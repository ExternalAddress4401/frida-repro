import "frida-il2cpp-bridge";
import { Buffer } from "buffer";
import Java from "frida-java-bridge";

const c = `KCgpID0+IHsKICB2YXIgX19jcmVhdGUgPSBPYmplY3QuY3JlYXRlOwogIHZhciBfX2RlZlByb3AgPSBPYmplY3QuZGVmaW5lUHJvcGVydHk7CiAgdmFyIF9fZ2V0T3duUHJvcERlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOwogIHZhciBfX2dldE93blByb3BOYW1lcyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzOwogIHZhciBfX2dldFByb3RvT2YgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Y7CiAgdmFyIF9faGFzT3duUHJvcCA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgdmFyIF9fY29tbW9uSlMgPSAoY2IsIG1vZCkgPT4gZnVuY3Rpb24gX19yZXF1aXJlKCkgewogICAgcmV0dXJuIG1vZCB8fCAoMCwgY2JbX19nZXRPd25Qcm9wTmFtZXMoY2IpWzBdXSkoKG1vZCA9IHsgZXhwb3J0czoge30gfSkuZXhwb3J0cywgbW9kKSwgbW9kLmV4cG9ydHM7CiAgfTsKICB2YXIgX19leHBvcnQgPSAodGFyZ2V0LCBhbGwpID0+IHsKICAgIGZvciAodmFyIG5hbWUgaW4gYWxsKQogICAgICBfX2RlZlByb3AodGFyZ2V0LCBuYW1lLCB7IGdldDogYWxsW25hbWVdLCBlbnVtZXJhYmxlOiB0cnVlIH0pOwogIH07CiAgdmFyIF9fY29weVByb3BzID0gKHRvLCBmcm9tMiwgZXhjZXB0LCBkZXNjKSA9PiB7CiAgICBpZiAoZnJvbTIgJiYgdHlwZW9mIGZyb20yID09PSAib2JqZWN0IiB8fCB0eXBlb2YgZnJvbTIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgZm9yIChsZXQga2V5IG9mIF9fZ2V0T3duUHJvcE5hbWVzKGZyb20yKSkKICAgICAgICBpZiAoIV9faGFzT3duUHJvcC5jYWxsKHRvLCBrZXkpICYmIGtleSAhPT0gZXhjZXB0KQogICAgICAgICAgX19kZWZQcm9wKHRvLCBrZXksIHsgZ2V0OiAoKSA9PiBmcm9tMltrZXldLCBlbnVtZXJhYmxlOiAhKGRlc2MgPSBfX2dldE93blByb3BEZXNjKGZyb20yLCBrZXkpKSB8fCBkZXNjLmVudW1lcmFibGUgfSk7CiAgICB9CiAgICByZXR1cm4gdG87CiAgfTsKICB2YXIgX190b0VTTSA9IChtb2QsIGlzTm9kZU1vZGUsIHRhcmdldCkgPT4gKHRhcmdldCA9IG1vZCAhPSBudWxsID8gX19jcmVhdGUoX19nZXRQcm90b09mKG1vZCkpIDoge30sIF9fY29weVByb3BzKAogICAgLy8gSWYgdGhlIGltcG9ydGVyIGlzIGluIG5vZGUgY29tcGF0aWJpbGl0eSBtb2RlIG9yIHRoaXMgaXMgbm90IGFuIEVTTQogICAgLy8gZmlsZSB0aGF0IGhhcyBiZWVuIGNvbnZlcnRlZCB0byBhIENvbW1vbkpTIGZpbGUgdXNpbmcgYSBCYWJlbC0KICAgIC8vIGNvbXBhdGlibGUgdHJhbnNmb3JtIChpLmUuICJfX2VzTW9kdWxlIiBoYXMgbm90IGJlZW4gc2V0KSwgdGhlbiBzZXQKICAgIC8vICJkZWZhdWx0IiB0byB0aGUgQ29tbW9uSlMgIm1vZHVsZS5leHBvcnRzIiBmb3Igbm9kZSBjb21wYXRpYmlsaXR5LgogICAgaXNOb2RlTW9kZSB8fCAhbW9kIHx8ICFtb2QuX19lc01vZHVsZSA/IF9fZGVmUHJvcCh0YXJnZXQsICJkZWZhdWx0IiwgeyB2YWx1ZTogbW9kLCBlbnVtZXJhYmxlOiB0cnVlIH0pIDogdGFyZ2V0LAogICAgbW9kCiAgKSk7CgogIC8vIG5vZGVfbW9kdWxlcy9iYXNlNjQtanMvaW5kZXguanMKICB2YXIgcmVxdWlyZV9iYXNlNjRfanMgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvYmFzZTY0LWpzL2luZGV4LmpzIihleHBvcnRzKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgZXhwb3J0cy5ieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aDI7CiAgICAgIGV4cG9ydHMudG9CeXRlQXJyYXkgPSB0b0J5dGVBcnJheTI7CiAgICAgIGV4cG9ydHMuZnJvbUJ5dGVBcnJheSA9IGZyb21CeXRlQXJyYXkyOwogICAgICB2YXIgbG9va3VwID0gW107CiAgICAgIHZhciByZXZMb29rdXAgPSBbXTsKICAgICAgdmFyIEFyciA9IHR5cGVvZiBVaW50OEFycmF5ICE9PSAidW5kZWZpbmVkIiA/IFVpbnQ4QXJyYXkgOiBBcnJheTsKICAgICAgdmFyIGNvZGUyID0gIkFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5Ky8iOwogICAgICBmb3IgKGkgPSAwLCBsZW4gPSBjb2RlMi5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICAgIGxvb2t1cFtpXSA9IGNvZGUyW2ldOwogICAgICAgIHJldkxvb2t1cFtjb2RlMi5jaGFyQ29kZUF0KGkpXSA9IGk7CiAgICAgIH0KICAgICAgdmFyIGk7CiAgICAgIHZhciBsZW47CiAgICAgIHJldkxvb2t1cFsiLSIuY2hhckNvZGVBdCgwKV0gPSA2MjsKICAgICAgcmV2TG9va3VwWyJfIi5jaGFyQ29kZUF0KDApXSA9IDYzOwogICAgICBmdW5jdGlvbiBnZXRMZW5zKGI2NCkgewogICAgICAgIHZhciBsZW4yID0gYjY0Lmxlbmd0aDsKICAgICAgICBpZiAobGVuMiAlIDQgPiAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgc3RyaW5nLiBMZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDQiKTsKICAgICAgICB9CiAgICAgICAgdmFyIHZhbGlkTGVuID0gYjY0LmluZGV4T2YoIj0iKTsKICAgICAgICBpZiAodmFsaWRMZW4gPT09IC0xKQogICAgICAgICAgdmFsaWRMZW4gPSBsZW4yOwogICAgICAgIHZhciBwbGFjZUhvbGRlcnNMZW4gPSB2YWxpZExlbiA9PT0gbGVuMiA/IDAgOiA0IC0gdmFsaWRMZW4gJSA0OwogICAgICAgIHJldHVybiBbdmFsaWRMZW4sIHBsYWNlSG9sZGVyc0xlbl07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYnl0ZUxlbmd0aDIoYjY0KSB7CiAgICAgICAgdmFyIGxlbnMgPSBnZXRMZW5zKGI2NCk7CiAgICAgICAgdmFyIHZhbGlkTGVuID0gbGVuc1swXTsKICAgICAgICB2YXIgcGxhY2VIb2xkZXJzTGVuID0gbGVuc1sxXTsKICAgICAgICByZXR1cm4gKHZhbGlkTGVuICsgcGxhY2VIb2xkZXJzTGVuKSAqIDMgLyA0IC0gcGxhY2VIb2xkZXJzTGVuOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIF9ieXRlTGVuZ3RoKGI2NCwgdmFsaWRMZW4sIHBsYWNlSG9sZGVyc0xlbikgewogICAgICAgIHJldHVybiAodmFsaWRMZW4gKyBwbGFjZUhvbGRlcnNMZW4pICogMyAvIDQgLSBwbGFjZUhvbGRlcnNMZW47CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdG9CeXRlQXJyYXkyKGI2NCkgewogICAgICAgIHZhciB0bXA7CiAgICAgICAgdmFyIGxlbnMgPSBnZXRMZW5zKGI2NCk7CiAgICAgICAgdmFyIHZhbGlkTGVuID0gbGVuc1swXTsKICAgICAgICB2YXIgcGxhY2VIb2xkZXJzTGVuID0gbGVuc1sxXTsKICAgICAgICB2YXIgYXJyID0gbmV3IEFycihfYnl0ZUxlbmd0aChiNjQsIHZhbGlkTGVuLCBwbGFjZUhvbGRlcnNMZW4pKTsKICAgICAgICB2YXIgY3VyQnl0ZSA9IDA7CiAgICAgICAgdmFyIGxlbjIgPSBwbGFjZUhvbGRlcnNMZW4gPiAwID8gdmFsaWRMZW4gLSA0IDogdmFsaWRMZW47CiAgICAgICAgdmFyIGkyOwogICAgICAgIGZvciAoaTIgPSAwOyBpMiA8IGxlbjI7IGkyICs9IDQpIHsKICAgICAgICAgIHRtcCA9IHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpMildIDw8IDE4IHwgcmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkyICsgMSldIDw8IDEyIHwgcmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkyICsgMildIDw8IDYgfCByZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaTIgKyAzKV07CiAgICAgICAgICBhcnJbY3VyQnl0ZSsrXSA9IHRtcCA+PiAxNiAmIDI1NTsKICAgICAgICAgIGFycltjdXJCeXRlKytdID0gdG1wID4+IDggJiAyNTU7CiAgICAgICAgICBhcnJbY3VyQnl0ZSsrXSA9IHRtcCAmIDI1NTsKICAgICAgICB9CiAgICAgICAgaWYgKHBsYWNlSG9sZGVyc0xlbiA9PT0gMikgewogICAgICAgICAgdG1wID0gcmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkyKV0gPDwgMiB8IHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpMiArIDEpXSA+PiA0OwogICAgICAgICAgYXJyW2N1ckJ5dGUrK10gPSB0bXAgJiAyNTU7CiAgICAgICAgfQogICAgICAgIGlmIChwbGFjZUhvbGRlcnNMZW4gPT09IDEpIHsKICAgICAgICAgIHRtcCA9IHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpMildIDw8IDEwIHwgcmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkyICsgMSldIDw8IDQgfCByZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaTIgKyAyKV0gPj4gMjsKICAgICAgICAgIGFycltjdXJCeXRlKytdID0gdG1wID4+IDggJiAyNTU7CiAgICAgICAgICBhcnJbY3VyQnl0ZSsrXSA9IHRtcCAmIDI1NTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFycjsKICAgICAgfQogICAgICBmdW5jdGlvbiB0cmlwbGV0VG9CYXNlNjQobnVtKSB7CiAgICAgICAgcmV0dXJuIGxvb2t1cFtudW0gPj4gMTggJiA2M10gKyBsb29rdXBbbnVtID4+IDEyICYgNjNdICsgbG9va3VwW251bSA+PiA2ICYgNjNdICsgbG9va3VwW251bSAmIDYzXTsKICAgICAgfQogICAgICBmdW5jdGlvbiBlbmNvZGVDaHVuayh1aW50OCwgc3RhcnQsIGVuZCkgewogICAgICAgIHZhciB0bXA7CiAgICAgICAgdmFyIG91dHB1dCA9IFtdOwogICAgICAgIGZvciAodmFyIGkyID0gc3RhcnQ7IGkyIDwgZW5kOyBpMiArPSAzKSB7CiAgICAgICAgICB0bXAgPSAodWludDhbaTJdIDw8IDE2ICYgMTY3MTE2ODApICsgKHVpbnQ4W2kyICsgMV0gPDwgOCAmIDY1MjgwKSArICh1aW50OFtpMiArIDJdICYgMjU1KTsKICAgICAgICAgIG91dHB1dC5wdXNoKHRyaXBsZXRUb0Jhc2U2NCh0bXApKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG91dHB1dC5qb2luKCIiKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBmcm9tQnl0ZUFycmF5Mih1aW50OCkgewogICAgICAgIHZhciB0bXA7CiAgICAgICAgdmFyIGxlbjIgPSB1aW50OC5sZW5ndGg7CiAgICAgICAgdmFyIGV4dHJhQnl0ZXMgPSBsZW4yICUgMzsKICAgICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgICB2YXIgbWF4Q2h1bmtMZW5ndGggPSAxNjM4MzsKICAgICAgICBmb3IgKHZhciBpMiA9IDAsIGxlbjIyID0gbGVuMiAtIGV4dHJhQnl0ZXM7IGkyIDwgbGVuMjI7IGkyICs9IG1heENodW5rTGVuZ3RoKSB7CiAgICAgICAgICBwYXJ0cy5wdXNoKGVuY29kZUNodW5rKHVpbnQ4LCBpMiwgaTIgKyBtYXhDaHVua0xlbmd0aCA+IGxlbjIyID8gbGVuMjIgOiBpMiArIG1heENodW5rTGVuZ3RoKSk7CiAgICAgICAgfQogICAgICAgIGlmIChleHRyYUJ5dGVzID09PSAxKSB7CiAgICAgICAgICB0bXAgPSB1aW50OFtsZW4yIC0gMV07CiAgICAgICAgICBwYXJ0cy5wdXNoKAogICAgICAgICAgICBsb29rdXBbdG1wID4+IDJdICsgbG9va3VwW3RtcCA8PCA0ICYgNjNdICsgIj09IgogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKGV4dHJhQnl0ZXMgPT09IDIpIHsKICAgICAgICAgIHRtcCA9ICh1aW50OFtsZW4yIC0gMl0gPDwgOCkgKyB1aW50OFtsZW4yIC0gMV07CiAgICAgICAgICBwYXJ0cy5wdXNoKAogICAgICAgICAgICBsb29rdXBbdG1wID4+IDEwXSArIGxvb2t1cFt0bXAgPj4gNCAmIDYzXSArIGxvb2t1cFt0bXAgPDwgMiAmIDYzXSArICI9IgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oIiIpOwogICAgICB9CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9pZWVlNzU0L2luZGV4LmpzCiAgdmFyIHJlcXVpcmVfaWVlZTc1NCA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9pZWVlNzU0L2luZGV4LmpzIihleHBvcnRzKSB7CiAgICAgIGV4cG9ydHMucmVhZCA9IGZ1bmN0aW9uKGJ1ZmZlciwgb2Zmc2V0LCBpc0xFLCBtTGVuLCBuQnl0ZXMpIHsKICAgICAgICB2YXIgZSwgbTsKICAgICAgICB2YXIgZUxlbiA9IG5CeXRlcyAqIDggLSBtTGVuIC0gMTsKICAgICAgICB2YXIgZU1heCA9ICgxIDw8IGVMZW4pIC0gMTsKICAgICAgICB2YXIgZUJpYXMgPSBlTWF4ID4+IDE7CiAgICAgICAgdmFyIG5CaXRzID0gLTc7CiAgICAgICAgdmFyIGkgPSBpc0xFID8gbkJ5dGVzIC0gMSA6IDA7CiAgICAgICAgdmFyIGQgPSBpc0xFID8gLTEgOiAxOwogICAgICAgIHZhciBzID0gYnVmZmVyW29mZnNldCArIGldOwogICAgICAgIGkgKz0gZDsKICAgICAgICBlID0gcyAmICgxIDw8IC1uQml0cykgLSAxOwogICAgICAgIHMgPj49IC1uQml0czsKICAgICAgICBuQml0cyArPSBlTGVuOwogICAgICAgIGZvciAoOyBuQml0cyA+IDA7IGUgPSBlICogMjU2ICsgYnVmZmVyW29mZnNldCArIGldLCBpICs9IGQsIG5CaXRzIC09IDgpIHsKICAgICAgICB9CiAgICAgICAgbSA9IGUgJiAoMSA8PCAtbkJpdHMpIC0gMTsKICAgICAgICBlID4+PSAtbkJpdHM7CiAgICAgICAgbkJpdHMgKz0gbUxlbjsKICAgICAgICBmb3IgKDsgbkJpdHMgPiAwOyBtID0gbSAqIDI1NiArIGJ1ZmZlcltvZmZzZXQgKyBpXSwgaSArPSBkLCBuQml0cyAtPSA4KSB7CiAgICAgICAgfQogICAgICAgIGlmIChlID09PSAwKSB7CiAgICAgICAgICBlID0gMSAtIGVCaWFzOwogICAgICAgIH0gZWxzZSBpZiAoZSA9PT0gZU1heCkgewogICAgICAgICAgcmV0dXJuIG0gPyBOYU4gOiAocyA/IC0xIDogMSkgKiBJbmZpbml0eTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbSA9IG0gKyBNYXRoLnBvdygyLCBtTGVuKTsKICAgICAgICAgIGUgPSBlIC0gZUJpYXM7CiAgICAgICAgfQogICAgICAgIHJldHVybiAocyA/IC0xIDogMSkgKiBtICogTWF0aC5wb3coMiwgZSAtIG1MZW4pOwogICAgICB9OwogICAgICBleHBvcnRzLndyaXRlID0gZnVuY3Rpb24oYnVmZmVyLCB2YWx1ZSwgb2Zmc2V0LCBpc0xFLCBtTGVuLCBuQnl0ZXMpIHsKICAgICAgICB2YXIgZSwgbSwgYzsKICAgICAgICB2YXIgZUxlbiA9IG5CeXRlcyAqIDggLSBtTGVuIC0gMTsKICAgICAgICB2YXIgZU1heCA9ICgxIDw8IGVMZW4pIC0gMTsKICAgICAgICB2YXIgZUJpYXMgPSBlTWF4ID4+IDE7CiAgICAgICAgdmFyIHJ0ID0gbUxlbiA9PT0gMjMgPyBNYXRoLnBvdygyLCAtMjQpIC0gTWF0aC5wb3coMiwgLTc3KSA6IDA7CiAgICAgICAgdmFyIGkgPSBpc0xFID8gMCA6IG5CeXRlcyAtIDE7CiAgICAgICAgdmFyIGQgPSBpc0xFID8gMSA6IC0xOwogICAgICAgIHZhciBzID0gdmFsdWUgPCAwIHx8IHZhbHVlID09PSAwICYmIDEgLyB2YWx1ZSA8IDAgPyAxIDogMDsKICAgICAgICB2YWx1ZSA9IE1hdGguYWJzKHZhbHVlKTsKICAgICAgICBpZiAoaXNOYU4odmFsdWUpIHx8IHZhbHVlID09PSBJbmZpbml0eSkgewogICAgICAgICAgbSA9IGlzTmFOKHZhbHVlKSA/IDEgOiAwOwogICAgICAgICAgZSA9IGVNYXg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGUgPSBNYXRoLmZsb29yKE1hdGgubG9nKHZhbHVlKSAvIE1hdGguTE4yKTsKICAgICAgICAgIGlmICh2YWx1ZSAqIChjID0gTWF0aC5wb3coMiwgLWUpKSA8IDEpIHsKICAgICAgICAgICAgZS0tOwogICAgICAgICAgICBjICo9IDI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZSArIGVCaWFzID49IDEpIHsKICAgICAgICAgICAgdmFsdWUgKz0gcnQgLyBjOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsdWUgKz0gcnQgKiBNYXRoLnBvdygyLCAxIC0gZUJpYXMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZhbHVlICogYyA+PSAyKSB7CiAgICAgICAgICAgIGUrKzsKICAgICAgICAgICAgYyAvPSAyOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGUgKyBlQmlhcyA+PSBlTWF4KSB7CiAgICAgICAgICAgIG0gPSAwOwogICAgICAgICAgICBlID0gZU1heDsKICAgICAgICAgIH0gZWxzZSBpZiAoZSArIGVCaWFzID49IDEpIHsKICAgICAgICAgICAgbSA9ICh2YWx1ZSAqIGMgLSAxKSAqIE1hdGgucG93KDIsIG1MZW4pOwogICAgICAgICAgICBlID0gZSArIGVCaWFzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbSA9IHZhbHVlICogTWF0aC5wb3coMiwgZUJpYXMgLSAxKSAqIE1hdGgucG93KDIsIG1MZW4pOwogICAgICAgICAgICBlID0gMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yICg7IG1MZW4gPj0gODsgYnVmZmVyW29mZnNldCArIGldID0gbSAmIDI1NSwgaSArPSBkLCBtIC89IDI1NiwgbUxlbiAtPSA4KSB7CiAgICAgICAgfQogICAgICAgIGUgPSBlIDw8IG1MZW4gfCBtOwogICAgICAgIGVMZW4gKz0gbUxlbjsKICAgICAgICBmb3IgKDsgZUxlbiA+IDA7IGJ1ZmZlcltvZmZzZXQgKyBpXSA9IGUgJiAyNTUsIGkgKz0gZCwgZSAvPSAyNTYsIGVMZW4gLT0gOCkgewogICAgICAgIH0KICAgICAgICBidWZmZXJbb2Zmc2V0ICsgaSAtIGRdIHw9IHMgKiAxMjg7CiAgICAgIH07CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9mcmlkYS1qYXZhLWJyaWRnZS9saWIvYW5kcm9pZC5qcwogIHZhciBhbmRyb2lkX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChhbmRyb2lkX2V4cG9ydHMsIHsKICAgIEFydE1ldGhvZDogKCkgPT4gQXJ0TWV0aG9kLAogICAgQXJ0U3RhY2tWaXNpdG9yOiAoKSA9PiBBcnRTdGFja1Zpc2l0b3IsCiAgICBEVk1fSk5JX0VOVl9PRkZTRVRfU0VMRjogKCkgPT4gRFZNX0pOSV9FTlZfT0ZGU0VUX1NFTEYsCiAgICBIYW5kbGVWZWN0b3I6ICgpID0+IEhhbmRsZVZlY3RvciwKICAgIFZhcmlhYmxlU2l6ZWRIYW5kbGVTY29wZTogKCkgPT4gVmFyaWFibGVTaXplZEhhbmRsZVNjb3BlLAogICAgYmFja3RyYWNlOiAoKSA9PiBiYWNrdHJhY2UsCiAgICBkZW9wdGltaXplQm9vdEltYWdlOiAoKSA9PiBkZW9wdGltaXplQm9vdEltYWdlLAogICAgZGVvcHRpbWl6ZUV2ZXJ5dGhpbmc6ICgpID0+IGRlb3B0aW1pemVFdmVyeXRoaW5nLAogICAgZGVvcHRpbWl6ZU1ldGhvZDogKCkgPT4gZGVvcHRpbWl6ZU1ldGhvZCwKICAgIGVuc3VyZUNsYXNzSW5pdGlhbGl6ZWQ6ICgpID0+IGVuc3VyZUNsYXNzSW5pdGlhbGl6ZWQsCiAgICBnZXRBbmRyb2lkQXBpTGV2ZWw6ICgpID0+IGdldEFuZHJvaWRBcGlMZXZlbCwKICAgIGdldEFuZHJvaWRWZXJzaW9uOiAoKSA9PiBnZXRBbmRyb2lkVmVyc2lvbiwKICAgIGdldEFwaTogKCkgPT4gZ2V0QXBpLAogICAgZ2V0QXJ0Q2xhc3NTcGVjOiAoKSA9PiBnZXRBcnRDbGFzc1NwZWMsCiAgICBnZXRBcnRGaWVsZFNwZWM6ICgpID0+IGdldEFydEZpZWxkU3BlYywKICAgIGdldEFydE1ldGhvZFNwZWM6ICgpID0+IGdldEFydE1ldGhvZFNwZWMsCiAgICBnZXRBcnRUaHJlYWRGcm9tRW52OiAoKSA9PiBnZXRBcnRUaHJlYWRGcm9tRW52LAogICAgZ2V0QXJ0VGhyZWFkU3BlYzogKCkgPT4gZ2V0QXJ0VGhyZWFkU3BlYywKICAgIG1ha2VBcnRDbGFzc0xvYWRlclZpc2l0b3I6ICgpID0+IG1ha2VBcnRDbGFzc0xvYWRlclZpc2l0b3IsCiAgICBtYWtlQXJ0Q2xhc3NWaXNpdG9yOiAoKSA9PiBtYWtlQXJ0Q2xhc3NWaXNpdG9yLAogICAgbWFrZU1ldGhvZE1hbmdsZXI6ICgpID0+IG1ha2VNZXRob2RNYW5nbGVyLAogICAgbWFrZU9iamVjdFZpc2l0b3JQcmVkaWNhdGU6ICgpID0+IG1ha2VPYmplY3RWaXNpdG9yUHJlZGljYXRlLAogICAgcmV2ZXJ0R2xvYmFsUGF0Y2hlczogKCkgPT4gcmV2ZXJ0R2xvYmFsUGF0Y2hlcywKICAgIHRyYW5zbGF0ZU1ldGhvZDogKCkgPT4gdHJhbnNsYXRlTWV0aG9kLAogICAgd2l0aEFsbEFydFRocmVhZHNTdXNwZW5kZWQ6ICgpID0+IHdpdGhBbGxBcnRUaHJlYWRzU3VzcGVuZGVkLAogICAgd2l0aFJ1bm5hYmxlQXJ0VGhyZWFkOiAoKSA9PiB3aXRoUnVubmFibGVBcnRUaHJlYWQKICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL2ZyaWRhLWphdmEtYnJpZGdlL2xpYi9hbGxvYy5qcwogIHZhciB7CiAgICBwYWdlU2l6ZSwKICAgIHBvaW50ZXJTaXplCiAgfSA9IFByb2Nlc3M7CiAgdmFyIENvZGVBbGxvY2F0b3IgPSBjbGFzcyB7CiAgICBjb25zdHJ1Y3RvcihzbGljZVNpemUpIHsKICAgICAgdGhpcy5zbGljZVNpemUgPSBzbGljZVNpemU7CiAgICAgIHRoaXMuc2xpY2VzUGVyUGFnZSA9IHBhZ2VTaXplIC8gc2xpY2VTaXplOwogICAgICB0aGlzLnBhZ2VzID0gW107CiAgICAgIHRoaXMuZnJlZSA9IFtdOwogICAgfQogICAgYWxsb2NhdGVTbGljZShzcGVjLCBhbGlnbm1lbnQpIHsKICAgICAgY29uc3QgYW55TG9jYXRpb24gPSBzcGVjLm5lYXIgPT09IHZvaWQgMDsKICAgICAgY29uc3QgYW55QWxpZ25tZW50ID0gYWxpZ25tZW50ID09PSAxOwogICAgICBpZiAoYW55TG9jYXRpb24gJiYgYW55QWxpZ25tZW50KSB7CiAgICAgICAgY29uc3Qgc2xpY2UyID0gdGhpcy5mcmVlLnBvcCgpOwogICAgICAgIGlmIChzbGljZTIgIT09IHZvaWQgMCkgewogICAgICAgICAgcmV0dXJuIHNsaWNlMjsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoYWxpZ25tZW50IDwgcGFnZVNpemUpIHsKICAgICAgICBjb25zdCB7IGZyZWUgfSA9IHRoaXM7CiAgICAgICAgY29uc3QgbiA9IGZyZWUubGVuZ3RoOwogICAgICAgIGNvbnN0IGFsaWduTWFzayA9IGFueUFsaWdubWVudCA/IG51bGwgOiBwdHIoYWxpZ25tZW50IC0gMSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IG47IGkrKykgewogICAgICAgICAgY29uc3Qgc2xpY2UyID0gZnJlZVtpXTsKICAgICAgICAgIGNvbnN0IHNhdGlzZmllc0xvY2F0aW9uID0gYW55TG9jYXRpb24gfHwgdGhpcy5faXNTbGljZU5lYXIoc2xpY2UyLCBzcGVjKTsKICAgICAgICAgIGNvbnN0IHNhdGlzZmllc0FsaWdubWVudCA9IGFueUFsaWdubWVudCB8fCBzbGljZTIuYW5kKGFsaWduTWFzaykuaXNOdWxsKCk7CiAgICAgICAgICBpZiAoc2F0aXNmaWVzTG9jYXRpb24gJiYgc2F0aXNmaWVzQWxpZ25tZW50KSB7CiAgICAgICAgICAgIHJldHVybiBmcmVlLnNwbGljZShpLCAxKVswXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuX2FsbG9jYXRlUGFnZShzcGVjKTsKICAgIH0KICAgIF9hbGxvY2F0ZVBhZ2Uoc3BlYykgewogICAgICBjb25zdCBwYWdlID0gTWVtb3J5LmFsbG9jKHBhZ2VTaXplLCBzcGVjKTsKICAgICAgY29uc3QgeyBzbGljZVNpemUsIHNsaWNlc1BlclBhZ2UgfSA9IHRoaXM7CiAgICAgIGZvciAobGV0IGkgPSAxOyBpICE9PSBzbGljZXNQZXJQYWdlOyBpKyspIHsKICAgICAgICBjb25zdCBzbGljZTIgPSBwYWdlLmFkZChpICogc2xpY2VTaXplKTsKICAgICAgICB0aGlzLmZyZWUucHVzaChzbGljZTIpOwogICAgICB9CiAgICAgIHRoaXMucGFnZXMucHVzaChwYWdlKTsKICAgICAgcmV0dXJuIHBhZ2U7CiAgICB9CiAgICBfaXNTbGljZU5lYXIoc2xpY2UyLCBzcGVjKSB7CiAgICAgIGNvbnN0IHNsaWNlRW5kID0gc2xpY2UyLmFkZCh0aGlzLnNsaWNlU2l6ZSk7CiAgICAgIGNvbnN0IHsgbmVhciwgbWF4RGlzdGFuY2UgfSA9IHNwZWM7CiAgICAgIGNvbnN0IHN0YXJ0RGlzdGFuY2UgPSBhYnMobmVhci5zdWIoc2xpY2UyKSk7CiAgICAgIGNvbnN0IGVuZERpc3RhbmNlID0gYWJzKG5lYXIuc3ViKHNsaWNlRW5kKSk7CiAgICAgIHJldHVybiBzdGFydERpc3RhbmNlLmNvbXBhcmUobWF4RGlzdGFuY2UpIDw9IDAgJiYgZW5kRGlzdGFuY2UuY29tcGFyZShtYXhEaXN0YW5jZSkgPD0gMDsKICAgIH0KICAgIGZyZWVTbGljZShzbGljZTIpIHsKICAgICAgdGhpcy5mcmVlLnB1c2goc2xpY2UyKTsKICAgIH0KICB9OwogIGZ1bmN0aW9uIGFicyhucHRyKSB7CiAgICBjb25zdCBzaG10ID0gcG9pbnRlclNpemUgPT09IDQgPyAzMSA6IDYzOwogICAgY29uc3QgbWFzayA9IHB0cigxKS5zaGwoc2htdCkubm90KCk7CiAgICByZXR1cm4gbnB0ci5hbmQobWFzayk7CiAgfQogIGZ1bmN0aW9uIG1ha2VBbGxvY2F0b3Ioc2xpY2VTaXplKSB7CiAgICByZXR1cm4gbmV3IENvZGVBbGxvY2F0b3Ioc2xpY2VTaXplKTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9mcmlkYS1qYXZhLWJyaWRnZS9saWIvcmVzdWx0LmpzCiAgdmFyIEpOSV9PSyA9IDA7CiAgZnVuY3Rpb24gY2hlY2tKbmlSZXN1bHQobmFtZSwgcmVzdWx0KSB7CiAgICBpZiAocmVzdWx0ICE9PSBKTklfT0spIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKG5hbWUgKyAiIGZhaWxlZDogIiArIHJlc3VsdCk7CiAgICB9CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZnJpZGEtamF2YS1icmlkZ2UvbGliL2p2bXRpLmpzCiAgdmFyIGp2bXRpVmVyc2lvbiA9IHsKICAgIHYxXzA6IDgwNTM3MTkwNCwKICAgIHYxXzI6IDgwNTM3MjQxNgogIH07CiAgdmFyIGp2bXRpQ2FwYWJpbGl0aWVzID0gewogICAgY2FuVGFnT2JqZWN0czogMQogIH07CiAgdmFyIHsgcG9pbnRlclNpemU6IHBvaW50ZXJTaXplMiB9ID0gUHJvY2VzczsKICB2YXIgbmF0aXZlRnVuY3Rpb25PcHRpb25zID0gewogICAgZXhjZXB0aW9uczogInByb3BhZ2F0ZSIKICB9OwogIGZ1bmN0aW9uIEVudkp2bXRpKGhhbmRsZSwgdm0zKSB7CiAgICB0aGlzLmhhbmRsZSA9IGhhbmRsZTsKICAgIHRoaXMudm0gPSB2bTM7CiAgICB0aGlzLnZ0YWJsZSA9IGhhbmRsZS5yZWFkUG9pbnRlcigpOwogIH0KICBFbnZKdm10aS5wcm90b3R5cGUuZGVhbGxvY2F0ZSA9IHByb3h5KDQ3LCAiaW50MzIiLCBbInBvaW50ZXIiLCAicG9pbnRlciJdLCBmdW5jdGlvbihpbXBsLCBtZW0pIHsKICAgIHJldHVybiBpbXBsKHRoaXMuaGFuZGxlLCBtZW0pOwogIH0pOwogIEVudkp2bXRpLnByb3RvdHlwZS5nZXRMb2FkZWRDbGFzc2VzID0gcHJveHkoNzgsICJpbnQzMiIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwgY2xhc3NDb3VudFB0ciwgY2xhc3Nlc1B0cikgewogICAgY29uc3QgcmVzdWx0ID0gaW1wbCh0aGlzLmhhbmRsZSwgY2xhc3NDb3VudFB0ciwgY2xhc3Nlc1B0cik7CiAgICBjaGVja0puaVJlc3VsdCgiRW52SnZtdGk6OmdldExvYWRlZENsYXNzZXMiLCByZXN1bHQpOwogIH0pOwogIEVudkp2bXRpLnByb3RvdHlwZS5pdGVyYXRlT3Zlckluc3RhbmNlc09mQ2xhc3MgPSBwcm94eSgxMTIsICJpbnQzMiIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgImludCIsICJwb2ludGVyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwga2xhc3MsIG9iamVjdEZpbHRlciwgaGVhcE9iamVjdENhbGxiYWNrLCB1c2VyRGF0YSkgewogICAgY29uc3QgcmVzdWx0ID0gaW1wbCh0aGlzLmhhbmRsZSwga2xhc3MsIG9iamVjdEZpbHRlciwgaGVhcE9iamVjdENhbGxiYWNrLCB1c2VyRGF0YSk7CiAgICBjaGVja0puaVJlc3VsdCgiRW52SnZtdGk6Oml0ZXJhdGVPdmVySW5zdGFuY2VzT2ZDbGFzcyIsIHJlc3VsdCk7CiAgfSk7CiAgRW52SnZtdGkucHJvdG90eXBlLmdldE9iamVjdHNXaXRoVGFncyA9IHByb3h5KDExNCwgImludDMyIiwgWyJwb2ludGVyIiwgImludCIsICJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciIsICJwb2ludGVyIl0sIGZ1bmN0aW9uKGltcGwsIHRhZ0NvdW50LCB0YWdzLCBjb3VudFB0ciwgb2JqZWN0UmVzdWx0UHRyLCB0YWdSZXN1bHRQdHIpIHsKICAgIGNvbnN0IHJlc3VsdCA9IGltcGwodGhpcy5oYW5kbGUsIHRhZ0NvdW50LCB0YWdzLCBjb3VudFB0ciwgb2JqZWN0UmVzdWx0UHRyLCB0YWdSZXN1bHRQdHIpOwogICAgY2hlY2tKbmlSZXN1bHQoIkVudkp2bXRpOjpnZXRPYmplY3RzV2l0aFRhZ3MiLCByZXN1bHQpOwogIH0pOwogIEVudkp2bXRpLnByb3RvdHlwZS5hZGRDYXBhYmlsaXRpZXMgPSBwcm94eSgxNDIsICJpbnQzMiIsIFsicG9pbnRlciIsICJwb2ludGVyIl0sIGZ1bmN0aW9uKGltcGwsIGNhcGFiaWxpdGllc1B0cikgewogICAgcmV0dXJuIGltcGwodGhpcy5oYW5kbGUsIGNhcGFiaWxpdGllc1B0cik7CiAgfSk7CiAgZnVuY3Rpb24gcHJveHkob2Zmc2V0LCByZXRUeXBlLCBhcmdUeXBlcywgd3JhcHBlcikgewogICAgbGV0IGltcGwgPSBudWxsOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBpZiAoaW1wbCA9PT0gbnVsbCkgewogICAgICAgIGltcGwgPSBuZXcgTmF0aXZlRnVuY3Rpb24odGhpcy52dGFibGUuYWRkKChvZmZzZXQgLSAxKSAqIHBvaW50ZXJTaXplMikucmVhZFBvaW50ZXIoKSwgcmV0VHlwZSwgYXJnVHlwZXMsIG5hdGl2ZUZ1bmN0aW9uT3B0aW9ucyk7CiAgICAgIH0KICAgICAgbGV0IGFyZ3MgPSBbaW1wbF07CiAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gd3JhcHBlci5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH07CiAgfQoKICAvLyBub2RlX21vZHVsZXMvZnJpZGEtamF2YS1icmlkZ2UvbGliL21hY2hpbmUtY29kZS5qcwogIGZ1bmN0aW9uIHBhcnNlSW5zdHJ1Y3Rpb25zQXQoYWRkcmVzcywgdHJ5UGFyc2UsIHsgbGltaXQgfSkgewogICAgbGV0IGN1cnNvciA9IGFkZHJlc3M7CiAgICBsZXQgcHJldkluc24gPSBudWxsOwogICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IGxpbWl0OyBpKyspIHsKICAgICAgY29uc3QgaW5zbiA9IEluc3RydWN0aW9uLnBhcnNlKGN1cnNvcik7CiAgICAgIGNvbnN0IHZhbHVlID0gdHJ5UGFyc2UoaW5zbiwgcHJldkluc24pOwogICAgICBpZiAodmFsdWUgIT09IG51bGwpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgY3Vyc29yID0gaW5zbi5uZXh0OwogICAgICBwcmV2SW5zbiA9IGluc247CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9mcmlkYS1qYXZhLWJyaWRnZS9saWIvbWVtb2l6ZS5qcwogIGZ1bmN0aW9uIG1lbW9pemUoY29tcHV0ZSkgewogICAgbGV0IHZhbHVlID0gbnVsbDsKICAgIGxldCBjb21wdXRlZCA9IGZhbHNlOwogICAgcmV0dXJuIGZ1bmN0aW9uKC4uLmFyZ3MpIHsKICAgICAgaWYgKCFjb21wdXRlZCkgewogICAgICAgIHZhbHVlID0gY29tcHV0ZSguLi5hcmdzKTsKICAgICAgICBjb21wdXRlZCA9IHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbHVlOwogICAgfTsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9mcmlkYS1qYXZhLWJyaWRnZS9saWIvZW52LmpzCiAgZnVuY3Rpb24gRW52KGhhbmRsZSwgdm0zKSB7CiAgICB0aGlzLmhhbmRsZSA9IGhhbmRsZTsKICAgIHRoaXMudm0gPSB2bTM7CiAgfQogIHZhciBwb2ludGVyU2l6ZTMgPSBQcm9jZXNzLnBvaW50ZXJTaXplOwogIHZhciBKTklfQUJPUlQgPSAyOwogIHZhciBDQUxMX0NPTlNUUlVDVE9SX01FVEhPRF9PRkZTRVQgPSAyODsKICB2YXIgQ0FMTF9PQkpFQ1RfTUVUSE9EX09GRlNFVCA9IDM0OwogIHZhciBDQUxMX0JPT0xFQU5fTUVUSE9EX09GRlNFVCA9IDM3OwogIHZhciBDQUxMX0JZVEVfTUVUSE9EX09GRlNFVCA9IDQwOwogIHZhciBDQUxMX0NIQVJfTUVUSE9EX09GRlNFVCA9IDQzOwogIHZhciBDQUxMX1NIT1JUX01FVEhPRF9PRkZTRVQgPSA0NjsKICB2YXIgQ0FMTF9JTlRfTUVUSE9EX09GRlNFVCA9IDQ5OwogIHZhciBDQUxMX0xPTkdfTUVUSE9EX09GRlNFVCA9IDUyOwogIHZhciBDQUxMX0ZMT0FUX01FVEhPRF9PRkZTRVQgPSA1NTsKICB2YXIgQ0FMTF9ET1VCTEVfTUVUSE9EX09GRlNFVCA9IDU4OwogIHZhciBDQUxMX1ZPSURfTUVUSE9EX09GRlNFVCA9IDYxOwogIHZhciBDQUxMX05PTlZJUlRVQUxfT0JKRUNUX01FVEhPRF9PRkZTRVQgPSA2NDsKICB2YXIgQ0FMTF9OT05WSVJUVUFMX0JPT0xFQU5fTUVUSE9EX09GRlNFVCA9IDY3OwogIHZhciBDQUxMX05PTlZJUlRVQUxfQllURV9NRVRIT0RfT0ZGU0VUID0gNzA7CiAgdmFyIENBTExfTk9OVklSVFVBTF9DSEFSX01FVEhPRF9PRkZTRVQgPSA3MzsKICB2YXIgQ0FMTF9OT05WSVJUVUFMX1NIT1JUX01FVEhPRF9PRkZTRVQgPSA3NjsKICB2YXIgQ0FMTF9OT05WSVJUVUFMX0lOVF9NRVRIT0RfT0ZGU0VUID0gNzk7CiAgdmFyIENBTExfTk9OVklSVFVBTF9MT05HX01FVEhPRF9PRkZTRVQgPSA4MjsKICB2YXIgQ0FMTF9OT05WSVJUVUFMX0ZMT0FUX01FVEhPRF9PRkZTRVQgPSA4NTsKICB2YXIgQ0FMTF9OT05WSVJUVUFMX0RPVUJMRV9NRVRIT0RfT0ZGU0VUID0gODg7CiAgdmFyIENBTExfTk9OVklSVFVBTF9WT0lEX01FVEhPRF9PRkZTRVQgPSA5MTsKICB2YXIgQ0FMTF9TVEFUSUNfT0JKRUNUX01FVEhPRF9PRkZTRVQgPSAxMTQ7CiAgdmFyIENBTExfU1RBVElDX0JPT0xFQU5fTUVUSE9EX09GRlNFVCA9IDExNzsKICB2YXIgQ0FMTF9TVEFUSUNfQllURV9NRVRIT0RfT0ZGU0VUID0gMTIwOwogIHZhciBDQUxMX1NUQVRJQ19DSEFSX01FVEhPRF9PRkZTRVQgPSAxMjM7CiAgdmFyIENBTExfU1RBVElDX1NIT1JUX01FVEhPRF9PRkZTRVQgPSAxMjY7CiAgdmFyIENBTExfU1RBVElDX0lOVF9NRVRIT0RfT0ZGU0VUID0gMTI5OwogIHZhciBDQUxMX1NUQVRJQ19MT05HX01FVEhPRF9PRkZTRVQgPSAxMzI7CiAgdmFyIENBTExfU1RBVElDX0ZMT0FUX01FVEhPRF9PRkZTRVQgPSAxMzU7CiAgdmFyIENBTExfU1RBVElDX0RPVUJMRV9NRVRIT0RfT0ZGU0VUID0gMTM4OwogIHZhciBDQUxMX1NUQVRJQ19WT0lEX01FVEhPRF9PRkZTRVQgPSAxNDE7CiAgdmFyIEdFVF9PQkpFQ1RfRklFTERfT0ZGU0VUID0gOTU7CiAgdmFyIEdFVF9CT09MRUFOX0ZJRUxEX09GRlNFVCA9IDk2OwogIHZhciBHRVRfQllURV9GSUVMRF9PRkZTRVQgPSA5NzsKICB2YXIgR0VUX0NIQVJfRklFTERfT0ZGU0VUID0gOTg7CiAgdmFyIEdFVF9TSE9SVF9GSUVMRF9PRkZTRVQgPSA5OTsKICB2YXIgR0VUX0lOVF9GSUVMRF9PRkZTRVQgPSAxMDA7CiAgdmFyIEdFVF9MT05HX0ZJRUxEX09GRlNFVCA9IDEwMTsKICB2YXIgR0VUX0ZMT0FUX0ZJRUxEX09GRlNFVCA9IDEwMjsKICB2YXIgR0VUX0RPVUJMRV9GSUVMRF9PRkZTRVQgPSAxMDM7CiAgdmFyIFNFVF9PQkpFQ1RfRklFTERfT0ZGU0VUID0gMTA0OwogIHZhciBTRVRfQk9PTEVBTl9GSUVMRF9PRkZTRVQgPSAxMDU7CiAgdmFyIFNFVF9CWVRFX0ZJRUxEX09GRlNFVCA9IDEwNjsKICB2YXIgU0VUX0NIQVJfRklFTERfT0ZGU0VUID0gMTA3OwogIHZhciBTRVRfU0hPUlRfRklFTERfT0ZGU0VUID0gMTA4OwogIHZhciBTRVRfSU5UX0ZJRUxEX09GRlNFVCA9IDEwOTsKICB2YXIgU0VUX0xPTkdfRklFTERfT0ZGU0VUID0gMTEwOwogIHZhciBTRVRfRkxPQVRfRklFTERfT0ZGU0VUID0gMTExOwogIHZhciBTRVRfRE9VQkxFX0ZJRUxEX09GRlNFVCA9IDExMjsKICB2YXIgR0VUX1NUQVRJQ19PQkpFQ1RfRklFTERfT0ZGU0VUID0gMTQ1OwogIHZhciBHRVRfU1RBVElDX0JPT0xFQU5fRklFTERfT0ZGU0VUID0gMTQ2OwogIHZhciBHRVRfU1RBVElDX0JZVEVfRklFTERfT0ZGU0VUID0gMTQ3OwogIHZhciBHRVRfU1RBVElDX0NIQVJfRklFTERfT0ZGU0VUID0gMTQ4OwogIHZhciBHRVRfU1RBVElDX1NIT1JUX0ZJRUxEX09GRlNFVCA9IDE0OTsKICB2YXIgR0VUX1NUQVRJQ19JTlRfRklFTERfT0ZGU0VUID0gMTUwOwogIHZhciBHRVRfU1RBVElDX0xPTkdfRklFTERfT0ZGU0VUID0gMTUxOwogIHZhciBHRVRfU1RBVElDX0ZMT0FUX0ZJRUxEX09GRlNFVCA9IDE1MjsKICB2YXIgR0VUX1NUQVRJQ19ET1VCTEVfRklFTERfT0ZGU0VUID0gMTUzOwogIHZhciBTRVRfU1RBVElDX09CSkVDVF9GSUVMRF9PRkZTRVQgPSAxNTQ7CiAgdmFyIFNFVF9TVEFUSUNfQk9PTEVBTl9GSUVMRF9PRkZTRVQgPSAxNTU7CiAgdmFyIFNFVF9TVEFUSUNfQllURV9GSUVMRF9PRkZTRVQgPSAxNTY7CiAgdmFyIFNFVF9TVEFUSUNfQ0hBUl9GSUVMRF9PRkZTRVQgPSAxNTc7CiAgdmFyIFNFVF9TVEFUSUNfU0hPUlRfRklFTERfT0ZGU0VUID0gMTU4OwogIHZhciBTRVRfU1RBVElDX0lOVF9GSUVMRF9PRkZTRVQgPSAxNTk7CiAgdmFyIFNFVF9TVEFUSUNfTE9OR19GSUVMRF9PRkZTRVQgPSAxNjA7CiAgdmFyIFNFVF9TVEFUSUNfRkxPQVRfRklFTERfT0ZGU0VUID0gMTYxOwogIHZhciBTRVRfU1RBVElDX0RPVUJMRV9GSUVMRF9PRkZTRVQgPSAxNjI7CiAgdmFyIGNhbGxNZXRob2RPZmZzZXQgPSB7CiAgICBwb2ludGVyOiBDQUxMX09CSkVDVF9NRVRIT0RfT0ZGU0VULAogICAgdWludDg6IENBTExfQk9PTEVBTl9NRVRIT0RfT0ZGU0VULAogICAgaW50ODogQ0FMTF9CWVRFX01FVEhPRF9PRkZTRVQsCiAgICB1aW50MTY6IENBTExfQ0hBUl9NRVRIT0RfT0ZGU0VULAogICAgaW50MTY6IENBTExfU0hPUlRfTUVUSE9EX09GRlNFVCwKICAgIGludDMyOiBDQUxMX0lOVF9NRVRIT0RfT0ZGU0VULAogICAgaW50NjQ6IENBTExfTE9OR19NRVRIT0RfT0ZGU0VULAogICAgZmxvYXQ6IENBTExfRkxPQVRfTUVUSE9EX09GRlNFVCwKICAgIGRvdWJsZTogQ0FMTF9ET1VCTEVfTUVUSE9EX09GRlNFVCwKICAgIHZvaWQ6IENBTExfVk9JRF9NRVRIT0RfT0ZGU0VUCiAgfTsKICB2YXIgY2FsbE5vbnZpcnR1YWxNZXRob2RPZmZzZXQgPSB7CiAgICBwb2ludGVyOiBDQUxMX05PTlZJUlRVQUxfT0JKRUNUX01FVEhPRF9PRkZTRVQsCiAgICB1aW50ODogQ0FMTF9OT05WSVJUVUFMX0JPT0xFQU5fTUVUSE9EX09GRlNFVCwKICAgIGludDg6IENBTExfTk9OVklSVFVBTF9CWVRFX01FVEhPRF9PRkZTRVQsCiAgICB1aW50MTY6IENBTExfTk9OVklSVFVBTF9DSEFSX01FVEhPRF9PRkZTRVQsCiAgICBpbnQxNjogQ0FMTF9OT05WSVJUVUFMX1NIT1JUX01FVEhPRF9PRkZTRVQsCiAgICBpbnQzMjogQ0FMTF9OT05WSVJUVUFMX0lOVF9NRVRIT0RfT0ZGU0VULAogICAgaW50NjQ6IENBTExfTk9OVklSVFVBTF9MT05HX01FVEhPRF9PRkZTRVQsCiAgICBmbG9hdDogQ0FMTF9OT05WSVJUVUFMX0ZMT0FUX01FVEhPRF9PRkZTRVQsCiAgICBkb3VibGU6IENBTExfTk9OVklSVFVBTF9ET1VCTEVfTUVUSE9EX09GRlNFVCwKICAgIHZvaWQ6IENBTExfTk9OVklSVFVBTF9WT0lEX01FVEhPRF9PRkZTRVQKICB9OwogIHZhciBjYWxsU3RhdGljTWV0aG9kT2Zmc2V0ID0gewogICAgcG9pbnRlcjogQ0FMTF9TVEFUSUNfT0JKRUNUX01FVEhPRF9PRkZTRVQsCiAgICB1aW50ODogQ0FMTF9TVEFUSUNfQk9PTEVBTl9NRVRIT0RfT0ZGU0VULAogICAgaW50ODogQ0FMTF9TVEFUSUNfQllURV9NRVRIT0RfT0ZGU0VULAogICAgdWludDE2OiBDQUxMX1NUQVRJQ19DSEFSX01FVEhPRF9PRkZTRVQsCiAgICBpbnQxNjogQ0FMTF9TVEFUSUNfU0hPUlRfTUVUSE9EX09GRlNFVCwKICAgIGludDMyOiBDQUxMX1NUQVRJQ19JTlRfTUVUSE9EX09GRlNFVCwKICAgIGludDY0OiBDQUxMX1NUQVRJQ19MT05HX01FVEhPRF9PRkZTRVQsCiAgICBmbG9hdDogQ0FMTF9TVEFUSUNfRkxPQVRfTUVUSE9EX09GRlNFVCwKICAgIGRvdWJsZTogQ0FMTF9TVEFUSUNfRE9VQkxFX01FVEhPRF9PRkZTRVQsCiAgICB2b2lkOiBDQUxMX1NUQVRJQ19WT0lEX01FVEhPRF9PRkZTRVQKICB9OwogIHZhciBnZXRGaWVsZE9mZnNldCA9IHsKICAgIHBvaW50ZXI6IEdFVF9PQkpFQ1RfRklFTERfT0ZGU0VULAogICAgdWludDg6IEdFVF9CT09MRUFOX0ZJRUxEX09GRlNFVCwKICAgIGludDg6IEdFVF9CWVRFX0ZJRUxEX09GRlNFVCwKICAgIHVpbnQxNjogR0VUX0NIQVJfRklFTERfT0ZGU0VULAogICAgaW50MTY6IEdFVF9TSE9SVF9GSUVMRF9PRkZTRVQsCiAgICBpbnQzMjogR0VUX0lOVF9GSUVMRF9PRkZTRVQsCiAgICBpbnQ2NDogR0VUX0xPTkdfRklFTERfT0ZGU0VULAogICAgZmxvYXQ6IEdFVF9GTE9BVF9GSUVMRF9PRkZTRVQsCiAgICBkb3VibGU6IEdFVF9ET1VCTEVfRklFTERfT0ZGU0VUCiAgfTsKICB2YXIgc2V0RmllbGRPZmZzZXQgPSB7CiAgICBwb2ludGVyOiBTRVRfT0JKRUNUX0ZJRUxEX09GRlNFVCwKICAgIHVpbnQ4OiBTRVRfQk9PTEVBTl9GSUVMRF9PRkZTRVQsCiAgICBpbnQ4OiBTRVRfQllURV9GSUVMRF9PRkZTRVQsCiAgICB1aW50MTY6IFNFVF9DSEFSX0ZJRUxEX09GRlNFVCwKICAgIGludDE2OiBTRVRfU0hPUlRfRklFTERfT0ZGU0VULAogICAgaW50MzI6IFNFVF9JTlRfRklFTERfT0ZGU0VULAogICAgaW50NjQ6IFNFVF9MT05HX0ZJRUxEX09GRlNFVCwKICAgIGZsb2F0OiBTRVRfRkxPQVRfRklFTERfT0ZGU0VULAogICAgZG91YmxlOiBTRVRfRE9VQkxFX0ZJRUxEX09GRlNFVAogIH07CiAgdmFyIGdldFN0YXRpY0ZpZWxkT2Zmc2V0ID0gewogICAgcG9pbnRlcjogR0VUX1NUQVRJQ19PQkpFQ1RfRklFTERfT0ZGU0VULAogICAgdWludDg6IEdFVF9TVEFUSUNfQk9PTEVBTl9GSUVMRF9PRkZTRVQsCiAgICBpbnQ4OiBHRVRfU1RBVElDX0JZVEVfRklFTERfT0ZGU0VULAogICAgdWludDE2OiBHRVRfU1RBVElDX0NIQVJfRklFTERfT0ZGU0VULAogICAgaW50MTY6IEdFVF9TVEFUSUNfU0hPUlRfRklFTERfT0ZGU0VULAogICAgaW50MzI6IEdFVF9TVEFUSUNfSU5UX0ZJRUxEX09GRlNFVCwKICAgIGludDY0OiBHRVRfU1RBVElDX0xPTkdfRklFTERfT0ZGU0VULAogICAgZmxvYXQ6IEdFVF9TVEFUSUNfRkxPQVRfRklFTERfT0ZGU0VULAogICAgZG91YmxlOiBHRVRfU1RBVElDX0RPVUJMRV9GSUVMRF9PRkZTRVQKICB9OwogIHZhciBzZXRTdGF0aWNGaWVsZE9mZnNldCA9IHsKICAgIHBvaW50ZXI6IFNFVF9TVEFUSUNfT0JKRUNUX0ZJRUxEX09GRlNFVCwKICAgIHVpbnQ4OiBTRVRfU1RBVElDX0JPT0xFQU5fRklFTERfT0ZGU0VULAogICAgaW50ODogU0VUX1NUQVRJQ19CWVRFX0ZJRUxEX09GRlNFVCwKICAgIHVpbnQxNjogU0VUX1NUQVRJQ19DSEFSX0ZJRUxEX09GRlNFVCwKICAgIGludDE2OiBTRVRfU1RBVElDX1NIT1JUX0ZJRUxEX09GRlNFVCwKICAgIGludDMyOiBTRVRfU1RBVElDX0lOVF9GSUVMRF9PRkZTRVQsCiAgICBpbnQ2NDogU0VUX1NUQVRJQ19MT05HX0ZJRUxEX09GRlNFVCwKICAgIGZsb2F0OiBTRVRfU1RBVElDX0ZMT0FUX0ZJRUxEX09GRlNFVCwKICAgIGRvdWJsZTogU0VUX1NUQVRJQ19ET1VCTEVfRklFTERfT0ZGU0VUCiAgfTsKICB2YXIgbmF0aXZlRnVuY3Rpb25PcHRpb25zMiA9IHsKICAgIGV4Y2VwdGlvbnM6ICJwcm9wYWdhdGUiCiAgfTsKICB2YXIgY2FjaGVkVnRhYmxlID0gbnVsbDsKICB2YXIgZ2xvYmFsUmVmcyA9IFtdOwogIEVudi5kaXNwb3NlID0gZnVuY3Rpb24oZW52KSB7CiAgICBnbG9iYWxSZWZzLmZvckVhY2goZW52LmRlbGV0ZUdsb2JhbFJlZiwgZW52KTsKICAgIGdsb2JhbFJlZnMgPSBbXTsKICB9OwogIGZ1bmN0aW9uIHJlZ2lzdGVyKGdsb2JhbFJlZikgewogICAgZ2xvYmFsUmVmcy5wdXNoKGdsb2JhbFJlZik7CiAgICByZXR1cm4gZ2xvYmFsUmVmOwogIH0KICBmdW5jdGlvbiB2dGFibGUoaW5zdGFuY2UpIHsKICAgIGlmIChjYWNoZWRWdGFibGUgPT09IG51bGwpIHsKICAgICAgY2FjaGVkVnRhYmxlID0gaW5zdGFuY2UuaGFuZGxlLnJlYWRQb2ludGVyKCk7CiAgICB9CiAgICByZXR1cm4gY2FjaGVkVnRhYmxlOwogIH0KICBmdW5jdGlvbiBwcm94eTIob2Zmc2V0LCByZXRUeXBlLCBhcmdUeXBlcywgd3JhcHBlcikgewogICAgbGV0IGltcGwgPSBudWxsOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBpZiAoaW1wbCA9PT0gbnVsbCkgewogICAgICAgIGltcGwgPSBuZXcgTmF0aXZlRnVuY3Rpb24odnRhYmxlKHRoaXMpLmFkZChvZmZzZXQgKiBwb2ludGVyU2l6ZTMpLnJlYWRQb2ludGVyKCksIHJldFR5cGUsIGFyZ1R5cGVzLCBuYXRpdmVGdW5jdGlvbk9wdGlvbnMyKTsKICAgICAgfQogICAgICBsZXQgYXJncyA9IFtpbXBsXTsKICAgICAgYXJncyA9IGFyZ3MuY29uY2F0LmFwcGx5KGFyZ3MsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB3cmFwcGVyLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfTsKICB9CiAgRW52LnByb3RvdHlwZS5nZXRWZXJzaW9uID0gcHJveHkyKDQsICJpbnQzMiIsIFsicG9pbnRlciJdLCBmdW5jdGlvbihpbXBsKSB7CiAgICByZXR1cm4gaW1wbCh0aGlzLmhhbmRsZSk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5maW5kQ2xhc3MgPSBwcm94eTIoNiwgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAicG9pbnRlciJdLCBmdW5jdGlvbihpbXBsLCBuYW1lKSB7CiAgICBjb25zdCByZXN1bHQgPSBpbXBsKHRoaXMuaGFuZGxlLCBNZW1vcnkuYWxsb2NVdGY4U3RyaW5nKG5hbWUpKTsKICAgIHRoaXMudGhyb3dJZkV4Y2VwdGlvblBlbmRpbmcoKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfSk7CiAgRW52LnByb3RvdHlwZS50aHJvd0lmRXhjZXB0aW9uUGVuZGluZyA9IGZ1bmN0aW9uKCkgewogICAgY29uc3QgdGhyb3dhYmxlID0gdGhpcy5leGNlcHRpb25PY2N1cnJlZCgpOwogICAgaWYgKHRocm93YWJsZS5pc051bGwoKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmV4Y2VwdGlvbkNsZWFyKCk7CiAgICBjb25zdCBoYW5kbGUgPSB0aGlzLm5ld0dsb2JhbFJlZih0aHJvd2FibGUpOwogICAgdGhpcy5kZWxldGVMb2NhbFJlZih0aHJvd2FibGUpOwogICAgY29uc3QgZGVzY3JpcHRpb24gPSB0aGlzLnZhTWV0aG9kKCJwb2ludGVyIiwgW10pKHRoaXMuaGFuZGxlLCBoYW5kbGUsIHRoaXMuamF2YUxhbmdPYmplY3QoKS50b1N0cmluZyk7CiAgICBjb25zdCBkZXNjcmlwdGlvblN0ciA9IHRoaXMuc3RyaW5nRnJvbUpuaShkZXNjcmlwdGlvbik7CiAgICB0aGlzLmRlbGV0ZUxvY2FsUmVmKGRlc2NyaXB0aW9uKTsKICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKGRlc2NyaXB0aW9uU3RyKTsKICAgIGVycm9yLiRoID0gaGFuZGxlOwogICAgU2NyaXB0LmJpbmRXZWFrKGVycm9yLCBtYWtlRXJyb3JIYW5kbGVEZXN0cnVjdG9yKHRoaXMudm0sIGhhbmRsZSkpOwogICAgdGhyb3cgZXJyb3I7CiAgfTsKICBmdW5jdGlvbiBtYWtlRXJyb3JIYW5kbGVEZXN0cnVjdG9yKHZtMywgaGFuZGxlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZtMy5wZXJmb3JtKChlbnYpID0+IHsKICAgICAgICBlbnYuZGVsZXRlR2xvYmFsUmVmKGhhbmRsZSk7CiAgICAgIH0pOwogICAgfTsKICB9CiAgRW52LnByb3RvdHlwZS5mcm9tUmVmbGVjdGVkTWV0aG9kID0gcHJveHkyKDcsICJwb2ludGVyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwgbWV0aG9kKSB7CiAgICByZXR1cm4gaW1wbCh0aGlzLmhhbmRsZSwgbWV0aG9kKTsKICB9KTsKICBFbnYucHJvdG90eXBlLmZyb21SZWZsZWN0ZWRGaWVsZCA9IHByb3h5Mig4LCAicG9pbnRlciIsIFsicG9pbnRlciIsICJwb2ludGVyIl0sIGZ1bmN0aW9uKGltcGwsIG1ldGhvZCkgewogICAgcmV0dXJuIGltcGwodGhpcy5oYW5kbGUsIG1ldGhvZCk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS50b1JlZmxlY3RlZE1ldGhvZCA9IHByb3h5Mig5LCAicG9pbnRlciIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgInBvaW50ZXIiLCAidWludDgiXSwgZnVuY3Rpb24oaW1wbCwga2xhc3MsIG1ldGhvZElkLCBpc1N0YXRpYykgewogICAgcmV0dXJuIGltcGwodGhpcy5oYW5kbGUsIGtsYXNzLCBtZXRob2RJZCwgaXNTdGF0aWMpOwogIH0pOwogIEVudi5wcm90b3R5cGUuZ2V0U3VwZXJjbGFzcyA9IHByb3h5MigxMCwgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAicG9pbnRlciJdLCBmdW5jdGlvbihpbXBsLCBrbGFzcykgewogICAgcmV0dXJuIGltcGwodGhpcy5oYW5kbGUsIGtsYXNzKTsKICB9KTsKICBFbnYucHJvdG90eXBlLmlzQXNzaWduYWJsZUZyb20gPSBwcm94eTIoMTEsICJ1aW50OCIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwga2xhc3MxLCBrbGFzczIpIHsKICAgIHJldHVybiAhIWltcGwodGhpcy5oYW5kbGUsIGtsYXNzMSwga2xhc3MyKTsKICB9KTsKICBFbnYucHJvdG90eXBlLnRvUmVmbGVjdGVkRmllbGQgPSBwcm94eTIoMTIsICJwb2ludGVyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciIsICJ1aW50OCJdLCBmdW5jdGlvbihpbXBsLCBrbGFzcywgZmllbGRJZCwgaXNTdGF0aWMpIHsKICAgIHJldHVybiBpbXBsKHRoaXMuaGFuZGxlLCBrbGFzcywgZmllbGRJZCwgaXNTdGF0aWMpOwogIH0pOwogIEVudi5wcm90b3R5cGUudGhyb3cgPSBwcm94eTIoMTMsICJpbnQzMiIsIFsicG9pbnRlciIsICJwb2ludGVyIl0sIGZ1bmN0aW9uKGltcGwsIG9iaikgewogICAgcmV0dXJuIGltcGwodGhpcy5oYW5kbGUsIG9iaik7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5leGNlcHRpb25PY2N1cnJlZCA9IHByb3h5MigxNSwgInBvaW50ZXIiLCBbInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCkgewogICAgcmV0dXJuIGltcGwodGhpcy5oYW5kbGUpOwogIH0pOwogIEVudi5wcm90b3R5cGUuZXhjZXB0aW9uRGVzY3JpYmUgPSBwcm94eTIoMTYsICJ2b2lkIiwgWyJwb2ludGVyIl0sIGZ1bmN0aW9uKGltcGwpIHsKICAgIGltcGwodGhpcy5oYW5kbGUpOwogIH0pOwogIEVudi5wcm90b3R5cGUuZXhjZXB0aW9uQ2xlYXIgPSBwcm94eTIoMTcsICJ2b2lkIiwgWyJwb2ludGVyIl0sIGZ1bmN0aW9uKGltcGwpIHsKICAgIGltcGwodGhpcy5oYW5kbGUpOwogIH0pOwogIEVudi5wcm90b3R5cGUucHVzaExvY2FsRnJhbWUgPSBwcm94eTIoMTksICJpbnQzMiIsIFsicG9pbnRlciIsICJpbnQzMiJdLCBmdW5jdGlvbihpbXBsLCBjYXBhY2l0eSkgewogICAgcmV0dXJuIGltcGwodGhpcy5oYW5kbGUsIGNhcGFjaXR5KTsKICB9KTsKICBFbnYucHJvdG90eXBlLnBvcExvY2FsRnJhbWUgPSBwcm94eTIoMjAsICJwb2ludGVyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwgcmVzdWx0KSB7CiAgICByZXR1cm4gaW1wbCh0aGlzLmhhbmRsZSwgcmVzdWx0KTsKICB9KTsKICBFbnYucHJvdG90eXBlLm5ld0dsb2JhbFJlZiA9IHByb3h5MigyMSwgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAicG9pbnRlciJdLCBmdW5jdGlvbihpbXBsLCBvYmopIHsKICAgIHJldHVybiBpbXBsKHRoaXMuaGFuZGxlLCBvYmopOwogIH0pOwogIEVudi5wcm90b3R5cGUuZGVsZXRlR2xvYmFsUmVmID0gcHJveHkyKDIyLCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIl0sIGZ1bmN0aW9uKGltcGwsIGdsb2JhbFJlZikgewogICAgaW1wbCh0aGlzLmhhbmRsZSwgZ2xvYmFsUmVmKTsKICB9KTsKICBFbnYucHJvdG90eXBlLmRlbGV0ZUxvY2FsUmVmID0gcHJveHkyKDIzLCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIl0sIGZ1bmN0aW9uKGltcGwsIGxvY2FsUmVmKSB7CiAgICBpbXBsKHRoaXMuaGFuZGxlLCBsb2NhbFJlZik7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5pc1NhbWVPYmplY3QgPSBwcm94eTIoMjQsICJ1aW50OCIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwgcmVmMSwgcmVmMikgewogICAgcmV0dXJuICEhaW1wbCh0aGlzLmhhbmRsZSwgcmVmMSwgcmVmMik7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5uZXdMb2NhbFJlZiA9IHByb3h5MigyNSwgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAicG9pbnRlciJdLCBmdW5jdGlvbihpbXBsLCBvYmopIHsKICAgIHJldHVybiBpbXBsKHRoaXMuaGFuZGxlLCBvYmopOwogIH0pOwogIEVudi5wcm90b3R5cGUuYWxsb2NPYmplY3QgPSBwcm94eTIoMjcsICJwb2ludGVyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwgY2xhenopIHsKICAgIHJldHVybiBpbXBsKHRoaXMuaGFuZGxlLCBjbGF6eik7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5nZXRPYmplY3RDbGFzcyA9IHByb3h5MigzMSwgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAicG9pbnRlciJdLCBmdW5jdGlvbihpbXBsLCBvYmopIHsKICAgIHJldHVybiBpbXBsKHRoaXMuaGFuZGxlLCBvYmopOwogIH0pOwogIEVudi5wcm90b3R5cGUuaXNJbnN0YW5jZU9mID0gcHJveHkyKDMyLCAidWludDgiLCBbInBvaW50ZXIiLCAicG9pbnRlciIsICJwb2ludGVyIl0sIGZ1bmN0aW9uKGltcGwsIG9iaiwga2xhc3MpIHsKICAgIHJldHVybiAhIWltcGwodGhpcy5oYW5kbGUsIG9iaiwga2xhc3MpOwogIH0pOwogIEVudi5wcm90b3R5cGUuZ2V0TWV0aG9kSWQgPSBwcm94eTIoMzMsICJwb2ludGVyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciIsICJwb2ludGVyIl0sIGZ1bmN0aW9uKGltcGwsIGtsYXNzLCBuYW1lLCBzaWcpIHsKICAgIHJldHVybiBpbXBsKHRoaXMuaGFuZGxlLCBrbGFzcywgTWVtb3J5LmFsbG9jVXRmOFN0cmluZyhuYW1lKSwgTWVtb3J5LmFsbG9jVXRmOFN0cmluZyhzaWcpKTsKICB9KTsKICBFbnYucHJvdG90eXBlLmdldEZpZWxkSWQgPSBwcm94eTIoOTQsICJwb2ludGVyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciIsICJwb2ludGVyIl0sIGZ1bmN0aW9uKGltcGwsIGtsYXNzLCBuYW1lLCBzaWcpIHsKICAgIHJldHVybiBpbXBsKHRoaXMuaGFuZGxlLCBrbGFzcywgTWVtb3J5LmFsbG9jVXRmOFN0cmluZyhuYW1lKSwgTWVtb3J5LmFsbG9jVXRmOFN0cmluZyhzaWcpKTsKICB9KTsKICBFbnYucHJvdG90eXBlLmdldEludEZpZWxkID0gcHJveHkyKDEwMCwgImludDMyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciJdLCBmdW5jdGlvbihpbXBsLCBvYmosIGZpZWxkSWQpIHsKICAgIHJldHVybiBpbXBsKHRoaXMuaGFuZGxlLCBvYmosIGZpZWxkSWQpOwogIH0pOwogIEVudi5wcm90b3R5cGUuZ2V0U3RhdGljTWV0aG9kSWQgPSBwcm94eTIoMTEzLCAicG9pbnRlciIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciJdLCBmdW5jdGlvbihpbXBsLCBrbGFzcywgbmFtZSwgc2lnKSB7CiAgICByZXR1cm4gaW1wbCh0aGlzLmhhbmRsZSwga2xhc3MsIE1lbW9yeS5hbGxvY1V0ZjhTdHJpbmcobmFtZSksIE1lbW9yeS5hbGxvY1V0ZjhTdHJpbmcoc2lnKSk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5nZXRTdGF0aWNGaWVsZElkID0gcHJveHkyKDE0NCwgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAicG9pbnRlciIsICJwb2ludGVyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwga2xhc3MsIG5hbWUsIHNpZykgewogICAgcmV0dXJuIGltcGwodGhpcy5oYW5kbGUsIGtsYXNzLCBNZW1vcnkuYWxsb2NVdGY4U3RyaW5nKG5hbWUpLCBNZW1vcnkuYWxsb2NVdGY4U3RyaW5nKHNpZykpOwogIH0pOwogIEVudi5wcm90b3R5cGUuZ2V0U3RhdGljSW50RmllbGQgPSBwcm94eTIoMTUwLCAiaW50MzIiLCBbInBvaW50ZXIiLCAicG9pbnRlciIsICJwb2ludGVyIl0sIGZ1bmN0aW9uKGltcGwsIG9iaiwgZmllbGRJZCkgewogICAgcmV0dXJuIGltcGwodGhpcy5oYW5kbGUsIG9iaiwgZmllbGRJZCk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5nZXRTdHJpbmdMZW5ndGggPSBwcm94eTIoMTY0LCAiaW50MzIiLCBbInBvaW50ZXIiLCAicG9pbnRlciJdLCBmdW5jdGlvbihpbXBsLCBzdHIpIHsKICAgIHJldHVybiBpbXBsKHRoaXMuaGFuZGxlLCBzdHIpOwogIH0pOwogIEVudi5wcm90b3R5cGUuZ2V0U3RyaW5nQ2hhcnMgPSBwcm94eTIoMTY1LCAicG9pbnRlciIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwgc3RyKSB7CiAgICByZXR1cm4gaW1wbCh0aGlzLmhhbmRsZSwgc3RyLCBOVUxMKTsKICB9KTsKICBFbnYucHJvdG90eXBlLnJlbGVhc2VTdHJpbmdDaGFycyA9IHByb3h5MigxNjYsICJ2b2lkIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciJdLCBmdW5jdGlvbihpbXBsLCBzdHIsIHV0ZikgewogICAgaW1wbCh0aGlzLmhhbmRsZSwgc3RyLCB1dGYpOwogIH0pOwogIEVudi5wcm90b3R5cGUubmV3U3RyaW5nVXRmID0gcHJveHkyKDE2NywgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAicG9pbnRlciJdLCBmdW5jdGlvbihpbXBsLCBzdHIpIHsKICAgIGNvbnN0IHV0ZiA9IE1lbW9yeS5hbGxvY1V0ZjhTdHJpbmcoc3RyKTsKICAgIHJldHVybiBpbXBsKHRoaXMuaGFuZGxlLCB1dGYpOwogIH0pOwogIEVudi5wcm90b3R5cGUuZ2V0U3RyaW5nVXRmQ2hhcnMgPSBwcm94eTIoMTY5LCAicG9pbnRlciIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwgc3RyKSB7CiAgICByZXR1cm4gaW1wbCh0aGlzLmhhbmRsZSwgc3RyLCBOVUxMKTsKICB9KTsKICBFbnYucHJvdG90eXBlLnJlbGVhc2VTdHJpbmdVdGZDaGFycyA9IHByb3h5MigxNzAsICJ2b2lkIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciJdLCBmdW5jdGlvbihpbXBsLCBzdHIsIHV0ZikgewogICAgaW1wbCh0aGlzLmhhbmRsZSwgc3RyLCB1dGYpOwogIH0pOwogIEVudi5wcm90b3R5cGUuZ2V0QXJyYXlMZW5ndGggPSBwcm94eTIoMTcxLCAiaW50MzIiLCBbInBvaW50ZXIiLCAicG9pbnRlciJdLCBmdW5jdGlvbihpbXBsLCBhcnJheSkgewogICAgcmV0dXJuIGltcGwodGhpcy5oYW5kbGUsIGFycmF5KTsKICB9KTsKICBFbnYucHJvdG90eXBlLm5ld09iamVjdEFycmF5ID0gcHJveHkyKDE3MiwgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAiaW50MzIiLCAicG9pbnRlciIsICJwb2ludGVyIl0sIGZ1bmN0aW9uKGltcGwsIGxlbmd0aCwgZWxlbWVudENsYXNzLCBpbml0aWFsRWxlbWVudCkgewogICAgcmV0dXJuIGltcGwodGhpcy5oYW5kbGUsIGxlbmd0aCwgZWxlbWVudENsYXNzLCBpbml0aWFsRWxlbWVudCk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5nZXRPYmplY3RBcnJheUVsZW1lbnQgPSBwcm94eTIoMTczLCAicG9pbnRlciIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgImludDMyIl0sIGZ1bmN0aW9uKGltcGwsIGFycmF5LCBpbmRleCkgewogICAgcmV0dXJuIGltcGwodGhpcy5oYW5kbGUsIGFycmF5LCBpbmRleCk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5zZXRPYmplY3RBcnJheUVsZW1lbnQgPSBwcm94eTIoMTc0LCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgImludDMyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwgYXJyYXksIGluZGV4LCB2YWx1ZSkgewogICAgaW1wbCh0aGlzLmhhbmRsZSwgYXJyYXksIGluZGV4LCB2YWx1ZSk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5uZXdCb29sZWFuQXJyYXkgPSBwcm94eTIoMTc1LCAicG9pbnRlciIsIFsicG9pbnRlciIsICJpbnQzMiJdLCBmdW5jdGlvbihpbXBsLCBsZW5ndGgpIHsKICAgIHJldHVybiBpbXBsKHRoaXMuaGFuZGxlLCBsZW5ndGgpOwogIH0pOwogIEVudi5wcm90b3R5cGUubmV3Qnl0ZUFycmF5ID0gcHJveHkyKDE3NiwgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAiaW50MzIiXSwgZnVuY3Rpb24oaW1wbCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gaW1wbCh0aGlzLmhhbmRsZSwgbGVuZ3RoKTsKICB9KTsKICBFbnYucHJvdG90eXBlLm5ld0NoYXJBcnJheSA9IHByb3h5MigxNzcsICJwb2ludGVyIiwgWyJwb2ludGVyIiwgImludDMyIl0sIGZ1bmN0aW9uKGltcGwsIGxlbmd0aCkgewogICAgcmV0dXJuIGltcGwodGhpcy5oYW5kbGUsIGxlbmd0aCk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5uZXdTaG9ydEFycmF5ID0gcHJveHkyKDE3OCwgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAiaW50MzIiXSwgZnVuY3Rpb24oaW1wbCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gaW1wbCh0aGlzLmhhbmRsZSwgbGVuZ3RoKTsKICB9KTsKICBFbnYucHJvdG90eXBlLm5ld0ludEFycmF5ID0gcHJveHkyKDE3OSwgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAiaW50MzIiXSwgZnVuY3Rpb24oaW1wbCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gaW1wbCh0aGlzLmhhbmRsZSwgbGVuZ3RoKTsKICB9KTsKICBFbnYucHJvdG90eXBlLm5ld0xvbmdBcnJheSA9IHByb3h5MigxODAsICJwb2ludGVyIiwgWyJwb2ludGVyIiwgImludDMyIl0sIGZ1bmN0aW9uKGltcGwsIGxlbmd0aCkgewogICAgcmV0dXJuIGltcGwodGhpcy5oYW5kbGUsIGxlbmd0aCk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5uZXdGbG9hdEFycmF5ID0gcHJveHkyKDE4MSwgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAiaW50MzIiXSwgZnVuY3Rpb24oaW1wbCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gaW1wbCh0aGlzLmhhbmRsZSwgbGVuZ3RoKTsKICB9KTsKICBFbnYucHJvdG90eXBlLm5ld0RvdWJsZUFycmF5ID0gcHJveHkyKDE4MiwgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAiaW50MzIiXSwgZnVuY3Rpb24oaW1wbCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gaW1wbCh0aGlzLmhhbmRsZSwgbGVuZ3RoKTsKICB9KTsKICBFbnYucHJvdG90eXBlLmdldEJvb2xlYW5BcnJheUVsZW1lbnRzID0gcHJveHkyKDE4MywgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAicG9pbnRlciIsICJwb2ludGVyIl0sIGZ1bmN0aW9uKGltcGwsIGFycmF5KSB7CiAgICByZXR1cm4gaW1wbCh0aGlzLmhhbmRsZSwgYXJyYXksIE5VTEwpOwogIH0pOwogIEVudi5wcm90b3R5cGUuZ2V0Qnl0ZUFycmF5RWxlbWVudHMgPSBwcm94eTIoMTg0LCAicG9pbnRlciIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwgYXJyYXkpIHsKICAgIHJldHVybiBpbXBsKHRoaXMuaGFuZGxlLCBhcnJheSwgTlVMTCk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5nZXRDaGFyQXJyYXlFbGVtZW50cyA9IHByb3h5MigxODUsICJwb2ludGVyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciJdLCBmdW5jdGlvbihpbXBsLCBhcnJheSkgewogICAgcmV0dXJuIGltcGwodGhpcy5oYW5kbGUsIGFycmF5LCBOVUxMKTsKICB9KTsKICBFbnYucHJvdG90eXBlLmdldFNob3J0QXJyYXlFbGVtZW50cyA9IHByb3h5MigxODYsICJwb2ludGVyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciJdLCBmdW5jdGlvbihpbXBsLCBhcnJheSkgewogICAgcmV0dXJuIGltcGwodGhpcy5oYW5kbGUsIGFycmF5LCBOVUxMKTsKICB9KTsKICBFbnYucHJvdG90eXBlLmdldEludEFycmF5RWxlbWVudHMgPSBwcm94eTIoMTg3LCAicG9pbnRlciIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwgYXJyYXkpIHsKICAgIHJldHVybiBpbXBsKHRoaXMuaGFuZGxlLCBhcnJheSwgTlVMTCk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5nZXRMb25nQXJyYXlFbGVtZW50cyA9IHByb3h5MigxODgsICJwb2ludGVyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciJdLCBmdW5jdGlvbihpbXBsLCBhcnJheSkgewogICAgcmV0dXJuIGltcGwodGhpcy5oYW5kbGUsIGFycmF5LCBOVUxMKTsKICB9KTsKICBFbnYucHJvdG90eXBlLmdldEZsb2F0QXJyYXlFbGVtZW50cyA9IHByb3h5MigxODksICJwb2ludGVyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciJdLCBmdW5jdGlvbihpbXBsLCBhcnJheSkgewogICAgcmV0dXJuIGltcGwodGhpcy5oYW5kbGUsIGFycmF5LCBOVUxMKTsKICB9KTsKICBFbnYucHJvdG90eXBlLmdldERvdWJsZUFycmF5RWxlbWVudHMgPSBwcm94eTIoMTkwLCAicG9pbnRlciIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwgYXJyYXkpIHsKICAgIHJldHVybiBpbXBsKHRoaXMuaGFuZGxlLCBhcnJheSwgTlVMTCk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5yZWxlYXNlQm9vbGVhbkFycmF5RWxlbWVudHMgPSBwcm94eTIoMTkxLCAicG9pbnRlciIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgInBvaW50ZXIiLCAiaW50MzIiXSwgZnVuY3Rpb24oaW1wbCwgYXJyYXksIGNBcnJheSkgewogICAgaW1wbCh0aGlzLmhhbmRsZSwgYXJyYXksIGNBcnJheSwgSk5JX0FCT1JUKTsKICB9KTsKICBFbnYucHJvdG90eXBlLnJlbGVhc2VCeXRlQXJyYXlFbGVtZW50cyA9IHByb3h5MigxOTIsICJwb2ludGVyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciIsICJpbnQzMiJdLCBmdW5jdGlvbihpbXBsLCBhcnJheSwgY0FycmF5KSB7CiAgICBpbXBsKHRoaXMuaGFuZGxlLCBhcnJheSwgY0FycmF5LCBKTklfQUJPUlQpOwogIH0pOwogIEVudi5wcm90b3R5cGUucmVsZWFzZUNoYXJBcnJheUVsZW1lbnRzID0gcHJveHkyKDE5MywgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAicG9pbnRlciIsICJwb2ludGVyIiwgImludDMyIl0sIGZ1bmN0aW9uKGltcGwsIGFycmF5LCBjQXJyYXkpIHsKICAgIGltcGwodGhpcy5oYW5kbGUsIGFycmF5LCBjQXJyYXksIEpOSV9BQk9SVCk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5yZWxlYXNlU2hvcnRBcnJheUVsZW1lbnRzID0gcHJveHkyKDE5NCwgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAicG9pbnRlciIsICJwb2ludGVyIiwgImludDMyIl0sIGZ1bmN0aW9uKGltcGwsIGFycmF5LCBjQXJyYXkpIHsKICAgIGltcGwodGhpcy5oYW5kbGUsIGFycmF5LCBjQXJyYXksIEpOSV9BQk9SVCk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5yZWxlYXNlSW50QXJyYXlFbGVtZW50cyA9IHByb3h5MigxOTUsICJwb2ludGVyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciIsICJpbnQzMiJdLCBmdW5jdGlvbihpbXBsLCBhcnJheSwgY0FycmF5KSB7CiAgICBpbXBsKHRoaXMuaGFuZGxlLCBhcnJheSwgY0FycmF5LCBKTklfQUJPUlQpOwogIH0pOwogIEVudi5wcm90b3R5cGUucmVsZWFzZUxvbmdBcnJheUVsZW1lbnRzID0gcHJveHkyKDE5NiwgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAicG9pbnRlciIsICJwb2ludGVyIiwgImludDMyIl0sIGZ1bmN0aW9uKGltcGwsIGFycmF5LCBjQXJyYXkpIHsKICAgIGltcGwodGhpcy5oYW5kbGUsIGFycmF5LCBjQXJyYXksIEpOSV9BQk9SVCk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5yZWxlYXNlRmxvYXRBcnJheUVsZW1lbnRzID0gcHJveHkyKDE5NywgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAicG9pbnRlciIsICJwb2ludGVyIiwgImludDMyIl0sIGZ1bmN0aW9uKGltcGwsIGFycmF5LCBjQXJyYXkpIHsKICAgIGltcGwodGhpcy5oYW5kbGUsIGFycmF5LCBjQXJyYXksIEpOSV9BQk9SVCk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5yZWxlYXNlRG91YmxlQXJyYXlFbGVtZW50cyA9IHByb3h5MigxOTgsICJwb2ludGVyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciIsICJpbnQzMiJdLCBmdW5jdGlvbihpbXBsLCBhcnJheSwgY0FycmF5KSB7CiAgICBpbXBsKHRoaXMuaGFuZGxlLCBhcnJheSwgY0FycmF5LCBKTklfQUJPUlQpOwogIH0pOwogIEVudi5wcm90b3R5cGUuZ2V0Qnl0ZUFycmF5UmVnaW9uID0gcHJveHkyKDIwMCwgInZvaWQiLCBbInBvaW50ZXIiLCAicG9pbnRlciIsICJpbnQiLCAiaW50IiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwgYXJyYXksIHN0YXJ0LCBsZW5ndGgsIGNBcnJheSkgewogICAgaW1wbCh0aGlzLmhhbmRsZSwgYXJyYXksIHN0YXJ0LCBsZW5ndGgsIGNBcnJheSk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5zZXRCb29sZWFuQXJyYXlSZWdpb24gPSBwcm94eTIoMjA3LCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgImludDMyIiwgImludDMyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwgYXJyYXksIHN0YXJ0LCBsZW5ndGgsIGNBcnJheSkgewogICAgaW1wbCh0aGlzLmhhbmRsZSwgYXJyYXksIHN0YXJ0LCBsZW5ndGgsIGNBcnJheSk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5zZXRCeXRlQXJyYXlSZWdpb24gPSBwcm94eTIoMjA4LCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgImludDMyIiwgImludDMyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwgYXJyYXksIHN0YXJ0LCBsZW5ndGgsIGNBcnJheSkgewogICAgaW1wbCh0aGlzLmhhbmRsZSwgYXJyYXksIHN0YXJ0LCBsZW5ndGgsIGNBcnJheSk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5zZXRDaGFyQXJyYXlSZWdpb24gPSBwcm94eTIoMjA5LCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgImludDMyIiwgImludDMyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwgYXJyYXksIHN0YXJ0LCBsZW5ndGgsIGNBcnJheSkgewogICAgaW1wbCh0aGlzLmhhbmRsZSwgYXJyYXksIHN0YXJ0LCBsZW5ndGgsIGNBcnJheSk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5zZXRTaG9ydEFycmF5UmVnaW9uID0gcHJveHkyKDIxMCwgInZvaWQiLCBbInBvaW50ZXIiLCAicG9pbnRlciIsICJpbnQzMiIsICJpbnQzMiIsICJwb2ludGVyIl0sIGZ1bmN0aW9uKGltcGwsIGFycmF5LCBzdGFydCwgbGVuZ3RoLCBjQXJyYXkpIHsKICAgIGltcGwodGhpcy5oYW5kbGUsIGFycmF5LCBzdGFydCwgbGVuZ3RoLCBjQXJyYXkpOwogIH0pOwogIEVudi5wcm90b3R5cGUuc2V0SW50QXJyYXlSZWdpb24gPSBwcm94eTIoMjExLCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgImludDMyIiwgImludDMyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwgYXJyYXksIHN0YXJ0LCBsZW5ndGgsIGNBcnJheSkgewogICAgaW1wbCh0aGlzLmhhbmRsZSwgYXJyYXksIHN0YXJ0LCBsZW5ndGgsIGNBcnJheSk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5zZXRMb25nQXJyYXlSZWdpb24gPSBwcm94eTIoMjEyLCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgImludDMyIiwgImludDMyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwgYXJyYXksIHN0YXJ0LCBsZW5ndGgsIGNBcnJheSkgewogICAgaW1wbCh0aGlzLmhhbmRsZSwgYXJyYXksIHN0YXJ0LCBsZW5ndGgsIGNBcnJheSk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5zZXRGbG9hdEFycmF5UmVnaW9uID0gcHJveHkyKDIxMywgInZvaWQiLCBbInBvaW50ZXIiLCAicG9pbnRlciIsICJpbnQzMiIsICJpbnQzMiIsICJwb2ludGVyIl0sIGZ1bmN0aW9uKGltcGwsIGFycmF5LCBzdGFydCwgbGVuZ3RoLCBjQXJyYXkpIHsKICAgIGltcGwodGhpcy5oYW5kbGUsIGFycmF5LCBzdGFydCwgbGVuZ3RoLCBjQXJyYXkpOwogIH0pOwogIEVudi5wcm90b3R5cGUuc2V0RG91YmxlQXJyYXlSZWdpb24gPSBwcm94eTIoMjE0LCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgImludDMyIiwgImludDMyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwgYXJyYXksIHN0YXJ0LCBsZW5ndGgsIGNBcnJheSkgewogICAgaW1wbCh0aGlzLmhhbmRsZSwgYXJyYXksIHN0YXJ0LCBsZW5ndGgsIGNBcnJheSk7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5yZWdpc3Rlck5hdGl2ZXMgPSBwcm94eTIoMjE1LCAiaW50MzIiLCBbInBvaW50ZXIiLCAicG9pbnRlciIsICJwb2ludGVyIiwgImludDMyIl0sIGZ1bmN0aW9uKGltcGwsIGtsYXNzLCBtZXRob2RzLCBudW1NZXRob2RzKSB7CiAgICByZXR1cm4gaW1wbCh0aGlzLmhhbmRsZSwga2xhc3MsIG1ldGhvZHMsIG51bU1ldGhvZHMpOwogIH0pOwogIEVudi5wcm90b3R5cGUubW9uaXRvckVudGVyID0gcHJveHkyKDIxNywgImludDMyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwgb2JqKSB7CiAgICByZXR1cm4gaW1wbCh0aGlzLmhhbmRsZSwgb2JqKTsKICB9KTsKICBFbnYucHJvdG90eXBlLm1vbml0b3JFeGl0ID0gcHJveHkyKDIxOCwgImludDMyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwgb2JqKSB7CiAgICByZXR1cm4gaW1wbCh0aGlzLmhhbmRsZSwgb2JqKTsKICB9KTsKICBFbnYucHJvdG90eXBlLmdldERpcmVjdEJ1ZmZlckFkZHJlc3MgPSBwcm94eTIoMjMwLCAicG9pbnRlciIsIFsicG9pbnRlciIsICJwb2ludGVyIl0sIGZ1bmN0aW9uKGltcGwsIG9iaikgewogICAgcmV0dXJuIGltcGwodGhpcy5oYW5kbGUsIG9iaik7CiAgfSk7CiAgRW52LnByb3RvdHlwZS5nZXRPYmplY3RSZWZUeXBlID0gcHJveHkyKDIzMiwgImludDMyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiXSwgZnVuY3Rpb24oaW1wbCwgcmVmKSB7CiAgICByZXR1cm4gaW1wbCh0aGlzLmhhbmRsZSwgcmVmKTsKICB9KTsKICB2YXIgY2FjaGVkTWV0aG9kcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgZnVuY3Rpb24gcGxhaW5NZXRob2Qob2Zmc2V0LCByZXRUeXBlLCBhcmdUeXBlcywgb3B0aW9ucykgewogICAgcmV0dXJuIGdldE9yTWFrZU1ldGhvZCh0aGlzLCAicCIsIG1ha2VQbGFpbk1ldGhvZCwgb2Zmc2V0LCByZXRUeXBlLCBhcmdUeXBlcywgb3B0aW9ucyk7CiAgfQogIGZ1bmN0aW9uIHZhTWV0aG9kKG9mZnNldCwgcmV0VHlwZSwgYXJnVHlwZXMsIG9wdGlvbnMpIHsKICAgIHJldHVybiBnZXRPck1ha2VNZXRob2QodGhpcywgInYiLCBtYWtlVmFNZXRob2QsIG9mZnNldCwgcmV0VHlwZSwgYXJnVHlwZXMsIG9wdGlvbnMpOwogIH0KICBmdW5jdGlvbiBub252aXJ0dWFsVmFNZXRob2Qob2Zmc2V0LCByZXRUeXBlLCBhcmdUeXBlcywgb3B0aW9ucykgewogICAgcmV0dXJuIGdldE9yTWFrZU1ldGhvZCh0aGlzLCAibiIsIG1ha2VOb252aXJ0dWFsVmFNZXRob2QsIG9mZnNldCwgcmV0VHlwZSwgYXJnVHlwZXMsIG9wdGlvbnMpOwogIH0KICBmdW5jdGlvbiBnZXRPck1ha2VNZXRob2QoZW52LCBmbGF2b3IsIGNvbnN0cnVjdCwgb2Zmc2V0LCByZXRUeXBlLCBhcmdUeXBlcywgb3B0aW9ucykgewogICAgaWYgKG9wdGlvbnMgIT09IHZvaWQgMCkgewogICAgICByZXR1cm4gY29uc3RydWN0KGVudiwgb2Zmc2V0LCByZXRUeXBlLCBhcmdUeXBlcywgb3B0aW9ucyk7CiAgICB9CiAgICBjb25zdCBrZXkgPSBbb2Zmc2V0LCBmbGF2b3IsIHJldFR5cGVdLmNvbmNhdChhcmdUeXBlcykuam9pbigifCIpOwogICAgbGV0IG0gPSBjYWNoZWRNZXRob2RzLmdldChrZXkpOwogICAgaWYgKG0gPT09IHZvaWQgMCkgewogICAgICBtID0gY29uc3RydWN0KGVudiwgb2Zmc2V0LCByZXRUeXBlLCBhcmdUeXBlcywgbmF0aXZlRnVuY3Rpb25PcHRpb25zMik7CiAgICAgIGNhY2hlZE1ldGhvZHMuc2V0KGtleSwgbSk7CiAgICB9CiAgICByZXR1cm4gbTsKICB9CiAgZnVuY3Rpb24gbWFrZVBsYWluTWV0aG9kKGVudiwgb2Zmc2V0LCByZXRUeXBlLCBhcmdUeXBlcywgb3B0aW9ucykgewogICAgcmV0dXJuIG5ldyBOYXRpdmVGdW5jdGlvbigKICAgICAgdnRhYmxlKGVudikuYWRkKG9mZnNldCAqIHBvaW50ZXJTaXplMykucmVhZFBvaW50ZXIoKSwKICAgICAgcmV0VHlwZSwKICAgICAgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciJdLmNvbmNhdChhcmdUeXBlcyksCiAgICAgIG9wdGlvbnMKICAgICk7CiAgfQogIGZ1bmN0aW9uIG1ha2VWYU1ldGhvZChlbnYsIG9mZnNldCwgcmV0VHlwZSwgYXJnVHlwZXMsIG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgTmF0aXZlRnVuY3Rpb24oCiAgICAgIHZ0YWJsZShlbnYpLmFkZChvZmZzZXQgKiBwb2ludGVyU2l6ZTMpLnJlYWRQb2ludGVyKCksCiAgICAgIHJldFR5cGUsCiAgICAgIFsicG9pbnRlciIsICJwb2ludGVyIiwgInBvaW50ZXIiLCAiLi4uIl0uY29uY2F0KGFyZ1R5cGVzKSwKICAgICAgb3B0aW9ucwogICAgKTsKICB9CiAgZnVuY3Rpb24gbWFrZU5vbnZpcnR1YWxWYU1ldGhvZChlbnYsIG9mZnNldCwgcmV0VHlwZSwgYXJnVHlwZXMsIG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgTmF0aXZlRnVuY3Rpb24oCiAgICAgIHZ0YWJsZShlbnYpLmFkZChvZmZzZXQgKiBwb2ludGVyU2l6ZTMpLnJlYWRQb2ludGVyKCksCiAgICAgIHJldFR5cGUsCiAgICAgIFsicG9pbnRlciIsICJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciIsICIuLi4iXS5jb25jYXQoYXJnVHlwZXMpLAogICAgICBvcHRpb25zCiAgICApOwogIH0KICBFbnYucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gZnVuY3Rpb24oYXJnVHlwZXMsIG9wdGlvbnMpIHsKICAgIHJldHVybiB2YU1ldGhvZC5jYWxsKHRoaXMsIENBTExfQ09OU1RSVUNUT1JfTUVUSE9EX09GRlNFVCwgInBvaW50ZXIiLCBhcmdUeXBlcywgb3B0aW9ucyk7CiAgfTsKICBFbnYucHJvdG90eXBlLnZhTWV0aG9kID0gZnVuY3Rpb24ocmV0VHlwZSwgYXJnVHlwZXMsIG9wdGlvbnMpIHsKICAgIGNvbnN0IG9mZnNldCA9IGNhbGxNZXRob2RPZmZzZXRbcmV0VHlwZV07CiAgICBpZiAob2Zmc2V0ID09PSB2b2lkIDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbnN1cHBvcnRlZCB0eXBlOiAiICsgcmV0VHlwZSk7CiAgICB9CiAgICByZXR1cm4gdmFNZXRob2QuY2FsbCh0aGlzLCBvZmZzZXQsIHJldFR5cGUsIGFyZ1R5cGVzLCBvcHRpb25zKTsKICB9OwogIEVudi5wcm90b3R5cGUubm9udmlydHVhbFZhTWV0aG9kID0gZnVuY3Rpb24ocmV0VHlwZSwgYXJnVHlwZXMsIG9wdGlvbnMpIHsKICAgIGNvbnN0IG9mZnNldCA9IGNhbGxOb252aXJ0dWFsTWV0aG9kT2Zmc2V0W3JldFR5cGVdOwogICAgaWYgKG9mZnNldCA9PT0gdm9pZCAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5zdXBwb3J0ZWQgdHlwZTogIiArIHJldFR5cGUpOwogICAgfQogICAgcmV0dXJuIG5vbnZpcnR1YWxWYU1ldGhvZC5jYWxsKHRoaXMsIG9mZnNldCwgcmV0VHlwZSwgYXJnVHlwZXMsIG9wdGlvbnMpOwogIH07CiAgRW52LnByb3RvdHlwZS5zdGF0aWNWYU1ldGhvZCA9IGZ1bmN0aW9uKHJldFR5cGUsIGFyZ1R5cGVzLCBvcHRpb25zKSB7CiAgICBjb25zdCBvZmZzZXQgPSBjYWxsU3RhdGljTWV0aG9kT2Zmc2V0W3JldFR5cGVdOwogICAgaWYgKG9mZnNldCA9PT0gdm9pZCAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5zdXBwb3J0ZWQgdHlwZTogIiArIHJldFR5cGUpOwogICAgfQogICAgcmV0dXJuIHZhTWV0aG9kLmNhbGwodGhpcywgb2Zmc2V0LCByZXRUeXBlLCBhcmdUeXBlcywgb3B0aW9ucyk7CiAgfTsKICBFbnYucHJvdG90eXBlLmdldEZpZWxkID0gZnVuY3Rpb24oZmllbGRUeXBlKSB7CiAgICBjb25zdCBvZmZzZXQgPSBnZXRGaWVsZE9mZnNldFtmaWVsZFR5cGVdOwogICAgaWYgKG9mZnNldCA9PT0gdm9pZCAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5zdXBwb3J0ZWQgdHlwZTogIiArIGZpZWxkVHlwZSk7CiAgICB9CiAgICByZXR1cm4gcGxhaW5NZXRob2QuY2FsbCh0aGlzLCBvZmZzZXQsIGZpZWxkVHlwZSwgW10pOwogIH07CiAgRW52LnByb3RvdHlwZS5nZXRTdGF0aWNGaWVsZCA9IGZ1bmN0aW9uKGZpZWxkVHlwZSkgewogICAgY29uc3Qgb2Zmc2V0ID0gZ2V0U3RhdGljRmllbGRPZmZzZXRbZmllbGRUeXBlXTsKICAgIGlmIChvZmZzZXQgPT09IHZvaWQgMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuc3VwcG9ydGVkIHR5cGU6ICIgKyBmaWVsZFR5cGUpOwogICAgfQogICAgcmV0dXJuIHBsYWluTWV0aG9kLmNhbGwodGhpcywgb2Zmc2V0LCBmaWVsZFR5cGUsIFtdKTsKICB9OwogIEVudi5wcm90b3R5cGUuc2V0RmllbGQgPSBmdW5jdGlvbihmaWVsZFR5cGUpIHsKICAgIGNvbnN0IG9mZnNldCA9IHNldEZpZWxkT2Zmc2V0W2ZpZWxkVHlwZV07CiAgICBpZiAob2Zmc2V0ID09PSB2b2lkIDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbnN1cHBvcnRlZCB0eXBlOiAiICsgZmllbGRUeXBlKTsKICAgIH0KICAgIHJldHVybiBwbGFpbk1ldGhvZC5jYWxsKHRoaXMsIG9mZnNldCwgInZvaWQiLCBbZmllbGRUeXBlXSk7CiAgfTsKICBFbnYucHJvdG90eXBlLnNldFN0YXRpY0ZpZWxkID0gZnVuY3Rpb24oZmllbGRUeXBlKSB7CiAgICBjb25zdCBvZmZzZXQgPSBzZXRTdGF0aWNGaWVsZE9mZnNldFtmaWVsZFR5cGVdOwogICAgaWYgKG9mZnNldCA9PT0gdm9pZCAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5zdXBwb3J0ZWQgdHlwZTogIiArIGZpZWxkVHlwZSk7CiAgICB9CiAgICByZXR1cm4gcGxhaW5NZXRob2QuY2FsbCh0aGlzLCBvZmZzZXQsICJ2b2lkIiwgW2ZpZWxkVHlwZV0pOwogIH07CiAgdmFyIGphdmFMYW5nQ2xhc3MgPSBudWxsOwogIEVudi5wcm90b3R5cGUuamF2YUxhbmdDbGFzcyA9IGZ1bmN0aW9uKCkgewogICAgaWYgKGphdmFMYW5nQ2xhc3MgPT09IG51bGwpIHsKICAgICAgY29uc3QgaGFuZGxlID0gdGhpcy5maW5kQ2xhc3MoImphdmEvbGFuZy9DbGFzcyIpOwogICAgICB0cnkgewogICAgICAgIGNvbnN0IGdldCA9IHRoaXMuZ2V0TWV0aG9kSWQuYmluZCh0aGlzLCBoYW5kbGUpOwogICAgICAgIGphdmFMYW5nQ2xhc3MgPSB7CiAgICAgICAgICBoYW5kbGU6IHJlZ2lzdGVyKHRoaXMubmV3R2xvYmFsUmVmKGhhbmRsZSkpLAogICAgICAgICAgZ2V0TmFtZTogZ2V0KCJnZXROYW1lIiwgIigpTGphdmEvbGFuZy9TdHJpbmc7IiksCiAgICAgICAgICBnZXRTaW1wbGVOYW1lOiBnZXQoImdldFNpbXBsZU5hbWUiLCAiKClMamF2YS9sYW5nL1N0cmluZzsiKSwKICAgICAgICAgIGdldEdlbmVyaWNTdXBlcmNsYXNzOiBnZXQoImdldEdlbmVyaWNTdXBlcmNsYXNzIiwgIigpTGphdmEvbGFuZy9yZWZsZWN0L1R5cGU7IiksCiAgICAgICAgICBnZXREZWNsYXJlZENvbnN0cnVjdG9yczogZ2V0KCJnZXREZWNsYXJlZENvbnN0cnVjdG9ycyIsICIoKVtMamF2YS9sYW5nL3JlZmxlY3QvQ29uc3RydWN0b3I7IiksCiAgICAgICAgICBnZXREZWNsYXJlZE1ldGhvZHM6IGdldCgiZ2V0RGVjbGFyZWRNZXRob2RzIiwgIigpW0xqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7IiksCiAgICAgICAgICBnZXREZWNsYXJlZEZpZWxkczogZ2V0KCJnZXREZWNsYXJlZEZpZWxkcyIsICIoKVtMamF2YS9sYW5nL3JlZmxlY3QvRmllbGQ7IiksCiAgICAgICAgICBpc0FycmF5OiBnZXQoImlzQXJyYXkiLCAiKClaIiksCiAgICAgICAgICBpc1ByaW1pdGl2ZTogZ2V0KCJpc1ByaW1pdGl2ZSIsICIoKVoiKSwKICAgICAgICAgIGlzSW50ZXJmYWNlOiBnZXQoImlzSW50ZXJmYWNlIiwgIigpWiIpLAogICAgICAgICAgZ2V0Q29tcG9uZW50VHlwZTogZ2V0KCJnZXRDb21wb25lbnRUeXBlIiwgIigpTGphdmEvbGFuZy9DbGFzczsiKQogICAgICAgIH07CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgdGhpcy5kZWxldGVMb2NhbFJlZihoYW5kbGUpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gamF2YUxhbmdDbGFzczsKICB9OwogIHZhciBqYXZhTGFuZ09iamVjdCA9IG51bGw7CiAgRW52LnByb3RvdHlwZS5qYXZhTGFuZ09iamVjdCA9IGZ1bmN0aW9uKCkgewogICAgaWYgKGphdmFMYW5nT2JqZWN0ID09PSBudWxsKSB7CiAgICAgIGNvbnN0IGhhbmRsZSA9IHRoaXMuZmluZENsYXNzKCJqYXZhL2xhbmcvT2JqZWN0Iik7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgZ2V0ID0gdGhpcy5nZXRNZXRob2RJZC5iaW5kKHRoaXMsIGhhbmRsZSk7CiAgICAgICAgamF2YUxhbmdPYmplY3QgPSB7CiAgICAgICAgICBoYW5kbGU6IHJlZ2lzdGVyKHRoaXMubmV3R2xvYmFsUmVmKGhhbmRsZSkpLAogICAgICAgICAgdG9TdHJpbmc6IGdldCgidG9TdHJpbmciLCAiKClMamF2YS9sYW5nL1N0cmluZzsiKSwKICAgICAgICAgIGdldENsYXNzOiBnZXQoImdldENsYXNzIiwgIigpTGphdmEvbGFuZy9DbGFzczsiKQogICAgICAgIH07CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgdGhpcy5kZWxldGVMb2NhbFJlZihoYW5kbGUpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gamF2YUxhbmdPYmplY3Q7CiAgfTsKICB2YXIgamF2YUxhbmdSZWZsZWN0Q29uc3RydWN0b3IgPSBudWxsOwogIEVudi5wcm90b3R5cGUuamF2YUxhbmdSZWZsZWN0Q29uc3RydWN0b3IgPSBmdW5jdGlvbigpIHsKICAgIGlmIChqYXZhTGFuZ1JlZmxlY3RDb25zdHJ1Y3RvciA9PT0gbnVsbCkgewogICAgICBjb25zdCBoYW5kbGUgPSB0aGlzLmZpbmRDbGFzcygiamF2YS9sYW5nL3JlZmxlY3QvQ29uc3RydWN0b3IiKTsKICAgICAgdHJ5IHsKICAgICAgICBqYXZhTGFuZ1JlZmxlY3RDb25zdHJ1Y3RvciA9IHsKICAgICAgICAgIGdldEdlbmVyaWNQYXJhbWV0ZXJUeXBlczogdGhpcy5nZXRNZXRob2RJZChoYW5kbGUsICJnZXRHZW5lcmljUGFyYW1ldGVyVHlwZXMiLCAiKClbTGphdmEvbGFuZy9yZWZsZWN0L1R5cGU7IikKICAgICAgICB9OwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHRoaXMuZGVsZXRlTG9jYWxSZWYoaGFuZGxlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGphdmFMYW5nUmVmbGVjdENvbnN0cnVjdG9yOwogIH07CiAgdmFyIGphdmFMYW5nUmVmbGVjdE1ldGhvZCA9IG51bGw7CiAgRW52LnByb3RvdHlwZS5qYXZhTGFuZ1JlZmxlY3RNZXRob2QgPSBmdW5jdGlvbigpIHsKICAgIGlmIChqYXZhTGFuZ1JlZmxlY3RNZXRob2QgPT09IG51bGwpIHsKICAgICAgY29uc3QgaGFuZGxlID0gdGhpcy5maW5kQ2xhc3MoImphdmEvbGFuZy9yZWZsZWN0L01ldGhvZCIpOwogICAgICB0cnkgewogICAgICAgIGNvbnN0IGdldCA9IHRoaXMuZ2V0TWV0aG9kSWQuYmluZCh0aGlzLCBoYW5kbGUpOwogICAgICAgIGphdmFMYW5nUmVmbGVjdE1ldGhvZCA9IHsKICAgICAgICAgIGdldE5hbWU6IGdldCgiZ2V0TmFtZSIsICIoKUxqYXZhL2xhbmcvU3RyaW5nOyIpLAogICAgICAgICAgZ2V0R2VuZXJpY1BhcmFtZXRlclR5cGVzOiBnZXQoImdldEdlbmVyaWNQYXJhbWV0ZXJUeXBlcyIsICIoKVtMamF2YS9sYW5nL3JlZmxlY3QvVHlwZTsiKSwKICAgICAgICAgIGdldFBhcmFtZXRlclR5cGVzOiBnZXQoImdldFBhcmFtZXRlclR5cGVzIiwgIigpW0xqYXZhL2xhbmcvQ2xhc3M7IiksCiAgICAgICAgICBnZXRHZW5lcmljUmV0dXJuVHlwZTogZ2V0KCJnZXRHZW5lcmljUmV0dXJuVHlwZSIsICIoKUxqYXZhL2xhbmcvcmVmbGVjdC9UeXBlOyIpLAogICAgICAgICAgZ2V0R2VuZXJpY0V4Y2VwdGlvblR5cGVzOiBnZXQoImdldEdlbmVyaWNFeGNlcHRpb25UeXBlcyIsICIoKVtMamF2YS9sYW5nL3JlZmxlY3QvVHlwZTsiKSwKICAgICAgICAgIGdldE1vZGlmaWVyczogZ2V0KCJnZXRNb2RpZmllcnMiLCAiKClJIiksCiAgICAgICAgICBpc1ZhckFyZ3M6IGdldCgiaXNWYXJBcmdzIiwgIigpWiIpCiAgICAgICAgfTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICB0aGlzLmRlbGV0ZUxvY2FsUmVmKGhhbmRsZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBqYXZhTGFuZ1JlZmxlY3RNZXRob2Q7CiAgfTsKICB2YXIgamF2YUxhbmdSZWZsZWN0RmllbGQgPSBudWxsOwogIEVudi5wcm90b3R5cGUuamF2YUxhbmdSZWZsZWN0RmllbGQgPSBmdW5jdGlvbigpIHsKICAgIGlmIChqYXZhTGFuZ1JlZmxlY3RGaWVsZCA9PT0gbnVsbCkgewogICAgICBjb25zdCBoYW5kbGUgPSB0aGlzLmZpbmRDbGFzcygiamF2YS9sYW5nL3JlZmxlY3QvRmllbGQiKTsKICAgICAgdHJ5IHsKICAgICAgICBjb25zdCBnZXQgPSB0aGlzLmdldE1ldGhvZElkLmJpbmQodGhpcywgaGFuZGxlKTsKICAgICAgICBqYXZhTGFuZ1JlZmxlY3RGaWVsZCA9IHsKICAgICAgICAgIGdldE5hbWU6IGdldCgiZ2V0TmFtZSIsICIoKUxqYXZhL2xhbmcvU3RyaW5nOyIpLAogICAgICAgICAgZ2V0VHlwZTogZ2V0KCJnZXRUeXBlIiwgIigpTGphdmEvbGFuZy9DbGFzczsiKSwKICAgICAgICAgIGdldEdlbmVyaWNUeXBlOiBnZXQoImdldEdlbmVyaWNUeXBlIiwgIigpTGphdmEvbGFuZy9yZWZsZWN0L1R5cGU7IiksCiAgICAgICAgICBnZXRNb2RpZmllcnM6IGdldCgiZ2V0TW9kaWZpZXJzIiwgIigpSSIpLAogICAgICAgICAgdG9TdHJpbmc6IGdldCgidG9TdHJpbmciLCAiKClMamF2YS9sYW5nL1N0cmluZzsiKQogICAgICAgIH07CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgdGhpcy5kZWxldGVMb2NhbFJlZihoYW5kbGUpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gamF2YUxhbmdSZWZsZWN0RmllbGQ7CiAgfTsKICB2YXIgamF2YUxhbmdSZWZsZWN0VHlwZVZhcmlhYmxlID0gbnVsbDsKICBFbnYucHJvdG90eXBlLmphdmFMYW5nUmVmbGVjdFR5cGVWYXJpYWJsZSA9IGZ1bmN0aW9uKCkgewogICAgaWYgKGphdmFMYW5nUmVmbGVjdFR5cGVWYXJpYWJsZSA9PT0gbnVsbCkgewogICAgICBjb25zdCBoYW5kbGUgPSB0aGlzLmZpbmRDbGFzcygiamF2YS9sYW5nL3JlZmxlY3QvVHlwZVZhcmlhYmxlIik7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgZ2V0ID0gdGhpcy5nZXRNZXRob2RJZC5iaW5kKHRoaXMsIGhhbmRsZSk7CiAgICAgICAgamF2YUxhbmdSZWZsZWN0VHlwZVZhcmlhYmxlID0gewogICAgICAgICAgaGFuZGxlOiByZWdpc3Rlcih0aGlzLm5ld0dsb2JhbFJlZihoYW5kbGUpKSwKICAgICAgICAgIGdldE5hbWU6IGdldCgiZ2V0TmFtZSIsICIoKUxqYXZhL2xhbmcvU3RyaW5nOyIpLAogICAgICAgICAgZ2V0Qm91bmRzOiBnZXQoImdldEJvdW5kcyIsICIoKVtMamF2YS9sYW5nL3JlZmxlY3QvVHlwZTsiKSwKICAgICAgICAgIGdldEdlbmVyaWNEZWNsYXJhdGlvbjogZ2V0KCJnZXRHZW5lcmljRGVjbGFyYXRpb24iLCAiKClMamF2YS9sYW5nL3JlZmxlY3QvR2VuZXJpY0RlY2xhcmF0aW9uOyIpCiAgICAgICAgfTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICB0aGlzLmRlbGV0ZUxvY2FsUmVmKGhhbmRsZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBqYXZhTGFuZ1JlZmxlY3RUeXBlVmFyaWFibGU7CiAgfTsKICB2YXIgamF2YUxhbmdSZWZsZWN0V2lsZGNhcmRUeXBlID0gbnVsbDsKICBFbnYucHJvdG90eXBlLmphdmFMYW5nUmVmbGVjdFdpbGRjYXJkVHlwZSA9IGZ1bmN0aW9uKCkgewogICAgaWYgKGphdmFMYW5nUmVmbGVjdFdpbGRjYXJkVHlwZSA9PT0gbnVsbCkgewogICAgICBjb25zdCBoYW5kbGUgPSB0aGlzLmZpbmRDbGFzcygiamF2YS9sYW5nL3JlZmxlY3QvV2lsZGNhcmRUeXBlIik7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgZ2V0ID0gdGhpcy5nZXRNZXRob2RJZC5iaW5kKHRoaXMsIGhhbmRsZSk7CiAgICAgICAgamF2YUxhbmdSZWZsZWN0V2lsZGNhcmRUeXBlID0gewogICAgICAgICAgaGFuZGxlOiByZWdpc3Rlcih0aGlzLm5ld0dsb2JhbFJlZihoYW5kbGUpKSwKICAgICAgICAgIGdldExvd2VyQm91bmRzOiBnZXQoImdldExvd2VyQm91bmRzIiwgIigpW0xqYXZhL2xhbmcvcmVmbGVjdC9UeXBlOyIpLAogICAgICAgICAgZ2V0VXBwZXJCb3VuZHM6IGdldCgiZ2V0VXBwZXJCb3VuZHMiLCAiKClbTGphdmEvbGFuZy9yZWZsZWN0L1R5cGU7IikKICAgICAgICB9OwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHRoaXMuZGVsZXRlTG9jYWxSZWYoaGFuZGxlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGphdmFMYW5nUmVmbGVjdFdpbGRjYXJkVHlwZTsKICB9OwogIHZhciBqYXZhTGFuZ1JlZmxlY3RHZW5lcmljQXJyYXlUeXBlID0gbnVsbDsKICBFbnYucHJvdG90eXBlLmphdmFMYW5nUmVmbGVjdEdlbmVyaWNBcnJheVR5cGUgPSBmdW5jdGlvbigpIHsKICAgIGlmIChqYXZhTGFuZ1JlZmxlY3RHZW5lcmljQXJyYXlUeXBlID09PSBudWxsKSB7CiAgICAgIGNvbnN0IGhhbmRsZSA9IHRoaXMuZmluZENsYXNzKCJqYXZhL2xhbmcvcmVmbGVjdC9HZW5lcmljQXJyYXlUeXBlIik7CiAgICAgIHRyeSB7CiAgICAgICAgamF2YUxhbmdSZWZsZWN0R2VuZXJpY0FycmF5VHlwZSA9IHsKICAgICAgICAgIGhhbmRsZTogcmVnaXN0ZXIodGhpcy5uZXdHbG9iYWxSZWYoaGFuZGxlKSksCiAgICAgICAgICBnZXRHZW5lcmljQ29tcG9uZW50VHlwZTogdGhpcy5nZXRNZXRob2RJZChoYW5kbGUsICJnZXRHZW5lcmljQ29tcG9uZW50VHlwZSIsICIoKUxqYXZhL2xhbmcvcmVmbGVjdC9UeXBlOyIpCiAgICAgICAgfTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICB0aGlzLmRlbGV0ZUxvY2FsUmVmKGhhbmRsZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBqYXZhTGFuZ1JlZmxlY3RHZW5lcmljQXJyYXlUeXBlOwogIH07CiAgdmFyIGphdmFMYW5nUmVmbGVjdFBhcmFtZXRlcml6ZWRUeXBlID0gbnVsbDsKICBFbnYucHJvdG90eXBlLmphdmFMYW5nUmVmbGVjdFBhcmFtZXRlcml6ZWRUeXBlID0gZnVuY3Rpb24oKSB7CiAgICBpZiAoamF2YUxhbmdSZWZsZWN0UGFyYW1ldGVyaXplZFR5cGUgPT09IG51bGwpIHsKICAgICAgY29uc3QgaGFuZGxlID0gdGhpcy5maW5kQ2xhc3MoImphdmEvbGFuZy9yZWZsZWN0L1BhcmFtZXRlcml6ZWRUeXBlIik7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgZ2V0ID0gdGhpcy5nZXRNZXRob2RJZC5iaW5kKHRoaXMsIGhhbmRsZSk7CiAgICAgICAgamF2YUxhbmdSZWZsZWN0UGFyYW1ldGVyaXplZFR5cGUgPSB7CiAgICAgICAgICBoYW5kbGU6IHJlZ2lzdGVyKHRoaXMubmV3R2xvYmFsUmVmKGhhbmRsZSkpLAogICAgICAgICAgZ2V0QWN0dWFsVHlwZUFyZ3VtZW50czogZ2V0KCJnZXRBY3R1YWxUeXBlQXJndW1lbnRzIiwgIigpW0xqYXZhL2xhbmcvcmVmbGVjdC9UeXBlOyIpLAogICAgICAgICAgZ2V0UmF3VHlwZTogZ2V0KCJnZXRSYXdUeXBlIiwgIigpTGphdmEvbGFuZy9yZWZsZWN0L1R5cGU7IiksCiAgICAgICAgICBnZXRPd25lclR5cGU6IGdldCgiZ2V0T3duZXJUeXBlIiwgIigpTGphdmEvbGFuZy9yZWZsZWN0L1R5cGU7IikKICAgICAgICB9OwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHRoaXMuZGVsZXRlTG9jYWxSZWYoaGFuZGxlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGphdmFMYW5nUmVmbGVjdFBhcmFtZXRlcml6ZWRUeXBlOwogIH07CiAgdmFyIGphdmFMYW5nU3RyaW5nID0gbnVsbDsKICBFbnYucHJvdG90eXBlLmphdmFMYW5nU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICBpZiAoamF2YUxhbmdTdHJpbmcgPT09IG51bGwpIHsKICAgICAgY29uc3QgaGFuZGxlID0gdGhpcy5maW5kQ2xhc3MoImphdmEvbGFuZy9TdHJpbmciKTsKICAgICAgdHJ5IHsKICAgICAgICBqYXZhTGFuZ1N0cmluZyA9IHsKICAgICAgICAgIGhhbmRsZTogcmVnaXN0ZXIodGhpcy5uZXdHbG9iYWxSZWYoaGFuZGxlKSkKICAgICAgICB9OwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHRoaXMuZGVsZXRlTG9jYWxSZWYoaGFuZGxlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGphdmFMYW5nU3RyaW5nOwogIH07CiAgRW52LnByb3RvdHlwZS5nZXRDbGFzc05hbWUgPSBmdW5jdGlvbihjbGFzc0hhbmRsZSkgewogICAgY29uc3QgbmFtZSA9IHRoaXMudmFNZXRob2QoInBvaW50ZXIiLCBbXSkodGhpcy5oYW5kbGUsIGNsYXNzSGFuZGxlLCB0aGlzLmphdmFMYW5nQ2xhc3MoKS5nZXROYW1lKTsKICAgIHRyeSB7CiAgICAgIHJldHVybiB0aGlzLnN0cmluZ0Zyb21KbmkobmFtZSk7CiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLmRlbGV0ZUxvY2FsUmVmKG5hbWUpOwogICAgfQogIH07CiAgRW52LnByb3RvdHlwZS5nZXRPYmplY3RDbGFzc05hbWUgPSBmdW5jdGlvbihvYmpIYW5kbGUpIHsKICAgIGNvbnN0IGprbGFzcyA9IHRoaXMuZ2V0T2JqZWN0Q2xhc3Mob2JqSGFuZGxlKTsKICAgIHRyeSB7CiAgICAgIHJldHVybiB0aGlzLmdldENsYXNzTmFtZShqa2xhc3MpOwogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5kZWxldGVMb2NhbFJlZihqa2xhc3MpOwogICAgfQogIH07CiAgRW52LnByb3RvdHlwZS5nZXRBY3R1YWxUeXBlQXJndW1lbnQgPSBmdW5jdGlvbih0eXBlKSB7CiAgICBjb25zdCBhY3R1YWxUeXBlQXJndW1lbnRzID0gdGhpcy52YU1ldGhvZCgicG9pbnRlciIsIFtdKSh0aGlzLmhhbmRsZSwgdHlwZSwgdGhpcy5qYXZhTGFuZ1JlZmxlY3RQYXJhbWV0ZXJpemVkVHlwZSgpLmdldEFjdHVhbFR5cGVBcmd1bWVudHMpOwogICAgdGhpcy50aHJvd0lmRXhjZXB0aW9uUGVuZGluZygpOwogICAgaWYgKCFhY3R1YWxUeXBlQXJndW1lbnRzLmlzTnVsbCgpKSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VHlwZU5hbWVGcm9tRmlyc3RUeXBlRWxlbWVudChhY3R1YWxUeXBlQXJndW1lbnRzKTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICB0aGlzLmRlbGV0ZUxvY2FsUmVmKGFjdHVhbFR5cGVBcmd1bWVudHMpOwogICAgICB9CiAgICB9CiAgfTsKICBFbnYucHJvdG90eXBlLmdldFR5cGVOYW1lRnJvbUZpcnN0VHlwZUVsZW1lbnQgPSBmdW5jdGlvbih0eXBlQXJyYXkpIHsKICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMuZ2V0QXJyYXlMZW5ndGgodHlwZUFycmF5KTsKICAgIGlmIChsZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IHR5cGVBcmd1bWVudDAgPSB0aGlzLmdldE9iamVjdEFycmF5RWxlbWVudCh0eXBlQXJyYXksIDApOwogICAgICB0cnkgewogICAgICAgIHJldHVybiB0aGlzLmdldFR5cGVOYW1lKHR5cGVBcmd1bWVudDApOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHRoaXMuZGVsZXRlTG9jYWxSZWYodHlwZUFyZ3VtZW50MCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAiamF2YS5sYW5nLk9iamVjdCI7CiAgICB9CiAgfTsKICBFbnYucHJvdG90eXBlLmdldFR5cGVOYW1lID0gZnVuY3Rpb24odHlwZSwgZ2V0R2VuZXJpY3NJbmZvcm1hdGlvbikgewogICAgY29uc3QgaW52b2tlT2JqZWN0TWV0aG9kTm9BcmdzID0gdGhpcy52YU1ldGhvZCgicG9pbnRlciIsIFtdKTsKICAgIGlmICh0aGlzLmlzSW5zdGFuY2VPZih0eXBlLCB0aGlzLmphdmFMYW5nQ2xhc3MoKS5oYW5kbGUpKSB7CiAgICAgIHJldHVybiB0aGlzLmdldENsYXNzTmFtZSh0eXBlKTsKICAgIH0gZWxzZSBpZiAodGhpcy5pc0luc3RhbmNlT2YodHlwZSwgdGhpcy5qYXZhTGFuZ1JlZmxlY3RHZW5lcmljQXJyYXlUeXBlKCkuaGFuZGxlKSkgewogICAgICByZXR1cm4gdGhpcy5nZXRBcnJheVR5cGVOYW1lKHR5cGUpOwogICAgfSBlbHNlIGlmICh0aGlzLmlzSW5zdGFuY2VPZih0eXBlLCB0aGlzLmphdmFMYW5nUmVmbGVjdFBhcmFtZXRlcml6ZWRUeXBlKCkuaGFuZGxlKSkgewogICAgICBjb25zdCByYXdUeXBlID0gaW52b2tlT2JqZWN0TWV0aG9kTm9BcmdzKHRoaXMuaGFuZGxlLCB0eXBlLCB0aGlzLmphdmFMYW5nUmVmbGVjdFBhcmFtZXRlcml6ZWRUeXBlKCkuZ2V0UmF3VHlwZSk7CiAgICAgIHRoaXMudGhyb3dJZkV4Y2VwdGlvblBlbmRpbmcoKTsKICAgICAgbGV0IHJlc3VsdDsKICAgICAgdHJ5IHsKICAgICAgICByZXN1bHQgPSB0aGlzLmdldFR5cGVOYW1lKHJhd1R5cGUpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHRoaXMuZGVsZXRlTG9jYWxSZWYocmF3VHlwZSk7CiAgICAgIH0KICAgICAgaWYgKGdldEdlbmVyaWNzSW5mb3JtYXRpb24pIHsKICAgICAgICByZXN1bHQgKz0gIjwiICsgdGhpcy5nZXRBY3R1YWxUeXBlQXJndW1lbnQodHlwZSkgKyAiPiI7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0gZWxzZSBpZiAodGhpcy5pc0luc3RhbmNlT2YodHlwZSwgdGhpcy5qYXZhTGFuZ1JlZmxlY3RUeXBlVmFyaWFibGUoKS5oYW5kbGUpKSB7CiAgICAgIHJldHVybiAiamF2YS5sYW5nLk9iamVjdCI7CiAgICB9IGVsc2UgaWYgKHRoaXMuaXNJbnN0YW5jZU9mKHR5cGUsIHRoaXMuamF2YUxhbmdSZWZsZWN0V2lsZGNhcmRUeXBlKCkuaGFuZGxlKSkgewogICAgICByZXR1cm4gImphdmEubGFuZy5PYmplY3QiOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuICJqYXZhLmxhbmcuT2JqZWN0IjsKICAgIH0KICB9OwogIEVudi5wcm90b3R5cGUuZ2V0QXJyYXlUeXBlTmFtZSA9IGZ1bmN0aW9uKHR5cGUpIHsKICAgIGNvbnN0IGludm9rZU9iamVjdE1ldGhvZE5vQXJncyA9IHRoaXMudmFNZXRob2QoInBvaW50ZXIiLCBbXSk7CiAgICBpZiAodGhpcy5pc0luc3RhbmNlT2YodHlwZSwgdGhpcy5qYXZhTGFuZ0NsYXNzKCkuaGFuZGxlKSkgewogICAgICByZXR1cm4gdGhpcy5nZXRDbGFzc05hbWUodHlwZSk7CiAgICB9IGVsc2UgaWYgKHRoaXMuaXNJbnN0YW5jZU9mKHR5cGUsIHRoaXMuamF2YUxhbmdSZWZsZWN0R2VuZXJpY0FycmF5VHlwZSgpLmhhbmRsZSkpIHsKICAgICAgY29uc3QgY29tcG9uZW50VHlwZSA9IGludm9rZU9iamVjdE1ldGhvZE5vQXJncyh0aGlzLmhhbmRsZSwgdHlwZSwgdGhpcy5qYXZhTGFuZ1JlZmxlY3RHZW5lcmljQXJyYXlUeXBlKCkuZ2V0R2VuZXJpY0NvbXBvbmVudFR5cGUpOwogICAgICB0aGlzLnRocm93SWZFeGNlcHRpb25QZW5kaW5nKCk7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuICJbTCIgKyB0aGlzLmdldFR5cGVOYW1lKGNvbXBvbmVudFR5cGUpICsgIjsiOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHRoaXMuZGVsZXRlTG9jYWxSZWYoY29tcG9uZW50VHlwZSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAiW0xqYXZhLmxhbmcuT2JqZWN0OyI7CiAgICB9CiAgfTsKICBFbnYucHJvdG90eXBlLnN0cmluZ0Zyb21KbmkgPSBmdW5jdGlvbihzdHIpIHsKICAgIGNvbnN0IHV0ZiA9IHRoaXMuZ2V0U3RyaW5nQ2hhcnMoc3RyKTsKICAgIGlmICh1dGYuaXNOdWxsKCkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gYWNjZXNzIHN0cmluZyIpOwogICAgfQogICAgdHJ5IHsKICAgICAgY29uc3QgbGVuZ3RoID0gdGhpcy5nZXRTdHJpbmdMZW5ndGgoc3RyKTsKICAgICAgcmV0dXJuIHV0Zi5yZWFkVXRmMTZTdHJpbmcobGVuZ3RoKTsKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMucmVsZWFzZVN0cmluZ0NoYXJzKHN0ciwgdXRmKTsKICAgIH0KICB9OwoKICAvLyBub2RlX21vZHVsZXMvZnJpZGEtamF2YS1icmlkZ2UvbGliL3ZtLmpzCiAgdmFyIEpOSV9WRVJTSU9OXzFfNiA9IDY1NTQyOwogIHZhciBwb2ludGVyU2l6ZTQgPSBQcm9jZXNzLnBvaW50ZXJTaXplOwogIHZhciBqc1RocmVhZElEID0gUHJvY2Vzcy5nZXRDdXJyZW50VGhyZWFkSWQoKTsKICB2YXIgYXR0YWNoZWRUaHJlYWRzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICB2YXIgYWN0aXZlRW52cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgZnVuY3Rpb24gVk0oYXBpMikgewogICAgY29uc3QgaGFuZGxlID0gYXBpMi52bTsKICAgIGxldCBhdHRhY2hDdXJyZW50VGhyZWFkID0gbnVsbDsKICAgIGxldCBkZXRhY2hDdXJyZW50VGhyZWFkID0gbnVsbDsKICAgIGxldCBnZXRFbnYgPSBudWxsOwogICAgZnVuY3Rpb24gaW5pdGlhbGl6ZTIoKSB7CiAgICAgIGNvbnN0IHZ0YWJsZTIgPSBoYW5kbGUucmVhZFBvaW50ZXIoKTsKICAgICAgY29uc3Qgb3B0aW9ucyA9IHsKICAgICAgICBleGNlcHRpb25zOiAicHJvcGFnYXRlIgogICAgICB9OwogICAgICBhdHRhY2hDdXJyZW50VGhyZWFkID0gbmV3IE5hdGl2ZUZ1bmN0aW9uKHZ0YWJsZTIuYWRkKDQgKiBwb2ludGVyU2l6ZTQpLnJlYWRQb2ludGVyKCksICJpbnQzMiIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgInBvaW50ZXIiXSwgb3B0aW9ucyk7CiAgICAgIGRldGFjaEN1cnJlbnRUaHJlYWQgPSBuZXcgTmF0aXZlRnVuY3Rpb24odnRhYmxlMi5hZGQoNSAqIHBvaW50ZXJTaXplNCkucmVhZFBvaW50ZXIoKSwgImludDMyIiwgWyJwb2ludGVyIl0sIG9wdGlvbnMpOwogICAgICBnZXRFbnYgPSBuZXcgTmF0aXZlRnVuY3Rpb24odnRhYmxlMi5hZGQoNiAqIHBvaW50ZXJTaXplNCkucmVhZFBvaW50ZXIoKSwgImludDMyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAiaW50MzIiXSwgb3B0aW9ucyk7CiAgICB9CiAgICB0aGlzLmhhbmRsZSA9IGhhbmRsZTsKICAgIHRoaXMucGVyZm9ybSA9IGZ1bmN0aW9uKGZuKSB7CiAgICAgIGNvbnN0IHRocmVhZElkID0gUHJvY2Vzcy5nZXRDdXJyZW50VGhyZWFkSWQoKTsKICAgICAgY29uc3QgY2FjaGVkRW52ID0gdHJ5R2V0Q2FjaGVkRW52KHRocmVhZElkKTsKICAgICAgaWYgKGNhY2hlZEVudiAhPT0gbnVsbCkgewogICAgICAgIHJldHVybiBmbihjYWNoZWRFbnYpOwogICAgICB9CiAgICAgIGxldCBlbnYgPSB0aGlzLl90cnlHZXRFbnYoKTsKICAgICAgY29uc3QgYWxyZWFkeUF0dGFjaGVkID0gZW52ICE9PSBudWxsOwogICAgICBpZiAoIWFscmVhZHlBdHRhY2hlZCkgewogICAgICAgIGVudiA9IHRoaXMuYXR0YWNoQ3VycmVudFRocmVhZCgpOwogICAgICAgIGF0dGFjaGVkVGhyZWFkcy5zZXQodGhyZWFkSWQsIHRydWUpOwogICAgICB9CiAgICAgIHRoaXMubGluayh0aHJlYWRJZCwgZW52KTsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gZm4oZW52KTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBjb25zdCBpc0pzVGhyZWFkID0gdGhyZWFkSWQgPT09IGpzVGhyZWFkSUQ7CiAgICAgICAgaWYgKCFpc0pzVGhyZWFkKSB7CiAgICAgICAgICB0aGlzLnVubGluayh0aHJlYWRJZCk7CiAgICAgICAgfQogICAgICAgIGlmICghYWxyZWFkeUF0dGFjaGVkICYmICFpc0pzVGhyZWFkKSB7CiAgICAgICAgICBjb25zdCBhbGxvd2VkVG9EZXRhY2ggPSBhdHRhY2hlZFRocmVhZHMuZ2V0KHRocmVhZElkKTsKICAgICAgICAgIGF0dGFjaGVkVGhyZWFkcy5kZWxldGUodGhyZWFkSWQpOwogICAgICAgICAgaWYgKGFsbG93ZWRUb0RldGFjaCkgewogICAgICAgICAgICB0aGlzLmRldGFjaEN1cnJlbnRUaHJlYWQoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICB0aGlzLmF0dGFjaEN1cnJlbnRUaHJlYWQgPSBmdW5jdGlvbigpIHsKICAgICAgY29uc3QgZW52QnVmID0gTWVtb3J5LmFsbG9jKHBvaW50ZXJTaXplNCk7CiAgICAgIGNoZWNrSm5pUmVzdWx0KCJWTTo6QXR0YWNoQ3VycmVudFRocmVhZCIsIGF0dGFjaEN1cnJlbnRUaHJlYWQoaGFuZGxlLCBlbnZCdWYsIE5VTEwpKTsKICAgICAgcmV0dXJuIG5ldyBFbnYoZW52QnVmLnJlYWRQb2ludGVyKCksIHRoaXMpOwogICAgfTsKICAgIHRoaXMuZGV0YWNoQ3VycmVudFRocmVhZCA9IGZ1bmN0aW9uKCkgewogICAgICBjaGVja0puaVJlc3VsdCgiVk06OkRldGFjaEN1cnJlbnRUaHJlYWQiLCBkZXRhY2hDdXJyZW50VGhyZWFkKGhhbmRsZSkpOwogICAgfTsKICAgIHRoaXMucHJldmVudERldGFjaER1ZVRvQ2xhc3NMb2FkZXIgPSBmdW5jdGlvbigpIHsKICAgICAgY29uc3QgdGhyZWFkSWQgPSBQcm9jZXNzLmdldEN1cnJlbnRUaHJlYWRJZCgpOwogICAgICBpZiAoYXR0YWNoZWRUaHJlYWRzLmhhcyh0aHJlYWRJZCkpIHsKICAgICAgICBhdHRhY2hlZFRocmVhZHMuc2V0KHRocmVhZElkLCBmYWxzZSk7CiAgICAgIH0KICAgIH07CiAgICB0aGlzLmdldEVudiA9IGZ1bmN0aW9uKCkgewogICAgICBjb25zdCBjYWNoZWRFbnYgPSB0cnlHZXRDYWNoZWRFbnYoUHJvY2Vzcy5nZXRDdXJyZW50VGhyZWFkSWQoKSk7CiAgICAgIGlmIChjYWNoZWRFbnYgIT09IG51bGwpIHsKICAgICAgICByZXR1cm4gY2FjaGVkRW52OwogICAgICB9CiAgICAgIGNvbnN0IGVudkJ1ZiA9IE1lbW9yeS5hbGxvYyhwb2ludGVyU2l6ZTQpOwogICAgICBjb25zdCByZXN1bHQgPSBnZXRFbnYoaGFuZGxlLCBlbnZCdWYsIEpOSV9WRVJTSU9OXzFfNik7CiAgICAgIGlmIChyZXN1bHQgPT09IC0yKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDdXJyZW50IHRocmVhZCBpcyBub3QgYXR0YWNoZWQgdG8gdGhlIEphdmEgVk07IHBsZWFzZSBtb3ZlIHRoaXMgY29kZSBpbnNpZGUgYSBKYXZhLnBlcmZvcm0oKSBjYWxsYmFjayIpOwogICAgICB9CiAgICAgIGNoZWNrSm5pUmVzdWx0KCJWTTo6R2V0RW52IiwgcmVzdWx0KTsKICAgICAgcmV0dXJuIG5ldyBFbnYoZW52QnVmLnJlYWRQb2ludGVyKCksIHRoaXMpOwogICAgfTsKICAgIHRoaXMudHJ5R2V0RW52ID0gZnVuY3Rpb24oKSB7CiAgICAgIGNvbnN0IGNhY2hlZEVudiA9IHRyeUdldENhY2hlZEVudihQcm9jZXNzLmdldEN1cnJlbnRUaHJlYWRJZCgpKTsKICAgICAgaWYgKGNhY2hlZEVudiAhPT0gbnVsbCkgewogICAgICAgIHJldHVybiBjYWNoZWRFbnY7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuX3RyeUdldEVudigpOwogICAgfTsKICAgIHRoaXMuX3RyeUdldEVudiA9IGZ1bmN0aW9uKCkgewogICAgICBjb25zdCBoID0gdGhpcy50cnlHZXRFbnZIYW5kbGUoSk5JX1ZFUlNJT05fMV82KTsKICAgICAgaWYgKGggPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICByZXR1cm4gbmV3IEVudihoLCB0aGlzKTsKICAgIH07CiAgICB0aGlzLnRyeUdldEVudkhhbmRsZSA9IGZ1bmN0aW9uKHZlcnNpb24pIHsKICAgICAgY29uc3QgZW52QnVmID0gTWVtb3J5LmFsbG9jKHBvaW50ZXJTaXplNCk7CiAgICAgIGNvbnN0IHJlc3VsdCA9IGdldEVudihoYW5kbGUsIGVudkJ1ZiwgdmVyc2lvbik7CiAgICAgIGlmIChyZXN1bHQgIT09IEpOSV9PSykgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIHJldHVybiBlbnZCdWYucmVhZFBvaW50ZXIoKTsKICAgIH07CiAgICB0aGlzLm1ha2VIYW5kbGVEZXN0cnVjdG9yID0gZnVuY3Rpb24oaGFuZGxlMikgewogICAgICByZXR1cm4gKCkgPT4gewogICAgICAgIHRoaXMucGVyZm9ybSgoZW52KSA9PiB7CiAgICAgICAgICBlbnYuZGVsZXRlR2xvYmFsUmVmKGhhbmRsZTIpOwogICAgICAgIH0pOwogICAgICB9OwogICAgfTsKICAgIHRoaXMubGluayA9IGZ1bmN0aW9uKHRpZCwgZW52KSB7CiAgICAgIGNvbnN0IGVudHJ5ID0gYWN0aXZlRW52cy5nZXQodGlkKTsKICAgICAgaWYgKGVudHJ5ID09PSB2b2lkIDApIHsKICAgICAgICBhY3RpdmVFbnZzLnNldCh0aWQsIFtlbnYsIDFdKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBlbnRyeVsxXSsrOwogICAgICB9CiAgICB9OwogICAgdGhpcy51bmxpbmsgPSBmdW5jdGlvbih0aWQpIHsKICAgICAgY29uc3QgZW50cnkgPSBhY3RpdmVFbnZzLmdldCh0aWQpOwogICAgICBpZiAoZW50cnlbMV0gPT09IDEpIHsKICAgICAgICBhY3RpdmVFbnZzLmRlbGV0ZSh0aWQpOwogICAgICB9IGVsc2UgewogICAgICAgIGVudHJ5WzFdLS07CiAgICAgIH0KICAgIH07CiAgICBmdW5jdGlvbiB0cnlHZXRDYWNoZWRFbnYodGhyZWFkSWQpIHsKICAgICAgY29uc3QgZW50cnkgPSBhY3RpdmVFbnZzLmdldCh0aHJlYWRJZCk7CiAgICAgIGlmIChlbnRyeSA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgcmV0dXJuIGVudHJ5WzBdOwogICAgfQogICAgaW5pdGlhbGl6ZTIuY2FsbCh0aGlzKTsKICB9CiAgVk0uZGlzcG9zZSA9IGZ1bmN0aW9uKHZtMykgewogICAgaWYgKGF0dGFjaGVkVGhyZWFkcy5nZXQoanNUaHJlYWRJRCkgPT09IHRydWUpIHsKICAgICAgYXR0YWNoZWRUaHJlYWRzLmRlbGV0ZShqc1RocmVhZElEKTsKICAgICAgdm0zLmRldGFjaEN1cnJlbnRUaHJlYWQoKTsKICAgIH0KICB9OwoKICAvLyBub2RlX21vZHVsZXMvZnJpZGEtamF2YS1icmlkZ2UvbGliL2FuZHJvaWQuanMKICB2YXIganNpemVTaXplID0gNDsKICB2YXIgcG9pbnRlclNpemU1ID0gUHJvY2Vzcy5wb2ludGVyU2l6ZTsKICB2YXIgewogICAgcmVhZFUzMiwKICAgIHJlYWRQb2ludGVyLAogICAgd3JpdGVVMzIsCiAgICB3cml0ZVBvaW50ZXIKICB9ID0gTmF0aXZlUG9pbnRlci5wcm90b3R5cGU7CiAgdmFyIGtBY2NQdWJsaWMgPSAxOwogIHZhciBrQWNjU3RhdGljID0gODsKICB2YXIga0FjY0ZpbmFsID0gMTY7CiAgdmFyIGtBY2NOYXRpdmUgPSAyNTY7CiAgdmFyIGtBY2NGYXN0TmF0aXZlID0gNTI0Mjg4OwogIHZhciBrQWNjQ3JpdGljYWxOYXRpdmUgPSAyMDk3MTUyOwogIHZhciBrQWNjRmFzdEludGVycHJldGVyVG9JbnRlcnByZXRlckludm9rZSA9IDEwNzM3NDE4MjQ7CiAgdmFyIGtBY2NTa2lwQWNjZXNzQ2hlY2tzID0gNTI0Mjg4OwogIHZhciBrQWNjU2luZ2xlSW1wbGVtZW50YXRpb24gPSAxMzQyMTc3Mjg7CiAgdmFyIGtBY2NOdGVycEVudHJ5UG9pbnRGYXN0UGF0aEZsYWcgPSAxMDQ4NTc2OwogIHZhciBrQWNjTnRlcnBJbnZva2VGYXN0UGF0aEZsYWcgPSAyMDk3MTUyOwogIHZhciBrQWNjUHVibGljQXBpID0gMjY4NDM1NDU2OwogIHZhciBrQWNjWHBvc2VkSG9va2VkTWV0aG9kID0gMjY4NDM1NDU2OwogIHZhciBrUG9pbnRlciA9IDA7CiAgdmFyIGtGdWxsRGVvcHRpbWl6YXRpb24gPSAzOwogIHZhciBrU2VsZWN0aXZlRGVvcHRpbWl6YXRpb24gPSA1OwogIHZhciBUSFVNQl9CSVRfUkVNT1ZBTF9NQVNLID0gcHRyKDEpLm5vdCgpOwogIHZhciBYODZfSk1QX01BWF9ESVNUQU5DRSA9IDIxNDc0NjcyNjM7CiAgdmFyIEFSTTY0X0FEUlBfTUFYX0RJU1RBTkNFID0gNDI5NDk2MzIwMDsKICB2YXIgRU5WX1ZUQUJMRV9PRkZTRVRfRVhDRVBUSU9OX0NMRUFSID0gMTcgKiBwb2ludGVyU2l6ZTU7CiAgdmFyIEVOVl9WVEFCTEVfT0ZGU0VUX0ZBVEFMX0VSUk9SID0gMTggKiBwb2ludGVyU2l6ZTU7CiAgdmFyIERWTV9KTklfRU5WX09GRlNFVF9TRUxGID0gMTI7CiAgdmFyIERWTV9DTEFTU19PQkpFQ1RfT0ZGU0VUX1ZUQUJMRV9DT1VOVCA9IDExMjsKICB2YXIgRFZNX0NMQVNTX09CSkVDVF9PRkZTRVRfVlRBQkxFID0gMTE2OwogIHZhciBEVk1fT0JKRUNUX09GRlNFVF9DTEFaWiA9IDA7CiAgdmFyIERWTV9NRVRIT0RfU0laRSA9IDU2OwogIHZhciBEVk1fTUVUSE9EX09GRlNFVF9BQ0NFU1NfRkxBR1MgPSA0OwogIHZhciBEVk1fTUVUSE9EX09GRlNFVF9NRVRIT0RfSU5ERVggPSA4OwogIHZhciBEVk1fTUVUSE9EX09GRlNFVF9SRUdJU1RFUlNfU0laRSA9IDEwOwogIHZhciBEVk1fTUVUSE9EX09GRlNFVF9PVVRTX1NJWkUgPSAxMjsKICB2YXIgRFZNX01FVEhPRF9PRkZTRVRfSU5TX1NJWkUgPSAxNDsKICB2YXIgRFZNX01FVEhPRF9PRkZTRVRfU0hPUlRZID0gMjg7CiAgdmFyIERWTV9NRVRIT0RfT0ZGU0VUX0pOSV9BUkdfSU5GTyA9IDM2OwogIHZhciBEQUxWSUtfSk5JX1JFVFVSTl9WT0lEID0gMDsKICB2YXIgREFMVklLX0pOSV9SRVRVUk5fRkxPQVQgPSAxOwogIHZhciBEQUxWSUtfSk5JX1JFVFVSTl9ET1VCTEUgPSAyOwogIHZhciBEQUxWSUtfSk5JX1JFVFVSTl9TOCA9IDM7CiAgdmFyIERBTFZJS19KTklfUkVUVVJOX1M0ID0gNDsKICB2YXIgREFMVklLX0pOSV9SRVRVUk5fUzIgPSA1OwogIHZhciBEQUxWSUtfSk5JX1JFVFVSTl9VMiA9IDY7CiAgdmFyIERBTFZJS19KTklfUkVUVVJOX1MxID0gNzsKICB2YXIgREFMVklLX0pOSV9OT19BUkdfSU5GTyA9IDIxNDc0ODM2NDg7CiAgdmFyIERBTFZJS19KTklfUkVUVVJOX1NISUZUID0gMjg7CiAgdmFyIFNURF9TVFJJTkdfU0laRSA9IDMgKiBwb2ludGVyU2l6ZTU7CiAgdmFyIFNURF9WRUNUT1JfU0laRSA9IDMgKiBwb2ludGVyU2l6ZTU7CiAgdmFyIEFGX1VOSVggPSAxOwogIHZhciBTT0NLX1NUUkVBTSA9IDE7CiAgdmFyIGdldEFydFJ1bnRpbWVTcGVjID0gbWVtb2l6ZShfZ2V0QXJ0UnVudGltZVNwZWMpOwogIHZhciBnZXRBcnRJbnN0cnVtZW50YXRpb25TcGVjID0gbWVtb2l6ZShfZ2V0QXJ0SW5zdHJ1bWVudGF0aW9uU3BlYyk7CiAgdmFyIGdldEFydE1ldGhvZFNwZWMgPSBtZW1vaXplKF9nZXRBcnRNZXRob2RTcGVjKTsKICB2YXIgZ2V0QXJ0VGhyZWFkU3BlYyA9IG1lbW9pemUoX2dldEFydFRocmVhZFNwZWMpOwogIHZhciBnZXRBcnRNYW5hZ2VkU3RhY2tTcGVjID0gbWVtb2l6ZShfZ2V0QXJ0TWFuYWdlZFN0YWNrU3BlYyk7CiAgdmFyIGdldEFydFRocmVhZFN0YXRlVHJhbnNpdGlvbkltcGwgPSBtZW1vaXplKF9nZXRBcnRUaHJlYWRTdGF0ZVRyYW5zaXRpb25JbXBsKTsKICB2YXIgZ2V0QW5kcm9pZFZlcnNpb24gPSBtZW1vaXplKF9nZXRBbmRyb2lkVmVyc2lvbik7CiAgdmFyIGdldEFuZHJvaWRDb2RlbmFtZSA9IG1lbW9pemUoX2dldEFuZHJvaWRDb2RlbmFtZSk7CiAgdmFyIGdldEFuZHJvaWRBcGlMZXZlbCA9IG1lbW9pemUoX2dldEFuZHJvaWRBcGlMZXZlbCk7CiAgdmFyIGdldEFydFF1aWNrRnJhbWVJbmZvR2V0dGVyVGh1bmsgPSBtZW1vaXplKF9nZXRBcnRRdWlja0ZyYW1lSW5mb0dldHRlclRodW5rKTsKICB2YXIgbWFrZUN4eE1ldGhvZFdyYXBwZXJSZXR1cm5pbmdQb2ludGVyQnlWYWx1ZSA9IFByb2Nlc3MuYXJjaCA9PT0gImlhMzIiID8gbWFrZUN4eE1ldGhvZFdyYXBwZXJSZXR1cm5pbmdQb2ludGVyQnlWYWx1ZUluRmlyc3RBcmcgOiBtYWtlQ3h4TWV0aG9kV3JhcHBlclJldHVybmluZ1BvaW50ZXJCeVZhbHVlR2VuZXJpYzsKICB2YXIgbmF0aXZlRnVuY3Rpb25PcHRpb25zMyA9IHsKICAgIGV4Y2VwdGlvbnM6ICJwcm9wYWdhdGUiCiAgfTsKICB2YXIgYXJ0VGhyZWFkU3RhdGVUcmFuc2l0aW9ucyA9IHt9OwogIHZhciBjYWNoZWRBcGkgPSBudWxsOwogIHZhciBjYWNoZWRBcnRDbGFzc0xpbmtlclNwZWMgPSBudWxsOwogIHZhciBNZXRob2RNYW5nbGVyID0gbnVsbDsKICB2YXIgYXJ0Q29udHJvbGxlciA9IG51bGw7CiAgdmFyIGlubGluZUhvb2tzID0gW107CiAgdmFyIHBhdGNoZWRDbGFzc2VzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICB2YXIgYXJ0UXVpY2tJbnRlcmNlcHRvcnMgPSBbXTsKICB2YXIgdGh1bmtQYWdlID0gbnVsbDsKICB2YXIgdGh1bmtPZmZzZXQgPSAwOwogIHZhciB0YXVnaHRBcnRBYm91dFJlcGxhY2VtZW50TWV0aG9kcyA9IGZhbHNlOwogIHZhciB0YXVnaHRBcnRBYm91dE1ldGhvZEluc3RydW1lbnRhdGlvbiA9IGZhbHNlOwogIHZhciBiYWNrdHJhY2VNb2R1bGUgPSBudWxsOwogIHZhciBqZHdwU2Vzc2lvbnMgPSBbXTsKICB2YXIgc29ja2V0cGFpciA9IG51bGw7CiAgdmFyIHRyYW1wb2xpbmVBbGxvY2F0b3IgPSBudWxsOwogIGZ1bmN0aW9uIGdldEFwaSgpIHsKICAgIGlmIChjYWNoZWRBcGkgPT09IG51bGwpIHsKICAgICAgY2FjaGVkQXBpID0gX2dldEFwaSgpOwogICAgfQogICAgcmV0dXJuIGNhY2hlZEFwaTsKICB9CiAgZnVuY3Rpb24gX2dldEFwaSgpIHsKICAgIGNvbnN0IHZtTW9kdWxlcyA9IFByb2Nlc3MuZW51bWVyYXRlTW9kdWxlcygpLmZpbHRlcigobSkgPT4gL15saWIoYXJ0fGR2bSkuc28kLy50ZXN0KG0ubmFtZSkpLmZpbHRlcigobSkgPT4gIS9cL3N5c3RlbVwvZmFrZS1saWJzLy50ZXN0KG0ucGF0aCkpOwogICAgaWYgKHZtTW9kdWxlcy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBjb25zdCB2bU1vZHVsZSA9IHZtTW9kdWxlc1swXTsKICAgIGNvbnN0IGZsYXZvciA9IHZtTW9kdWxlLm5hbWUuaW5kZXhPZigiYXJ0IikgIT09IC0xID8gImFydCIgOiAiZGFsdmlrIjsKICAgIGNvbnN0IGlzQXJ0ID0gZmxhdm9yID09PSAiYXJ0IjsKICAgIGNvbnN0IHRlbXBvcmFyeUFwaSA9IHsKICAgICAgbW9kdWxlOiB2bU1vZHVsZSwKICAgICAgZmluZChuYW1lKSB7CiAgICAgICAgY29uc3QgeyBtb2R1bGUgfSA9IHRoaXM7CiAgICAgICAgbGV0IGFkZHJlc3MgPSBtb2R1bGUuZmluZEV4cG9ydEJ5TmFtZShuYW1lKTsKICAgICAgICBpZiAoYWRkcmVzcyA9PT0gbnVsbCkgewogICAgICAgICAgYWRkcmVzcyA9IG1vZHVsZS5maW5kU3ltYm9sQnlOYW1lKG5hbWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYWRkcmVzczsKICAgICAgfSwKICAgICAgZmxhdm9yLAogICAgICBhZGRMb2NhbFJlZmVyZW5jZTogbnVsbAogICAgfTsKICAgIHRlbXBvcmFyeUFwaS5pc0FwaUxldmVsMzRPckFwZXhFcXVpdmFsZW50ID0gaXNBcnQgJiYgKHRlbXBvcmFyeUFwaS5maW5kKCJfWk4zYXJ0N0FwcEluZm8yOUdldFByaW1hcnlBcGtSZWZlcmVuY2VQcm9maWxlRXYiKSAhPT0gbnVsbCB8fCB0ZW1wb3JhcnlBcGkuZmluZCgiX1pOM2FydDZUaHJlYWQxNVJ1bkZsaXBGdW5jdGlvbkVQUzBfIikgIT09IG51bGwpOwogICAgY29uc3QgcGVuZGluZyA9IGlzQXJ0ID8gewogICAgICBmdW5jdGlvbnM6IHsKICAgICAgICBKTklfR2V0Q3JlYXRlZEphdmFWTXM6IFsiSk5JX0dldENyZWF0ZWRKYXZhVk1zIiwgImludCIsIFsicG9pbnRlciIsICJpbnQiLCAicG9pbnRlciJdXSwKICAgICAgICAvLyBBbmRyb2lkIDwgNwogICAgICAgIGFydEludGVycHJldGVyVG9Db21waWxlZENvZGVCcmlkZ2U6IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIHRoaXMuYXJ0SW50ZXJwcmV0ZXJUb0NvbXBpbGVkQ29kZUJyaWRnZSA9IGFkZHJlc3M7CiAgICAgICAgfSwKICAgICAgICAvLyBBbmRyb2lkID49IDgKICAgICAgICBfWk4zYXJ0OUphdmFWTUV4dDEyQWRkR2xvYmFsUmVmRVBOU182VGhyZWFkRU5TXzZPYmpQdHJJTlNfNm1pcnJvcjZPYmplY3RFRUU6IFsiYXJ0OjpKYXZhVk1FeHQ6OkFkZEdsb2JhbFJlZiIsICJwb2ludGVyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciJdXSwKICAgICAgICAvLyBBbmRyb2lkID49IDYKICAgICAgICBfWk4zYXJ0OUphdmFWTUV4dDEyQWRkR2xvYmFsUmVmRVBOU182VGhyZWFkRVBOU182bWlycm9yNk9iamVjdEU6IFsiYXJ0OjpKYXZhVk1FeHQ6OkFkZEdsb2JhbFJlZiIsICJwb2ludGVyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciJdXSwKICAgICAgICAvLyBBbmRyb2lkIDwgNjogbWFrZUFkZEdsb2JhbFJlZkZhbGxiYWNrRm9yQW5kcm9pZDUoKSBuZWVkcyB0aGVzZToKICAgICAgICBfWk4zYXJ0MTdSZWFkZXJXcml0ZXJNdXRleDEzRXhjbHVzaXZlTG9ja0VQTlNfNlRocmVhZEU6IFsiYXJ0OjpSZWFkZXJXcml0ZXJNdXRleDo6RXhjbHVzaXZlTG9jayIsICJ2b2lkIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiXV0sCiAgICAgICAgX1pOM2FydDE3UmVhZGVyV3JpdGVyTXV0ZXgxNUV4Y2x1c2l2ZVVubG9ja0VQTlNfNlRocmVhZEU6IFsiYXJ0OjpSZWFkZXJXcml0ZXJNdXRleDo6RXhjbHVzaXZlVW5sb2NrIiwgInZvaWQiLCBbInBvaW50ZXIiLCAicG9pbnRlciJdXSwKICAgICAgICAvLyBBbmRyb2lkIDw9IDcKICAgICAgICBfWk4zYXJ0MjJJbmRpcmVjdFJlZmVyZW5jZVRhYmxlM0FkZEVqUE5TXzZtaXJyb3I2T2JqZWN0RTogZnVuY3Rpb24oYWRkcmVzcykgewogICAgICAgICAgdGhpc1siYXJ0OjpJbmRpcmVjdFJlZmVyZW5jZVRhYmxlOjpBZGQiXSA9IG5ldyBOYXRpdmVGdW5jdGlvbihhZGRyZXNzLCAicG9pbnRlciIsIFsicG9pbnRlciIsICJ1aW50IiwgInBvaW50ZXIiXSwgbmF0aXZlRnVuY3Rpb25PcHRpb25zMyk7CiAgICAgICAgfSwKICAgICAgICAvLyBBbmRyb2lkID4gNwogICAgICAgIF9aTjNhcnQyMkluZGlyZWN0UmVmZXJlbmNlVGFibGUzQWRkRU5TXzE1SVJUU2VnbWVudFN0YXRlRU5TXzZPYmpQdHJJTlNfNm1pcnJvcjZPYmplY3RFRUU6IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIHRoaXNbImFydDo6SW5kaXJlY3RSZWZlcmVuY2VUYWJsZTo6QWRkIl0gPSBuZXcgTmF0aXZlRnVuY3Rpb24oYWRkcmVzcywgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAidWludCIsICJwb2ludGVyIl0sIG5hdGl2ZUZ1bmN0aW9uT3B0aW9uczMpOwogICAgICAgIH0sCiAgICAgICAgLy8gQW5kcm9pZCA+PSA3CiAgICAgICAgX1pOM2FydDlKYXZhVk1FeHQxMkRlY29kZUdsb2JhbEVQdjogZnVuY3Rpb24oYWRkcmVzcykgewogICAgICAgICAgbGV0IGRlY29kZUdsb2JhbDsKICAgICAgICAgIGlmIChnZXRBbmRyb2lkQXBpTGV2ZWwoKSA+PSAyNikgewogICAgICAgICAgICBkZWNvZGVHbG9iYWwgPSBtYWtlQ3h4TWV0aG9kV3JhcHBlclJldHVybmluZ1BvaW50ZXJCeVZhbHVlKGFkZHJlc3MsIFsicG9pbnRlciIsICJwb2ludGVyIl0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGVjb2RlR2xvYmFsID0gbmV3IE5hdGl2ZUZ1bmN0aW9uKGFkZHJlc3MsICJwb2ludGVyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiXSwgbmF0aXZlRnVuY3Rpb25PcHRpb25zMyk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzWyJhcnQ6OkphdmFWTUV4dDo6RGVjb2RlR2xvYmFsIl0gPSBmdW5jdGlvbih2bTMsIHRocmVhZCwgcmVmKSB7CiAgICAgICAgICAgIHJldHVybiBkZWNvZGVHbG9iYWwodm0zLCByZWYpOwogICAgICAgICAgfTsKICAgICAgICB9LAogICAgICAgIC8vIEFuZHJvaWQgPj0gNgogICAgICAgIF9aTjNhcnQ5SmF2YVZNRXh0MTJEZWNvZGVHbG9iYWxFUE5TXzZUaHJlYWRFUHY6IFsiYXJ0OjpKYXZhVk1FeHQ6OkRlY29kZUdsb2JhbCIsICJwb2ludGVyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciJdXSwKICAgICAgICAvLyBtYWtlRGVjb2RlR2xvYmFsRmFsbGJhY2soKSB1c2VzOgogICAgICAgIC8vIEFuZHJvaWQgPj0gMTUKICAgICAgICBfWk5LM2FydDZUaHJlYWQxOURlY29kZUdsb2JhbEpPYmplY3RFUDhfam9iamVjdDogWyJhcnQ6OlRocmVhZDo6RGVjb2RlSk9iamVjdCIsICJwb2ludGVyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiXV0sCiAgICAgICAgLy8gQW5kcm9pZCA8IDYKICAgICAgICBfWk5LM2FydDZUaHJlYWQxM0RlY29kZUpPYmplY3RFUDhfam9iamVjdDogWyJhcnQ6OlRocmVhZDo6RGVjb2RlSk9iamVjdCIsICJwb2ludGVyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiXV0sCiAgICAgICAgLy8gQW5kcm9pZCA+PSA2CiAgICAgICAgX1pOM2FydDEwVGhyZWFkTGlzdDEwU3VzcGVuZEFsbEVQS2NiOiBbImFydDo6VGhyZWFkTGlzdDo6U3VzcGVuZEFsbCIsICJ2b2lkIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAiYm9vbCJdXSwKICAgICAgICAvLyBvciBmYWxsYmFjazoKICAgICAgICBfWk4zYXJ0MTBUaHJlYWRMaXN0MTBTdXNwZW5kQWxsRXY6IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIGNvbnN0IHN1c3BlbmRBbGwgPSBuZXcgTmF0aXZlRnVuY3Rpb24oYWRkcmVzcywgInZvaWQiLCBbInBvaW50ZXIiXSwgbmF0aXZlRnVuY3Rpb25PcHRpb25zMyk7CiAgICAgICAgICB0aGlzWyJhcnQ6OlRocmVhZExpc3Q6OlN1c3BlbmRBbGwiXSA9IGZ1bmN0aW9uKHRocmVhZExpc3QsIGNhdXNlLCBsb25nU3VzcGVuZCkgewogICAgICAgICAgICByZXR1cm4gc3VzcGVuZEFsbCh0aHJlYWRMaXN0KTsKICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICBfWk4zYXJ0MTBUaHJlYWRMaXN0OVJlc3VtZUFsbEV2OiBbImFydDo6VGhyZWFkTGlzdDo6UmVzdW1lQWxsIiwgInZvaWQiLCBbInBvaW50ZXIiXV0sCiAgICAgICAgLy8gQW5kcm9pZCA+PSA3CiAgICAgICAgX1pOM2FydDExQ2xhc3NMaW5rZXIxMlZpc2l0Q2xhc3Nlc0VQTlNfMTJDbGFzc1Zpc2l0b3JFOiBbImFydDo6Q2xhc3NMaW5rZXI6OlZpc2l0Q2xhc3NlcyIsICJ2b2lkIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiXV0sCiAgICAgICAgLy8gQW5kcm9pZCA8IDcKICAgICAgICBfWk4zYXJ0MTFDbGFzc0xpbmtlcjEyVmlzaXRDbGFzc2VzRVBGYlBOU182bWlycm9yNUNsYXNzRVB2RVM0XzogZnVuY3Rpb24oYWRkcmVzcykgewogICAgICAgICAgY29uc3QgdmlzaXRDbGFzc2VzID0gbmV3IE5hdGl2ZUZ1bmN0aW9uKGFkZHJlc3MsICJ2b2lkIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciJdLCBuYXRpdmVGdW5jdGlvbk9wdGlvbnMzKTsKICAgICAgICAgIHRoaXNbImFydDo6Q2xhc3NMaW5rZXI6OlZpc2l0Q2xhc3NlcyJdID0gZnVuY3Rpb24oY2xhc3NMaW5rZXIsIHZpc2l0b3IpIHsKICAgICAgICAgICAgdmlzaXRDbGFzc2VzKGNsYXNzTGlua2VyLCB2aXNpdG9yLCBOVUxMKTsKICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICBfWk5LM2FydDExQ2xhc3NMaW5rZXIxN1Zpc2l0Q2xhc3NMb2FkZXJzRVBOU18xOENsYXNzTG9hZGVyVmlzaXRvckU6IFsiYXJ0OjpDbGFzc0xpbmtlcjo6VmlzaXRDbGFzc0xvYWRlcnMiLCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIl1dLAogICAgICAgIF9aTjNhcnQyZ2M0SGVhcDEyVmlzaXRPYmplY3RzRVBGdlBOU182bWlycm9yNk9iamVjdEVQdkVTNV86IFsiYXJ0OjpnYzo6SGVhcDo6VmlzaXRPYmplY3RzIiwgInZvaWQiLCBbInBvaW50ZXIiLCAicG9pbnRlciIsICJwb2ludGVyIl1dLAogICAgICAgIF9aTjNhcnQyZ2M0SGVhcDEyR2V0SW5zdGFuY2VzRVJOU18yNFZhcmlhYmxlU2l6ZWRIYW5kbGVTY29wZUVOU182SGFuZGxlSU5TXzZtaXJyb3I1Q2xhc3NFRUVpUk5TdDNfXzE2dmVjdG9ySU5TNF9JTlM1XzZPYmplY3RFRUVOUzhfOWFsbG9jYXRvcklTQl9FRUVFOiBbImFydDo6Z2M6OkhlYXA6OkdldEluc3RhbmNlcyIsICJ2b2lkIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciIsICJpbnQiLCAicG9pbnRlciJdXSwKICAgICAgICAvLyBBbmRyb2lkID49IDkKICAgICAgICBfWk4zYXJ0MmdjNEhlYXAxMkdldEluc3RhbmNlc0VSTlNfMjRWYXJpYWJsZVNpemVkSGFuZGxlU2NvcGVFTlNfNkhhbmRsZUlOU182bWlycm9yNUNsYXNzRUVFYmlSTlN0M19fMTZ2ZWN0b3JJTlM0X0lOUzVfNk9iamVjdEVFRU5TOF85YWxsb2NhdG9ySVNCX0VFRUU6IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIGNvbnN0IGdldEluc3RhbmNlcyA9IG5ldyBOYXRpdmVGdW5jdGlvbihhZGRyZXNzLCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgInBvaW50ZXIiLCAiYm9vbCIsICJpbnQiLCAicG9pbnRlciJdLCBuYXRpdmVGdW5jdGlvbk9wdGlvbnMzKTsKICAgICAgICAgIHRoaXNbImFydDo6Z2M6OkhlYXA6OkdldEluc3RhbmNlcyJdID0gZnVuY3Rpb24oaW5zdGFuY2UsIHNjb3BlLCBoQ2xhc3MsIG1heENvdW50LCBpbnN0YW5jZXMpIHsKICAgICAgICAgICAgY29uc3QgdXNlSXNBc3NpZ25hYmxlRnJvbSA9IDA7CiAgICAgICAgICAgIGdldEluc3RhbmNlcyhpbnN0YW5jZSwgc2NvcGUsIGhDbGFzcywgdXNlSXNBc3NpZ25hYmxlRnJvbSwgbWF4Q291bnQsIGluc3RhbmNlcyk7CiAgICAgICAgICB9OwogICAgICAgIH0sCiAgICAgICAgX1pOM2FydDEyU3RhY2tWaXNpdG9yQzJFUE5TXzZUaHJlYWRFUE5TXzdDb250ZXh0RU5TMF8xM1N0YWNrV2Fsa0tpbmRFamI6IFsiYXJ0OjpTdGFja1Zpc2l0b3I6OlN0YWNrVmlzaXRvciIsICJ2b2lkIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciIsICJ1aW50IiwgInVpbnQiLCAiYm9vbCJdXSwKICAgICAgICBfWk4zYXJ0MTJTdGFja1Zpc2l0b3JDMkVQTlNfNlRocmVhZEVQTlNfN0NvbnRleHRFTlMwXzEzU3RhY2tXYWxrS2luZEVtYjogWyJhcnQ6OlN0YWNrVmlzaXRvcjo6U3RhY2tWaXNpdG9yIiwgInZvaWQiLCBbInBvaW50ZXIiLCAicG9pbnRlciIsICJwb2ludGVyIiwgInVpbnQiLCAic2l6ZV90IiwgImJvb2wiXV0sCiAgICAgICAgX1pOM2FydDEyU3RhY2tWaXNpdG9yOVdhbGtTdGFja0lMTlMwXzE2Q291bnRUcmFuc2l0aW9uc0UwRUVFdmI6IFsiYXJ0OjpTdGFja1Zpc2l0b3I6OldhbGtTdGFjayIsICJ2b2lkIiwgWyJwb2ludGVyIiwgImJvb2wiXV0sCiAgICAgICAgX1pOSzNhcnQxMlN0YWNrVmlzaXRvcjlHZXRNZXRob2RFdjogWyJhcnQ6OlN0YWNrVmlzaXRvcjo6R2V0TWV0aG9kIiwgInBvaW50ZXIiLCBbInBvaW50ZXIiXV0sCiAgICAgICAgX1pOSzNhcnQxMlN0YWNrVmlzaXRvcjE2RGVzY3JpYmVMb2NhdGlvbkV2OiBmdW5jdGlvbihhZGRyZXNzKSB7CiAgICAgICAgICB0aGlzWyJhcnQ6OlN0YWNrVmlzaXRvcjo6RGVzY3JpYmVMb2NhdGlvbiJdID0gbWFrZUN4eE1ldGhvZFdyYXBwZXJSZXR1cm5pbmdTdGRTdHJpbmdCeVZhbHVlKGFkZHJlc3MsIFsicG9pbnRlciJdKTsKICAgICAgICB9LAogICAgICAgIF9aTkszYXJ0MTJTdGFja1Zpc2l0b3IyNEdldEN1cnJlbnRRdWlja0ZyYW1lSW5mb0V2OiBmdW5jdGlvbihhZGRyZXNzKSB7CiAgICAgICAgICB0aGlzWyJhcnQ6OlN0YWNrVmlzaXRvcjo6R2V0Q3VycmVudFF1aWNrRnJhbWVJbmZvIl0gPSBtYWtlQXJ0UXVpY2tGcmFtZUluZm9HZXR0ZXIoYWRkcmVzcyk7CiAgICAgICAgfSwKICAgICAgICBfWk4zYXJ0NlRocmVhZDE4R2V0TG9uZ0p1bXBDb250ZXh0RXY6IFsiYXJ0OjpUaHJlYWQ6OkdldExvbmdKdW1wQ29udGV4dCIsICJwb2ludGVyIiwgWyJwb2ludGVyIl1dLAogICAgICAgIF9aTjNhcnQ2bWlycm9yNUNsYXNzMTNHZXREZXNjcmlwdG9yRVBOU3QzX18xMTJiYXNpY19zdHJpbmdJY05TMl8xMWNoYXJfdHJhaXRzSWNFRU5TMl85YWxsb2NhdG9ySWNFRUVFOiBmdW5jdGlvbihhZGRyZXNzKSB7CiAgICAgICAgICB0aGlzWyJhcnQ6Om1pcnJvcjo6Q2xhc3M6OkdldERlc2NyaXB0b3IiXSA9IGFkZHJlc3M7CiAgICAgICAgfSwKICAgICAgICBfWk4zYXJ0Nm1pcnJvcjVDbGFzczExR2V0TG9jYXRpb25FdjogZnVuY3Rpb24oYWRkcmVzcykgewogICAgICAgICAgdGhpc1siYXJ0OjptaXJyb3I6OkNsYXNzOjpHZXRMb2NhdGlvbiJdID0gbWFrZUN4eE1ldGhvZFdyYXBwZXJSZXR1cm5pbmdTdGRTdHJpbmdCeVZhbHVlKGFkZHJlc3MsIFsicG9pbnRlciJdKTsKICAgICAgICB9LAogICAgICAgIF9aTjNhcnQ5QXJ0TWV0aG9kMTJQcmV0dHlNZXRob2RFYjogZnVuY3Rpb24oYWRkcmVzcykgewogICAgICAgICAgdGhpc1siYXJ0OjpBcnRNZXRob2Q6OlByZXR0eU1ldGhvZCJdID0gbWFrZUN4eE1ldGhvZFdyYXBwZXJSZXR1cm5pbmdTdGRTdHJpbmdCeVZhbHVlKGFkZHJlc3MsIFsicG9pbnRlciIsICJib29sIl0pOwogICAgICAgIH0sCiAgICAgICAgX1pOM2FydDEyUHJldHR5TWV0aG9kRVBOU185QXJ0TWV0aG9kRWI6IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIHRoaXNbImFydDo6QXJ0TWV0aG9kOjpQcmV0dHlNZXRob2ROdWxsU2FmZSJdID0gbWFrZUN4eE1ldGhvZFdyYXBwZXJSZXR1cm5pbmdTdGRTdHJpbmdCeVZhbHVlKGFkZHJlc3MsIFsicG9pbnRlciIsICJib29sIl0pOwogICAgICAgIH0sCiAgICAgICAgLy8gQW5kcm9pZCA8IDYgZm9yIGNsb25lQXJ0TWV0aG9kKCkKICAgICAgICBfWk4zYXJ0NlRocmVhZDE0Q3VycmVudEZyb21HZGJFdjogWyJhcnQ6OlRocmVhZDo6Q3VycmVudEZyb21HZGIiLCAicG9pbnRlciIsIFtdXSwKICAgICAgICBfWk4zYXJ0Nm1pcnJvcjZPYmplY3Q1Q2xvbmVFUE5TXzZUaHJlYWRFOiBmdW5jdGlvbihhZGRyZXNzKSB7CiAgICAgICAgICB0aGlzWyJhcnQ6Om1pcnJvcjo6T2JqZWN0OjpDbG9uZSJdID0gbmV3IE5hdGl2ZUZ1bmN0aW9uKGFkZHJlc3MsICJwb2ludGVyIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiXSwgbmF0aXZlRnVuY3Rpb25PcHRpb25zMyk7CiAgICAgICAgfSwKICAgICAgICBfWk4zYXJ0Nm1pcnJvcjZPYmplY3Q1Q2xvbmVFUE5TXzZUaHJlYWRFbTogZnVuY3Rpb24oYWRkcmVzcykgewogICAgICAgICAgY29uc3QgY2xvbmUgPSBuZXcgTmF0aXZlRnVuY3Rpb24oYWRkcmVzcywgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAicG9pbnRlciIsICJwb2ludGVyIl0sIG5hdGl2ZUZ1bmN0aW9uT3B0aW9uczMpOwogICAgICAgICAgdGhpc1siYXJ0OjptaXJyb3I6Ok9iamVjdDo6Q2xvbmUiXSA9IGZ1bmN0aW9uKHRoaXNQdHIsIHRocmVhZFB0cikgewogICAgICAgICAgICBjb25zdCBudW1UYXJnZXRCeXRlcyA9IE5VTEw7CiAgICAgICAgICAgIHJldHVybiBjbG9uZSh0aGlzUHRyLCB0aHJlYWRQdHIsIG51bVRhcmdldEJ5dGVzKTsKICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICBfWk4zYXJ0Nm1pcnJvcjZPYmplY3Q1Q2xvbmVFUE5TXzZUaHJlYWRFajogZnVuY3Rpb24oYWRkcmVzcykgewogICAgICAgICAgY29uc3QgY2xvbmUgPSBuZXcgTmF0aXZlRnVuY3Rpb24oYWRkcmVzcywgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAicG9pbnRlciIsICJ1aW50Il0sIG5hdGl2ZUZ1bmN0aW9uT3B0aW9uczMpOwogICAgICAgICAgdGhpc1siYXJ0OjptaXJyb3I6Ok9iamVjdDo6Q2xvbmUiXSA9IGZ1bmN0aW9uKHRoaXNQdHIsIHRocmVhZFB0cikgewogICAgICAgICAgICBjb25zdCBudW1UYXJnZXRCeXRlcyA9IDA7CiAgICAgICAgICAgIHJldHVybiBjbG9uZSh0aGlzUHRyLCB0aHJlYWRQdHIsIG51bVRhcmdldEJ5dGVzKTsKICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICBfWk4zYXJ0M0RiZzE0U2V0SmR3cEFsbG93ZWRFYjogWyJhcnQ6OkRiZzo6U2V0SmR3cEFsbG93ZWQiLCAidm9pZCIsIFsiYm9vbCJdXSwKICAgICAgICBfWk4zYXJ0M0RiZzEzQ29uZmlndXJlSmR3cEVSS05TXzRKRFdQMTFKZHdwT3B0aW9uc0U6IFsiYXJ0OjpEYmc6OkNvbmZpZ3VyZUpkd3AiLCAidm9pZCIsIFsicG9pbnRlciJdXSwKICAgICAgICBfWk4zYXJ0MzFJbnRlcm5hbERlYnVnZ2VyQ29udHJvbENhbGxiYWNrMTNTdGFydERlYnVnZ2VyRXY6IFsiYXJ0OjpJbnRlcm5hbERlYnVnZ2VyQ29udHJvbENhbGxiYWNrOjpTdGFydERlYnVnZ2VyIiwgInZvaWQiLCBbInBvaW50ZXIiXV0sCiAgICAgICAgX1pOM2FydDNEYmc5U3RhcnRKZHdwRXY6IFsiYXJ0OjpEYmc6OlN0YXJ0SmR3cCIsICJ2b2lkIiwgW11dLAogICAgICAgIF9aTjNhcnQzRGJnOEdvQWN0aXZlRXY6IFsiYXJ0OjpEYmc6OkdvQWN0aXZlIiwgInZvaWQiLCBbXV0sCiAgICAgICAgX1pOM2FydDNEYmcyMVJlcXVlc3REZW9wdGltaXphdGlvbkVSS05TXzIxRGVvcHRpbWl6YXRpb25SZXF1ZXN0RTogWyJhcnQ6OkRiZzo6UmVxdWVzdERlb3B0aW1pemF0aW9uIiwgInZvaWQiLCBbInBvaW50ZXIiXV0sCiAgICAgICAgX1pOM2FydDNEYmcyME1hbmFnZURlb3B0aW1pemF0aW9uRXY6IFsiYXJ0OjpEYmc6Ok1hbmFnZURlb3B0aW1pemF0aW9uIiwgInZvaWQiLCBbXV0sCiAgICAgICAgX1pOM2FydDE1aW5zdHJ1bWVudGF0aW9uMTVJbnN0cnVtZW50YXRpb24yMEVuYWJsZURlb3B0aW1pemF0aW9uRXY6IFsiYXJ0OjpJbnN0cnVtZW50YXRpb246OkVuYWJsZURlb3B0aW1pemF0aW9uIiwgInZvaWQiLCBbInBvaW50ZXIiXV0sCiAgICAgICAgLy8gQW5kcm9pZCA+PSA2CiAgICAgICAgX1pOM2FydDE1aW5zdHJ1bWVudGF0aW9uMTVJbnN0cnVtZW50YXRpb24yMERlb3B0aW1pemVFdmVyeXRoaW5nRVBLYzogWyJhcnQ6Okluc3RydW1lbnRhdGlvbjo6RGVvcHRpbWl6ZUV2ZXJ5dGhpbmciLCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIl1dLAogICAgICAgIC8vIEFuZHJvaWQgPCA2CiAgICAgICAgX1pOM2FydDE1aW5zdHJ1bWVudGF0aW9uMTVJbnN0cnVtZW50YXRpb24yMERlb3B0aW1pemVFdmVyeXRoaW5nRXY6IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIGNvbnN0IGRlb3B0aW1pemUgPSBuZXcgTmF0aXZlRnVuY3Rpb24oYWRkcmVzcywgInZvaWQiLCBbInBvaW50ZXIiXSwgbmF0aXZlRnVuY3Rpb25PcHRpb25zMyk7CiAgICAgICAgICB0aGlzWyJhcnQ6Okluc3RydW1lbnRhdGlvbjo6RGVvcHRpbWl6ZUV2ZXJ5dGhpbmciXSA9IGZ1bmN0aW9uKGluc3RydW1lbnRhdGlvbiwga2V5KSB7CiAgICAgICAgICAgIGRlb3B0aW1pemUoaW5zdHJ1bWVudGF0aW9uKTsKICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICBfWk4zYXJ0N1J1bnRpbWUxOURlb3B0aW1pemVCb290SW1hZ2VFdjogWyJhcnQ6OlJ1bnRpbWU6OkRlb3B0aW1pemVCb290SW1hZ2UiLCAidm9pZCIsIFsicG9pbnRlciJdXSwKICAgICAgICBfWk4zYXJ0MTVpbnN0cnVtZW50YXRpb24xNUluc3RydW1lbnRhdGlvbjEwRGVvcHRpbWl6ZUVQTlNfOUFydE1ldGhvZEU6IFsiYXJ0OjpJbnN0cnVtZW50YXRpb246OkRlb3B0aW1pemUiLCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIl1dLAogICAgICAgIC8vIEFuZHJvaWQgPj0gMTEKICAgICAgICBfWk4zYXJ0M2puaTEySm5pSWRNYW5hZ2VyMTREZWNvZGVNZXRob2RJZEVQMTBfam1ldGhvZElEOiBbImFydDo6am5pOjpKbmlJZE1hbmFnZXI6OkRlY29kZU1ldGhvZElkIiwgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAicG9pbnRlciJdXSwKICAgICAgICBfWk4zYXJ0MTFpbnRlcnByZXRlcjE4R2V0TnRlcnBFbnRyeVBvaW50RXY6IFsiYXJ0OjppbnRlcnByZXRlcjo6R2V0TnRlcnBFbnRyeVBvaW50IiwgInBvaW50ZXIiLCBbXV0sCiAgICAgICAgX1pOM2FydDdNb25pdG9yMTdUcmFuc2xhdGVMb2NhdGlvbkVQTlNfOUFydE1ldGhvZEVqUFBLY1BpOiBbImFydDo6TW9uaXRvcjo6VHJhbnNsYXRlTG9jYXRpb24iLCAidm9pZCIsIFsicG9pbnRlciIsICJ1aW50MzIiLCAicG9pbnRlciIsICJwb2ludGVyIl1dCiAgICAgIH0sCiAgICAgIHZhcmlhYmxlczogewogICAgICAgIF9aTjNhcnQzRGJnOWdSZWdpc3RyeUU6IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIHRoaXMuaXNKZHdwU3RhcnRlZCA9ICgpID0+ICFhZGRyZXNzLnJlYWRQb2ludGVyKCkuaXNOdWxsKCk7CiAgICAgICAgfSwKICAgICAgICBfWk4zYXJ0M0RiZzE1Z0RlYnVnZ2VyQWN0aXZlRTogZnVuY3Rpb24oYWRkcmVzcykgewogICAgICAgICAgdGhpcy5pc0RlYnVnZ2VyQWN0aXZlID0gKCkgPT4gISFhZGRyZXNzLnJlYWRVOCgpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgb3B0aW9uYWxzOiAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbCiAgICAgICAgImFydEludGVycHJldGVyVG9Db21waWxlZENvZGVCcmlkZ2UiLAogICAgICAgICJfWk4zYXJ0OUphdmFWTUV4dDEyQWRkR2xvYmFsUmVmRVBOU182VGhyZWFkRU5TXzZPYmpQdHJJTlNfNm1pcnJvcjZPYmplY3RFRUUiLAogICAgICAgICJfWk4zYXJ0OUphdmFWTUV4dDEyQWRkR2xvYmFsUmVmRVBOU182VGhyZWFkRVBOU182bWlycm9yNk9iamVjdEUiLAogICAgICAgICJfWk4zYXJ0OUphdmFWTUV4dDEyRGVjb2RlR2xvYmFsRVB2IiwKICAgICAgICAiX1pOM2FydDlKYXZhVk1FeHQxMkRlY29kZUdsb2JhbEVQTlNfNlRocmVhZEVQdiIsCiAgICAgICAgIl9aTkszYXJ0NlRocmVhZDE5RGVjb2RlR2xvYmFsSk9iamVjdEVQOF9qb2JqZWN0IiwKICAgICAgICAiX1pOSzNhcnQ2VGhyZWFkMTNEZWNvZGVKT2JqZWN0RVA4X2pvYmplY3QiLAogICAgICAgICJfWk4zYXJ0MTBUaHJlYWRMaXN0MTBTdXNwZW5kQWxsRVBLY2IiLAogICAgICAgICJfWk4zYXJ0MTBUaHJlYWRMaXN0MTBTdXNwZW5kQWxsRXYiLAogICAgICAgICJfWk4zYXJ0MTFDbGFzc0xpbmtlcjEyVmlzaXRDbGFzc2VzRVBOU18xMkNsYXNzVmlzaXRvckUiLAogICAgICAgICJfWk4zYXJ0MTFDbGFzc0xpbmtlcjEyVmlzaXRDbGFzc2VzRVBGYlBOU182bWlycm9yNUNsYXNzRVB2RVM0XyIsCiAgICAgICAgIl9aTkszYXJ0MTFDbGFzc0xpbmtlcjE3VmlzaXRDbGFzc0xvYWRlcnNFUE5TXzE4Q2xhc3NMb2FkZXJWaXNpdG9yRSIsCiAgICAgICAgIl9aTjNhcnQ2bWlycm9yNk9iamVjdDVDbG9uZUVQTlNfNlRocmVhZEUiLAogICAgICAgICJfWk4zYXJ0Nm1pcnJvcjZPYmplY3Q1Q2xvbmVFUE5TXzZUaHJlYWRFbSIsCiAgICAgICAgIl9aTjNhcnQ2bWlycm9yNk9iamVjdDVDbG9uZUVQTlNfNlRocmVhZEVqIiwKICAgICAgICAiX1pOM2FydDIySW5kaXJlY3RSZWZlcmVuY2VUYWJsZTNBZGRFalBOU182bWlycm9yNk9iamVjdEUiLAogICAgICAgICJfWk4zYXJ0MjJJbmRpcmVjdFJlZmVyZW5jZVRhYmxlM0FkZEVOU18xNUlSVFNlZ21lbnRTdGF0ZUVOU182T2JqUHRySU5TXzZtaXJyb3I2T2JqZWN0RUVFIiwKICAgICAgICAiX1pOM2FydDJnYzRIZWFwMTJWaXNpdE9iamVjdHNFUEZ2UE5TXzZtaXJyb3I2T2JqZWN0RVB2RVM1XyIsCiAgICAgICAgIl9aTjNhcnQyZ2M0SGVhcDEyR2V0SW5zdGFuY2VzRVJOU18yNFZhcmlhYmxlU2l6ZWRIYW5kbGVTY29wZUVOU182SGFuZGxlSU5TXzZtaXJyb3I1Q2xhc3NFRUVpUk5TdDNfXzE2dmVjdG9ySU5TNF9JTlM1XzZPYmplY3RFRUVOUzhfOWFsbG9jYXRvcklTQl9FRUVFIiwKICAgICAgICAiX1pOM2FydDJnYzRIZWFwMTJHZXRJbnN0YW5jZXNFUk5TXzI0VmFyaWFibGVTaXplZEhhbmRsZVNjb3BlRU5TXzZIYW5kbGVJTlNfNm1pcnJvcjVDbGFzc0VFRWJpUk5TdDNfXzE2dmVjdG9ySU5TNF9JTlM1XzZPYmplY3RFRUVOUzhfOWFsbG9jYXRvcklTQl9FRUVFIiwKICAgICAgICAiX1pOM2FydDEyU3RhY2tWaXNpdG9yQzJFUE5TXzZUaHJlYWRFUE5TXzdDb250ZXh0RU5TMF8xM1N0YWNrV2Fsa0tpbmRFamIiLAogICAgICAgICJfWk4zYXJ0MTJTdGFja1Zpc2l0b3JDMkVQTlNfNlRocmVhZEVQTlNfN0NvbnRleHRFTlMwXzEzU3RhY2tXYWxrS2luZEVtYiIsCiAgICAgICAgIl9aTjNhcnQxMlN0YWNrVmlzaXRvcjlXYWxrU3RhY2tJTE5TMF8xNkNvdW50VHJhbnNpdGlvbnNFMEVFRXZiIiwKICAgICAgICAiX1pOSzNhcnQxMlN0YWNrVmlzaXRvcjlHZXRNZXRob2RFdiIsCiAgICAgICAgIl9aTkszYXJ0MTJTdGFja1Zpc2l0b3IxNkRlc2NyaWJlTG9jYXRpb25FdiIsCiAgICAgICAgIl9aTkszYXJ0MTJTdGFja1Zpc2l0b3IyNEdldEN1cnJlbnRRdWlja0ZyYW1lSW5mb0V2IiwKICAgICAgICAiX1pOM2FydDZUaHJlYWQxOEdldExvbmdKdW1wQ29udGV4dEV2IiwKICAgICAgICAiX1pOM2FydDZtaXJyb3I1Q2xhc3MxM0dldERlc2NyaXB0b3JFUE5TdDNfXzExMmJhc2ljX3N0cmluZ0ljTlMyXzExY2hhcl90cmFpdHNJY0VFTlMyXzlhbGxvY2F0b3JJY0VFRUUiLAogICAgICAgICJfWk4zYXJ0Nm1pcnJvcjVDbGFzczExR2V0TG9jYXRpb25FdiIsCiAgICAgICAgIl9aTjNhcnQ5QXJ0TWV0aG9kMTJQcmV0dHlNZXRob2RFYiIsCiAgICAgICAgIl9aTjNhcnQxMlByZXR0eU1ldGhvZEVQTlNfOUFydE1ldGhvZEViIiwKICAgICAgICAiX1pOM2FydDNEYmcxM0NvbmZpZ3VyZUpkd3BFUktOU180SkRXUDExSmR3cE9wdGlvbnNFIiwKICAgICAgICAiX1pOM2FydDMxSW50ZXJuYWxEZWJ1Z2dlckNvbnRyb2xDYWxsYmFjazEzU3RhcnREZWJ1Z2dlckV2IiwKICAgICAgICAiX1pOM2FydDNEYmcxNWdEZWJ1Z2dlckFjdGl2ZUUiLAogICAgICAgICJfWk4zYXJ0MTVpbnN0cnVtZW50YXRpb24xNUluc3RydW1lbnRhdGlvbjIwRW5hYmxlRGVvcHRpbWl6YXRpb25FdiIsCiAgICAgICAgIl9aTjNhcnQxNWluc3RydW1lbnRhdGlvbjE1SW5zdHJ1bWVudGF0aW9uMjBEZW9wdGltaXplRXZlcnl0aGluZ0VQS2MiLAogICAgICAgICJfWk4zYXJ0MTVpbnN0cnVtZW50YXRpb24xNUluc3RydW1lbnRhdGlvbjIwRGVvcHRpbWl6ZUV2ZXJ5dGhpbmdFdiIsCiAgICAgICAgIl9aTjNhcnQ3UnVudGltZTE5RGVvcHRpbWl6ZUJvb3RJbWFnZUV2IiwKICAgICAgICAiX1pOM2FydDE1aW5zdHJ1bWVudGF0aW9uMTVJbnN0cnVtZW50YXRpb24xMERlb3B0aW1pemVFUE5TXzlBcnRNZXRob2RFIiwKICAgICAgICAiX1pOM2FydDNEYmc5U3RhcnRKZHdwRXYiLAogICAgICAgICJfWk4zYXJ0M0RiZzhHb0FjdGl2ZUV2IiwKICAgICAgICAiX1pOM2FydDNEYmcyMVJlcXVlc3REZW9wdGltaXphdGlvbkVSS05TXzIxRGVvcHRpbWl6YXRpb25SZXF1ZXN0RSIsCiAgICAgICAgIl9aTjNhcnQzRGJnMjBNYW5hZ2VEZW9wdGltaXphdGlvbkV2IiwKICAgICAgICAiX1pOM2FydDNEYmc5Z1JlZ2lzdHJ5RSIsCiAgICAgICAgIl9aTjNhcnQzam5pMTJKbmlJZE1hbmFnZXIxNERlY29kZU1ldGhvZElkRVAxMF9qbWV0aG9kSUQiLAogICAgICAgICJfWk4zYXJ0MTFpbnRlcnByZXRlcjE4R2V0TnRlcnBFbnRyeVBvaW50RXYiLAogICAgICAgICJfWk4zYXJ0N01vbml0b3IxN1RyYW5zbGF0ZUxvY2F0aW9uRVBOU185QXJ0TWV0aG9kRWpQUEtjUGkiCiAgICAgIF0pCiAgICB9IDogewogICAgICBmdW5jdGlvbnM6IHsKICAgICAgICBfWjIwZHZtRGVjb2RlSW5kaXJlY3RSZWZQNlRocmVhZFA4X2pvYmplY3Q6IFsiZHZtRGVjb2RlSW5kaXJlY3RSZWYiLCAicG9pbnRlciIsIFsicG9pbnRlciIsICJwb2ludGVyIl1dLAogICAgICAgIF9aMTVkdm1Vc2VKTklCcmlkZ2VQNk1ldGhvZFB2OiBbImR2bVVzZUpOSUJyaWRnZSIsICJ2b2lkIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiXV0sCiAgICAgICAgX1oyMGR2bUhlYXBTb3VyY2VHZXRCYXNldjogWyJkdm1IZWFwU291cmNlR2V0QmFzZSIsICJwb2ludGVyIiwgW11dLAogICAgICAgIF9aMjFkdm1IZWFwU291cmNlR2V0TGltaXR2OiBbImR2bUhlYXBTb3VyY2VHZXRMaW1pdCIsICJwb2ludGVyIiwgW11dLAogICAgICAgIF9aMTZkdm1Jc1ZhbGlkT2JqZWN0UEs2T2JqZWN0OiBbImR2bUlzVmFsaWRPYmplY3QiLCAidWludDgiLCBbInBvaW50ZXIiXV0sCiAgICAgICAgSk5JX0dldENyZWF0ZWRKYXZhVk1zOiBbIkpOSV9HZXRDcmVhdGVkSmF2YVZNcyIsICJpbnQiLCBbInBvaW50ZXIiLCAiaW50IiwgInBvaW50ZXIiXV0KICAgICAgfSwKICAgICAgdmFyaWFibGVzOiB7CiAgICAgICAgZ0R2bUpuaTogZnVuY3Rpb24oYWRkcmVzcykgewogICAgICAgICAgdGhpcy5nRHZtSm5pID0gYWRkcmVzczsKICAgICAgICB9LAogICAgICAgIGdEdm06IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIHRoaXMuZ0R2bSA9IGFkZHJlc3M7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogICAgY29uc3QgewogICAgICBmdW5jdGlvbnMgPSB7fSwKICAgICAgdmFyaWFibGVzID0ge30sCiAgICAgIG9wdGlvbmFscyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCkKICAgIH0gPSBwZW5kaW5nOwogICAgY29uc3QgbWlzc2luZyA9IFtdOwogICAgZm9yIChjb25zdCBbbmFtZSwgc2lnbmF0dXJlXSBvZiBPYmplY3QuZW50cmllcyhmdW5jdGlvbnMpKSB7CiAgICAgIGNvbnN0IGFkZHJlc3MgPSB0ZW1wb3JhcnlBcGkuZmluZChuYW1lKTsKICAgICAgaWYgKGFkZHJlc3MgIT09IG51bGwpIHsKICAgICAgICBpZiAodHlwZW9mIHNpZ25hdHVyZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgc2lnbmF0dXJlLmNhbGwodGVtcG9yYXJ5QXBpLCBhZGRyZXNzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGVtcG9yYXJ5QXBpW3NpZ25hdHVyZVswXV0gPSBuZXcgTmF0aXZlRnVuY3Rpb24oYWRkcmVzcywgc2lnbmF0dXJlWzFdLCBzaWduYXR1cmVbMl0sIG5hdGl2ZUZ1bmN0aW9uT3B0aW9uczMpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoIW9wdGlvbmFscy5oYXMobmFtZSkpIHsKICAgICAgICAgIG1pc3NpbmcucHVzaChuYW1lKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZvciAoY29uc3QgW25hbWUsIGhhbmRsZXJdIG9mIE9iamVjdC5lbnRyaWVzKHZhcmlhYmxlcykpIHsKICAgICAgY29uc3QgYWRkcmVzcyA9IHRlbXBvcmFyeUFwaS5maW5kKG5hbWUpOwogICAgICBpZiAoYWRkcmVzcyAhPT0gbnVsbCkgewogICAgICAgIGhhbmRsZXIuY2FsbCh0ZW1wb3JhcnlBcGksIGFkZHJlc3MpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghb3B0aW9uYWxzLmhhcyhuYW1lKSkgewogICAgICAgICAgbWlzc2luZy5wdXNoKG5hbWUpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKG1pc3NpbmcubGVuZ3RoID4gMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkphdmEgQVBJIG9ubHkgcGFydGlhbGx5IGF2YWlsYWJsZTsgcGxlYXNlIGZpbGUgYSBidWcuIE1pc3Npbmc6ICIgKyBtaXNzaW5nLmpvaW4oIiwgIikpOwogICAgfQogICAgY29uc3Qgdm1zID0gTWVtb3J5LmFsbG9jKHBvaW50ZXJTaXplNSk7CiAgICBjb25zdCB2bUNvdW50ID0gTWVtb3J5LmFsbG9jKGpzaXplU2l6ZSk7CiAgICBjaGVja0puaVJlc3VsdCgiSk5JX0dldENyZWF0ZWRKYXZhVk1zIiwgdGVtcG9yYXJ5QXBpLkpOSV9HZXRDcmVhdGVkSmF2YVZNcyh2bXMsIDEsIHZtQ291bnQpKTsKICAgIGlmICh2bUNvdW50LnJlYWRJbnQoKSA9PT0gMCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHRlbXBvcmFyeUFwaS52bSA9IHZtcy5yZWFkUG9pbnRlcigpOwogICAgaWYgKGlzQXJ0KSB7CiAgICAgIGNvbnN0IGFwaUxldmVsID0gZ2V0QW5kcm9pZEFwaUxldmVsKCk7CiAgICAgIGxldCBrQWNjQ29tcGlsZURvbnRCb3RoZXI7CiAgICAgIGlmIChhcGlMZXZlbCA+PSAyNykgewogICAgICAgIGtBY2NDb21waWxlRG9udEJvdGhlciA9IDMzNTU0NDMyOwogICAgICB9IGVsc2UgaWYgKGFwaUxldmVsID49IDI0KSB7CiAgICAgICAga0FjY0NvbXBpbGVEb250Qm90aGVyID0gMTY3NzcyMTY7CiAgICAgIH0gZWxzZSB7CiAgICAgICAga0FjY0NvbXBpbGVEb250Qm90aGVyID0gMDsKICAgICAgfQogICAgICB0ZW1wb3JhcnlBcGkua0FjY0NvbXBpbGVEb250Qm90aGVyID0ga0FjY0NvbXBpbGVEb250Qm90aGVyOwogICAgICBjb25zdCBhcnRSdW50aW1lID0gdGVtcG9yYXJ5QXBpLnZtLmFkZChwb2ludGVyU2l6ZTUpLnJlYWRQb2ludGVyKCk7CiAgICAgIHRlbXBvcmFyeUFwaS5hcnRSdW50aW1lID0gYXJ0UnVudGltZTsKICAgICAgY29uc3QgcnVudGltZVNwZWMgPSBnZXRBcnRSdW50aW1lU3BlYyh0ZW1wb3JhcnlBcGkpOwogICAgICBjb25zdCBydW50aW1lT2Zmc2V0ID0gcnVudGltZVNwZWMub2Zmc2V0OwogICAgICBjb25zdCBpbnN0cnVtZW50YXRpb25PZmZzZXQgPSBydW50aW1lT2Zmc2V0Lmluc3RydW1lbnRhdGlvbjsKICAgICAgdGVtcG9yYXJ5QXBpLmFydEluc3RydW1lbnRhdGlvbiA9IGluc3RydW1lbnRhdGlvbk9mZnNldCAhPT0gbnVsbCA/IGFydFJ1bnRpbWUuYWRkKGluc3RydW1lbnRhdGlvbk9mZnNldCkgOiBudWxsOwogICAgICB0ZW1wb3JhcnlBcGkuYXJ0SGVhcCA9IGFydFJ1bnRpbWUuYWRkKHJ1bnRpbWVPZmZzZXQuaGVhcCkucmVhZFBvaW50ZXIoKTsKICAgICAgdGVtcG9yYXJ5QXBpLmFydFRocmVhZExpc3QgPSBhcnRSdW50aW1lLmFkZChydW50aW1lT2Zmc2V0LnRocmVhZExpc3QpLnJlYWRQb2ludGVyKCk7CiAgICAgIGNvbnN0IGNsYXNzTGlua2VyID0gYXJ0UnVudGltZS5hZGQocnVudGltZU9mZnNldC5jbGFzc0xpbmtlcikucmVhZFBvaW50ZXIoKTsKICAgICAgY29uc3QgY2xhc3NMaW5rZXJPZmZzZXRzID0gZ2V0QXJ0Q2xhc3NMaW5rZXJTcGVjKGFydFJ1bnRpbWUsIHJ1bnRpbWVTcGVjKS5vZmZzZXQ7CiAgICAgIGNvbnN0IHF1aWNrUmVzb2x1dGlvblRyYW1wb2xpbmUgPSBjbGFzc0xpbmtlci5hZGQoY2xhc3NMaW5rZXJPZmZzZXRzLnF1aWNrUmVzb2x1dGlvblRyYW1wb2xpbmUpLnJlYWRQb2ludGVyKCk7CiAgICAgIGNvbnN0IHF1aWNrSW10Q29uZmxpY3RUcmFtcG9saW5lID0gY2xhc3NMaW5rZXIuYWRkKGNsYXNzTGlua2VyT2Zmc2V0cy5xdWlja0ltdENvbmZsaWN0VHJhbXBvbGluZSkucmVhZFBvaW50ZXIoKTsKICAgICAgY29uc3QgcXVpY2tHZW5lcmljSm5pVHJhbXBvbGluZSA9IGNsYXNzTGlua2VyLmFkZChjbGFzc0xpbmtlck9mZnNldHMucXVpY2tHZW5lcmljSm5pVHJhbXBvbGluZSkucmVhZFBvaW50ZXIoKTsKICAgICAgY29uc3QgcXVpY2tUb0ludGVycHJldGVyQnJpZGdlVHJhbXBvbGluZSA9IGNsYXNzTGlua2VyLmFkZChjbGFzc0xpbmtlck9mZnNldHMucXVpY2tUb0ludGVycHJldGVyQnJpZGdlVHJhbXBvbGluZSkucmVhZFBvaW50ZXIoKTsKICAgICAgdGVtcG9yYXJ5QXBpLmFydENsYXNzTGlua2VyID0gewogICAgICAgIGFkZHJlc3M6IGNsYXNzTGlua2VyLAogICAgICAgIHF1aWNrUmVzb2x1dGlvblRyYW1wb2xpbmUsCiAgICAgICAgcXVpY2tJbXRDb25mbGljdFRyYW1wb2xpbmUsCiAgICAgICAgcXVpY2tHZW5lcmljSm5pVHJhbXBvbGluZSwKICAgICAgICBxdWlja1RvSW50ZXJwcmV0ZXJCcmlkZ2VUcmFtcG9saW5lCiAgICAgIH07CiAgICAgIGNvbnN0IHZtMyA9IG5ldyBWTSh0ZW1wb3JhcnlBcGkpOwogICAgICB0ZW1wb3JhcnlBcGkuYXJ0UXVpY2tHZW5lcmljSm5pVHJhbXBvbGluZSA9IGdldEFydFF1aWNrRW50cnlwb2ludEZyb21UcmFtcG9saW5lKHF1aWNrR2VuZXJpY0puaVRyYW1wb2xpbmUsIHZtMyk7CiAgICAgIHRlbXBvcmFyeUFwaS5hcnRRdWlja1RvSW50ZXJwcmV0ZXJCcmlkZ2UgPSBnZXRBcnRRdWlja0VudHJ5cG9pbnRGcm9tVHJhbXBvbGluZShxdWlja1RvSW50ZXJwcmV0ZXJCcmlkZ2VUcmFtcG9saW5lLCB2bTMpOwogICAgICB0ZW1wb3JhcnlBcGkuYXJ0UXVpY2tSZXNvbHV0aW9uVHJhbXBvbGluZSA9IGdldEFydFF1aWNrRW50cnlwb2ludEZyb21UcmFtcG9saW5lKHF1aWNrUmVzb2x1dGlvblRyYW1wb2xpbmUsIHZtMyk7CiAgICAgIGlmICh0ZW1wb3JhcnlBcGlbImFydDo6SmF2YVZNRXh0OjpBZGRHbG9iYWxSZWYiXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGVtcG9yYXJ5QXBpWyJhcnQ6OkphdmFWTUV4dDo6QWRkR2xvYmFsUmVmIl0gPSBtYWtlQWRkR2xvYmFsUmVmRmFsbGJhY2tGb3JBbmRyb2lkNSh0ZW1wb3JhcnlBcGkpOwogICAgICB9CiAgICAgIGlmICh0ZW1wb3JhcnlBcGlbImFydDo6SmF2YVZNRXh0OjpEZWNvZGVHbG9iYWwiXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGVtcG9yYXJ5QXBpWyJhcnQ6OkphdmFWTUV4dDo6RGVjb2RlR2xvYmFsIl0gPSBtYWtlRGVjb2RlR2xvYmFsRmFsbGJhY2sodGVtcG9yYXJ5QXBpKTsKICAgICAgfQogICAgICBpZiAodGVtcG9yYXJ5QXBpWyJhcnQ6OkFydE1ldGhvZDo6UHJldHR5TWV0aG9kIl0gPT09IHZvaWQgMCkgewogICAgICAgIHRlbXBvcmFyeUFwaVsiYXJ0OjpBcnRNZXRob2Q6OlByZXR0eU1ldGhvZCJdID0gdGVtcG9yYXJ5QXBpWyJhcnQ6OkFydE1ldGhvZDo6UHJldHR5TWV0aG9kTnVsbFNhZmUiXTsKICAgICAgfQogICAgICBpZiAodGVtcG9yYXJ5QXBpWyJhcnQ6OmludGVycHJldGVyOjpHZXROdGVycEVudHJ5UG9pbnQiXSAhPT0gdm9pZCAwKSB7CiAgICAgICAgdGVtcG9yYXJ5QXBpLmFydE50ZXJwRW50cnlQb2ludCA9IHRlbXBvcmFyeUFwaVsiYXJ0OjppbnRlcnByZXRlcjo6R2V0TnRlcnBFbnRyeVBvaW50Il0oKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0ZW1wb3JhcnlBcGkuYXJ0TnRlcnBFbnRyeVBvaW50ID0gdGVtcG9yYXJ5QXBpLmZpbmQoIkV4ZWN1dGVOdGVycEltcGwiKTsKICAgICAgfQogICAgICBhcnRDb250cm9sbGVyID0gbWFrZUFydENvbnRyb2xsZXIodGVtcG9yYXJ5QXBpLCB2bTMpOwogICAgICBmaXh1cEFydFF1aWNrRGVsaXZlckV4Y2VwdGlvbkJ1Zyh0ZW1wb3JhcnlBcGkpOwogICAgICBsZXQgY2FjaGVkSnZtdGkgPSBudWxsOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGVtcG9yYXJ5QXBpLCAianZtdGkiLCB7CiAgICAgICAgZ2V0KCkgewogICAgICAgICAgaWYgKGNhY2hlZEp2bXRpID09PSBudWxsKSB7CiAgICAgICAgICAgIGNhY2hlZEp2bXRpID0gW3RyeUdldEVudkp2bXRpKHZtMywgdGhpcy5hcnRSdW50aW1lKV07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2FjaGVkSnZtdGlbMF07CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IGN4eEltcG9ydHMgPSB2bU1vZHVsZS5lbnVtZXJhdGVJbXBvcnRzKCkuZmlsdGVyKChpbXApID0+IGltcC5uYW1lLmluZGV4T2YoIl9aIikgPT09IDApLnJlZHVjZSgocmVzdWx0LCBpbXApID0+IHsKICAgICAgcmVzdWx0W2ltcC5uYW1lXSA9IGltcC5hZGRyZXNzOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwge30pOwogICAgdGVtcG9yYXJ5QXBpLiRuZXcgPSBuZXcgTmF0aXZlRnVuY3Rpb24oY3h4SW1wb3J0cy5fWm53bSB8fCBjeHhJbXBvcnRzLl9abndqLCAicG9pbnRlciIsIFsidWxvbmciXSwgbmF0aXZlRnVuY3Rpb25PcHRpb25zMyk7CiAgICB0ZW1wb3JhcnlBcGkuJGRlbGV0ZSA9IG5ldyBOYXRpdmVGdW5jdGlvbihjeHhJbXBvcnRzLl9aZGxQdiwgInZvaWQiLCBbInBvaW50ZXIiXSwgbmF0aXZlRnVuY3Rpb25PcHRpb25zMyk7CiAgICBNZXRob2RNYW5nbGVyID0gaXNBcnQgPyBBcnRNZXRob2RNYW5nbGVyIDogRGFsdmlrTWV0aG9kTWFuZ2xlcjsKICAgIHJldHVybiB0ZW1wb3JhcnlBcGk7CiAgfQogIGZ1bmN0aW9uIHRyeUdldEVudkp2bXRpKHZtMywgcnVudGltZTIpIHsKICAgIGxldCBlbnYgPSBudWxsOwogICAgdm0zLnBlcmZvcm0oKCkgPT4gewogICAgICBjb25zdCBlbnN1cmVQbHVnaW5Mb2FkZWRBZGRyID0gZ2V0QXBpKCkuZmluZCgiX1pOM2FydDdSdW50aW1lMThFbnN1cmVQbHVnaW5Mb2FkZWRFUEtjUE5TdDNfXzExMmJhc2ljX3N0cmluZ0ljTlMzXzExY2hhcl90cmFpdHNJY0VFTlMzXzlhbGxvY2F0b3JJY0VFRUUiKTsKICAgICAgaWYgKGVuc3VyZVBsdWdpbkxvYWRlZEFkZHIgPT09IG51bGwpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3QgZW5zdXJlUGx1Z2luTG9hZGVkID0gbmV3IE5hdGl2ZUZ1bmN0aW9uKAogICAgICAgIGVuc3VyZVBsdWdpbkxvYWRlZEFkZHIsCiAgICAgICAgImJvb2wiLAogICAgICAgIFsicG9pbnRlciIsICJwb2ludGVyIiwgInBvaW50ZXIiXQogICAgICApOwogICAgICBjb25zdCBlcnJvclB0ciA9IE1lbW9yeS5hbGxvYyhwb2ludGVyU2l6ZTUpOwogICAgICBjb25zdCBzdWNjZXNzID0gZW5zdXJlUGx1Z2luTG9hZGVkKHJ1bnRpbWUyLCBNZW1vcnkuYWxsb2NVdGY4U3RyaW5nKCJsaWJvcGVuamRranZtdGkuc28iKSwgZXJyb3JQdHIpOwogICAgICBpZiAoIXN1Y2Nlc3MpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3Qga0FydFRpVmVyc2lvbiA9IGp2bXRpVmVyc2lvbi52MV8yIHwgMTA3Mzc0MTgyNDsKICAgICAgY29uc3QgaGFuZGxlID0gdm0zLnRyeUdldEVudkhhbmRsZShrQXJ0VGlWZXJzaW9uKTsKICAgICAgaWYgKGhhbmRsZSA9PT0gbnVsbCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBlbnYgPSBuZXcgRW52SnZtdGkoaGFuZGxlLCB2bTMpOwogICAgICBjb25zdCBjYXBhQnVmID0gTWVtb3J5LmFsbG9jKDgpOwogICAgICBjYXBhQnVmLndyaXRlVTY0KGp2bXRpQ2FwYWJpbGl0aWVzLmNhblRhZ09iamVjdHMpOwogICAgICBjb25zdCByZXN1bHQgPSBlbnYuYWRkQ2FwYWJpbGl0aWVzKGNhcGFCdWYpOwogICAgICBpZiAocmVzdWx0ICE9PSBKTklfT0spIHsKICAgICAgICBlbnYgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBlbnY7CiAgfQogIGZ1bmN0aW9uIGVuc3VyZUNsYXNzSW5pdGlhbGl6ZWQoZW52LCBjbGFzc1JlZikgewogICAgY29uc3QgYXBpMiA9IGdldEFwaSgpOwogICAgaWYgKGFwaTIuZmxhdm9yICE9PSAiYXJ0IikgewogICAgICByZXR1cm47CiAgICB9CiAgICBlbnYuZ2V0RmllbGRJZChjbGFzc1JlZiwgIngiLCAiWiIpOwogICAgZW52LmV4Y2VwdGlvbkNsZWFyKCk7CiAgfQogIGZ1bmN0aW9uIGdldEFydFZNU3BlYyhhcGkyKSB7CiAgICByZXR1cm4gewogICAgICBvZmZzZXQ6IHBvaW50ZXJTaXplNSA9PT0gNCA/IHsKICAgICAgICBnbG9iYWxzTG9jazogMzIsCiAgICAgICAgZ2xvYmFsczogNzIKICAgICAgfSA6IHsKICAgICAgICBnbG9iYWxzTG9jazogNjQsCiAgICAgICAgZ2xvYmFsczogMTEyCiAgICAgIH0KICAgIH07CiAgfQogIGZ1bmN0aW9uIF9nZXRBcnRSdW50aW1lU3BlYyhhcGkyKSB7CiAgICBjb25zdCB2bTMgPSBhcGkyLnZtOwogICAgY29uc3QgcnVudGltZTIgPSBhcGkyLmFydFJ1bnRpbWU7CiAgICBjb25zdCBzdGFydE9mZnNldCA9IHBvaW50ZXJTaXplNSA9PT0gNCA/IDIwMCA6IDM4NDsKICAgIGNvbnN0IGVuZE9mZnNldCA9IHN0YXJ0T2Zmc2V0ICsgMTAwICogcG9pbnRlclNpemU1OwogICAgY29uc3QgYXBpTGV2ZWwgPSBnZXRBbmRyb2lkQXBpTGV2ZWwoKTsKICAgIGNvbnN0IGNvZGVuYW1lID0gZ2V0QW5kcm9pZENvZGVuYW1lKCk7CiAgICBjb25zdCB7IGlzQXBpTGV2ZWwzNE9yQXBleEVxdWl2YWxlbnQgfSA9IGFwaTI7CiAgICBsZXQgc3BlYyA9IG51bGw7CiAgICBmb3IgKGxldCBvZmZzZXQgPSBzdGFydE9mZnNldDsgb2Zmc2V0ICE9PSBlbmRPZmZzZXQ7IG9mZnNldCArPSBwb2ludGVyU2l6ZTUpIHsKICAgICAgY29uc3QgdmFsdWUgPSBydW50aW1lMi5hZGQob2Zmc2V0KS5yZWFkUG9pbnRlcigpOwogICAgICBpZiAodmFsdWUuZXF1YWxzKHZtMykpIHsKICAgICAgICBsZXQgY2xhc3NMaW5rZXJPZmZzZXRzOwogICAgICAgIGxldCBqbmlJZE1hbmFnZXJPZmZzZXQgPSBudWxsOwogICAgICAgIGlmIChhcGlMZXZlbCA+PSAzMyB8fCBjb2RlbmFtZSA9PT0gIlRpcmFtaXN1IiB8fCBpc0FwaUxldmVsMzRPckFwZXhFcXVpdmFsZW50KSB7CiAgICAgICAgICBjbGFzc0xpbmtlck9mZnNldHMgPSBbb2Zmc2V0IC0gNCAqIHBvaW50ZXJTaXplNV07CiAgICAgICAgICBqbmlJZE1hbmFnZXJPZmZzZXQgPSBvZmZzZXQgLSBwb2ludGVyU2l6ZTU7CiAgICAgICAgfSBlbHNlIGlmIChhcGlMZXZlbCA+PSAzMCB8fCBjb2RlbmFtZSA9PT0gIlIiKSB7CiAgICAgICAgICBjbGFzc0xpbmtlck9mZnNldHMgPSBbb2Zmc2V0IC0gMyAqIHBvaW50ZXJTaXplNSwgb2Zmc2V0IC0gNCAqIHBvaW50ZXJTaXplNV07CiAgICAgICAgICBqbmlJZE1hbmFnZXJPZmZzZXQgPSBvZmZzZXQgLSBwb2ludGVyU2l6ZTU7CiAgICAgICAgfSBlbHNlIGlmIChhcGlMZXZlbCA+PSAyOSkgewogICAgICAgICAgY2xhc3NMaW5rZXJPZmZzZXRzID0gW29mZnNldCAtIDIgKiBwb2ludGVyU2l6ZTVdOwogICAgICAgIH0gZWxzZSBpZiAoYXBpTGV2ZWwgPj0gMjcpIHsKICAgICAgICAgIGNsYXNzTGlua2VyT2Zmc2V0cyA9IFtvZmZzZXQgLSBTVERfU1RSSU5HX1NJWkUgLSAzICogcG9pbnRlclNpemU1XTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2xhc3NMaW5rZXJPZmZzZXRzID0gW29mZnNldCAtIFNURF9TVFJJTkdfU0laRSAtIDIgKiBwb2ludGVyU2l6ZTVdOwogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IGNsYXNzTGlua2VyT2Zmc2V0IG9mIGNsYXNzTGlua2VyT2Zmc2V0cykgewogICAgICAgICAgY29uc3QgaW50ZXJuVGFibGVPZmZzZXQgPSBjbGFzc0xpbmtlck9mZnNldCAtIHBvaW50ZXJTaXplNTsKICAgICAgICAgIGNvbnN0IHRocmVhZExpc3RPZmZzZXQgPSBpbnRlcm5UYWJsZU9mZnNldCAtIHBvaW50ZXJTaXplNTsKICAgICAgICAgIGxldCBoZWFwT2Zmc2V0OwogICAgICAgICAgaWYgKGlzQXBpTGV2ZWwzNE9yQXBleEVxdWl2YWxlbnQpIHsKICAgICAgICAgICAgaGVhcE9mZnNldCA9IHRocmVhZExpc3RPZmZzZXQgLSA5ICogcG9pbnRlclNpemU1OwogICAgICAgICAgfSBlbHNlIGlmIChhcGlMZXZlbCA+PSAyNCkgewogICAgICAgICAgICBoZWFwT2Zmc2V0ID0gdGhyZWFkTGlzdE9mZnNldCAtIDggKiBwb2ludGVyU2l6ZTU7CiAgICAgICAgICB9IGVsc2UgaWYgKGFwaUxldmVsID49IDIzKSB7CiAgICAgICAgICAgIGhlYXBPZmZzZXQgPSB0aHJlYWRMaXN0T2Zmc2V0IC0gNyAqIHBvaW50ZXJTaXplNTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGhlYXBPZmZzZXQgPSB0aHJlYWRMaXN0T2Zmc2V0IC0gNCAqIHBvaW50ZXJTaXplNTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGNhbmRpZGF0ZSA9IHsKICAgICAgICAgICAgb2Zmc2V0OiB7CiAgICAgICAgICAgICAgaGVhcDogaGVhcE9mZnNldCwKICAgICAgICAgICAgICB0aHJlYWRMaXN0OiB0aHJlYWRMaXN0T2Zmc2V0LAogICAgICAgICAgICAgIGludGVyblRhYmxlOiBpbnRlcm5UYWJsZU9mZnNldCwKICAgICAgICAgICAgICBjbGFzc0xpbmtlcjogY2xhc3NMaW5rZXJPZmZzZXQsCiAgICAgICAgICAgICAgam5pSWRNYW5hZ2VyOiBqbmlJZE1hbmFnZXJPZmZzZXQKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIGlmICh0cnlHZXRBcnRDbGFzc0xpbmtlclNwZWMocnVudGltZTIsIGNhbmRpZGF0ZSkgIT09IG51bGwpIHsKICAgICAgICAgICAgc3BlYyA9IGNhbmRpZGF0ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICBpZiAoc3BlYyA9PT0gbnVsbCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBkZXRlcm1pbmUgUnVudGltZSBmaWVsZCBvZmZzZXRzIik7CiAgICB9CiAgICBzcGVjLm9mZnNldC5pbnN0cnVtZW50YXRpb24gPSB0cnlEZXRlY3RJbnN0cnVtZW50YXRpb25PZmZzZXQoYXBpMik7CiAgICBzcGVjLm9mZnNldC5qbmlJZHNJbmRpcmVjdGlvbiA9IHRyeURldGVjdEpuaUlkc0luZGlyZWN0aW9uT2Zmc2V0KGFwaTIpOwogICAgcmV0dXJuIHNwZWM7CiAgfQogIHZhciBpbnN0cnVtZW50YXRpb25PZmZzZXRQYXJzZXJzID0gewogICAgaWEzMjogcGFyc2V4ODZJbnN0cnVtZW50YXRpb25PZmZzZXQsCiAgICB4NjQ6IHBhcnNleDg2SW5zdHJ1bWVudGF0aW9uT2Zmc2V0LAogICAgYXJtOiBwYXJzZUFybUluc3RydW1lbnRhdGlvbk9mZnNldCwKICAgIGFybTY0OiBwYXJzZUFybTY0SW5zdHJ1bWVudGF0aW9uT2Zmc2V0CiAgfTsKICBmdW5jdGlvbiB0cnlEZXRlY3RJbnN0cnVtZW50YXRpb25PZmZzZXQoYXBpMikgewogICAgY29uc3QgaW1wbCA9IGFwaTJbImFydDo6UnVudGltZTo6RGVvcHRpbWl6ZUJvb3RJbWFnZSJdOwogICAgaWYgKGltcGwgPT09IHZvaWQgMCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHJldHVybiBwYXJzZUluc3RydWN0aW9uc0F0KGltcGwsIGluc3RydW1lbnRhdGlvbk9mZnNldFBhcnNlcnNbUHJvY2Vzcy5hcmNoXSwgeyBsaW1pdDogMzAgfSk7CiAgfQogIGZ1bmN0aW9uIHBhcnNleDg2SW5zdHJ1bWVudGF0aW9uT2Zmc2V0KGluc24pIHsKICAgIGlmIChpbnNuLm1uZW1vbmljICE9PSAibGVhIikgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IG9mZnNldCA9IGluc24ub3BlcmFuZHNbMV0udmFsdWUuZGlzcDsKICAgIGlmIChvZmZzZXQgPCAyNTYgfHwgb2Zmc2V0ID4gMTAyNCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHJldHVybiBvZmZzZXQ7CiAgfQogIGZ1bmN0aW9uIHBhcnNlQXJtSW5zdHJ1bWVudGF0aW9uT2Zmc2V0KGluc24pIHsKICAgIGlmIChpbnNuLm1uZW1vbmljICE9PSAiYWRkLnciKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3Qgb3BzID0gaW5zbi5vcGVyYW5kczsKICAgIGlmIChvcHMubGVuZ3RoICE9PSAzKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3Qgb3AyID0gb3BzWzJdOwogICAgaWYgKG9wMi50eXBlICE9PSAiaW1tIikgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHJldHVybiBvcDIudmFsdWU7CiAgfQogIGZ1bmN0aW9uIHBhcnNlQXJtNjRJbnN0cnVtZW50YXRpb25PZmZzZXQoaW5zbikgewogICAgaWYgKGluc24ubW5lbW9uaWMgIT09ICJhZGQiKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3Qgb3BzID0gaW5zbi5vcGVyYW5kczsKICAgIGlmIChvcHMubGVuZ3RoICE9PSAzKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgaWYgKG9wc1swXS52YWx1ZSA9PT0gInNwIiB8fCBvcHNbMV0udmFsdWUgPT09ICJzcCIpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBjb25zdCBvcDIgPSBvcHNbMl07CiAgICBpZiAob3AyLnR5cGUgIT09ICJpbW0iKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3Qgb2Zmc2V0ID0gb3AyLnZhbHVlLnZhbHVlT2YoKTsKICAgIGlmIChvZmZzZXQgPCAyNTYgfHwgb2Zmc2V0ID4gMTAyNCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHJldHVybiBvZmZzZXQ7CiAgfQogIHZhciBqbmlJZHNJbmRpcmVjdGlvbk9mZnNldFBhcnNlcnMgPSB7CiAgICBpYTMyOiBwYXJzZXg4NkpuaUlkc0luZGlyZWN0aW9uT2Zmc2V0LAogICAgeDY0OiBwYXJzZXg4NkpuaUlkc0luZGlyZWN0aW9uT2Zmc2V0LAogICAgYXJtOiBwYXJzZUFybUpuaUlkc0luZGlyZWN0aW9uT2Zmc2V0LAogICAgYXJtNjQ6IHBhcnNlQXJtNjRKbmlJZHNJbmRpcmVjdGlvbk9mZnNldAogIH07CiAgZnVuY3Rpb24gdHJ5RGV0ZWN0Sm5pSWRzSW5kaXJlY3Rpb25PZmZzZXQoYXBpMikgewogICAgY29uc3QgaW1wbCA9IGFwaTIuZmluZCgiX1pOM2FydDdSdW50aW1lMTJTZXRKbmlJZFR5cGVFTlNfOUpuaUlkVHlwZUUiKTsKICAgIGlmIChpbXBsID09PSBudWxsKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3Qgb2Zmc2V0ID0gcGFyc2VJbnN0cnVjdGlvbnNBdChpbXBsLCBqbmlJZHNJbmRpcmVjdGlvbk9mZnNldFBhcnNlcnNbUHJvY2Vzcy5hcmNoXSwgeyBsaW1pdDogMjAgfSk7CiAgICBpZiAob2Zmc2V0ID09PSBudWxsKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGRldGVybWluZSBSdW50aW1lLmpuaV9pZHNfaW5kaXJlY3Rpb25fIG9mZnNldCIpOwogICAgfQogICAgcmV0dXJuIG9mZnNldDsKICB9CiAgZnVuY3Rpb24gcGFyc2V4ODZKbmlJZHNJbmRpcmVjdGlvbk9mZnNldChpbnNuKSB7CiAgICBpZiAoaW5zbi5tbmVtb25pYyA9PT0gImNtcCIpIHsKICAgICAgcmV0dXJuIGluc24ub3BlcmFuZHNbMF0udmFsdWUuZGlzcDsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KICBmdW5jdGlvbiBwYXJzZUFybUpuaUlkc0luZGlyZWN0aW9uT2Zmc2V0KGluc24pIHsKICAgIGlmIChpbnNuLm1uZW1vbmljID09PSAibGRyLnciKSB7CiAgICAgIHJldHVybiBpbnNuLm9wZXJhbmRzWzFdLnZhbHVlLmRpc3A7CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CiAgZnVuY3Rpb24gcGFyc2VBcm02NEpuaUlkc0luZGlyZWN0aW9uT2Zmc2V0KGluc24sIHByZXZJbnNuKSB7CiAgICBpZiAocHJldkluc24gPT09IG51bGwpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBjb25zdCB7IG1uZW1vbmljIH0gPSBpbnNuOwogICAgY29uc3QgeyBtbmVtb25pYzogcHJldk1uZW1vbmljIH0gPSBwcmV2SW5zbjsKICAgIGlmIChtbmVtb25pYyA9PT0gImNtcCIgJiYgcHJldk1uZW1vbmljID09PSAibGRyIiB8fCBtbmVtb25pYyA9PT0gImJsIiAmJiBwcmV2TW5lbW9uaWMgPT09ICJzdHIiKSB7CiAgICAgIHJldHVybiBwcmV2SW5zbi5vcGVyYW5kc1sxXS52YWx1ZS5kaXNwOwogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQogIGZ1bmN0aW9uIF9nZXRBcnRJbnN0cnVtZW50YXRpb25TcGVjKCkgewogICAgY29uc3QgZGVvcHRpbWl6YXRpb25FbmFibGVkT2Zmc2V0cyA9IHsKICAgICAgIjQtMjEiOiAxMzYsCiAgICAgICI0LTIyIjogMTM2LAogICAgICAiNC0yMyI6IDE3MiwKICAgICAgIjQtMjQiOiAxOTYsCiAgICAgICI0LTI1IjogMTk2LAogICAgICAiNC0yNiI6IDE5NiwKICAgICAgIjQtMjciOiAxOTYsCiAgICAgICI0LTI4IjogMjEyLAogICAgICAiNC0yOSI6IDE3MiwKICAgICAgIjQtMzAiOiAxODAsCiAgICAgICI0LTMxIjogMTgwLAogICAgICAiOC0yMSI6IDIyNCwKICAgICAgIjgtMjIiOiAyMjQsCiAgICAgICI4LTIzIjogMjk2LAogICAgICAiOC0yNCI6IDM0NCwKICAgICAgIjgtMjUiOiAzNDQsCiAgICAgICI4LTI2IjogMzUyLAogICAgICAiOC0yNyI6IDM1MiwKICAgICAgIjgtMjgiOiAzOTIsCiAgICAgICI4LTI5IjogMzI4LAogICAgICAiOC0zMCI6IDMzNiwKICAgICAgIjgtMzEiOiAzMzYKICAgIH07CiAgICBjb25zdCBkZW9wdEVuYWJsZWRPZmZzZXQgPSBkZW9wdGltaXphdGlvbkVuYWJsZWRPZmZzZXRzW2Ake3BvaW50ZXJTaXplNX0tJHtnZXRBbmRyb2lkQXBpTGV2ZWwoKX1gXTsKICAgIGlmIChkZW9wdEVuYWJsZWRPZmZzZXQgPT09IHZvaWQgMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBkZXRlcm1pbmUgSW5zdHJ1bWVudGF0aW9uIGZpZWxkIG9mZnNldHMiKTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIG9mZnNldDogewogICAgICAgIGZvcmNlZEludGVycHJldE9ubHk6IDQsCiAgICAgICAgZGVvcHRpbWl6YXRpb25FbmFibGVkOiBkZW9wdEVuYWJsZWRPZmZzZXQKICAgICAgfQogICAgfTsKICB9CiAgZnVuY3Rpb24gZ2V0QXJ0Q2xhc3NMaW5rZXJTcGVjKHJ1bnRpbWUyLCBydW50aW1lU3BlYykgewogICAgY29uc3Qgc3BlYyA9IHRyeUdldEFydENsYXNzTGlua2VyU3BlYyhydW50aW1lMiwgcnVudGltZVNwZWMpOwogICAgaWYgKHNwZWMgPT09IG51bGwpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZGV0ZXJtaW5lIENsYXNzTGlua2VyIGZpZWxkIG9mZnNldHMiKTsKICAgIH0KICAgIHJldHVybiBzcGVjOwogIH0KICBmdW5jdGlvbiB0cnlHZXRBcnRDbGFzc0xpbmtlclNwZWMocnVudGltZTIsIHJ1bnRpbWVTcGVjKSB7CiAgICBpZiAoY2FjaGVkQXJ0Q2xhc3NMaW5rZXJTcGVjICE9PSBudWxsKSB7CiAgICAgIHJldHVybiBjYWNoZWRBcnRDbGFzc0xpbmtlclNwZWM7CiAgICB9CiAgICBjb25zdCB7IGNsYXNzTGlua2VyOiBjbGFzc0xpbmtlck9mZnNldCwgaW50ZXJuVGFibGU6IGludGVyblRhYmxlT2Zmc2V0IH0gPSBydW50aW1lU3BlYy5vZmZzZXQ7CiAgICBjb25zdCBjbGFzc0xpbmtlciA9IHJ1bnRpbWUyLmFkZChjbGFzc0xpbmtlck9mZnNldCkucmVhZFBvaW50ZXIoKTsKICAgIGNvbnN0IGludGVyblRhYmxlID0gcnVudGltZTIuYWRkKGludGVyblRhYmxlT2Zmc2V0KS5yZWFkUG9pbnRlcigpOwogICAgY29uc3Qgc3RhcnRPZmZzZXQgPSBwb2ludGVyU2l6ZTUgPT09IDQgPyAxMDAgOiAyMDA7CiAgICBjb25zdCBlbmRPZmZzZXQgPSBzdGFydE9mZnNldCArIDEwMCAqIHBvaW50ZXJTaXplNTsKICAgIGNvbnN0IGFwaUxldmVsID0gZ2V0QW5kcm9pZEFwaUxldmVsKCk7CiAgICBsZXQgc3BlYyA9IG51bGw7CiAgICBmb3IgKGxldCBvZmZzZXQgPSBzdGFydE9mZnNldDsgb2Zmc2V0ICE9PSBlbmRPZmZzZXQ7IG9mZnNldCArPSBwb2ludGVyU2l6ZTUpIHsKICAgICAgY29uc3QgdmFsdWUgPSBjbGFzc0xpbmtlci5hZGQob2Zmc2V0KS5yZWFkUG9pbnRlcigpOwogICAgICBpZiAodmFsdWUuZXF1YWxzKGludGVyblRhYmxlKSkgewogICAgICAgIGxldCBkZWx0YTsKICAgICAgICBpZiAoYXBpTGV2ZWwgPj0gMzAgfHwgZ2V0QW5kcm9pZENvZGVuYW1lKCkgPT09ICJSIikgewogICAgICAgICAgZGVsdGEgPSA2OwogICAgICAgIH0gZWxzZSBpZiAoYXBpTGV2ZWwgPj0gMjkpIHsKICAgICAgICAgIGRlbHRhID0gNDsKICAgICAgICB9IGVsc2UgaWYgKGFwaUxldmVsID49IDIzKSB7CiAgICAgICAgICBkZWx0YSA9IDM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRlbHRhID0gNTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcXVpY2tHZW5lcmljSm5pVHJhbXBvbGluZU9mZnNldCA9IG9mZnNldCArIGRlbHRhICogcG9pbnRlclNpemU1OwogICAgICAgIGxldCBxdWlja1Jlc29sdXRpb25UcmFtcG9saW5lT2Zmc2V0OwogICAgICAgIGlmIChhcGlMZXZlbCA+PSAyMykgewogICAgICAgICAgcXVpY2tSZXNvbHV0aW9uVHJhbXBvbGluZU9mZnNldCA9IHF1aWNrR2VuZXJpY0puaVRyYW1wb2xpbmVPZmZzZXQgLSAyICogcG9pbnRlclNpemU1OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBxdWlja1Jlc29sdXRpb25UcmFtcG9saW5lT2Zmc2V0ID0gcXVpY2tHZW5lcmljSm5pVHJhbXBvbGluZU9mZnNldCAtIDMgKiBwb2ludGVyU2l6ZTU7CiAgICAgICAgfQogICAgICAgIHNwZWMgPSB7CiAgICAgICAgICBvZmZzZXQ6IHsKICAgICAgICAgICAgcXVpY2tSZXNvbHV0aW9uVHJhbXBvbGluZTogcXVpY2tSZXNvbHV0aW9uVHJhbXBvbGluZU9mZnNldCwKICAgICAgICAgICAgcXVpY2tJbXRDb25mbGljdFRyYW1wb2xpbmU6IHF1aWNrR2VuZXJpY0puaVRyYW1wb2xpbmVPZmZzZXQgLSBwb2ludGVyU2l6ZTUsCiAgICAgICAgICAgIHF1aWNrR2VuZXJpY0puaVRyYW1wb2xpbmU6IHF1aWNrR2VuZXJpY0puaVRyYW1wb2xpbmVPZmZzZXQsCiAgICAgICAgICAgIHF1aWNrVG9JbnRlcnByZXRlckJyaWRnZVRyYW1wb2xpbmU6IHF1aWNrR2VuZXJpY0puaVRyYW1wb2xpbmVPZmZzZXQgKyBwb2ludGVyU2l6ZTUKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICBpZiAoc3BlYyAhPT0gbnVsbCkgewogICAgICBjYWNoZWRBcnRDbGFzc0xpbmtlclNwZWMgPSBzcGVjOwogICAgfQogICAgcmV0dXJuIHNwZWM7CiAgfQogIGZ1bmN0aW9uIGdldEFydENsYXNzU3BlYyh2bTMpIHsKICAgIGNvbnN0IE1BWF9PRkZTRVQgPSAyNTY7CiAgICBsZXQgc3BlYyA9IG51bGw7CiAgICB2bTMucGVyZm9ybSgoZW52KSA9PiB7CiAgICAgIGNvbnN0IGZpZWxkU3BlYyA9IGdldEFydEZpZWxkU3BlYyh2bTMpOwogICAgICBjb25zdCBtZXRob2RTcGVjID0gZ2V0QXJ0TWV0aG9kU3BlYyh2bTMpOwogICAgICBjb25zdCBmSW5mbyA9IHsKICAgICAgICBhcnRBcnJheUxlbmd0aFNpemU6IDQsCiAgICAgICAgYXJ0QXJyYXlFbnRyeVNpemU6IGZpZWxkU3BlYy5zaXplLAogICAgICAgIC8vIGphdmEvaW8vRmlsZSBoYXMgMTUgZmllbGRzIG9uIEFuZHJvaWQgMTYuCiAgICAgICAgYXJ0QXJyYXlNYXg6IDI1CiAgICAgIH07CiAgICAgIGNvbnN0IG1JbmZvID0gewogICAgICAgIGFydEFycmF5TGVuZ3RoU2l6ZTogcG9pbnRlclNpemU1LAogICAgICAgIGFydEFycmF5RW50cnlTaXplOiBtZXRob2RTcGVjLnNpemUsCiAgICAgICAgLy8gamF2YS9pby9GaWxlIGhhcyA2MyBtZXRob2RzIG9uIEFuZHJvaWQgMTYuCiAgICAgICAgYXJ0QXJyYXlNYXg6IDEwMAogICAgICB9OwogICAgICBjb25zdCByZWFkQXJ0QXJyYXkgPSAob2JqZWN0QmFzZSwgZmllbGRPZmZzZXQsIGxlbmd0aFNpemUpID0+IHsKICAgICAgICBjb25zdCBoZWFkZXIgPSBvYmplY3RCYXNlLmFkZChmaWVsZE9mZnNldCkucmVhZFBvaW50ZXIoKTsKICAgICAgICBpZiAoaGVhZGVyLmlzTnVsbCgpKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoID0gbGVuZ3RoU2l6ZSA9PT0gNCA/IGhlYWRlci5yZWFkVTMyKCkgOiBoZWFkZXIucmVhZFU2NCgpLnZhbHVlT2YoKTsKICAgICAgICBpZiAobGVuZ3RoIDw9IDApIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgZGF0YTogaGVhZGVyLmFkZChsZW5ndGhTaXplKQogICAgICAgIH07CiAgICAgIH07CiAgICAgIGNvbnN0IGhhc0VudHJ5ID0gKG9iamVjdEJhc2UsIG9mZnNldCwgbmVlZGxlLCBpbmZvKSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbnN0IGFydEFycmF5ID0gcmVhZEFydEFycmF5KG9iamVjdEJhc2UsIG9mZnNldCwgaW5mby5hcnRBcnJheUxlbmd0aFNpemUpOwogICAgICAgICAgaWYgKGFydEFycmF5ID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGFydEFycmF5RW5kID0gTWF0aC5taW4oYXJ0QXJyYXkubGVuZ3RoLCBpbmZvLmFydEFycmF5TWF4KTsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBhcnRBcnJheUVuZDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IGZpZWxkUHRyID0gYXJ0QXJyYXkuZGF0YS5hZGQoaSAqIGluZm8uYXJ0QXJyYXlFbnRyeVNpemUpOwogICAgICAgICAgICBpZiAoZmllbGRQdHIuZXF1YWxzKG5lZWRsZSkpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggewogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH07CiAgICAgIGNvbnN0IGNsYXp6ID0gZW52LmZpbmRDbGFzcygiamF2YS9pby9GaWxlIik7CiAgICAgIGNvbnN0IGNsYXp6UmVmID0gZW52Lm5ld0dsb2JhbFJlZihjbGF6eik7CiAgICAgIHRyeSB7CiAgICAgICAgbGV0IG9iamVjdDsKICAgICAgICB3aXRoUnVubmFibGVBcnRUaHJlYWQodm0zLCBlbnYsICh0aHJlYWQpID0+IHsKICAgICAgICAgIG9iamVjdCA9IGdldEFwaSgpWyJhcnQ6OkphdmFWTUV4dDo6RGVjb2RlR2xvYmFsIl0odm0zLCB0aHJlYWQsIGNsYXp6UmVmKTsKICAgICAgICB9KTsKICAgICAgICBjb25zdCBmaWVsZEluc3RhbmNlID0gZW52LmdldEZpZWxkSWQoY2xhenpSZWYsICJwYXRoIiwgIkxqYXZhL2xhbmcvU3RyaW5nOyIpOwogICAgICAgIGNvbnN0IGZpZWxkU3RhdGljID0gZW52LmdldFN0YXRpY0ZpZWxkSWQoY2xhenpSZWYsICJzZXBhcmF0b3JDaGFyIiwgIkMiKTsKICAgICAgICBsZXQgb2Zmc2V0U3RhdGljID0gLTE7CiAgICAgICAgbGV0IG9mZnNldEluc3RhbmNlID0gLTE7CiAgICAgICAgZm9yIChsZXQgb2Zmc2V0ID0gMDsgb2Zmc2V0ICE9PSBNQVhfT0ZGU0VUOyBvZmZzZXQgKz0gNCkgewogICAgICAgICAgaWYgKG9mZnNldFN0YXRpYyA9PT0gLTEgJiYgaGFzRW50cnkob2JqZWN0LCBvZmZzZXQsIGZpZWxkU3RhdGljLCBmSW5mbykpIHsKICAgICAgICAgICAgb2Zmc2V0U3RhdGljID0gb2Zmc2V0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKG9mZnNldEluc3RhbmNlID09PSAtMSAmJiBoYXNFbnRyeShvYmplY3QsIG9mZnNldCwgZmllbGRJbnN0YW5jZSwgZkluZm8pKSB7CiAgICAgICAgICAgIG9mZnNldEluc3RhbmNlID0gb2Zmc2V0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAob2Zmc2V0SW5zdGFuY2UgPT09IC0xIHx8IG9mZnNldFN0YXRpYyA9PT0gLTEpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGZpbmQgZmllbGRzIGluIGphdmEvaW8vRmlsZTsgcGxlYXNlIGZpbGUgYSBidWciKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc2ZpZWxkT2Zmc2V0ID0gb2Zmc2V0SW5zdGFuY2UgIT09IG9mZnNldFN0YXRpYyA/IG9mZnNldFN0YXRpYyA6IDA7CiAgICAgICAgY29uc3QgaWZpZWxkT2Zmc2V0ID0gb2Zmc2V0SW5zdGFuY2U7CiAgICAgICAgbGV0IG9mZnNldE1ldGhvZHMgPSAtMTsKICAgICAgICBjb25zdCBtZXRob2RJbnN0YW5jZSA9IGVudi5nZXRNZXRob2RJZChjbGF6elJlZiwgImxlbmd0aCIsICIoKUoiKTsKICAgICAgICBmb3IgKGxldCBvZmZzZXQgPSAwOyBvZmZzZXQgIT09IE1BWF9PRkZTRVQ7IG9mZnNldCArPSA0KSB7CiAgICAgICAgICBpZiAob2Zmc2V0TWV0aG9kcyA9PT0gLTEgJiYgaGFzRW50cnkob2JqZWN0LCBvZmZzZXQsIG1ldGhvZEluc3RhbmNlLCBtSW5mbykpIHsKICAgICAgICAgICAgb2Zmc2V0TWV0aG9kcyA9IG9mZnNldDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKG9mZnNldE1ldGhvZHMgPT09IC0xKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG1ldGhvZHMgaW4gamF2YS9pby9GaWxlOyBwbGVhc2UgZmlsZSBhIGJ1ZyIpOwogICAgICAgIH0KICAgICAgICBsZXQgb2Zmc2V0Q29waWVkTWV0aG9kcyA9IC0xOwogICAgICAgIGNvbnN0IG1ldGhvZHNBcnJheSA9IHJlYWRBcnRBcnJheShvYmplY3QsIG9mZnNldE1ldGhvZHMsIG1JbmZvLmFydEFycmF5TGVuZ3RoU2l6ZSk7CiAgICAgICAgY29uc3QgbWV0aG9kc0FycmF5U2l6ZSA9IG1ldGhvZHNBcnJheS5sZW5ndGg7CiAgICAgICAgZm9yIChsZXQgb2Zmc2V0ID0gb2Zmc2V0TWV0aG9kczsgb2Zmc2V0ICE9PSBNQVhfT0ZGU0VUOyBvZmZzZXQgKz0gNCkgewogICAgICAgICAgaWYgKG9iamVjdC5hZGQob2Zmc2V0KS5yZWFkVTE2KCkgPT09IG1ldGhvZHNBcnJheVNpemUpIHsKICAgICAgICAgICAgb2Zmc2V0Q29waWVkTWV0aG9kcyA9IG9mZnNldDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChvZmZzZXRDb3BpZWRNZXRob2RzID09PSAtMSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBjb3BpZWQgbWV0aG9kcyBpbiBqYXZhL2lvL0ZpbGU7IHBsZWFzZSBmaWxlIGEgYnVnIik7CiAgICAgICAgfQogICAgICAgIHNwZWMgPSB7CiAgICAgICAgICBvZmZzZXQ6IHsKICAgICAgICAgICAgaWZpZWxkczogaWZpZWxkT2Zmc2V0LAogICAgICAgICAgICBtZXRob2RzOiBvZmZzZXRNZXRob2RzLAogICAgICAgICAgICBzZmllbGRzOiBzZmllbGRPZmZzZXQsCiAgICAgICAgICAgIGNvcGllZE1ldGhvZHNPZmZzZXQ6IG9mZnNldENvcGllZE1ldGhvZHMKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9IGZpbmFsbHkgewogICAgICAgIGVudi5kZWxldGVMb2NhbFJlZihjbGF6eik7CiAgICAgICAgZW52LmRlbGV0ZUdsb2JhbFJlZihjbGF6elJlZik7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHNwZWM7CiAgfQogIGZ1bmN0aW9uIF9nZXRBcnRNZXRob2RTcGVjKHZtMykgewogICAgY29uc3QgYXBpMiA9IGdldEFwaSgpOwogICAgbGV0IHNwZWM7CiAgICB2bTMucGVyZm9ybSgoZW52KSA9PiB7CiAgICAgIGNvbnN0IHByb2Nlc3MgPSBlbnYuZmluZENsYXNzKCJhbmRyb2lkL29zL1Byb2Nlc3MiKTsKICAgICAgY29uc3QgZ2V0RWxhcHNlZENwdVRpbWUgPSB1bndyYXBNZXRob2RJZChlbnYuZ2V0U3RhdGljTWV0aG9kSWQocHJvY2VzcywgImdldEVsYXBzZWRDcHVUaW1lIiwgIigpSiIpKTsKICAgICAgZW52LmRlbGV0ZUxvY2FsUmVmKHByb2Nlc3MpOwogICAgICBjb25zdCBydW50aW1lTW9kdWxlID0gUHJvY2Vzcy5nZXRNb2R1bGVCeU5hbWUoImxpYmFuZHJvaWRfcnVudGltZS5zbyIpOwogICAgICBjb25zdCBydW50aW1lU3RhcnQgPSBydW50aW1lTW9kdWxlLmJhc2U7CiAgICAgIGNvbnN0IHJ1bnRpbWVFbmQgPSBydW50aW1lU3RhcnQuYWRkKHJ1bnRpbWVNb2R1bGUuc2l6ZSk7CiAgICAgIGNvbnN0IGFwaUxldmVsID0gZ2V0QW5kcm9pZEFwaUxldmVsKCk7CiAgICAgIGNvbnN0IGVudHJ5cG9pbnRGaWVsZFNpemUgPSBhcGlMZXZlbCA8PSAyMSA/IDggOiBwb2ludGVyU2l6ZTU7CiAgICAgIGNvbnN0IGV4cGVjdGVkQWNjZXNzRmxhZ3MgPSBrQWNjUHVibGljIHwga0FjY1N0YXRpYyB8IGtBY2NGaW5hbCB8IGtBY2NOYXRpdmU7CiAgICAgIGNvbnN0IHJlbGV2YW50QWNjZXNzRmxhZ3NNYXNrID0gfihrQWNjRmFzdEludGVycHJldGVyVG9JbnRlcnByZXRlckludm9rZSB8IGtBY2NQdWJsaWNBcGkgfCBrQWNjTnRlcnBJbnZva2VGYXN0UGF0aEZsYWcpID4+PiAwOwogICAgICBsZXQgam5pQ29kZU9mZnNldCA9IG51bGw7CiAgICAgIGxldCBhY2Nlc3NGbGFnc09mZnNldCA9IG51bGw7CiAgICAgIGxldCByZW1haW5pbmcgPSAyOwogICAgICBmb3IgKGxldCBvZmZzZXQgPSAwOyBvZmZzZXQgIT09IDY0ICYmIHJlbWFpbmluZyAhPT0gMDsgb2Zmc2V0ICs9IDQpIHsKICAgICAgICBjb25zdCBmaWVsZCA9IGdldEVsYXBzZWRDcHVUaW1lLmFkZChvZmZzZXQpOwogICAgICAgIGlmIChqbmlDb2RlT2Zmc2V0ID09PSBudWxsKSB7CiAgICAgICAgICBjb25zdCBhZGRyZXNzID0gZmllbGQucmVhZFBvaW50ZXIoKTsKICAgICAgICAgIGlmIChhZGRyZXNzLmNvbXBhcmUocnVudGltZVN0YXJ0KSA+PSAwICYmIGFkZHJlc3MuY29tcGFyZShydW50aW1lRW5kKSA8IDApIHsKICAgICAgICAgICAgam5pQ29kZU9mZnNldCA9IG9mZnNldDsKICAgICAgICAgICAgcmVtYWluaW5nLS07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChhY2Nlc3NGbGFnc09mZnNldCA9PT0gbnVsbCkgewogICAgICAgICAgY29uc3QgZmxhZ3MgPSBmaWVsZC5yZWFkVTMyKCk7CiAgICAgICAgICBpZiAoKGZsYWdzICYgcmVsZXZhbnRBY2Nlc3NGbGFnc01hc2spID09PSBleHBlY3RlZEFjY2Vzc0ZsYWdzKSB7CiAgICAgICAgICAgIGFjY2Vzc0ZsYWdzT2Zmc2V0ID0gb2Zmc2V0OwogICAgICAgICAgICByZW1haW5pbmctLTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHJlbWFpbmluZyAhPT0gMCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGRldGVybWluZSBBcnRNZXRob2QgZmllbGQgb2Zmc2V0cyIpOwogICAgICB9CiAgICAgIGNvbnN0IHF1aWNrQ29kZU9mZnNldCA9IGpuaUNvZGVPZmZzZXQgKyBlbnRyeXBvaW50RmllbGRTaXplOwogICAgICBjb25zdCBzaXplID0gYXBpTGV2ZWwgPD0gMjEgPyBxdWlja0NvZGVPZmZzZXQgKyAzMiA6IHF1aWNrQ29kZU9mZnNldCArIHBvaW50ZXJTaXplNTsKICAgICAgc3BlYyA9IHsKICAgICAgICBzaXplLAogICAgICAgIG9mZnNldDogewogICAgICAgICAgam5pQ29kZTogam5pQ29kZU9mZnNldCwKICAgICAgICAgIHF1aWNrQ29kZTogcXVpY2tDb2RlT2Zmc2V0LAogICAgICAgICAgYWNjZXNzRmxhZ3M6IGFjY2Vzc0ZsYWdzT2Zmc2V0CiAgICAgICAgfQogICAgICB9OwogICAgICBpZiAoImFydEludGVycHJldGVyVG9Db21waWxlZENvZGVCcmlkZ2UiIGluIGFwaTIpIHsKICAgICAgICBzcGVjLm9mZnNldC5pbnRlcnByZXRlckNvZGUgPSBqbmlDb2RlT2Zmc2V0IC0gZW50cnlwb2ludEZpZWxkU2l6ZTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gc3BlYzsKICB9CiAgZnVuY3Rpb24gZ2V0QXJ0RmllbGRTcGVjKHZtMykgewogICAgY29uc3QgYXBpTGV2ZWwgPSBnZXRBbmRyb2lkQXBpTGV2ZWwoKTsKICAgIGlmIChhcGlMZXZlbCA+PSAyMykgewogICAgICByZXR1cm4gewogICAgICAgIHNpemU6IDE2LAogICAgICAgIG9mZnNldDogewogICAgICAgICAgYWNjZXNzRmxhZ3M6IDQKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICBpZiAoYXBpTGV2ZWwgPj0gMjEpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBzaXplOiAyNCwKICAgICAgICBvZmZzZXQ6IHsKICAgICAgICAgIGFjY2Vzc0ZsYWdzOiAxMgogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KICBmdW5jdGlvbiBfZ2V0QXJ0VGhyZWFkU3BlYyh2bTMpIHsKICAgIGNvbnN0IGFwaUxldmVsID0gZ2V0QW5kcm9pZEFwaUxldmVsKCk7CiAgICBsZXQgc3BlYzsKICAgIHZtMy5wZXJmb3JtKChlbnYpID0+IHsKICAgICAgY29uc3QgdGhyZWFkSGFuZGxlID0gZ2V0QXJ0VGhyZWFkRnJvbUVudihlbnYpOwogICAgICBjb25zdCBlbnZIYW5kbGUgPSBlbnYuaGFuZGxlOwogICAgICBsZXQgaXNFeGNlcHRpb25SZXBvcnRlZE9mZnNldCA9IG51bGw7CiAgICAgIGxldCBleGNlcHRpb25PZmZzZXQgPSBudWxsOwogICAgICBsZXQgdGhyb3dMb2NhdGlvbk9mZnNldCA9IG51bGw7CiAgICAgIGxldCB0b3BIYW5kbGVTY29wZU9mZnNldCA9IG51bGw7CiAgICAgIGxldCBtYW5hZ2VkU3RhY2tPZmZzZXQgPSBudWxsOwogICAgICBsZXQgc2VsZk9mZnNldCA9IG51bGw7CiAgICAgIGZvciAobGV0IG9mZnNldCA9IDE0NDsgb2Zmc2V0ICE9PSAyNTY7IG9mZnNldCArPSBwb2ludGVyU2l6ZTUpIHsKICAgICAgICBjb25zdCBmaWVsZCA9IHRocmVhZEhhbmRsZS5hZGQob2Zmc2V0KTsKICAgICAgICBjb25zdCB2YWx1ZSA9IGZpZWxkLnJlYWRQb2ludGVyKCk7CiAgICAgICAgaWYgKHZhbHVlLmVxdWFscyhlbnZIYW5kbGUpKSB7CiAgICAgICAgICBleGNlcHRpb25PZmZzZXQgPSBvZmZzZXQgLSA2ICogcG9pbnRlclNpemU1OwogICAgICAgICAgbWFuYWdlZFN0YWNrT2Zmc2V0ID0gb2Zmc2V0IC0gNCAqIHBvaW50ZXJTaXplNTsKICAgICAgICAgIHNlbGZPZmZzZXQgPSBvZmZzZXQgKyAyICogcG9pbnRlclNpemU1OwogICAgICAgICAgaWYgKGFwaUxldmVsIDw9IDIyKSB7CiAgICAgICAgICAgIGV4Y2VwdGlvbk9mZnNldCAtPSBwb2ludGVyU2l6ZTU7CiAgICAgICAgICAgIGlzRXhjZXB0aW9uUmVwb3J0ZWRPZmZzZXQgPSBleGNlcHRpb25PZmZzZXQgLSBwb2ludGVyU2l6ZTUgLSA5ICogOCAtIDMgKiA0OwogICAgICAgICAgICB0aHJvd0xvY2F0aW9uT2Zmc2V0ID0gb2Zmc2V0ICsgNiAqIHBvaW50ZXJTaXplNTsKICAgICAgICAgICAgbWFuYWdlZFN0YWNrT2Zmc2V0IC09IHBvaW50ZXJTaXplNTsKICAgICAgICAgICAgc2VsZk9mZnNldCAtPSBwb2ludGVyU2l6ZTU7CiAgICAgICAgICB9CiAgICAgICAgICB0b3BIYW5kbGVTY29wZU9mZnNldCA9IG9mZnNldCArIDkgKiBwb2ludGVyU2l6ZTU7CiAgICAgICAgICBpZiAoYXBpTGV2ZWwgPD0gMjIpIHsKICAgICAgICAgICAgdG9wSGFuZGxlU2NvcGVPZmZzZXQgKz0gMiAqIHBvaW50ZXJTaXplNSArIDQ7CiAgICAgICAgICAgIGlmIChwb2ludGVyU2l6ZTUgPT09IDgpIHsKICAgICAgICAgICAgICB0b3BIYW5kbGVTY29wZU9mZnNldCArPSA0OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYXBpTGV2ZWwgPj0gMjMpIHsKICAgICAgICAgICAgdG9wSGFuZGxlU2NvcGVPZmZzZXQgKz0gcG9pbnRlclNpemU1OwogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICh0b3BIYW5kbGVTY29wZU9mZnNldCA9PT0gbnVsbCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGRldGVybWluZSBBcnRUaHJlYWQgZmllbGQgb2Zmc2V0cyIpOwogICAgICB9CiAgICAgIHNwZWMgPSB7CiAgICAgICAgb2Zmc2V0OiB7CiAgICAgICAgICBpc0V4Y2VwdGlvblJlcG9ydGVkVG9JbnN0cnVtZW50YXRpb246IGlzRXhjZXB0aW9uUmVwb3J0ZWRPZmZzZXQsCiAgICAgICAgICBleGNlcHRpb246IGV4Y2VwdGlvbk9mZnNldCwKICAgICAgICAgIHRocm93TG9jYXRpb246IHRocm93TG9jYXRpb25PZmZzZXQsCiAgICAgICAgICB0b3BIYW5kbGVTY29wZTogdG9wSGFuZGxlU2NvcGVPZmZzZXQsCiAgICAgICAgICBtYW5hZ2VkU3RhY2s6IG1hbmFnZWRTdGFja09mZnNldCwKICAgICAgICAgIHNlbGY6IHNlbGZPZmZzZXQKICAgICAgICB9CiAgICAgIH07CiAgICB9KTsKICAgIHJldHVybiBzcGVjOwogIH0KICBmdW5jdGlvbiBfZ2V0QXJ0TWFuYWdlZFN0YWNrU3BlYygpIHsKICAgIGNvbnN0IGFwaUxldmVsID0gZ2V0QW5kcm9pZEFwaUxldmVsKCk7CiAgICBpZiAoYXBpTGV2ZWwgPj0gMjMpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBvZmZzZXQ6IHsKICAgICAgICAgIHRvcFF1aWNrRnJhbWU6IDAsCiAgICAgICAgICBsaW5rOiBwb2ludGVyU2l6ZTUKICAgICAgICB9CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gewogICAgICAgIG9mZnNldDogewogICAgICAgICAgdG9wUXVpY2tGcmFtZTogMiAqIHBvaW50ZXJTaXplNSwKICAgICAgICAgIGxpbms6IDAKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgfQogIHZhciBhcnRRdWlja1RyYW1wb2xpbmVQYXJzZXJzID0gewogICAgaWEzMjogcGFyc2VBcnRRdWlja1RyYW1wb2xpbmVYODYsCiAgICB4NjQ6IHBhcnNlQXJ0UXVpY2tUcmFtcG9saW5lWDg2LAogICAgYXJtOiBwYXJzZUFydFF1aWNrVHJhbXBvbGluZUFybSwKICAgIGFybTY0OiBwYXJzZUFydFF1aWNrVHJhbXBvbGluZUFybTY0CiAgfTsKICBmdW5jdGlvbiBnZXRBcnRRdWlja0VudHJ5cG9pbnRGcm9tVHJhbXBvbGluZSh0cmFtcG9saW5lLCB2bTMpIHsKICAgIGxldCBhZGRyZXNzOwogICAgdm0zLnBlcmZvcm0oKGVudikgPT4gewogICAgICBjb25zdCB0aHJlYWQgPSBnZXRBcnRUaHJlYWRGcm9tRW52KGVudik7CiAgICAgIGNvbnN0IHRyeVBhcnNlID0gYXJ0UXVpY2tUcmFtcG9saW5lUGFyc2Vyc1tQcm9jZXNzLmFyY2hdOwogICAgICBjb25zdCBpbnNuID0gSW5zdHJ1Y3Rpb24ucGFyc2UodHJhbXBvbGluZSk7CiAgICAgIGNvbnN0IG9mZnNldCA9IHRyeVBhcnNlKGluc24pOwogICAgICBpZiAob2Zmc2V0ICE9PSBudWxsKSB7CiAgICAgICAgYWRkcmVzcyA9IHRocmVhZC5hZGQob2Zmc2V0KS5yZWFkUG9pbnRlcigpOwogICAgICB9IGVsc2UgewogICAgICAgIGFkZHJlc3MgPSB0cmFtcG9saW5lOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBhZGRyZXNzOwogIH0KICBmdW5jdGlvbiBwYXJzZUFydFF1aWNrVHJhbXBvbGluZVg4NihpbnNuKSB7CiAgICBpZiAoaW5zbi5tbmVtb25pYyA9PT0gImptcCIpIHsKICAgICAgcmV0dXJuIGluc24ub3BlcmFuZHNbMF0udmFsdWUuZGlzcDsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KICBmdW5jdGlvbiBwYXJzZUFydFF1aWNrVHJhbXBvbGluZUFybShpbnNuKSB7CiAgICBpZiAoaW5zbi5tbmVtb25pYyA9PT0gImxkci53IikgewogICAgICByZXR1cm4gaW5zbi5vcGVyYW5kc1sxXS52YWx1ZS5kaXNwOwogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQogIGZ1bmN0aW9uIHBhcnNlQXJ0UXVpY2tUcmFtcG9saW5lQXJtNjQoaW5zbikgewogICAgaWYgKGluc24ubW5lbW9uaWMgPT09ICJsZHIiKSB7CiAgICAgIHJldHVybiBpbnNuLm9wZXJhbmRzWzFdLnZhbHVlLmRpc3A7CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CiAgZnVuY3Rpb24gZ2V0QXJ0VGhyZWFkRnJvbUVudihlbnYpIHsKICAgIHJldHVybiBlbnYuaGFuZGxlLmFkZChwb2ludGVyU2l6ZTUpLnJlYWRQb2ludGVyKCk7CiAgfQogIGZ1bmN0aW9uIF9nZXRBbmRyb2lkVmVyc2lvbigpIHsKICAgIHJldHVybiBnZXRBbmRyb2lkU3lzdGVtUHJvcGVydHkoInJvLmJ1aWxkLnZlcnNpb24ucmVsZWFzZSIpOwogIH0KICBmdW5jdGlvbiBfZ2V0QW5kcm9pZENvZGVuYW1lKCkgewogICAgcmV0dXJuIGdldEFuZHJvaWRTeXN0ZW1Qcm9wZXJ0eSgicm8uYnVpbGQudmVyc2lvbi5jb2RlbmFtZSIpOwogIH0KICBmdW5jdGlvbiBfZ2V0QW5kcm9pZEFwaUxldmVsKCkgewogICAgcmV0dXJuIHBhcnNlSW50KGdldEFuZHJvaWRTeXN0ZW1Qcm9wZXJ0eSgicm8uYnVpbGQudmVyc2lvbi5zZGsiKSwgMTApOwogIH0KICB2YXIgc3lzdGVtUHJvcGVydHlHZXQgPSBudWxsOwogIHZhciBQUk9QX1ZBTFVFX01BWCA9IDkyOwogIGZ1bmN0aW9uIGdldEFuZHJvaWRTeXN0ZW1Qcm9wZXJ0eShuYW1lKSB7CiAgICBpZiAoc3lzdGVtUHJvcGVydHlHZXQgPT09IG51bGwpIHsKICAgICAgc3lzdGVtUHJvcGVydHlHZXQgPSBuZXcgTmF0aXZlRnVuY3Rpb24oCiAgICAgICAgUHJvY2Vzcy5nZXRNb2R1bGVCeU5hbWUoImxpYmMuc28iKS5nZXRFeHBvcnRCeU5hbWUoIl9fc3lzdGVtX3Byb3BlcnR5X2dldCIpLAogICAgICAgICJpbnQiLAogICAgICAgIFsicG9pbnRlciIsICJwb2ludGVyIl0sCiAgICAgICAgbmF0aXZlRnVuY3Rpb25PcHRpb25zMwogICAgICApOwogICAgfQogICAgY29uc3QgYnVmID0gTWVtb3J5LmFsbG9jKFBST1BfVkFMVUVfTUFYKTsKICAgIHN5c3RlbVByb3BlcnR5R2V0KE1lbW9yeS5hbGxvY1V0ZjhTdHJpbmcobmFtZSksIGJ1Zik7CiAgICByZXR1cm4gYnVmLnJlYWRVdGY4U3RyaW5nKCk7CiAgfQogIGZ1bmN0aW9uIHdpdGhSdW5uYWJsZUFydFRocmVhZCh2bTMsIGVudiwgZm4pIHsKICAgIGNvbnN0IHBlcmZvcm0gPSBnZXRBcnRUaHJlYWRTdGF0ZVRyYW5zaXRpb25JbXBsKHZtMywgZW52KTsKICAgIGNvbnN0IGlkID0gZ2V0QXJ0VGhyZWFkRnJvbUVudihlbnYpLnRvU3RyaW5nKCk7CiAgICBhcnRUaHJlYWRTdGF0ZVRyYW5zaXRpb25zW2lkXSA9IGZuOwogICAgcGVyZm9ybShlbnYuaGFuZGxlKTsKICAgIGlmIChhcnRUaHJlYWRTdGF0ZVRyYW5zaXRpb25zW2lkXSAhPT0gdm9pZCAwKSB7CiAgICAgIGRlbGV0ZSBhcnRUaHJlYWRTdGF0ZVRyYW5zaXRpb25zW2lkXTsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gcGVyZm9ybSBzdGF0ZSB0cmFuc2l0aW9uOyBwbGVhc2UgZmlsZSBhIGJ1ZyIpOwogICAgfQogIH0KICBmdW5jdGlvbiBfZ2V0QXJ0VGhyZWFkU3RhdGVUcmFuc2l0aW9uSW1wbCh2bTMsIGVudikgewogICAgY29uc3QgY2FsbGJhY2sgPSBuZXcgTmF0aXZlQ2FsbGJhY2sob25UaHJlYWRTdGF0ZVRyYW5zaXRpb25Db21wbGV0ZSwgInZvaWQiLCBbInBvaW50ZXIiXSk7CiAgICByZXR1cm4gbWFrZUFydFRocmVhZFN0YXRlVHJhbnNpdGlvbkltcGwodm0zLCBlbnYsIGNhbGxiYWNrKTsKICB9CiAgZnVuY3Rpb24gb25UaHJlYWRTdGF0ZVRyYW5zaXRpb25Db21wbGV0ZSh0aHJlYWQpIHsKICAgIGNvbnN0IGlkID0gdGhyZWFkLnRvU3RyaW5nKCk7CiAgICBjb25zdCBmbiA9IGFydFRocmVhZFN0YXRlVHJhbnNpdGlvbnNbaWRdOwogICAgZGVsZXRlIGFydFRocmVhZFN0YXRlVHJhbnNpdGlvbnNbaWRdOwogICAgZm4odGhyZWFkKTsKICB9CiAgZnVuY3Rpb24gd2l0aEFsbEFydFRocmVhZHNTdXNwZW5kZWQoZm4pIHsKICAgIGNvbnN0IGFwaTIgPSBnZXRBcGkoKTsKICAgIGNvbnN0IHRocmVhZExpc3QgPSBhcGkyLmFydFRocmVhZExpc3Q7CiAgICBjb25zdCBsb25nU3VzcGVuZCA9IGZhbHNlOwogICAgYXBpMlsiYXJ0OjpUaHJlYWRMaXN0OjpTdXNwZW5kQWxsIl0odGhyZWFkTGlzdCwgTWVtb3J5LmFsbG9jVXRmOFN0cmluZygiZnJpZGEiKSwgbG9uZ1N1c3BlbmQgPyAxIDogMCk7CiAgICB0cnkgewogICAgICBmbigpOwogICAgfSBmaW5hbGx5IHsKICAgICAgYXBpMlsiYXJ0OjpUaHJlYWRMaXN0OjpSZXN1bWVBbGwiXSh0aHJlYWRMaXN0KTsKICAgIH0KICB9CiAgdmFyIEFydENsYXNzVmlzaXRvciA9IGNsYXNzIHsKICAgIGNvbnN0cnVjdG9yKHZpc2l0KSB7CiAgICAgIGNvbnN0IHZpc2l0b3IgPSBNZW1vcnkuYWxsb2MoNCAqIHBvaW50ZXJTaXplNSk7CiAgICAgIGNvbnN0IHZ0YWJsZTIgPSB2aXNpdG9yLmFkZChwb2ludGVyU2l6ZTUpOwogICAgICB2aXNpdG9yLndyaXRlUG9pbnRlcih2dGFibGUyKTsKICAgICAgY29uc3Qgb25WaXNpdCA9IG5ldyBOYXRpdmVDYWxsYmFjaygoc2VsZiwga2xhc3MpID0+IHsKICAgICAgICByZXR1cm4gdmlzaXQoa2xhc3MpID09PSB0cnVlID8gMSA6IDA7CiAgICAgIH0sICJib29sIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiXSk7CiAgICAgIHZ0YWJsZTIuYWRkKDIgKiBwb2ludGVyU2l6ZTUpLndyaXRlUG9pbnRlcihvblZpc2l0KTsKICAgICAgdGhpcy5oYW5kbGUgPSB2aXNpdG9yOwogICAgICB0aGlzLl9vblZpc2l0ID0gb25WaXNpdDsKICAgIH0KICB9OwogIGZ1bmN0aW9uIG1ha2VBcnRDbGFzc1Zpc2l0b3IodmlzaXQpIHsKICAgIGNvbnN0IGFwaTIgPSBnZXRBcGkoKTsKICAgIGlmIChhcGkyWyJhcnQ6OkNsYXNzTGlua2VyOjpWaXNpdENsYXNzZXMiXSBpbnN0YW5jZW9mIE5hdGl2ZUZ1bmN0aW9uKSB7CiAgICAgIHJldHVybiBuZXcgQXJ0Q2xhc3NWaXNpdG9yKHZpc2l0KTsKICAgIH0KICAgIHJldHVybiBuZXcgTmF0aXZlQ2FsbGJhY2soKGtsYXNzKSA9PiB7CiAgICAgIHJldHVybiB2aXNpdChrbGFzcykgPT09IHRydWUgPyAxIDogMDsKICAgIH0sICJib29sIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiXSk7CiAgfQogIHZhciBBcnRDbGFzc0xvYWRlclZpc2l0b3IgPSBjbGFzcyB7CiAgICBjb25zdHJ1Y3Rvcih2aXNpdCkgewogICAgICBjb25zdCB2aXNpdG9yID0gTWVtb3J5LmFsbG9jKDQgKiBwb2ludGVyU2l6ZTUpOwogICAgICBjb25zdCB2dGFibGUyID0gdmlzaXRvci5hZGQocG9pbnRlclNpemU1KTsKICAgICAgdmlzaXRvci53cml0ZVBvaW50ZXIodnRhYmxlMik7CiAgICAgIGNvbnN0IG9uVmlzaXQgPSBuZXcgTmF0aXZlQ2FsbGJhY2soKHNlbGYsIGtsYXNzKSA9PiB7CiAgICAgICAgdmlzaXQoa2xhc3MpOwogICAgICB9LCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIl0pOwogICAgICB2dGFibGUyLmFkZCgyICogcG9pbnRlclNpemU1KS53cml0ZVBvaW50ZXIob25WaXNpdCk7CiAgICAgIHRoaXMuaGFuZGxlID0gdmlzaXRvcjsKICAgICAgdGhpcy5fb25WaXNpdCA9IG9uVmlzaXQ7CiAgICB9CiAgfTsKICBmdW5jdGlvbiBtYWtlQXJ0Q2xhc3NMb2FkZXJWaXNpdG9yKHZpc2l0KSB7CiAgICByZXR1cm4gbmV3IEFydENsYXNzTG9hZGVyVmlzaXRvcih2aXNpdCk7CiAgfQogIHZhciBXYWxrS2luZCA9IHsKICAgICJpbmNsdWRlLWlubGluZWQtZnJhbWVzIjogMCwKICAgICJza2lwLWlubGluZWQtZnJhbWVzIjogMQogIH07CiAgdmFyIEFydFN0YWNrVmlzaXRvciA9IGNsYXNzIHsKICAgIGNvbnN0cnVjdG9yKHRocmVhZCwgY29udGV4dCwgd2Fsa0tpbmQsIG51bUZyYW1lcyA9IDAsIGNoZWNrU3VzcGVuZGVkID0gdHJ1ZSkgewogICAgICBjb25zdCBhcGkyID0gZ2V0QXBpKCk7CiAgICAgIGNvbnN0IGJhc2VTaXplID0gNTEyOwogICAgICBjb25zdCB2dGFibGVTaXplID0gMyAqIHBvaW50ZXJTaXplNTsKICAgICAgY29uc3QgdmlzaXRvciA9IE1lbW9yeS5hbGxvYyhiYXNlU2l6ZSArIHZ0YWJsZVNpemUpOwogICAgICBhcGkyWyJhcnQ6OlN0YWNrVmlzaXRvcjo6U3RhY2tWaXNpdG9yIl0oCiAgICAgICAgdmlzaXRvciwKICAgICAgICB0aHJlYWQsCiAgICAgICAgY29udGV4dCwKICAgICAgICBXYWxrS2luZFt3YWxrS2luZF0sCiAgICAgICAgbnVtRnJhbWVzLAogICAgICAgIGNoZWNrU3VzcGVuZGVkID8gMSA6IDAKICAgICAgKTsKICAgICAgY29uc3QgdnRhYmxlMiA9IHZpc2l0b3IuYWRkKGJhc2VTaXplKTsKICAgICAgdmlzaXRvci53cml0ZVBvaW50ZXIodnRhYmxlMik7CiAgICAgIGNvbnN0IG9uVmlzaXRGcmFtZSA9IG5ldyBOYXRpdmVDYWxsYmFjayh0aGlzLl92aXNpdEZyYW1lLmJpbmQodGhpcyksICJib29sIiwgWyJwb2ludGVyIl0pOwogICAgICB2dGFibGUyLmFkZCgyICogcG9pbnRlclNpemU1KS53cml0ZVBvaW50ZXIob25WaXNpdEZyYW1lKTsKICAgICAgdGhpcy5oYW5kbGUgPSB2aXNpdG9yOwogICAgICB0aGlzLl9vblZpc2l0RnJhbWUgPSBvblZpc2l0RnJhbWU7CiAgICAgIGNvbnN0IGN1clNoYWRvd0ZyYW1lID0gdmlzaXRvci5hZGQocG9pbnRlclNpemU1ID09PSA0ID8gMTIgOiAyNCk7CiAgICAgIHRoaXMuX2N1clNoYWRvd0ZyYW1lID0gY3VyU2hhZG93RnJhbWU7CiAgICAgIHRoaXMuX2N1clF1aWNrRnJhbWUgPSBjdXJTaGFkb3dGcmFtZS5hZGQocG9pbnRlclNpemU1KTsKICAgICAgdGhpcy5fY3VyUXVpY2tGcmFtZVBjID0gY3VyU2hhZG93RnJhbWUuYWRkKDIgKiBwb2ludGVyU2l6ZTUpOwogICAgICB0aGlzLl9jdXJPYXRRdWlja01ldGhvZEhlYWRlciA9IGN1clNoYWRvd0ZyYW1lLmFkZCgzICogcG9pbnRlclNpemU1KTsKICAgICAgdGhpcy5fZ2V0TWV0aG9kSW1wbCA9IGFwaTJbImFydDo6U3RhY2tWaXNpdG9yOjpHZXRNZXRob2QiXTsKICAgICAgdGhpcy5fZGVzY0xvY0ltcGwgPSBhcGkyWyJhcnQ6OlN0YWNrVmlzaXRvcjo6RGVzY3JpYmVMb2NhdGlvbiJdOwogICAgICB0aGlzLl9nZXRDUUZJSW1wbCA9IGFwaTJbImFydDo6U3RhY2tWaXNpdG9yOjpHZXRDdXJyZW50UXVpY2tGcmFtZUluZm8iXTsKICAgIH0KICAgIHdhbGtTdGFjayhpbmNsdWRlVHJhbnNpdGlvbnMgPSBmYWxzZSkgewogICAgICBnZXRBcGkoKVsiYXJ0OjpTdGFja1Zpc2l0b3I6OldhbGtTdGFjayJdKHRoaXMuaGFuZGxlLCBpbmNsdWRlVHJhbnNpdGlvbnMgPyAxIDogMCk7CiAgICB9CiAgICBfdmlzaXRGcmFtZSgpIHsKICAgICAgcmV0dXJuIHRoaXMudmlzaXRGcmFtZSgpID8gMSA6IDA7CiAgICB9CiAgICB2aXNpdEZyYW1lKCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlN1YmNsYXNzIG11c3QgaW1wbGVtZW50IHZpc2l0RnJhbWUiKTsKICAgIH0KICAgIGdldE1ldGhvZCgpIHsKICAgICAgY29uc3QgbWV0aG9kSGFuZGxlID0gdGhpcy5fZ2V0TWV0aG9kSW1wbCh0aGlzLmhhbmRsZSk7CiAgICAgIGlmIChtZXRob2RIYW5kbGUuaXNOdWxsKCkpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICByZXR1cm4gbmV3IEFydE1ldGhvZChtZXRob2RIYW5kbGUpOwogICAgfQogICAgZ2V0Q3VycmVudFF1aWNrRnJhbWVQYygpIHsKICAgICAgcmV0dXJuIHRoaXMuX2N1clF1aWNrRnJhbWVQYy5yZWFkUG9pbnRlcigpOwogICAgfQogICAgZ2V0Q3VycmVudFF1aWNrRnJhbWUoKSB7CiAgICAgIHJldHVybiB0aGlzLl9jdXJRdWlja0ZyYW1lLnJlYWRQb2ludGVyKCk7CiAgICB9CiAgICBnZXRDdXJyZW50U2hhZG93RnJhbWUoKSB7CiAgICAgIHJldHVybiB0aGlzLl9jdXJTaGFkb3dGcmFtZS5yZWFkUG9pbnRlcigpOwogICAgfQogICAgZGVzY3JpYmVMb2NhdGlvbigpIHsKICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IFN0ZFN0cmluZygpOwogICAgICB0aGlzLl9kZXNjTG9jSW1wbChyZXN1bHQsIHRoaXMuaGFuZGxlKTsKICAgICAgcmV0dXJuIHJlc3VsdC5kaXNwb3NlVG9TdHJpbmcoKTsKICAgIH0KICAgIGdldEN1cnJlbnRPYXRRdWlja01ldGhvZEhlYWRlcigpIHsKICAgICAgcmV0dXJuIHRoaXMuX2N1ck9hdFF1aWNrTWV0aG9kSGVhZGVyLnJlYWRQb2ludGVyKCk7CiAgICB9CiAgICBnZXRDdXJyZW50UXVpY2tGcmFtZUluZm8oKSB7CiAgICAgIHJldHVybiB0aGlzLl9nZXRDUUZJSW1wbCh0aGlzLmhhbmRsZSk7CiAgICB9CiAgfTsKICB2YXIgQXJ0TWV0aG9kID0gY2xhc3MgewogICAgY29uc3RydWN0b3IoaGFuZGxlKSB7CiAgICAgIHRoaXMuaGFuZGxlID0gaGFuZGxlOwogICAgfQogICAgcHJldHR5TWV0aG9kKHdpdGhTaWduYXR1cmUgPSB0cnVlKSB7CiAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBTdGRTdHJpbmcoKTsKICAgICAgZ2V0QXBpKClbImFydDo6QXJ0TWV0aG9kOjpQcmV0dHlNZXRob2QiXShyZXN1bHQsIHRoaXMuaGFuZGxlLCB3aXRoU2lnbmF0dXJlID8gMSA6IDApOwogICAgICByZXR1cm4gcmVzdWx0LmRpc3Bvc2VUb1N0cmluZygpOwogICAgfQogICAgdG9TdHJpbmcoKSB7CiAgICAgIHJldHVybiBgQXJ0TWV0aG9kKGhhbmRsZT0ke3RoaXMuaGFuZGxlfSlgOwogICAgfQogIH07CiAgZnVuY3Rpb24gbWFrZUFydFF1aWNrRnJhbWVJbmZvR2V0dGVyKGltcGwpIHsKICAgIHJldHVybiBmdW5jdGlvbihzZWxmKSB7CiAgICAgIGNvbnN0IHJlc3VsdCA9IE1lbW9yeS5hbGxvYygxMik7CiAgICAgIGdldEFydFF1aWNrRnJhbWVJbmZvR2V0dGVyVGh1bmsoaW1wbCkocmVzdWx0LCBzZWxmKTsKICAgICAgcmV0dXJuIHsKICAgICAgICBmcmFtZVNpemVJbkJ5dGVzOiByZXN1bHQucmVhZFUzMigpLAogICAgICAgIGNvcmVTcGlsbE1hc2s6IHJlc3VsdC5hZGQoNCkucmVhZFUzMigpLAogICAgICAgIGZwU3BpbGxNYXNrOiByZXN1bHQuYWRkKDgpLnJlYWRVMzIoKQogICAgICB9OwogICAgfTsKICB9CiAgZnVuY3Rpb24gX2dldEFydFF1aWNrRnJhbWVJbmZvR2V0dGVyVGh1bmsoaW1wbCkgewogICAgbGV0IHRodW5rID0gTlVMTDsKICAgIHN3aXRjaCAoUHJvY2Vzcy5hcmNoKSB7CiAgICAgIGNhc2UgImlhMzIiOgogICAgICAgIHRodW5rID0gbWFrZVRodW5rKDMyLCAod3JpdGVyKSA9PiB7CiAgICAgICAgICB3cml0ZXIucHV0TW92UmVnUmVnT2Zmc2V0UHRyKCJlY3giLCAiZXNwIiwgNCk7CiAgICAgICAgICB3cml0ZXIucHV0TW92UmVnUmVnT2Zmc2V0UHRyKCJlZHgiLCAiZXNwIiwgOCk7CiAgICAgICAgICB3cml0ZXIucHV0Q2FsbEFkZHJlc3NXaXRoQXJndW1lbnRzKGltcGwsIFsiZWN4IiwgImVkeCJdKTsKICAgICAgICAgIHdyaXRlci5wdXRNb3ZSZWdSZWcoImVzcCIsICJlYnAiKTsKICAgICAgICAgIHdyaXRlci5wdXRQb3BSZWcoImVicCIpOwogICAgICAgICAgd3JpdGVyLnB1dFJldCgpOwogICAgICAgIH0pOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJ4NjQiOgogICAgICAgIHRodW5rID0gbWFrZVRodW5rKDMyLCAod3JpdGVyKSA9PiB7CiAgICAgICAgICB3cml0ZXIucHV0UHVzaFJlZygicmRpIik7CiAgICAgICAgICB3cml0ZXIucHV0Q2FsbEFkZHJlc3NXaXRoQXJndW1lbnRzKGltcGwsIFsicnNpIl0pOwogICAgICAgICAgd3JpdGVyLnB1dFBvcFJlZygicmRpIik7CiAgICAgICAgICB3cml0ZXIucHV0TW92UmVnUHRyUmVnKCJyZGkiLCAicmF4Iik7CiAgICAgICAgICB3cml0ZXIucHV0TW92UmVnT2Zmc2V0UHRyUmVnKCJyZGkiLCA4LCAiZWR4Iik7CiAgICAgICAgICB3cml0ZXIucHV0UmV0KCk7CiAgICAgICAgfSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgImFybSI6CiAgICAgICAgdGh1bmsgPSBtYWtlVGh1bmsoMTYsICh3cml0ZXIpID0+IHsKICAgICAgICAgIHdyaXRlci5wdXRDYWxsQWRkcmVzc1dpdGhBcmd1bWVudHMoaW1wbCwgWyJyMCIsICJyMSJdKTsKICAgICAgICAgIHdyaXRlci5wdXRQb3BSZWdzKFsicjAiLCAibHIiXSk7CiAgICAgICAgICB3cml0ZXIucHV0TW92UmVnUmVnKCJwYyIsICJsciIpOwogICAgICAgIH0pOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJhcm02NCI6CiAgICAgICAgdGh1bmsgPSBtYWtlVGh1bmsoNjQsICh3cml0ZXIpID0+IHsKICAgICAgICAgIHdyaXRlci5wdXRQdXNoUmVnUmVnKCJ4MCIsICJsciIpOwogICAgICAgICAgd3JpdGVyLnB1dENhbGxBZGRyZXNzV2l0aEFyZ3VtZW50cyhpbXBsLCBbIngxIl0pOwogICAgICAgICAgd3JpdGVyLnB1dFBvcFJlZ1JlZygieDIiLCAibHIiKTsKICAgICAgICAgIHdyaXRlci5wdXRTdHJSZWdSZWdPZmZzZXQoIngwIiwgIngyIiwgMCk7CiAgICAgICAgICB3cml0ZXIucHV0U3RyUmVnUmVnT2Zmc2V0KCJ3MSIsICJ4MiIsIDgpOwogICAgICAgICAgd3JpdGVyLnB1dFJldCgpOwogICAgICAgIH0pOwogICAgICAgIGJyZWFrOwogICAgfQogICAgcmV0dXJuIG5ldyBOYXRpdmVGdW5jdGlvbih0aHVuaywgInZvaWQiLCBbInBvaW50ZXIiLCAicG9pbnRlciJdLCBuYXRpdmVGdW5jdGlvbk9wdGlvbnMzKTsKICB9CiAgdmFyIHRodW5rUmVsb2NhdG9ycyA9IHsKICAgIGlhMzI6IGdsb2JhbFRoaXMuWDg2UmVsb2NhdG9yLAogICAgeDY0OiBnbG9iYWxUaGlzLlg4NlJlbG9jYXRvciwKICAgIGFybTogZ2xvYmFsVGhpcy5UaHVtYlJlbG9jYXRvciwKICAgIGFybTY0OiBnbG9iYWxUaGlzLkFybTY0UmVsb2NhdG9yCiAgfTsKICB2YXIgdGh1bmtXcml0ZXJzID0gewogICAgaWEzMjogZ2xvYmFsVGhpcy5YODZXcml0ZXIsCiAgICB4NjQ6IGdsb2JhbFRoaXMuWDg2V3JpdGVyLAogICAgYXJtOiBnbG9iYWxUaGlzLlRodW1iV3JpdGVyLAogICAgYXJtNjQ6IGdsb2JhbFRoaXMuQXJtNjRXcml0ZXIKICB9OwogIGZ1bmN0aW9uIG1ha2VUaHVuayhzaXplLCB3cml0ZTMpIHsKICAgIGlmICh0aHVua1BhZ2UgPT09IG51bGwpIHsKICAgICAgdGh1bmtQYWdlID0gTWVtb3J5LmFsbG9jKFByb2Nlc3MucGFnZVNpemUpOwogICAgfQogICAgY29uc3QgdGh1bmsgPSB0aHVua1BhZ2UuYWRkKHRodW5rT2Zmc2V0KTsKICAgIGNvbnN0IGFyY2ggPSBQcm9jZXNzLmFyY2g7CiAgICBjb25zdCBXcml0ZXIgPSB0aHVua1dyaXRlcnNbYXJjaF07CiAgICBNZW1vcnkucGF0Y2hDb2RlKHRodW5rLCBzaXplLCAoY29kZTIpID0+IHsKICAgICAgY29uc3Qgd3JpdGVyID0gbmV3IFdyaXRlcihjb2RlMiwgeyBwYzogdGh1bmsgfSk7CiAgICAgIHdyaXRlMyh3cml0ZXIpOwogICAgICB3cml0ZXIuZmx1c2goKTsKICAgICAgaWYgKHdyaXRlci5vZmZzZXQgPiBzaXplKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBXcm90ZSAke3dyaXRlci5vZmZzZXR9LCBleGNlZWRpbmcgbWF4aW11bSBvZiAke3NpemV9YCk7CiAgICAgIH0KICAgIH0pOwogICAgdGh1bmtPZmZzZXQgKz0gc2l6ZTsKICAgIHJldHVybiBhcmNoID09PSAiYXJtIiA/IHRodW5rLm9yKDEpIDogdGh1bms7CiAgfQogIGZ1bmN0aW9uIG5vdGlmeUFydE1ldGhvZEhvb2tlZChtZXRob2QsIHZtMykgewogICAgZW5zdXJlQXJ0S25vd3NIb3dUb0hhbmRsZU1ldGhvZEluc3RydW1lbnRhdGlvbih2bTMpOwogICAgZW5zdXJlQXJ0S25vd3NIb3dUb0hhbmRsZVJlcGxhY2VtZW50TWV0aG9kcyh2bTMpOwogIH0KICBmdW5jdGlvbiBtYWtlQXJ0Q29udHJvbGxlcihhcGkyLCB2bTMpIHsKICAgIGNvbnN0IHRocmVhZE9mZnNldHMgPSBnZXRBcnRUaHJlYWRTcGVjKHZtMykub2Zmc2V0OwogICAgY29uc3QgbWFuYWdlZFN0YWNrT2Zmc2V0cyA9IGdldEFydE1hbmFnZWRTdGFja1NwZWMoKS5vZmZzZXQ7CiAgICBjb25zdCBjb2RlMiA9IGAKI2luY2x1ZGUgPGd1bS9ndW1pbnRlcmNlcHRvci5oPgoKZXh0ZXJuIEdNdXRleCBsb2NrOwpleHRlcm4gR0hhc2hUYWJsZSAqIG1ldGhvZHM7CmV4dGVybiBHSGFzaFRhYmxlICogcmVwbGFjZW1lbnRzOwpleHRlcm4gZ3BvaW50ZXIgbGFzdF9zZWVuX2FydF9tZXRob2Q7CgpleHRlcm4gZ3BvaW50ZXIgZ2V0X29hdF9xdWlja19tZXRob2RfaGVhZGVyX2ltcGwgKGdwb2ludGVyIG1ldGhvZCwgZ3BvaW50ZXIgcGMpOwoKdm9pZAppbml0ICh2b2lkKQp7CiAgZ19tdXRleF9pbml0ICgmbG9jayk7CiAgbWV0aG9kcyA9IGdfaGFzaF90YWJsZV9uZXdfZnVsbCAoTlVMTCwgTlVMTCwgTlVMTCwgTlVMTCk7CiAgcmVwbGFjZW1lbnRzID0gZ19oYXNoX3RhYmxlX25ld19mdWxsIChOVUxMLCBOVUxMLCBOVUxMLCBOVUxMKTsKfQoKdm9pZApmaW5hbGl6ZSAodm9pZCkKewogIGdfaGFzaF90YWJsZV91bnJlZiAocmVwbGFjZW1lbnRzKTsKICBnX2hhc2hfdGFibGVfdW5yZWYgKG1ldGhvZHMpOwogIGdfbXV0ZXhfY2xlYXIgKCZsb2NrKTsKfQoKZ2Jvb2xlYW4KaXNfcmVwbGFjZW1lbnRfbWV0aG9kIChncG9pbnRlciBtZXRob2QpCnsKICBnYm9vbGVhbiBpc19yZXBsYWNlbWVudDsKCiAgZ19tdXRleF9sb2NrICgmbG9jayk7CgogIGlzX3JlcGxhY2VtZW50ID0gZ19oYXNoX3RhYmxlX2NvbnRhaW5zIChyZXBsYWNlbWVudHMsIG1ldGhvZCk7CgogIGdfbXV0ZXhfdW5sb2NrICgmbG9jayk7CgogIHJldHVybiBpc19yZXBsYWNlbWVudDsKfQoKZ3BvaW50ZXIKZ2V0X3JlcGxhY2VtZW50X21ldGhvZCAoZ3BvaW50ZXIgb3JpZ2luYWxfbWV0aG9kKQp7CiAgZ3BvaW50ZXIgcmVwbGFjZW1lbnRfbWV0aG9kOwoKICBnX211dGV4X2xvY2sgKCZsb2NrKTsKCiAgcmVwbGFjZW1lbnRfbWV0aG9kID0gZ19oYXNoX3RhYmxlX2xvb2t1cCAobWV0aG9kcywgb3JpZ2luYWxfbWV0aG9kKTsKCiAgZ19tdXRleF91bmxvY2sgKCZsb2NrKTsKCiAgcmV0dXJuIHJlcGxhY2VtZW50X21ldGhvZDsKfQoKdm9pZApzZXRfcmVwbGFjZW1lbnRfbWV0aG9kIChncG9pbnRlciBvcmlnaW5hbF9tZXRob2QsCiAgICAgICAgICAgICAgICAgICAgICAgIGdwb2ludGVyIHJlcGxhY2VtZW50X21ldGhvZCkKewogIGdfbXV0ZXhfbG9jayAoJmxvY2spOwoKICBnX2hhc2hfdGFibGVfaW5zZXJ0IChtZXRob2RzLCBvcmlnaW5hbF9tZXRob2QsIHJlcGxhY2VtZW50X21ldGhvZCk7CiAgZ19oYXNoX3RhYmxlX2luc2VydCAocmVwbGFjZW1lbnRzLCByZXBsYWNlbWVudF9tZXRob2QsIG9yaWdpbmFsX21ldGhvZCk7CgogIGdfbXV0ZXhfdW5sb2NrICgmbG9jayk7Cn0KCnZvaWQKZGVsZXRlX3JlcGxhY2VtZW50X21ldGhvZCAoZ3BvaW50ZXIgb3JpZ2luYWxfbWV0aG9kKQp7CiAgZ3BvaW50ZXIgcmVwbGFjZW1lbnRfbWV0aG9kOwoKICBnX211dGV4X2xvY2sgKCZsb2NrKTsKCiAgcmVwbGFjZW1lbnRfbWV0aG9kID0gZ19oYXNoX3RhYmxlX2xvb2t1cCAobWV0aG9kcywgb3JpZ2luYWxfbWV0aG9kKTsKICBpZiAocmVwbGFjZW1lbnRfbWV0aG9kICE9IE5VTEwpCiAgewogICAgZ19oYXNoX3RhYmxlX3JlbW92ZSAobWV0aG9kcywgb3JpZ2luYWxfbWV0aG9kKTsKICAgIGdfaGFzaF90YWJsZV9yZW1vdmUgKHJlcGxhY2VtZW50cywgcmVwbGFjZW1lbnRfbWV0aG9kKTsKICB9CgogIGdfbXV0ZXhfdW5sb2NrICgmbG9jayk7Cn0KCmdwb2ludGVyCnRyYW5zbGF0ZV9tZXRob2QgKGdwb2ludGVyIG1ldGhvZCkKewogIGdwb2ludGVyIHRyYW5zbGF0ZWRfbWV0aG9kOwoKICBnX211dGV4X2xvY2sgKCZsb2NrKTsKCiAgdHJhbnNsYXRlZF9tZXRob2QgPSBnX2hhc2hfdGFibGVfbG9va3VwIChyZXBsYWNlbWVudHMsIG1ldGhvZCk7CgogIGdfbXV0ZXhfdW5sb2NrICgmbG9jayk7CgogIHJldHVybiAodHJhbnNsYXRlZF9tZXRob2QgIT0gTlVMTCkgPyB0cmFuc2xhdGVkX21ldGhvZCA6IG1ldGhvZDsKfQoKZ3BvaW50ZXIKZmluZF9yZXBsYWNlbWVudF9tZXRob2RfZnJvbV9xdWlja19jb2RlIChncG9pbnRlciBtZXRob2QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3BvaW50ZXIgdGhyZWFkKQp7CiAgZ3BvaW50ZXIgcmVwbGFjZW1lbnRfbWV0aG9kOwogIGdwb2ludGVyIG1hbmFnZWRfc3RhY2s7CiAgZ3BvaW50ZXIgdG9wX3F1aWNrX2ZyYW1lOwogIGdwb2ludGVyIGxpbmtfbWFuYWdlZF9zdGFjazsKICBncG9pbnRlciAqIGxpbmtfdG9wX3F1aWNrX2ZyYW1lOwoKICByZXBsYWNlbWVudF9tZXRob2QgPSBnZXRfcmVwbGFjZW1lbnRfbWV0aG9kIChtZXRob2QpOwogIGlmIChyZXBsYWNlbWVudF9tZXRob2QgPT0gTlVMTCkKICAgIHJldHVybiBOVUxMOwoKICAvKgogICAqIFN0YWNrIGNoZWNrLgogICAqCiAgICogUmV0dXJuIE5VTEwgdG8gaW5kaWNhdGUgdGhhdCB0aGUgb3JpZ2luYWwgbWV0aG9kIHNob3VsZCBiZSBpbnZva2VkLCBvdGhlcndpc2UKICAgKiByZXR1cm4gYSBwb2ludGVyIHRvIHRoZSByZXBsYWNlbWVudCBBcnRNZXRob2QuCiAgICoKICAgKiBJZiB0aGUgY2FsbGVyIGlzIG91ciBvd24gSk5JIHJlcGxhY2VtZW50IHN0dWIsIHRoZW4gYSBzdGFjayB0cmFuc2l0aW9uIG11c3QKICAgKiBoYXZlIGJlZW4gcHVzaGVkIG9udG8gdGhlIGN1cnJlbnQgdGhyZWFkJ3MgbGlua2VkIGxpc3QuCiAgICoKICAgKiBUaGVyZWZvcmUsIHdlIGludm9rZSB0aGUgb3JpZ2luYWwgbWV0aG9kIGlmIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OgogICAqICAgMS0gVGhlIGN1cnJlbnQgbWFuYWdlZCBzdGFjayBpcyBlbXB0eS4KICAgKiAgIDItIFRoZSBBcnRNZXRob2QgKiBpbnNpZGUgdGhlIGxpbmtlZCBtYW5hZ2VkIHN0YWNrJ3MgdG9wIHF1aWNrIGZyYW1lIGlzIHRoZQogICAqICAgICAgc2FtZSBhcyBvdXIgcmVwbGFjZW1lbnQuCiAgICovCiAgbWFuYWdlZF9zdGFjayA9IHRocmVhZCArICR7dGhyZWFkT2Zmc2V0cy5tYW5hZ2VkU3RhY2t9OwogIHRvcF9xdWlja19mcmFtZSA9ICooKGdwb2ludGVyICopIChtYW5hZ2VkX3N0YWNrICsgJHttYW5hZ2VkU3RhY2tPZmZzZXRzLnRvcFF1aWNrRnJhbWV9KSk7CiAgaWYgKHRvcF9xdWlja19mcmFtZSAhPSBOVUxMKQogICAgcmV0dXJuIHJlcGxhY2VtZW50X21ldGhvZDsKCiAgbGlua19tYW5hZ2VkX3N0YWNrID0gKigoZ3BvaW50ZXIgKikgKG1hbmFnZWRfc3RhY2sgKyAke21hbmFnZWRTdGFja09mZnNldHMubGlua30pKTsKICBpZiAobGlua19tYW5hZ2VkX3N0YWNrID09IE5VTEwpCiAgICByZXR1cm4gcmVwbGFjZW1lbnRfbWV0aG9kOwoKICBsaW5rX3RvcF9xdWlja19mcmFtZSA9IEdTSVpFX1RPX1BPSU5URVIgKCooKGdzaXplICopIChsaW5rX21hbmFnZWRfc3RhY2sgKyAke21hbmFnZWRTdGFja09mZnNldHMudG9wUXVpY2tGcmFtZX0pKSAmIH4oKGdzaXplKSAxKSk7CiAgaWYgKGxpbmtfdG9wX3F1aWNrX2ZyYW1lID09IE5VTEwgfHwgKmxpbmtfdG9wX3F1aWNrX2ZyYW1lICE9IHJlcGxhY2VtZW50X21ldGhvZCkKICAgIHJldHVybiByZXBsYWNlbWVudF9tZXRob2Q7CgogIHJldHVybiBOVUxMOwp9Cgp2b2lkCm9uX2ludGVycHJldGVyX2RvX2NhbGwgKEd1bUludm9jYXRpb25Db250ZXh0ICogaWMpCnsKICBncG9pbnRlciBtZXRob2QsIHJlcGxhY2VtZW50X21ldGhvZDsKCiAgbWV0aG9kID0gZ3VtX2ludm9jYXRpb25fY29udGV4dF9nZXRfbnRoX2FyZ3VtZW50IChpYywgMCk7CgogIHJlcGxhY2VtZW50X21ldGhvZCA9IGdldF9yZXBsYWNlbWVudF9tZXRob2QgKG1ldGhvZCk7CiAgaWYgKHJlcGxhY2VtZW50X21ldGhvZCAhPSBOVUxMKQogICAgZ3VtX2ludm9jYXRpb25fY29udGV4dF9yZXBsYWNlX250aF9hcmd1bWVudCAoaWMsIDAsIHJlcGxhY2VtZW50X21ldGhvZCk7Cn0KCmdwb2ludGVyCm9uX2FydF9tZXRob2RfZ2V0X29hdF9xdWlja19tZXRob2RfaGVhZGVyIChncG9pbnRlciBtZXRob2QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncG9pbnRlciBwYykKewogIGlmIChpc19yZXBsYWNlbWVudF9tZXRob2QgKG1ldGhvZCkpCiAgICByZXR1cm4gTlVMTDsKCiAgcmV0dXJuIGdldF9vYXRfcXVpY2tfbWV0aG9kX2hlYWRlcl9pbXBsIChtZXRob2QsIHBjKTsKfQoKdm9pZApvbl9hcnRfbWV0aG9kX3ByZXR0eV9tZXRob2QgKEd1bUludm9jYXRpb25Db250ZXh0ICogaWMpCnsKICBjb25zdCBndWludCB0aGlzX2FyZ19pbmRleCA9ICR7UHJvY2Vzcy5hcmNoID09PSAiYXJtNjQiID8gMCA6IDF9OwogIGdwb2ludGVyIG1ldGhvZDsKCiAgbWV0aG9kID0gZ3VtX2ludm9jYXRpb25fY29udGV4dF9nZXRfbnRoX2FyZ3VtZW50IChpYywgdGhpc19hcmdfaW5kZXgpOwogIGlmIChtZXRob2QgPT0gTlVMTCkKICAgIGd1bV9pbnZvY2F0aW9uX2NvbnRleHRfcmVwbGFjZV9udGhfYXJndW1lbnQgKGljLCB0aGlzX2FyZ19pbmRleCwgbGFzdF9zZWVuX2FydF9tZXRob2QpOwogIGVsc2UKICAgIGxhc3Rfc2Vlbl9hcnRfbWV0aG9kID0gbWV0aG9kOwp9Cgp2b2lkCm9uX2xlYXZlX2djX2NvbmN1cnJlbnRfY29weWluZ19jb3B5aW5nX3BoYXNlIChHdW1JbnZvY2F0aW9uQ29udGV4dCAqIGljKQp7CiAgR0hhc2hUYWJsZUl0ZXIgaXRlcjsKICBncG9pbnRlciBob29rZWRfbWV0aG9kLCByZXBsYWNlbWVudF9tZXRob2Q7CgogIGdfbXV0ZXhfbG9jayAoJmxvY2spOwoKICBnX2hhc2hfdGFibGVfaXRlcl9pbml0ICgmaXRlciwgbWV0aG9kcyk7CiAgd2hpbGUgKGdfaGFzaF90YWJsZV9pdGVyX25leHQgKCZpdGVyLCAmaG9va2VkX21ldGhvZCwgJnJlcGxhY2VtZW50X21ldGhvZCkpCiAgICAqKCh1aW50MzJfdCAqKSByZXBsYWNlbWVudF9tZXRob2QpID0gKigodWludDMyX3QgKikgaG9va2VkX21ldGhvZCk7CgogIGdfbXV0ZXhfdW5sb2NrICgmbG9jayk7Cn0KYDsKICAgIGNvbnN0IGxvY2tTaXplID0gODsKICAgIGNvbnN0IG1ldGhvZHNTaXplID0gcG9pbnRlclNpemU1OwogICAgY29uc3QgcmVwbGFjZW1lbnRzU2l6ZSA9IHBvaW50ZXJTaXplNTsKICAgIGNvbnN0IGxhc3RTZWVuQXJ0TWV0aG9kU2l6ZSA9IHBvaW50ZXJTaXplNTsKICAgIGNvbnN0IGRhdGEgPSBNZW1vcnkuYWxsb2MobG9ja1NpemUgKyBtZXRob2RzU2l6ZSArIHJlcGxhY2VtZW50c1NpemUgKyBsYXN0U2VlbkFydE1ldGhvZFNpemUpOwogICAgY29uc3QgbG9jayA9IGRhdGE7CiAgICBjb25zdCBtZXRob2RzID0gbG9jay5hZGQobG9ja1NpemUpOwogICAgY29uc3QgcmVwbGFjZW1lbnRzID0gbWV0aG9kcy5hZGQobWV0aG9kc1NpemUpOwogICAgY29uc3QgbGFzdFNlZW5BcnRNZXRob2QgPSByZXBsYWNlbWVudHMuYWRkKHJlcGxhY2VtZW50c1NpemUpOwogICAgY29uc3QgZ2V0T2F0UXVpY2tNZXRob2RIZWFkZXJJbXBsID0gYXBpMi5maW5kKHBvaW50ZXJTaXplNSA9PT0gNCA/ICJfWk4zYXJ0OUFydE1ldGhvZDIzR2V0T2F0UXVpY2tNZXRob2RIZWFkZXJFaiIgOiAiX1pOM2FydDlBcnRNZXRob2QyM0dldE9hdFF1aWNrTWV0aG9kSGVhZGVyRW0iKTsKICAgIGNvbnN0IGNtMiA9IG5ldyBDTW9kdWxlKGNvZGUyLCB7CiAgICAgIGxvY2ssCiAgICAgIG1ldGhvZHMsCiAgICAgIHJlcGxhY2VtZW50cywKICAgICAgbGFzdF9zZWVuX2FydF9tZXRob2Q6IGxhc3RTZWVuQXJ0TWV0aG9kLAogICAgICBnZXRfb2F0X3F1aWNrX21ldGhvZF9oZWFkZXJfaW1wbDogZ2V0T2F0UXVpY2tNZXRob2RIZWFkZXJJbXBsID8/IHB0cigiMHhkZWFkYmVlZiIpCiAgICB9KTsKICAgIGNvbnN0IGZhc3RPcHRpb25zID0geyBleGNlcHRpb25zOiAicHJvcGFnYXRlIiwgc2NoZWR1bGluZzogImV4Y2x1c2l2ZSIgfTsKICAgIHJldHVybiB7CiAgICAgIGhhbmRsZTogY20yLAogICAgICByZXBsYWNlZE1ldGhvZHM6IHsKICAgICAgICBpc1JlcGxhY2VtZW50OiBuZXcgTmF0aXZlRnVuY3Rpb24oY20yLmlzX3JlcGxhY2VtZW50X21ldGhvZCwgImJvb2wiLCBbInBvaW50ZXIiXSwgZmFzdE9wdGlvbnMpLAogICAgICAgIGdldDogbmV3IE5hdGl2ZUZ1bmN0aW9uKGNtMi5nZXRfcmVwbGFjZW1lbnRfbWV0aG9kLCAicG9pbnRlciIsIFsicG9pbnRlciJdLCBmYXN0T3B0aW9ucyksCiAgICAgICAgc2V0OiBuZXcgTmF0aXZlRnVuY3Rpb24oY20yLnNldF9yZXBsYWNlbWVudF9tZXRob2QsICJ2b2lkIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiXSwgZmFzdE9wdGlvbnMpLAogICAgICAgIGRlbGV0ZTogbmV3IE5hdGl2ZUZ1bmN0aW9uKGNtMi5kZWxldGVfcmVwbGFjZW1lbnRfbWV0aG9kLCAidm9pZCIsIFsicG9pbnRlciJdLCBmYXN0T3B0aW9ucyksCiAgICAgICAgdHJhbnNsYXRlOiBuZXcgTmF0aXZlRnVuY3Rpb24oY20yLnRyYW5zbGF0ZV9tZXRob2QsICJwb2ludGVyIiwgWyJwb2ludGVyIl0sIGZhc3RPcHRpb25zKSwKICAgICAgICBmaW5kUmVwbGFjZW1lbnRGcm9tUXVpY2tDb2RlOiBjbTIuZmluZF9yZXBsYWNlbWVudF9tZXRob2RfZnJvbV9xdWlja19jb2RlCiAgICAgIH0sCiAgICAgIGdldE9hdFF1aWNrTWV0aG9kSGVhZGVySW1wbCwKICAgICAgaG9va3M6IHsKICAgICAgICBJbnRlcnByZXRlcjogewogICAgICAgICAgZG9DYWxsOiBjbTIub25faW50ZXJwcmV0ZXJfZG9fY2FsbAogICAgICAgIH0sCiAgICAgICAgQXJ0TWV0aG9kOiB7CiAgICAgICAgICBnZXRPYXRRdWlja01ldGhvZEhlYWRlcjogY20yLm9uX2FydF9tZXRob2RfZ2V0X29hdF9xdWlja19tZXRob2RfaGVhZGVyLAogICAgICAgICAgcHJldHR5TWV0aG9kOiBjbTIub25fYXJ0X21ldGhvZF9wcmV0dHlfbWV0aG9kCiAgICAgICAgfSwKICAgICAgICBHYzogewogICAgICAgICAgY29weWluZ1BoYXNlOiB7CiAgICAgICAgICAgIG9uTGVhdmU6IGNtMi5vbl9sZWF2ZV9nY19jb25jdXJyZW50X2NvcHlpbmdfY29weWluZ19waGFzZQogICAgICAgICAgfSwKICAgICAgICAgIHJ1bkZsaXA6IHsKICAgICAgICAgICAgb25FbnRlcjogY20yLm9uX2xlYXZlX2djX2NvbmN1cnJlbnRfY29weWluZ19jb3B5aW5nX3BoYXNlCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH0KICBmdW5jdGlvbiBlbnN1cmVBcnRLbm93c0hvd1RvSGFuZGxlTWV0aG9kSW5zdHJ1bWVudGF0aW9uKHZtMykgewogICAgaWYgKHRhdWdodEFydEFib3V0TWV0aG9kSW5zdHJ1bWVudGF0aW9uKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRhdWdodEFydEFib3V0TWV0aG9kSW5zdHJ1bWVudGF0aW9uID0gdHJ1ZTsKICAgIGluc3RydW1lbnRBcnRRdWlja0VudHJ5cG9pbnRzKHZtMyk7CiAgICBpbnN0cnVtZW50QXJ0TWV0aG9kSW52b2NhdGlvbkZyb21JbnRlcnByZXRlcigpOwogIH0KICBmdW5jdGlvbiBpbnN0cnVtZW50QXJ0UXVpY2tFbnRyeXBvaW50cyh2bTMpIHsKICAgIGNvbnN0IGFwaTIgPSBnZXRBcGkoKTsKICAgIGNvbnN0IHF1aWNrRW50cnlwb2ludHMgPSBbCiAgICAgIGFwaTIuYXJ0UXVpY2tHZW5lcmljSm5pVHJhbXBvbGluZSwKICAgICAgYXBpMi5hcnRRdWlja1RvSW50ZXJwcmV0ZXJCcmlkZ2UsCiAgICAgIGFwaTIuYXJ0UXVpY2tSZXNvbHV0aW9uVHJhbXBvbGluZQogICAgXTsKICAgIHF1aWNrRW50cnlwb2ludHMuZm9yRWFjaCgoZW50cnlwb2ludCkgPT4gewogICAgICBNZW1vcnkucHJvdGVjdChlbnRyeXBvaW50LCAzMiwgInJ3eCIpOwogICAgICBjb25zdCBpbnRlcmNlcHRvciA9IG5ldyBBcnRRdWlja0NvZGVJbnRlcmNlcHRvcihlbnRyeXBvaW50KTsKICAgICAgaW50ZXJjZXB0b3IuYWN0aXZhdGUodm0zKTsKICAgICAgYXJ0UXVpY2tJbnRlcmNlcHRvcnMucHVzaChpbnRlcmNlcHRvcik7CiAgICB9KTsKICB9CiAgZnVuY3Rpb24gaW5zdHJ1bWVudEFydE1ldGhvZEludm9jYXRpb25Gcm9tSW50ZXJwcmV0ZXIoKSB7CiAgICBjb25zdCBhcGkyID0gZ2V0QXBpKCk7CiAgICBjb25zdCBhcGlMZXZlbCA9IGdldEFuZHJvaWRBcGlMZXZlbCgpOwogICAgY29uc3QgeyBpc0FwaUxldmVsMzRPckFwZXhFcXVpdmFsZW50IH0gPSBhcGkyOwogICAgbGV0IGFydEludGVycHJldGVyRG9DYWxsRXhwb3J0UmVnZXg7CiAgICBpZiAoYXBpTGV2ZWwgPD0gMjIpIHsKICAgICAgYXJ0SW50ZXJwcmV0ZXJEb0NhbGxFeHBvcnRSZWdleCA9IC9eX1pOM2FydDExaW50ZXJwcmV0ZXI2RG9DYWxsSUxiWzAtMV1FTGJbMC0xXUVFRWJQTlNfNm1pcnJvcjlBcnRNZXRob2RFUE5TXzZUaHJlYWRFUk5TXzExU2hhZG93RnJhbWVFUEtOU18xMUluc3RydWN0aW9uRXRQTlNfNkpWYWx1ZUUkLzsKICAgIH0gZWxzZSBpZiAoYXBpTGV2ZWwgPD0gMzMgJiYgIWlzQXBpTGV2ZWwzNE9yQXBleEVxdWl2YWxlbnQpIHsKICAgICAgYXJ0SW50ZXJwcmV0ZXJEb0NhbGxFeHBvcnRSZWdleCA9IC9eX1pOM2FydDExaW50ZXJwcmV0ZXI2RG9DYWxsSUxiWzAtMV1FTGJbMC0xXUVFRWJQTlNfOUFydE1ldGhvZEVQTlNfNlRocmVhZEVSTlNfMTFTaGFkb3dGcmFtZUVQS05TXzExSW5zdHJ1Y3Rpb25FdFBOU182SlZhbHVlRSQvOwogICAgfSBlbHNlIGlmIChpc0FwaUxldmVsMzRPckFwZXhFcXVpdmFsZW50KSB7CiAgICAgIGFydEludGVycHJldGVyRG9DYWxsRXhwb3J0UmVnZXggPSAvXl9aTjNhcnQxMWludGVycHJldGVyNkRvQ2FsbElMYlswLTFdRUVFYlBOU185QXJ0TWV0aG9kRVBOU182VGhyZWFkRVJOU18xMVNoYWRvd0ZyYW1lRVBLTlNfMTFJbnN0cnVjdGlvbkV0YlBOU182SlZhbHVlRSQvOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBtZXRob2QgaW52b2NhdGlvbiBpbiBBUlQ7IHBsZWFzZSBmaWxlIGEgYnVnIik7CiAgICB9CiAgICBjb25zdCBhcnQgPSBhcGkyLm1vZHVsZTsKICAgIGNvbnN0IGVudHJpZXMgPSBbLi4uYXJ0LmVudW1lcmF0ZUV4cG9ydHMoKSwgLi4uYXJ0LmVudW1lcmF0ZVN5bWJvbHMoKV0uZmlsdGVyKChlbnRyeSkgPT4gYXJ0SW50ZXJwcmV0ZXJEb0NhbGxFeHBvcnRSZWdleC50ZXN0KGVudHJ5Lm5hbWUpKTsKICAgIGlmIChlbnRyaWVzLmxlbmd0aCA9PT0gMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG1ldGhvZCBpbnZvY2F0aW9uIGluIEFSVDsgcGxlYXNlIGZpbGUgYSBidWciKTsKICAgIH0KICAgIGZvciAoY29uc3QgZW50cnkgb2YgZW50cmllcykgewogICAgICBJbnRlcmNlcHRvci5hdHRhY2goZW50cnkuYWRkcmVzcywgYXJ0Q29udHJvbGxlci5ob29rcy5JbnRlcnByZXRlci5kb0NhbGwpOwogICAgfQogIH0KICBmdW5jdGlvbiBlbnN1cmVBcnRLbm93c0hvd1RvSGFuZGxlUmVwbGFjZW1lbnRNZXRob2RzKHZtMykgewogICAgaWYgKHRhdWdodEFydEFib3V0UmVwbGFjZW1lbnRNZXRob2RzKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRhdWdodEFydEFib3V0UmVwbGFjZW1lbnRNZXRob2RzID0gdHJ1ZTsKICAgIGlmICghbWF5YmVJbnN0cnVtZW50R2V0T2F0UXVpY2tNZXRob2RIZWFkZXJJbmxpbmVDb3BpZXMoKSkgewogICAgICBjb25zdCB7IGdldE9hdFF1aWNrTWV0aG9kSGVhZGVySW1wbCB9ID0gYXJ0Q29udHJvbGxlcjsKICAgICAgaWYgKGdldE9hdFF1aWNrTWV0aG9kSGVhZGVySW1wbCA9PT0gbnVsbCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0cnkgewogICAgICAgIEludGVyY2VwdG9yLnJlcGxhY2UoZ2V0T2F0UXVpY2tNZXRob2RIZWFkZXJJbXBsLCBhcnRDb250cm9sbGVyLmhvb2tzLkFydE1ldGhvZC5nZXRPYXRRdWlja01ldGhvZEhlYWRlcik7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgfQogICAgfQogICAgY29uc3QgYXBpTGV2ZWwgPSBnZXRBbmRyb2lkQXBpTGV2ZWwoKTsKICAgIGxldCBjb3B5aW5nUGhhc2UgPSBudWxsOwogICAgY29uc3QgYXBpMiA9IGdldEFwaSgpOwogICAgaWYgKGFwaUxldmVsID4gMjgpIHsKICAgICAgY29weWluZ1BoYXNlID0gYXBpMi5maW5kKCJfWk4zYXJ0MmdjOWNvbGxlY3RvcjE3Q29uY3VycmVudENvcHlpbmcxMkNvcHlpbmdQaGFzZUV2Iik7CiAgICB9IGVsc2UgaWYgKGFwaUxldmVsID4gMjIpIHsKICAgICAgY29weWluZ1BoYXNlID0gYXBpMi5maW5kKCJfWk4zYXJ0MmdjOWNvbGxlY3RvcjE3Q29uY3VycmVudENvcHlpbmcxMk1hcmtpbmdQaGFzZUV2Iik7CiAgICB9CiAgICBpZiAoY29weWluZ1BoYXNlICE9PSBudWxsKSB7CiAgICAgIEludGVyY2VwdG9yLmF0dGFjaChjb3B5aW5nUGhhc2UsIGFydENvbnRyb2xsZXIuaG9va3MuR2MuY29weWluZ1BoYXNlKTsKICAgIH0KICAgIGxldCBydW5GbGlwID0gbnVsbDsKICAgIHJ1bkZsaXAgPSBhcGkyLmZpbmQoIl9aTjNhcnQ2VGhyZWFkMTVSdW5GbGlwRnVuY3Rpb25FUFMwXyIpOwogICAgaWYgKHJ1bkZsaXAgPT09IG51bGwpIHsKICAgICAgcnVuRmxpcCA9IGFwaTIuZmluZCgiX1pOM2FydDZUaHJlYWQxNVJ1bkZsaXBGdW5jdGlvbkVQUzBfYiIpOwogICAgfQogICAgaWYgKHJ1bkZsaXAgIT09IG51bGwpIHsKICAgICAgSW50ZXJjZXB0b3IuYXR0YWNoKHJ1bkZsaXAsIGFydENvbnRyb2xsZXIuaG9va3MuR2MucnVuRmxpcCk7CiAgICB9CiAgfQogIHZhciBhcnRHZXRPYXRRdWlja01ldGhvZEhlYWRlcklubGluZWRDb3B5SGFuZGxlciA9IHsKICAgIGFybTogewogICAgICBzaWduYXR1cmVzOiBbCiAgICAgICAgewogICAgICAgICAgcGF0dGVybjogWwogICAgICAgICAgICAiYjAgNjgiLAogICAgICAgICAgICAvLyBsZHIgcjAsIFtyNiwgIzhdCiAgICAgICAgICAgICIwMSAzMCIsCiAgICAgICAgICAgIC8vIGFkZHMgcjAsICMxCiAgICAgICAgICAgICIwYyBkMCIsCiAgICAgICAgICAgIC8vIGJlcSAjMHgxNmZjZDQKICAgICAgICAgICAgIjFiIDk4IiwKICAgICAgICAgICAgLy8gbGRyIHIwLCBbc3AsICMweDZjXQogICAgICAgICAgICAiOiIsCiAgICAgICAgICAgICJjMCBmZiIsCiAgICAgICAgICAgICJjMCBmZiIsCiAgICAgICAgICAgICIwMCBmZiIsCiAgICAgICAgICAgICIwMCAyZiIKICAgICAgICAgIF0sCiAgICAgICAgICB2YWxpZGF0ZU1hdGNoOiB2YWxpZGF0ZUdldE9hdFF1aWNrTWV0aG9kSGVhZGVySW5saW5lZE1hdGNoQXJtCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICBwYXR0ZXJuOiBbCiAgICAgICAgICAgICJkOCBmOCAwOCAwMCIsCiAgICAgICAgICAgIC8vIGxkciByMCwgW3I4LCAjOF0KICAgICAgICAgICAgIjAxIDMwIiwKICAgICAgICAgICAgLy8gYWRkcyByMCwgIzEKICAgICAgICAgICAgIjBjIGQwIiwKICAgICAgICAgICAgLy8gYmVxICMweDE2ZmNkNAogICAgICAgICAgICAiMWIgOTgiLAogICAgICAgICAgICAvLyBsZHIgcjAsIFtzcCwgIzB4NmNdCiAgICAgICAgICAgICI6IiwKICAgICAgICAgICAgImYwIGZmIGZmIDBmIiwKICAgICAgICAgICAgImZmIGZmIiwKICAgICAgICAgICAgIjAwIGZmIiwKICAgICAgICAgICAgIjAwIDJmIgogICAgICAgICAgXSwKICAgICAgICAgIHZhbGlkYXRlTWF0Y2g6IHZhbGlkYXRlR2V0T2F0UXVpY2tNZXRob2RIZWFkZXJJbmxpbmVkTWF0Y2hBcm0KICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgIHBhdHRlcm46IFsKICAgICAgICAgICAgImIwIDY4IiwKICAgICAgICAgICAgLy8gbGRyIHIwLCBbcjYsICM4XQogICAgICAgICAgICAiMDEgMzAiLAogICAgICAgICAgICAvLyBhZGRzIHIwLCAjMQogICAgICAgICAgICAiNDAgZjAgYzMgODAiLAogICAgICAgICAgICAvLyBibmUgIzB4MjAzYmYwCiAgICAgICAgICAgICIwMCAyNSIsCiAgICAgICAgICAgIC8vIG1vdnMgcjUsICMwCiAgICAgICAgICAgICI6IiwKICAgICAgICAgICAgImMwIGZmIiwKICAgICAgICAgICAgImMwIGZmIiwKICAgICAgICAgICAgImMwIGZiIDAwIGQwIiwKICAgICAgICAgICAgImZmIGY4IgogICAgICAgICAgXSwKICAgICAgICAgIHZhbGlkYXRlTWF0Y2g6IHZhbGlkYXRlR2V0T2F0UXVpY2tNZXRob2RIZWFkZXJJbmxpbmVkTWF0Y2hBcm0KICAgICAgICB9CiAgICAgIF0sCiAgICAgIGluc3RydW1lbnQ6IGluc3RydW1lbnRHZXRPYXRRdWlja01ldGhvZEhlYWRlcklubGluZWRDb3B5QXJtCiAgICB9LAogICAgYXJtNjQ6IHsKICAgICAgc2lnbmF0dXJlczogWwogICAgICAgIHsKICAgICAgICAgIHBhdHRlcm46IFsKICAgICAgICAgICAgLyogZTggKi8KICAgICAgICAgICAgIjBhIDQwIGI5IiwKICAgICAgICAgICAgLy8gbGRyIHc4LCBbeDIzLCAjMHg4XQogICAgICAgICAgICAiMWYgMDUgMDAgMzEiLAogICAgICAgICAgICAvLyBjbW4gdzgsICMweDEKICAgICAgICAgICAgIjQwIDAxIDAwIDU0IiwKICAgICAgICAgICAgLy8gYi5lcSAweDJlNDIwNAogICAgICAgICAgICAiODggMzkgMDAgZjAiLAogICAgICAgICAgICAvLyBhZHJwIHg4LCAweGExNzAwMAogICAgICAgICAgICAiOiIsCiAgICAgICAgICAgIC8qIDAwICovCiAgICAgICAgICAgICJmYyBmZiBmZiIsCiAgICAgICAgICAgICIxZiBmYyBmZiBmZiIsCiAgICAgICAgICAgICIxZiAwMCAwMCBmZiIsCiAgICAgICAgICAgICIwMCAwMCAwMCA5ZiIKICAgICAgICAgIF0sCiAgICAgICAgICBvZmZzZXQ6IDEsCiAgICAgICAgICB2YWxpZGF0ZU1hdGNoOiB2YWxpZGF0ZUdldE9hdFF1aWNrTWV0aG9kSGVhZGVySW5saW5lZE1hdGNoQXJtNjQKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgIHBhdHRlcm46IFsKICAgICAgICAgICAgLyogZTggKi8KICAgICAgICAgICAgIjBhIDQwIGI5IiwKICAgICAgICAgICAgLy8gbGRyIHc4LCBbeDIzLCAjMHg4XQogICAgICAgICAgICAiMWYgMDUgMDAgMzEiLAogICAgICAgICAgICAvLyBjbW4gdzgsICMweDEKICAgICAgICAgICAgIjAxIDM0IDAwIDU0IiwKICAgICAgICAgICAgLy8gYi5uZSAweDNkOGU1MAogICAgICAgICAgICAiZTAgMDMgMWYgYWEiLAogICAgICAgICAgICAvLyBtb3YgeDAsIHh6cgogICAgICAgICAgICAiOiIsCiAgICAgICAgICAgIC8qIDAwICovCiAgICAgICAgICAgICJmYyBmZiBmZiIsCiAgICAgICAgICAgICIxZiBmYyBmZiBmZiIsCiAgICAgICAgICAgICIxZiAwMCAwMCBmZiIsCiAgICAgICAgICAgICJlMCBmZiBmZiBmZiIKICAgICAgICAgIF0sCiAgICAgICAgICBvZmZzZXQ6IDEsCiAgICAgICAgICB2YWxpZGF0ZU1hdGNoOiB2YWxpZGF0ZUdldE9hdFF1aWNrTWV0aG9kSGVhZGVySW5saW5lZE1hdGNoQXJtNjQKICAgICAgICB9CiAgICAgIF0sCiAgICAgIGluc3RydW1lbnQ6IGluc3RydW1lbnRHZXRPYXRRdWlja01ldGhvZEhlYWRlcklubGluZWRDb3B5QXJtNjQKICAgIH0KICB9OwogIGZ1bmN0aW9uIHZhbGlkYXRlR2V0T2F0UXVpY2tNZXRob2RIZWFkZXJJbmxpbmVkTWF0Y2hBcm0oeyBhZGRyZXNzLCBzaXplIH0pIHsKICAgIGNvbnN0IGxkciA9IEluc3RydWN0aW9uLnBhcnNlKGFkZHJlc3Mub3IoMSkpOwogICAgY29uc3QgW2xkckRzdCwgbGRyU3JjXSA9IGxkci5vcGVyYW5kczsKICAgIGNvbnN0IG1ldGhvZFJlZyA9IGxkclNyYy52YWx1ZS5iYXNlOwogICAgY29uc3Qgc2NyYXRjaFJlZyA9IGxkckRzdC52YWx1ZTsKICAgIGNvbnN0IGJyYW5jaCA9IEluc3RydWN0aW9uLnBhcnNlKGxkci5uZXh0LmFkZCgyKSk7CiAgICBjb25zdCB0YXJnZXRXaGVuVHJ1ZSA9IHB0cihicmFuY2gub3BlcmFuZHNbMF0udmFsdWUpOwogICAgY29uc3QgdGFyZ2V0V2hlbkZhbHNlID0gYnJhbmNoLmFkZHJlc3MuYWRkKGJyYW5jaC5zaXplKTsKICAgIGxldCB0YXJnZXRXaGVuUmVndWxhck1ldGhvZCwgdGFyZ2V0V2hlblJ1bnRpbWVNZXRob2Q7CiAgICBpZiAoYnJhbmNoLm1uZW1vbmljID09PSAiYmVxIikgewogICAgICB0YXJnZXRXaGVuUmVndWxhck1ldGhvZCA9IHRhcmdldFdoZW5GYWxzZTsKICAgICAgdGFyZ2V0V2hlblJ1bnRpbWVNZXRob2QgPSB0YXJnZXRXaGVuVHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHRhcmdldFdoZW5SZWd1bGFyTWV0aG9kID0gdGFyZ2V0V2hlblRydWU7CiAgICAgIHRhcmdldFdoZW5SdW50aW1lTWV0aG9kID0gdGFyZ2V0V2hlbkZhbHNlOwogICAgfQogICAgcmV0dXJuIHBhcnNlSW5zdHJ1Y3Rpb25zQXQodGFyZ2V0V2hlblJlZ3VsYXJNZXRob2Qub3IoMSksIHRyeVBhcnNlLCB7IGxpbWl0OiAzIH0pOwogICAgZnVuY3Rpb24gdHJ5UGFyc2UoaW5zbikgewogICAgICBjb25zdCB7IG1uZW1vbmljIH0gPSBpbnNuOwogICAgICBpZiAoIShtbmVtb25pYyA9PT0gImxkciIgfHwgbW5lbW9uaWMgPT09ICJsZHIudyIpKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgY29uc3QgeyBiYXNlLCBkaXNwIH0gPSBpbnNuLm9wZXJhbmRzWzFdLnZhbHVlOwogICAgICBpZiAoIShiYXNlID09PSBtZXRob2RSZWcgJiYgZGlzcCA9PT0gMjApKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICBtZXRob2RSZWcsCiAgICAgICAgc2NyYXRjaFJlZywKICAgICAgICB0YXJnZXQ6IHsKICAgICAgICAgIHdoZW5UcnVlOiB0YXJnZXRXaGVuVHJ1ZSwKICAgICAgICAgIHdoZW5SZWd1bGFyTWV0aG9kOiB0YXJnZXRXaGVuUmVndWxhck1ldGhvZCwKICAgICAgICAgIHdoZW5SdW50aW1lTWV0aG9kOiB0YXJnZXRXaGVuUnVudGltZU1ldGhvZAogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9CiAgZnVuY3Rpb24gdmFsaWRhdGVHZXRPYXRRdWlja01ldGhvZEhlYWRlcklubGluZWRNYXRjaEFybTY0KHsgYWRkcmVzcywgc2l6ZSB9KSB7CiAgICBjb25zdCBbbGRyRHN0LCBsZHJTcmNdID0gSW5zdHJ1Y3Rpb24ucGFyc2UoYWRkcmVzcykub3BlcmFuZHM7CiAgICBjb25zdCBtZXRob2RSZWcgPSBsZHJTcmMudmFsdWUuYmFzZTsKICAgIGNvbnN0IHNjcmF0Y2hSZWcgPSAieCIgKyBsZHJEc3QudmFsdWUuc3Vic3RyaW5nKDEpOwogICAgY29uc3QgYnJhbmNoID0gSW5zdHJ1Y3Rpb24ucGFyc2UoYWRkcmVzcy5hZGQoOCkpOwogICAgY29uc3QgdGFyZ2V0V2hlblRydWUgPSBwdHIoYnJhbmNoLm9wZXJhbmRzWzBdLnZhbHVlKTsKICAgIGNvbnN0IHRhcmdldFdoZW5GYWxzZSA9IGFkZHJlc3MuYWRkKDEyKTsKICAgIGxldCB0YXJnZXRXaGVuUmVndWxhck1ldGhvZCwgdGFyZ2V0V2hlblJ1bnRpbWVNZXRob2Q7CiAgICBpZiAoYnJhbmNoLm1uZW1vbmljID09PSAiYi5lcSIpIHsKICAgICAgdGFyZ2V0V2hlblJlZ3VsYXJNZXRob2QgPSB0YXJnZXRXaGVuRmFsc2U7CiAgICAgIHRhcmdldFdoZW5SdW50aW1lTWV0aG9kID0gdGFyZ2V0V2hlblRydWU7CiAgICB9IGVsc2UgewogICAgICB0YXJnZXRXaGVuUmVndWxhck1ldGhvZCA9IHRhcmdldFdoZW5UcnVlOwogICAgICB0YXJnZXRXaGVuUnVudGltZU1ldGhvZCA9IHRhcmdldFdoZW5GYWxzZTsKICAgIH0KICAgIHJldHVybiBwYXJzZUluc3RydWN0aW9uc0F0KHRhcmdldFdoZW5SZWd1bGFyTWV0aG9kLCB0cnlQYXJzZSwgeyBsaW1pdDogMyB9KTsKICAgIGZ1bmN0aW9uIHRyeVBhcnNlKGluc24pIHsKICAgICAgaWYgKGluc24ubW5lbW9uaWMgIT09ICJsZHIiKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgY29uc3QgeyBiYXNlLCBkaXNwIH0gPSBpbnNuLm9wZXJhbmRzWzFdLnZhbHVlOwogICAgICBpZiAoIShiYXNlID09PSBtZXRob2RSZWcgJiYgZGlzcCA9PT0gMjQpKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICBtZXRob2RSZWcsCiAgICAgICAgc2NyYXRjaFJlZywKICAgICAgICB0YXJnZXQ6IHsKICAgICAgICAgIHdoZW5UcnVlOiB0YXJnZXRXaGVuVHJ1ZSwKICAgICAgICAgIHdoZW5SZWd1bGFyTWV0aG9kOiB0YXJnZXRXaGVuUmVndWxhck1ldGhvZCwKICAgICAgICAgIHdoZW5SdW50aW1lTWV0aG9kOiB0YXJnZXRXaGVuUnVudGltZU1ldGhvZAogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9CiAgZnVuY3Rpb24gbWF5YmVJbnN0cnVtZW50R2V0T2F0UXVpY2tNZXRob2RIZWFkZXJJbmxpbmVDb3BpZXMoKSB7CiAgICBpZiAoZ2V0QW5kcm9pZEFwaUxldmVsKCkgPCAzMSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBjb25zdCBoYW5kbGVyID0gYXJ0R2V0T2F0UXVpY2tNZXRob2RIZWFkZXJJbmxpbmVkQ29weUhhbmRsZXJbUHJvY2Vzcy5hcmNoXTsKICAgIGlmIChoYW5kbGVyID09PSB2b2lkIDApIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgY29uc3Qgc2lnbmF0dXJlcyA9IGhhbmRsZXIuc2lnbmF0dXJlcy5tYXAoKHsgcGF0dGVybiwgb2Zmc2V0ID0gMCwgdmFsaWRhdGVNYXRjaCA9IHJldHVybkVtcHR5T2JqZWN0IH0pID0+IHsKICAgICAgcmV0dXJuIHsKICAgICAgICBwYXR0ZXJuOiBuZXcgTWF0Y2hQYXR0ZXJuKHBhdHRlcm4uam9pbigiIikpLAogICAgICAgIG9mZnNldCwKICAgICAgICB2YWxpZGF0ZU1hdGNoCiAgICAgIH07CiAgICB9KTsKICAgIGNvbnN0IGltcGxzID0gW107CiAgICBmb3IgKGNvbnN0IHsgYmFzZSwgc2l6ZSB9IG9mIGdldEFwaSgpLm1vZHVsZS5lbnVtZXJhdGVSYW5nZXMoIi0teCIpKSB7CiAgICAgIGZvciAoY29uc3QgeyBwYXR0ZXJuLCBvZmZzZXQsIHZhbGlkYXRlTWF0Y2ggfSBvZiBzaWduYXR1cmVzKSB7CiAgICAgICAgY29uc3QgbWF0Y2hlcyA9IE1lbW9yeS5zY2FuU3luYyhiYXNlLCBzaXplLCBwYXR0ZXJuKS5tYXAoKHsgYWRkcmVzcywgc2l6ZTogc2l6ZTIgfSkgPT4gewogICAgICAgICAgcmV0dXJuIHsgYWRkcmVzczogYWRkcmVzcy5zdWIob2Zmc2V0KSwgc2l6ZTogc2l6ZTIgKyBvZmZzZXQgfTsKICAgICAgICB9KS5maWx0ZXIoKG1hdGNoKSA9PiB7CiAgICAgICAgICBjb25zdCB2YWxpZGF0aW9uUmVzdWx0ID0gdmFsaWRhdGVNYXRjaChtYXRjaCk7CiAgICAgICAgICBpZiAodmFsaWRhdGlvblJlc3VsdCA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBtYXRjaC52YWxpZGF0aW9uUmVzdWx0ID0gdmFsaWRhdGlvblJlc3VsdDsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0pOwogICAgICAgIGltcGxzLnB1c2goLi4ubWF0Y2hlcyk7CiAgICAgIH0KICAgIH0KICAgIGlmIChpbXBscy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgaW1wbHMuZm9yRWFjaChoYW5kbGVyLmluc3RydW1lbnQpOwogICAgcmV0dXJuIHRydWU7CiAgfQogIGZ1bmN0aW9uIHJldHVybkVtcHR5T2JqZWN0KCkgewogICAgcmV0dXJuIHt9OwogIH0KICB2YXIgSW5saW5lSG9vayA9IGNsYXNzIHsKICAgIGNvbnN0cnVjdG9yKGFkZHJlc3MsIHNpemUsIHRyYW1wb2xpbmUpIHsKICAgICAgdGhpcy5hZGRyZXNzID0gYWRkcmVzczsKICAgICAgdGhpcy5zaXplID0gc2l6ZTsKICAgICAgdGhpcy5vcmlnaW5hbENvZGUgPSBhZGRyZXNzLnJlYWRCeXRlQXJyYXkoc2l6ZSk7CiAgICAgIHRoaXMudHJhbXBvbGluZSA9IHRyYW1wb2xpbmU7CiAgICB9CiAgICByZXZlcnQoKSB7CiAgICAgIE1lbW9yeS5wYXRjaENvZGUodGhpcy5hZGRyZXNzLCB0aGlzLnNpemUsIChjb2RlMikgPT4gewogICAgICAgIGNvZGUyLndyaXRlQnl0ZUFycmF5KHRoaXMub3JpZ2luYWxDb2RlKTsKICAgICAgfSk7CiAgICB9CiAgfTsKICBmdW5jdGlvbiBpbnN0cnVtZW50R2V0T2F0UXVpY2tNZXRob2RIZWFkZXJJbmxpbmVkQ29weUFybSh7IGFkZHJlc3MsIHNpemUsIHZhbGlkYXRpb25SZXN1bHQgfSkgewogICAgY29uc3QgeyBtZXRob2RSZWcsIHRhcmdldCB9ID0gdmFsaWRhdGlvblJlc3VsdDsKICAgIGNvbnN0IHRyYW1wb2xpbmUgPSBNZW1vcnkuYWxsb2MoUHJvY2Vzcy5wYWdlU2l6ZSk7CiAgICBsZXQgcmVkaXJlY3RDYXBhY2l0eSA9IHNpemU7CiAgICBNZW1vcnkucGF0Y2hDb2RlKHRyYW1wb2xpbmUsIDI1NiwgKGNvZGUyKSA9PiB7CiAgICAgIGNvbnN0IHdyaXRlciA9IG5ldyBUaHVtYldyaXRlcihjb2RlMiwgeyBwYzogdHJhbXBvbGluZSB9KTsKICAgICAgY29uc3QgcmVsb2NhdG9yID0gbmV3IFRodW1iUmVsb2NhdG9yKGFkZHJlc3MsIHdyaXRlcik7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSAyOyBpKyspIHsKICAgICAgICByZWxvY2F0b3IucmVhZE9uZSgpOwogICAgICB9CiAgICAgIHJlbG9jYXRvci53cml0ZUFsbCgpOwogICAgICByZWxvY2F0b3IucmVhZE9uZSgpOwogICAgICByZWxvY2F0b3Iuc2tpcE9uZSgpOwogICAgICB3cml0ZXIucHV0QkNvbmRMYWJlbCgiZXEiLCAicnVudGltZV9vcl9yZXBsYWNlbWVudF9tZXRob2QiKTsKICAgICAgY29uc3QgdnB1c2hGcFJlZ3MgPSBbNDUsIDIzNywgMTYsIDEwXTsKICAgICAgd3JpdGVyLnB1dEJ5dGVzKHZwdXNoRnBSZWdzKTsKICAgICAgY29uc3Qgc2F2ZWRSZWdzID0gWyJyMCIsICJyMSIsICJyMiIsICJyMyJdOwogICAgICB3cml0ZXIucHV0UHVzaFJlZ3Moc2F2ZWRSZWdzKTsKICAgICAgd3JpdGVyLnB1dENhbGxBZGRyZXNzV2l0aEFyZ3VtZW50cyhhcnRDb250cm9sbGVyLnJlcGxhY2VkTWV0aG9kcy5pc1JlcGxhY2VtZW50LCBbbWV0aG9kUmVnXSk7CiAgICAgIHdyaXRlci5wdXRDbXBSZWdJbW0oInIwIiwgMCk7CiAgICAgIHdyaXRlci5wdXRQb3BSZWdzKHNhdmVkUmVncyk7CiAgICAgIGNvbnN0IHZwb3BGcFJlZ3MgPSBbMTg5LCAyMzYsIDE2LCAxMF07CiAgICAgIHdyaXRlci5wdXRCeXRlcyh2cG9wRnBSZWdzKTsKICAgICAgd3JpdGVyLnB1dEJDb25kTGFiZWwoIm5lIiwgInJ1bnRpbWVfb3JfcmVwbGFjZW1lbnRfbWV0aG9kIik7CiAgICAgIHdyaXRlci5wdXRCTGFiZWwoInJlZ3VsYXJfbWV0aG9kIik7CiAgICAgIHJlbG9jYXRvci5yZWFkT25lKCk7CiAgICAgIGNvbnN0IHRhaWxJc1JlZ3VsYXIgPSByZWxvY2F0b3IuaW5wdXQuYWRkcmVzcy5lcXVhbHModGFyZ2V0LndoZW5SZWd1bGFyTWV0aG9kKTsKICAgICAgd3JpdGVyLnB1dExhYmVsKHRhaWxJc1JlZ3VsYXIgPyAicmVndWxhcl9tZXRob2QiIDogInJ1bnRpbWVfb3JfcmVwbGFjZW1lbnRfbWV0aG9kIik7CiAgICAgIHJlbG9jYXRvci53cml0ZU9uZSgpOwogICAgICB3aGlsZSAocmVkaXJlY3RDYXBhY2l0eSA8IDEwKSB7CiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gcmVsb2NhdG9yLnJlYWRPbmUoKTsKICAgICAgICBpZiAob2Zmc2V0ID09PSAwKSB7CiAgICAgICAgICByZWRpcmVjdENhcGFjaXR5ID0gMTA7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgcmVkaXJlY3RDYXBhY2l0eSA9IG9mZnNldDsKICAgICAgfQogICAgICByZWxvY2F0b3Iud3JpdGVBbGwoKTsKICAgICAgd3JpdGVyLnB1dEJyYW5jaEFkZHJlc3MoYWRkcmVzcy5hZGQocmVkaXJlY3RDYXBhY2l0eSArIDEpKTsKICAgICAgd3JpdGVyLnB1dExhYmVsKHRhaWxJc1JlZ3VsYXIgPyAicnVudGltZV9vcl9yZXBsYWNlbWVudF9tZXRob2QiIDogInJlZ3VsYXJfbWV0aG9kIik7CiAgICAgIHdyaXRlci5wdXRCcmFuY2hBZGRyZXNzKHRhcmdldC53aGVuVHJ1ZSk7CiAgICAgIHdyaXRlci5mbHVzaCgpOwogICAgfSk7CiAgICBpbmxpbmVIb29rcy5wdXNoKG5ldyBJbmxpbmVIb29rKGFkZHJlc3MsIHJlZGlyZWN0Q2FwYWNpdHksIHRyYW1wb2xpbmUpKTsKICAgIE1lbW9yeS5wYXRjaENvZGUoYWRkcmVzcywgcmVkaXJlY3RDYXBhY2l0eSwgKGNvZGUyKSA9PiB7CiAgICAgIGNvbnN0IHdyaXRlciA9IG5ldyBUaHVtYldyaXRlcihjb2RlMiwgeyBwYzogYWRkcmVzcyB9KTsKICAgICAgd3JpdGVyLnB1dExkclJlZ0FkZHJlc3MoInBjIiwgdHJhbXBvbGluZS5vcigxKSk7CiAgICAgIHdyaXRlci5mbHVzaCgpOwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIGluc3RydW1lbnRHZXRPYXRRdWlja01ldGhvZEhlYWRlcklubGluZWRDb3B5QXJtNjQoeyBhZGRyZXNzLCBzaXplLCB2YWxpZGF0aW9uUmVzdWx0IH0pIHsKICAgIGNvbnN0IHsgbWV0aG9kUmVnLCBzY3JhdGNoUmVnLCB0YXJnZXQgfSA9IHZhbGlkYXRpb25SZXN1bHQ7CiAgICBjb25zdCB0cmFtcG9saW5lID0gTWVtb3J5LmFsbG9jKFByb2Nlc3MucGFnZVNpemUpOwogICAgTWVtb3J5LnBhdGNoQ29kZSh0cmFtcG9saW5lLCAyNTYsIChjb2RlMikgPT4gewogICAgICBjb25zdCB3cml0ZXIgPSBuZXcgQXJtNjRXcml0ZXIoY29kZTIsIHsgcGM6IHRyYW1wb2xpbmUgfSk7CiAgICAgIGNvbnN0IHJlbG9jYXRvciA9IG5ldyBBcm02NFJlbG9jYXRvcihhZGRyZXNzLCB3cml0ZXIpOwogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gMjsgaSsrKSB7CiAgICAgICAgcmVsb2NhdG9yLnJlYWRPbmUoKTsKICAgICAgfQogICAgICByZWxvY2F0b3Iud3JpdGVBbGwoKTsKICAgICAgcmVsb2NhdG9yLnJlYWRPbmUoKTsKICAgICAgcmVsb2NhdG9yLnNraXBPbmUoKTsKICAgICAgd3JpdGVyLnB1dEJDb25kTGFiZWwoImVxIiwgInJ1bnRpbWVfb3JfcmVwbGFjZW1lbnRfbWV0aG9kIik7CiAgICAgIGNvbnN0IHNhdmVkUmVncyA9IFsKICAgICAgICAiZDAiLAogICAgICAgICJkMSIsCiAgICAgICAgImQyIiwKICAgICAgICAiZDMiLAogICAgICAgICJkNCIsCiAgICAgICAgImQ1IiwKICAgICAgICAiZDYiLAogICAgICAgICJkNyIsCiAgICAgICAgIngwIiwKICAgICAgICAieDEiLAogICAgICAgICJ4MiIsCiAgICAgICAgIngzIiwKICAgICAgICAieDQiLAogICAgICAgICJ4NSIsCiAgICAgICAgIng2IiwKICAgICAgICAieDciLAogICAgICAgICJ4OCIsCiAgICAgICAgIng5IiwKICAgICAgICAieDEwIiwKICAgICAgICAieDExIiwKICAgICAgICAieDEyIiwKICAgICAgICAieDEzIiwKICAgICAgICAieDE0IiwKICAgICAgICAieDE1IiwKICAgICAgICAieDE2IiwKICAgICAgICAieDE3IgogICAgICBdOwogICAgICBjb25zdCBudW1TYXZlZFJlZ3MgPSBzYXZlZFJlZ3MubGVuZ3RoOwogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gbnVtU2F2ZWRSZWdzOyBpICs9IDIpIHsKICAgICAgICB3cml0ZXIucHV0UHVzaFJlZ1JlZyhzYXZlZFJlZ3NbaV0sIHNhdmVkUmVnc1tpICsgMV0pOwogICAgICB9CiAgICAgIHdyaXRlci5wdXRDYWxsQWRkcmVzc1dpdGhBcmd1bWVudHMoYXJ0Q29udHJvbGxlci5yZXBsYWNlZE1ldGhvZHMuaXNSZXBsYWNlbWVudCwgW21ldGhvZFJlZ10pOwogICAgICB3cml0ZXIucHV0Q21wUmVnUmVnKCJ4MCIsICJ4enIiKTsKICAgICAgZm9yIChsZXQgaSA9IG51bVNhdmVkUmVncyAtIDI7IGkgPj0gMDsgaSAtPSAyKSB7CiAgICAgICAgd3JpdGVyLnB1dFBvcFJlZ1JlZyhzYXZlZFJlZ3NbaV0sIHNhdmVkUmVnc1tpICsgMV0pOwogICAgICB9CiAgICAgIHdyaXRlci5wdXRCQ29uZExhYmVsKCJuZSIsICJydW50aW1lX29yX3JlcGxhY2VtZW50X21ldGhvZCIpOwogICAgICB3cml0ZXIucHV0QkxhYmVsKCJyZWd1bGFyX21ldGhvZCIpOwogICAgICByZWxvY2F0b3IucmVhZE9uZSgpOwogICAgICBjb25zdCB0YWlsSW5zdHJ1Y3Rpb24gPSByZWxvY2F0b3IuaW5wdXQ7CiAgICAgIGNvbnN0IHRhaWxJc1JlZ3VsYXIgPSB0YWlsSW5zdHJ1Y3Rpb24uYWRkcmVzcy5lcXVhbHModGFyZ2V0LndoZW5SZWd1bGFyTWV0aG9kKTsKICAgICAgd3JpdGVyLnB1dExhYmVsKHRhaWxJc1JlZ3VsYXIgPyAicmVndWxhcl9tZXRob2QiIDogInJ1bnRpbWVfb3JfcmVwbGFjZW1lbnRfbWV0aG9kIik7CiAgICAgIHJlbG9jYXRvci53cml0ZU9uZSgpOwogICAgICB3cml0ZXIucHV0QnJhbmNoQWRkcmVzcyh0YWlsSW5zdHJ1Y3Rpb24ubmV4dCk7CiAgICAgIHdyaXRlci5wdXRMYWJlbCh0YWlsSXNSZWd1bGFyID8gInJ1bnRpbWVfb3JfcmVwbGFjZW1lbnRfbWV0aG9kIiA6ICJyZWd1bGFyX21ldGhvZCIpOwogICAgICB3cml0ZXIucHV0QnJhbmNoQWRkcmVzcyh0YXJnZXQud2hlblRydWUpOwogICAgICB3cml0ZXIuZmx1c2goKTsKICAgIH0pOwogICAgaW5saW5lSG9va3MucHVzaChuZXcgSW5saW5lSG9vayhhZGRyZXNzLCBzaXplLCB0cmFtcG9saW5lKSk7CiAgICBNZW1vcnkucGF0Y2hDb2RlKGFkZHJlc3MsIHNpemUsIChjb2RlMikgPT4gewogICAgICBjb25zdCB3cml0ZXIgPSBuZXcgQXJtNjRXcml0ZXIoY29kZTIsIHsgcGM6IGFkZHJlc3MgfSk7CiAgICAgIHdyaXRlci5wdXRMZHJSZWdBZGRyZXNzKHNjcmF0Y2hSZWcsIHRyYW1wb2xpbmUpOwogICAgICB3cml0ZXIucHV0QnJSZWcoc2NyYXRjaFJlZyk7CiAgICAgIHdyaXRlci5mbHVzaCgpOwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIG1ha2VNZXRob2RNYW5nbGVyKG1ldGhvZElkKSB7CiAgICByZXR1cm4gbmV3IE1ldGhvZE1hbmdsZXIobWV0aG9kSWQpOwogIH0KICBmdW5jdGlvbiB0cmFuc2xhdGVNZXRob2QobWV0aG9kSWQpIHsKICAgIHJldHVybiBhcnRDb250cm9sbGVyLnJlcGxhY2VkTWV0aG9kcy50cmFuc2xhdGUobWV0aG9kSWQpOwogIH0KICBmdW5jdGlvbiBiYWNrdHJhY2Uodm0zLCBvcHRpb25zID0ge30pIHsKICAgIGNvbnN0IHsgbGltaXQgPSAxNiB9ID0gb3B0aW9uczsKICAgIGNvbnN0IGVudiA9IHZtMy5nZXRFbnYoKTsKICAgIGlmIChiYWNrdHJhY2VNb2R1bGUgPT09IG51bGwpIHsKICAgICAgYmFja3RyYWNlTW9kdWxlID0gbWFrZUJhY2t0cmFjZU1vZHVsZSh2bTMsIGVudik7CiAgICB9CiAgICByZXR1cm4gYmFja3RyYWNlTW9kdWxlLmJhY2t0cmFjZShlbnYsIGxpbWl0KTsKICB9CiAgZnVuY3Rpb24gbWFrZUJhY2t0cmFjZU1vZHVsZSh2bTMsIGVudikgewogICAgY29uc3QgYXBpMiA9IGdldEFwaSgpOwogICAgY29uc3QgcGVyZm9ybUltcGwgPSBNZW1vcnkuYWxsb2MoUHJvY2Vzcy5wb2ludGVyU2l6ZSk7CiAgICBjb25zdCBjbTIgPSBuZXcgQ01vZHVsZShgCiNpbmNsdWRlIDxnbGliLmg+CiNpbmNsdWRlIDxzdGRib29sLmg+CiNpbmNsdWRlIDxzdHJpbmcuaD4KI2luY2x1ZGUgPGd1bS9ndW10bHMuaD4KI2luY2x1ZGUgPGpzb24tZ2xpYi9qc29uLWdsaWIuaD4KCnR5cGVkZWYgc3RydWN0IF9BcnRCYWNrdHJhY2UgQXJ0QmFja3RyYWNlOwp0eXBlZGVmIHN0cnVjdCBfQXJ0U3RhY2tGcmFtZSBBcnRTdGFja0ZyYW1lOwoKdHlwZWRlZiBzdHJ1Y3QgX0FydFN0YWNrVmlzaXRvciBBcnRTdGFja1Zpc2l0b3I7CnR5cGVkZWYgc3RydWN0IF9BcnRTdGFja1Zpc2l0b3JWVGFibGUgQXJ0U3RhY2tWaXNpdG9yVlRhYmxlOwoKdHlwZWRlZiBzdHJ1Y3QgX0FydENsYXNzIEFydENsYXNzOwp0eXBlZGVmIHN0cnVjdCBfQXJ0TWV0aG9kIEFydE1ldGhvZDsKdHlwZWRlZiBzdHJ1Y3QgX0FydFRocmVhZCBBcnRUaHJlYWQ7CnR5cGVkZWYgc3RydWN0IF9BcnRDb250ZXh0IEFydENvbnRleHQ7Cgp0eXBlZGVmIHN0cnVjdCBfSk5JRW52IEpOSUVudjsKCnR5cGVkZWYgc3RydWN0IF9TdGRTdHJpbmcgU3RkU3RyaW5nOwp0eXBlZGVmIHN0cnVjdCBfU3RkVGlueVN0cmluZyBTdGRUaW55U3RyaW5nOwp0eXBlZGVmIHN0cnVjdCBfU3RkTGFyZ2VTdHJpbmcgU3RkTGFyZ2VTdHJpbmc7Cgp0eXBlZGVmIGVudW0gewogIFNUQUNLX1dBTEtfSU5DTFVERV9JTkxJTkVEX0ZSQU1FUywKICBTVEFDS19XQUxLX1NLSVBfSU5MSU5FRF9GUkFNRVMsCn0gU3RhY2tXYWxrS2luZDsKCnN0cnVjdCBfU3RkVGlueVN0cmluZwp7CiAgZ3VpbnQ4IHVudXNlZDsKICBnY2hhciBkYXRhWygzICogc2l6ZW9mIChncG9pbnRlcikpIC0gMV07Cn07CgpzdHJ1Y3QgX1N0ZExhcmdlU3RyaW5nCnsKICBnc2l6ZSBjYXBhY2l0eTsKICBnc2l6ZSBzaXplOwogIGdjaGFyICogZGF0YTsKfTsKCnN0cnVjdCBfU3RkU3RyaW5nCnsKICB1bmlvbgogIHsKICAgIGd1aW50OCBmbGFnczsKICAgIFN0ZFRpbnlTdHJpbmcgdGlueTsKICAgIFN0ZExhcmdlU3RyaW5nIGxhcmdlOwogIH07Cn07CgpzdHJ1Y3QgX0FydEJhY2t0cmFjZQp7CiAgR0NoZWNrc3VtICogaWQ7CiAgR0FycmF5ICogZnJhbWVzOwogIGdjaGFyICogZnJhbWVzX2pzb247Cn07CgpzdHJ1Y3QgX0FydFN0YWNrRnJhbWUKewogIEFydE1ldGhvZCAqIG1ldGhvZDsKICBnc2l6ZSBkZXhwYzsKICBTdGRTdHJpbmcgZGVzY3JpcHRpb247Cn07CgpzdHJ1Y3QgX0FydFN0YWNrVmlzaXRvclZUYWJsZQp7CiAgdm9pZCAoKiB1bnVzZWQxKSAodm9pZCk7CiAgdm9pZCAoKiB1bnVzZWQyKSAodm9pZCk7CiAgYm9vbCAoKiB2aXNpdCkgKEFydFN0YWNrVmlzaXRvciAqIHZpc2l0b3IpOwp9OwoKc3RydWN0IF9BcnRTdGFja1Zpc2l0b3IKewogIEFydFN0YWNrVmlzaXRvclZUYWJsZSAqIHZ0YWJsZTsKCiAgZ3VpbnQ4IHBhZGRpbmdbNTEyXTsKCiAgQXJ0U3RhY2tWaXNpdG9yVlRhYmxlIHZ0YWJsZV9zdG9yYWdlOwoKICBBcnRCYWNrdHJhY2UgKiBiYWNrdHJhY2U7Cn07CgpzdHJ1Y3QgX0FydE1ldGhvZAp7CiAgZ3VpbnQzMiBkZWNsYXJpbmdfY2xhc3M7CiAgZ3VpbnQzMiBhY2Nlc3NfZmxhZ3M7Cn07CgpleHRlcm4gR3VtVGxzS2V5IGN1cnJlbnRfYmFja3RyYWNlOwoKZXh0ZXJuIHZvaWQgKCogcGVyZm9ybV9hcnRfdGhyZWFkX3N0YXRlX3RyYW5zaXRpb24pIChKTklFbnYgKiBlbnYpOwoKZXh0ZXJuIEFydENvbnRleHQgKiBhcnRfdGhyZWFkX2dldF9sb25nX2p1bXBfY29udGV4dCAoQXJ0VGhyZWFkICogdGhyZWFkKTsKCmV4dGVybiB2b2lkIGFydF9zdGFja192aXNpdG9yX2luaXQgKEFydFN0YWNrVmlzaXRvciAqIHZpc2l0b3IsIEFydFRocmVhZCAqIHRocmVhZCwgdm9pZCAqIGNvbnRleHQsIFN0YWNrV2Fsa0tpbmQgd2Fsa19raW5kLAogICAgc2l6ZV90IG51bV9mcmFtZXMsIGJvb2wgY2hlY2tfc3VzcGVuZGVkKTsKZXh0ZXJuIHZvaWQgYXJ0X3N0YWNrX3Zpc2l0b3Jfd2Fsa19zdGFjayAoQXJ0U3RhY2tWaXNpdG9yICogdmlzaXRvciwgYm9vbCBpbmNsdWRlX3RyYW5zaXRpb25zKTsKZXh0ZXJuIEFydE1ldGhvZCAqIGFydF9zdGFja192aXNpdG9yX2dldF9tZXRob2QgKEFydFN0YWNrVmlzaXRvciAqIHZpc2l0b3IpOwpleHRlcm4gdm9pZCBhcnRfc3RhY2tfdmlzaXRvcl9kZXNjcmliZV9sb2NhdGlvbiAoU3RkU3RyaW5nICogZGVzY3JpcHRpb24sIEFydFN0YWNrVmlzaXRvciAqIHZpc2l0b3IpOwpleHRlcm4gQXJ0TWV0aG9kICogdHJhbnNsYXRlX21ldGhvZCAoQXJ0TWV0aG9kICogbWV0aG9kKTsKZXh0ZXJuIHZvaWQgdHJhbnNsYXRlX2xvY2F0aW9uIChBcnRNZXRob2QgKiBtZXRob2QsIGd1aW50MzIgcGMsIGNvbnN0IGdjaGFyICoqIHNvdXJjZV9maWxlLCBnaW50MzIgKiBsaW5lX251bWJlcik7CmV4dGVybiB2b2lkIGdldF9jbGFzc19sb2NhdGlvbiAoU3RkU3RyaW5nICogcmVzdWx0LCBBcnRDbGFzcyAqIGtsYXNzKTsKZXh0ZXJuIHZvaWQgY3h4X2RlbGV0ZSAodm9pZCAqIG1lbSk7CmV4dGVybiB1bnNpZ25lZCBsb25nIHN0cnRvdWwgKGNvbnN0IGNoYXIgKiBzdHIsIGNoYXIgKiogZW5kcHRyLCBpbnQgYmFzZSk7CgpzdGF0aWMgYm9vbCB2aXNpdF9mcmFtZSAoQXJ0U3RhY2tWaXNpdG9yICogdmlzaXRvcik7CnN0YXRpYyB2b2lkIGFydF9zdGFja19mcmFtZV9kZXN0cm95IChBcnRTdGFja0ZyYW1lICogZnJhbWUpOwoKc3RhdGljIHZvaWQgYXBwZW5kX2puaV90eXBlX25hbWUgKEdTdHJpbmcgKiBzLCBjb25zdCBnY2hhciAqIG5hbWUsIGdzaXplIGxlbmd0aCk7CgpzdGF0aWMgdm9pZCBzdGRfc3RyaW5nX2Rlc3Ryb3kgKFN0ZFN0cmluZyAqIHN0cik7CnN0YXRpYyBnY2hhciAqIHN0ZF9zdHJpbmdfZ2V0X2RhdGEgKFN0ZFN0cmluZyAqIHN0cik7Cgp2b2lkCmluaXQgKHZvaWQpCnsKICBjdXJyZW50X2JhY2t0cmFjZSA9IGd1bV90bHNfa2V5X25ldyAoKTsKfQoKdm9pZApmaW5hbGl6ZSAodm9pZCkKewogIGd1bV90bHNfa2V5X2ZyZWUgKGN1cnJlbnRfYmFja3RyYWNlKTsKfQoKQXJ0QmFja3RyYWNlICoKX2NyZWF0ZSAoSk5JRW52ICogZW52LAogICAgICAgICBndWludCBsaW1pdCkKewogIEFydEJhY2t0cmFjZSAqIGJ0OwoKICBidCA9IGdfbmV3IChBcnRCYWNrdHJhY2UsIDEpOwogIGJ0LT5pZCA9IGdfY2hlY2tzdW1fbmV3IChHX0NIRUNLU1VNX1NIQTEpOwogIGJ0LT5mcmFtZXMgPSAobGltaXQgIT0gMCkKICAgICAgPyBnX2FycmF5X3NpemVkX25ldyAoRkFMU0UsIEZBTFNFLCBzaXplb2YgKEFydFN0YWNrRnJhbWUpLCBsaW1pdCkKICAgICAgOiBnX2FycmF5X25ldyAoRkFMU0UsIEZBTFNFLCBzaXplb2YgKEFydFN0YWNrRnJhbWUpKTsKICBnX2FycmF5X3NldF9jbGVhcl9mdW5jIChidC0+ZnJhbWVzLCAoR0Rlc3Ryb3lOb3RpZnkpIGFydF9zdGFja19mcmFtZV9kZXN0cm95KTsKICBidC0+ZnJhbWVzX2pzb24gPSBOVUxMOwoKICBndW1fdGxzX2tleV9zZXRfdmFsdWUgKGN1cnJlbnRfYmFja3RyYWNlLCBidCk7CgogIHBlcmZvcm1fYXJ0X3RocmVhZF9zdGF0ZV90cmFuc2l0aW9uIChlbnYpOwoKICBndW1fdGxzX2tleV9zZXRfdmFsdWUgKGN1cnJlbnRfYmFja3RyYWNlLCBOVUxMKTsKCiAgcmV0dXJuIGJ0Owp9Cgp2b2lkCl9vbl90aHJlYWRfc3RhdGVfdHJhbnNpdGlvbl9jb21wbGV0ZSAoQXJ0VGhyZWFkICogdGhyZWFkKQp7CiAgQXJ0Q29udGV4dCAqIGNvbnRleHQ7CiAgQXJ0U3RhY2tWaXNpdG9yIHZpc2l0b3IgPSB7CiAgICAudnRhYmxlX3N0b3JhZ2UgPSB7CiAgICAgIC52aXNpdCA9IHZpc2l0X2ZyYW1lLAogICAgfSwKICB9OwoKICBjb250ZXh0ID0gYXJ0X3RocmVhZF9nZXRfbG9uZ19qdW1wX2NvbnRleHQgKHRocmVhZCk7CgogIGFydF9zdGFja192aXNpdG9yX2luaXQgKCZ2aXNpdG9yLCB0aHJlYWQsIGNvbnRleHQsIFNUQUNLX1dBTEtfU0tJUF9JTkxJTkVEX0ZSQU1FUywgMCwgdHJ1ZSk7CiAgdmlzaXRvci52dGFibGUgPSAmdmlzaXRvci52dGFibGVfc3RvcmFnZTsKICB2aXNpdG9yLmJhY2t0cmFjZSA9IGd1bV90bHNfa2V5X2dldF92YWx1ZSAoY3VycmVudF9iYWNrdHJhY2UpOwoKICBhcnRfc3RhY2tfdmlzaXRvcl93YWxrX3N0YWNrICgmdmlzaXRvciwgZmFsc2UpOwoKICBjeHhfZGVsZXRlIChjb250ZXh0KTsKfQoKc3RhdGljIGJvb2wKdmlzaXRfZnJhbWUgKEFydFN0YWNrVmlzaXRvciAqIHZpc2l0b3IpCnsKICBBcnRCYWNrdHJhY2UgKiBidCA9IHZpc2l0b3ItPmJhY2t0cmFjZTsKICBBcnRTdGFja0ZyYW1lIGZyYW1lOwogIGNvbnN0IGdjaGFyICogZGVzY3JpcHRpb24sICogZGV4cGNfcGFydDsKCiAgZnJhbWUubWV0aG9kID0gYXJ0X3N0YWNrX3Zpc2l0b3JfZ2V0X21ldGhvZCAodmlzaXRvcik7CgogIGFydF9zdGFja192aXNpdG9yX2Rlc2NyaWJlX2xvY2F0aW9uICgmZnJhbWUuZGVzY3JpcHRpb24sIHZpc2l0b3IpOwoKICBkZXNjcmlwdGlvbiA9IHN0ZF9zdHJpbmdfZ2V0X2RhdGEgKCZmcmFtZS5kZXNjcmlwdGlvbik7CiAgaWYgKHN0cnN0ciAoZGVzY3JpcHRpb24sICIgJzwiKSAhPSBOVUxMKQogICAgZ290byBza2lwOwoKICBkZXhwY19wYXJ0ID0gc3Ryc3RyIChkZXNjcmlwdGlvbiwgIiBhdCBkZXggUEMgMHgiKTsKICBpZiAoZGV4cGNfcGFydCA9PSBOVUxMKQogICAgZ290byBza2lwOwogIGZyYW1lLmRleHBjID0gc3RydG91bCAoZGV4cGNfcGFydCArIDEzLCBOVUxMLCAxNik7CgogIGdfYXJyYXlfYXBwZW5kX3ZhbCAoYnQtPmZyYW1lcywgZnJhbWUpOwoKICBnX2NoZWNrc3VtX3VwZGF0ZSAoYnQtPmlkLCAoZ3VjaGFyICopICZmcmFtZS5tZXRob2QsIHNpemVvZiAoZnJhbWUubWV0aG9kKSk7CiAgZ19jaGVja3N1bV91cGRhdGUgKGJ0LT5pZCwgKGd1Y2hhciAqKSAmZnJhbWUuZGV4cGMsIHNpemVvZiAoZnJhbWUuZGV4cGMpKTsKCiAgcmV0dXJuIHRydWU7Cgpza2lwOgogIHN0ZF9zdHJpbmdfZGVzdHJveSAoJmZyYW1lLmRlc2NyaXB0aW9uKTsKICByZXR1cm4gdHJ1ZTsKfQoKc3RhdGljIHZvaWQKYXJ0X3N0YWNrX2ZyYW1lX2Rlc3Ryb3kgKEFydFN0YWNrRnJhbWUgKiBmcmFtZSkKewogIHN0ZF9zdHJpbmdfZGVzdHJveSAoJmZyYW1lLT5kZXNjcmlwdGlvbik7Cn0KCnZvaWQKX2Rlc3Ryb3kgKEFydEJhY2t0cmFjZSAqIGJhY2t0cmFjZSkKewogIGdfZnJlZSAoYmFja3RyYWNlLT5mcmFtZXNfanNvbik7CiAgZ19hcnJheV9mcmVlIChiYWNrdHJhY2UtPmZyYW1lcywgVFJVRSk7CiAgZ19jaGVja3N1bV9mcmVlIChiYWNrdHJhY2UtPmlkKTsKICBnX2ZyZWUgKGJhY2t0cmFjZSk7Cn0KCmNvbnN0IGdjaGFyICoKX2dldF9pZCAoQXJ0QmFja3RyYWNlICogYmFja3RyYWNlKQp7CiAgcmV0dXJuIGdfY2hlY2tzdW1fZ2V0X3N0cmluZyAoYmFja3RyYWNlLT5pZCk7Cn0KCmNvbnN0IGdjaGFyICoKX2dldF9mcmFtZXMgKEFydEJhY2t0cmFjZSAqIGJhY2t0cmFjZSkKewogIEdBcnJheSAqIGZyYW1lcyA9IGJhY2t0cmFjZS0+ZnJhbWVzOwogIEpzb25CdWlsZGVyICogYjsKICBndWludCBpOwogIEpzb25Ob2RlICogcm9vdDsKCiAgaWYgKGJhY2t0cmFjZS0+ZnJhbWVzX2pzb24gIT0gTlVMTCkKICAgIHJldHVybiBiYWNrdHJhY2UtPmZyYW1lc19qc29uOwoKICBiID0ganNvbl9idWlsZGVyX25ld19pbW11dGFibGUgKCk7CgogIGpzb25fYnVpbGRlcl9iZWdpbl9hcnJheSAoYik7CgogIGZvciAoaSA9IDA7IGkgIT0gZnJhbWVzLT5sZW47IGkrKykKICB7CiAgICBBcnRTdGFja0ZyYW1lICogZnJhbWUgPSAmZ19hcnJheV9pbmRleCAoZnJhbWVzLCBBcnRTdGFja0ZyYW1lLCBpKTsKICAgIGdjaGFyICogZGVzY3JpcHRpb24sICogcmV0X3R5cGUsICogcGFyZW5fb3BlbiwgKiBwYXJlbl9jbG9zZSwgKiBhcmdfdHlwZXMsICogdG9rZW4sICogbWV0aG9kX25hbWUsICogY2xhc3NfbmFtZTsKICAgIEdTdHJpbmcgKiBzaWduYXR1cmU7CiAgICBnY2hhciAqIGN1cnNvcjsKICAgIEFydE1ldGhvZCAqIHRyYW5zbGF0ZWRfbWV0aG9kOwogICAgU3RkU3RyaW5nIGxvY2F0aW9uOwogICAgZ3NpemUgZGV4cGM7CiAgICBjb25zdCBnY2hhciAqIHNvdXJjZV9maWxlOwogICAgZ2ludDMyIGxpbmVfbnVtYmVyOwoKICAgIGRlc2NyaXB0aW9uID0gc3RkX3N0cmluZ19nZXRfZGF0YSAoJmZyYW1lLT5kZXNjcmlwdGlvbik7CgogICAgcmV0X3R5cGUgPSBzdHJjaHIgKGRlc2NyaXB0aW9uLCAnXFwnJykgKyAxOwoKICAgIHBhcmVuX29wZW4gPSBzdHJjaHIgKHJldF90eXBlLCAnKCcpOwogICAgcGFyZW5fY2xvc2UgPSBzdHJjaHIgKHBhcmVuX29wZW4sICcpJyk7CiAgICAqcGFyZW5fb3BlbiA9ICdcXDAnOwogICAgKnBhcmVuX2Nsb3NlID0gJ1xcMCc7CgogICAgYXJnX3R5cGVzID0gcGFyZW5fb3BlbiArIDE7CgogICAgdG9rZW4gPSBzdHJyY2hyIChyZXRfdHlwZSwgJy4nKTsKICAgICp0b2tlbiA9ICdcXDAnOwoKICAgIG1ldGhvZF9uYW1lID0gdG9rZW4gKyAxOwoKICAgIHRva2VuID0gc3RycmNociAocmV0X3R5cGUsICcgJyk7CiAgICAqdG9rZW4gPSAnXFwwJzsKCiAgICBjbGFzc19uYW1lID0gdG9rZW4gKyAxOwoKICAgIHNpZ25hdHVyZSA9IGdfc3RyaW5nX3NpemVkX25ldyAoMTI4KTsKCiAgICBhcHBlbmRfam5pX3R5cGVfbmFtZSAoc2lnbmF0dXJlLCBjbGFzc19uYW1lLCBtZXRob2RfbmFtZSAtIGNsYXNzX25hbWUgLSAxKTsKICAgIGdfc3RyaW5nX2FwcGVuZF9jIChzaWduYXR1cmUsICcsJyk7CiAgICBnX3N0cmluZ19hcHBlbmQgKHNpZ25hdHVyZSwgbWV0aG9kX25hbWUpOwogICAgZ19zdHJpbmdfYXBwZW5kIChzaWduYXR1cmUsICIsKCIpOwoKICAgIGlmIChhcmdfdHlwZXMgIT0gcGFyZW5fY2xvc2UpCiAgICB7CiAgICAgIGZvciAoY3Vyc29yID0gYXJnX3R5cGVzOyBjdXJzb3IgIT0gTlVMTDspCiAgICAgIHsKICAgICAgICBnc2l6ZSBsZW5ndGg7CiAgICAgICAgZ2NoYXIgKiBuZXh0OwoKICAgICAgICB0b2tlbiA9IHN0cnN0ciAoY3Vyc29yLCAiLCAiKTsKICAgICAgICBpZiAodG9rZW4gIT0gTlVMTCkKICAgICAgICB7CiAgICAgICAgICBsZW5ndGggPSB0b2tlbiAtIGN1cnNvcjsKICAgICAgICAgIG5leHQgPSB0b2tlbiArIDI7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICBsZW5ndGggPSBwYXJlbl9jbG9zZSAtIGN1cnNvcjsKICAgICAgICAgIG5leHQgPSBOVUxMOwogICAgICAgIH0KCiAgICAgICAgYXBwZW5kX2puaV90eXBlX25hbWUgKHNpZ25hdHVyZSwgY3Vyc29yLCBsZW5ndGgpOwoKICAgICAgICBjdXJzb3IgPSBuZXh0OwogICAgICB9CiAgICB9CgogICAgZ19zdHJpbmdfYXBwZW5kX2MgKHNpZ25hdHVyZSwgJyknKTsKCiAgICBhcHBlbmRfam5pX3R5cGVfbmFtZSAoc2lnbmF0dXJlLCByZXRfdHlwZSwgY2xhc3NfbmFtZSAtIHJldF90eXBlIC0gMSk7CgogICAgdHJhbnNsYXRlZF9tZXRob2QgPSB0cmFuc2xhdGVfbWV0aG9kIChmcmFtZS0+bWV0aG9kKTsKICAgIGRleHBjID0gKHRyYW5zbGF0ZWRfbWV0aG9kID09IGZyYW1lLT5tZXRob2QpID8gZnJhbWUtPmRleHBjIDogMDsKCiAgICBnZXRfY2xhc3NfbG9jYXRpb24gKCZsb2NhdGlvbiwgR1NJWkVfVE9fUE9JTlRFUiAodHJhbnNsYXRlZF9tZXRob2QtPmRlY2xhcmluZ19jbGFzcykpOwoKICAgIHRyYW5zbGF0ZV9sb2NhdGlvbiAodHJhbnNsYXRlZF9tZXRob2QsIGRleHBjLCAmc291cmNlX2ZpbGUsICZsaW5lX251bWJlcik7CgogICAganNvbl9idWlsZGVyX2JlZ2luX29iamVjdCAoYik7CgogICAganNvbl9idWlsZGVyX3NldF9tZW1iZXJfbmFtZSAoYiwgInNpZ25hdHVyZSIpOwogICAganNvbl9idWlsZGVyX2FkZF9zdHJpbmdfdmFsdWUgKGIsIHNpZ25hdHVyZS0+c3RyKTsKCiAgICBqc29uX2J1aWxkZXJfc2V0X21lbWJlcl9uYW1lIChiLCAib3JpZ2luIik7CiAgICBqc29uX2J1aWxkZXJfYWRkX3N0cmluZ192YWx1ZSAoYiwgc3RkX3N0cmluZ19nZXRfZGF0YSAoJmxvY2F0aW9uKSk7CgogICAganNvbl9idWlsZGVyX3NldF9tZW1iZXJfbmFtZSAoYiwgImNsYXNzTmFtZSIpOwogICAganNvbl9idWlsZGVyX2FkZF9zdHJpbmdfdmFsdWUgKGIsIGNsYXNzX25hbWUpOwoKICAgIGpzb25fYnVpbGRlcl9zZXRfbWVtYmVyX25hbWUgKGIsICJtZXRob2ROYW1lIik7CiAgICBqc29uX2J1aWxkZXJfYWRkX3N0cmluZ192YWx1ZSAoYiwgbWV0aG9kX25hbWUpOwoKICAgIGpzb25fYnVpbGRlcl9zZXRfbWVtYmVyX25hbWUgKGIsICJtZXRob2RGbGFncyIpOwogICAganNvbl9idWlsZGVyX2FkZF9pbnRfdmFsdWUgKGIsIHRyYW5zbGF0ZWRfbWV0aG9kLT5hY2Nlc3NfZmxhZ3MpOwoKICAgIGpzb25fYnVpbGRlcl9zZXRfbWVtYmVyX25hbWUgKGIsICJmaWxlTmFtZSIpOwogICAganNvbl9idWlsZGVyX2FkZF9zdHJpbmdfdmFsdWUgKGIsIHNvdXJjZV9maWxlKTsKCiAgICBqc29uX2J1aWxkZXJfc2V0X21lbWJlcl9uYW1lIChiLCAibGluZU51bWJlciIpOwogICAganNvbl9idWlsZGVyX2FkZF9pbnRfdmFsdWUgKGIsIGxpbmVfbnVtYmVyKTsKCiAgICBqc29uX2J1aWxkZXJfZW5kX29iamVjdCAoYik7CgogICAgc3RkX3N0cmluZ19kZXN0cm95ICgmbG9jYXRpb24pOwogICAgZ19zdHJpbmdfZnJlZSAoc2lnbmF0dXJlLCBUUlVFKTsKICB9CgogIGpzb25fYnVpbGRlcl9lbmRfYXJyYXkgKGIpOwoKICByb290ID0ganNvbl9idWlsZGVyX2dldF9yb290IChiKTsKICBiYWNrdHJhY2UtPmZyYW1lc19qc29uID0ganNvbl90b19zdHJpbmcgKHJvb3QsIEZBTFNFKTsKICBqc29uX25vZGVfdW5yZWYgKHJvb3QpOwoKICByZXR1cm4gYmFja3RyYWNlLT5mcmFtZXNfanNvbjsKfQoKc3RhdGljIHZvaWQKYXBwZW5kX2puaV90eXBlX25hbWUgKEdTdHJpbmcgKiBzLAogICAgICAgICAgICAgICAgICAgICAgY29uc3QgZ2NoYXIgKiBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgZ3NpemUgbGVuZ3RoKQp7CiAgZ2NoYXIgc2hvcnR5ID0gJ1xcMCc7CiAgZ3NpemUgaTsKCiAgc3dpdGNoIChuYW1lWzBdKQogIHsKICAgIGNhc2UgJ2InOgogICAgICBpZiAoc3RybmNtcCAobmFtZSwgImJvb2xlYW4iLCBsZW5ndGgpID09IDApCiAgICAgICAgc2hvcnR5ID0gJ1onOwogICAgICBlbHNlIGlmIChzdHJuY21wIChuYW1lLCAiYnl0ZSIsIGxlbmd0aCkgPT0gMCkKICAgICAgICBzaG9ydHkgPSAnQic7CiAgICAgIGJyZWFrOwogICAgY2FzZSAnYyc6CiAgICAgIGlmIChzdHJuY21wIChuYW1lLCAiY2hhciIsIGxlbmd0aCkgPT0gMCkKICAgICAgICBzaG9ydHkgPSAnQyc7CiAgICAgIGJyZWFrOwogICAgY2FzZSAnZCc6CiAgICAgIGlmIChzdHJuY21wIChuYW1lLCAiZG91YmxlIiwgbGVuZ3RoKSA9PSAwKQogICAgICAgIHNob3J0eSA9ICdEJzsKICAgICAgYnJlYWs7CiAgICBjYXNlICdmJzoKICAgICAgaWYgKHN0cm5jbXAgKG5hbWUsICJmbG9hdCIsIGxlbmd0aCkgPT0gMCkKICAgICAgICBzaG9ydHkgPSAnRic7CiAgICAgIGJyZWFrOwogICAgY2FzZSAnaSc6CiAgICAgIGlmIChzdHJuY21wIChuYW1lLCAiaW50IiwgbGVuZ3RoKSA9PSAwKQogICAgICAgIHNob3J0eSA9ICdJJzsKICAgICAgYnJlYWs7CiAgICBjYXNlICdsJzoKICAgICAgaWYgKHN0cm5jbXAgKG5hbWUsICJsb25nIiwgbGVuZ3RoKSA9PSAwKQogICAgICAgIHNob3J0eSA9ICdKJzsKICAgICAgYnJlYWs7CiAgICBjYXNlICdzJzoKICAgICAgaWYgKHN0cm5jbXAgKG5hbWUsICJzaG9ydCIsIGxlbmd0aCkgPT0gMCkKICAgICAgICBzaG9ydHkgPSAnUyc7CiAgICAgIGJyZWFrOwogICAgY2FzZSAndic6CiAgICAgIGlmIChzdHJuY21wIChuYW1lLCAidm9pZCIsIGxlbmd0aCkgPT0gMCkKICAgICAgICBzaG9ydHkgPSAnVic7CiAgICAgIGJyZWFrOwogIH0KCiAgaWYgKHNob3J0eSAhPSAnXFwwJykKICB7CiAgICBnX3N0cmluZ19hcHBlbmRfYyAocywgc2hvcnR5KTsKCiAgICByZXR1cm47CiAgfQoKICBpZiAobGVuZ3RoID4gMiAmJiBuYW1lW2xlbmd0aCAtIDJdID09ICdbJyAmJiBuYW1lW2xlbmd0aCAtIDFdID09ICddJykKICB7CiAgICBnX3N0cmluZ19hcHBlbmRfYyAocywgJ1snKTsKICAgIGFwcGVuZF9qbmlfdHlwZV9uYW1lIChzLCBuYW1lLCBsZW5ndGggLSAyKTsKCiAgICByZXR1cm47CiAgfQoKICBnX3N0cmluZ19hcHBlbmRfYyAocywgJ0wnKTsKCiAgZm9yIChpID0gMDsgaSAhPSBsZW5ndGg7IGkrKykKICB7CiAgICBnY2hhciBjaCA9IG5hbWVbaV07CiAgICBpZiAoY2ggIT0gJy4nKQogICAgICBnX3N0cmluZ19hcHBlbmRfYyAocywgY2gpOwogICAgZWxzZQogICAgICBnX3N0cmluZ19hcHBlbmRfYyAocywgJy8nKTsKICB9CgogIGdfc3RyaW5nX2FwcGVuZF9jIChzLCAnOycpOwp9CgpzdGF0aWMgdm9pZApzdGRfc3RyaW5nX2Rlc3Ryb3kgKFN0ZFN0cmluZyAqIHN0cikKewogIGJvb2wgaXNfbGFyZ2UgPSAoc3RyLT5mbGFncyAmIDEpICE9IDA7CiAgaWYgKGlzX2xhcmdlKQogICAgY3h4X2RlbGV0ZSAoc3RyLT5sYXJnZS5kYXRhKTsKfQoKc3RhdGljIGdjaGFyICoKc3RkX3N0cmluZ19nZXRfZGF0YSAoU3RkU3RyaW5nICogc3RyKQp7CiAgYm9vbCBpc19sYXJnZSA9IChzdHItPmZsYWdzICYgMSkgIT0gMDsKICByZXR1cm4gaXNfbGFyZ2UgPyBzdHItPmxhcmdlLmRhdGEgOiBzdHItPnRpbnkuZGF0YTsKfQpgLCB7CiAgICAgIGN1cnJlbnRfYmFja3RyYWNlOiBNZW1vcnkuYWxsb2MoUHJvY2Vzcy5wb2ludGVyU2l6ZSksCiAgICAgIHBlcmZvcm1fYXJ0X3RocmVhZF9zdGF0ZV90cmFuc2l0aW9uOiBwZXJmb3JtSW1wbCwKICAgICAgYXJ0X3RocmVhZF9nZXRfbG9uZ19qdW1wX2NvbnRleHQ6IGFwaTJbImFydDo6VGhyZWFkOjpHZXRMb25nSnVtcENvbnRleHQiXSwKICAgICAgYXJ0X3N0YWNrX3Zpc2l0b3JfaW5pdDogYXBpMlsiYXJ0OjpTdGFja1Zpc2l0b3I6OlN0YWNrVmlzaXRvciJdLAogICAgICBhcnRfc3RhY2tfdmlzaXRvcl93YWxrX3N0YWNrOiBhcGkyWyJhcnQ6OlN0YWNrVmlzaXRvcjo6V2Fsa1N0YWNrIl0sCiAgICAgIGFydF9zdGFja192aXNpdG9yX2dldF9tZXRob2Q6IGFwaTJbImFydDo6U3RhY2tWaXNpdG9yOjpHZXRNZXRob2QiXSwKICAgICAgYXJ0X3N0YWNrX3Zpc2l0b3JfZGVzY3JpYmVfbG9jYXRpb246IGFwaTJbImFydDo6U3RhY2tWaXNpdG9yOjpEZXNjcmliZUxvY2F0aW9uIl0sCiAgICAgIHRyYW5zbGF0ZV9tZXRob2Q6IGFydENvbnRyb2xsZXIucmVwbGFjZWRNZXRob2RzLnRyYW5zbGF0ZSwKICAgICAgdHJhbnNsYXRlX2xvY2F0aW9uOiBhcGkyWyJhcnQ6Ok1vbml0b3I6OlRyYW5zbGF0ZUxvY2F0aW9uIl0sCiAgICAgIGdldF9jbGFzc19sb2NhdGlvbjogYXBpMlsiYXJ0OjptaXJyb3I6OkNsYXNzOjpHZXRMb2NhdGlvbiJdLAogICAgICBjeHhfZGVsZXRlOiBhcGkyLiRkZWxldGUsCiAgICAgIHN0cnRvdWw6IFByb2Nlc3MuZ2V0TW9kdWxlQnlOYW1lKCJsaWJjLnNvIikuZ2V0RXhwb3J0QnlOYW1lKCJzdHJ0b3VsIikKICAgIH0pOwogICAgY29uc3QgX2NyZWF0ZSA9IG5ldyBOYXRpdmVGdW5jdGlvbihjbTIuX2NyZWF0ZSwgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAidWludCJdLCBuYXRpdmVGdW5jdGlvbk9wdGlvbnMzKTsKICAgIGNvbnN0IF9kZXN0cm95ID0gbmV3IE5hdGl2ZUZ1bmN0aW9uKGNtMi5fZGVzdHJveSwgInZvaWQiLCBbInBvaW50ZXIiXSwgbmF0aXZlRnVuY3Rpb25PcHRpb25zMyk7CiAgICBjb25zdCBmYXN0T3B0aW9ucyA9IHsgZXhjZXB0aW9uczogInByb3BhZ2F0ZSIsIHNjaGVkdWxpbmc6ICJleGNsdXNpdmUiIH07CiAgICBjb25zdCBfZ2V0SWQgPSBuZXcgTmF0aXZlRnVuY3Rpb24oY20yLl9nZXRfaWQsICJwb2ludGVyIiwgWyJwb2ludGVyIl0sIGZhc3RPcHRpb25zKTsKICAgIGNvbnN0IF9nZXRGcmFtZXMgPSBuZXcgTmF0aXZlRnVuY3Rpb24oY20yLl9nZXRfZnJhbWVzLCAicG9pbnRlciIsIFsicG9pbnRlciJdLCBmYXN0T3B0aW9ucyk7CiAgICBjb25zdCBwZXJmb3JtVGhyZWFkU3RhdGVUcmFuc2l0aW9uID0gbWFrZUFydFRocmVhZFN0YXRlVHJhbnNpdGlvbkltcGwodm0zLCBlbnYsIGNtMi5fb25fdGhyZWFkX3N0YXRlX3RyYW5zaXRpb25fY29tcGxldGUpOwogICAgY20yLl9wZXJmb3JtRGF0YSA9IHBlcmZvcm1UaHJlYWRTdGF0ZVRyYW5zaXRpb247CiAgICBwZXJmb3JtSW1wbC53cml0ZVBvaW50ZXIocGVyZm9ybVRocmVhZFN0YXRlVHJhbnNpdGlvbik7CiAgICBjbTIuYmFja3RyYWNlID0gKGVudjIsIGxpbWl0KSA9PiB7CiAgICAgIGNvbnN0IGhhbmRsZSA9IF9jcmVhdGUoZW52MiwgbGltaXQpOwogICAgICBjb25zdCBidCA9IG5ldyBCYWNrdHJhY2UoaGFuZGxlKTsKICAgICAgU2NyaXB0LmJpbmRXZWFrKGJ0LCBkZXN0cm95LmJpbmQobnVsbCwgaGFuZGxlKSk7CiAgICAgIHJldHVybiBidDsKICAgIH07CiAgICBmdW5jdGlvbiBkZXN0cm95KGhhbmRsZSkgewogICAgICBfZGVzdHJveShoYW5kbGUpOwogICAgfQogICAgY20yLmdldElkID0gKGhhbmRsZSkgPT4gewogICAgICByZXR1cm4gX2dldElkKGhhbmRsZSkucmVhZFV0ZjhTdHJpbmcoKTsKICAgIH07CiAgICBjbTIuZ2V0RnJhbWVzID0gKGhhbmRsZSkgPT4gewogICAgICByZXR1cm4gSlNPTi5wYXJzZShfZ2V0RnJhbWVzKGhhbmRsZSkucmVhZFV0ZjhTdHJpbmcoKSk7CiAgICB9OwogICAgcmV0dXJuIGNtMjsKICB9CiAgdmFyIEJhY2t0cmFjZSA9IGNsYXNzIHsKICAgIGNvbnN0cnVjdG9yKGhhbmRsZSkgewogICAgICB0aGlzLmhhbmRsZSA9IGhhbmRsZTsKICAgIH0KICAgIGdldCBpZCgpIHsKICAgICAgcmV0dXJuIGJhY2t0cmFjZU1vZHVsZS5nZXRJZCh0aGlzLmhhbmRsZSk7CiAgICB9CiAgICBnZXQgZnJhbWVzKCkgewogICAgICByZXR1cm4gYmFja3RyYWNlTW9kdWxlLmdldEZyYW1lcyh0aGlzLmhhbmRsZSk7CiAgICB9CiAgfTsKICBmdW5jdGlvbiByZXZlcnRHbG9iYWxQYXRjaGVzKCkgewogICAgcGF0Y2hlZENsYXNzZXMuZm9yRWFjaCgoZW50cnkpID0+IHsKICAgICAgZW50cnkudnRhYmxlUHRyLndyaXRlUG9pbnRlcihlbnRyeS52dGFibGUpOwogICAgICBlbnRyeS52dGFibGVDb3VudFB0ci53cml0ZVMzMihlbnRyeS52dGFibGVDb3VudCk7CiAgICB9KTsKICAgIHBhdGNoZWRDbGFzc2VzLmNsZWFyKCk7CiAgICBmb3IgKGNvbnN0IGludGVyY2VwdG9yIG9mIGFydFF1aWNrSW50ZXJjZXB0b3JzLnNwbGljZSgwKSkgewogICAgICBpbnRlcmNlcHRvci5kZWFjdGl2YXRlKCk7CiAgICB9CiAgICBmb3IgKGNvbnN0IGhvb2sgb2YgaW5saW5lSG9va3Muc3BsaWNlKDApKSB7CiAgICAgIGhvb2sucmV2ZXJ0KCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHVud3JhcE1ldGhvZElkKG1ldGhvZElkKSB7CiAgICBjb25zdCBhcGkyID0gZ2V0QXBpKCk7CiAgICBjb25zdCBydW50aW1lT2Zmc2V0ID0gZ2V0QXJ0UnVudGltZVNwZWMoYXBpMikub2Zmc2V0OwogICAgY29uc3Qgam5pSWRNYW5hZ2VyT2Zmc2V0ID0gcnVudGltZU9mZnNldC5qbmlJZE1hbmFnZXI7CiAgICBjb25zdCBqbmlJZHNJbmRpcmVjdGlvbk9mZnNldCA9IHJ1bnRpbWVPZmZzZXQuam5pSWRzSW5kaXJlY3Rpb247CiAgICBpZiAoam5pSWRNYW5hZ2VyT2Zmc2V0ICE9PSBudWxsICYmIGpuaUlkc0luZGlyZWN0aW9uT2Zmc2V0ICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IHJ1bnRpbWUyID0gYXBpMi5hcnRSdW50aW1lOwogICAgICBjb25zdCBqbmlJZHNJbmRpcmVjdGlvbiA9IHJ1bnRpbWUyLmFkZChqbmlJZHNJbmRpcmVjdGlvbk9mZnNldCkucmVhZEludCgpOwogICAgICBpZiAoam5pSWRzSW5kaXJlY3Rpb24gIT09IGtQb2ludGVyKSB7CiAgICAgICAgY29uc3Qgam5pSWRNYW5hZ2VyID0gcnVudGltZTIuYWRkKGpuaUlkTWFuYWdlck9mZnNldCkucmVhZFBvaW50ZXIoKTsKICAgICAgICByZXR1cm4gYXBpMlsiYXJ0Ojpqbmk6OkpuaUlkTWFuYWdlcjo6RGVjb2RlTWV0aG9kSWQiXShqbmlJZE1hbmFnZXIsIG1ldGhvZElkKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG1ldGhvZElkOwogIH0KICB2YXIgYXJ0UXVpY2tDb2RlUmVwbGFjZW1lbnRUcmFtcG9saW5lV3JpdGVycyA9IHsKICAgIGlhMzI6IHdyaXRlQXJ0UXVpY2tDb2RlUmVwbGFjZW1lbnRUcmFtcG9saW5lSUEzMiwKICAgIHg2NDogd3JpdGVBcnRRdWlja0NvZGVSZXBsYWNlbWVudFRyYW1wb2xpbmVYNjQsCiAgICBhcm06IHdyaXRlQXJ0UXVpY2tDb2RlUmVwbGFjZW1lbnRUcmFtcG9saW5lQXJtLAogICAgYXJtNjQ6IHdyaXRlQXJ0UXVpY2tDb2RlUmVwbGFjZW1lbnRUcmFtcG9saW5lQXJtNjQKICB9OwogIGZ1bmN0aW9uIHdyaXRlQXJ0UXVpY2tDb2RlUmVwbGFjZW1lbnRUcmFtcG9saW5lSUEzMih0cmFtcG9saW5lLCB0YXJnZXQsIHJlZGlyZWN0U2l6ZSwgY29uc3RyYWludHMsIHZtMykgewogICAgY29uc3QgdGhyZWFkT2Zmc2V0cyA9IGdldEFydFRocmVhZFNwZWModm0zKS5vZmZzZXQ7CiAgICBjb25zdCBhcnRNZXRob2RPZmZzZXRzID0gZ2V0QXJ0TWV0aG9kU3BlYyh2bTMpLm9mZnNldDsKICAgIGxldCBvZmZzZXQ7CiAgICBNZW1vcnkucGF0Y2hDb2RlKHRyYW1wb2xpbmUsIDEyOCwgKGNvZGUyKSA9PiB7CiAgICAgIGNvbnN0IHdyaXRlciA9IG5ldyBYODZXcml0ZXIoY29kZTIsIHsgcGM6IHRyYW1wb2xpbmUgfSk7CiAgICAgIGNvbnN0IHJlbG9jYXRvciA9IG5ldyBYODZSZWxvY2F0b3IodGFyZ2V0LCB3cml0ZXIpOwogICAgICBjb25zdCBmeHNhdmUgPSBbMTUsIDE3NCwgNCwgMzZdOwogICAgICBjb25zdCBmeHJzdG9yID0gWzE1LCAxNzQsIDEyLCAzNl07CiAgICAgIHdyaXRlci5wdXRQdXNoYXgoKTsKICAgICAgd3JpdGVyLnB1dE1vdlJlZ1JlZygiZWJwIiwgImVzcCIpOwogICAgICB3cml0ZXIucHV0QW5kUmVnVTMyKCJlc3AiLCA0Mjk0OTY3MjgwKTsKICAgICAgd3JpdGVyLnB1dFN1YlJlZ0ltbSgiZXNwIiwgNTEyKTsKICAgICAgd3JpdGVyLnB1dEJ5dGVzKGZ4c2F2ZSk7CiAgICAgIHdyaXRlci5wdXRNb3ZSZWdGc1UzMlB0cigiZWJ4IiwgdGhyZWFkT2Zmc2V0cy5zZWxmKTsKICAgICAgd3JpdGVyLnB1dENhbGxBZGRyZXNzV2l0aEFsaWduZWRBcmd1bWVudHMoYXJ0Q29udHJvbGxlci5yZXBsYWNlZE1ldGhvZHMuZmluZFJlcGxhY2VtZW50RnJvbVF1aWNrQ29kZSwgWyJlYXgiLCAiZWJ4Il0pOwogICAgICB3cml0ZXIucHV0VGVzdFJlZ1JlZygiZWF4IiwgImVheCIpOwogICAgICB3cml0ZXIucHV0SmNjU2hvcnRMYWJlbCgiamUiLCAicmVzdG9yZV9yZWdpc3RlcnMiLCAibm8taGludCIpOwogICAgICB3cml0ZXIucHV0TW92UmVnT2Zmc2V0UHRyUmVnKCJlYnAiLCA3ICogNCwgImVheCIpOwogICAgICB3cml0ZXIucHV0TGFiZWwoInJlc3RvcmVfcmVnaXN0ZXJzIik7CiAgICAgIHdyaXRlci5wdXRCeXRlcyhmeHJzdG9yKTsKICAgICAgd3JpdGVyLnB1dE1vdlJlZ1JlZygiZXNwIiwgImVicCIpOwogICAgICB3cml0ZXIucHV0UG9wYXgoKTsKICAgICAgd3JpdGVyLnB1dEpjY1Nob3J0TGFiZWwoImpuZSIsICJpbnZva2VfcmVwbGFjZW1lbnQiLCAibm8taGludCIpOwogICAgICBkbyB7CiAgICAgICAgb2Zmc2V0ID0gcmVsb2NhdG9yLnJlYWRPbmUoKTsKICAgICAgfSB3aGlsZSAob2Zmc2V0IDwgcmVkaXJlY3RTaXplICYmICFyZWxvY2F0b3IuZW9pKTsKICAgICAgcmVsb2NhdG9yLndyaXRlQWxsKCk7CiAgICAgIGlmICghcmVsb2NhdG9yLmVvaSkgewogICAgICAgIHdyaXRlci5wdXRKbXBBZGRyZXNzKHRhcmdldC5hZGQob2Zmc2V0KSk7CiAgICAgIH0KICAgICAgd3JpdGVyLnB1dExhYmVsKCJpbnZva2VfcmVwbGFjZW1lbnQiKTsKICAgICAgd3JpdGVyLnB1dEptcFJlZ09mZnNldFB0cigiZWF4IiwgYXJ0TWV0aG9kT2Zmc2V0cy5xdWlja0NvZGUpOwogICAgICB3cml0ZXIuZmx1c2goKTsKICAgIH0pOwogICAgcmV0dXJuIG9mZnNldDsKICB9CiAgZnVuY3Rpb24gd3JpdGVBcnRRdWlja0NvZGVSZXBsYWNlbWVudFRyYW1wb2xpbmVYNjQodHJhbXBvbGluZSwgdGFyZ2V0LCByZWRpcmVjdFNpemUsIGNvbnN0cmFpbnRzLCB2bTMpIHsKICAgIGNvbnN0IHRocmVhZE9mZnNldHMgPSBnZXRBcnRUaHJlYWRTcGVjKHZtMykub2Zmc2V0OwogICAgY29uc3QgYXJ0TWV0aG9kT2Zmc2V0cyA9IGdldEFydE1ldGhvZFNwZWModm0zKS5vZmZzZXQ7CiAgICBsZXQgb2Zmc2V0OwogICAgTWVtb3J5LnBhdGNoQ29kZSh0cmFtcG9saW5lLCAyNTYsIChjb2RlMikgPT4gewogICAgICBjb25zdCB3cml0ZXIgPSBuZXcgWDg2V3JpdGVyKGNvZGUyLCB7IHBjOiB0cmFtcG9saW5lIH0pOwogICAgICBjb25zdCByZWxvY2F0b3IgPSBuZXcgWDg2UmVsb2NhdG9yKHRhcmdldCwgd3JpdGVyKTsKICAgICAgY29uc3QgZnhzYXZlID0gWzE1LCAxNzQsIDQsIDM2XTsKICAgICAgY29uc3QgZnhyc3RvciA9IFsxNSwgMTc0LCAxMiwgMzZdOwogICAgICB3cml0ZXIucHV0UHVzaGF4KCk7CiAgICAgIHdyaXRlci5wdXRNb3ZSZWdSZWcoInJicCIsICJyc3AiKTsKICAgICAgd3JpdGVyLnB1dEFuZFJlZ1UzMigicnNwIiwgNDI5NDk2NzI4MCk7CiAgICAgIHdyaXRlci5wdXRTdWJSZWdJbW0oInJzcCIsIDUxMik7CiAgICAgIHdyaXRlci5wdXRCeXRlcyhmeHNhdmUpOwogICAgICB3cml0ZXIucHV0TW92UmVnR3NVMzJQdHIoInJieCIsIHRocmVhZE9mZnNldHMuc2VsZik7CiAgICAgIHdyaXRlci5wdXRDYWxsQWRkcmVzc1dpdGhBbGlnbmVkQXJndW1lbnRzKGFydENvbnRyb2xsZXIucmVwbGFjZWRNZXRob2RzLmZpbmRSZXBsYWNlbWVudEZyb21RdWlja0NvZGUsIFsicmRpIiwgInJieCJdKTsKICAgICAgd3JpdGVyLnB1dFRlc3RSZWdSZWcoInJheCIsICJyYXgiKTsKICAgICAgd3JpdGVyLnB1dEpjY1Nob3J0TGFiZWwoImplIiwgInJlc3RvcmVfcmVnaXN0ZXJzIiwgIm5vLWhpbnQiKTsKICAgICAgd3JpdGVyLnB1dE1vdlJlZ09mZnNldFB0clJlZygicmJwIiwgOCAqIDgsICJyYXgiKTsKICAgICAgd3JpdGVyLnB1dExhYmVsKCJyZXN0b3JlX3JlZ2lzdGVycyIpOwogICAgICB3cml0ZXIucHV0Qnl0ZXMoZnhyc3Rvcik7CiAgICAgIHdyaXRlci5wdXRNb3ZSZWdSZWcoInJzcCIsICJyYnAiKTsKICAgICAgd3JpdGVyLnB1dFBvcGF4KCk7CiAgICAgIHdyaXRlci5wdXRKY2NTaG9ydExhYmVsKCJqbmUiLCAiaW52b2tlX3JlcGxhY2VtZW50IiwgIm5vLWhpbnQiKTsKICAgICAgZG8gewogICAgICAgIG9mZnNldCA9IHJlbG9jYXRvci5yZWFkT25lKCk7CiAgICAgIH0gd2hpbGUgKG9mZnNldCA8IHJlZGlyZWN0U2l6ZSAmJiAhcmVsb2NhdG9yLmVvaSk7CiAgICAgIHJlbG9jYXRvci53cml0ZUFsbCgpOwogICAgICBpZiAoIXJlbG9jYXRvci5lb2kpIHsKICAgICAgICB3cml0ZXIucHV0Sm1wQWRkcmVzcyh0YXJnZXQuYWRkKG9mZnNldCkpOwogICAgICB9CiAgICAgIHdyaXRlci5wdXRMYWJlbCgiaW52b2tlX3JlcGxhY2VtZW50Iik7CiAgICAgIHdyaXRlci5wdXRKbXBSZWdPZmZzZXRQdHIoInJkaSIsIGFydE1ldGhvZE9mZnNldHMucXVpY2tDb2RlKTsKICAgICAgd3JpdGVyLmZsdXNoKCk7CiAgICB9KTsKICAgIHJldHVybiBvZmZzZXQ7CiAgfQogIGZ1bmN0aW9uIHdyaXRlQXJ0UXVpY2tDb2RlUmVwbGFjZW1lbnRUcmFtcG9saW5lQXJtKHRyYW1wb2xpbmUsIHRhcmdldCwgcmVkaXJlY3RTaXplLCBjb25zdHJhaW50cywgdm0zKSB7CiAgICBjb25zdCBhcnRNZXRob2RPZmZzZXRzID0gZ2V0QXJ0TWV0aG9kU3BlYyh2bTMpLm9mZnNldDsKICAgIGNvbnN0IHRhcmdldEFkZHJlc3MgPSB0YXJnZXQuYW5kKFRIVU1CX0JJVF9SRU1PVkFMX01BU0spOwogICAgbGV0IG9mZnNldDsKICAgIE1lbW9yeS5wYXRjaENvZGUodHJhbXBvbGluZSwgMTI4LCAoY29kZTIpID0+IHsKICAgICAgY29uc3Qgd3JpdGVyID0gbmV3IFRodW1iV3JpdGVyKGNvZGUyLCB7IHBjOiB0cmFtcG9saW5lIH0pOwogICAgICBjb25zdCByZWxvY2F0b3IgPSBuZXcgVGh1bWJSZWxvY2F0b3IodGFyZ2V0QWRkcmVzcywgd3JpdGVyKTsKICAgICAgY29uc3QgdnB1c2hGcFJlZ3MgPSBbNDUsIDIzNywgMTYsIDEwXTsKICAgICAgY29uc3QgdnBvcEZwUmVncyA9IFsxODksIDIzNiwgMTYsIDEwXTsKICAgICAgd3JpdGVyLnB1dFB1c2hSZWdzKFsKICAgICAgICAicjEiLAogICAgICAgICJyMiIsCiAgICAgICAgInIzIiwKICAgICAgICAicjUiLAogICAgICAgICJyNiIsCiAgICAgICAgInI3IiwKICAgICAgICAicjgiLAogICAgICAgICJyMTAiLAogICAgICAgICJyMTEiLAogICAgICAgICJsciIKICAgICAgXSk7CiAgICAgIHdyaXRlci5wdXRCeXRlcyh2cHVzaEZwUmVncyk7CiAgICAgIHdyaXRlci5wdXRTdWJSZWdSZWdJbW0oInNwIiwgInNwIiwgOCk7CiAgICAgIHdyaXRlci5wdXRTdHJSZWdSZWdPZmZzZXQoInIwIiwgInNwIiwgMCk7CiAgICAgIHdyaXRlci5wdXRDYWxsQWRkcmVzc1dpdGhBcmd1bWVudHMoYXJ0Q29udHJvbGxlci5yZXBsYWNlZE1ldGhvZHMuZmluZFJlcGxhY2VtZW50RnJvbVF1aWNrQ29kZSwgWyJyMCIsICJyOSJdKTsKICAgICAgd3JpdGVyLnB1dENtcFJlZ0ltbSgicjAiLCAwKTsKICAgICAgd3JpdGVyLnB1dEJDb25kTGFiZWwoImVxIiwgInJlc3RvcmVfcmVnaXN0ZXJzIik7CiAgICAgIHdyaXRlci5wdXRTdHJSZWdSZWdPZmZzZXQoInIwIiwgInNwIiwgMCk7CiAgICAgIHdyaXRlci5wdXRMYWJlbCgicmVzdG9yZV9yZWdpc3RlcnMiKTsKICAgICAgd3JpdGVyLnB1dExkclJlZ1JlZ09mZnNldCgicjAiLCAic3AiLCAwKTsKICAgICAgd3JpdGVyLnB1dEFkZFJlZ1JlZ0ltbSgic3AiLCAic3AiLCA4KTsKICAgICAgd3JpdGVyLnB1dEJ5dGVzKHZwb3BGcFJlZ3MpOwogICAgICB3cml0ZXIucHV0UG9wUmVncyhbCiAgICAgICAgImxyIiwKICAgICAgICAicjExIiwKICAgICAgICAicjEwIiwKICAgICAgICAicjgiLAogICAgICAgICJyNyIsCiAgICAgICAgInI2IiwKICAgICAgICAicjUiLAogICAgICAgICJyMyIsCiAgICAgICAgInIyIiwKICAgICAgICAicjEiCiAgICAgIF0pOwogICAgICB3cml0ZXIucHV0QkNvbmRMYWJlbCgibmUiLCAiaW52b2tlX3JlcGxhY2VtZW50Iik7CiAgICAgIGRvIHsKICAgICAgICBvZmZzZXQgPSByZWxvY2F0b3IucmVhZE9uZSgpOwogICAgICB9IHdoaWxlIChvZmZzZXQgPCByZWRpcmVjdFNpemUgJiYgIXJlbG9jYXRvci5lb2kpOwogICAgICByZWxvY2F0b3Iud3JpdGVBbGwoKTsKICAgICAgaWYgKCFyZWxvY2F0b3IuZW9pKSB7CiAgICAgICAgd3JpdGVyLnB1dExkclJlZ0FkZHJlc3MoInBjIiwgdGFyZ2V0LmFkZChvZmZzZXQpKTsKICAgICAgfQogICAgICB3cml0ZXIucHV0TGFiZWwoImludm9rZV9yZXBsYWNlbWVudCIpOwogICAgICB3cml0ZXIucHV0TGRyUmVnUmVnT2Zmc2V0KCJwYyIsICJyMCIsIGFydE1ldGhvZE9mZnNldHMucXVpY2tDb2RlKTsKICAgICAgd3JpdGVyLmZsdXNoKCk7CiAgICB9KTsKICAgIHJldHVybiBvZmZzZXQ7CiAgfQogIGZ1bmN0aW9uIHdyaXRlQXJ0UXVpY2tDb2RlUmVwbGFjZW1lbnRUcmFtcG9saW5lQXJtNjQodHJhbXBvbGluZSwgdGFyZ2V0LCByZWRpcmVjdFNpemUsIHsgYXZhaWxhYmxlU2NyYXRjaFJlZ3MgfSwgdm0zKSB7CiAgICBjb25zdCBhcnRNZXRob2RPZmZzZXRzID0gZ2V0QXJ0TWV0aG9kU3BlYyh2bTMpLm9mZnNldDsKICAgIGxldCBvZmZzZXQ7CiAgICBNZW1vcnkucGF0Y2hDb2RlKHRyYW1wb2xpbmUsIDI1NiwgKGNvZGUyKSA9PiB7CiAgICAgIGNvbnN0IHdyaXRlciA9IG5ldyBBcm02NFdyaXRlcihjb2RlMiwgeyBwYzogdHJhbXBvbGluZSB9KTsKICAgICAgY29uc3QgcmVsb2NhdG9yID0gbmV3IEFybTY0UmVsb2NhdG9yKHRhcmdldCwgd3JpdGVyKTsKICAgICAgd3JpdGVyLnB1dFB1c2hSZWdSZWcoImQwIiwgImQxIik7CiAgICAgIHdyaXRlci5wdXRQdXNoUmVnUmVnKCJkMiIsICJkMyIpOwogICAgICB3cml0ZXIucHV0UHVzaFJlZ1JlZygiZDQiLCAiZDUiKTsKICAgICAgd3JpdGVyLnB1dFB1c2hSZWdSZWcoImQ2IiwgImQ3Iik7CiAgICAgIHdyaXRlci5wdXRQdXNoUmVnUmVnKCJ4MSIsICJ4MiIpOwogICAgICB3cml0ZXIucHV0UHVzaFJlZ1JlZygieDMiLCAieDQiKTsKICAgICAgd3JpdGVyLnB1dFB1c2hSZWdSZWcoIng1IiwgIng2Iik7CiAgICAgIHdyaXRlci5wdXRQdXNoUmVnUmVnKCJ4NyIsICJ4MjAiKTsKICAgICAgd3JpdGVyLnB1dFB1c2hSZWdSZWcoIngyMSIsICJ4MjIiKTsKICAgICAgd3JpdGVyLnB1dFB1c2hSZWdSZWcoIngyMyIsICJ4MjQiKTsKICAgICAgd3JpdGVyLnB1dFB1c2hSZWdSZWcoIngyNSIsICJ4MjYiKTsKICAgICAgd3JpdGVyLnB1dFB1c2hSZWdSZWcoIngyNyIsICJ4MjgiKTsKICAgICAgd3JpdGVyLnB1dFB1c2hSZWdSZWcoIngyOSIsICJsciIpOwogICAgICB3cml0ZXIucHV0U3ViUmVnUmVnSW1tKCJzcCIsICJzcCIsIDE2KTsKICAgICAgd3JpdGVyLnB1dFN0clJlZ1JlZ09mZnNldCgieDAiLCAic3AiLCAwKTsKICAgICAgd3JpdGVyLnB1dENhbGxBZGRyZXNzV2l0aEFyZ3VtZW50cyhhcnRDb250cm9sbGVyLnJlcGxhY2VkTWV0aG9kcy5maW5kUmVwbGFjZW1lbnRGcm9tUXVpY2tDb2RlLCBbIngwIiwgIngxOSJdKTsKICAgICAgd3JpdGVyLnB1dENtcFJlZ1JlZygieDAiLCAieHpyIik7CiAgICAgIHdyaXRlci5wdXRCQ29uZExhYmVsKCJlcSIsICJyZXN0b3JlX3JlZ2lzdGVycyIpOwogICAgICB3cml0ZXIucHV0U3RyUmVnUmVnT2Zmc2V0KCJ4MCIsICJzcCIsIDApOwogICAgICB3cml0ZXIucHV0TGFiZWwoInJlc3RvcmVfcmVnaXN0ZXJzIik7CiAgICAgIHdyaXRlci5wdXRMZHJSZWdSZWdPZmZzZXQoIngwIiwgInNwIiwgMCk7CiAgICAgIHdyaXRlci5wdXRBZGRSZWdSZWdJbW0oInNwIiwgInNwIiwgMTYpOwogICAgICB3cml0ZXIucHV0UG9wUmVnUmVnKCJ4MjkiLCAibHIiKTsKICAgICAgd3JpdGVyLnB1dFBvcFJlZ1JlZygieDI3IiwgIngyOCIpOwogICAgICB3cml0ZXIucHV0UG9wUmVnUmVnKCJ4MjUiLCAieDI2Iik7CiAgICAgIHdyaXRlci5wdXRQb3BSZWdSZWcoIngyMyIsICJ4MjQiKTsKICAgICAgd3JpdGVyLnB1dFBvcFJlZ1JlZygieDIxIiwgIngyMiIpOwogICAgICB3cml0ZXIucHV0UG9wUmVnUmVnKCJ4NyIsICJ4MjAiKTsKICAgICAgd3JpdGVyLnB1dFBvcFJlZ1JlZygieDUiLCAieDYiKTsKICAgICAgd3JpdGVyLnB1dFBvcFJlZ1JlZygieDMiLCAieDQiKTsKICAgICAgd3JpdGVyLnB1dFBvcFJlZ1JlZygieDEiLCAieDIiKTsKICAgICAgd3JpdGVyLnB1dFBvcFJlZ1JlZygiZDYiLCAiZDciKTsKICAgICAgd3JpdGVyLnB1dFBvcFJlZ1JlZygiZDQiLCAiZDUiKTsKICAgICAgd3JpdGVyLnB1dFBvcFJlZ1JlZygiZDIiLCAiZDMiKTsKICAgICAgd3JpdGVyLnB1dFBvcFJlZ1JlZygiZDAiLCAiZDEiKTsKICAgICAgd3JpdGVyLnB1dEJDb25kTGFiZWwoIm5lIiwgImludm9rZV9yZXBsYWNlbWVudCIpOwogICAgICBkbyB7CiAgICAgICAgb2Zmc2V0ID0gcmVsb2NhdG9yLnJlYWRPbmUoKTsKICAgICAgfSB3aGlsZSAob2Zmc2V0IDwgcmVkaXJlY3RTaXplICYmICFyZWxvY2F0b3IuZW9pKTsKICAgICAgcmVsb2NhdG9yLndyaXRlQWxsKCk7CiAgICAgIGlmICghcmVsb2NhdG9yLmVvaSkgewogICAgICAgIGNvbnN0IHNjcmF0Y2hSZWcgPSBBcnJheS5mcm9tKGF2YWlsYWJsZVNjcmF0Y2hSZWdzKVswXTsKICAgICAgICB3cml0ZXIucHV0TGRyUmVnQWRkcmVzcyhzY3JhdGNoUmVnLCB0YXJnZXQuYWRkKG9mZnNldCkpOwogICAgICAgIHdyaXRlci5wdXRCclJlZyhzY3JhdGNoUmVnKTsKICAgICAgfQogICAgICB3cml0ZXIucHV0TGFiZWwoImludm9rZV9yZXBsYWNlbWVudCIpOwogICAgICB3cml0ZXIucHV0TGRyUmVnUmVnT2Zmc2V0KCJ4MTYiLCAieDAiLCBhcnRNZXRob2RPZmZzZXRzLnF1aWNrQ29kZSk7CiAgICAgIHdyaXRlci5wdXRCclJlZygieDE2Iik7CiAgICAgIHdyaXRlci5mbHVzaCgpOwogICAgfSk7CiAgICByZXR1cm4gb2Zmc2V0OwogIH0KICB2YXIgYXJ0UXVpY2tDb2RlUHJvbG9ndWVXcml0ZXJzID0gewogICAgaWEzMjogd3JpdGVBcnRRdWlja0NvZGVQcm9sb2d1ZVg4NiwKICAgIHg2NDogd3JpdGVBcnRRdWlja0NvZGVQcm9sb2d1ZVg4NiwKICAgIGFybTogd3JpdGVBcnRRdWlja0NvZGVQcm9sb2d1ZUFybSwKICAgIGFybTY0OiB3cml0ZUFydFF1aWNrQ29kZVByb2xvZ3VlQXJtNjQKICB9OwogIGZ1bmN0aW9uIHdyaXRlQXJ0UXVpY2tDb2RlUHJvbG9ndWVYODYodGFyZ2V0LCB0cmFtcG9saW5lLCByZWRpcmVjdFNpemUpIHsKICAgIE1lbW9yeS5wYXRjaENvZGUodGFyZ2V0LCAxNiwgKGNvZGUyKSA9PiB7CiAgICAgIGNvbnN0IHdyaXRlciA9IG5ldyBYODZXcml0ZXIoY29kZTIsIHsgcGM6IHRhcmdldCB9KTsKICAgICAgd3JpdGVyLnB1dEptcEFkZHJlc3ModHJhbXBvbGluZSk7CiAgICAgIHdyaXRlci5mbHVzaCgpOwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIHdyaXRlQXJ0UXVpY2tDb2RlUHJvbG9ndWVBcm0odGFyZ2V0LCB0cmFtcG9saW5lLCByZWRpcmVjdFNpemUpIHsKICAgIGNvbnN0IHRhcmdldEFkZHJlc3MgPSB0YXJnZXQuYW5kKFRIVU1CX0JJVF9SRU1PVkFMX01BU0spOwogICAgTWVtb3J5LnBhdGNoQ29kZSh0YXJnZXRBZGRyZXNzLCAxNiwgKGNvZGUyKSA9PiB7CiAgICAgIGNvbnN0IHdyaXRlciA9IG5ldyBUaHVtYldyaXRlcihjb2RlMiwgeyBwYzogdGFyZ2V0QWRkcmVzcyB9KTsKICAgICAgd3JpdGVyLnB1dExkclJlZ0FkZHJlc3MoInBjIiwgdHJhbXBvbGluZS5vcigxKSk7CiAgICAgIHdyaXRlci5mbHVzaCgpOwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIHdyaXRlQXJ0UXVpY2tDb2RlUHJvbG9ndWVBcm02NCh0YXJnZXQsIHRyYW1wb2xpbmUsIHJlZGlyZWN0U2l6ZSkgewogICAgTWVtb3J5LnBhdGNoQ29kZSh0YXJnZXQsIDE2LCAoY29kZTIpID0+IHsKICAgICAgY29uc3Qgd3JpdGVyID0gbmV3IEFybTY0V3JpdGVyKGNvZGUyLCB7IHBjOiB0YXJnZXQgfSk7CiAgICAgIGlmIChyZWRpcmVjdFNpemUgPT09IDE2KSB7CiAgICAgICAgd3JpdGVyLnB1dExkclJlZ0FkZHJlc3MoIngxNiIsIHRyYW1wb2xpbmUpOwogICAgICB9IGVsc2UgewogICAgICAgIHdyaXRlci5wdXRBZHJwUmVnQWRkcmVzcygieDE2IiwgdHJhbXBvbGluZSk7CiAgICAgIH0KICAgICAgd3JpdGVyLnB1dEJyUmVnKCJ4MTYiKTsKICAgICAgd3JpdGVyLmZsdXNoKCk7CiAgICB9KTsKICB9CiAgdmFyIGFydFF1aWNrQ29kZUhvb2tSZWRpcmVjdFNpemUgPSB7CiAgICBpYTMyOiA1LAogICAgeDY0OiAxNiwKICAgIGFybTogOCwKICAgIGFybTY0OiAxNgogIH07CiAgdmFyIEFydFF1aWNrQ29kZUludGVyY2VwdG9yID0gY2xhc3MgewogICAgY29uc3RydWN0b3IocXVpY2tDb2RlKSB7CiAgICAgIHRoaXMucXVpY2tDb2RlID0gcXVpY2tDb2RlOwogICAgICB0aGlzLnF1aWNrQ29kZUFkZHJlc3MgPSBQcm9jZXNzLmFyY2ggPT09ICJhcm0iID8gcXVpY2tDb2RlLmFuZChUSFVNQl9CSVRfUkVNT1ZBTF9NQVNLKSA6IHF1aWNrQ29kZTsKICAgICAgdGhpcy5yZWRpcmVjdFNpemUgPSAwOwogICAgICB0aGlzLnRyYW1wb2xpbmUgPSBudWxsOwogICAgICB0aGlzLm92ZXJ3cml0dGVuUHJvbG9ndWUgPSBudWxsOwogICAgICB0aGlzLm92ZXJ3cml0dGVuUHJvbG9ndWVMZW5ndGggPSAwOwogICAgfQogICAgX2NhblJlbG9jYXRlQ29kZShyZWxvY2F0aW9uU2l6ZSwgY29uc3RyYWludHMpIHsKICAgICAgY29uc3QgV3JpdGVyID0gdGh1bmtXcml0ZXJzW1Byb2Nlc3MuYXJjaF07CiAgICAgIGNvbnN0IFJlbG9jYXRvciA9IHRodW5rUmVsb2NhdG9yc1tQcm9jZXNzLmFyY2hdOwogICAgICBjb25zdCB7IHF1aWNrQ29kZUFkZHJlc3MgfSA9IHRoaXM7CiAgICAgIGNvbnN0IHdyaXRlciA9IG5ldyBXcml0ZXIocXVpY2tDb2RlQWRkcmVzcyk7CiAgICAgIGNvbnN0IHJlbG9jYXRvciA9IG5ldyBSZWxvY2F0b3IocXVpY2tDb2RlQWRkcmVzcywgd3JpdGVyKTsKICAgICAgbGV0IG9mZnNldDsKICAgICAgaWYgKFByb2Nlc3MuYXJjaCA9PT0gImFybTY0IikgewogICAgICAgIGxldCBhdmFpbGFibGVTY3JhdGNoUmVncyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsieDE2IiwgIngxNyJdKTsKICAgICAgICBkbyB7CiAgICAgICAgICBjb25zdCBuZXh0T2Zmc2V0ID0gcmVsb2NhdG9yLnJlYWRPbmUoKTsKICAgICAgICAgIGNvbnN0IG5leHRTY3JhdGNoUmVncyA9IG5ldyBTZXQoYXZhaWxhYmxlU2NyYXRjaFJlZ3MpOwogICAgICAgICAgY29uc3QgeyByZWFkOiByZWFkMiwgd3JpdHRlbiB9ID0gcmVsb2NhdG9yLmlucHV0LnJlZ3NBY2Nlc3NlZDsKICAgICAgICAgIGZvciAoY29uc3QgcmVncyBvZiBbcmVhZDIsIHdyaXR0ZW5dKSB7CiAgICAgICAgICAgIGZvciAoY29uc3QgcmVnIG9mIHJlZ3MpIHsKICAgICAgICAgICAgICBsZXQgbmFtZTsKICAgICAgICAgICAgICBpZiAocmVnLnN0YXJ0c1dpdGgoInciKSkgewogICAgICAgICAgICAgICAgbmFtZSA9ICJ4IiArIHJlZy5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5hbWUgPSByZWc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5leHRTY3JhdGNoUmVncy5kZWxldGUobmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChuZXh0U2NyYXRjaFJlZ3Muc2l6ZSA9PT0gMCkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIG9mZnNldCA9IG5leHRPZmZzZXQ7CiAgICAgICAgICBhdmFpbGFibGVTY3JhdGNoUmVncyA9IG5leHRTY3JhdGNoUmVnczsKICAgICAgICB9IHdoaWxlIChvZmZzZXQgPCByZWxvY2F0aW9uU2l6ZSAmJiAhcmVsb2NhdG9yLmVvaSk7CiAgICAgICAgY29uc3RyYWludHMuYXZhaWxhYmxlU2NyYXRjaFJlZ3MgPSBhdmFpbGFibGVTY3JhdGNoUmVnczsKICAgICAgfSBlbHNlIHsKICAgICAgICBkbyB7CiAgICAgICAgICBvZmZzZXQgPSByZWxvY2F0b3IucmVhZE9uZSgpOwogICAgICAgIH0gd2hpbGUgKG9mZnNldCA8IHJlbG9jYXRpb25TaXplICYmICFyZWxvY2F0b3IuZW9pKTsKICAgICAgfQogICAgICByZXR1cm4gb2Zmc2V0ID49IHJlbG9jYXRpb25TaXplOwogICAgfQogICAgX2FsbG9jYXRlVHJhbXBvbGluZSgpIHsKICAgICAgaWYgKHRyYW1wb2xpbmVBbGxvY2F0b3IgPT09IG51bGwpIHsKICAgICAgICBjb25zdCB0cmFtcG9saW5lU2l6ZSA9IHBvaW50ZXJTaXplNSA9PT0gNCA/IDEyOCA6IDI1NjsKICAgICAgICB0cmFtcG9saW5lQWxsb2NhdG9yID0gbWFrZUFsbG9jYXRvcih0cmFtcG9saW5lU2l6ZSk7CiAgICAgIH0KICAgICAgY29uc3QgbWF4UmVkaXJlY3RTaXplID0gYXJ0UXVpY2tDb2RlSG9va1JlZGlyZWN0U2l6ZVtQcm9jZXNzLmFyY2hdOwogICAgICBsZXQgcmVkaXJlY3RTaXplLCBzcGVjOwogICAgICBsZXQgYWxpZ25tZW50ID0gMTsKICAgICAgY29uc3QgY29uc3RyYWludHMgPSB7fTsKICAgICAgaWYgKHBvaW50ZXJTaXplNSA9PT0gNCB8fCB0aGlzLl9jYW5SZWxvY2F0ZUNvZGUobWF4UmVkaXJlY3RTaXplLCBjb25zdHJhaW50cykpIHsKICAgICAgICByZWRpcmVjdFNpemUgPSBtYXhSZWRpcmVjdFNpemU7CiAgICAgICAgc3BlYyA9IHt9OwogICAgICB9IGVsc2UgewogICAgICAgIGxldCBtYXhEaXN0YW5jZTsKICAgICAgICBpZiAoUHJvY2Vzcy5hcmNoID09PSAieDY0IikgewogICAgICAgICAgcmVkaXJlY3RTaXplID0gNTsKICAgICAgICAgIG1heERpc3RhbmNlID0gWDg2X0pNUF9NQVhfRElTVEFOQ0U7CiAgICAgICAgfSBlbHNlIGlmIChQcm9jZXNzLmFyY2ggPT09ICJhcm02NCIpIHsKICAgICAgICAgIHJlZGlyZWN0U2l6ZSA9IDg7CiAgICAgICAgICBtYXhEaXN0YW5jZSA9IEFSTTY0X0FEUlBfTUFYX0RJU1RBTkNFOwogICAgICAgICAgYWxpZ25tZW50ID0gNDA5NjsKICAgICAgICB9CiAgICAgICAgc3BlYyA9IHsgbmVhcjogdGhpcy5xdWlja0NvZGVBZGRyZXNzLCBtYXhEaXN0YW5jZSB9OwogICAgICB9CiAgICAgIHRoaXMucmVkaXJlY3RTaXplID0gcmVkaXJlY3RTaXplOwogICAgICB0aGlzLnRyYW1wb2xpbmUgPSB0cmFtcG9saW5lQWxsb2NhdG9yLmFsbG9jYXRlU2xpY2Uoc3BlYywgYWxpZ25tZW50KTsKICAgICAgcmV0dXJuIGNvbnN0cmFpbnRzOwogICAgfQogICAgX2Rlc3Ryb3lUcmFtcG9saW5lKCkgewogICAgICB0cmFtcG9saW5lQWxsb2NhdG9yLmZyZWVTbGljZSh0aGlzLnRyYW1wb2xpbmUpOwogICAgfQogICAgYWN0aXZhdGUodm0zKSB7CiAgICAgIGNvbnN0IGNvbnN0cmFpbnRzID0gdGhpcy5fYWxsb2NhdGVUcmFtcG9saW5lKCk7CiAgICAgIGNvbnN0IHsgdHJhbXBvbGluZSwgcXVpY2tDb2RlLCByZWRpcmVjdFNpemUgfSA9IHRoaXM7CiAgICAgIGNvbnN0IHdyaXRlVHJhbXBvbGluZSA9IGFydFF1aWNrQ29kZVJlcGxhY2VtZW50VHJhbXBvbGluZVdyaXRlcnNbUHJvY2Vzcy5hcmNoXTsKICAgICAgY29uc3QgcHJvbG9ndWVMZW5ndGggPSB3cml0ZVRyYW1wb2xpbmUodHJhbXBvbGluZSwgcXVpY2tDb2RlLCByZWRpcmVjdFNpemUsIGNvbnN0cmFpbnRzLCB2bTMpOwogICAgICB0aGlzLm92ZXJ3cml0dGVuUHJvbG9ndWVMZW5ndGggPSBwcm9sb2d1ZUxlbmd0aDsKICAgICAgdGhpcy5vdmVyd3JpdHRlblByb2xvZ3VlID0gTWVtb3J5LmR1cCh0aGlzLnF1aWNrQ29kZUFkZHJlc3MsIHByb2xvZ3VlTGVuZ3RoKTsKICAgICAgY29uc3Qgd3JpdGVQcm9sb2d1ZSA9IGFydFF1aWNrQ29kZVByb2xvZ3VlV3JpdGVyc1tQcm9jZXNzLmFyY2hdOwogICAgICB3cml0ZVByb2xvZ3VlKHF1aWNrQ29kZSwgdHJhbXBvbGluZSwgcmVkaXJlY3RTaXplKTsKICAgIH0KICAgIGRlYWN0aXZhdGUoKSB7CiAgICAgIGNvbnN0IHsgcXVpY2tDb2RlQWRkcmVzcywgb3ZlcndyaXR0ZW5Qcm9sb2d1ZUxlbmd0aDogcHJvbG9ndWVMZW5ndGggfSA9IHRoaXM7CiAgICAgIGNvbnN0IFdyaXRlciA9IHRodW5rV3JpdGVyc1tQcm9jZXNzLmFyY2hdOwogICAgICBNZW1vcnkucGF0Y2hDb2RlKHF1aWNrQ29kZUFkZHJlc3MsIHByb2xvZ3VlTGVuZ3RoLCAoY29kZTIpID0+IHsKICAgICAgICBjb25zdCB3cml0ZXIgPSBuZXcgV3JpdGVyKGNvZGUyLCB7IHBjOiBxdWlja0NvZGVBZGRyZXNzIH0pOwogICAgICAgIGNvbnN0IHsgb3ZlcndyaXR0ZW5Qcm9sb2d1ZSB9ID0gdGhpczsKICAgICAgICB3cml0ZXIucHV0Qnl0ZXMob3ZlcndyaXR0ZW5Qcm9sb2d1ZS5yZWFkQnl0ZUFycmF5KHByb2xvZ3VlTGVuZ3RoKSk7CiAgICAgICAgd3JpdGVyLmZsdXNoKCk7CiAgICAgIH0pOwogICAgICB0aGlzLl9kZXN0cm95VHJhbXBvbGluZSgpOwogICAgfQogIH07CiAgZnVuY3Rpb24gaXNBcnRRdWlja0VudHJ5cG9pbnQoYWRkcmVzcykgewogICAgY29uc3QgYXBpMiA9IGdldEFwaSgpOwogICAgY29uc3QgeyBtb2R1bGU6IG0sIGFydENsYXNzTGlua2VyIH0gPSBhcGkyOwogICAgcmV0dXJuIGFkZHJlc3MuZXF1YWxzKGFydENsYXNzTGlua2VyLnF1aWNrR2VuZXJpY0puaVRyYW1wb2xpbmUpIHx8IGFkZHJlc3MuZXF1YWxzKGFydENsYXNzTGlua2VyLnF1aWNrVG9JbnRlcnByZXRlckJyaWRnZVRyYW1wb2xpbmUpIHx8IGFkZHJlc3MuZXF1YWxzKGFydENsYXNzTGlua2VyLnF1aWNrUmVzb2x1dGlvblRyYW1wb2xpbmUpIHx8IGFkZHJlc3MuZXF1YWxzKGFydENsYXNzTGlua2VyLnF1aWNrSW10Q29uZmxpY3RUcmFtcG9saW5lKSB8fCBhZGRyZXNzLmNvbXBhcmUobS5iYXNlKSA+PSAwICYmIGFkZHJlc3MuY29tcGFyZShtLmJhc2UuYWRkKG0uc2l6ZSkpIDwgMDsKICB9CiAgdmFyIEFydE1ldGhvZE1hbmdsZXIgPSBjbGFzcyB7CiAgICBjb25zdHJ1Y3RvcihvcGFxdWVNZXRob2RJZCkgewogICAgICBjb25zdCBtZXRob2RJZCA9IHVud3JhcE1ldGhvZElkKG9wYXF1ZU1ldGhvZElkKTsKICAgICAgdGhpcy5tZXRob2RJZCA9IG1ldGhvZElkOwogICAgICB0aGlzLm9yaWdpbmFsTWV0aG9kID0gbnVsbDsKICAgICAgdGhpcy5ob29rZWRNZXRob2RJZCA9IG1ldGhvZElkOwogICAgICB0aGlzLnJlcGxhY2VtZW50TWV0aG9kSWQgPSBudWxsOwogICAgICB0aGlzLmludGVyY2VwdG9yID0gbnVsbDsKICAgIH0KICAgIHJlcGxhY2UoaW1wbCwgaXNJbnN0YW5jZU1ldGhvZCwgYXJnVHlwZXMsIHZtMywgYXBpMikgewogICAgICBjb25zdCB7IGtBY2NDb21waWxlRG9udEJvdGhlciwgYXJ0TnRlcnBFbnRyeVBvaW50IH0gPSBhcGkyOwogICAgICB0aGlzLm9yaWdpbmFsTWV0aG9kID0gZmV0Y2hBcnRNZXRob2QodGhpcy5tZXRob2RJZCwgdm0zKTsKICAgICAgY29uc3Qgb3JpZ2luYWxGbGFncyA9IHRoaXMub3JpZ2luYWxNZXRob2QuYWNjZXNzRmxhZ3M7CiAgICAgIGlmICgob3JpZ2luYWxGbGFncyAmIGtBY2NYcG9zZWRIb29rZWRNZXRob2QpICE9PSAwICYmIHhwb3NlZElzU3VwcG9ydGVkKCkpIHsKICAgICAgICBjb25zdCBob29rSW5mbyA9IHRoaXMub3JpZ2luYWxNZXRob2Quam5pQ29kZTsKICAgICAgICB0aGlzLmhvb2tlZE1ldGhvZElkID0gaG9va0luZm8uYWRkKDIgKiBwb2ludGVyU2l6ZTUpLnJlYWRQb2ludGVyKCk7CiAgICAgICAgdGhpcy5vcmlnaW5hbE1ldGhvZCA9IGZldGNoQXJ0TWV0aG9kKHRoaXMuaG9va2VkTWV0aG9kSWQsIHZtMyk7CiAgICAgIH0KICAgICAgY29uc3QgeyBob29rZWRNZXRob2RJZCB9ID0gdGhpczsKICAgICAgY29uc3QgcmVwbGFjZW1lbnRNZXRob2RJZCA9IGNsb25lQXJ0TWV0aG9kKGhvb2tlZE1ldGhvZElkLCB2bTMpOwogICAgICB0aGlzLnJlcGxhY2VtZW50TWV0aG9kSWQgPSByZXBsYWNlbWVudE1ldGhvZElkOwogICAgICBwYXRjaEFydE1ldGhvZChyZXBsYWNlbWVudE1ldGhvZElkLCB7CiAgICAgICAgam5pQ29kZTogaW1wbCwKICAgICAgICBhY2Nlc3NGbGFnczogKG9yaWdpbmFsRmxhZ3MgJiB+KGtBY2NDcml0aWNhbE5hdGl2ZSB8IGtBY2NGYXN0TmF0aXZlIHwga0FjY050ZXJwRW50cnlQb2ludEZhc3RQYXRoRmxhZykgfCBrQWNjTmF0aXZlIHwga0FjY0NvbXBpbGVEb250Qm90aGVyKSA+Pj4gMCwKICAgICAgICBxdWlja0NvZGU6IGFwaTIuYXJ0Q2xhc3NMaW5rZXIucXVpY2tHZW5lcmljSm5pVHJhbXBvbGluZSwKICAgICAgICBpbnRlcnByZXRlckNvZGU6IGFwaTIuYXJ0SW50ZXJwcmV0ZXJUb0NvbXBpbGVkQ29kZUJyaWRnZQogICAgICB9LCB2bTMpOwogICAgICBsZXQgaG9va2VkTWV0aG9kUmVtb3ZlZEZsYWdzID0ga0FjY0Zhc3RJbnRlcnByZXRlclRvSW50ZXJwcmV0ZXJJbnZva2UgfCBrQWNjU2luZ2xlSW1wbGVtZW50YXRpb24gfCBrQWNjTnRlcnBFbnRyeVBvaW50RmFzdFBhdGhGbGFnOwogICAgICBpZiAoKG9yaWdpbmFsRmxhZ3MgJiBrQWNjTmF0aXZlKSA9PT0gMCkgewogICAgICAgIGhvb2tlZE1ldGhvZFJlbW92ZWRGbGFncyB8PSBrQWNjU2tpcEFjY2Vzc0NoZWNrczsKICAgICAgfQogICAgICBwYXRjaEFydE1ldGhvZChob29rZWRNZXRob2RJZCwgewogICAgICAgIGFjY2Vzc0ZsYWdzOiAob3JpZ2luYWxGbGFncyAmIH5ob29rZWRNZXRob2RSZW1vdmVkRmxhZ3MgfCBrQWNjQ29tcGlsZURvbnRCb3RoZXIpID4+PiAwCiAgICAgIH0sIHZtMyk7CiAgICAgIGNvbnN0IHF1aWNrQ29kZSA9IHRoaXMub3JpZ2luYWxNZXRob2QucXVpY2tDb2RlOwogICAgICBpZiAoYXJ0TnRlcnBFbnRyeVBvaW50ICE9PSBudWxsICYmIHF1aWNrQ29kZS5lcXVhbHMoYXJ0TnRlcnBFbnRyeVBvaW50KSkgewogICAgICAgIHBhdGNoQXJ0TWV0aG9kKGhvb2tlZE1ldGhvZElkLCB7CiAgICAgICAgICBxdWlja0NvZGU6IGFwaTIuYXJ0UXVpY2tUb0ludGVycHJldGVyQnJpZGdlCiAgICAgICAgfSwgdm0zKTsKICAgICAgfQogICAgICBpZiAoIWlzQXJ0UXVpY2tFbnRyeXBvaW50KHF1aWNrQ29kZSkpIHsKICAgICAgICBjb25zdCBpbnRlcmNlcHRvciA9IG5ldyBBcnRRdWlja0NvZGVJbnRlcmNlcHRvcihxdWlja0NvZGUpOwogICAgICAgIGludGVyY2VwdG9yLmFjdGl2YXRlKHZtMyk7CiAgICAgICAgdGhpcy5pbnRlcmNlcHRvciA9IGludGVyY2VwdG9yOwogICAgICB9CiAgICAgIGFydENvbnRyb2xsZXIucmVwbGFjZWRNZXRob2RzLnNldChob29rZWRNZXRob2RJZCwgcmVwbGFjZW1lbnRNZXRob2RJZCk7CiAgICAgIG5vdGlmeUFydE1ldGhvZEhvb2tlZChob29rZWRNZXRob2RJZCwgdm0zKTsKICAgIH0KICAgIHJldmVydCh2bTMpIHsKICAgICAgY29uc3QgeyBob29rZWRNZXRob2RJZCwgaW50ZXJjZXB0b3IgfSA9IHRoaXM7CiAgICAgIHBhdGNoQXJ0TWV0aG9kKGhvb2tlZE1ldGhvZElkLCB0aGlzLm9yaWdpbmFsTWV0aG9kLCB2bTMpOwogICAgICBhcnRDb250cm9sbGVyLnJlcGxhY2VkTWV0aG9kcy5kZWxldGUoaG9va2VkTWV0aG9kSWQpOwogICAgICBpZiAoaW50ZXJjZXB0b3IgIT09IG51bGwpIHsKICAgICAgICBpbnRlcmNlcHRvci5kZWFjdGl2YXRlKCk7CiAgICAgICAgdGhpcy5pbnRlcmNlcHRvciA9IG51bGw7CiAgICAgIH0KICAgIH0KICAgIHJlc29sdmVUYXJnZXQod3JhcHBlciwgaXNJbnN0YW5jZU1ldGhvZCwgZW52LCBhcGkyKSB7CiAgICAgIHJldHVybiB0aGlzLmhvb2tlZE1ldGhvZElkOwogICAgfQogIH07CiAgZnVuY3Rpb24geHBvc2VkSXNTdXBwb3J0ZWQoKSB7CiAgICByZXR1cm4gZ2V0QW5kcm9pZEFwaUxldmVsKCkgPCAyODsKICB9CiAgZnVuY3Rpb24gZmV0Y2hBcnRNZXRob2QobWV0aG9kSWQsIHZtMykgewogICAgY29uc3QgYXJ0TWV0aG9kU3BlYyA9IGdldEFydE1ldGhvZFNwZWModm0zKTsKICAgIGNvbnN0IGFydE1ldGhvZE9mZnNldCA9IGFydE1ldGhvZFNwZWMub2Zmc2V0OwogICAgcmV0dXJuIFsiam5pQ29kZSIsICJhY2Nlc3NGbGFncyIsICJxdWlja0NvZGUiLCAiaW50ZXJwcmV0ZXJDb2RlIl0ucmVkdWNlKChvcmlnaW5hbCwgbmFtZSkgPT4gewogICAgICBjb25zdCBvZmZzZXQgPSBhcnRNZXRob2RPZmZzZXRbbmFtZV07CiAgICAgIGlmIChvZmZzZXQgPT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiBvcmlnaW5hbDsKICAgICAgfQogICAgICBjb25zdCBhZGRyZXNzID0gbWV0aG9kSWQuYWRkKG9mZnNldCk7CiAgICAgIGNvbnN0IHJlYWQyID0gbmFtZSA9PT0gImFjY2Vzc0ZsYWdzIiA/IHJlYWRVMzIgOiByZWFkUG9pbnRlcjsKICAgICAgb3JpZ2luYWxbbmFtZV0gPSByZWFkMi5jYWxsKGFkZHJlc3MpOwogICAgICByZXR1cm4gb3JpZ2luYWw7CiAgICB9LCB7fSk7CiAgfQogIGZ1bmN0aW9uIHBhdGNoQXJ0TWV0aG9kKG1ldGhvZElkLCBwYXRjaGVzLCB2bTMpIHsKICAgIGNvbnN0IGFydE1ldGhvZFNwZWMgPSBnZXRBcnRNZXRob2RTcGVjKHZtMyk7CiAgICBjb25zdCBhcnRNZXRob2RPZmZzZXQgPSBhcnRNZXRob2RTcGVjLm9mZnNldDsKICAgIE9iamVjdC5rZXlzKHBhdGNoZXMpLmZvckVhY2goKG5hbWUpID0+IHsKICAgICAgY29uc3Qgb2Zmc2V0ID0gYXJ0TWV0aG9kT2Zmc2V0W25hbWVdOwogICAgICBpZiAob2Zmc2V0ID09PSB2b2lkIDApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3QgYWRkcmVzcyA9IG1ldGhvZElkLmFkZChvZmZzZXQpOwogICAgICBjb25zdCB3cml0ZTMgPSBuYW1lID09PSAiYWNjZXNzRmxhZ3MiID8gd3JpdGVVMzIgOiB3cml0ZVBvaW50ZXI7CiAgICAgIHdyaXRlMy5jYWxsKGFkZHJlc3MsIHBhdGNoZXNbbmFtZV0pOwogICAgfSk7CiAgfQogIHZhciBEYWx2aWtNZXRob2RNYW5nbGVyID0gY2xhc3MgewogICAgY29uc3RydWN0b3IobWV0aG9kSWQpIHsKICAgICAgdGhpcy5tZXRob2RJZCA9IG1ldGhvZElkOwogICAgICB0aGlzLm9yaWdpbmFsTWV0aG9kID0gbnVsbDsKICAgIH0KICAgIHJlcGxhY2UoaW1wbCwgaXNJbnN0YW5jZU1ldGhvZCwgYXJnVHlwZXMsIHZtMywgYXBpMikgewogICAgICBjb25zdCB7IG1ldGhvZElkIH0gPSB0aGlzOwogICAgICB0aGlzLm9yaWdpbmFsTWV0aG9kID0gTWVtb3J5LmR1cChtZXRob2RJZCwgRFZNX01FVEhPRF9TSVpFKTsKICAgICAgbGV0IGFyZ3NTaXplID0gYXJnVHlwZXMucmVkdWNlKChhY2MsIHQpID0+IGFjYyArIHQuc2l6ZSwgMCk7CiAgICAgIGlmIChpc0luc3RhbmNlTWV0aG9kKSB7CiAgICAgICAgYXJnc1NpemUrKzsKICAgICAgfQogICAgICBjb25zdCBhY2Nlc3NGbGFncyA9IChtZXRob2RJZC5hZGQoRFZNX01FVEhPRF9PRkZTRVRfQUNDRVNTX0ZMQUdTKS5yZWFkVTMyKCkgfCBrQWNjTmF0aXZlKSA+Pj4gMDsKICAgICAgY29uc3QgcmVnaXN0ZXJzU2l6ZSA9IGFyZ3NTaXplOwogICAgICBjb25zdCBvdXRzU2l6ZSA9IDA7CiAgICAgIGNvbnN0IGluc1NpemUgPSBhcmdzU2l6ZTsKICAgICAgbWV0aG9kSWQuYWRkKERWTV9NRVRIT0RfT0ZGU0VUX0FDQ0VTU19GTEFHUykud3JpdGVVMzIoYWNjZXNzRmxhZ3MpOwogICAgICBtZXRob2RJZC5hZGQoRFZNX01FVEhPRF9PRkZTRVRfUkVHSVNURVJTX1NJWkUpLndyaXRlVTE2KHJlZ2lzdGVyc1NpemUpOwogICAgICBtZXRob2RJZC5hZGQoRFZNX01FVEhPRF9PRkZTRVRfT1VUU19TSVpFKS53cml0ZVUxNihvdXRzU2l6ZSk7CiAgICAgIG1ldGhvZElkLmFkZChEVk1fTUVUSE9EX09GRlNFVF9JTlNfU0laRSkud3JpdGVVMTYoaW5zU2l6ZSk7CiAgICAgIG1ldGhvZElkLmFkZChEVk1fTUVUSE9EX09GRlNFVF9KTklfQVJHX0lORk8pLndyaXRlVTMyKGNvbXB1dGVEYWx2aWtKbmlBcmdJbmZvKG1ldGhvZElkKSk7CiAgICAgIGFwaTIuZHZtVXNlSk5JQnJpZGdlKG1ldGhvZElkLCBpbXBsKTsKICAgIH0KICAgIHJldmVydCh2bTMpIHsKICAgICAgTWVtb3J5LmNvcHkodGhpcy5tZXRob2RJZCwgdGhpcy5vcmlnaW5hbE1ldGhvZCwgRFZNX01FVEhPRF9TSVpFKTsKICAgIH0KICAgIHJlc29sdmVUYXJnZXQod3JhcHBlciwgaXNJbnN0YW5jZU1ldGhvZCwgZW52LCBhcGkyKSB7CiAgICAgIGNvbnN0IHRocmVhZCA9IGVudi5oYW5kbGUuYWRkKERWTV9KTklfRU5WX09GRlNFVF9TRUxGKS5yZWFkUG9pbnRlcigpOwogICAgICBsZXQgb2JqZWN0UHRyOwogICAgICBpZiAoaXNJbnN0YW5jZU1ldGhvZCkgewogICAgICAgIG9iamVjdFB0ciA9IGFwaTIuZHZtRGVjb2RlSW5kaXJlY3RSZWYodGhyZWFkLCB3cmFwcGVyLiRoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBoID0gd3JhcHBlci4kYm9ycm93Q2xhc3NIYW5kbGUoZW52KTsKICAgICAgICBvYmplY3RQdHIgPSBhcGkyLmR2bURlY29kZUluZGlyZWN0UmVmKHRocmVhZCwgaC52YWx1ZSk7CiAgICAgICAgaC51bnJlZihlbnYpOwogICAgICB9CiAgICAgIGxldCBjbGFzc09iamVjdDsKICAgICAgaWYgKGlzSW5zdGFuY2VNZXRob2QpIHsKICAgICAgICBjbGFzc09iamVjdCA9IG9iamVjdFB0ci5hZGQoRFZNX09CSkVDVF9PRkZTRVRfQ0xBWlopLnJlYWRQb2ludGVyKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2xhc3NPYmplY3QgPSBvYmplY3RQdHI7CiAgICAgIH0KICAgICAgY29uc3QgY2xhc3NLZXkgPSBjbGFzc09iamVjdC50b1N0cmluZygxNik7CiAgICAgIGxldCBlbnRyeSA9IHBhdGNoZWRDbGFzc2VzLmdldChjbGFzc0tleSk7CiAgICAgIGlmIChlbnRyeSA9PT0gdm9pZCAwKSB7CiAgICAgICAgY29uc3QgdnRhYmxlUHRyID0gY2xhc3NPYmplY3QuYWRkKERWTV9DTEFTU19PQkpFQ1RfT0ZGU0VUX1ZUQUJMRSk7CiAgICAgICAgY29uc3QgdnRhYmxlQ291bnRQdHIgPSBjbGFzc09iamVjdC5hZGQoRFZNX0NMQVNTX09CSkVDVF9PRkZTRVRfVlRBQkxFX0NPVU5UKTsKICAgICAgICBjb25zdCB2dGFibGUyID0gdnRhYmxlUHRyLnJlYWRQb2ludGVyKCk7CiAgICAgICAgY29uc3QgdnRhYmxlQ291bnQgPSB2dGFibGVDb3VudFB0ci5yZWFkUzMyKCk7CiAgICAgICAgY29uc3QgdnRhYmxlU2l6ZSA9IHZ0YWJsZUNvdW50ICogcG9pbnRlclNpemU1OwogICAgICAgIGNvbnN0IHNoYWRvd1Z0YWJsZSA9IE1lbW9yeS5hbGxvYygyICogdnRhYmxlU2l6ZSk7CiAgICAgICAgTWVtb3J5LmNvcHkoc2hhZG93VnRhYmxlLCB2dGFibGUyLCB2dGFibGVTaXplKTsKICAgICAgICB2dGFibGVQdHIud3JpdGVQb2ludGVyKHNoYWRvd1Z0YWJsZSk7CiAgICAgICAgZW50cnkgPSB7CiAgICAgICAgICBjbGFzc09iamVjdCwKICAgICAgICAgIHZ0YWJsZVB0ciwKICAgICAgICAgIHZ0YWJsZUNvdW50UHRyLAogICAgICAgICAgdnRhYmxlOiB2dGFibGUyLAogICAgICAgICAgdnRhYmxlQ291bnQsCiAgICAgICAgICBzaGFkb3dWdGFibGUsCiAgICAgICAgICBzaGFkb3dWdGFibGVDb3VudDogdnRhYmxlQ291bnQsCiAgICAgICAgICB0YXJnZXRNZXRob2RzOiAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpCiAgICAgICAgfTsKICAgICAgICBwYXRjaGVkQ2xhc3Nlcy5zZXQoY2xhc3NLZXksIGVudHJ5KTsKICAgICAgfQogICAgICBjb25zdCBtZXRob2RLZXkgPSB0aGlzLm1ldGhvZElkLnRvU3RyaW5nKDE2KTsKICAgICAgbGV0IHRhcmdldE1ldGhvZCA9IGVudHJ5LnRhcmdldE1ldGhvZHMuZ2V0KG1ldGhvZEtleSk7CiAgICAgIGlmICh0YXJnZXRNZXRob2QgPT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldE1ldGhvZCA9IE1lbW9yeS5kdXAodGhpcy5vcmlnaW5hbE1ldGhvZCwgRFZNX01FVEhPRF9TSVpFKTsKICAgICAgICBjb25zdCBtZXRob2RJbmRleCA9IGVudHJ5LnNoYWRvd1Z0YWJsZUNvdW50Kys7CiAgICAgICAgZW50cnkuc2hhZG93VnRhYmxlLmFkZChtZXRob2RJbmRleCAqIHBvaW50ZXJTaXplNSkud3JpdGVQb2ludGVyKHRhcmdldE1ldGhvZCk7CiAgICAgICAgdGFyZ2V0TWV0aG9kLmFkZChEVk1fTUVUSE9EX09GRlNFVF9NRVRIT0RfSU5ERVgpLndyaXRlVTE2KG1ldGhvZEluZGV4KTsKICAgICAgICBlbnRyeS52dGFibGVDb3VudFB0ci53cml0ZVMzMihlbnRyeS5zaGFkb3dWdGFibGVDb3VudCk7CiAgICAgICAgZW50cnkudGFyZ2V0TWV0aG9kcy5zZXQobWV0aG9kS2V5LCB0YXJnZXRNZXRob2QpOwogICAgICB9CiAgICAgIHJldHVybiB0YXJnZXRNZXRob2Q7CiAgICB9CiAgfTsKICBmdW5jdGlvbiBjb21wdXRlRGFsdmlrSm5pQXJnSW5mbyhtZXRob2RJZCkgewogICAgaWYgKFByb2Nlc3MuYXJjaCAhPT0gImlhMzIiKSB7CiAgICAgIHJldHVybiBEQUxWSUtfSk5JX05PX0FSR19JTkZPOwogICAgfQogICAgY29uc3Qgc2hvcnR5ID0gbWV0aG9kSWQuYWRkKERWTV9NRVRIT0RfT0ZGU0VUX1NIT1JUWSkucmVhZFBvaW50ZXIoKS5yZWFkQ1N0cmluZygpOwogICAgaWYgKHNob3J0eSA9PT0gbnVsbCB8fCBzaG9ydHkubGVuZ3RoID09PSAwIHx8IHNob3J0eS5sZW5ndGggPiA2NTUzNSkgewogICAgICByZXR1cm4gREFMVklLX0pOSV9OT19BUkdfSU5GTzsKICAgIH0KICAgIGxldCByZXR1cm5UeXBlOwogICAgc3dpdGNoIChzaG9ydHlbMF0pIHsKICAgICAgY2FzZSAiViI6CiAgICAgICAgcmV0dXJuVHlwZSA9IERBTFZJS19KTklfUkVUVVJOX1ZPSUQ7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIkYiOgogICAgICAgIHJldHVyblR5cGUgPSBEQUxWSUtfSk5JX1JFVFVSTl9GTE9BVDsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiRCI6CiAgICAgICAgcmV0dXJuVHlwZSA9IERBTFZJS19KTklfUkVUVVJOX0RPVUJMRTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiSiI6CiAgICAgICAgcmV0dXJuVHlwZSA9IERBTFZJS19KTklfUkVUVVJOX1M4OwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJaIjoKICAgICAgY2FzZSAiQiI6CiAgICAgICAgcmV0dXJuVHlwZSA9IERBTFZJS19KTklfUkVUVVJOX1MxOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJDIjoKICAgICAgICByZXR1cm5UeXBlID0gREFMVklLX0pOSV9SRVRVUk5fVTI7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIlMiOgogICAgICAgIHJldHVyblR5cGUgPSBEQUxWSUtfSk5JX1JFVFVSTl9TMjsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm5UeXBlID0gREFMVklLX0pOSV9SRVRVUk5fUzQ7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICBsZXQgaGludHMgPSAwOwogICAgZm9yIChsZXQgaSA9IHNob3J0eS5sZW5ndGggLSAxOyBpID4gMDsgaS0tKSB7CiAgICAgIGNvbnN0IGNoID0gc2hvcnR5W2ldOwogICAgICBoaW50cyArPSBjaCA9PT0gIkQiIHx8IGNoID09PSAiSiIgPyAyIDogMTsKICAgIH0KICAgIHJldHVybiByZXR1cm5UeXBlIDw8IERBTFZJS19KTklfUkVUVVJOX1NISUZUIHwgaGludHM7CiAgfQogIGZ1bmN0aW9uIGNsb25lQXJ0TWV0aG9kKG1ldGhvZCwgdm0zKSB7CiAgICBjb25zdCBhcGkyID0gZ2V0QXBpKCk7CiAgICBpZiAoZ2V0QW5kcm9pZEFwaUxldmVsKCkgPCAyMykgewogICAgICBjb25zdCB0aHJlYWQgPSBhcGkyWyJhcnQ6OlRocmVhZDo6Q3VycmVudEZyb21HZGIiXSgpOwogICAgICByZXR1cm4gYXBpMlsiYXJ0OjptaXJyb3I6Ok9iamVjdDo6Q2xvbmUiXShtZXRob2QsIHRocmVhZCk7CiAgICB9CiAgICByZXR1cm4gTWVtb3J5LmR1cChtZXRob2QsIGdldEFydE1ldGhvZFNwZWModm0zKS5zaXplKTsKICB9CiAgZnVuY3Rpb24gZGVvcHRpbWl6ZU1ldGhvZCh2bTMsIGVudiwgbWV0aG9kKSB7CiAgICByZXF1ZXN0RGVvcHRpbWl6YXRpb24odm0zLCBlbnYsIGtTZWxlY3RpdmVEZW9wdGltaXphdGlvbiwgbWV0aG9kKTsKICB9CiAgZnVuY3Rpb24gZGVvcHRpbWl6ZUV2ZXJ5dGhpbmcodm0zLCBlbnYpIHsKICAgIHJlcXVlc3REZW9wdGltaXphdGlvbih2bTMsIGVudiwga0Z1bGxEZW9wdGltaXphdGlvbik7CiAgfQogIGZ1bmN0aW9uIGRlb3B0aW1pemVCb290SW1hZ2Uodm0zLCBlbnYpIHsKICAgIGNvbnN0IGFwaTIgPSBnZXRBcGkoKTsKICAgIGlmIChnZXRBbmRyb2lkQXBpTGV2ZWwoKSA8IDI2KSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyBBUEkgaXMgb25seSBhdmFpbGFibGUgb24gQW5kcm9pZCA+PSA4LjAiKTsKICAgIH0KICAgIHdpdGhSdW5uYWJsZUFydFRocmVhZCh2bTMsIGVudiwgKHRocmVhZCkgPT4gewogICAgICBhcGkyWyJhcnQ6OlJ1bnRpbWU6OkRlb3B0aW1pemVCb290SW1hZ2UiXShhcGkyLmFydFJ1bnRpbWUpOwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIHJlcXVlc3REZW9wdGltaXphdGlvbih2bTMsIGVudiwga2luZCwgbWV0aG9kKSB7CiAgICBjb25zdCBhcGkyID0gZ2V0QXBpKCk7CiAgICBpZiAoZ2V0QW5kcm9pZEFwaUxldmVsKCkgPCAyNCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoaXMgQVBJIGlzIG9ubHkgYXZhaWxhYmxlIG9uIEFuZHJvaWQgPj0gNy4wIik7CiAgICB9CiAgICB3aXRoUnVubmFibGVBcnRUaHJlYWQodm0zLCBlbnYsICh0aHJlYWQpID0+IHsKICAgICAgaWYgKGdldEFuZHJvaWRBcGlMZXZlbCgpIDwgMzApIHsKICAgICAgICBpZiAoIWFwaTIuaXNKZHdwU3RhcnRlZCgpKSB7CiAgICAgICAgICBjb25zdCBzZXNzaW9uID0gc3RhcnRKZHdwKGFwaTIpOwogICAgICAgICAgamR3cFNlc3Npb25zLnB1c2goc2Vzc2lvbik7CiAgICAgICAgfQogICAgICAgIGlmICghYXBpMi5pc0RlYnVnZ2VyQWN0aXZlKCkpIHsKICAgICAgICAgIGFwaTJbImFydDo6RGJnOjpHb0FjdGl2ZSJdKCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJlcXVlc3QgPSBNZW1vcnkuYWxsb2MoOCArIHBvaW50ZXJTaXplNSk7CiAgICAgICAgcmVxdWVzdC53cml0ZVUzMihraW5kKTsKICAgICAgICBzd2l0Y2ggKGtpbmQpIHsKICAgICAgICAgIGNhc2Uga0Z1bGxEZW9wdGltaXphdGlvbjoKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIGtTZWxlY3RpdmVEZW9wdGltaXphdGlvbjoKICAgICAgICAgICAgcmVxdWVzdC5hZGQoOCkud3JpdGVQb2ludGVyKG1ldGhvZCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbnN1cHBvcnRlZCBkZW9wdGltaXphdGlvbiBraW5kIik7CiAgICAgICAgfQogICAgICAgIGFwaTJbImFydDo6RGJnOjpSZXF1ZXN0RGVvcHRpbWl6YXRpb24iXShyZXF1ZXN0KTsKICAgICAgICBhcGkyWyJhcnQ6OkRiZzo6TWFuYWdlRGVvcHRpbWl6YXRpb24iXSgpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGluc3RydW1lbnRhdGlvbiA9IGFwaTIuYXJ0SW5zdHJ1bWVudGF0aW9uOwogICAgICAgIGlmIChpbnN0cnVtZW50YXRpb24gPT09IG51bGwpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGZpbmQgSW5zdHJ1bWVudGF0aW9uIGNsYXNzIGluIEFSVDsgcGxlYXNlIGZpbGUgYSBidWciKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZW5hYmxlRGVvcHQgPSBhcGkyWyJhcnQ6Okluc3RydW1lbnRhdGlvbjo6RW5hYmxlRGVvcHRpbWl6YXRpb24iXTsKICAgICAgICBpZiAoZW5hYmxlRGVvcHQgIT09IHZvaWQgMCkgewogICAgICAgICAgY29uc3QgZGVvcHRpbWl6YXRpb25FbmFibGVkID0gISFpbnN0cnVtZW50YXRpb24uYWRkKGdldEFydEluc3RydW1lbnRhdGlvblNwZWMoKS5vZmZzZXQuZGVvcHRpbWl6YXRpb25FbmFibGVkKS5yZWFkVTgoKTsKICAgICAgICAgIGlmICghZGVvcHRpbWl6YXRpb25FbmFibGVkKSB7CiAgICAgICAgICAgIGVuYWJsZURlb3B0KGluc3RydW1lbnRhdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAoa2luZCkgewogICAgICAgICAgY2FzZSBrRnVsbERlb3B0aW1pemF0aW9uOgogICAgICAgICAgICBhcGkyWyJhcnQ6Okluc3RydW1lbnRhdGlvbjo6RGVvcHRpbWl6ZUV2ZXJ5dGhpbmciXShpbnN0cnVtZW50YXRpb24sIE1lbW9yeS5hbGxvY1V0ZjhTdHJpbmcoImZyaWRhIikpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2Uga1NlbGVjdGl2ZURlb3B0aW1pemF0aW9uOgogICAgICAgICAgICBhcGkyWyJhcnQ6Okluc3RydW1lbnRhdGlvbjo6RGVvcHRpbWl6ZSJdKGluc3RydW1lbnRhdGlvbiwgbWV0aG9kKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuc3VwcG9ydGVkIGRlb3B0aW1pemF0aW9uIGtpbmQiKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KICB2YXIgSmR3cFNlc3Npb24gPSBjbGFzcyB7CiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgY29uc3QgbGliYXJ0ID0gUHJvY2Vzcy5nZXRNb2R1bGVCeU5hbWUoImxpYmFydC5zbyIpOwogICAgICBjb25zdCBhY2NlcHRJbXBsID0gbGliYXJ0LmdldEV4cG9ydEJ5TmFtZSgiX1pOM2FydDRKRFdQMTJKZHdwQWRiU3RhdGU2QWNjZXB0RXYiKTsKICAgICAgY29uc3QgcmVjZWl2ZUNsaWVudEZkSW1wbCA9IGxpYmFydC5nZXRFeHBvcnRCeU5hbWUoIl9aTjNhcnQ0SkRXUDEySmR3cEFkYlN0YXRlMTVSZWNlaXZlQ2xpZW50RmRFdiIpOwogICAgICBjb25zdCBjb250cm9sUGFpciA9IG1ha2VTb2NrZXRQYWlyKCk7CiAgICAgIGNvbnN0IGNsaWVudFBhaXIgPSBtYWtlU29ja2V0UGFpcigpOwogICAgICB0aGlzLl9jb250cm9sRmQgPSBjb250cm9sUGFpclswXTsKICAgICAgdGhpcy5fY2xpZW50RmQgPSBjbGllbnRQYWlyWzBdOwogICAgICBsZXQgYWNjZXB0TGlzdGVuZXIgPSBudWxsOwogICAgICBhY2NlcHRMaXN0ZW5lciA9IEludGVyY2VwdG9yLmF0dGFjaChhY2NlcHRJbXBsLCBmdW5jdGlvbihhcmdzKSB7CiAgICAgICAgY29uc3Qgc3RhdGUgPSBhcmdzWzBdOwogICAgICAgIGNvbnN0IGNvbnRyb2xTb2NrUHRyID0gTWVtb3J5LnNjYW5TeW5jKHN0YXRlLmFkZCg4MjUyKSwgMjU2LCAiMDAgZmYgZmYgZmYgZmYgMDAiKVswXS5hZGRyZXNzLmFkZCgxKTsKICAgICAgICBjb250cm9sU29ja1B0ci53cml0ZVMzMihjb250cm9sUGFpclsxXSk7CiAgICAgICAgYWNjZXB0TGlzdGVuZXIuZGV0YWNoKCk7CiAgICAgIH0pOwogICAgICBJbnRlcmNlcHRvci5yZXBsYWNlKHJlY2VpdmVDbGllbnRGZEltcGwsIG5ldyBOYXRpdmVDYWxsYmFjayhmdW5jdGlvbihzdGF0ZSkgewogICAgICAgIEludGVyY2VwdG9yLnJldmVydChyZWNlaXZlQ2xpZW50RmRJbXBsKTsKICAgICAgICByZXR1cm4gY2xpZW50UGFpclsxXTsKICAgICAgfSwgImludCIsIFsicG9pbnRlciJdKSk7CiAgICAgIEludGVyY2VwdG9yLmZsdXNoKCk7CiAgICAgIHRoaXMuX2hhbmRzaGFrZVJlcXVlc3QgPSB0aGlzLl9wZXJmb3JtSGFuZHNoYWtlKCk7CiAgICB9CiAgICBhc3luYyBfcGVyZm9ybUhhbmRzaGFrZSgpIHsKICAgICAgY29uc3QgaW5wdXQgPSBuZXcgVW5peElucHV0U3RyZWFtKHRoaXMuX2NsaWVudEZkLCB7IGF1dG9DbG9zZTogZmFsc2UgfSk7CiAgICAgIGNvbnN0IG91dHB1dCA9IG5ldyBVbml4T3V0cHV0U3RyZWFtKHRoaXMuX2NsaWVudEZkLCB7IGF1dG9DbG9zZTogZmFsc2UgfSk7CiAgICAgIGNvbnN0IGhhbmRzaGFrZVBhY2tldCA9IFs3NCwgNjgsIDg3LCA4MCwgNDUsIDcyLCA5NywgMTEwLCAxMDAsIDExNSwgMTA0LCA5NywgMTA3LCAxMDFdOwogICAgICB0cnkgewogICAgICAgIGF3YWl0IG91dHB1dC53cml0ZUFsbChoYW5kc2hha2VQYWNrZXQpOwogICAgICAgIGF3YWl0IGlucHV0LnJlYWRBbGwoaGFuZHNoYWtlUGFja2V0Lmxlbmd0aCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgfQogICAgfQogIH07CiAgZnVuY3Rpb24gc3RhcnRKZHdwKGFwaTIpIHsKICAgIGNvbnN0IHNlc3Npb24gPSBuZXcgSmR3cFNlc3Npb24oKTsKICAgIGFwaTJbImFydDo6RGJnOjpTZXRKZHdwQWxsb3dlZCJdKDEpOwogICAgY29uc3Qgb3B0aW9ucyA9IG1ha2VKZHdwT3B0aW9ucygpOwogICAgYXBpMlsiYXJ0OjpEYmc6OkNvbmZpZ3VyZUpkd3AiXShvcHRpb25zKTsKICAgIGNvbnN0IHN0YXJ0RGVidWdnZXIgPSBhcGkyWyJhcnQ6OkludGVybmFsRGVidWdnZXJDb250cm9sQ2FsbGJhY2s6OlN0YXJ0RGVidWdnZXIiXTsKICAgIGlmIChzdGFydERlYnVnZ2VyICE9PSB2b2lkIDApIHsKICAgICAgc3RhcnREZWJ1Z2dlcihOVUxMKTsKICAgIH0gZWxzZSB7CiAgICAgIGFwaTJbImFydDo6RGJnOjpTdGFydEpkd3AiXSgpOwogICAgfQogICAgcmV0dXJuIHNlc3Npb247CiAgfQogIGZ1bmN0aW9uIG1ha2VKZHdwT3B0aW9ucygpIHsKICAgIGNvbnN0IGtKZHdwVHJhbnNwb3J0QW5kcm9pZEFkYiA9IGdldEFuZHJvaWRBcGlMZXZlbCgpIDwgMjggPyAyIDogMzsKICAgIGNvbnN0IGtKZHdwUG9ydEZpcnN0QXZhaWxhYmxlID0gMDsKICAgIGNvbnN0IHRyYW5zcG9ydCA9IGtKZHdwVHJhbnNwb3J0QW5kcm9pZEFkYjsKICAgIGNvbnN0IHNlcnZlciA9IHRydWU7CiAgICBjb25zdCBzdXNwZW5kID0gZmFsc2U7CiAgICBjb25zdCBwb3J0ID0ga0pkd3BQb3J0Rmlyc3RBdmFpbGFibGU7CiAgICBjb25zdCBzaXplID0gOCArIFNURF9TVFJJTkdfU0laRSArIDI7CiAgICBjb25zdCByZXN1bHQgPSBNZW1vcnkuYWxsb2Moc2l6ZSk7CiAgICByZXN1bHQud3JpdGVVMzIodHJhbnNwb3J0KS5hZGQoNCkud3JpdGVVOChzZXJ2ZXIgPyAxIDogMCkuYWRkKDEpLndyaXRlVTgoc3VzcGVuZCA/IDEgOiAwKS5hZGQoMSkuYWRkKFNURF9TVFJJTkdfU0laRSkud3JpdGVVMTYocG9ydCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBtYWtlU29ja2V0UGFpcigpIHsKICAgIGlmIChzb2NrZXRwYWlyID09PSBudWxsKSB7CiAgICAgIHNvY2tldHBhaXIgPSBuZXcgTmF0aXZlRnVuY3Rpb24oCiAgICAgICAgUHJvY2Vzcy5nZXRNb2R1bGVCeU5hbWUoImxpYmMuc28iKS5nZXRFeHBvcnRCeU5hbWUoInNvY2tldHBhaXIiKSwKICAgICAgICAiaW50IiwKICAgICAgICBbImludCIsICJpbnQiLCAiaW50IiwgInBvaW50ZXIiXQogICAgICApOwogICAgfQogICAgY29uc3QgYnVmID0gTWVtb3J5LmFsbG9jKDgpOwogICAgaWYgKHNvY2tldHBhaXIoQUZfVU5JWCwgU09DS19TVFJFQU0sIDAsIGJ1ZikgPT09IC0xKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGNyZWF0ZSBzb2NrZXRwYWlyIGZvciBKRFdQIik7CiAgICB9CiAgICByZXR1cm4gWwogICAgICBidWYucmVhZFMzMigpLAogICAgICBidWYuYWRkKDQpLnJlYWRTMzIoKQogICAgXTsKICB9CiAgZnVuY3Rpb24gbWFrZUFkZEdsb2JhbFJlZkZhbGxiYWNrRm9yQW5kcm9pZDUoYXBpMikgewogICAgY29uc3Qgb2Zmc2V0ID0gZ2V0QXJ0Vk1TcGVjKCkub2Zmc2V0OwogICAgY29uc3QgbG9jayA9IGFwaTIudm0uYWRkKG9mZnNldC5nbG9iYWxzTG9jayk7CiAgICBjb25zdCB0YWJsZSA9IGFwaTIudm0uYWRkKG9mZnNldC5nbG9iYWxzKTsKICAgIGNvbnN0IGFkZCA9IGFwaTJbImFydDo6SW5kaXJlY3RSZWZlcmVuY2VUYWJsZTo6QWRkIl07CiAgICBjb25zdCBhY3F1aXJlID0gYXBpMlsiYXJ0OjpSZWFkZXJXcml0ZXJNdXRleDo6RXhjbHVzaXZlTG9jayJdOwogICAgY29uc3QgcmVsZWFzZSA9IGFwaTJbImFydDo6UmVhZGVyV3JpdGVyTXV0ZXg6OkV4Y2x1c2l2ZVVubG9jayJdOwogICAgY29uc3QgSVJUX0ZJUlNUX1NFR01FTlQgPSAwOwogICAgcmV0dXJuIGZ1bmN0aW9uKHZtMywgdGhyZWFkLCBvYmopIHsKICAgICAgYWNxdWlyZShsb2NrLCB0aHJlYWQpOwogICAgICB0cnkgewogICAgICAgIHJldHVybiBhZGQodGFibGUsIElSVF9GSVJTVF9TRUdNRU5ULCBvYmopOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHJlbGVhc2UobG9jaywgdGhyZWFkKTsKICAgICAgfQogICAgfTsKICB9CiAgZnVuY3Rpb24gbWFrZURlY29kZUdsb2JhbEZhbGxiYWNrKGFwaTIpIHsKICAgIGNvbnN0IGRlY29kZSA9IGFwaTJbImFydDo6VGhyZWFkOjpEZWNvZGVKT2JqZWN0Il07CiAgICBpZiAoZGVjb2RlID09PSB2b2lkIDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJhcnQ6OlRocmVhZDo6RGVjb2RlSk9iamVjdCBpcyBub3QgYXZhaWxhYmxlOyBwbGVhc2UgZmlsZSBhIGJ1ZyIpOwogICAgfQogICAgcmV0dXJuIGZ1bmN0aW9uKHZtMywgdGhyZWFkLCByZWYpIHsKICAgICAgcmV0dXJuIGRlY29kZSh0aHJlYWQsIHJlZik7CiAgICB9OwogIH0KICB2YXIgdGhyZWFkU3RhdGVUcmFuc2l0aW9uUmVjb21waWxlcnMgPSB7CiAgICBpYTMyOiByZWNvbXBpbGVFeGNlcHRpb25DbGVhckZvclg4NiwKICAgIHg2NDogcmVjb21waWxlRXhjZXB0aW9uQ2xlYXJGb3JYODYsCiAgICBhcm06IHJlY29tcGlsZUV4Y2VwdGlvbkNsZWFyRm9yQXJtLAogICAgYXJtNjQ6IHJlY29tcGlsZUV4Y2VwdGlvbkNsZWFyRm9yQXJtNjQKICB9OwogIGZ1bmN0aW9uIG1ha2VBcnRUaHJlYWRTdGF0ZVRyYW5zaXRpb25JbXBsKHZtMywgZW52LCBjYWxsYmFjaykgewogICAgY29uc3QgYXBpMiA9IGdldEFwaSgpOwogICAgY29uc3QgZW52VnRhYmxlID0gZW52LmhhbmRsZS5yZWFkUG9pbnRlcigpOwogICAgbGV0IGV4Y2VwdGlvbkNsZWFySW1wbDsKICAgIGNvbnN0IGlubmVyRXhjZXB0aW9uQ2xlYXJJbXBsID0gYXBpMi5maW5kKCJfWk4zYXJ0M0pOSUlMYjFFRTE0RXhjZXB0aW9uQ2xlYXJFUDdfSk5JRW52Iik7CiAgICBpZiAoaW5uZXJFeGNlcHRpb25DbGVhckltcGwgIT09IG51bGwpIHsKICAgICAgZXhjZXB0aW9uQ2xlYXJJbXBsID0gaW5uZXJFeGNlcHRpb25DbGVhckltcGw7CiAgICB9IGVsc2UgewogICAgICBleGNlcHRpb25DbGVhckltcGwgPSBlbnZWdGFibGUuYWRkKEVOVl9WVEFCTEVfT0ZGU0VUX0VYQ0VQVElPTl9DTEVBUikucmVhZFBvaW50ZXIoKTsKICAgIH0KICAgIGxldCBuZXh0RnVuY0ltcGw7CiAgICBjb25zdCBpbm5lck5leHRGdW5jSW1wbCA9IGFwaTIuZmluZCgiX1pOM2FydDNKTklJTGIxRUUxMEZhdGFsRXJyb3JFUDdfSk5JRW52UEtjIik7CiAgICBpZiAoaW5uZXJOZXh0RnVuY0ltcGwgIT09IG51bGwpIHsKICAgICAgbmV4dEZ1bmNJbXBsID0gaW5uZXJOZXh0RnVuY0ltcGw7CiAgICB9IGVsc2UgewogICAgICBuZXh0RnVuY0ltcGwgPSBlbnZWdGFibGUuYWRkKEVOVl9WVEFCTEVfT0ZGU0VUX0ZBVEFMX0VSUk9SKS5yZWFkUG9pbnRlcigpOwogICAgfQogICAgY29uc3QgcmVjb21waWxlID0gdGhyZWFkU3RhdGVUcmFuc2l0aW9uUmVjb21waWxlcnNbUHJvY2Vzcy5hcmNoXTsKICAgIGlmIChyZWNvbXBpbGUgPT09IHZvaWQgMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIk5vdCB5ZXQgaW1wbGVtZW50ZWQgZm9yICIgKyBQcm9jZXNzLmFyY2gpOwogICAgfQogICAgbGV0IHBlcmZvcm0gPSBudWxsOwogICAgY29uc3QgdGhyZWFkT2Zmc2V0cyA9IGdldEFydFRocmVhZFNwZWModm0zKS5vZmZzZXQ7CiAgICBjb25zdCBleGNlcHRpb25PZmZzZXQgPSB0aHJlYWRPZmZzZXRzLmV4Y2VwdGlvbjsKICAgIGNvbnN0IG5ldXRlcmVkT2Zmc2V0cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICBjb25zdCBpc1JlcG9ydGVkT2Zmc2V0ID0gdGhyZWFkT2Zmc2V0cy5pc0V4Y2VwdGlvblJlcG9ydGVkVG9JbnN0cnVtZW50YXRpb247CiAgICBpZiAoaXNSZXBvcnRlZE9mZnNldCAhPT0gbnVsbCkgewogICAgICBuZXV0ZXJlZE9mZnNldHMuYWRkKGlzUmVwb3J0ZWRPZmZzZXQpOwogICAgfQogICAgY29uc3QgdGhyb3dMb2NhdGlvblN0YXJ0T2Zmc2V0ID0gdGhyZWFkT2Zmc2V0cy50aHJvd0xvY2F0aW9uOwogICAgaWYgKHRocm93TG9jYXRpb25TdGFydE9mZnNldCAhPT0gbnVsbCkgewogICAgICBuZXV0ZXJlZE9mZnNldHMuYWRkKHRocm93TG9jYXRpb25TdGFydE9mZnNldCk7CiAgICAgIG5ldXRlcmVkT2Zmc2V0cy5hZGQodGhyb3dMb2NhdGlvblN0YXJ0T2Zmc2V0ICsgcG9pbnRlclNpemU1KTsKICAgICAgbmV1dGVyZWRPZmZzZXRzLmFkZCh0aHJvd0xvY2F0aW9uU3RhcnRPZmZzZXQgKyAyICogcG9pbnRlclNpemU1KTsKICAgIH0KICAgIGNvbnN0IGNvZGVTaXplID0gNjU1MzY7CiAgICBjb25zdCBjb2RlMiA9IE1lbW9yeS5hbGxvYyhjb2RlU2l6ZSk7CiAgICBNZW1vcnkucGF0Y2hDb2RlKGNvZGUyLCBjb2RlU2l6ZSwgKGJ1ZmZlcikgPT4gewogICAgICBwZXJmb3JtID0gcmVjb21waWxlKGJ1ZmZlciwgY29kZTIsIGV4Y2VwdGlvbkNsZWFySW1wbCwgbmV4dEZ1bmNJbXBsLCBleGNlcHRpb25PZmZzZXQsIG5ldXRlcmVkT2Zmc2V0cywgY2FsbGJhY2spOwogICAgfSk7CiAgICBwZXJmb3JtLl9jb2RlID0gY29kZTI7CiAgICBwZXJmb3JtLl9jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgcmV0dXJuIHBlcmZvcm07CiAgfQogIGZ1bmN0aW9uIHJlY29tcGlsZUV4Y2VwdGlvbkNsZWFyRm9yWDg2KGJ1ZmZlciwgcGMsIGV4Y2VwdGlvbkNsZWFySW1wbCwgbmV4dEZ1bmNJbXBsLCBleGNlcHRpb25PZmZzZXQsIG5ldXRlcmVkT2Zmc2V0cywgY2FsbGJhY2spIHsKICAgIGNvbnN0IGJsb2NrcyA9IHt9OwogICAgY29uc3QgYnJhbmNoVGFyZ2V0cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICBjb25zdCBwZW5kaW5nID0gW2V4Y2VwdGlvbkNsZWFySW1wbF07CiAgICB3aGlsZSAocGVuZGluZy5sZW5ndGggPiAwKSB7CiAgICAgIGxldCBjdXJyZW50ID0gcGVuZGluZy5zaGlmdCgpOwogICAgICBjb25zdCBhbHJlYWR5Q292ZXJlZCA9IE9iamVjdC52YWx1ZXMoYmxvY2tzKS5zb21lKCh7IGJlZ2luLCBlbmQgfSkgPT4gY3VycmVudC5jb21wYXJlKGJlZ2luKSA+PSAwICYmIGN1cnJlbnQuY29tcGFyZShlbmQpIDwgMCk7CiAgICAgIGlmIChhbHJlYWR5Q292ZXJlZCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbnN0IGJsb2NrQWRkcmVzc0tleSA9IGN1cnJlbnQudG9TdHJpbmcoKTsKICAgICAgbGV0IGJsb2NrID0gewogICAgICAgIGJlZ2luOiBjdXJyZW50CiAgICAgIH07CiAgICAgIGxldCBsYXN0SW5zbiA9IG51bGw7CiAgICAgIGxldCByZWFjaGVkRW5kT2ZCbG9jayA9IGZhbHNlOwogICAgICBkbyB7CiAgICAgICAgaWYgKGN1cnJlbnQuZXF1YWxzKG5leHRGdW5jSW1wbCkpIHsKICAgICAgICAgIHJlYWNoZWRFbmRPZkJsb2NrID0gdHJ1ZTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbnNuID0gSW5zdHJ1Y3Rpb24ucGFyc2UoY3VycmVudCk7CiAgICAgICAgbGFzdEluc24gPSBpbnNuOwogICAgICAgIGNvbnN0IGV4aXN0aW5nQmxvY2sgPSBibG9ja3NbaW5zbi5hZGRyZXNzLnRvU3RyaW5nKCldOwogICAgICAgIGlmIChleGlzdGluZ0Jsb2NrICE9PSB2b2lkIDApIHsKICAgICAgICAgIGRlbGV0ZSBibG9ja3NbZXhpc3RpbmdCbG9jay5iZWdpbi50b1N0cmluZygpXTsKICAgICAgICAgIGJsb2Nrc1tibG9ja0FkZHJlc3NLZXldID0gZXhpc3RpbmdCbG9jazsKICAgICAgICAgIGV4aXN0aW5nQmxvY2suYmVnaW4gPSBibG9jay5iZWdpbjsKICAgICAgICAgIGJsb2NrID0gbnVsbDsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBsZXQgYnJhbmNoVGFyZ2V0ID0gbnVsbDsKICAgICAgICBzd2l0Y2ggKGluc24ubW5lbW9uaWMpIHsKICAgICAgICAgIGNhc2UgImptcCI6CiAgICAgICAgICAgIGJyYW5jaFRhcmdldCA9IHB0cihpbnNuLm9wZXJhbmRzWzBdLnZhbHVlKTsKICAgICAgICAgICAgcmVhY2hlZEVuZE9mQmxvY2sgPSB0cnVlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgImplIjoKICAgICAgICAgIGNhc2UgImpnIjoKICAgICAgICAgIGNhc2UgImpsZSI6CiAgICAgICAgICBjYXNlICJqbmUiOgogICAgICAgICAgY2FzZSAianMiOgogICAgICAgICAgICBicmFuY2hUYXJnZXQgPSBwdHIoaW5zbi5vcGVyYW5kc1swXS52YWx1ZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAicmV0IjoKICAgICAgICAgICAgcmVhY2hlZEVuZE9mQmxvY2sgPSB0cnVlOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKGJyYW5jaFRhcmdldCAhPT0gbnVsbCkgewogICAgICAgICAgYnJhbmNoVGFyZ2V0cy5hZGQoYnJhbmNoVGFyZ2V0LnRvU3RyaW5nKCkpOwogICAgICAgICAgcGVuZGluZy5wdXNoKGJyYW5jaFRhcmdldCk7CiAgICAgICAgICBwZW5kaW5nLnNvcnQoKGEsIGIpID0+IGEuY29tcGFyZShiKSk7CiAgICAgICAgfQogICAgICAgIGN1cnJlbnQgPSBpbnNuLm5leHQ7CiAgICAgIH0gd2hpbGUgKCFyZWFjaGVkRW5kT2ZCbG9jayk7CiAgICAgIGlmIChibG9jayAhPT0gbnVsbCkgewogICAgICAgIGJsb2NrLmVuZCA9IGxhc3RJbnNuLmFkZHJlc3MuYWRkKGxhc3RJbnNuLnNpemUpOwogICAgICAgIGJsb2Nrc1tibG9ja0FkZHJlc3NLZXldID0gYmxvY2s7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGJsb2Nrc09yZGVyZWQgPSBPYmplY3Qua2V5cyhibG9ja3MpLm1hcCgoa2V5KSA9PiBibG9ja3Nba2V5XSk7CiAgICBibG9ja3NPcmRlcmVkLnNvcnQoKGEsIGIpID0+IGEuYmVnaW4uY29tcGFyZShiLmJlZ2luKSk7CiAgICBjb25zdCBlbnRyeUJsb2NrID0gYmxvY2tzW2V4Y2VwdGlvbkNsZWFySW1wbC50b1N0cmluZygpXTsKICAgIGJsb2Nrc09yZGVyZWQuc3BsaWNlKGJsb2Nrc09yZGVyZWQuaW5kZXhPZihlbnRyeUJsb2NrKSwgMSk7CiAgICBibG9ja3NPcmRlcmVkLnVuc2hpZnQoZW50cnlCbG9jayk7CiAgICBjb25zdCB3cml0ZXIgPSBuZXcgWDg2V3JpdGVyKGJ1ZmZlciwgeyBwYyB9KTsKICAgIGxldCBmb3VuZENvcmUgPSBmYWxzZTsKICAgIGxldCB0aHJlYWRSZWcgPSBudWxsOwogICAgYmxvY2tzT3JkZXJlZC5mb3JFYWNoKChibG9jaykgPT4gewogICAgICBjb25zdCBzaXplID0gYmxvY2suZW5kLnN1YihibG9jay5iZWdpbikudG9JbnQzMigpOwogICAgICBjb25zdCByZWxvY2F0b3IgPSBuZXcgWDg2UmVsb2NhdG9yKGJsb2NrLmJlZ2luLCB3cml0ZXIpOwogICAgICBsZXQgb2Zmc2V0OwogICAgICB3aGlsZSAoKG9mZnNldCA9IHJlbG9jYXRvci5yZWFkT25lKCkpICE9PSAwKSB7CiAgICAgICAgY29uc3QgaW5zbiA9IHJlbG9jYXRvci5pbnB1dDsKICAgICAgICBjb25zdCB7IG1uZW1vbmljIH0gPSBpbnNuOwogICAgICAgIGNvbnN0IGluc25BZGRyZXNzSWQgPSBpbnNuLmFkZHJlc3MudG9TdHJpbmcoKTsKICAgICAgICBpZiAoYnJhbmNoVGFyZ2V0cy5oYXMoaW5zbkFkZHJlc3NJZCkpIHsKICAgICAgICAgIHdyaXRlci5wdXRMYWJlbChpbnNuQWRkcmVzc0lkKTsKICAgICAgICB9CiAgICAgICAgbGV0IGtlZXAgPSB0cnVlOwogICAgICAgIHN3aXRjaCAobW5lbW9uaWMpIHsKICAgICAgICAgIGNhc2UgImptcCI6CiAgICAgICAgICAgIHdyaXRlci5wdXRKbXBOZWFyTGFiZWwoYnJhbmNoTGFiZWxGcm9tT3BlcmFuZChpbnNuLm9wZXJhbmRzWzBdKSk7CiAgICAgICAgICAgIGtlZXAgPSBmYWxzZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJqZSI6CiAgICAgICAgICBjYXNlICJqZyI6CiAgICAgICAgICBjYXNlICJqbGUiOgogICAgICAgICAgY2FzZSAiam5lIjoKICAgICAgICAgIGNhc2UgImpzIjoKICAgICAgICAgICAgd3JpdGVyLnB1dEpjY05lYXJMYWJlbChtbmVtb25pYywgYnJhbmNoTGFiZWxGcm9tT3BlcmFuZChpbnNuLm9wZXJhbmRzWzBdKSwgIm5vLWhpbnQiKTsKICAgICAgICAgICAga2VlcCA9IGZhbHNlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgIm1vdiI6IHsKICAgICAgICAgICAgY29uc3QgW2RzdCwgc3JjXSA9IGluc24ub3BlcmFuZHM7CiAgICAgICAgICAgIGlmIChkc3QudHlwZSA9PT0gIm1lbSIgJiYgc3JjLnR5cGUgPT09ICJpbW0iKSB7CiAgICAgICAgICAgICAgY29uc3QgZHN0VmFsdWUgPSBkc3QudmFsdWU7CiAgICAgICAgICAgICAgY29uc3QgZHN0T2Zmc2V0ID0gZHN0VmFsdWUuZGlzcDsKICAgICAgICAgICAgICBpZiAoZHN0T2Zmc2V0ID09PSBleGNlcHRpb25PZmZzZXQgJiYgc3JjLnZhbHVlLnZhbHVlT2YoKSA9PT0gMCkgewogICAgICAgICAgICAgICAgdGhyZWFkUmVnID0gZHN0VmFsdWUuYmFzZTsKICAgICAgICAgICAgICAgIHdyaXRlci5wdXRQdXNoZngoKTsKICAgICAgICAgICAgICAgIHdyaXRlci5wdXRQdXNoYXgoKTsKICAgICAgICAgICAgICAgIHdyaXRlci5wdXRNb3ZSZWdSZWcoInhicCIsICJ4c3AiKTsKICAgICAgICAgICAgICAgIGlmIChwb2ludGVyU2l6ZTUgPT09IDQpIHsKICAgICAgICAgICAgICAgICAgd3JpdGVyLnB1dEFuZFJlZ1UzMigiZXNwIiwgNDI5NDk2NzI4MCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjb25zdCBzY3JhdGNoUmVnID0gdGhyZWFkUmVnICE9PSAicmRpIiA/ICJyZGkiIDogInJzaSI7CiAgICAgICAgICAgICAgICAgIHdyaXRlci5wdXRNb3ZSZWdVNjQoc2NyYXRjaFJlZywgdWludDY0KCIweGZmZmZmZmZmZmZmZmZmZjAiKSk7CiAgICAgICAgICAgICAgICAgIHdyaXRlci5wdXRBbmRSZWdSZWcoInJzcCIsIHNjcmF0Y2hSZWcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd3JpdGVyLnB1dENhbGxBZGRyZXNzV2l0aEFsaWduZWRBcmd1bWVudHMoY2FsbGJhY2ssIFt0aHJlYWRSZWddKTsKICAgICAgICAgICAgICAgIHdyaXRlci5wdXRNb3ZSZWdSZWcoInhzcCIsICJ4YnAiKTsKICAgICAgICAgICAgICAgIHdyaXRlci5wdXRQb3BheCgpOwogICAgICAgICAgICAgICAgd3JpdGVyLnB1dFBvcGZ4KCk7CiAgICAgICAgICAgICAgICBmb3VuZENvcmUgPSB0cnVlOwogICAgICAgICAgICAgICAga2VlcCA9IGZhbHNlOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobmV1dGVyZWRPZmZzZXRzLmhhcyhkc3RPZmZzZXQpICYmIGRzdFZhbHVlLmJhc2UgPT09IHRocmVhZFJlZykgewogICAgICAgICAgICAgICAga2VlcCA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgImNhbGwiOiB7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IGluc24ub3BlcmFuZHNbMF07CiAgICAgICAgICAgIGlmICh0YXJnZXQudHlwZSA9PT0gIm1lbSIgJiYgdGFyZ2V0LnZhbHVlLmRpc3AgPT09IEVOVl9WVEFCTEVfT0ZGU0VUX0VYQ0VQVElPTl9DTEVBUikgewogICAgICAgICAgICAgIGlmIChwb2ludGVyU2l6ZTUgPT09IDQpIHsKICAgICAgICAgICAgICAgIHdyaXRlci5wdXRQb3BSZWcoImVheCIpOwogICAgICAgICAgICAgICAgd3JpdGVyLnB1dE1vdlJlZ1JlZ09mZnNldFB0cigiZWF4IiwgImVheCIsIDQpOwogICAgICAgICAgICAgICAgd3JpdGVyLnB1dFB1c2hSZWcoImVheCIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB3cml0ZXIucHV0TW92UmVnUmVnT2Zmc2V0UHRyKCJyZGkiLCAicmRpIiwgOCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdyaXRlci5wdXRDYWxsQWRkcmVzc1dpdGhBcmd1bWVudHMoY2FsbGJhY2ssIFtdKTsKICAgICAgICAgICAgICBmb3VuZENvcmUgPSB0cnVlOwogICAgICAgICAgICAgIGtlZXAgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGtlZXApIHsKICAgICAgICAgIHJlbG9jYXRvci53cml0ZUFsbCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZWxvY2F0b3Iuc2tpcE9uZSgpOwogICAgICAgIH0KICAgICAgICBpZiAob2Zmc2V0ID09PSBzaXplKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmVsb2NhdG9yLmRpc3Bvc2UoKTsKICAgIH0pOwogICAgd3JpdGVyLmRpc3Bvc2UoKTsKICAgIGlmICghZm91bmRDb3JlKSB7CiAgICAgIHRocm93VGhyZWFkU3RhdGVUcmFuc2l0aW9uUGFyc2VFcnJvcigpOwogICAgfQogICAgcmV0dXJuIG5ldyBOYXRpdmVGdW5jdGlvbihwYywgInZvaWQiLCBbInBvaW50ZXIiXSwgbmF0aXZlRnVuY3Rpb25PcHRpb25zMyk7CiAgfQogIGZ1bmN0aW9uIHJlY29tcGlsZUV4Y2VwdGlvbkNsZWFyRm9yQXJtKGJ1ZmZlciwgcGMsIGV4Y2VwdGlvbkNsZWFySW1wbCwgbmV4dEZ1bmNJbXBsLCBleGNlcHRpb25PZmZzZXQsIG5ldXRlcmVkT2Zmc2V0cywgY2FsbGJhY2spIHsKICAgIGNvbnN0IGJsb2NrcyA9IHt9OwogICAgY29uc3QgYnJhbmNoVGFyZ2V0cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICBjb25zdCB0aHVtYkJpdFJlbW92YWxNYXNrID0gcHRyKDEpLm5vdCgpOwogICAgY29uc3QgcGVuZGluZyA9IFtleGNlcHRpb25DbGVhckltcGxdOwogICAgd2hpbGUgKHBlbmRpbmcubGVuZ3RoID4gMCkgewogICAgICBsZXQgY3VycmVudCA9IHBlbmRpbmcuc2hpZnQoKTsKICAgICAgY29uc3QgYWxyZWFkeUNvdmVyZWQgPSBPYmplY3QudmFsdWVzKGJsb2Nrcykuc29tZSgoeyBiZWdpbjogYmVnaW4yLCBlbmQgfSkgPT4gY3VycmVudC5jb21wYXJlKGJlZ2luMikgPj0gMCAmJiBjdXJyZW50LmNvbXBhcmUoZW5kKSA8IDApOwogICAgICBpZiAoYWxyZWFkeUNvdmVyZWQpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25zdCBiZWdpbiA9IGN1cnJlbnQuYW5kKHRodW1iQml0UmVtb3ZhbE1hc2spOwogICAgICBjb25zdCBibG9ja0lkID0gYmVnaW4udG9TdHJpbmcoKTsKICAgICAgY29uc3QgdGh1bWJCaXQgPSBjdXJyZW50LmFuZCgxKTsKICAgICAgbGV0IGJsb2NrID0gewogICAgICAgIGJlZ2luCiAgICAgIH07CiAgICAgIGxldCBsYXN0SW5zbiA9IG51bGw7CiAgICAgIGxldCByZWFjaGVkRW5kT2ZCbG9jayA9IGZhbHNlOwogICAgICBsZXQgaWZUaGVuQmxvY2tSZW1haW5pbmcgPSAwOwogICAgICBkbyB7CiAgICAgICAgaWYgKGN1cnJlbnQuZXF1YWxzKG5leHRGdW5jSW1wbCkpIHsKICAgICAgICAgIHJlYWNoZWRFbmRPZkJsb2NrID0gdHJ1ZTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbnNuID0gSW5zdHJ1Y3Rpb24ucGFyc2UoY3VycmVudCk7CiAgICAgICAgY29uc3QgeyBtbmVtb25pYyB9ID0gaW5zbjsKICAgICAgICBsYXN0SW5zbiA9IGluc247CiAgICAgICAgY29uc3QgY3VycmVudEFkZHJlc3MgPSBjdXJyZW50LmFuZCh0aHVtYkJpdFJlbW92YWxNYXNrKTsKICAgICAgICBjb25zdCBpbnNuSWQgPSBjdXJyZW50QWRkcmVzcy50b1N0cmluZygpOwogICAgICAgIGNvbnN0IGV4aXN0aW5nQmxvY2sgPSBibG9ja3NbaW5zbklkXTsKICAgICAgICBpZiAoZXhpc3RpbmdCbG9jayAhPT0gdm9pZCAwKSB7CiAgICAgICAgICBkZWxldGUgYmxvY2tzW2V4aXN0aW5nQmxvY2suYmVnaW4udG9TdHJpbmcoKV07CiAgICAgICAgICBibG9ja3NbYmxvY2tJZF0gPSBleGlzdGluZ0Jsb2NrOwogICAgICAgICAgZXhpc3RpbmdCbG9jay5iZWdpbiA9IGJsb2NrLmJlZ2luOwogICAgICAgICAgYmxvY2sgPSBudWxsOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGlzT3V0c2lkZUlmVGhlbkJsb2NrID0gaWZUaGVuQmxvY2tSZW1haW5pbmcgPT09IDA7CiAgICAgICAgbGV0IGJyYW5jaFRhcmdldCA9IG51bGw7CiAgICAgICAgc3dpdGNoIChtbmVtb25pYykgewogICAgICAgICAgY2FzZSAiYiI6CiAgICAgICAgICAgIGJyYW5jaFRhcmdldCA9IHB0cihpbnNuLm9wZXJhbmRzWzBdLnZhbHVlKTsKICAgICAgICAgICAgcmVhY2hlZEVuZE9mQmxvY2sgPSBpc091dHNpZGVJZlRoZW5CbG9jazsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJiZXEudyI6CiAgICAgICAgICBjYXNlICJiZXEiOgogICAgICAgICAgY2FzZSAiYm5lIjoKICAgICAgICAgIGNhc2UgImJuZS53IjoKICAgICAgICAgIGNhc2UgImJndCI6CiAgICAgICAgICAgIGJyYW5jaFRhcmdldCA9IHB0cihpbnNuLm9wZXJhbmRzWzBdLnZhbHVlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJjYnoiOgogICAgICAgICAgY2FzZSAiY2JueiI6CiAgICAgICAgICAgIGJyYW5jaFRhcmdldCA9IHB0cihpbnNuLm9wZXJhbmRzWzFdLnZhbHVlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJwb3AudyI6CiAgICAgICAgICAgIGlmIChpc091dHNpZGVJZlRoZW5CbG9jaykgewogICAgICAgICAgICAgIHJlYWNoZWRFbmRPZkJsb2NrID0gaW5zbi5vcGVyYW5kcy5maWx0ZXIoKG9wKSA9PiBvcC52YWx1ZSA9PT0gInBjIikubGVuZ3RoID09PSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBzd2l0Y2ggKG1uZW1vbmljKSB7CiAgICAgICAgICBjYXNlICJpdCI6CiAgICAgICAgICAgIGlmVGhlbkJsb2NrUmVtYWluaW5nID0gMTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJpdHQiOgogICAgICAgICAgICBpZlRoZW5CbG9ja1JlbWFpbmluZyA9IDI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiaXR0dCI6CiAgICAgICAgICAgIGlmVGhlbkJsb2NrUmVtYWluaW5nID0gMzsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJpdHR0dCI6CiAgICAgICAgICAgIGlmVGhlbkJsb2NrUmVtYWluaW5nID0gNDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBpZiAoaWZUaGVuQmxvY2tSZW1haW5pbmcgPiAwKSB7CiAgICAgICAgICAgICAgaWZUaGVuQmxvY2tSZW1haW5pbmctLTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKGJyYW5jaFRhcmdldCAhPT0gbnVsbCkgewogICAgICAgICAgYnJhbmNoVGFyZ2V0cy5hZGQoYnJhbmNoVGFyZ2V0LnRvU3RyaW5nKCkpOwogICAgICAgICAgcGVuZGluZy5wdXNoKGJyYW5jaFRhcmdldC5vcih0aHVtYkJpdCkpOwogICAgICAgICAgcGVuZGluZy5zb3J0KChhLCBiKSA9PiBhLmNvbXBhcmUoYikpOwogICAgICAgIH0KICAgICAgICBjdXJyZW50ID0gaW5zbi5uZXh0OwogICAgICB9IHdoaWxlICghcmVhY2hlZEVuZE9mQmxvY2spOwogICAgICBpZiAoYmxvY2sgIT09IG51bGwpIHsKICAgICAgICBibG9jay5lbmQgPSBsYXN0SW5zbi5hZGRyZXNzLmFkZChsYXN0SW5zbi5zaXplKTsKICAgICAgICBibG9ja3NbYmxvY2tJZF0gPSBibG9jazsKICAgICAgfQogICAgfQogICAgY29uc3QgYmxvY2tzT3JkZXJlZCA9IE9iamVjdC5rZXlzKGJsb2NrcykubWFwKChrZXkpID0+IGJsb2Nrc1trZXldKTsKICAgIGJsb2Nrc09yZGVyZWQuc29ydCgoYSwgYikgPT4gYS5iZWdpbi5jb21wYXJlKGIuYmVnaW4pKTsKICAgIGNvbnN0IGVudHJ5QmxvY2sgPSBibG9ja3NbZXhjZXB0aW9uQ2xlYXJJbXBsLmFuZCh0aHVtYkJpdFJlbW92YWxNYXNrKS50b1N0cmluZygpXTsKICAgIGJsb2Nrc09yZGVyZWQuc3BsaWNlKGJsb2Nrc09yZGVyZWQuaW5kZXhPZihlbnRyeUJsb2NrKSwgMSk7CiAgICBibG9ja3NPcmRlcmVkLnVuc2hpZnQoZW50cnlCbG9jayk7CiAgICBjb25zdCB3cml0ZXIgPSBuZXcgVGh1bWJXcml0ZXIoYnVmZmVyLCB7IHBjIH0pOwogICAgbGV0IGZvdW5kQ29yZSA9IGZhbHNlOwogICAgbGV0IHRocmVhZFJlZyA9IG51bGw7CiAgICBsZXQgcmVhbEltcGxSZWcgPSBudWxsOwogICAgYmxvY2tzT3JkZXJlZC5mb3JFYWNoKChibG9jaykgPT4gewogICAgICBjb25zdCByZWxvY2F0b3IgPSBuZXcgVGh1bWJSZWxvY2F0b3IoYmxvY2suYmVnaW4sIHdyaXRlcik7CiAgICAgIGxldCBhZGRyZXNzID0gYmxvY2suYmVnaW47CiAgICAgIGNvbnN0IGVuZCA9IGJsb2NrLmVuZDsKICAgICAgbGV0IHNpemUgPSAwOwogICAgICBkbyB7CiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gcmVsb2NhdG9yLnJlYWRPbmUoKTsKICAgICAgICBpZiAob2Zmc2V0ID09PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgZW5kIG9mIGJsb2NrIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGluc24gPSByZWxvY2F0b3IuaW5wdXQ7CiAgICAgICAgYWRkcmVzcyA9IGluc24uYWRkcmVzczsKICAgICAgICBzaXplID0gaW5zbi5zaXplOwogICAgICAgIGNvbnN0IHsgbW5lbW9uaWMgfSA9IGluc247CiAgICAgICAgY29uc3QgaW5zbkFkZHJlc3NJZCA9IGFkZHJlc3MudG9TdHJpbmcoKTsKICAgICAgICBpZiAoYnJhbmNoVGFyZ2V0cy5oYXMoaW5zbkFkZHJlc3NJZCkpIHsKICAgICAgICAgIHdyaXRlci5wdXRMYWJlbChpbnNuQWRkcmVzc0lkKTsKICAgICAgICB9CiAgICAgICAgbGV0IGtlZXAgPSB0cnVlOwogICAgICAgIHN3aXRjaCAobW5lbW9uaWMpIHsKICAgICAgICAgIGNhc2UgImIiOgogICAgICAgICAgICB3cml0ZXIucHV0QkxhYmVsKGJyYW5jaExhYmVsRnJvbU9wZXJhbmQoaW5zbi5vcGVyYW5kc1swXSkpOwogICAgICAgICAgICBrZWVwID0gZmFsc2U7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiYmVxLnciOgogICAgICAgICAgICB3cml0ZXIucHV0QkNvbmRMYWJlbFdpZGUoImVxIiwgYnJhbmNoTGFiZWxGcm9tT3BlcmFuZChpbnNuLm9wZXJhbmRzWzBdKSk7CiAgICAgICAgICAgIGtlZXAgPSBmYWxzZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJibmUudyI6CiAgICAgICAgICAgIHdyaXRlci5wdXRCQ29uZExhYmVsV2lkZSgibmUiLCBicmFuY2hMYWJlbEZyb21PcGVyYW5kKGluc24ub3BlcmFuZHNbMF0pKTsKICAgICAgICAgICAga2VlcCA9IGZhbHNlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgImJlcSI6CiAgICAgICAgICBjYXNlICJibmUiOgogICAgICAgICAgY2FzZSAiYmd0IjoKICAgICAgICAgICAgd3JpdGVyLnB1dEJDb25kTGFiZWxXaWRlKG1uZW1vbmljLnN1YnN0cigxKSwgYnJhbmNoTGFiZWxGcm9tT3BlcmFuZChpbnNuLm9wZXJhbmRzWzBdKSk7CiAgICAgICAgICAgIGtlZXAgPSBmYWxzZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJjYnoiOiB7CiAgICAgICAgICAgIGNvbnN0IG9wcyA9IGluc24ub3BlcmFuZHM7CiAgICAgICAgICAgIHdyaXRlci5wdXRDYnpSZWdMYWJlbChvcHNbMF0udmFsdWUsIGJyYW5jaExhYmVsRnJvbU9wZXJhbmQob3BzWzFdKSk7CiAgICAgICAgICAgIGtlZXAgPSBmYWxzZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlICJjYm56IjogewogICAgICAgICAgICBjb25zdCBvcHMgPSBpbnNuLm9wZXJhbmRzOwogICAgICAgICAgICB3cml0ZXIucHV0Q2JuelJlZ0xhYmVsKG9wc1swXS52YWx1ZSwgYnJhbmNoTGFiZWxGcm9tT3BlcmFuZChvcHNbMV0pKTsKICAgICAgICAgICAga2VlcCA9IGZhbHNlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgInN0ciI6CiAgICAgICAgICBjYXNlICJzdHIudyI6IHsKICAgICAgICAgICAgY29uc3QgZHN0VmFsdWUgPSBpbnNuLm9wZXJhbmRzWzFdLnZhbHVlOwogICAgICAgICAgICBjb25zdCBkc3RPZmZzZXQgPSBkc3RWYWx1ZS5kaXNwOwogICAgICAgICAgICBpZiAoZHN0T2Zmc2V0ID09PSBleGNlcHRpb25PZmZzZXQpIHsKICAgICAgICAgICAgICB0aHJlYWRSZWcgPSBkc3RWYWx1ZS5iYXNlOwogICAgICAgICAgICAgIGNvbnN0IG56Y3ZxUmVnID0gdGhyZWFkUmVnICE9PSAicjQiID8gInI0IiA6ICJyNSI7CiAgICAgICAgICAgICAgY29uc3QgY2xvYmJlcmVkUmVncyA9IFsicjAiLCAicjEiLCAicjIiLCAicjMiLCBuemN2cVJlZywgInI5IiwgInIxMiIsICJsciJdOwogICAgICAgICAgICAgIHdyaXRlci5wdXRQdXNoUmVncyhjbG9iYmVyZWRSZWdzKTsKICAgICAgICAgICAgICB3cml0ZXIucHV0TXJzUmVnUmVnKG56Y3ZxUmVnLCAiYXBzci1uemN2cSIpOwogICAgICAgICAgICAgIHdyaXRlci5wdXRDYWxsQWRkcmVzc1dpdGhBcmd1bWVudHMoY2FsbGJhY2ssIFt0aHJlYWRSZWddKTsKICAgICAgICAgICAgICB3cml0ZXIucHV0TXNyUmVnUmVnKCJhcHNyLW56Y3ZxIiwgbnpjdnFSZWcpOwogICAgICAgICAgICAgIHdyaXRlci5wdXRQb3BSZWdzKGNsb2JiZXJlZFJlZ3MpOwogICAgICAgICAgICAgIGZvdW5kQ29yZSA9IHRydWU7CiAgICAgICAgICAgICAga2VlcCA9IGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5ldXRlcmVkT2Zmc2V0cy5oYXMoZHN0T2Zmc2V0KSAmJiBkc3RWYWx1ZS5iYXNlID09PSB0aHJlYWRSZWcpIHsKICAgICAgICAgICAgICBrZWVwID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlICJsZHIiOiB7CiAgICAgICAgICAgIGNvbnN0IFtkc3RPcCwgc3JjT3BdID0gaW5zbi5vcGVyYW5kczsKICAgICAgICAgICAgaWYgKHNyY09wLnR5cGUgPT09ICJtZW0iKSB7CiAgICAgICAgICAgICAgY29uc3Qgc3JjID0gc3JjT3AudmFsdWU7CiAgICAgICAgICAgICAgaWYgKHNyYy5iYXNlWzBdID09PSAiciIgJiYgc3JjLmRpc3AgPT09IEVOVl9WVEFCTEVfT0ZGU0VUX0VYQ0VQVElPTl9DTEVBUikgewogICAgICAgICAgICAgICAgcmVhbEltcGxSZWcgPSBkc3RPcC52YWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlICJibHgiOgogICAgICAgICAgICBpZiAoaW5zbi5vcGVyYW5kc1swXS52YWx1ZSA9PT0gcmVhbEltcGxSZWcpIHsKICAgICAgICAgICAgICB3cml0ZXIucHV0TGRyUmVnUmVnT2Zmc2V0KCJyMCIsICJyMCIsIDQpOwogICAgICAgICAgICAgIHdyaXRlci5wdXRDYWxsQWRkcmVzc1dpdGhBcmd1bWVudHMoY2FsbGJhY2ssIFsicjAiXSk7CiAgICAgICAgICAgICAgZm91bmRDb3JlID0gdHJ1ZTsKICAgICAgICAgICAgICByZWFsSW1wbFJlZyA9IG51bGw7CiAgICAgICAgICAgICAga2VlcCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBpZiAoa2VlcCkgewogICAgICAgICAgcmVsb2NhdG9yLndyaXRlQWxsKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlbG9jYXRvci5za2lwT25lKCk7CiAgICAgICAgfQogICAgICB9IHdoaWxlICghYWRkcmVzcy5hZGQoc2l6ZSkuZXF1YWxzKGVuZCkpOwogICAgICByZWxvY2F0b3IuZGlzcG9zZSgpOwogICAgfSk7CiAgICB3cml0ZXIuZGlzcG9zZSgpOwogICAgaWYgKCFmb3VuZENvcmUpIHsKICAgICAgdGhyb3dUaHJlYWRTdGF0ZVRyYW5zaXRpb25QYXJzZUVycm9yKCk7CiAgICB9CiAgICByZXR1cm4gbmV3IE5hdGl2ZUZ1bmN0aW9uKHBjLm9yKDEpLCAidm9pZCIsIFsicG9pbnRlciJdLCBuYXRpdmVGdW5jdGlvbk9wdGlvbnMzKTsKICB9CiAgZnVuY3Rpb24gcmVjb21waWxlRXhjZXB0aW9uQ2xlYXJGb3JBcm02NChidWZmZXIsIHBjLCBleGNlcHRpb25DbGVhckltcGwsIG5leHRGdW5jSW1wbCwgZXhjZXB0aW9uT2Zmc2V0LCBuZXV0ZXJlZE9mZnNldHMsIGNhbGxiYWNrKSB7CiAgICBjb25zdCBibG9ja3MgPSB7fTsKICAgIGNvbnN0IGJyYW5jaFRhcmdldHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgY29uc3QgcGVuZGluZyA9IFtleGNlcHRpb25DbGVhckltcGxdOwogICAgd2hpbGUgKHBlbmRpbmcubGVuZ3RoID4gMCkgewogICAgICBsZXQgY3VycmVudCA9IHBlbmRpbmcuc2hpZnQoKTsKICAgICAgY29uc3QgYWxyZWFkeUNvdmVyZWQgPSBPYmplY3QudmFsdWVzKGJsb2Nrcykuc29tZSgoeyBiZWdpbiwgZW5kIH0pID0+IGN1cnJlbnQuY29tcGFyZShiZWdpbikgPj0gMCAmJiBjdXJyZW50LmNvbXBhcmUoZW5kKSA8IDApOwogICAgICBpZiAoYWxyZWFkeUNvdmVyZWQpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25zdCBibG9ja0FkZHJlc3NLZXkgPSBjdXJyZW50LnRvU3RyaW5nKCk7CiAgICAgIGxldCBibG9jayA9IHsKICAgICAgICBiZWdpbjogY3VycmVudAogICAgICB9OwogICAgICBsZXQgbGFzdEluc24gPSBudWxsOwogICAgICBsZXQgcmVhY2hlZEVuZE9mQmxvY2sgPSBmYWxzZTsKICAgICAgZG8gewogICAgICAgIGlmIChjdXJyZW50LmVxdWFscyhuZXh0RnVuY0ltcGwpKSB7CiAgICAgICAgICByZWFjaGVkRW5kT2ZCbG9jayA9IHRydWU7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgbGV0IGluc247CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGluc24gPSBJbnN0cnVjdGlvbi5wYXJzZShjdXJyZW50KTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBpZiAoY3VycmVudC5yZWFkVTMyKCkgPT09IDApIHsKICAgICAgICAgICAgcmVhY2hlZEVuZE9mQmxvY2sgPSB0cnVlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxhc3RJbnNuID0gaW5zbjsKICAgICAgICBjb25zdCBleGlzdGluZ0Jsb2NrID0gYmxvY2tzW2luc24uYWRkcmVzcy50b1N0cmluZygpXTsKICAgICAgICBpZiAoZXhpc3RpbmdCbG9jayAhPT0gdm9pZCAwKSB7CiAgICAgICAgICBkZWxldGUgYmxvY2tzW2V4aXN0aW5nQmxvY2suYmVnaW4udG9TdHJpbmcoKV07CiAgICAgICAgICBibG9ja3NbYmxvY2tBZGRyZXNzS2V5XSA9IGV4aXN0aW5nQmxvY2s7CiAgICAgICAgICBleGlzdGluZ0Jsb2NrLmJlZ2luID0gYmxvY2suYmVnaW47CiAgICAgICAgICBibG9jayA9IG51bGw7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgbGV0IGJyYW5jaFRhcmdldCA9IG51bGw7CiAgICAgICAgc3dpdGNoIChpbnNuLm1uZW1vbmljKSB7CiAgICAgICAgICBjYXNlICJiIjoKICAgICAgICAgICAgYnJhbmNoVGFyZ2V0ID0gcHRyKGluc24ub3BlcmFuZHNbMF0udmFsdWUpOwogICAgICAgICAgICByZWFjaGVkRW5kT2ZCbG9jayA9IHRydWU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiYi5lcSI6CiAgICAgICAgICBjYXNlICJiLm5lIjoKICAgICAgICAgIGNhc2UgImIubGUiOgogICAgICAgICAgY2FzZSAiYi5ndCI6CiAgICAgICAgICAgIGJyYW5jaFRhcmdldCA9IHB0cihpbnNuLm9wZXJhbmRzWzBdLnZhbHVlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJjYnoiOgogICAgICAgICAgY2FzZSAiY2JueiI6CiAgICAgICAgICAgIGJyYW5jaFRhcmdldCA9IHB0cihpbnNuLm9wZXJhbmRzWzFdLnZhbHVlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJ0YnoiOgogICAgICAgICAgY2FzZSAidGJueiI6CiAgICAgICAgICAgIGJyYW5jaFRhcmdldCA9IHB0cihpbnNuLm9wZXJhbmRzWzJdLnZhbHVlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJyZXQiOgogICAgICAgICAgICByZWFjaGVkRW5kT2ZCbG9jayA9IHRydWU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBpZiAoYnJhbmNoVGFyZ2V0ICE9PSBudWxsKSB7CiAgICAgICAgICBicmFuY2hUYXJnZXRzLmFkZChicmFuY2hUYXJnZXQudG9TdHJpbmcoKSk7CiAgICAgICAgICBwZW5kaW5nLnB1c2goYnJhbmNoVGFyZ2V0KTsKICAgICAgICAgIHBlbmRpbmcuc29ydCgoYSwgYikgPT4gYS5jb21wYXJlKGIpKTsKICAgICAgICB9CiAgICAgICAgY3VycmVudCA9IGluc24ubmV4dDsKICAgICAgfSB3aGlsZSAoIXJlYWNoZWRFbmRPZkJsb2NrKTsKICAgICAgaWYgKGJsb2NrICE9PSBudWxsKSB7CiAgICAgICAgYmxvY2suZW5kID0gbGFzdEluc24uYWRkcmVzcy5hZGQobGFzdEluc24uc2l6ZSk7CiAgICAgICAgYmxvY2tzW2Jsb2NrQWRkcmVzc0tleV0gPSBibG9jazsKICAgICAgfQogICAgfQogICAgY29uc3QgYmxvY2tzT3JkZXJlZCA9IE9iamVjdC5rZXlzKGJsb2NrcykubWFwKChrZXkpID0+IGJsb2Nrc1trZXldKTsKICAgIGJsb2Nrc09yZGVyZWQuc29ydCgoYSwgYikgPT4gYS5iZWdpbi5jb21wYXJlKGIuYmVnaW4pKTsKICAgIGNvbnN0IGVudHJ5QmxvY2sgPSBibG9ja3NbZXhjZXB0aW9uQ2xlYXJJbXBsLnRvU3RyaW5nKCldOwogICAgYmxvY2tzT3JkZXJlZC5zcGxpY2UoYmxvY2tzT3JkZXJlZC5pbmRleE9mKGVudHJ5QmxvY2spLCAxKTsKICAgIGJsb2Nrc09yZGVyZWQudW5zaGlmdChlbnRyeUJsb2NrKTsKICAgIGNvbnN0IHdyaXRlciA9IG5ldyBBcm02NFdyaXRlcihidWZmZXIsIHsgcGMgfSk7CiAgICB3cml0ZXIucHV0QkxhYmVsKCJwZXJmb3JtVHJhbnNpdGlvbiIpOwogICAgY29uc3QgaW52b2tlQ2FsbGJhY2sgPSBwYy5hZGQod3JpdGVyLm9mZnNldCk7CiAgICB3cml0ZXIucHV0UHVzaEFsbFhSZWdpc3RlcnMoKTsKICAgIHdyaXRlci5wdXRDYWxsQWRkcmVzc1dpdGhBcmd1bWVudHMoY2FsbGJhY2ssIFsieDAiXSk7CiAgICB3cml0ZXIucHV0UG9wQWxsWFJlZ2lzdGVycygpOwogICAgd3JpdGVyLnB1dFJldCgpOwogICAgd3JpdGVyLnB1dExhYmVsKCJwZXJmb3JtVHJhbnNpdGlvbiIpOwogICAgbGV0IGZvdW5kQ29yZSA9IGZhbHNlOwogICAgbGV0IHRocmVhZFJlZyA9IG51bGw7CiAgICBsZXQgcmVhbEltcGxSZWcgPSBudWxsOwogICAgYmxvY2tzT3JkZXJlZC5mb3JFYWNoKChibG9jaykgPT4gewogICAgICBjb25zdCBzaXplID0gYmxvY2suZW5kLnN1YihibG9jay5iZWdpbikudG9JbnQzMigpOwogICAgICBjb25zdCByZWxvY2F0b3IgPSBuZXcgQXJtNjRSZWxvY2F0b3IoYmxvY2suYmVnaW4sIHdyaXRlcik7CiAgICAgIGxldCBvZmZzZXQ7CiAgICAgIHdoaWxlICgob2Zmc2V0ID0gcmVsb2NhdG9yLnJlYWRPbmUoKSkgIT09IDApIHsKICAgICAgICBjb25zdCBpbnNuID0gcmVsb2NhdG9yLmlucHV0OwogICAgICAgIGNvbnN0IHsgbW5lbW9uaWMgfSA9IGluc247CiAgICAgICAgY29uc3QgaW5zbkFkZHJlc3NJZCA9IGluc24uYWRkcmVzcy50b1N0cmluZygpOwogICAgICAgIGlmIChicmFuY2hUYXJnZXRzLmhhcyhpbnNuQWRkcmVzc0lkKSkgewogICAgICAgICAgd3JpdGVyLnB1dExhYmVsKGluc25BZGRyZXNzSWQpOwogICAgICAgIH0KICAgICAgICBsZXQga2VlcCA9IHRydWU7CiAgICAgICAgc3dpdGNoIChtbmVtb25pYykgewogICAgICAgICAgY2FzZSAiYiI6CiAgICAgICAgICAgIHdyaXRlci5wdXRCTGFiZWwoYnJhbmNoTGFiZWxGcm9tT3BlcmFuZChpbnNuLm9wZXJhbmRzWzBdKSk7CiAgICAgICAgICAgIGtlZXAgPSBmYWxzZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJiLmVxIjoKICAgICAgICAgIGNhc2UgImIubmUiOgogICAgICAgICAgY2FzZSAiYi5sZSI6CiAgICAgICAgICBjYXNlICJiLmd0IjoKICAgICAgICAgICAgd3JpdGVyLnB1dEJDb25kTGFiZWwobW5lbW9uaWMuc3Vic3RyKDIpLCBicmFuY2hMYWJlbEZyb21PcGVyYW5kKGluc24ub3BlcmFuZHNbMF0pKTsKICAgICAgICAgICAga2VlcCA9IGZhbHNlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgImNieiI6IHsKICAgICAgICAgICAgY29uc3Qgb3BzID0gaW5zbi5vcGVyYW5kczsKICAgICAgICAgICAgd3JpdGVyLnB1dENielJlZ0xhYmVsKG9wc1swXS52YWx1ZSwgYnJhbmNoTGFiZWxGcm9tT3BlcmFuZChvcHNbMV0pKTsKICAgICAgICAgICAga2VlcCA9IGZhbHNlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgImNibnoiOiB7CiAgICAgICAgICAgIGNvbnN0IG9wcyA9IGluc24ub3BlcmFuZHM7CiAgICAgICAgICAgIHdyaXRlci5wdXRDYm56UmVnTGFiZWwob3BzWzBdLnZhbHVlLCBicmFuY2hMYWJlbEZyb21PcGVyYW5kKG9wc1sxXSkpOwogICAgICAgICAgICBrZWVwID0gZmFsc2U7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSAidGJ6IjogewogICAgICAgICAgICBjb25zdCBvcHMgPSBpbnNuLm9wZXJhbmRzOwogICAgICAgICAgICB3cml0ZXIucHV0VGJ6UmVnSW1tTGFiZWwob3BzWzBdLnZhbHVlLCBvcHNbMV0udmFsdWUudmFsdWVPZigpLCBicmFuY2hMYWJlbEZyb21PcGVyYW5kKG9wc1syXSkpOwogICAgICAgICAgICBrZWVwID0gZmFsc2U7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSAidGJueiI6IHsKICAgICAgICAgICAgY29uc3Qgb3BzID0gaW5zbi5vcGVyYW5kczsKICAgICAgICAgICAgd3JpdGVyLnB1dFRibnpSZWdJbW1MYWJlbChvcHNbMF0udmFsdWUsIG9wc1sxXS52YWx1ZS52YWx1ZU9mKCksIGJyYW5jaExhYmVsRnJvbU9wZXJhbmQob3BzWzJdKSk7CiAgICAgICAgICAgIGtlZXAgPSBmYWxzZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlICJzdHIiOiB7CiAgICAgICAgICAgIGNvbnN0IG9wcyA9IGluc24ub3BlcmFuZHM7CiAgICAgICAgICAgIGNvbnN0IHNyY1JlZyA9IG9wc1swXS52YWx1ZTsKICAgICAgICAgICAgY29uc3QgZHN0VmFsdWUgPSBvcHNbMV0udmFsdWU7CiAgICAgICAgICAgIGNvbnN0IGRzdE9mZnNldCA9IGRzdFZhbHVlLmRpc3A7CiAgICAgICAgICAgIGlmIChzcmNSZWcgPT09ICJ4enIiICYmIGRzdE9mZnNldCA9PT0gZXhjZXB0aW9uT2Zmc2V0KSB7CiAgICAgICAgICAgICAgdGhyZWFkUmVnID0gZHN0VmFsdWUuYmFzZTsKICAgICAgICAgICAgICB3cml0ZXIucHV0UHVzaFJlZ1JlZygieDAiLCAibHIiKTsKICAgICAgICAgICAgICB3cml0ZXIucHV0TW92UmVnUmVnKCJ4MCIsIHRocmVhZFJlZyk7CiAgICAgICAgICAgICAgd3JpdGVyLnB1dEJsSW1tKGludm9rZUNhbGxiYWNrKTsKICAgICAgICAgICAgICB3cml0ZXIucHV0UG9wUmVnUmVnKCJ4MCIsICJsciIpOwogICAgICAgICAgICAgIGZvdW5kQ29yZSA9IHRydWU7CiAgICAgICAgICAgICAga2VlcCA9IGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5ldXRlcmVkT2Zmc2V0cy5oYXMoZHN0T2Zmc2V0KSAmJiBkc3RWYWx1ZS5iYXNlID09PSB0aHJlYWRSZWcpIHsKICAgICAgICAgICAgICBrZWVwID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlICJsZHIiOiB7CiAgICAgICAgICAgIGNvbnN0IG9wcyA9IGluc24ub3BlcmFuZHM7CiAgICAgICAgICAgIGNvbnN0IHNyYyA9IG9wc1sxXS52YWx1ZTsKICAgICAgICAgICAgaWYgKHNyYy5iYXNlWzBdID09PSAieCIgJiYgc3JjLmRpc3AgPT09IEVOVl9WVEFCTEVfT0ZGU0VUX0VYQ0VQVElPTl9DTEVBUikgewogICAgICAgICAgICAgIHJlYWxJbXBsUmVnID0gb3BzWzBdLnZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSAiYmxyIjoKICAgICAgICAgICAgaWYgKGluc24ub3BlcmFuZHNbMF0udmFsdWUgPT09IHJlYWxJbXBsUmVnKSB7CiAgICAgICAgICAgICAgd3JpdGVyLnB1dExkclJlZ1JlZ09mZnNldCgieDAiLCAieDAiLCA4KTsKICAgICAgICAgICAgICB3cml0ZXIucHV0Q2FsbEFkZHJlc3NXaXRoQXJndW1lbnRzKGNhbGxiYWNrLCBbIngwIl0pOwogICAgICAgICAgICAgIGZvdW5kQ29yZSA9IHRydWU7CiAgICAgICAgICAgICAgcmVhbEltcGxSZWcgPSBudWxsOwogICAgICAgICAgICAgIGtlZXAgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKGtlZXApIHsKICAgICAgICAgIHJlbG9jYXRvci53cml0ZUFsbCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZWxvY2F0b3Iuc2tpcE9uZSgpOwogICAgICAgIH0KICAgICAgICBpZiAob2Zmc2V0ID09PSBzaXplKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmVsb2NhdG9yLmRpc3Bvc2UoKTsKICAgIH0pOwogICAgd3JpdGVyLmRpc3Bvc2UoKTsKICAgIGlmICghZm91bmRDb3JlKSB7CiAgICAgIHRocm93VGhyZWFkU3RhdGVUcmFuc2l0aW9uUGFyc2VFcnJvcigpOwogICAgfQogICAgcmV0dXJuIG5ldyBOYXRpdmVGdW5jdGlvbihwYywgInZvaWQiLCBbInBvaW50ZXIiXSwgbmF0aXZlRnVuY3Rpb25PcHRpb25zMyk7CiAgfQogIGZ1bmN0aW9uIHRocm93VGhyZWFkU3RhdGVUcmFuc2l0aW9uUGFyc2VFcnJvcigpIHsKICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIHBhcnNlIEFSVCBpbnRlcm5hbHM7IHBsZWFzZSBmaWxlIGEgYnVnIik7CiAgfQogIGZ1bmN0aW9uIGZpeHVwQXJ0UXVpY2tEZWxpdmVyRXhjZXB0aW9uQnVnKGFwaTIpIHsKICAgIGNvbnN0IHByZXR0eU1ldGhvZCA9IGFwaTJbImFydDo6QXJ0TWV0aG9kOjpQcmV0dHlNZXRob2QiXTsKICAgIGlmIChwcmV0dHlNZXRob2QgPT09IHZvaWQgMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBJbnRlcmNlcHRvci5hdHRhY2gocHJldHR5TWV0aG9kLmltcGwsIGFydENvbnRyb2xsZXIuaG9va3MuQXJ0TWV0aG9kLnByZXR0eU1ldGhvZCk7CiAgICBJbnRlcmNlcHRvci5mbHVzaCgpOwogIH0KICBmdW5jdGlvbiBicmFuY2hMYWJlbEZyb21PcGVyYW5kKG9wKSB7CiAgICByZXR1cm4gcHRyKG9wLnZhbHVlKS50b1N0cmluZygpOwogIH0KICBmdW5jdGlvbiBtYWtlQ3h4TWV0aG9kV3JhcHBlclJldHVybmluZ1BvaW50ZXJCeVZhbHVlR2VuZXJpYyhhZGRyZXNzLCBhcmdUeXBlcykgewogICAgcmV0dXJuIG5ldyBOYXRpdmVGdW5jdGlvbihhZGRyZXNzLCAicG9pbnRlciIsIGFyZ1R5cGVzLCBuYXRpdmVGdW5jdGlvbk9wdGlvbnMzKTsKICB9CiAgZnVuY3Rpb24gbWFrZUN4eE1ldGhvZFdyYXBwZXJSZXR1cm5pbmdQb2ludGVyQnlWYWx1ZUluRmlyc3RBcmcoYWRkcmVzcywgYXJnVHlwZXMpIHsKICAgIGNvbnN0IGltcGwgPSBuZXcgTmF0aXZlRnVuY3Rpb24oYWRkcmVzcywgInZvaWQiLCBbInBvaW50ZXIiXS5jb25jYXQoYXJnVHlwZXMpLCBuYXRpdmVGdW5jdGlvbk9wdGlvbnMzKTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgY29uc3QgcmVzdWx0UHRyID0gTWVtb3J5LmFsbG9jKHBvaW50ZXJTaXplNSk7CiAgICAgIGltcGwocmVzdWx0UHRyLCAuLi5hcmd1bWVudHMpOwogICAgICByZXR1cm4gcmVzdWx0UHRyLnJlYWRQb2ludGVyKCk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBtYWtlQ3h4TWV0aG9kV3JhcHBlclJldHVybmluZ1N0ZFN0cmluZ0J5VmFsdWUoaW1wbCwgYXJnVHlwZXMpIHsKICAgIGNvbnN0IHsgYXJjaCB9ID0gUHJvY2VzczsKICAgIHN3aXRjaCAoYXJjaCkgewogICAgICBjYXNlICJpYTMyIjoKICAgICAgY2FzZSAiYXJtNjQiOiB7CiAgICAgICAgbGV0IHRodW5rOwogICAgICAgIGlmIChhcmNoID09PSAiaWEzMiIpIHsKICAgICAgICAgIHRodW5rID0gbWFrZVRodW5rKDY0LCAod3JpdGVyKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGFyZ0NvdW50ID0gMSArIGFyZ1R5cGVzLmxlbmd0aDsKICAgICAgICAgICAgY29uc3QgYXJndlNpemUgPSBhcmdDb3VudCAqIDQ7CiAgICAgICAgICAgIHdyaXRlci5wdXRTdWJSZWdJbW0oImVzcCIsIGFyZ3ZTaXplKTsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IGFyZ0NvdW50OyBpKyspIHsKICAgICAgICAgICAgICBjb25zdCBvZmZzZXQgPSBpICogNDsKICAgICAgICAgICAgICB3cml0ZXIucHV0TW92UmVnUmVnT2Zmc2V0UHRyKCJlYXgiLCAiZXNwIiwgYXJndlNpemUgKyA0ICsgb2Zmc2V0KTsKICAgICAgICAgICAgICB3cml0ZXIucHV0TW92UmVnT2Zmc2V0UHRyUmVnKCJlc3AiLCBvZmZzZXQsICJlYXgiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3cml0ZXIucHV0Q2FsbEFkZHJlc3MoaW1wbCk7CiAgICAgICAgICAgIHdyaXRlci5wdXRBZGRSZWdJbW0oImVzcCIsIGFyZ3ZTaXplIC0gNCk7CiAgICAgICAgICAgIHdyaXRlci5wdXRSZXQoKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHVuayA9IG1ha2VUaHVuaygzMiwgKHdyaXRlcikgPT4gewogICAgICAgICAgICB3cml0ZXIucHV0TW92UmVnUmVnKCJ4OCIsICJ4MCIpOwogICAgICAgICAgICBhcmdUeXBlcy5mb3JFYWNoKCh0LCBpKSA9PiB7CiAgICAgICAgICAgICAgd3JpdGVyLnB1dE1vdlJlZ1JlZygieCIgKyBpLCAieCIgKyAoaSArIDEpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHdyaXRlci5wdXRMZHJSZWdBZGRyZXNzKCJ4NyIsIGltcGwpOwogICAgICAgICAgICB3cml0ZXIucHV0QnJSZWcoIng3Iik7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgaW52b2tlVGh1bmsgPSBuZXcgTmF0aXZlRnVuY3Rpb24odGh1bmssICJ2b2lkIiwgWyJwb2ludGVyIl0uY29uY2F0KGFyZ1R5cGVzKSwgbmF0aXZlRnVuY3Rpb25PcHRpb25zMyk7CiAgICAgICAgY29uc3Qgd3JhcHBlciA9IGZ1bmN0aW9uKC4uLmFyZ3MpIHsKICAgICAgICAgIGludm9rZVRodW5rKC4uLmFyZ3MpOwogICAgICAgIH07CiAgICAgICAgd3JhcHBlci5oYW5kbGUgPSB0aHVuazsKICAgICAgICB3cmFwcGVyLmltcGwgPSBpbXBsOwogICAgICAgIHJldHVybiB3cmFwcGVyOwogICAgICB9CiAgICAgIGRlZmF1bHQ6IHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgTmF0aXZlRnVuY3Rpb24oaW1wbCwgInZvaWQiLCBbInBvaW50ZXIiXS5jb25jYXQoYXJnVHlwZXMpLCBuYXRpdmVGdW5jdGlvbk9wdGlvbnMzKTsKICAgICAgICByZXN1bHQuaW1wbCA9IGltcGw7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgfQogIH0KICB2YXIgU3RkU3RyaW5nID0gY2xhc3MgewogICAgY29uc3RydWN0b3IoKSB7CiAgICAgIHRoaXMuaGFuZGxlID0gTWVtb3J5LmFsbG9jKFNURF9TVFJJTkdfU0laRSk7CiAgICB9CiAgICBkaXNwb3NlKCkgewogICAgICBjb25zdCBbZGF0YSwgaXNUaW55XSA9IHRoaXMuX2dldERhdGEoKTsKICAgICAgaWYgKCFpc1RpbnkpIHsKICAgICAgICBnZXRBcGkoKS4kZGVsZXRlKGRhdGEpOwogICAgICB9CiAgICB9CiAgICBkaXNwb3NlVG9TdHJpbmcoKSB7CiAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMudG9TdHJpbmcoKTsKICAgICAgdGhpcy5kaXNwb3NlKCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICB0b1N0cmluZygpIHsKICAgICAgY29uc3QgW2RhdGFdID0gdGhpcy5fZ2V0RGF0YSgpOwogICAgICByZXR1cm4gZGF0YS5yZWFkVXRmOFN0cmluZygpOwogICAgfQogICAgX2dldERhdGEoKSB7CiAgICAgIGNvbnN0IHN0ciA9IHRoaXMuaGFuZGxlOwogICAgICBjb25zdCBpc1RpbnkgPSAoc3RyLnJlYWRVOCgpICYgMSkgPT09IDA7CiAgICAgIGNvbnN0IGRhdGEgPSBpc1RpbnkgPyBzdHIuYWRkKDEpIDogc3RyLmFkZCgyICogcG9pbnRlclNpemU1KS5yZWFkUG9pbnRlcigpOwogICAgICByZXR1cm4gW2RhdGEsIGlzVGlueV07CiAgICB9CiAgfTsKICB2YXIgU3RkVmVjdG9yID0gY2xhc3MgewogICAgJGRlbGV0ZSgpIHsKICAgICAgdGhpcy5kaXNwb3NlKCk7CiAgICAgIGdldEFwaSgpLiRkZWxldGUodGhpcyk7CiAgICB9CiAgICBjb25zdHJ1Y3RvcihzdG9yYWdlLCBlbGVtZW50U2l6ZSkgewogICAgICB0aGlzLmhhbmRsZSA9IHN0b3JhZ2U7CiAgICAgIHRoaXMuX2JlZ2luID0gc3RvcmFnZTsKICAgICAgdGhpcy5fZW5kID0gc3RvcmFnZS5hZGQocG9pbnRlclNpemU1KTsKICAgICAgdGhpcy5fc3RvcmFnZSA9IHN0b3JhZ2UuYWRkKDIgKiBwb2ludGVyU2l6ZTUpOwogICAgICB0aGlzLl9lbGVtZW50U2l6ZSA9IGVsZW1lbnRTaXplOwogICAgfQogICAgaW5pdCgpIHsKICAgICAgdGhpcy5iZWdpbiA9IE5VTEw7CiAgICAgIHRoaXMuZW5kID0gTlVMTDsKICAgICAgdGhpcy5zdG9yYWdlID0gTlVMTDsKICAgIH0KICAgIGRpc3Bvc2UoKSB7CiAgICAgIGdldEFwaSgpLiRkZWxldGUodGhpcy5iZWdpbik7CiAgICB9CiAgICBnZXQgYmVnaW4oKSB7CiAgICAgIHJldHVybiB0aGlzLl9iZWdpbi5yZWFkUG9pbnRlcigpOwogICAgfQogICAgc2V0IGJlZ2luKHZhbHVlKSB7CiAgICAgIHRoaXMuX2JlZ2luLndyaXRlUG9pbnRlcih2YWx1ZSk7CiAgICB9CiAgICBnZXQgZW5kKCkgewogICAgICByZXR1cm4gdGhpcy5fZW5kLnJlYWRQb2ludGVyKCk7CiAgICB9CiAgICBzZXQgZW5kKHZhbHVlKSB7CiAgICAgIHRoaXMuX2VuZC53cml0ZVBvaW50ZXIodmFsdWUpOwogICAgfQogICAgZ2V0IHN0b3JhZ2UoKSB7CiAgICAgIHJldHVybiB0aGlzLl9zdG9yYWdlLnJlYWRQb2ludGVyKCk7CiAgICB9CiAgICBzZXQgc3RvcmFnZSh2YWx1ZSkgewogICAgICB0aGlzLl9zdG9yYWdlLndyaXRlUG9pbnRlcih2YWx1ZSk7CiAgICB9CiAgICBnZXQgc2l6ZSgpIHsKICAgICAgcmV0dXJuIHRoaXMuZW5kLnN1Yih0aGlzLmJlZ2luKS50b0ludDMyKCkgLyB0aGlzLl9lbGVtZW50U2l6ZTsKICAgIH0KICB9OwogIHZhciBIYW5kbGVWZWN0b3IgPSBjbGFzcyBleHRlbmRzIFN0ZFZlY3RvciB7CiAgICBzdGF0aWMgJG5ldygpIHsKICAgICAgY29uc3QgdmVjdG9yID0gbmV3IEhhbmRsZVZlY3RvcihnZXRBcGkoKS4kbmV3KFNURF9WRUNUT1JfU0laRSkpOwogICAgICB2ZWN0b3IuaW5pdCgpOwogICAgICByZXR1cm4gdmVjdG9yOwogICAgfQogICAgY29uc3RydWN0b3Ioc3RvcmFnZSkgewogICAgICBzdXBlcihzdG9yYWdlLCBwb2ludGVyU2l6ZTUpOwogICAgfQogICAgZ2V0IGhhbmRsZXMoKSB7CiAgICAgIGNvbnN0IHJlc3VsdCA9IFtdOwogICAgICBsZXQgY3VyID0gdGhpcy5iZWdpbjsKICAgICAgY29uc3QgZW5kID0gdGhpcy5lbmQ7CiAgICAgIHdoaWxlICghY3VyLmVxdWFscyhlbmQpKSB7CiAgICAgICAgcmVzdWx0LnB1c2goY3VyLnJlYWRQb2ludGVyKCkpOwogICAgICAgIGN1ciA9IGN1ci5hZGQocG9pbnRlclNpemU1KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIH07CiAgdmFyIEJIU19PRkZTRVRfTElOSyA9IDA7CiAgdmFyIEJIU19PRkZTRVRfTlVNX1JFRlMgPSBwb2ludGVyU2l6ZTU7CiAgdmFyIEJIU19TSVpFID0gQkhTX09GRlNFVF9OVU1fUkVGUyArIDQ7CiAgdmFyIGtOdW1SZWZlcmVuY2VzVmFyaWFibGVTaXplZCA9IC0xOwogIHZhciBCYXNlSGFuZGxlU2NvcGUgPSBjbGFzcyB7CiAgICAkZGVsZXRlKCkgewogICAgICB0aGlzLmRpc3Bvc2UoKTsKICAgICAgZ2V0QXBpKCkuJGRlbGV0ZSh0aGlzKTsKICAgIH0KICAgIGNvbnN0cnVjdG9yKHN0b3JhZ2UpIHsKICAgICAgdGhpcy5oYW5kbGUgPSBzdG9yYWdlOwogICAgICB0aGlzLl9saW5rID0gc3RvcmFnZS5hZGQoQkhTX09GRlNFVF9MSU5LKTsKICAgICAgdGhpcy5fbnVtYmVyT2ZSZWZlcmVuY2VzID0gc3RvcmFnZS5hZGQoQkhTX09GRlNFVF9OVU1fUkVGUyk7CiAgICB9CiAgICBpbml0KGxpbmssIG51bWJlck9mUmVmZXJlbmNlcykgewogICAgICB0aGlzLmxpbmsgPSBsaW5rOwogICAgICB0aGlzLm51bWJlck9mUmVmZXJlbmNlcyA9IG51bWJlck9mUmVmZXJlbmNlczsKICAgIH0KICAgIGRpc3Bvc2UoKSB7CiAgICB9CiAgICBnZXQgbGluaygpIHsKICAgICAgcmV0dXJuIG5ldyBCYXNlSGFuZGxlU2NvcGUodGhpcy5fbGluay5yZWFkUG9pbnRlcigpKTsKICAgIH0KICAgIHNldCBsaW5rKHZhbHVlKSB7CiAgICAgIHRoaXMuX2xpbmsud3JpdGVQb2ludGVyKHZhbHVlKTsKICAgIH0KICAgIGdldCBudW1iZXJPZlJlZmVyZW5jZXMoKSB7CiAgICAgIHJldHVybiB0aGlzLl9udW1iZXJPZlJlZmVyZW5jZXMucmVhZFMzMigpOwogICAgfQogICAgc2V0IG51bWJlck9mUmVmZXJlbmNlcyh2YWx1ZSkgewogICAgICB0aGlzLl9udW1iZXJPZlJlZmVyZW5jZXMud3JpdGVTMzIodmFsdWUpOwogICAgfQogIH07CiAgdmFyIFZTSFNfT0ZGU0VUX1NFTEYgPSBhbGlnblBvaW50ZXJPZmZzZXQoQkhTX1NJWkUpOwogIHZhciBWU0hTX09GRlNFVF9DVVJSRU5UX1NDT1BFID0gVlNIU19PRkZTRVRfU0VMRiArIHBvaW50ZXJTaXplNTsKICB2YXIgVlNIU19TSVpFID0gVlNIU19PRkZTRVRfQ1VSUkVOVF9TQ09QRSArIHBvaW50ZXJTaXplNTsKICB2YXIgVmFyaWFibGVTaXplZEhhbmRsZVNjb3BlID0gY2xhc3MgZXh0ZW5kcyBCYXNlSGFuZGxlU2NvcGUgewogICAgc3RhdGljICRuZXcodGhyZWFkLCB2bTMpIHsKICAgICAgY29uc3Qgc2NvcGUgPSBuZXcgVmFyaWFibGVTaXplZEhhbmRsZVNjb3BlKGdldEFwaSgpLiRuZXcoVlNIU19TSVpFKSk7CiAgICAgIHNjb3BlLmluaXQodGhyZWFkLCB2bTMpOwogICAgICByZXR1cm4gc2NvcGU7CiAgICB9CiAgICBjb25zdHJ1Y3RvcihzdG9yYWdlKSB7CiAgICAgIHN1cGVyKHN0b3JhZ2UpOwogICAgICB0aGlzLl9zZWxmID0gc3RvcmFnZS5hZGQoVlNIU19PRkZTRVRfU0VMRik7CiAgICAgIHRoaXMuX2N1cnJlbnRTY29wZSA9IHN0b3JhZ2UuYWRkKFZTSFNfT0ZGU0VUX0NVUlJFTlRfU0NPUEUpOwogICAgICBjb25zdCBrTG9jYWxTY29wZVNpemUgPSA2NDsKICAgICAgY29uc3Qga1NpemVPZlJlZmVyZW5jZXNQZXJTY29wZSA9IGtMb2NhbFNjb3BlU2l6ZSAtIHBvaW50ZXJTaXplNSAtIDQgLSA0OwogICAgICBjb25zdCBrTnVtUmVmZXJlbmNlc1BlclNjb3BlID0ga1NpemVPZlJlZmVyZW5jZXNQZXJTY29wZSAvIDQ7CiAgICAgIHRoaXMuX3Njb3BlTGF5b3V0ID0gRml4ZWRTaXplSGFuZGxlU2NvcGUubGF5b3V0Rm9yQ2FwYWNpdHkoa051bVJlZmVyZW5jZXNQZXJTY29wZSk7CiAgICAgIHRoaXMuX3RvcEhhbmRsZVNjb3BlUHRyID0gbnVsbDsKICAgIH0KICAgIGluaXQodGhyZWFkLCB2bTMpIHsKICAgICAgY29uc3QgdG9wSGFuZGxlU2NvcGVQdHIgPSB0aHJlYWQuYWRkKGdldEFydFRocmVhZFNwZWModm0zKS5vZmZzZXQudG9wSGFuZGxlU2NvcGUpOwogICAgICB0aGlzLl90b3BIYW5kbGVTY29wZVB0ciA9IHRvcEhhbmRsZVNjb3BlUHRyOwogICAgICBzdXBlci5pbml0KHRvcEhhbmRsZVNjb3BlUHRyLnJlYWRQb2ludGVyKCksIGtOdW1SZWZlcmVuY2VzVmFyaWFibGVTaXplZCk7CiAgICAgIHRoaXMuc2VsZiA9IHRocmVhZDsKICAgICAgdGhpcy5jdXJyZW50U2NvcGUgPSBGaXhlZFNpemVIYW5kbGVTY29wZS4kbmV3KHRoaXMuX3Njb3BlTGF5b3V0KTsKICAgICAgdG9wSGFuZGxlU2NvcGVQdHIud3JpdGVQb2ludGVyKHRoaXMpOwogICAgfQogICAgZGlzcG9zZSgpIHsKICAgICAgdGhpcy5fdG9wSGFuZGxlU2NvcGVQdHIud3JpdGVQb2ludGVyKHRoaXMubGluayk7CiAgICAgIGxldCBzY29wZTsKICAgICAgd2hpbGUgKChzY29wZSA9IHRoaXMuY3VycmVudFNjb3BlKSAhPT0gbnVsbCkgewogICAgICAgIGNvbnN0IG5leHQgPSBzY29wZS5saW5rOwogICAgICAgIHNjb3BlLiRkZWxldGUoKTsKICAgICAgICB0aGlzLmN1cnJlbnRTY29wZSA9IG5leHQ7CiAgICAgIH0KICAgIH0KICAgIGdldCBzZWxmKCkgewogICAgICByZXR1cm4gdGhpcy5fc2VsZi5yZWFkUG9pbnRlcigpOwogICAgfQogICAgc2V0IHNlbGYodmFsdWUpIHsKICAgICAgdGhpcy5fc2VsZi53cml0ZVBvaW50ZXIodmFsdWUpOwogICAgfQogICAgZ2V0IGN1cnJlbnRTY29wZSgpIHsKICAgICAgY29uc3Qgc3RvcmFnZSA9IHRoaXMuX2N1cnJlbnRTY29wZS5yZWFkUG9pbnRlcigpOwogICAgICBpZiAoc3RvcmFnZS5pc051bGwoKSkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIHJldHVybiBuZXcgRml4ZWRTaXplSGFuZGxlU2NvcGUoc3RvcmFnZSwgdGhpcy5fc2NvcGVMYXlvdXQpOwogICAgfQogICAgc2V0IGN1cnJlbnRTY29wZSh2YWx1ZSkgewogICAgICB0aGlzLl9jdXJyZW50U2NvcGUud3JpdGVQb2ludGVyKHZhbHVlKTsKICAgIH0KICAgIG5ld0hhbmRsZShvYmplY3QpIHsKICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFNjb3BlLm5ld0hhbmRsZShvYmplY3QpOwogICAgfQogIH07CiAgdmFyIEZpeGVkU2l6ZUhhbmRsZVNjb3BlID0gY2xhc3MgZXh0ZW5kcyBCYXNlSGFuZGxlU2NvcGUgewogICAgc3RhdGljICRuZXcobGF5b3V0KSB7CiAgICAgIGNvbnN0IHNjb3BlID0gbmV3IEZpeGVkU2l6ZUhhbmRsZVNjb3BlKGdldEFwaSgpLiRuZXcobGF5b3V0LnNpemUpLCBsYXlvdXQpOwogICAgICBzY29wZS5pbml0KCk7CiAgICAgIHJldHVybiBzY29wZTsKICAgIH0KICAgIGNvbnN0cnVjdG9yKHN0b3JhZ2UsIGxheW91dCkgewogICAgICBzdXBlcihzdG9yYWdlKTsKICAgICAgY29uc3QgeyBvZmZzZXQgfSA9IGxheW91dDsKICAgICAgdGhpcy5fcmVmc1N0b3JhZ2UgPSBzdG9yYWdlLmFkZChvZmZzZXQucmVmc1N0b3JhZ2UpOwogICAgICB0aGlzLl9wb3MgPSBzdG9yYWdlLmFkZChvZmZzZXQucG9zKTsKICAgICAgdGhpcy5fbGF5b3V0ID0gbGF5b3V0OwogICAgfQogICAgaW5pdCgpIHsKICAgICAgc3VwZXIuaW5pdChOVUxMLCB0aGlzLl9sYXlvdXQubnVtYmVyT2ZSZWZlcmVuY2VzKTsKICAgICAgdGhpcy5wb3MgPSAwOwogICAgfQogICAgZ2V0IHBvcygpIHsKICAgICAgcmV0dXJuIHRoaXMuX3Bvcy5yZWFkVTMyKCk7CiAgICB9CiAgICBzZXQgcG9zKHZhbHVlKSB7CiAgICAgIHRoaXMuX3Bvcy53cml0ZVUzMih2YWx1ZSk7CiAgICB9CiAgICBuZXdIYW5kbGUob2JqZWN0KSB7CiAgICAgIGNvbnN0IHBvcyA9IHRoaXMucG9zOwogICAgICBjb25zdCBoYW5kbGUgPSB0aGlzLl9yZWZzU3RvcmFnZS5hZGQocG9zICogNCk7CiAgICAgIGhhbmRsZS53cml0ZVMzMihvYmplY3QudG9JbnQzMigpKTsKICAgICAgdGhpcy5wb3MgPSBwb3MgKyAxOwogICAgICByZXR1cm4gaGFuZGxlOwogICAgfQogICAgc3RhdGljIGxheW91dEZvckNhcGFjaXR5KG51bVJlZnMpIHsKICAgICAgY29uc3QgcmVmc1N0b3JhZ2UgPSBCSFNfU0laRTsKICAgICAgY29uc3QgcG9zID0gcmVmc1N0b3JhZ2UgKyBudW1SZWZzICogNDsKICAgICAgcmV0dXJuIHsKICAgICAgICBzaXplOiBwb3MgKyA0LAogICAgICAgIG51bWJlck9mUmVmZXJlbmNlczogbnVtUmVmcywKICAgICAgICBvZmZzZXQ6IHsKICAgICAgICAgIHJlZnNTdG9yYWdlLAogICAgICAgICAgcG9zCiAgICAgICAgfQogICAgICB9OwogICAgfQogIH07CiAgdmFyIG9iamVjdFZpc2l0b3JQcmVkaWNhdGVGYWN0b3JpZXMgPSB7CiAgICBhcm06IGZ1bmN0aW9uKG5lZWRsZSwgb25NYXRjaCkgewogICAgICBjb25zdCBzaXplID0gUHJvY2Vzcy5wYWdlU2l6ZTsKICAgICAgY29uc3QgcHJlZGljYXRlID0gTWVtb3J5LmFsbG9jKHNpemUpOwogICAgICBNZW1vcnkucHJvdGVjdChwcmVkaWNhdGUsIHNpemUsICJyd3giKTsKICAgICAgY29uc3Qgb25NYXRjaENhbGxiYWNrID0gbmV3IE5hdGl2ZUNhbGxiYWNrKG9uTWF0Y2gsICJ2b2lkIiwgWyJwb2ludGVyIl0pOwogICAgICBwcmVkaWNhdGUuX29uTWF0Y2hDYWxsYmFjayA9IG9uTWF0Y2hDYWxsYmFjazsKICAgICAgY29uc3QgaW5zdHJ1Y3Rpb25zID0gWwogICAgICAgIDI2NjI1LAogICAgICAgIC8vIGxkciByMSwgW3IwXQogICAgICAgIDE4OTQ3LAogICAgICAgIC8vIGxkciByMiwgPW5lZWRsZQogICAgICAgIDE3MDQxLAogICAgICAgIC8vIGNtcCByMSwgcjIKICAgICAgICA1MzUwNSwKICAgICAgICAvLyBibmUgbWlzbWF0Y2gKICAgICAgICAxOTIwMiwKICAgICAgICAvLyBsZHIgcjMsID1vbk1hdGNoCiAgICAgICAgMTgyMDAsCiAgICAgICAgLy8gYnggcjMKICAgICAgICAxODI4OCwKICAgICAgICAvLyBieCBscgogICAgICAgIDQ4ODk2CiAgICAgICAgLy8gbm9wCiAgICAgIF07CiAgICAgIGNvbnN0IG5lZWRsZU9mZnNldCA9IGluc3RydWN0aW9ucy5sZW5ndGggKiAyOwogICAgICBjb25zdCBvbk1hdGNoT2Zmc2V0ID0gbmVlZGxlT2Zmc2V0ICsgNDsKICAgICAgY29uc3QgY29kZVNpemUgPSBvbk1hdGNoT2Zmc2V0ICsgNDsKICAgICAgTWVtb3J5LnBhdGNoQ29kZShwcmVkaWNhdGUsIGNvZGVTaXplLCBmdW5jdGlvbihhZGRyZXNzKSB7CiAgICAgICAgaW5zdHJ1Y3Rpb25zLmZvckVhY2goKGluc3RydWN0aW9uLCBpbmRleCkgPT4gewogICAgICAgICAgYWRkcmVzcy5hZGQoaW5kZXggKiAyKS53cml0ZVUxNihpbnN0cnVjdGlvbik7CiAgICAgICAgfSk7CiAgICAgICAgYWRkcmVzcy5hZGQobmVlZGxlT2Zmc2V0KS53cml0ZVMzMihuZWVkbGUpOwogICAgICAgIGFkZHJlc3MuYWRkKG9uTWF0Y2hPZmZzZXQpLndyaXRlUG9pbnRlcihvbk1hdGNoQ2FsbGJhY2spOwogICAgICB9KTsKICAgICAgcmV0dXJuIHByZWRpY2F0ZS5vcigxKTsKICAgIH0sCiAgICBhcm02NDogZnVuY3Rpb24obmVlZGxlLCBvbk1hdGNoKSB7CiAgICAgIGNvbnN0IHNpemUgPSBQcm9jZXNzLnBhZ2VTaXplOwogICAgICBjb25zdCBwcmVkaWNhdGUgPSBNZW1vcnkuYWxsb2Moc2l6ZSk7CiAgICAgIE1lbW9yeS5wcm90ZWN0KHByZWRpY2F0ZSwgc2l6ZSwgInJ3eCIpOwogICAgICBjb25zdCBvbk1hdGNoQ2FsbGJhY2sgPSBuZXcgTmF0aXZlQ2FsbGJhY2sob25NYXRjaCwgInZvaWQiLCBbInBvaW50ZXIiXSk7CiAgICAgIHByZWRpY2F0ZS5fb25NYXRjaENhbGxiYWNrID0gb25NYXRjaENhbGxiYWNrOwogICAgICBjb25zdCBpbnN0cnVjdGlvbnMgPSBbCiAgICAgICAgMzEwNzk3OTI2NSwKICAgICAgICAvLyBsZHIgdzEsIFt4MF0KICAgICAgICA0MDI2NTMzNzgsCiAgICAgICAgLy8gbGRyIHcyLCA9bmVlZGxlCiAgICAgICAgMTc5NTI5MzI0NywKICAgICAgICAvLyBjbXAgdzEsIHcyCiAgICAgICAgMTQwOTI4NjI0MSwKICAgICAgICAvLyBiLm5lIG1pc21hdGNoCiAgICAgICAgMTQ3NjM5NTEzOSwKICAgICAgICAvLyBsZHIgeDMsID1vbk1hdGNoCiAgICAgICAgMzU5MjM1NTkzNiwKICAgICAgICAvLyBiciB4MwogICAgICAgIDM1OTY1NTExMDQKICAgICAgICAvLyByZXQKICAgICAgXTsKICAgICAgY29uc3QgbmVlZGxlT2Zmc2V0ID0gaW5zdHJ1Y3Rpb25zLmxlbmd0aCAqIDQ7CiAgICAgIGNvbnN0IG9uTWF0Y2hPZmZzZXQgPSBuZWVkbGVPZmZzZXQgKyA0OwogICAgICBjb25zdCBjb2RlU2l6ZSA9IG9uTWF0Y2hPZmZzZXQgKyA4OwogICAgICBNZW1vcnkucGF0Y2hDb2RlKHByZWRpY2F0ZSwgY29kZVNpemUsIGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICBpbnN0cnVjdGlvbnMuZm9yRWFjaCgoaW5zdHJ1Y3Rpb24sIGluZGV4KSA9PiB7CiAgICAgICAgICBhZGRyZXNzLmFkZChpbmRleCAqIDQpLndyaXRlVTMyKGluc3RydWN0aW9uKTsKICAgICAgICB9KTsKICAgICAgICBhZGRyZXNzLmFkZChuZWVkbGVPZmZzZXQpLndyaXRlUzMyKG5lZWRsZSk7CiAgICAgICAgYWRkcmVzcy5hZGQob25NYXRjaE9mZnNldCkud3JpdGVQb2ludGVyKG9uTWF0Y2hDYWxsYmFjayk7CiAgICAgIH0pOwogICAgICByZXR1cm4gcHJlZGljYXRlOwogICAgfQogIH07CiAgZnVuY3Rpb24gbWFrZU9iamVjdFZpc2l0b3JQcmVkaWNhdGUobmVlZGxlLCBvbk1hdGNoKSB7CiAgICBjb25zdCBmYWN0b3J5ID0gb2JqZWN0VmlzaXRvclByZWRpY2F0ZUZhY3Rvcmllc1tQcm9jZXNzLmFyY2hdIHx8IG1ha2VHZW5lcmljT2JqZWN0VmlzaXRvclByZWRpY2F0ZTsKICAgIHJldHVybiBmYWN0b3J5KG5lZWRsZSwgb25NYXRjaCk7CiAgfQogIGZ1bmN0aW9uIG1ha2VHZW5lcmljT2JqZWN0VmlzaXRvclByZWRpY2F0ZShuZWVkbGUsIG9uTWF0Y2gpIHsKICAgIHJldHVybiBuZXcgTmF0aXZlQ2FsbGJhY2soKG9iamVjdCkgPT4gewogICAgICBjb25zdCBrbGFzcyA9IG9iamVjdC5yZWFkUzMyKCk7CiAgICAgIGlmIChrbGFzcyA9PT0gbmVlZGxlKSB7CiAgICAgICAgb25NYXRjaChvYmplY3QpOwogICAgICB9CiAgICB9LCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIl0pOwogIH0KICBmdW5jdGlvbiBhbGlnblBvaW50ZXJPZmZzZXQob2Zmc2V0KSB7CiAgICBjb25zdCByZW1haW5kZXIgPSBvZmZzZXQgJSBwb2ludGVyU2l6ZTU7CiAgICBpZiAocmVtYWluZGVyICE9PSAwKSB7CiAgICAgIHJldHVybiBvZmZzZXQgKyBwb2ludGVyU2l6ZTUgLSByZW1haW5kZXI7CiAgICB9CiAgICByZXR1cm4gb2Zmc2V0OwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2ZyaWRhLWphdmEtYnJpZGdlL2xpYi9qdm0uanMKICB2YXIganNpemVTaXplMiA9IDQ7CiAgdmFyIHsgcG9pbnRlclNpemU6IHBvaW50ZXJTaXplNiB9ID0gUHJvY2VzczsKICB2YXIgSlZNX0FDQ19OQVRJVkUgPSAyNTY7CiAgdmFyIEpWTV9BQ0NfSVNfT0xEID0gNjU1MzY7CiAgdmFyIEpWTV9BQ0NfSVNfT0JTT0xFVEUgPSAxMzEwNzI7CiAgdmFyIEpWTV9BQ0NfTk9UX0MyX0NPTVBJTEFCTEUgPSAzMzU1NDQzMjsKICB2YXIgSlZNX0FDQ19OT1RfQzFfQ09NUElMQUJMRSA9IDY3MTA4ODY0OwogIHZhciBKVk1fQUNDX05PVF9DMl9PU1JfQ09NUElMQUJMRSA9IDEzNDIxNzcyODsKICB2YXIgbmF0aXZlRnVuY3Rpb25PcHRpb25zNCA9IHsKICAgIGV4Y2VwdGlvbnM6ICJwcm9wYWdhdGUiCiAgfTsKICB2YXIgZ2V0SnZtTWV0aG9kU3BlYyA9IG1lbW9pemUoX2dldEp2bU1ldGhvZFNwZWMpOwogIHZhciBnZXRKdm1JbnN0YW5jZUtsYXNzU3BlYyA9IG1lbW9pemUoX2dldEp2bUluc3RhbmNlS2xhc3NTcGVjKTsKICB2YXIgZ2V0SnZtVGhyZWFkU3BlYyA9IG1lbW9pemUoX2dldEp2bVRocmVhZFNwZWMpOwogIHZhciBjYWNoZWRBcGkyID0gbnVsbDsKICB2YXIgbWFuZ2xlcnNTY2hlZHVsZWQgPSBmYWxzZTsKICB2YXIgcmVwbGFjZU1hbmdsZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICB2YXIgcmV2ZXJ0TWFuZ2xlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGZ1bmN0aW9uIGdldEFwaTIoKSB7CiAgICBpZiAoY2FjaGVkQXBpMiA9PT0gbnVsbCkgewogICAgICBjYWNoZWRBcGkyID0gX2dldEFwaTIoKTsKICAgIH0KICAgIHJldHVybiBjYWNoZWRBcGkyOwogIH0KICBmdW5jdGlvbiBfZ2V0QXBpMigpIHsKICAgIGNvbnN0IHZtTW9kdWxlcyA9IFByb2Nlc3MuZW51bWVyYXRlTW9kdWxlcygpLmZpbHRlcigobSkgPT4gL2p2bS4oZGxsfGR5bGlifHNvKSQvLnRlc3QobS5uYW1lKSk7CiAgICBpZiAodm1Nb2R1bGVzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IHZtTW9kdWxlID0gdm1Nb2R1bGVzWzBdOwogICAgY29uc3QgdGVtcG9yYXJ5QXBpID0gewogICAgICBmbGF2b3I6ICJqdm0iCiAgICB9OwogICAgY29uc3QgcGVuZGluZyA9IFByb2Nlc3MucGxhdGZvcm0gPT09ICJ3aW5kb3dzIiA/IFt7CiAgICAgIG1vZHVsZTogdm1Nb2R1bGUsCiAgICAgIGZ1bmN0aW9uczogewogICAgICAgIEpOSV9HZXRDcmVhdGVkSmF2YVZNczogWyJKTklfR2V0Q3JlYXRlZEphdmFWTXMiLCAiaW50IiwgWyJwb2ludGVyIiwgImludCIsICJwb2ludGVyIl1dLAogICAgICAgIEpWTV9TbGVlcDogWyJKVk1fU2xlZXAiLCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgImxvbmciXV0sCiAgICAgICAgIlZNVGhyZWFkOjpleGVjdXRlIjogWyJWTVRocmVhZDo6ZXhlY3V0ZSIsICJ2b2lkIiwgWyJwb2ludGVyIl1dLAogICAgICAgICJNZXRob2Q6OnNpemUiOiBbIk1ldGhvZDo6c2l6ZSIsICJpbnQiLCBbImludCJdXSwKICAgICAgICAiTWV0aG9kOjpzZXRfbmF0aXZlX2Z1bmN0aW9uIjogWyJNZXRob2Q6OnNldF9uYXRpdmVfZnVuY3Rpb24iLCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgImludCJdXSwKICAgICAgICAiTWV0aG9kOjpjbGVhcl9uYXRpdmVfZnVuY3Rpb24iOiBbIk1ldGhvZDo6Y2xlYXJfbmF0aXZlX2Z1bmN0aW9uIiwgInZvaWQiLCBbInBvaW50ZXIiXV0sCiAgICAgICAgIk1ldGhvZDo6am1ldGhvZF9pZCI6IFsiTWV0aG9kOjpqbWV0aG9kX2lkIiwgInBvaW50ZXIiLCBbInBvaW50ZXIiXV0sCiAgICAgICAgIkNsYXNzTG9hZGVyRGF0YUdyYXBoOjpjbGFzc2VzX2RvIjogWyJDbGFzc0xvYWRlckRhdGFHcmFwaDo6Y2xhc3Nlc19kbyIsICJ2b2lkIiwgWyJwb2ludGVyIl1dLAogICAgICAgICJOTWV0aG9kU3dlZXBlcjo6c3dlZXBfY29kZV9jYWNoZSI6IFsiTk1ldGhvZFN3ZWVwZXI6OnN3ZWVwX2NvZGVfY2FjaGUiLCAidm9pZCIsIFtdXSwKICAgICAgICAiT29wTWFwQ2FjaGU6OmZsdXNoX29ic29sZXRlX2VudHJpZXMiOiBbIk9vcE1hcENhY2hlOjpmbHVzaF9vYnNvbGV0ZV9lbnRyaWVzIiwgInZvaWQiLCBbInBvaW50ZXIiXV0KICAgICAgfSwKICAgICAgdmFyaWFibGVzOiB7CiAgICAgICAgIlZNX1JlZGVmaW5lQ2xhc3Nlczo6YHZmdGFibGUnIjogZnVuY3Rpb24oYWRkcmVzcykgewogICAgICAgICAgdGhpcy52dGFibGVSZWRlZmluZUNsYXNzZXMgPSBhZGRyZXNzOwogICAgICAgIH0sCiAgICAgICAgIlZNX1JlZGVmaW5lQ2xhc3Nlczo6ZG9pdCI6IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIHRoaXMucmVkZWZpbmVDbGFzc2VzRG9JdCA9IGFkZHJlc3M7CiAgICAgICAgfSwKICAgICAgICAiVk1fUmVkZWZpbmVDbGFzc2VzOjpkb2l0X3Byb2xvZ3VlIjogZnVuY3Rpb24oYWRkcmVzcykgewogICAgICAgICAgdGhpcy5yZWRlZmluZUNsYXNzZXNEb0l0UHJvbG9ndWUgPSBhZGRyZXNzOwogICAgICAgIH0sCiAgICAgICAgIlZNX1JlZGVmaW5lQ2xhc3Nlczo6ZG9pdF9lcGlsb2d1ZSI6IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIHRoaXMucmVkZWZpbmVDbGFzc2VzRG9JdEVwaWxvZ3VlID0gYWRkcmVzczsKICAgICAgICB9LAogICAgICAgICJWTV9SZWRlZmluZUNsYXNzZXM6OmFsbG93X25lc3RlZF92bV9vcGVyYXRpb25zIjogZnVuY3Rpb24oYWRkcmVzcykgewogICAgICAgICAgdGhpcy5yZWRlZmluZUNsYXNzZXNBbGxvdyA9IGFkZHJlc3M7CiAgICAgICAgfSwKICAgICAgICAiTk1ldGhvZFN3ZWVwZXI6Ol90cmF2ZXJzYWxzIjogZnVuY3Rpb24oYWRkcmVzcykgewogICAgICAgICAgdGhpcy50cmF2ZXJzYWxzID0gYWRkcmVzczsKICAgICAgICB9LAogICAgICAgICJOTWV0aG9kU3dlZXBlcjo6X3Nob3VsZF9zd2VlcCI6IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIHRoaXMuc2hvdWxkU3dlZXAgPSBhZGRyZXNzOwogICAgICAgIH0KICAgICAgfSwKICAgICAgb3B0aW9uYWxzOiBbXQogICAgfV0gOiBbewogICAgICBtb2R1bGU6IHZtTW9kdWxlLAogICAgICBmdW5jdGlvbnM6IHsKICAgICAgICBKTklfR2V0Q3JlYXRlZEphdmFWTXM6IFsiSk5JX0dldENyZWF0ZWRKYXZhVk1zIiwgImludCIsIFsicG9pbnRlciIsICJpbnQiLCAicG9pbnRlciJdXSwKICAgICAgICBfWk42TWV0aG9kNHNpemVFYjogWyJNZXRob2Q6OnNpemUiLCAiaW50IiwgWyJpbnQiXV0sCiAgICAgICAgX1pONk1ldGhvZDE5c2V0X25hdGl2ZV9mdW5jdGlvbkVQaGI6IFsiTWV0aG9kOjpzZXRfbmF0aXZlX2Z1bmN0aW9uIiwgInZvaWQiLCBbInBvaW50ZXIiLCAicG9pbnRlciIsICJpbnQiXV0sCiAgICAgICAgX1pONk1ldGhvZDIxY2xlYXJfbmF0aXZlX2Z1bmN0aW9uRXY6IFsiTWV0aG9kOjpjbGVhcl9uYXRpdmVfZnVuY3Rpb24iLCAidm9pZCIsIFsicG9pbnRlciJdXSwKICAgICAgICAvLyBKREsgPj0gMTcKICAgICAgICBfWk42TWV0aG9kMjRyZXN0b3JlX3Vuc2hhcmVhYmxlX2luZm9FUDEwSmF2YVRocmVhZDogWyJNZXRob2Q6OnJlc3RvcmVfdW5zaGFyZWFibGVfaW5mbyIsICJ2b2lkIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiXV0sCiAgICAgICAgLy8gSkRLIDwgMTcKICAgICAgICBfWk42TWV0aG9kMjRyZXN0b3JlX3Vuc2hhcmVhYmxlX2luZm9FUDZUaHJlYWQ6IFsiTWV0aG9kOjpyZXN0b3JlX3Vuc2hhcmVhYmxlX2luZm8iLCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIl1dLAogICAgICAgIF9aTjZNZXRob2QxMWxpbmtfbWV0aG9kRVJLMTJtZXRob2RIYW5kbGVQMTBKYXZhVGhyZWFkOiBbIk1ldGhvZDo6bGlua19tZXRob2QiLCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgInBvaW50ZXIiXV0sCiAgICAgICAgX1pONk1ldGhvZDEwam1ldGhvZF9pZEV2OiBbIk1ldGhvZDo6am1ldGhvZF9pZCIsICJwb2ludGVyIiwgWyJwb2ludGVyIl1dLAogICAgICAgIF9aTjZNZXRob2QxMGNsZWFyX2NvZGVFdjogZnVuY3Rpb24oYWRkcmVzcykgewogICAgICAgICAgY29uc3QgY2xlYXJDb2RlID0gbmV3IE5hdGl2ZUZ1bmN0aW9uKGFkZHJlc3MsICJ2b2lkIiwgWyJwb2ludGVyIl0sIG5hdGl2ZUZ1bmN0aW9uT3B0aW9uczQpOwogICAgICAgICAgdGhpc1siTWV0aG9kOjpjbGVhcl9jb2RlIl0gPSBmdW5jdGlvbih0aGlzUHRyKSB7CiAgICAgICAgICAgIGNsZWFyQ29kZSh0aGlzUHRyKTsKICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICBfWk42TWV0aG9kMTBjbGVhcl9jb2RlRWI6IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIGNvbnN0IGNsZWFyQ29kZSA9IG5ldyBOYXRpdmVGdW5jdGlvbihhZGRyZXNzLCAidm9pZCIsIFsicG9pbnRlciIsICJpbnQiXSwgbmF0aXZlRnVuY3Rpb25PcHRpb25zNCk7CiAgICAgICAgICBjb25zdCBsb2NrID0gMDsKICAgICAgICAgIHRoaXNbIk1ldGhvZDo6Y2xlYXJfY29kZSJdID0gZnVuY3Rpb24odGhpc1B0cikgewogICAgICAgICAgICBjbGVhckNvZGUodGhpc1B0ciwgbG9jayk7CiAgICAgICAgICB9OwogICAgICAgIH0sCiAgICAgICAgLy8gSkRLID49IDEzCiAgICAgICAgX1pOMThWTV9SZWRlZmluZUNsYXNzZXMxOW1hcmtfZGVwZW5kZW50X2NvZGVFUDEzSW5zdGFuY2VLbGFzczogWyJWTV9SZWRlZmluZUNsYXNzZXM6Om1hcmtfZGVwZW5kZW50X2NvZGUiLCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIl1dLAogICAgICAgIF9aTjE4Vk1fUmVkZWZpbmVDbGFzc2VzMjBmbHVzaF9kZXBlbmRlbnRfY29kZUV2OiBbIlZNX1JlZGVmaW5lQ2xhc3Nlczo6Zmx1c2hfZGVwZW5kZW50X2NvZGUiLCAidm9pZCIsIFtdXSwKICAgICAgICAvLyBKREsgPCAxMwogICAgICAgIF9aTjE4Vk1fUmVkZWZpbmVDbGFzc2VzMjBmbHVzaF9kZXBlbmRlbnRfY29kZUVQMTNJbnN0YW5jZUtsYXNzUDZUaHJlYWQ6IFsiVk1fUmVkZWZpbmVDbGFzc2VzOjpmbHVzaF9kZXBlbmRlbnRfY29kZSIsICJ2b2lkIiwgWyJwb2ludGVyIiwgInBvaW50ZXIiLCAicG9pbnRlciJdXSwKICAgICAgICAvLyBKREsgPCAxMAogICAgICAgIF9aTjE4Vk1fUmVkZWZpbmVDbGFzc2VzMjBmbHVzaF9kZXBlbmRlbnRfY29kZUUxOWluc3RhbmNlS2xhc3NIYW5kbGVQNlRocmVhZDogWyJWTV9SZWRlZmluZUNsYXNzZXM6OmZsdXNoX2RlcGVuZGVudF9jb2RlIiwgInZvaWQiLCBbInBvaW50ZXIiLCAicG9pbnRlciIsICJwb2ludGVyIl1dLAogICAgICAgIF9aTjE5UmVzb2x2ZWRNZXRob2RUYWJsZTIxYWRqdXN0X21ldGhvZF9lbnRyaWVzRVBiOiBbIlJlc29sdmVkTWV0aG9kVGFibGU6OmFkanVzdF9tZXRob2RfZW50cmllcyIsICJ2b2lkIiwgWyJwb2ludGVyIl1dLAogICAgICAgIC8vIEpESyA8IDEwCiAgICAgICAgX1pOMTVNZW1iZXJOYW1lVGFibGUyMWFkanVzdF9tZXRob2RfZW50cmllc0VQMTNJbnN0YW5jZUtsYXNzUGI6IFsiTWVtYmVyTmFtZVRhYmxlOjphZGp1c3RfbWV0aG9kX2VudHJpZXMiLCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgInBvaW50ZXIiXV0sCiAgICAgICAgX1pOMTdDb25zdGFudFBvb2xDYWNoZTIxYWRqdXN0X21ldGhvZF9lbnRyaWVzRVBiOiBmdW5jdGlvbihhZGRyZXNzKSB7CiAgICAgICAgICBjb25zdCBhZGp1c3RNZXRob2QgPSBuZXcgTmF0aXZlRnVuY3Rpb24oYWRkcmVzcywgInZvaWQiLCBbInBvaW50ZXIiLCAicG9pbnRlciJdLCBuYXRpdmVGdW5jdGlvbk9wdGlvbnM0KTsKICAgICAgICAgIHRoaXNbIkNvbnN0YW50UG9vbENhY2hlOjphZGp1c3RfbWV0aG9kX2VudHJpZXMiXSA9IGZ1bmN0aW9uKHRoaXNQdHIsIGhvbGRlclB0ciwgdHJhY2VQdHIpIHsKICAgICAgICAgICAgYWRqdXN0TWV0aG9kKHRoaXNQdHIsIHRyYWNlUHRyKTsKICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICAvLyBKREsgPCAxMwogICAgICAgIF9aTjE3Q29uc3RhbnRQb29sQ2FjaGUyMWFkanVzdF9tZXRob2RfZW50cmllc0VQMTNJbnN0YW5jZUtsYXNzUGI6IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIGNvbnN0IGFkanVzdE1ldGhvZCA9IG5ldyBOYXRpdmVGdW5jdGlvbihhZGRyZXNzLCAidm9pZCIsIFsicG9pbnRlciIsICJwb2ludGVyIiwgInBvaW50ZXIiXSwgbmF0aXZlRnVuY3Rpb25PcHRpb25zNCk7CiAgICAgICAgICB0aGlzWyJDb25zdGFudFBvb2xDYWNoZTo6YWRqdXN0X21ldGhvZF9lbnRyaWVzIl0gPSBmdW5jdGlvbih0aGlzUHRyLCBob2xkZXJQdHIsIHRyYWNlUHRyKSB7CiAgICAgICAgICAgIGFkanVzdE1ldGhvZCh0aGlzUHRyLCBob2xkZXJQdHIsIHRyYWNlUHRyKTsKICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICBfWk4yMENsYXNzTG9hZGVyRGF0YUdyYXBoMTBjbGFzc2VzX2RvRVAxMktsYXNzQ2xvc3VyZTogWyJDbGFzc0xvYWRlckRhdGFHcmFwaDo6Y2xhc3Nlc19kbyIsICJ2b2lkIiwgWyJwb2ludGVyIl1dLAogICAgICAgIF9aTjIwQ2xhc3NMb2FkZXJEYXRhR3JhcGgyMmNsZWFuX2RlYWxsb2NhdGVfbGlzdHNFYjogWyJDbGFzc0xvYWRlckRhdGFHcmFwaDo6Y2xlYW5fZGVhbGxvY2F0ZV9saXN0cyIsICJ2b2lkIiwgWyJpbnQiXV0sCiAgICAgICAgX1pOMTBKYXZhVGhyZWFkMjd0aHJlYWRfZnJvbV9qbmlfZW52aXJvbm1lbnRFUDdKTklFbnZfOiBbIkphdmFUaHJlYWQ6OnRocmVhZF9mcm9tX2puaV9lbnZpcm9ubWVudCIsICJwb2ludGVyIiwgWyJwb2ludGVyIl1dLAogICAgICAgIF9aTjhWTVRocmVhZDdleGVjdXRlRVAxMlZNX09wZXJhdGlvbjogWyJWTVRocmVhZDo6ZXhlY3V0ZSIsICJ2b2lkIiwgWyJwb2ludGVyIl1dLAogICAgICAgIF9aTjExT29wTWFwQ2FjaGUyMmZsdXNoX29ic29sZXRlX2VudHJpZXNFdjogWyJPb3BNYXBDYWNoZTo6Zmx1c2hfb2Jzb2xldGVfZW50cmllcyIsICJ2b2lkIiwgWyJwb2ludGVyIl1dLAogICAgICAgIF9aTjE0Tk1ldGhvZFN3ZWVwZXIxMWZvcmNlX3N3ZWVwRXY6IFsiTk1ldGhvZFN3ZWVwZXI6OmZvcmNlX3N3ZWVwIiwgInZvaWQiLCBbXV0sCiAgICAgICAgX1pOMTROTWV0aG9kU3dlZXBlcjE2c3dlZXBfY29kZV9jYWNoZUV2OiBbIk5NZXRob2RTd2VlcGVyOjpzd2VlcF9jb2RlX2NhY2hlIiwgInZvaWQiLCBbXV0sCiAgICAgICAgX1pOMTROTWV0aG9kU3dlZXBlcjE3c3dlZXBfaW5fcHJvZ3Jlc3NFdjogWyJOTWV0aG9kU3dlZXBlcjo6c3dlZXBfaW5fcHJvZ3Jlc3MiLCAiYm9vbCIsIFtdXSwKICAgICAgICBKVk1fU2xlZXA6IFsiSlZNX1NsZWVwIiwgInZvaWQiLCBbInBvaW50ZXIiLCAicG9pbnRlciIsICJsb25nIl1dCiAgICAgIH0sCiAgICAgIHZhcmlhYmxlczogewogICAgICAgIC8vIEpESyA8PSA5CiAgICAgICAgX1pOMThWTV9SZWRlZmluZUNsYXNzZXMxNF90aGVfY2xhc3Nfb29wRTogZnVuY3Rpb24oYWRkcmVzcykgewogICAgICAgICAgdGhpcy5yZWRlZmluZUNsYXNzID0gYWRkcmVzczsKICAgICAgICB9LAogICAgICAgIC8vIDkgPCBKREsgPCAxMwogICAgICAgIF9aTjE4Vk1fUmVkZWZpbmVDbGFzc2VzMTBfdGhlX2NsYXNzRTogZnVuY3Rpb24oYWRkcmVzcykgewogICAgICAgICAgdGhpcy5yZWRlZmluZUNsYXNzID0gYWRkcmVzczsKICAgICAgICB9LAogICAgICAgIC8vIEpESyA8IDEzCiAgICAgICAgX1pOMThWTV9SZWRlZmluZUNsYXNzZXMyNUFkanVzdENwb29sQ2FjaGVBbmRWdGFibGU4ZG9fa2xhc3NFUDVLbGFzczogZnVuY3Rpb24oYWRkcmVzcykgewogICAgICAgICAgdGhpcy5kb0tsYXNzID0gYWRkcmVzczsKICAgICAgICB9LAogICAgICAgIC8vIEpESyA+PSAxMwogICAgICAgIF9aTjE4Vk1fUmVkZWZpbmVDbGFzc2VzMjJBZGp1c3RBbmRDbGVhbk1ldGFkYXRhOGRvX2tsYXNzRVA1S2xhc3M6IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIHRoaXMuZG9LbGFzcyA9IGFkZHJlc3M7CiAgICAgICAgfSwKICAgICAgICBfWlRWMThWTV9SZWRlZmluZUNsYXNzZXM6IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIHRoaXMudnRhYmxlUmVkZWZpbmVDbGFzc2VzID0gYWRkcmVzczsKICAgICAgICB9LAogICAgICAgIF9aTjE4Vk1fUmVkZWZpbmVDbGFzc2VzNGRvaXRFdjogZnVuY3Rpb24oYWRkcmVzcykgewogICAgICAgICAgdGhpcy5yZWRlZmluZUNsYXNzZXNEb0l0ID0gYWRkcmVzczsKICAgICAgICB9LAogICAgICAgIF9aTjE4Vk1fUmVkZWZpbmVDbGFzc2VzMTNkb2l0X3Byb2xvZ3VlRXY6IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIHRoaXMucmVkZWZpbmVDbGFzc2VzRG9JdFByb2xvZ3VlID0gYWRkcmVzczsKICAgICAgICB9LAogICAgICAgIF9aTjE4Vk1fUmVkZWZpbmVDbGFzc2VzMTNkb2l0X2VwaWxvZ3VlRXY6IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIHRoaXMucmVkZWZpbmVDbGFzc2VzRG9JdEVwaWxvZ3VlID0gYWRkcmVzczsKICAgICAgICB9LAogICAgICAgIF9aTjE4Vk1fUmVkZWZpbmVDbGFzc2VzRDBFdjogZnVuY3Rpb24oYWRkcmVzcykgewogICAgICAgICAgdGhpcy5yZWRlZmluZUNsYXNzZXNEaXNwb3NlMCA9IGFkZHJlc3M7CiAgICAgICAgfSwKICAgICAgICBfWk4xOFZNX1JlZGVmaW5lQ2xhc3Nlc0QxRXY6IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIHRoaXMucmVkZWZpbmVDbGFzc2VzRGlzcG9zZTEgPSBhZGRyZXNzOwogICAgICAgIH0sCiAgICAgICAgX1pOSzE4Vk1fUmVkZWZpbmVDbGFzc2VzMjZhbGxvd19uZXN0ZWRfdm1fb3BlcmF0aW9uc0V2OiBmdW5jdGlvbihhZGRyZXNzKSB7CiAgICAgICAgICB0aGlzLnJlZGVmaW5lQ2xhc3Nlc0FsbG93ID0gYWRkcmVzczsKICAgICAgICB9LAogICAgICAgIF9aTksxOFZNX1JlZGVmaW5lQ2xhc3NlczE0cHJpbnRfb25fZXJyb3JFUDEyb3V0cHV0U3RyZWFtOiBmdW5jdGlvbihhZGRyZXNzKSB7CiAgICAgICAgICB0aGlzLnJlZGVmaW5lQ2xhc3Nlc09uRXJyb3IgPSBhZGRyZXNzOwogICAgICAgIH0sCiAgICAgICAgLy8gSkRLID49IDE3CiAgICAgICAgX1pOMTNJbnN0YW5jZUtsYXNzMzNjcmVhdGVfbmV3X2RlZmF1bHRfdnRhYmxlX2luZGljZXNFaVAxMEphdmFUaHJlYWQ6IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIHRoaXMuY3JlYXRlTmV3RGVmYXVsdFZ0YWJsZUluZGljZXMgPSBhZGRyZXNzOwogICAgICAgIH0sCiAgICAgICAgLy8gSkRLIDwgMTcKICAgICAgICBfWk4xM0luc3RhbmNlS2xhc3MzM2NyZWF0ZV9uZXdfZGVmYXVsdF92dGFibGVfaW5kaWNlc0VpUDZUaHJlYWQ6IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIHRoaXMuY3JlYXRlTmV3RGVmYXVsdFZ0YWJsZUluZGljZXMgPSBhZGRyZXNzOwogICAgICAgIH0sCiAgICAgICAgX1pOMTlBYnN0cmFjdF9WTV9WZXJzaW9uMTlqcmVfcmVsZWFzZV92ZXJzaW9uRXY6IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIGNvbnN0IGdldFZlcnNpb24gPSBuZXcgTmF0aXZlRnVuY3Rpb24oYWRkcmVzcywgInBvaW50ZXIiLCBbXSwgbmF0aXZlRnVuY3Rpb25PcHRpb25zNCk7CiAgICAgICAgICBjb25zdCB2ZXJzaW9uUyA9IGdldFZlcnNpb24oKS5yZWFkQ1N0cmluZygpOwogICAgICAgICAgdGhpcy52ZXJzaW9uID0gdmVyc2lvblMuc3RhcnRzV2l0aCgiMS44IikgPyA4IDogdmVyc2lvblMuc3RhcnRzV2l0aCgiOS4iKSA/IDkgOiBwYXJzZUludCh2ZXJzaW9uUy5zbGljZSgwLCAyKSwgMTApOwogICAgICAgICAgdGhpcy52ZXJzaW9uUyA9IHZlcnNpb25TOwogICAgICAgIH0sCiAgICAgICAgX1pOMTROTWV0aG9kU3dlZXBlcjExX3RyYXZlcnNhbHNFOiBmdW5jdGlvbihhZGRyZXNzKSB7CiAgICAgICAgICB0aGlzLnRyYXZlcnNhbHMgPSBhZGRyZXNzOwogICAgICAgIH0sCiAgICAgICAgX1pOMTROTWV0aG9kU3dlZXBlcjIxX3N3ZWVwX2ZyYWN0aW9uc19sZWZ0RTogZnVuY3Rpb24oYWRkcmVzcykgewogICAgICAgICAgdGhpcy5mcmFjdGlvbnMgPSBhZGRyZXNzOwogICAgICAgIH0sCiAgICAgICAgX1pOMTROTWV0aG9kU3dlZXBlcjEzX3Nob3VsZF9zd2VlcEU6IGZ1bmN0aW9uKGFkZHJlc3MpIHsKICAgICAgICAgIHRoaXMuc2hvdWxkU3dlZXAgPSBhZGRyZXNzOwogICAgICAgIH0KICAgICAgfSwKICAgICAgb3B0aW9uYWxzOiBbCiAgICAgICAgIl9aTjZNZXRob2QyNHJlc3RvcmVfdW5zaGFyZWFibGVfaW5mb0VQMTBKYXZhVGhyZWFkIiwKICAgICAgICAiX1pONk1ldGhvZDI0cmVzdG9yZV91bnNoYXJlYWJsZV9pbmZvRVA2VGhyZWFkIiwKICAgICAgICAiX1pONk1ldGhvZDExbGlua19tZXRob2RFUksxMm1ldGhvZEhhbmRsZVAxMEphdmFUaHJlYWQiLAogICAgICAgICJfWk42TWV0aG9kMTBjbGVhcl9jb2RlRXYiLAogICAgICAgICJfWk42TWV0aG9kMTBjbGVhcl9jb2RlRWIiLAogICAgICAgICJfWk4xOFZNX1JlZGVmaW5lQ2xhc3NlczE5bWFya19kZXBlbmRlbnRfY29kZUVQMTNJbnN0YW5jZUtsYXNzIiwKICAgICAgICAiX1pOMThWTV9SZWRlZmluZUNsYXNzZXMyMGZsdXNoX2RlcGVuZGVudF9jb2RlRXYiLAogICAgICAgICJfWk4xOFZNX1JlZGVmaW5lQ2xhc3NlczIwZmx1c2hfZGVwZW5kZW50X2NvZGVFUDEzSW5zdGFuY2VLbGFzc1A2VGhyZWFkIiwKICAgICAgICAiX1pOMThWTV9SZWRlZmluZUNsYXNzZXMyMGZsdXNoX2RlcGVuZGVudF9jb2RlRTE5aW5zdGFuY2VLbGFzc0hhbmRsZVA2VGhyZWFkIiwKICAgICAgICAiX1pOMTlSZXNvbHZlZE1ldGhvZFRhYmxlMjFhZGp1c3RfbWV0aG9kX2VudHJpZXNFUGIiLAogICAgICAgICJfWk4xNU1lbWJlck5hbWVUYWJsZTIxYWRqdXN0X21ldGhvZF9lbnRyaWVzRVAxM0luc3RhbmNlS2xhc3NQYiIsCiAgICAgICAgIl9aTjE3Q29uc3RhbnRQb29sQ2FjaGUyMWFkanVzdF9tZXRob2RfZW50cmllc0VQYiIsCiAgICAgICAgIl9aTjE3Q29uc3RhbnRQb29sQ2FjaGUyMWFkanVzdF9tZXRob2RfZW50cmllc0VQMTNJbnN0YW5jZUtsYXNzUGIiLAogICAgICAgICJfWk4yMENsYXNzTG9hZGVyRGF0YUdyYXBoMjJjbGVhbl9kZWFsbG9jYXRlX2xpc3RzRWIiLAogICAgICAgICJfWk4xMEphdmFUaHJlYWQyN3RocmVhZF9mcm9tX2puaV9lbnZpcm9ubWVudEVQN0pOSUVudl8iLAogICAgICAgICJfWk4xNE5NZXRob2RTd2VlcGVyMTFmb3JjZV9zd2VlcEV2IiwKICAgICAgICAiX1pOMTROTWV0aG9kU3dlZXBlcjE3c3dlZXBfaW5fcHJvZ3Jlc3NFdiIsCiAgICAgICAgIl9aTjE4Vk1fUmVkZWZpbmVDbGFzc2VzMTRfdGhlX2NsYXNzX29vcEUiLAogICAgICAgICJfWk4xOFZNX1JlZGVmaW5lQ2xhc3NlczEwX3RoZV9jbGFzc0UiLAogICAgICAgICJfWk4xOFZNX1JlZGVmaW5lQ2xhc3NlczI1QWRqdXN0Q3Bvb2xDYWNoZUFuZFZ0YWJsZThkb19rbGFzc0VQNUtsYXNzIiwKICAgICAgICAiX1pOMThWTV9SZWRlZmluZUNsYXNzZXMyMkFkanVzdEFuZENsZWFuTWV0YWRhdGE4ZG9fa2xhc3NFUDVLbGFzcyIsCiAgICAgICAgIl9aTjE4Vk1fUmVkZWZpbmVDbGFzc2VzRDBFdiIsCiAgICAgICAgIl9aTjE4Vk1fUmVkZWZpbmVDbGFzc2VzRDFFdiIsCiAgICAgICAgIl9aTksxOFZNX1JlZGVmaW5lQ2xhc3NlczE0cHJpbnRfb25fZXJyb3JFUDEyb3V0cHV0U3RyZWFtIiwKICAgICAgICAiX1pOMTNJbnN0YW5jZUtsYXNzMzNjcmVhdGVfbmV3X2RlZmF1bHRfdnRhYmxlX2luZGljZXNFaVAxMEphdmFUaHJlYWQiLAogICAgICAgICJfWk4xM0luc3RhbmNlS2xhc3MzM2NyZWF0ZV9uZXdfZGVmYXVsdF92dGFibGVfaW5kaWNlc0VpUDZUaHJlYWQiLAogICAgICAgICJfWk4xNE5NZXRob2RTd2VlcGVyMjFfc3dlZXBfZnJhY3Rpb25zX2xlZnRFIgogICAgICBdCiAgICB9XTsKICAgIGNvbnN0IG1pc3NpbmcgPSBbXTsKICAgIHBlbmRpbmcuZm9yRWFjaChmdW5jdGlvbihhcGkyKSB7CiAgICAgIGNvbnN0IG1vZHVsZSA9IGFwaTIubW9kdWxlOwogICAgICBjb25zdCBmdW5jdGlvbnMgPSBhcGkyLmZ1bmN0aW9ucyB8fCB7fTsKICAgICAgY29uc3QgdmFyaWFibGVzID0gYXBpMi52YXJpYWJsZXMgfHwge307CiAgICAgIGNvbnN0IG9wdGlvbmFscyA9IG5ldyBTZXQoYXBpMi5vcHRpb25hbHMgfHwgW10pOwogICAgICBjb25zdCB0bXAgPSBtb2R1bGUuZW51bWVyYXRlRXhwb3J0cygpLnJlZHVjZShmdW5jdGlvbihyZXN1bHQsIGV4cCkgewogICAgICAgIHJlc3VsdFtleHAubmFtZV0gPSBleHA7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfSwge30pOwogICAgICBjb25zdCBleHBvcnRCeU5hbWUgPSBtb2R1bGUuZW51bWVyYXRlU3ltYm9scygpLnJlZHVjZShmdW5jdGlvbihyZXN1bHQsIGV4cCkgewogICAgICAgIHJlc3VsdFtleHAubmFtZV0gPSBleHA7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfSwgdG1wKTsKICAgICAgT2JqZWN0LmtleXMoZnVuY3Rpb25zKS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICBjb25zdCBleHAgPSBleHBvcnRCeU5hbWVbbmFtZV07CiAgICAgICAgaWYgKGV4cCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICBjb25zdCBzaWduYXR1cmUgPSBmdW5jdGlvbnNbbmFtZV07CiAgICAgICAgICBpZiAodHlwZW9mIHNpZ25hdHVyZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBzaWduYXR1cmUuY2FsbCh0ZW1wb3JhcnlBcGksIGV4cC5hZGRyZXNzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRlbXBvcmFyeUFwaVtzaWduYXR1cmVbMF1dID0gbmV3IE5hdGl2ZUZ1bmN0aW9uKGV4cC5hZGRyZXNzLCBzaWduYXR1cmVbMV0sIHNpZ25hdHVyZVsyXSwgbmF0aXZlRnVuY3Rpb25PcHRpb25zNCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICghb3B0aW9uYWxzLmhhcyhuYW1lKSkgewogICAgICAgICAgICBtaXNzaW5nLnB1c2gobmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgT2JqZWN0LmtleXModmFyaWFibGVzKS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICBjb25zdCBleHAgPSBleHBvcnRCeU5hbWVbbmFtZV07CiAgICAgICAgaWYgKGV4cCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICBjb25zdCBoYW5kbGVyID0gdmFyaWFibGVzW25hbWVdOwogICAgICAgICAgaGFuZGxlci5jYWxsKHRlbXBvcmFyeUFwaSwgZXhwLmFkZHJlc3MpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoIW9wdGlvbmFscy5oYXMobmFtZSkpIHsKICAgICAgICAgICAgbWlzc2luZy5wdXNoKG5hbWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICAgIGlmIChtaXNzaW5nLmxlbmd0aCA+IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJKYXZhIEFQSSBvbmx5IHBhcnRpYWxseSBhdmFpbGFibGU7IHBsZWFzZSBmaWxlIGEgYnVnLiBNaXNzaW5nOiAiICsgbWlzc2luZy5qb2luKCIsICIpKTsKICAgIH0KICAgIGNvbnN0IHZtcyA9IE1lbW9yeS5hbGxvYyhwb2ludGVyU2l6ZTYpOwogICAgY29uc3Qgdm1Db3VudCA9IE1lbW9yeS5hbGxvYyhqc2l6ZVNpemUyKTsKICAgIGNoZWNrSm5pUmVzdWx0KCJKTklfR2V0Q3JlYXRlZEphdmFWTXMiLCB0ZW1wb3JhcnlBcGkuSk5JX0dldENyZWF0ZWRKYXZhVk1zKHZtcywgMSwgdm1Db3VudCkpOwogICAgaWYgKHZtQ291bnQucmVhZEludCgpID09PSAwKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgdGVtcG9yYXJ5QXBpLnZtID0gdm1zLnJlYWRQb2ludGVyKCk7CiAgICBjb25zdCBhbGxvY2F0b3JGdW5jdGlvbnMgPSBQcm9jZXNzLnBsYXRmb3JtID09PSAid2luZG93cyIgPyB7CiAgICAgICRuZXc6IFsiPz8yQFlBUEVBWF9LQFoiLCAicG9pbnRlciIsIFsidWxvbmciXV0sCiAgICAgICRkZWxldGU6IFsiPz8zQFlBWFBFQVhAWiIsICJ2b2lkIiwgWyJwb2ludGVyIl1dCiAgICB9IDogewogICAgICAkbmV3OiBbIl9abndtIiwgInBvaW50ZXIiLCBbInVsb25nIl1dLAogICAgICAkZGVsZXRlOiBbIl9aZGxQdiIsICJ2b2lkIiwgWyJwb2ludGVyIl1dCiAgICB9OwogICAgZm9yIChjb25zdCBbbmFtZSwgW3Jhd05hbWUsIHJldFR5cGUsIGFyZ1R5cGVzXV0gb2YgT2JqZWN0LmVudHJpZXMoYWxsb2NhdG9yRnVuY3Rpb25zKSkgewogICAgICBsZXQgYWRkcmVzcyA9IE1vZHVsZS5maW5kR2xvYmFsRXhwb3J0QnlOYW1lKHJhd05hbWUpOwogICAgICBpZiAoYWRkcmVzcyA9PT0gbnVsbCkgewogICAgICAgIGFkZHJlc3MgPSBEZWJ1Z1N5bWJvbC5mcm9tTmFtZShyYXdOYW1lKS5hZGRyZXNzOwogICAgICAgIGlmIChhZGRyZXNzLmlzTnVsbCgpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHVuYWJsZSB0byBmaW5kIEMrKyBhbGxvY2F0b3IgQVBJLCBtaXNzaW5nOiAnJHtyYXdOYW1lfSdgKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGVtcG9yYXJ5QXBpW25hbWVdID0gbmV3IE5hdGl2ZUZ1bmN0aW9uKGFkZHJlc3MsIHJldFR5cGUsIGFyZ1R5cGVzLCBuYXRpdmVGdW5jdGlvbk9wdGlvbnM0KTsKICAgIH0KICAgIHRlbXBvcmFyeUFwaS5qdm10aSA9IGdldEVudkp2bXRpKHRlbXBvcmFyeUFwaSk7CiAgICBpZiAodGVtcG9yYXJ5QXBpWyJKYXZhVGhyZWFkOjp0aHJlYWRfZnJvbV9qbmlfZW52aXJvbm1lbnQiXSA9PT0gdm9pZCAwKSB7CiAgICAgIHRlbXBvcmFyeUFwaVsiSmF2YVRocmVhZDo6dGhyZWFkX2Zyb21fam5pX2Vudmlyb25tZW50Il0gPSBtYWtlVGhyZWFkRnJvbUpuaUhlbHBlcih0ZW1wb3JhcnlBcGkpOwogICAgfQogICAgcmV0dXJuIHRlbXBvcmFyeUFwaTsKICB9CiAgZnVuY3Rpb24gZ2V0RW52SnZtdGkoYXBpMikgewogICAgY29uc3Qgdm0zID0gbmV3IFZNKGFwaTIpOwogICAgbGV0IGVudjsKICAgIHZtMy5wZXJmb3JtKCgpID0+IHsKICAgICAgY29uc3QgaGFuZGxlID0gdm0zLnRyeUdldEVudkhhbmRsZShqdm10aVZlcnNpb24udjFfMCk7CiAgICAgIGlmIChoYW5kbGUgPT09IG51bGwpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkpWTVRJIG5vdCBhdmFpbGFibGUiKTsKICAgICAgfQogICAgICBlbnYgPSBuZXcgRW52SnZtdGkoaGFuZGxlLCB2bTMpOwogICAgICBjb25zdCBjYXBhQnVmID0gTWVtb3J5LmFsbG9jKDgpOwogICAgICBjYXBhQnVmLndyaXRlVTY0KGp2bXRpQ2FwYWJpbGl0aWVzLmNhblRhZ09iamVjdHMpOwogICAgICBjb25zdCByZXN1bHQgPSBlbnYuYWRkQ2FwYWJpbGl0aWVzKGNhcGFCdWYpOwogICAgICBjaGVja0puaVJlc3VsdCgiZ2V0RW52SnZtdGk6OkFkZENhcGFiaWxpdGllcyIsIHJlc3VsdCk7CiAgICB9KTsKICAgIHJldHVybiBlbnY7CiAgfQogIHZhciB0aHJlYWRPZmZzZXRQYXJzZXJzID0gewogICAgeDY0OiBwYXJzZVg2NFRocmVhZE9mZnNldAogIH07CiAgZnVuY3Rpb24gbWFrZVRocmVhZEZyb21KbmlIZWxwZXIoYXBpMikgewogICAgbGV0IG9mZnNldCA9IG51bGw7CiAgICBjb25zdCB0cnlQYXJzZSA9IHRocmVhZE9mZnNldFBhcnNlcnNbUHJvY2Vzcy5hcmNoXTsKICAgIGlmICh0cnlQYXJzZSAhPT0gdm9pZCAwKSB7CiAgICAgIGNvbnN0IHZtMyA9IG5ldyBWTShhcGkyKTsKICAgICAgY29uc3QgZmluZENsYXNzSW1wbCA9IHZtMy5wZXJmb3JtKChlbnYpID0+IGVudi5oYW5kbGUucmVhZFBvaW50ZXIoKS5hZGQoNiAqIHBvaW50ZXJTaXplNikucmVhZFBvaW50ZXIoKSk7CiAgICAgIG9mZnNldCA9IHBhcnNlSW5zdHJ1Y3Rpb25zQXQoZmluZENsYXNzSW1wbCwgdHJ5UGFyc2UsIHsgbGltaXQ6IDExIH0pOwogICAgfQogICAgaWYgKG9mZnNldCA9PT0gbnVsbCkgewogICAgICByZXR1cm4gKCkgPT4gewogICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIG1ha2UgdGhyZWFkX2Zyb21fam5pX2Vudmlyb25tZW50KCkgaGVscGVyIGZvciB0aGUgY3VycmVudCBhcmNoaXRlY3R1cmUiKTsKICAgICAgfTsKICAgIH0KICAgIHJldHVybiAoZW52KSA9PiB7CiAgICAgIHJldHVybiBlbnYuYWRkKG9mZnNldCk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBwYXJzZVg2NFRocmVhZE9mZnNldChpbnNuKSB7CiAgICBpZiAoaW5zbi5tbmVtb25pYyAhPT0gImxlYSIpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBjb25zdCB7IGJhc2UsIGRpc3AgfSA9IGluc24ub3BlcmFuZHNbMV0udmFsdWU7CiAgICBpZiAoIShiYXNlID09PSAicmRpIiAmJiBkaXNwIDwgMCkpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICByZXR1cm4gZGlzcDsKICB9CiAgZnVuY3Rpb24gZW5zdXJlQ2xhc3NJbml0aWFsaXplZDIoZW52LCBjbGFzc1JlZikgewogIH0KICB2YXIgSnZtTWV0aG9kTWFuZ2xlciA9IGNsYXNzIHsKICAgIGNvbnN0cnVjdG9yKG1ldGhvZElkKSB7CiAgICAgIHRoaXMubWV0aG9kSWQgPSBtZXRob2RJZDsKICAgICAgdGhpcy5tZXRob2QgPSBtZXRob2RJZC5yZWFkUG9pbnRlcigpOwogICAgICB0aGlzLm9yaWdpbmFsTWV0aG9kID0gbnVsbDsKICAgICAgdGhpcy5uZXdNZXRob2QgPSBudWxsOwogICAgICB0aGlzLnJlc29sdmVkID0gbnVsbDsKICAgICAgdGhpcy5pbXBsID0gbnVsbDsKICAgICAgdGhpcy5rZXkgPSBtZXRob2RJZC50b1N0cmluZygxNik7CiAgICB9CiAgICByZXBsYWNlKGltcGwsIGlzSW5zdGFuY2VNZXRob2QsIGFyZ1R5cGVzLCB2bTMsIGFwaTIpIHsKICAgICAgY29uc3QgeyBrZXkgfSA9IHRoaXM7CiAgICAgIGNvbnN0IG1hbmdsZXIgPSByZXZlcnRNYW5nbGVycy5nZXQoa2V5KTsKICAgICAgaWYgKG1hbmdsZXIgIT09IHZvaWQgMCkgewogICAgICAgIHJldmVydE1hbmdsZXJzLmRlbGV0ZShrZXkpOwogICAgICAgIHRoaXMubWV0aG9kID0gbWFuZ2xlci5tZXRob2Q7CiAgICAgICAgdGhpcy5vcmlnaW5hbE1ldGhvZCA9IG1hbmdsZXIub3JpZ2luYWxNZXRob2Q7CiAgICAgICAgdGhpcy5uZXdNZXRob2QgPSBtYW5nbGVyLm5ld01ldGhvZDsKICAgICAgICB0aGlzLnJlc29sdmVkID0gbWFuZ2xlci5yZXNvbHZlZDsKICAgICAgfQogICAgICB0aGlzLmltcGwgPSBpbXBsOwogICAgICByZXBsYWNlTWFuZ2xlcnMuc2V0KGtleSwgdGhpcyk7CiAgICAgIGVuc3VyZU1hbmdsZXJzU2NoZWR1bGVkKHZtMyk7CiAgICB9CiAgICByZXZlcnQodm0zKSB7CiAgICAgIGNvbnN0IHsga2V5IH0gPSB0aGlzOwogICAgICByZXBsYWNlTWFuZ2xlcnMuZGVsZXRlKGtleSk7CiAgICAgIHJldmVydE1hbmdsZXJzLnNldChrZXksIHRoaXMpOwogICAgICBlbnN1cmVNYW5nbGVyc1NjaGVkdWxlZCh2bTMpOwogICAgfQogICAgcmVzb2x2ZVRhcmdldCh3cmFwcGVyLCBpc0luc3RhbmNlTWV0aG9kLCBlbnYsIGFwaTIpIHsKICAgICAgY29uc3QgeyByZXNvbHZlZCwgb3JpZ2luYWxNZXRob2QsIG1ldGhvZElkIH0gPSB0aGlzOwogICAgICBpZiAocmVzb2x2ZWQgIT09IG51bGwpIHsKICAgICAgICByZXR1cm4gcmVzb2x2ZWQ7CiAgICAgIH0KICAgICAgaWYgKG9yaWdpbmFsTWV0aG9kID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIG1ldGhvZElkOwogICAgICB9CiAgICAgIGNvbnN0IHZpcCA9IG9yaWdpbmFsTWV0aG9kLm9sZE1ldGhvZC52dGFibGVJbmRleFB0cjsKICAgICAgdmlwLndyaXRlUzMyKC0yKTsKICAgICAgY29uc3Qgam1ldGhvZElEID0gTWVtb3J5LmFsbG9jKHBvaW50ZXJTaXplNik7CiAgICAgIGptZXRob2RJRC53cml0ZVBvaW50ZXIodGhpcy5tZXRob2QpOwogICAgICB0aGlzLnJlc29sdmVkID0gam1ldGhvZElEOwogICAgICByZXR1cm4gam1ldGhvZElEOwogICAgfQogIH07CiAgZnVuY3Rpb24gZW5zdXJlTWFuZ2xlcnNTY2hlZHVsZWQodm0zKSB7CiAgICBpZiAoIW1hbmdsZXJzU2NoZWR1bGVkKSB7CiAgICAgIG1hbmdsZXJzU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgU2NyaXB0Lm5leHRUaWNrKGRvTWFuZ2xlcnMsIHZtMyk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGRvTWFuZ2xlcnModm0zKSB7CiAgICBjb25zdCBsb2NhbFJlcGxhY2VNYW5nbGVycyA9IG5ldyBNYXAocmVwbGFjZU1hbmdsZXJzKTsKICAgIGNvbnN0IGxvY2FsUmV2ZXJ0TWFuZ2xlcnMgPSBuZXcgTWFwKHJldmVydE1hbmdsZXJzKTsKICAgIHJlcGxhY2VNYW5nbGVycy5jbGVhcigpOwogICAgcmV2ZXJ0TWFuZ2xlcnMuY2xlYXIoKTsKICAgIG1hbmdsZXJzU2NoZWR1bGVkID0gZmFsc2U7CiAgICB2bTMucGVyZm9ybSgoZW52KSA9PiB7CiAgICAgIGNvbnN0IGFwaTIgPSBnZXRBcGkyKCk7CiAgICAgIGNvbnN0IHRocmVhZCA9IGFwaTJbIkphdmFUaHJlYWQ6OnRocmVhZF9mcm9tX2puaV9lbnZpcm9ubWVudCJdKGVudi5oYW5kbGUpOwogICAgICBsZXQgZm9yY2UgPSBmYWxzZTsKICAgICAgd2l0aEp2bVRocmVhZCgoKSA9PiB7CiAgICAgICAgbG9jYWxSZXBsYWNlTWFuZ2xlcnMuZm9yRWFjaCgobWFuZ2xlcikgPT4gewogICAgICAgICAgY29uc3QgeyBtZXRob2QsIG9yaWdpbmFsTWV0aG9kLCBpbXBsLCBtZXRob2RJZCwgbmV3TWV0aG9kIH0gPSBtYW5nbGVyOwogICAgICAgICAgaWYgKG9yaWdpbmFsTWV0aG9kID09PSBudWxsKSB7CiAgICAgICAgICAgIG1hbmdsZXIub3JpZ2luYWxNZXRob2QgPSBmZXRjaEp2bU1ldGhvZChtZXRob2QpOwogICAgICAgICAgICBtYW5nbGVyLm5ld01ldGhvZCA9IG5hdGl2ZUp2bU1ldGhvZChtZXRob2QsIGltcGwsIHRocmVhZCk7CiAgICAgICAgICAgIGluc3RhbGxKdm1NZXRob2QobWFuZ2xlci5uZXdNZXRob2QsIG1ldGhvZElkLCB0aHJlYWQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYXBpMlsiTWV0aG9kOjpzZXRfbmF0aXZlX2Z1bmN0aW9uIl0obmV3TWV0aG9kLm1ldGhvZCwgaW1wbCwgMCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgbG9jYWxSZXZlcnRNYW5nbGVycy5mb3JFYWNoKChtYW5nbGVyKSA9PiB7CiAgICAgICAgICBjb25zdCB7IG9yaWdpbmFsTWV0aG9kLCBtZXRob2RJZCwgbmV3TWV0aG9kIH0gPSBtYW5nbGVyOwogICAgICAgICAgaWYgKG9yaWdpbmFsTWV0aG9kICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldmVydEp2bU1ldGhvZChvcmlnaW5hbE1ldGhvZCk7CiAgICAgICAgICAgIGNvbnN0IHJldmVydCA9IG9yaWdpbmFsTWV0aG9kLm9sZE1ldGhvZDsKICAgICAgICAgICAgcmV2ZXJ0Lm9sZE1ldGhvZCA9IG5ld01ldGhvZDsKICAgICAgICAgICAgaW5zdGFsbEp2bU1ldGhvZChyZXZlcnQsIG1ldGhvZElkLCB0aHJlYWQpOwogICAgICAgICAgICBmb3JjZSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICBpZiAoZm9yY2UpIHsKICAgICAgICBmb3JjZVN3ZWVwKGVudi5oYW5kbGUpOwogICAgICB9CiAgICB9KTsKICB9CiAgZnVuY3Rpb24gZm9yY2VTd2VlcChlbnYpIHsKICAgIGNvbnN0IHsKICAgICAgZnJhY3Rpb25zLAogICAgICBzaG91bGRTd2VlcCwKICAgICAgdHJhdmVyc2FscywKICAgICAgIk5NZXRob2RTd2VlcGVyOjpzd2VlcF9jb2RlX2NhY2hlIjogc3dlZXAsCiAgICAgICJOTWV0aG9kU3dlZXBlcjo6c3dlZXBfaW5fcHJvZ3Jlc3MiOiBpblByb2dyZXNzLAogICAgICAiTk1ldGhvZFN3ZWVwZXI6OmZvcmNlX3N3ZWVwIjogZm9yY2UsCiAgICAgIEpWTV9TbGVlcDogc2xlZXAKICAgIH0gPSBnZXRBcGkyKCk7CiAgICBpZiAoZm9yY2UgIT09IHZvaWQgMCkgewogICAgICBUaHJlYWQuc2xlZXAoMC4wNSk7CiAgICAgIGZvcmNlKCk7CiAgICAgIFRocmVhZC5zbGVlcCgwLjA1KTsKICAgICAgZm9yY2UoKTsKICAgIH0gZWxzZSB7CiAgICAgIGxldCB0cmF2ID0gdHJhdmVyc2Fscy5yZWFkUzY0KCk7CiAgICAgIGNvbnN0IGVuZFRyYXYgPSB0cmF2ICsgMjsKICAgICAgd2hpbGUgKGVuZFRyYXYgPiB0cmF2KSB7CiAgICAgICAgZnJhY3Rpb25zLndyaXRlUzMyKDEpOwogICAgICAgIHNsZWVwKGVudiwgTlVMTCwgNTApOwogICAgICAgIGlmICghaW5Qcm9ncmVzcygpKSB7CiAgICAgICAgICB3aXRoSnZtVGhyZWFkKCgpID0+IHsKICAgICAgICAgICAgVGhyZWFkLnNsZWVwKDAuMDUpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN3ZWVwTm90QWxyZWFkeUluUHJvZ3Jlc3MgPSBzaG91bGRTd2VlcC5yZWFkVTgoKSA9PT0gMDsKICAgICAgICBpZiAoc3dlZXBOb3RBbHJlYWR5SW5Qcm9ncmVzcykgewogICAgICAgICAgZnJhY3Rpb25zLndyaXRlUzMyKDEpOwogICAgICAgICAgc3dlZXAoKTsKICAgICAgICB9CiAgICAgICAgdHJhdiA9IHRyYXZlcnNhbHMucmVhZFM2NCgpOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIHdpdGhKdm1UaHJlYWQoZm4sIGZuUHJvbG9ndWUsIGZuRXBpbG9ndWUpIHsKICAgIGNvbnN0IHsKICAgICAgZXhlY3V0ZSwKICAgICAgdnRhYmxlOiB2dGFibGUyLAogICAgICB2dGFibGVTaXplLAogICAgICBkb0l0T2Zmc2V0LAogICAgICBwcm9sb2d1ZU9mZnNldCwKICAgICAgZXBpbG9ndWVPZmZzZXQKICAgIH0gPSBnZXRKdm1UaHJlYWRTcGVjKCk7CiAgICBjb25zdCB2dGFibGVEdXAgPSBNZW1vcnkuZHVwKHZ0YWJsZTIsIHZ0YWJsZVNpemUpOwogICAgY29uc3Qgdm1PcGVyYXRpb24gPSBNZW1vcnkuYWxsb2MocG9pbnRlclNpemU2ICogMjUpOwogICAgdm1PcGVyYXRpb24ud3JpdGVQb2ludGVyKHZ0YWJsZUR1cCk7CiAgICBjb25zdCBkb0l0ID0gbmV3IE5hdGl2ZUNhbGxiYWNrKGZuLCAidm9pZCIsIFsicG9pbnRlciJdKTsKICAgIHZ0YWJsZUR1cC5hZGQoZG9JdE9mZnNldCkud3JpdGVQb2ludGVyKGRvSXQpOwogICAgbGV0IHByb2xvZ3VlID0gbnVsbDsKICAgIGlmIChmblByb2xvZ3VlICE9PSB2b2lkIDApIHsKICAgICAgcHJvbG9ndWUgPSBuZXcgTmF0aXZlQ2FsbGJhY2soZm5Qcm9sb2d1ZSwgImludCIsIFsicG9pbnRlciJdKTsKICAgICAgdnRhYmxlRHVwLmFkZChwcm9sb2d1ZU9mZnNldCkud3JpdGVQb2ludGVyKHByb2xvZ3VlKTsKICAgIH0KICAgIGxldCBlcGlsb2d1ZSA9IG51bGw7CiAgICBpZiAoZm5FcGlsb2d1ZSAhPT0gdm9pZCAwKSB7CiAgICAgIGVwaWxvZ3VlID0gbmV3IE5hdGl2ZUNhbGxiYWNrKGZuRXBpbG9ndWUsICJ2b2lkIiwgWyJwb2ludGVyIl0pOwogICAgICB2dGFibGVEdXAuYWRkKGVwaWxvZ3VlT2Zmc2V0KS53cml0ZVBvaW50ZXIoZXBpbG9ndWUpOwogICAgfQogICAgZXhlY3V0ZSh2bU9wZXJhdGlvbik7CiAgfQogIGZ1bmN0aW9uIF9nZXRKdm1UaHJlYWRTcGVjKCkgewogICAgY29uc3QgewogICAgICB2dGFibGVSZWRlZmluZUNsYXNzZXMsCiAgICAgIHJlZGVmaW5lQ2xhc3Nlc0RvSXQsCiAgICAgIHJlZGVmaW5lQ2xhc3Nlc0RvSXRQcm9sb2d1ZSwKICAgICAgcmVkZWZpbmVDbGFzc2VzRG9JdEVwaWxvZ3VlLAogICAgICByZWRlZmluZUNsYXNzZXNPbkVycm9yLAogICAgICByZWRlZmluZUNsYXNzZXNBbGxvdywKICAgICAgcmVkZWZpbmVDbGFzc2VzRGlzcG9zZTAsCiAgICAgIHJlZGVmaW5lQ2xhc3Nlc0Rpc3Bvc2UxLAogICAgICAiVk1UaHJlYWQ6OmV4ZWN1dGUiOiBleGVjdXRlCiAgICB9ID0gZ2V0QXBpMigpOwogICAgY29uc3QgdnRhYmxlUHRyID0gdnRhYmxlUmVkZWZpbmVDbGFzc2VzLmFkZCgyICogcG9pbnRlclNpemU2KTsKICAgIGNvbnN0IHZ0YWJsZVNpemUgPSAxNSAqIHBvaW50ZXJTaXplNjsKICAgIGNvbnN0IHZ0YWJsZTIgPSBNZW1vcnkuZHVwKHZ0YWJsZVB0ciwgdnRhYmxlU2l6ZSk7CiAgICBjb25zdCBlbXB0eUNhbGxiYWNrID0gbmV3IE5hdGl2ZUNhbGxiYWNrKCgpID0+IHsKICAgIH0sICJ2b2lkIiwgWyJwb2ludGVyIl0pOwogICAgbGV0IGRvSXRPZmZzZXQsIHByb2xvZ3VlT2Zmc2V0LCBlcGlsb2d1ZU9mZnNldDsKICAgIGZvciAobGV0IG9mZnNldCA9IDA7IG9mZnNldCAhPT0gdnRhYmxlU2l6ZTsgb2Zmc2V0ICs9IHBvaW50ZXJTaXplNikgewogICAgICBjb25zdCBlbGVtZW50ID0gdnRhYmxlMi5hZGQob2Zmc2V0KTsKICAgICAgY29uc3QgdmFsdWUgPSBlbGVtZW50LnJlYWRQb2ludGVyKCk7CiAgICAgIGlmIChyZWRlZmluZUNsYXNzZXNPbkVycm9yICE9PSB2b2lkIDAgJiYgdmFsdWUuZXF1YWxzKHJlZGVmaW5lQ2xhc3Nlc09uRXJyb3IpIHx8IHJlZGVmaW5lQ2xhc3Nlc0Rpc3Bvc2UwICE9PSB2b2lkIDAgJiYgdmFsdWUuZXF1YWxzKHJlZGVmaW5lQ2xhc3Nlc0Rpc3Bvc2UwKSB8fCByZWRlZmluZUNsYXNzZXNEaXNwb3NlMSAhPT0gdm9pZCAwICYmIHZhbHVlLmVxdWFscyhyZWRlZmluZUNsYXNzZXNEaXNwb3NlMSkpIHsKICAgICAgICBlbGVtZW50LndyaXRlUG9pbnRlcihlbXB0eUNhbGxiYWNrKTsKICAgICAgfSBlbHNlIGlmICh2YWx1ZS5lcXVhbHMocmVkZWZpbmVDbGFzc2VzRG9JdCkpIHsKICAgICAgICBkb0l0T2Zmc2V0ID0gb2Zmc2V0OwogICAgICB9IGVsc2UgaWYgKHZhbHVlLmVxdWFscyhyZWRlZmluZUNsYXNzZXNEb0l0UHJvbG9ndWUpKSB7CiAgICAgICAgcHJvbG9ndWVPZmZzZXQgPSBvZmZzZXQ7CiAgICAgICAgZWxlbWVudC53cml0ZVBvaW50ZXIocmVkZWZpbmVDbGFzc2VzQWxsb3cpOwogICAgICB9IGVsc2UgaWYgKHZhbHVlLmVxdWFscyhyZWRlZmluZUNsYXNzZXNEb0l0RXBpbG9ndWUpKSB7CiAgICAgICAgZXBpbG9ndWVPZmZzZXQgPSBvZmZzZXQ7CiAgICAgICAgZWxlbWVudC53cml0ZVBvaW50ZXIoZW1wdHlDYWxsYmFjayk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB7CiAgICAgIGV4ZWN1dGUsCiAgICAgIGVtcHR5Q2FsbGJhY2ssCiAgICAgIHZ0YWJsZTogdnRhYmxlMiwKICAgICAgdnRhYmxlU2l6ZSwKICAgICAgZG9JdE9mZnNldCwKICAgICAgcHJvbG9ndWVPZmZzZXQsCiAgICAgIGVwaWxvZ3VlT2Zmc2V0CiAgICB9OwogIH0KICBmdW5jdGlvbiBtYWtlTWV0aG9kTWFuZ2xlcjIobWV0aG9kSWQpIHsKICAgIHJldHVybiBuZXcgSnZtTWV0aG9kTWFuZ2xlcihtZXRob2RJZCk7CiAgfQogIGZ1bmN0aW9uIGluc3RhbGxKdm1NZXRob2QobWV0aG9kLCBtZXRob2RJZCwgdGhyZWFkKSB7CiAgICBjb25zdCB7IG1ldGhvZDogaGFuZGxlLCBvbGRNZXRob2Q6IG9sZCB9ID0gbWV0aG9kOwogICAgY29uc3QgYXBpMiA9IGdldEFwaTIoKTsKICAgIG1ldGhvZC5tZXRob2RzQXJyYXkuYWRkKG1ldGhvZC5tZXRob2RJbmRleCAqIHBvaW50ZXJTaXplNikud3JpdGVQb2ludGVyKGhhbmRsZSk7CiAgICBpZiAobWV0aG9kLnZ0YWJsZUluZGV4ID49IDApIHsKICAgICAgbWV0aG9kLnZ0YWJsZS5hZGQobWV0aG9kLnZ0YWJsZUluZGV4ICogcG9pbnRlclNpemU2KS53cml0ZVBvaW50ZXIoaGFuZGxlKTsKICAgIH0KICAgIG1ldGhvZElkLndyaXRlUG9pbnRlcihoYW5kbGUpOwogICAgb2xkLmFjY2Vzc0ZsYWdzUHRyLndyaXRlVTMyKChvbGQuYWNjZXNzRmxhZ3MgfCBKVk1fQUNDX0lTX09MRCB8IEpWTV9BQ0NfSVNfT0JTT0xFVEUpID4+PiAwKTsKICAgIGNvbnN0IGZsdXNoT2JzID0gYXBpMlsiT29wTWFwQ2FjaGU6OmZsdXNoX29ic29sZXRlX2VudHJpZXMiXTsKICAgIGlmIChmbHVzaE9icyAhPT0gdm9pZCAwKSB7CiAgICAgIGNvbnN0IHsgb29wTWFwQ2FjaGUgfSA9IG1ldGhvZDsKICAgICAgaWYgKCFvb3BNYXBDYWNoZS5pc051bGwoKSkgewogICAgICAgIGZsdXNoT2JzKG9vcE1hcENhY2hlKTsKICAgICAgfQogICAgfQogICAgY29uc3QgbWFyayA9IGFwaTJbIlZNX1JlZGVmaW5lQ2xhc3Nlczo6bWFya19kZXBlbmRlbnRfY29kZSJdOwogICAgY29uc3QgZmx1c2ggPSBhcGkyWyJWTV9SZWRlZmluZUNsYXNzZXM6OmZsdXNoX2RlcGVuZGVudF9jb2RlIl07CiAgICBpZiAobWFyayAhPT0gdm9pZCAwKSB7CiAgICAgIG1hcmsoTlVMTCwgbWV0aG9kLmluc3RhbmNlS2xhc3MpOwogICAgICBmbHVzaCgpOwogICAgfSBlbHNlIHsKICAgICAgZmx1c2goTlVMTCwgbWV0aG9kLmluc3RhbmNlS2xhc3MsIHRocmVhZCk7CiAgICB9CiAgICBjb25zdCB0cmFjZU5hbWVQcmludGVkID0gTWVtb3J5LmFsbG9jKDEpOwogICAgdHJhY2VOYW1lUHJpbnRlZC53cml0ZVU4KDEpOwogICAgYXBpMlsiQ29uc3RhbnRQb29sQ2FjaGU6OmFkanVzdF9tZXRob2RfZW50cmllcyJdKG1ldGhvZC5jYWNoZSwgbWV0aG9kLmluc3RhbmNlS2xhc3MsIHRyYWNlTmFtZVByaW50ZWQpOwogICAgY29uc3Qga2xhc3NDbG9zdXJlID0gTWVtb3J5LmFsbG9jKDMgKiBwb2ludGVyU2l6ZTYpOwogICAgY29uc3QgZG9LbGFzc1B0ciA9IE1lbW9yeS5hbGxvYyhwb2ludGVyU2l6ZTYpOwogICAgZG9LbGFzc1B0ci53cml0ZVBvaW50ZXIoYXBpMi5kb0tsYXNzKTsKICAgIGtsYXNzQ2xvc3VyZS53cml0ZVBvaW50ZXIoZG9LbGFzc1B0cik7CiAgICBrbGFzc0Nsb3N1cmUuYWRkKHBvaW50ZXJTaXplNikud3JpdGVQb2ludGVyKHRocmVhZCk7CiAgICBrbGFzc0Nsb3N1cmUuYWRkKDIgKiBwb2ludGVyU2l6ZTYpLndyaXRlUG9pbnRlcih0aHJlYWQpOwogICAgaWYgKGFwaTIucmVkZWZpbmVDbGFzcyAhPT0gdm9pZCAwKSB7CiAgICAgIGFwaTIucmVkZWZpbmVDbGFzcy53cml0ZVBvaW50ZXIobWV0aG9kLmluc3RhbmNlS2xhc3MpOwogICAgfQogICAgYXBpMlsiQ2xhc3NMb2FkZXJEYXRhR3JhcGg6OmNsYXNzZXNfZG8iXShrbGFzc0Nsb3N1cmUpOwogICAgY29uc3Qgcm10QWRqdXN0TWV0aG9kRW50cmllcyA9IGFwaTJbIlJlc29sdmVkTWV0aG9kVGFibGU6OmFkanVzdF9tZXRob2RfZW50cmllcyJdOwogICAgaWYgKHJtdEFkanVzdE1ldGhvZEVudHJpZXMgIT09IHZvaWQgMCkgewogICAgICBybXRBZGp1c3RNZXRob2RFbnRyaWVzKHRyYWNlTmFtZVByaW50ZWQpOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgeyBtZW1iZXJOYW1lcyB9ID0gbWV0aG9kOwogICAgICBpZiAoIW1lbWJlck5hbWVzLmlzTnVsbCgpKSB7CiAgICAgICAgY29uc3QgbW50QWRqdXN0TWV0aG9kRW50cmllcyA9IGFwaTJbIk1lbWJlck5hbWVUYWJsZTo6YWRqdXN0X21ldGhvZF9lbnRyaWVzIl07CiAgICAgICAgaWYgKG1udEFkanVzdE1ldGhvZEVudHJpZXMgIT09IHZvaWQgMCkgewogICAgICAgICAgbW50QWRqdXN0TWV0aG9kRW50cmllcyhtZW1iZXJOYW1lcywgbWV0aG9kLmluc3RhbmNlS2xhc3MsIHRyYWNlTmFtZVByaW50ZWQpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgY29uc3QgY2xlYW4gPSBhcGkyWyJDbGFzc0xvYWRlckRhdGFHcmFwaDo6Y2xlYW5fZGVhbGxvY2F0ZV9saXN0cyJdOwogICAgaWYgKGNsZWFuICE9PSB2b2lkIDApIHsKICAgICAgY2xlYW4oMCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIG5hdGl2ZUp2bU1ldGhvZChtZXRob2QsIGltcGwsIHRocmVhZCkgewogICAgY29uc3QgYXBpMiA9IGdldEFwaTIoKTsKICAgIGNvbnN0IG5ld01ldGhvZCA9IGZldGNoSnZtTWV0aG9kKG1ldGhvZCk7CiAgICBuZXdNZXRob2QuY29uc3RQdHIud3JpdGVQb2ludGVyKG5ld01ldGhvZC5jb25zdCk7CiAgICBjb25zdCBmbGFncyA9IChuZXdNZXRob2QuYWNjZXNzRmxhZ3MgfCBKVk1fQUNDX05BVElWRSB8IEpWTV9BQ0NfTk9UX0MyX0NPTVBJTEFCTEUgfCBKVk1fQUNDX05PVF9DMV9DT01QSUxBQkxFIHwgSlZNX0FDQ19OT1RfQzJfT1NSX0NPTVBJTEFCTEUpID4+PiAwOwogICAgbmV3TWV0aG9kLmFjY2Vzc0ZsYWdzUHRyLndyaXRlVTMyKGZsYWdzKTsKICAgIG5ld01ldGhvZC5zaWduYXR1cmVIYW5kbGVyLndyaXRlUG9pbnRlcihOVUxMKTsKICAgIG5ld01ldGhvZC5hZGFwdGVyLndyaXRlUG9pbnRlcihOVUxMKTsKICAgIG5ld01ldGhvZC5pMmlFbnRyeS53cml0ZVBvaW50ZXIoTlVMTCk7CiAgICBhcGkyWyJNZXRob2Q6OmNsZWFyX2NvZGUiXShuZXdNZXRob2QubWV0aG9kKTsKICAgIG5ld01ldGhvZC5kYXRhUHRyLndyaXRlUG9pbnRlcihOVUxMKTsKICAgIG5ld01ldGhvZC5jb3VudGVyc1B0ci53cml0ZVBvaW50ZXIoTlVMTCk7CiAgICBuZXdNZXRob2Quc3RhY2ttYXBQdHIud3JpdGVQb2ludGVyKE5VTEwpOwogICAgYXBpMlsiTWV0aG9kOjpjbGVhcl9uYXRpdmVfZnVuY3Rpb24iXShuZXdNZXRob2QubWV0aG9kKTsKICAgIGFwaTJbIk1ldGhvZDo6c2V0X25hdGl2ZV9mdW5jdGlvbiJdKG5ld01ldGhvZC5tZXRob2QsIGltcGwsIDApOwogICAgYXBpMlsiTWV0aG9kOjpyZXN0b3JlX3Vuc2hhcmVhYmxlX2luZm8iXShuZXdNZXRob2QubWV0aG9kLCB0aHJlYWQpOwogICAgaWYgKGFwaTIudmVyc2lvbiA+PSAxNykgewogICAgICBjb25zdCBtZXRob2RIYW5kbGUgPSBNZW1vcnkuYWxsb2MoMiAqIHBvaW50ZXJTaXplNik7CiAgICAgIG1ldGhvZEhhbmRsZS53cml0ZVBvaW50ZXIobmV3TWV0aG9kLm1ldGhvZCk7CiAgICAgIG1ldGhvZEhhbmRsZS5hZGQocG9pbnRlclNpemU2KS53cml0ZVBvaW50ZXIodGhyZWFkKTsKICAgICAgYXBpMlsiTWV0aG9kOjpsaW5rX21ldGhvZCJdKG5ld01ldGhvZC5tZXRob2QsIG1ldGhvZEhhbmRsZSwgdGhyZWFkKTsKICAgIH0KICAgIHJldHVybiBuZXdNZXRob2Q7CiAgfQogIGZ1bmN0aW9uIGZldGNoSnZtTWV0aG9kKG1ldGhvZCkgewogICAgY29uc3Qgc3BlYyA9IGdldEp2bU1ldGhvZFNwZWMoKTsKICAgIGNvbnN0IGNvbnN0TWV0aG9kID0gbWV0aG9kLmFkZChzcGVjLm1ldGhvZC5jb25zdE1ldGhvZE9mZnNldCkucmVhZFBvaW50ZXIoKTsKICAgIGNvbnN0IGNvbnN0TWV0aG9kU2l6ZSA9IGNvbnN0TWV0aG9kLmFkZChzcGVjLmNvbnN0TWV0aG9kLnNpemVPZmZzZXQpLnJlYWRTMzIoKSAqIHBvaW50ZXJTaXplNjsKICAgIGNvbnN0IG5ld0NvbnN0TWV0aG9kID0gTWVtb3J5LmFsbG9jKGNvbnN0TWV0aG9kU2l6ZSArIHNwZWMubWV0aG9kLnNpemUpOwogICAgTWVtb3J5LmNvcHkobmV3Q29uc3RNZXRob2QsIGNvbnN0TWV0aG9kLCBjb25zdE1ldGhvZFNpemUpOwogICAgY29uc3QgbmV3TWV0aG9kID0gbmV3Q29uc3RNZXRob2QuYWRkKGNvbnN0TWV0aG9kU2l6ZSk7CiAgICBNZW1vcnkuY29weShuZXdNZXRob2QsIG1ldGhvZCwgc3BlYy5tZXRob2Quc2l6ZSk7CiAgICBjb25zdCByZXN1bHQgPSByZWFkSnZtTWV0aG9kKG5ld01ldGhvZCwgbmV3Q29uc3RNZXRob2QsIGNvbnN0TWV0aG9kU2l6ZSk7CiAgICBjb25zdCBvbGRNZXRob2QgPSByZWFkSnZtTWV0aG9kKG1ldGhvZCwgY29uc3RNZXRob2QsIGNvbnN0TWV0aG9kU2l6ZSk7CiAgICByZXN1bHQub2xkTWV0aG9kID0gb2xkTWV0aG9kOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gcmVhZEp2bU1ldGhvZChtZXRob2QsIGNvbnN0TWV0aG9kLCBjb25zdE1ldGhvZFNpemUpIHsKICAgIGNvbnN0IGFwaTIgPSBnZXRBcGkyKCk7CiAgICBjb25zdCBzcGVjID0gZ2V0SnZtTWV0aG9kU3BlYygpOwogICAgY29uc3QgY29uc3RQdHIgPSBtZXRob2QuYWRkKHNwZWMubWV0aG9kLmNvbnN0TWV0aG9kT2Zmc2V0KTsKICAgIGNvbnN0IGRhdGFQdHIgPSBtZXRob2QuYWRkKHNwZWMubWV0aG9kLm1ldGhvZERhdGFPZmZzZXQpOwogICAgY29uc3QgY291bnRlcnNQdHIgPSBtZXRob2QuYWRkKHNwZWMubWV0aG9kLm1ldGhvZENvdW50ZXJzT2Zmc2V0KTsKICAgIGNvbnN0IGFjY2Vzc0ZsYWdzUHRyID0gbWV0aG9kLmFkZChzcGVjLm1ldGhvZC5hY2Nlc3NGbGFnc09mZnNldCk7CiAgICBjb25zdCBhY2Nlc3NGbGFncyA9IGFjY2Vzc0ZsYWdzUHRyLnJlYWRVMzIoKTsKICAgIGNvbnN0IGFkYXB0ZXIgPSBzcGVjLmdldEFkYXB0ZXJQb2ludGVyKG1ldGhvZCwgY29uc3RNZXRob2QpOwogICAgY29uc3QgaTJpRW50cnkgPSBtZXRob2QuYWRkKHNwZWMubWV0aG9kLmkyaUVudHJ5T2Zmc2V0KTsKICAgIGNvbnN0IHNpZ25hdHVyZUhhbmRsZXIgPSBtZXRob2QuYWRkKHNwZWMubWV0aG9kLnNpZ25hdHVyZUhhbmRsZXJPZmZzZXQpOwogICAgY29uc3QgY29uc3RhbnRQb29sID0gY29uc3RNZXRob2QuYWRkKHNwZWMuY29uc3RNZXRob2QuY29uc3RhbnRQb29sT2Zmc2V0KS5yZWFkUG9pbnRlcigpOwogICAgY29uc3Qgc3RhY2ttYXBQdHIgPSBjb25zdE1ldGhvZC5hZGQoc3BlYy5jb25zdE1ldGhvZC5zdGFja21hcERhdGFPZmZzZXQpOwogICAgY29uc3QgaW5zdGFuY2VLbGFzcyA9IGNvbnN0YW50UG9vbC5hZGQoc3BlYy5jb25zdGFudFBvb2wuaW5zdGFuY2VLbGFzc09mZnNldCkucmVhZFBvaW50ZXIoKTsKICAgIGNvbnN0IGNhY2hlID0gY29uc3RhbnRQb29sLmFkZChzcGVjLmNvbnN0YW50UG9vbC5jYWNoZU9mZnNldCkucmVhZFBvaW50ZXIoKTsKICAgIGNvbnN0IGluc3RhbmNlS2xhc3NTcGVjID0gZ2V0SnZtSW5zdGFuY2VLbGFzc1NwZWMoKTsKICAgIGNvbnN0IG1ldGhvZHMgPSBpbnN0YW5jZUtsYXNzLmFkZChpbnN0YW5jZUtsYXNzU3BlYy5tZXRob2RzT2Zmc2V0KS5yZWFkUG9pbnRlcigpOwogICAgY29uc3QgbWV0aG9kc0NvdW50ID0gbWV0aG9kcy5yZWFkUzMyKCk7CiAgICBjb25zdCBtZXRob2RzQXJyYXkgPSBtZXRob2RzLmFkZChwb2ludGVyU2l6ZTYpOwogICAgY29uc3QgbWV0aG9kSW5kZXggPSBjb25zdE1ldGhvZC5hZGQoc3BlYy5jb25zdE1ldGhvZC5tZXRob2RJZG51bU9mZnNldCkucmVhZFUxNigpOwogICAgY29uc3QgdnRhYmxlSW5kZXhQdHIgPSBtZXRob2QuYWRkKHNwZWMubWV0aG9kLnZ0YWJsZUluZGV4T2Zmc2V0KTsKICAgIGNvbnN0IHZ0YWJsZUluZGV4ID0gdnRhYmxlSW5kZXhQdHIucmVhZFMzMigpOwogICAgY29uc3QgdnRhYmxlMiA9IGluc3RhbmNlS2xhc3MuYWRkKGluc3RhbmNlS2xhc3NTcGVjLnZ0YWJsZU9mZnNldCk7CiAgICBjb25zdCBvb3BNYXBDYWNoZSA9IGluc3RhbmNlS2xhc3MuYWRkKGluc3RhbmNlS2xhc3NTcGVjLm9vcE1hcENhY2hlT2Zmc2V0KS5yZWFkUG9pbnRlcigpOwogICAgY29uc3QgbWVtYmVyTmFtZXMgPSBhcGkyLnZlcnNpb24gPj0gMTAgPyBpbnN0YW5jZUtsYXNzLmFkZChpbnN0YW5jZUtsYXNzU3BlYy5tZW1iZXJOYW1lc09mZnNldCkucmVhZFBvaW50ZXIoKSA6IE5VTEw7CiAgICByZXR1cm4gewogICAgICBtZXRob2QsCiAgICAgIG1ldGhvZFNpemU6IHNwZWMubWV0aG9kLnNpemUsCiAgICAgIGNvbnN0OiBjb25zdE1ldGhvZCwKICAgICAgY29uc3RTaXplOiBjb25zdE1ldGhvZFNpemUsCiAgICAgIGNvbnN0UHRyLAogICAgICBkYXRhUHRyLAogICAgICBjb3VudGVyc1B0ciwKICAgICAgc3RhY2ttYXBQdHIsCiAgICAgIGluc3RhbmNlS2xhc3MsCiAgICAgIG1ldGhvZHNBcnJheSwKICAgICAgbWV0aG9kc0NvdW50LAogICAgICBtZXRob2RJbmRleCwKICAgICAgdnRhYmxlSW5kZXgsCiAgICAgIHZ0YWJsZUluZGV4UHRyLAogICAgICB2dGFibGU6IHZ0YWJsZTIsCiAgICAgIGFjY2Vzc0ZsYWdzLAogICAgICBhY2Nlc3NGbGFnc1B0ciwKICAgICAgYWRhcHRlciwKICAgICAgaTJpRW50cnksCiAgICAgIHNpZ25hdHVyZUhhbmRsZXIsCiAgICAgIG1lbWJlck5hbWVzLAogICAgICBjYWNoZSwKICAgICAgb29wTWFwQ2FjaGUKICAgIH07CiAgfQogIGZ1bmN0aW9uIHJldmVydEp2bU1ldGhvZChtZXRob2QpIHsKICAgIGNvbnN0IHsgb2xkTWV0aG9kOiBvbGQgfSA9IG1ldGhvZDsKICAgIG9sZC5hY2Nlc3NGbGFnc1B0ci53cml0ZVUzMihvbGQuYWNjZXNzRmxhZ3MpOwogICAgb2xkLnZ0YWJsZUluZGV4UHRyLndyaXRlUzMyKG9sZC52dGFibGVJbmRleCk7CiAgfQogIGZ1bmN0aW9uIF9nZXRKdm1NZXRob2RTcGVjKCkgewogICAgY29uc3QgYXBpMiA9IGdldEFwaTIoKTsKICAgIGNvbnN0IHsgdmVyc2lvbiB9ID0gYXBpMjsKICAgIGxldCBhZGFwdGVySGFuZGxlckxvY2F0aW9uOwogICAgaWYgKHZlcnNpb24gPj0gMTcpIHsKICAgICAgYWRhcHRlckhhbmRsZXJMb2NhdGlvbiA9ICJtZXRob2Q6ZWFybHkiOwogICAgfSBlbHNlIGlmICh2ZXJzaW9uID49IDkgJiYgdmVyc2lvbiA8PSAxNikgewogICAgICBhZGFwdGVySGFuZGxlckxvY2F0aW9uID0gImNvbnN0LW1ldGhvZCI7CiAgICB9IGVsc2UgewogICAgICBhZGFwdGVySGFuZGxlckxvY2F0aW9uID0gIm1ldGhvZDpsYXRlIjsKICAgIH0KICAgIGNvbnN0IGlzTmF0aXZlID0gMTsKICAgIGNvbnN0IG1ldGhvZFNpemUgPSBhcGkyWyJNZXRob2Q6OnNpemUiXShpc05hdGl2ZSkgKiBwb2ludGVyU2l6ZTY7CiAgICBjb25zdCBjb25zdE1ldGhvZE9mZnNldCA9IHBvaW50ZXJTaXplNjsKICAgIGNvbnN0IG1ldGhvZERhdGFPZmZzZXQgPSAyICogcG9pbnRlclNpemU2OwogICAgY29uc3QgbWV0aG9kQ291bnRlcnNPZmZzZXQgPSAzICogcG9pbnRlclNpemU2OwogICAgY29uc3QgYWRhcHRlckluTWV0aG9kRWFybHlPZmZzZXQgPSA0ICogcG9pbnRlclNpemU2OwogICAgY29uc3QgYWRhcHRlckluTWV0aG9kRWFybHlTaXplID0gYWRhcHRlckhhbmRsZXJMb2NhdGlvbiA9PT0gIm1ldGhvZDplYXJseSIgPyBwb2ludGVyU2l6ZTYgOiAwOwogICAgY29uc3QgYWNjZXNzRmxhZ3NPZmZzZXQgPSBhZGFwdGVySW5NZXRob2RFYXJseU9mZnNldCArIGFkYXB0ZXJJbk1ldGhvZEVhcmx5U2l6ZTsKICAgIGNvbnN0IHZ0YWJsZUluZGV4T2Zmc2V0ID0gYWNjZXNzRmxhZ3NPZmZzZXQgKyA0OwogICAgY29uc3QgaTJpRW50cnlPZmZzZXQgPSB2dGFibGVJbmRleE9mZnNldCArIDQgKyA4OwogICAgY29uc3QgYWRhcHRlckluTWV0aG9kTGF0ZU9mZnNldCA9IGkyaUVudHJ5T2Zmc2V0ICsgcG9pbnRlclNpemU2OwogICAgY29uc3QgYWRhcHRlckluTWV0aG9kT2Zmc2V0ID0gYWRhcHRlckluTWV0aG9kRWFybHlTaXplICE9PSAwID8gYWRhcHRlckluTWV0aG9kRWFybHlPZmZzZXQgOiBhZGFwdGVySW5NZXRob2RMYXRlT2Zmc2V0OwogICAgY29uc3QgbmF0aXZlRnVuY3Rpb25PZmZzZXQgPSBtZXRob2RTaXplIC0gMiAqIHBvaW50ZXJTaXplNjsKICAgIGNvbnN0IHNpZ25hdHVyZUhhbmRsZXJPZmZzZXQgPSBtZXRob2RTaXplIC0gcG9pbnRlclNpemU2OwogICAgY29uc3QgY29uc3RhbnRQb29sT2Zmc2V0ID0gODsKICAgIGNvbnN0IHN0YWNrbWFwRGF0YU9mZnNldCA9IGNvbnN0YW50UG9vbE9mZnNldCArIHBvaW50ZXJTaXplNjsKICAgIGNvbnN0IGFkYXB0ZXJJbkNvbnN0TWV0aG9kT2Zmc2V0ID0gc3RhY2ttYXBEYXRhT2Zmc2V0ICsgcG9pbnRlclNpemU2OwogICAgY29uc3QgYWRhcHRlckluQ29uc3RNZXRob2RTaXplID0gYWRhcHRlckhhbmRsZXJMb2NhdGlvbiA9PT0gImNvbnN0LW1ldGhvZCIgPyBwb2ludGVyU2l6ZTYgOiAwOwogICAgY29uc3QgY29uc3RNZXRob2RTaXplT2Zmc2V0ID0gYWRhcHRlckluQ29uc3RNZXRob2RPZmZzZXQgKyBhZGFwdGVySW5Db25zdE1ldGhvZFNpemU7CiAgICBjb25zdCBtZXRob2RJZG51bU9mZnNldCA9IGNvbnN0TWV0aG9kU2l6ZU9mZnNldCArIDE0OwogICAgY29uc3QgY2FjaGVPZmZzZXQgPSAyICogcG9pbnRlclNpemU2OwogICAgY29uc3QgaW5zdGFuY2VLbGFzc09mZnNldCA9IDMgKiBwb2ludGVyU2l6ZTY7CiAgICBjb25zdCBnZXRBZGFwdGVyUG9pbnRlciA9IGFkYXB0ZXJJbkNvbnN0TWV0aG9kU2l6ZSAhPT0gMCA/IGZ1bmN0aW9uKG1ldGhvZCwgY29uc3RNZXRob2QpIHsKICAgICAgcmV0dXJuIGNvbnN0TWV0aG9kLmFkZChhZGFwdGVySW5Db25zdE1ldGhvZE9mZnNldCk7CiAgICB9IDogZnVuY3Rpb24obWV0aG9kLCBjb25zdE1ldGhvZCkgewogICAgICByZXR1cm4gbWV0aG9kLmFkZChhZGFwdGVySW5NZXRob2RPZmZzZXQpOwogICAgfTsKICAgIHJldHVybiB7CiAgICAgIGdldEFkYXB0ZXJQb2ludGVyLAogICAgICBtZXRob2Q6IHsKICAgICAgICBzaXplOiBtZXRob2RTaXplLAogICAgICAgIGNvbnN0TWV0aG9kT2Zmc2V0LAogICAgICAgIG1ldGhvZERhdGFPZmZzZXQsCiAgICAgICAgbWV0aG9kQ291bnRlcnNPZmZzZXQsCiAgICAgICAgYWNjZXNzRmxhZ3NPZmZzZXQsCiAgICAgICAgdnRhYmxlSW5kZXhPZmZzZXQsCiAgICAgICAgaTJpRW50cnlPZmZzZXQsCiAgICAgICAgbmF0aXZlRnVuY3Rpb25PZmZzZXQsCiAgICAgICAgc2lnbmF0dXJlSGFuZGxlck9mZnNldAogICAgICB9LAogICAgICBjb25zdE1ldGhvZDogewogICAgICAgIGNvbnN0YW50UG9vbE9mZnNldCwKICAgICAgICBzdGFja21hcERhdGFPZmZzZXQsCiAgICAgICAgc2l6ZU9mZnNldDogY29uc3RNZXRob2RTaXplT2Zmc2V0LAogICAgICAgIG1ldGhvZElkbnVtT2Zmc2V0CiAgICAgIH0sCiAgICAgIGNvbnN0YW50UG9vbDogewogICAgICAgIGNhY2hlT2Zmc2V0LAogICAgICAgIGluc3RhbmNlS2xhc3NPZmZzZXQKICAgICAgfQogICAgfTsKICB9CiAgdmFyIHZ0YWJsZU9mZnNldFBhcnNlcnMgPSB7CiAgICB4NjQ6IHBhcnNlWDY0VlRhYmxlT2Zmc2V0CiAgfTsKICBmdW5jdGlvbiBfZ2V0SnZtSW5zdGFuY2VLbGFzc1NwZWMoKSB7CiAgICBjb25zdCB7IHZlcnNpb246IGp2bVZlcnNpb24sIGNyZWF0ZU5ld0RlZmF1bHRWdGFibGVJbmRpY2VzIH0gPSBnZXRBcGkyKCk7CiAgICBjb25zdCB0cnlQYXJzZSA9IHZ0YWJsZU9mZnNldFBhcnNlcnNbUHJvY2Vzcy5hcmNoXTsKICAgIGlmICh0cnlQYXJzZSA9PT0gdm9pZCAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyB2dGFibGUgb2Zmc2V0IHBhcnNlciBmb3IgJHtQcm9jZXNzLmFyY2h9YCk7CiAgICB9CiAgICBjb25zdCB2dGFibGVPZmZzZXQgPSBwYXJzZUluc3RydWN0aW9uc0F0KGNyZWF0ZU5ld0RlZmF1bHRWdGFibGVJbmRpY2VzLCB0cnlQYXJzZSwgeyBsaW1pdDogMzIgfSk7CiAgICBpZiAodnRhYmxlT2Zmc2V0ID09PSBudWxsKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGRlZHVjZSB2dGFibGUgb2Zmc2V0Iik7CiAgICB9CiAgICBjb25zdCBvb3BNdWx0aXBsaWVyID0ganZtVmVyc2lvbiA+PSAxMCAmJiBqdm1WZXJzaW9uIDw9IDExIHx8IGp2bVZlcnNpb24gPj0gMTUgPyAxNyA6IDE4OwogICAgY29uc3QgbWV0aG9kc09mZnNldCA9IHZ0YWJsZU9mZnNldCAtIDcgKiBwb2ludGVyU2l6ZTY7CiAgICBjb25zdCBtZW1iZXJOYW1lc09mZnNldCA9IHZ0YWJsZU9mZnNldCAtIDE3ICogcG9pbnRlclNpemU2OwogICAgY29uc3Qgb29wTWFwQ2FjaGVPZmZzZXQgPSB2dGFibGVPZmZzZXQgLSBvb3BNdWx0aXBsaWVyICogcG9pbnRlclNpemU2OwogICAgcmV0dXJuIHsKICAgICAgdnRhYmxlT2Zmc2V0LAogICAgICBtZXRob2RzT2Zmc2V0LAogICAgICBtZW1iZXJOYW1lc09mZnNldCwKICAgICAgb29wTWFwQ2FjaGVPZmZzZXQKICAgIH07CiAgfQogIGZ1bmN0aW9uIHBhcnNlWDY0VlRhYmxlT2Zmc2V0KGluc24pIHsKICAgIGlmIChpbnNuLm1uZW1vbmljICE9PSAibW92IikgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IGRzdCA9IGluc24ub3BlcmFuZHNbMF07CiAgICBpZiAoZHN0LnR5cGUgIT09ICJtZW0iKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3QgeyB2YWx1ZTogZHN0VmFsdWUgfSA9IGRzdDsKICAgIGlmIChkc3RWYWx1ZS5zY2FsZSAhPT0gMSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IHsgZGlzcCB9ID0gZHN0VmFsdWU7CiAgICBpZiAoZGlzcCA8IDI1NikgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IGRlZmF1bHRWdGFibGVJbmRpY2VzT2Zmc2V0ID0gZGlzcDsKICAgIHJldHVybiBkZWZhdWx0VnRhYmxlSW5kaWNlc09mZnNldCArIDE2OwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2ZyaWRhLWphdmEtYnJpZGdlL2xpYi9hcGkuanMKICB2YXIgZ2V0QXBpMyA9IGdldEFwaTsKICB0cnkgewogICAgZ2V0QW5kcm9pZFZlcnNpb24oKTsKICB9IGNhdGNoIChlKSB7CiAgICBnZXRBcGkzID0gZ2V0QXBpMjsKICB9CiAgdmFyIGFwaV9kZWZhdWx0ID0gZ2V0QXBpMzsKCiAgLy8gbm9kZV9tb2R1bGVzL2ZyaWRhLWphdmEtYnJpZGdlL2xpYi9jbGFzcy1tb2RlbC5qcwogIHZhciBjb2RlID0gYCNpbmNsdWRlIDxqc29uLWdsaWIvanNvbi1nbGliLmg+CiNpbmNsdWRlIDxzdHJpbmcuaD4KCiNkZWZpbmUga0FjY1N0YXRpYyAweDAwMDgKI2RlZmluZSBrQWNjQ29uc3RydWN0b3IgMHgwMDAxMDAwMAoKdHlwZWRlZiBzdHJ1Y3QgX01vZGVsIE1vZGVsOwp0eXBlZGVmIHN0cnVjdCBfRW51bWVyYXRlTWV0aG9kc0NvbnRleHQgRW51bWVyYXRlTWV0aG9kc0NvbnRleHQ7Cgp0eXBlZGVmIHN0cnVjdCBfSmF2YUFwaSBKYXZhQXBpOwp0eXBlZGVmIHN0cnVjdCBfSmF2YUNsYXNzQXBpIEphdmFDbGFzc0FwaTsKdHlwZWRlZiBzdHJ1Y3QgX0phdmFNZXRob2RBcGkgSmF2YU1ldGhvZEFwaTsKdHlwZWRlZiBzdHJ1Y3QgX0phdmFGaWVsZEFwaSBKYXZhRmllbGRBcGk7Cgp0eXBlZGVmIHN0cnVjdCBfSk5JRW52IEpOSUVudjsKdHlwZWRlZiBndWludDggamJvb2xlYW47CnR5cGVkZWYgZ2ludDMyIGppbnQ7CnR5cGVkZWYgamludCBqc2l6ZTsKdHlwZWRlZiBncG9pbnRlciBqb2JqZWN0Owp0eXBlZGVmIGpvYmplY3QgamNsYXNzOwp0eXBlZGVmIGpvYmplY3QganN0cmluZzsKdHlwZWRlZiBqb2JqZWN0IGphcnJheTsKdHlwZWRlZiBqYXJyYXkgam9iamVjdEFycmF5Owp0eXBlZGVmIGdwb2ludGVyIGpmaWVsZElEOwp0eXBlZGVmIGdwb2ludGVyIGptZXRob2RJRDsKCnR5cGVkZWYgc3RydWN0IF9qdm10aUVudiBqdm10aUVudjsKdHlwZWRlZiBlbnVtCnsKICBKVk1USV9FUlJPUl9OT05FID0gMAp9IGp2bXRpRXJyb3I7Cgp0eXBlZGVmIHN0cnVjdCBfQXJ0QXBpIEFydEFwaTsKdHlwZWRlZiBndWludDMyIEFydEhlYXBSZWZlcmVuY2U7CnR5cGVkZWYgc3RydWN0IF9BcnRPYmplY3QgQXJ0T2JqZWN0Owp0eXBlZGVmIHN0cnVjdCBfQXJ0Q2xhc3MgQXJ0Q2xhc3M7CnR5cGVkZWYgc3RydWN0IF9BcnRDbGFzc0xpbmtlciBBcnRDbGFzc0xpbmtlcjsKdHlwZWRlZiBzdHJ1Y3QgX0FydENsYXNzVmlzaXRvciBBcnRDbGFzc1Zpc2l0b3I7CnR5cGVkZWYgc3RydWN0IF9BcnRDbGFzc1Zpc2l0b3JWVGFibGUgQXJ0Q2xhc3NWaXNpdG9yVlRhYmxlOwp0eXBlZGVmIHN0cnVjdCBfQXJ0TWV0aG9kIEFydE1ldGhvZDsKdHlwZWRlZiBzdHJ1Y3QgX0FydFN0cmluZyBBcnRTdHJpbmc7Cgp0eXBlZGVmIHVuaW9uIF9TdGRTdHJpbmcgU3RkU3RyaW5nOwp0eXBlZGVmIHN0cnVjdCBfU3RkU3RyaW5nU2hvcnQgU3RkU3RyaW5nU2hvcnQ7CnR5cGVkZWYgc3RydWN0IF9TdGRTdHJpbmdMb25nIFN0ZFN0cmluZ0xvbmc7Cgp0eXBlZGVmIHZvaWQgKCogQXJ0VmlzaXRDbGFzc2VzRnVuYykgKEFydENsYXNzTGlua2VyICogbGlua2VyLCBBcnRDbGFzc1Zpc2l0b3IgKiB2aXNpdG9yKTsKdHlwZWRlZiBjb25zdCBjaGFyICogKCogQXJ0R2V0Q2xhc3NEZXNjcmlwdG9yRnVuYykgKEFydENsYXNzICoga2xhc3MsIFN0ZFN0cmluZyAqIHN0b3JhZ2UpOwp0eXBlZGVmIHZvaWQgKCogQXJ0UHJldHR5TWV0aG9kRnVuYykgKFN0ZFN0cmluZyAqIHJlc3VsdCwgQXJ0TWV0aG9kICogbWV0aG9kLCBqYm9vbGVhbiB3aXRoX3NpZ25hdHVyZSk7CgpzdHJ1Y3QgX01vZGVsCnsKICBHSGFzaFRhYmxlICogbWVtYmVyczsKfTsKCnN0cnVjdCBfRW51bWVyYXRlTWV0aG9kc0NvbnRleHQKewogIEdQYXR0ZXJuU3BlYyAqIGNsYXNzX3F1ZXJ5OwogIEdQYXR0ZXJuU3BlYyAqIG1ldGhvZF9xdWVyeTsKICBqYm9vbGVhbiBpbmNsdWRlX3NpZ25hdHVyZTsKICBqYm9vbGVhbiBpZ25vcmVfY2FzZTsKICBqYm9vbGVhbiBza2lwX3N5c3RlbV9jbGFzc2VzOwogIEdIYXNoVGFibGUgKiBncm91cHM7Cn07CgpzdHJ1Y3QgX0phdmFDbGFzc0FwaQp7CiAgam1ldGhvZElEIGdldF9kZWNsYXJlZF9tZXRob2RzOwogIGptZXRob2RJRCBnZXRfZGVjbGFyZWRfZmllbGRzOwp9OwoKc3RydWN0IF9KYXZhTWV0aG9kQXBpCnsKICBqbWV0aG9kSUQgZ2V0X25hbWU7CiAgam1ldGhvZElEIGdldF9tb2RpZmllcnM7Cn07CgpzdHJ1Y3QgX0phdmFGaWVsZEFwaQp7CiAgam1ldGhvZElEIGdldF9uYW1lOwogIGptZXRob2RJRCBnZXRfbW9kaWZpZXJzOwp9OwoKc3RydWN0IF9KYXZhQXBpCnsKICBKYXZhQ2xhc3NBcGkgY2xheno7CiAgSmF2YU1ldGhvZEFwaSBtZXRob2Q7CiAgSmF2YUZpZWxkQXBpIGZpZWxkOwp9OwoKc3RydWN0IF9KTklFbnYKewogIGdwb2ludGVyICogZnVuY3Rpb25zOwp9OwoKc3RydWN0IF9qdm10aUVudgp7CiAgZ3BvaW50ZXIgKiBmdW5jdGlvbnM7Cn07CgpzdHJ1Y3QgX0FydEFwaQp7CiAgZ2Jvb2xlYW4gYXZhaWxhYmxlOwoKICBndWludCBjbGFzc19vZmZzZXRfaWZpZWxkczsKICBndWludCBjbGFzc19vZmZzZXRfbWV0aG9kczsKICBndWludCBjbGFzc19vZmZzZXRfc2ZpZWxkczsKICBndWludCBjbGFzc19vZmZzZXRfY29waWVkX21ldGhvZHNfb2Zmc2V0OwoKICBndWludCBtZXRob2Rfc2l6ZTsKICBndWludCBtZXRob2Rfb2Zmc2V0X2FjY2Vzc19mbGFnczsKCiAgZ3VpbnQgZmllbGRfc2l6ZTsKICBndWludCBmaWVsZF9vZmZzZXRfYWNjZXNzX2ZsYWdzOwoKICBndWludCBhbGlnbm1lbnRfcGFkZGluZzsKCiAgQXJ0Q2xhc3NMaW5rZXIgKiBsaW5rZXI7CiAgQXJ0VmlzaXRDbGFzc2VzRnVuYyB2aXNpdF9jbGFzc2VzOwogIEFydEdldENsYXNzRGVzY3JpcHRvckZ1bmMgZ2V0X2NsYXNzX2Rlc2NyaXB0b3I7CiAgQXJ0UHJldHR5TWV0aG9kRnVuYyBwcmV0dHlfbWV0aG9kOwoKICB2b2lkICgqIGZyZWUpIChncG9pbnRlciBtZW0pOwp9OwoKc3RydWN0IF9BcnRPYmplY3QKewogIEFydEhlYXBSZWZlcmVuY2Uga2xhc3M7CiAgQXJ0SGVhcFJlZmVyZW5jZSBtb25pdG9yOwp9OwoKc3RydWN0IF9BcnRDbGFzcwp7CiAgQXJ0T2JqZWN0IHBhcmVudDsKCiAgQXJ0SGVhcFJlZmVyZW5jZSBjbGFzc19sb2FkZXI7Cn07CgpzdHJ1Y3QgX0FydENsYXNzVmlzaXRvcgp7CiAgQXJ0Q2xhc3NWaXNpdG9yVlRhYmxlICogdnRhYmxlOwogIGdwb2ludGVyIHVzZXJfZGF0YTsKfTsKCnN0cnVjdCBfQXJ0Q2xhc3NWaXNpdG9yVlRhYmxlCnsKICB2b2lkICgqIHJlc2VydmVkMSkgKEFydENsYXNzVmlzaXRvciAqIHNlbGYpOwogIHZvaWQgKCogcmVzZXJ2ZWQyKSAoQXJ0Q2xhc3NWaXNpdG9yICogc2VsZik7CiAgamJvb2xlYW4gKCogdmlzaXQpIChBcnRDbGFzc1Zpc2l0b3IgKiBzZWxmLCBBcnRDbGFzcyAqIGtsYXNzKTsKfTsKCnN0cnVjdCBfQXJ0U3RyaW5nCnsKICBBcnRPYmplY3QgcGFyZW50OwoKICBnaW50MzIgY291bnQ7CiAgZ3VpbnQzMiBoYXNoX2NvZGU7CgogIHVuaW9uCiAgewogICAgZ3VpbnQxNiB2YWx1ZVswXTsKICAgIGd1aW50OCB2YWx1ZV9jb21wcmVzc2VkWzBdOwogIH07Cn07CgpzdHJ1Y3QgX1N0ZFN0cmluZ1Nob3J0CnsKICBndWludDggc2l6ZTsKICBnY2hhciBkYXRhWygzICogc2l6ZW9mIChncG9pbnRlcikpIC0gc2l6ZW9mIChndWludDgpXTsKfTsKCnN0cnVjdCBfU3RkU3RyaW5nTG9uZwp7CiAgZ3NpemUgY2FwYWNpdHk7CiAgZ3NpemUgc2l6ZTsKICBnY2hhciAqIGRhdGE7Cn07Cgp1bmlvbiBfU3RkU3RyaW5nCnsKICBTdGRTdHJpbmdTaG9ydCBzOwogIFN0ZFN0cmluZ0xvbmcgbDsKfTsKCnN0YXRpYyB2b2lkIG1vZGVsX2FkZF9tZXRob2QgKE1vZGVsICogc2VsZiwgY29uc3QgZ2NoYXIgKiBuYW1lLCBqbWV0aG9kSUQgaWQsIGppbnQgbW9kaWZpZXJzKTsKc3RhdGljIHZvaWQgbW9kZWxfYWRkX2ZpZWxkIChNb2RlbCAqIHNlbGYsIGNvbnN0IGdjaGFyICogbmFtZSwgamZpZWxkSUQgaWQsIGppbnQgbW9kaWZpZXJzKTsKc3RhdGljIHZvaWQgbW9kZWxfZnJlZSAoTW9kZWwgKiBtb2RlbCk7CgpzdGF0aWMgamJvb2xlYW4gY29sbGVjdF9tYXRjaGluZ19jbGFzc19tZXRob2RzIChBcnRDbGFzc1Zpc2l0b3IgKiBzZWxmLCBBcnRDbGFzcyAqIGtsYXNzKTsKc3RhdGljIGdjaGFyICogZmluYWxpemVfbWV0aG9kX2dyb3Vwc190b19qc29uIChHSGFzaFRhYmxlICogZ3JvdXBzKTsKc3RhdGljIEdQYXR0ZXJuU3BlYyAqIG1ha2VfcGF0dGVybl9zcGVjIChjb25zdCBnY2hhciAqIHBhdHRlcm4sIGpib29sZWFuIGlnbm9yZV9jYXNlKTsKc3RhdGljIGdjaGFyICogY2xhc3NfbmFtZV9mcm9tX3NpZ25hdHVyZSAoY29uc3QgZ2NoYXIgKiBzaWduYXR1cmUpOwpzdGF0aWMgZ2NoYXIgKiBmb3JtYXRfbWV0aG9kX3NpZ25hdHVyZSAoY29uc3QgZ2NoYXIgKiBuYW1lLCBjb25zdCBnY2hhciAqIHNpZ25hdHVyZSk7CnN0YXRpYyB2b2lkIGFwcGVuZF90eXBlIChHU3RyaW5nICogb3V0cHV0LCBjb25zdCBnY2hhciAqKiB0eXBlKTsKCnN0YXRpYyBncG9pbnRlciByZWFkX2FydF9hcnJheSAoZ3BvaW50ZXIgb2JqZWN0X2Jhc2UsIGd1aW50IGZpZWxkX29mZnNldCwgZ3VpbnQgbGVuZ3RoX3NpemUsIGd1aW50ICogbGVuZ3RoKTsKCnN0YXRpYyB2b2lkIHN0ZF9zdHJpbmdfZGVzdHJveSAoU3RkU3RyaW5nICogc3RyKTsKc3RhdGljIGdjaGFyICogc3RkX3N0cmluZ19jX3N0ciAoU3RkU3RyaW5nICogc2VsZik7CgpleHRlcm4gR011dGV4IGxvY2s7CmV4dGVybiBHQXJyYXkgKiBtb2RlbHM7CmV4dGVybiBKYXZhQXBpIGphdmFfYXBpOwpleHRlcm4gQXJ0QXBpIGFydF9hcGk7Cgp2b2lkCmluaXQgKHZvaWQpCnsKICBnX211dGV4X2luaXQgKCZsb2NrKTsKICBtb2RlbHMgPSBnX2FycmF5X25ldyAoRkFMU0UsIEZBTFNFLCBzaXplb2YgKE1vZGVsICopKTsKfQoKdm9pZApmaW5hbGl6ZSAodm9pZCkKewogIGd1aW50IG4sIGk7CgogIG4gPSBtb2RlbHMtPmxlbjsKICBmb3IgKGkgPSAwOyBpICE9IG47IGkrKykKICB7CiAgICBNb2RlbCAqIG1vZGVsID0gZ19hcnJheV9pbmRleCAobW9kZWxzLCBNb2RlbCAqLCBpKTsKICAgIG1vZGVsX2ZyZWUgKG1vZGVsKTsKICB9CgogIGdfYXJyYXlfdW5yZWYgKG1vZGVscyk7CiAgZ19tdXRleF9jbGVhciAoJmxvY2spOwp9CgpNb2RlbCAqCm1vZGVsX25ldyAoamNsYXNzIGNsYXNzX2hhbmRsZSwKICAgICAgICAgICBncG9pbnRlciBjbGFzc19vYmplY3QsCiAgICAgICAgICAgSk5JRW52ICogZW52KQp7CiAgTW9kZWwgKiBtb2RlbDsKICBHSGFzaFRhYmxlICogbWVtYmVyczsKICBncG9pbnRlciAqIGZ1bmNzID0gZW52LT5mdW5jdGlvbnM7CiAgam1ldGhvZElEICgqIGZyb21fcmVmbGVjdGVkX21ldGhvZCkgKEpOSUVudiAqLCBqb2JqZWN0KSA9IGZ1bmNzWzddOwogIGpmaWVsZElEICgqIGZyb21fcmVmbGVjdGVkX2ZpZWxkKSAoSk5JRW52ICosIGpvYmplY3QpID0gZnVuY3NbOF07CiAgam9iamVjdCAoKiB0b19yZWZsZWN0ZWRfbWV0aG9kKSAoSk5JRW52ICosIGpjbGFzcywgam1ldGhvZElELCBqYm9vbGVhbikgPSBmdW5jc1s5XTsKICBqb2JqZWN0ICgqIHRvX3JlZmxlY3RlZF9maWVsZCkgKEpOSUVudiAqLCBqY2xhc3MsIGpmaWVsZElELCBqYm9vbGVhbikgPSBmdW5jc1sxMl07CiAgdm9pZCAoKiBkZWxldGVfbG9jYWxfcmVmKSAoSk5JRW52ICosIGpvYmplY3QpID0gZnVuY3NbMjNdOwogIGpvYmplY3QgKCogY2FsbF9vYmplY3RfbWV0aG9kKSAoSk5JRW52ICosIGpvYmplY3QsIGptZXRob2RJRCwgLi4uKSA9IGZ1bmNzWzM0XTsKICBqaW50ICgqIGNhbGxfaW50X21ldGhvZCkgKEpOSUVudiAqLCBqb2JqZWN0LCBqbWV0aG9kSUQsIC4uLikgPSBmdW5jc1s0OV07CiAgY29uc3QgY2hhciAqICgqIGdldF9zdHJpbmdfdXRmX2NoYXJzKSAoSk5JRW52ICosIGpzdHJpbmcsIGpib29sZWFuICopID0gZnVuY3NbMTY5XTsKICB2b2lkICgqIHJlbGVhc2Vfc3RyaW5nX3V0Zl9jaGFycykgKEpOSUVudiAqLCBqc3RyaW5nLCBjb25zdCBjaGFyICopID0gZnVuY3NbMTcwXTsKICBqc2l6ZSAoKiBnZXRfYXJyYXlfbGVuZ3RoKSAoSk5JRW52ICosIGphcnJheSkgPSBmdW5jc1sxNzFdOwogIGpvYmplY3QgKCogZ2V0X29iamVjdF9hcnJheV9lbGVtZW50KSAoSk5JRW52ICosIGpvYmplY3RBcnJheSwganNpemUpID0gZnVuY3NbMTczXTsKICBqc2l6ZSBuLCBpOwoKICBtb2RlbCA9IGdfbmV3IChNb2RlbCwgMSk7CgogIG1lbWJlcnMgPSBnX2hhc2hfdGFibGVfbmV3X2Z1bGwgKGdfc3RyX2hhc2gsIGdfc3RyX2VxdWFsLCBnX2ZyZWUsIGdfZnJlZSk7CiAgbW9kZWwtPm1lbWJlcnMgPSBtZW1iZXJzOwoKICBpZiAoYXJ0X2FwaS5hdmFpbGFibGUpCiAgewogICAgZ3BvaW50ZXIgZWxlbWVudHM7CiAgICBndWludCBuLCBpOwogICAgY29uc3QgZ3VpbnQgZmllbGRfYXJyYXlzW10gPSB7CiAgICAgIGFydF9hcGkuY2xhc3Nfb2Zmc2V0X2lmaWVsZHMsCiAgICAgIGFydF9hcGkuY2xhc3Nfb2Zmc2V0X3NmaWVsZHMKICAgIH07CiAgICBndWludCBmaWVsZF9hcnJheV9jdXJzb3I7CiAgICBnYm9vbGVhbiBtZXJnZWRfZmllbGRzID0gYXJ0X2FwaS5jbGFzc19vZmZzZXRfc2ZpZWxkcyA9PSAwOwoKICAgIGVsZW1lbnRzID0gcmVhZF9hcnRfYXJyYXkgKGNsYXNzX29iamVjdCwgYXJ0X2FwaS5jbGFzc19vZmZzZXRfbWV0aG9kcywgc2l6ZW9mIChnc2l6ZSksIE5VTEwpOwogICAgbiA9ICooZ3VpbnQxNiAqKSAoY2xhc3Nfb2JqZWN0ICsgYXJ0X2FwaS5jbGFzc19vZmZzZXRfY29waWVkX21ldGhvZHNfb2Zmc2V0KTsKICAgIGZvciAoaSA9IDA7IGkgIT0gbjsgaSsrKQogICAgewogICAgICBqbWV0aG9kSUQgaWQ7CiAgICAgIGd1aW50MzIgYWNjZXNzX2ZsYWdzOwogICAgICBqYm9vbGVhbiBpc19zdGF0aWM7CiAgICAgIGpvYmplY3QgbWV0aG9kLCBuYW1lOwogICAgICBjb25zdCBjaGFyICogbmFtZV9zdHI7CiAgICAgIGppbnQgbW9kaWZpZXJzOwoKICAgICAgaWQgPSBlbGVtZW50cyArIChpICogYXJ0X2FwaS5tZXRob2Rfc2l6ZSk7CgogICAgICBhY2Nlc3NfZmxhZ3MgPSAqKGd1aW50MzIgKikgKGlkICsgYXJ0X2FwaS5tZXRob2Rfb2Zmc2V0X2FjY2Vzc19mbGFncyk7CiAgICAgIGlmICgoYWNjZXNzX2ZsYWdzICYga0FjY0NvbnN0cnVjdG9yKSAhPSAwKQogICAgICAgIGNvbnRpbnVlOwogICAgICBpc19zdGF0aWMgPSAoYWNjZXNzX2ZsYWdzICYga0FjY1N0YXRpYykgIT0gMDsKICAgICAgbWV0aG9kID0gdG9fcmVmbGVjdGVkX21ldGhvZCAoZW52LCBjbGFzc19oYW5kbGUsIGlkLCBpc19zdGF0aWMpOwogICAgICBuYW1lID0gY2FsbF9vYmplY3RfbWV0aG9kIChlbnYsIG1ldGhvZCwgamF2YV9hcGkubWV0aG9kLmdldF9uYW1lKTsKICAgICAgbmFtZV9zdHIgPSBnZXRfc3RyaW5nX3V0Zl9jaGFycyAoZW52LCBuYW1lLCBOVUxMKTsKICAgICAgbW9kaWZpZXJzID0gYWNjZXNzX2ZsYWdzICYgMHhmZmZmOwoKICAgICAgbW9kZWxfYWRkX21ldGhvZCAobW9kZWwsIG5hbWVfc3RyLCBpZCwgbW9kaWZpZXJzKTsKCiAgICAgIHJlbGVhc2Vfc3RyaW5nX3V0Zl9jaGFycyAoZW52LCBuYW1lLCBuYW1lX3N0cik7CiAgICAgIGRlbGV0ZV9sb2NhbF9yZWYgKGVudiwgbmFtZSk7CiAgICAgIGRlbGV0ZV9sb2NhbF9yZWYgKGVudiwgbWV0aG9kKTsKICAgIH0KCiAgICBmb3IgKGZpZWxkX2FycmF5X2N1cnNvciA9IDA7IGZpZWxkX2FycmF5X2N1cnNvciAhPSBHX05fRUxFTUVOVFMgKGZpZWxkX2FycmF5cyk7IGZpZWxkX2FycmF5X2N1cnNvcisrKQogICAgewogICAgICBqYm9vbGVhbiBpc19zdGF0aWM7CgogICAgICBpZiAoZmllbGRfYXJyYXlzW2ZpZWxkX2FycmF5X2N1cnNvcl0gPT0gMCkKICAgICAgICBjb250aW51ZTsKCiAgICAgIGlmICghbWVyZ2VkX2ZpZWxkcykKICAgICAgICBpc19zdGF0aWMgPSBmaWVsZF9hcnJheV9jdXJzb3IgPT0gMTsKCiAgICAgIGVsZW1lbnRzID0gcmVhZF9hcnRfYXJyYXkgKGNsYXNzX29iamVjdCwgZmllbGRfYXJyYXlzW2ZpZWxkX2FycmF5X2N1cnNvcl0sIHNpemVvZiAoZ3VpbnQzMiksICZuKTsKICAgICAgZm9yIChpID0gMDsgaSAhPSBuOyBpKyspCiAgICAgIHsKICAgICAgICBqZmllbGRJRCBpZDsKICAgICAgICBndWludDMyIGFjY2Vzc19mbGFnczsKICAgICAgICBqb2JqZWN0IGZpZWxkLCBuYW1lOwogICAgICAgIGNvbnN0IGNoYXIgKiBuYW1lX3N0cjsKICAgICAgICBqaW50IG1vZGlmaWVyczsKCiAgICAgICAgaWQgPSBlbGVtZW50cyArIChpICogYXJ0X2FwaS5maWVsZF9zaXplKTsKCiAgICAgICAgYWNjZXNzX2ZsYWdzID0gKihndWludDMyICopIChpZCArIGFydF9hcGkuZmllbGRfb2Zmc2V0X2FjY2Vzc19mbGFncyk7CiAgICAgICAgaWYgKG1lcmdlZF9maWVsZHMpCiAgICAgICAgICBpc19zdGF0aWMgPSAoYWNjZXNzX2ZsYWdzICYga0FjY1N0YXRpYykgIT0gMDsKICAgICAgICBmaWVsZCA9IHRvX3JlZmxlY3RlZF9maWVsZCAoZW52LCBjbGFzc19oYW5kbGUsIGlkLCBpc19zdGF0aWMpOwogICAgICAgIG5hbWUgPSBjYWxsX29iamVjdF9tZXRob2QgKGVudiwgZmllbGQsIGphdmFfYXBpLmZpZWxkLmdldF9uYW1lKTsKICAgICAgICBuYW1lX3N0ciA9IGdldF9zdHJpbmdfdXRmX2NoYXJzIChlbnYsIG5hbWUsIE5VTEwpOwogICAgICAgIG1vZGlmaWVycyA9IGFjY2Vzc19mbGFncyAmIDB4ZmZmZjsKCiAgICAgICAgbW9kZWxfYWRkX2ZpZWxkIChtb2RlbCwgbmFtZV9zdHIsIGlkLCBtb2RpZmllcnMpOwoKICAgICAgICByZWxlYXNlX3N0cmluZ191dGZfY2hhcnMgKGVudiwgbmFtZSwgbmFtZV9zdHIpOwogICAgICAgIGRlbGV0ZV9sb2NhbF9yZWYgKGVudiwgbmFtZSk7CiAgICAgICAgZGVsZXRlX2xvY2FsX3JlZiAoZW52LCBmaWVsZCk7CiAgICAgIH0KICAgIH0KICB9CiAgZWxzZQogIHsKICAgIGpvYmplY3QgZWxlbWVudHM7CgogICAgZWxlbWVudHMgPSBjYWxsX29iamVjdF9tZXRob2QgKGVudiwgY2xhc3NfaGFuZGxlLCBqYXZhX2FwaS5jbGF6ei5nZXRfZGVjbGFyZWRfbWV0aG9kcyk7CiAgICBuID0gZ2V0X2FycmF5X2xlbmd0aCAoZW52LCBlbGVtZW50cyk7CiAgICBmb3IgKGkgPSAwOyBpICE9IG47IGkrKykKICAgIHsKICAgICAgam9iamVjdCBtZXRob2QsIG5hbWU7CiAgICAgIGNvbnN0IGNoYXIgKiBuYW1lX3N0cjsKICAgICAgam1ldGhvZElEIGlkOwogICAgICBqaW50IG1vZGlmaWVyczsKCiAgICAgIG1ldGhvZCA9IGdldF9vYmplY3RfYXJyYXlfZWxlbWVudCAoZW52LCBlbGVtZW50cywgaSk7CiAgICAgIG5hbWUgPSBjYWxsX29iamVjdF9tZXRob2QgKGVudiwgbWV0aG9kLCBqYXZhX2FwaS5tZXRob2QuZ2V0X25hbWUpOwogICAgICBuYW1lX3N0ciA9IGdldF9zdHJpbmdfdXRmX2NoYXJzIChlbnYsIG5hbWUsIE5VTEwpOwogICAgICBpZCA9IGZyb21fcmVmbGVjdGVkX21ldGhvZCAoZW52LCBtZXRob2QpOwogICAgICBtb2RpZmllcnMgPSBjYWxsX2ludF9tZXRob2QgKGVudiwgbWV0aG9kLCBqYXZhX2FwaS5tZXRob2QuZ2V0X21vZGlmaWVycyk7CgogICAgICBtb2RlbF9hZGRfbWV0aG9kIChtb2RlbCwgbmFtZV9zdHIsIGlkLCBtb2RpZmllcnMpOwoKICAgICAgcmVsZWFzZV9zdHJpbmdfdXRmX2NoYXJzIChlbnYsIG5hbWUsIG5hbWVfc3RyKTsKICAgICAgZGVsZXRlX2xvY2FsX3JlZiAoZW52LCBuYW1lKTsKICAgICAgZGVsZXRlX2xvY2FsX3JlZiAoZW52LCBtZXRob2QpOwogICAgfQogICAgZGVsZXRlX2xvY2FsX3JlZiAoZW52LCBlbGVtZW50cyk7CgogICAgZWxlbWVudHMgPSBjYWxsX29iamVjdF9tZXRob2QgKGVudiwgY2xhc3NfaGFuZGxlLCBqYXZhX2FwaS5jbGF6ei5nZXRfZGVjbGFyZWRfZmllbGRzKTsKICAgIG4gPSBnZXRfYXJyYXlfbGVuZ3RoIChlbnYsIGVsZW1lbnRzKTsKICAgIGZvciAoaSA9IDA7IGkgIT0gbjsgaSsrKQogICAgewogICAgICBqb2JqZWN0IGZpZWxkLCBuYW1lOwogICAgICBjb25zdCBjaGFyICogbmFtZV9zdHI7CiAgICAgIGpmaWVsZElEIGlkOwogICAgICBqaW50IG1vZGlmaWVyczsKCiAgICAgIGZpZWxkID0gZ2V0X29iamVjdF9hcnJheV9lbGVtZW50IChlbnYsIGVsZW1lbnRzLCBpKTsKICAgICAgbmFtZSA9IGNhbGxfb2JqZWN0X21ldGhvZCAoZW52LCBmaWVsZCwgamF2YV9hcGkuZmllbGQuZ2V0X25hbWUpOwogICAgICBuYW1lX3N0ciA9IGdldF9zdHJpbmdfdXRmX2NoYXJzIChlbnYsIG5hbWUsIE5VTEwpOwogICAgICBpZCA9IGZyb21fcmVmbGVjdGVkX2ZpZWxkIChlbnYsIGZpZWxkKTsKICAgICAgbW9kaWZpZXJzID0gY2FsbF9pbnRfbWV0aG9kIChlbnYsIGZpZWxkLCBqYXZhX2FwaS5maWVsZC5nZXRfbW9kaWZpZXJzKTsKCiAgICAgIG1vZGVsX2FkZF9maWVsZCAobW9kZWwsIG5hbWVfc3RyLCBpZCwgbW9kaWZpZXJzKTsKCiAgICAgIHJlbGVhc2Vfc3RyaW5nX3V0Zl9jaGFycyAoZW52LCBuYW1lLCBuYW1lX3N0cik7CiAgICAgIGRlbGV0ZV9sb2NhbF9yZWYgKGVudiwgbmFtZSk7CiAgICAgIGRlbGV0ZV9sb2NhbF9yZWYgKGVudiwgZmllbGQpOwogICAgfQogICAgZGVsZXRlX2xvY2FsX3JlZiAoZW52LCBlbGVtZW50cyk7CiAgfQoKICBnX211dGV4X2xvY2sgKCZsb2NrKTsKICBnX2FycmF5X2FwcGVuZF92YWwgKG1vZGVscywgbW9kZWwpOwogIGdfbXV0ZXhfdW5sb2NrICgmbG9jayk7CgogIHJldHVybiBtb2RlbDsKfQoKc3RhdGljIHZvaWQKbW9kZWxfYWRkX21ldGhvZCAoTW9kZWwgKiBzZWxmLAogICAgICAgICAgICAgICAgICBjb25zdCBnY2hhciAqIG5hbWUsCiAgICAgICAgICAgICAgICAgIGptZXRob2RJRCBpZCwKICAgICAgICAgICAgICAgICAgamludCBtb2RpZmllcnMpCnsKICBHSGFzaFRhYmxlICogbWVtYmVycyA9IHNlbGYtPm1lbWJlcnM7CiAgZ2NoYXIgKiBrZXksIHR5cGU7CiAgY29uc3QgZ2NoYXIgKiB2YWx1ZTsKCiAgaWYgKG5hbWVbMF0gPT0gJyQnKQogICAga2V5ID0gZ19zdHJkdXBfcHJpbnRmICgiXyVzIiwgbmFtZSk7CiAgZWxzZQogICAga2V5ID0gZ19zdHJkdXAgKG5hbWUpOwoKICB0eXBlID0gKG1vZGlmaWVycyAmIGtBY2NTdGF0aWMpICE9IDAgPyAncycgOiAnaSc7CgogIHZhbHVlID0gZ19oYXNoX3RhYmxlX2xvb2t1cCAobWVtYmVycywga2V5KTsKICBpZiAodmFsdWUgPT0gTlVMTCkKICAgIGdfaGFzaF90YWJsZV9pbnNlcnQgKG1lbWJlcnMsIGtleSwgZ19zdHJkdXBfcHJpbnRmICgibTolYzB4JXp4IiwgdHlwZSwgaWQpKTsKICBlbHNlCiAgICBnX2hhc2hfdGFibGVfaW5zZXJ0IChtZW1iZXJzLCBrZXksIGdfc3RyZHVwX3ByaW50ZiAoIiVzOiVjMHglengiLCB2YWx1ZSwgdHlwZSwgaWQpKTsKfQoKc3RhdGljIHZvaWQKbW9kZWxfYWRkX2ZpZWxkIChNb2RlbCAqIHNlbGYsCiAgICAgICAgICAgICAgICAgY29uc3QgZ2NoYXIgKiBuYW1lLAogICAgICAgICAgICAgICAgIGpmaWVsZElEIGlkLAogICAgICAgICAgICAgICAgIGppbnQgbW9kaWZpZXJzKQp7CiAgR0hhc2hUYWJsZSAqIG1lbWJlcnMgPSBzZWxmLT5tZW1iZXJzOwogIGdjaGFyICoga2V5LCB0eXBlOwoKICBpZiAobmFtZVswXSA9PSAnJCcpCiAgICBrZXkgPSBnX3N0cmR1cF9wcmludGYgKCJfJXMiLCBuYW1lKTsKICBlbHNlCiAgICBrZXkgPSBnX3N0cmR1cCAobmFtZSk7CiAgd2hpbGUgKGdfaGFzaF90YWJsZV9jb250YWlucyAobWVtYmVycywga2V5KSkKICB7CiAgICBnY2hhciAqIG5ld19rZXkgPSBnX3N0cmR1cF9wcmludGYgKCJfJXMiLCBrZXkpOwogICAgZ19mcmVlIChrZXkpOwogICAga2V5ID0gbmV3X2tleTsKICB9CgogIHR5cGUgPSAobW9kaWZpZXJzICYga0FjY1N0YXRpYykgIT0gMCA/ICdzJyA6ICdpJzsKCiAgZ19oYXNoX3RhYmxlX2luc2VydCAobWVtYmVycywga2V5LCBnX3N0cmR1cF9wcmludGYgKCJmOiVjMHglengiLCB0eXBlLCBpZCkpOwp9CgpzdGF0aWMgdm9pZAptb2RlbF9mcmVlIChNb2RlbCAqIG1vZGVsKQp7CiAgZ19oYXNoX3RhYmxlX3VucmVmIChtb2RlbC0+bWVtYmVycyk7CgogIGdfZnJlZSAobW9kZWwpOwp9CgpnYm9vbGVhbgptb2RlbF9oYXMgKE1vZGVsICogc2VsZiwKICAgICAgICAgICBjb25zdCBnY2hhciAqIG1lbWJlcikKewogIHJldHVybiBnX2hhc2hfdGFibGVfY29udGFpbnMgKHNlbGYtPm1lbWJlcnMsIG1lbWJlcik7Cn0KCmNvbnN0IGdjaGFyICoKbW9kZWxfZmluZCAoTW9kZWwgKiBzZWxmLAogICAgICAgICAgICBjb25zdCBnY2hhciAqIG1lbWJlcikKewogIHJldHVybiBnX2hhc2hfdGFibGVfbG9va3VwIChzZWxmLT5tZW1iZXJzLCBtZW1iZXIpOwp9CgpnY2hhciAqCm1vZGVsX2xpc3QgKE1vZGVsICogc2VsZikKewogIEdTdHJpbmcgKiByZXN1bHQ7CiAgR0hhc2hUYWJsZUl0ZXIgaXRlcjsKICBndWludCBpOwogIGNvbnN0IGdjaGFyICogbmFtZTsKCiAgcmVzdWx0ID0gZ19zdHJpbmdfc2l6ZWRfbmV3ICgxMjgpOwoKICBnX3N0cmluZ19hcHBlbmRfYyAocmVzdWx0LCAnWycpOwoKICBnX2hhc2hfdGFibGVfaXRlcl9pbml0ICgmaXRlciwgc2VsZi0+bWVtYmVycyk7CiAgZm9yIChpID0gMDsgZ19oYXNoX3RhYmxlX2l0ZXJfbmV4dCAoJml0ZXIsIChncG9pbnRlciAqKSAmbmFtZSwgTlVMTCk7IGkrKykKICB7CiAgICBpZiAoaSA+IDApCiAgICAgIGdfc3RyaW5nX2FwcGVuZF9jIChyZXN1bHQsICcsJyk7CgogICAgZ19zdHJpbmdfYXBwZW5kX2MgKHJlc3VsdCwgJyInKTsKICAgIGdfc3RyaW5nX2FwcGVuZCAocmVzdWx0LCBuYW1lKTsKICAgIGdfc3RyaW5nX2FwcGVuZF9jIChyZXN1bHQsICciJyk7CiAgfQoKICBnX3N0cmluZ19hcHBlbmRfYyAocmVzdWx0LCAnXScpOwoKICByZXR1cm4gZ19zdHJpbmdfZnJlZSAocmVzdWx0LCBGQUxTRSk7Cn0KCmdjaGFyICoKZW51bWVyYXRlX21ldGhvZHNfYXJ0IChjb25zdCBnY2hhciAqIGNsYXNzX3F1ZXJ5LAogICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGdjaGFyICogbWV0aG9kX3F1ZXJ5LAogICAgICAgICAgICAgICAgICAgICAgIGpib29sZWFuIGluY2x1ZGVfc2lnbmF0dXJlLAogICAgICAgICAgICAgICAgICAgICAgIGpib29sZWFuIGlnbm9yZV9jYXNlLAogICAgICAgICAgICAgICAgICAgICAgIGpib29sZWFuIHNraXBfc3lzdGVtX2NsYXNzZXMpCnsKICBnY2hhciAqIHJlc3VsdDsKICBFbnVtZXJhdGVNZXRob2RzQ29udGV4dCBjdHg7CiAgQXJ0Q2xhc3NWaXNpdG9yIHZpc2l0b3I7CiAgQXJ0Q2xhc3NWaXNpdG9yVlRhYmxlIHZpc2l0b3JfdnRhYmxlID0geyBOVUxMLCB9OwoKICBjdHguY2xhc3NfcXVlcnkgPSBtYWtlX3BhdHRlcm5fc3BlYyAoY2xhc3NfcXVlcnksIGlnbm9yZV9jYXNlKTsKICBjdHgubWV0aG9kX3F1ZXJ5ID0gbWFrZV9wYXR0ZXJuX3NwZWMgKG1ldGhvZF9xdWVyeSwgaWdub3JlX2Nhc2UpOwogIGN0eC5pbmNsdWRlX3NpZ25hdHVyZSA9IGluY2x1ZGVfc2lnbmF0dXJlOwogIGN0eC5pZ25vcmVfY2FzZSA9IGlnbm9yZV9jYXNlOwogIGN0eC5za2lwX3N5c3RlbV9jbGFzc2VzID0gc2tpcF9zeXN0ZW1fY2xhc3NlczsKICBjdHguZ3JvdXBzID0gZ19oYXNoX3RhYmxlX25ld19mdWxsIChOVUxMLCBOVUxMLCBOVUxMLCBOVUxMKTsKCiAgdmlzaXRvci52dGFibGUgPSAmdmlzaXRvcl92dGFibGU7CiAgdmlzaXRvci51c2VyX2RhdGEgPSAmY3R4OwoKICB2aXNpdG9yX3Z0YWJsZS52aXNpdCA9IGNvbGxlY3RfbWF0Y2hpbmdfY2xhc3NfbWV0aG9kczsKCiAgYXJ0X2FwaS52aXNpdF9jbGFzc2VzIChhcnRfYXBpLmxpbmtlciwgJnZpc2l0b3IpOwoKICByZXN1bHQgPSBmaW5hbGl6ZV9tZXRob2RfZ3JvdXBzX3RvX2pzb24gKGN0eC5ncm91cHMpOwoKICBnX2hhc2hfdGFibGVfdW5yZWYgKGN0eC5ncm91cHMpOwogIGdfcGF0dGVybl9zcGVjX2ZyZWUgKGN0eC5tZXRob2RfcXVlcnkpOwogIGdfcGF0dGVybl9zcGVjX2ZyZWUgKGN0eC5jbGFzc19xdWVyeSk7CgogIHJldHVybiByZXN1bHQ7Cn0KCnN0YXRpYyBqYm9vbGVhbgpjb2xsZWN0X21hdGNoaW5nX2NsYXNzX21ldGhvZHMgKEFydENsYXNzVmlzaXRvciAqIHNlbGYsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQXJ0Q2xhc3MgKiBrbGFzcykKewogIEVudW1lcmF0ZU1ldGhvZHNDb250ZXh0ICogY3R4ID0gc2VsZi0+dXNlcl9kYXRhOwogIGNvbnN0IGNoYXIgKiBkZXNjcmlwdG9yOwogIFN0ZFN0cmluZyBkZXNjcmlwdG9yX3N0b3JhZ2UgPSB7IDAsIH07CiAgZ2NoYXIgKiBjbGFzc19uYW1lID0gTlVMTDsKICBnY2hhciAqIGNsYXNzX25hbWVfY29weSA9IE5VTEw7CiAgY29uc3QgZ2NoYXIgKiBub3JtYWxpemVkX2NsYXNzX25hbWU7CiAgSnNvbkJ1aWxkZXIgKiBncm91cDsKICBzaXplX3QgY2xhc3NfbmFtZV9sZW5ndGg7CiAgR0hhc2hUYWJsZSAqIHNlZW5fbWV0aG9kX25hbWVzOwogIGdwb2ludGVyIGVsZW1lbnRzOwogIGd1aW50IG4sIGk7CgogIGlmIChjdHgtPnNraXBfc3lzdGVtX2NsYXNzZXMgJiYga2xhc3MtPmNsYXNzX2xvYWRlciA9PSAwKQogICAgZ290byBza2lwX2NsYXNzOwoKICBkZXNjcmlwdG9yID0gYXJ0X2FwaS5nZXRfY2xhc3NfZGVzY3JpcHRvciAoa2xhc3MsICZkZXNjcmlwdG9yX3N0b3JhZ2UpOwogIGlmIChkZXNjcmlwdG9yWzBdICE9ICdMJykKICAgIGdvdG8gc2tpcF9jbGFzczsKCiAgY2xhc3NfbmFtZSA9IGNsYXNzX25hbWVfZnJvbV9zaWduYXR1cmUgKGRlc2NyaXB0b3IpOwoKICBpZiAoY3R4LT5pZ25vcmVfY2FzZSkKICB7CiAgICBjbGFzc19uYW1lX2NvcHkgPSBnX3V0Zjhfc3RyZG93biAoY2xhc3NfbmFtZSwgLTEpOwogICAgbm9ybWFsaXplZF9jbGFzc19uYW1lID0gY2xhc3NfbmFtZV9jb3B5OwogIH0KICBlbHNlCiAgewogICAgbm9ybWFsaXplZF9jbGFzc19uYW1lID0gY2xhc3NfbmFtZTsKICB9CgogIGlmICghZ19wYXR0ZXJuX21hdGNoX3N0cmluZyAoY3R4LT5jbGFzc19xdWVyeSwgbm9ybWFsaXplZF9jbGFzc19uYW1lKSkKICAgIGdvdG8gc2tpcF9jbGFzczsKCiAgZ3JvdXAgPSBOVUxMOwogIGNsYXNzX25hbWVfbGVuZ3RoID0gc3RybGVuIChjbGFzc19uYW1lKTsKICBzZWVuX21ldGhvZF9uYW1lcyA9IGN0eC0+aW5jbHVkZV9zaWduYXR1cmUgPyBOVUxMIDogZ19oYXNoX3RhYmxlX25ld19mdWxsIChnX3N0cl9oYXNoLCBnX3N0cl9lcXVhbCwgZ19mcmVlLCBOVUxMKTsKCiAgZWxlbWVudHMgPSByZWFkX2FydF9hcnJheSAoa2xhc3MsIGFydF9hcGkuY2xhc3Nfb2Zmc2V0X21ldGhvZHMsIHNpemVvZiAoZ3NpemUpLCBOVUxMKTsKICBuID0gKihndWludDE2ICopICgoZ3BvaW50ZXIpIGtsYXNzICsgYXJ0X2FwaS5jbGFzc19vZmZzZXRfY29waWVkX21ldGhvZHNfb2Zmc2V0KTsKICBmb3IgKGkgPSAwOyBpICE9IG47IGkrKykKICB7CiAgICBBcnRNZXRob2QgKiBtZXRob2Q7CiAgICBndWludDMyIGFjY2Vzc19mbGFnczsKICAgIGpib29sZWFuIGlzX2NvbnN0cnVjdG9yOwogICAgU3RkU3RyaW5nIG1ldGhvZF9uYW1lID0geyAwLCB9OwogICAgY29uc3QgZ2NoYXIgKiBiYXJlX21ldGhvZF9uYW1lOwogICAgZ2NoYXIgKiBiYXJlX21ldGhvZF9uYW1lX2NvcHkgPSBOVUxMOwogICAgY29uc3QgZ2NoYXIgKiBub3JtYWxpemVkX21ldGhvZF9uYW1lOwogICAgZ2NoYXIgKiBub3JtYWxpemVkX21ldGhvZF9uYW1lX2NvcHkgPSBOVUxMOwoKICAgIG1ldGhvZCA9IGVsZW1lbnRzICsgKGkgKiBhcnRfYXBpLm1ldGhvZF9zaXplKTsKCiAgICBhY2Nlc3NfZmxhZ3MgPSAqKGd1aW50MzIgKikgKChncG9pbnRlcikgbWV0aG9kICsgYXJ0X2FwaS5tZXRob2Rfb2Zmc2V0X2FjY2Vzc19mbGFncyk7CiAgICBpc19jb25zdHJ1Y3RvciA9IChhY2Nlc3NfZmxhZ3MgJiBrQWNjQ29uc3RydWN0b3IpICE9IDA7CgogICAgYXJ0X2FwaS5wcmV0dHlfbWV0aG9kICgmbWV0aG9kX25hbWUsIG1ldGhvZCwgY3R4LT5pbmNsdWRlX3NpZ25hdHVyZSk7CiAgICBiYXJlX21ldGhvZF9uYW1lID0gc3RkX3N0cmluZ19jX3N0ciAoJm1ldGhvZF9uYW1lKTsKICAgIGlmIChjdHgtPmluY2x1ZGVfc2lnbmF0dXJlKQogICAgewogICAgICBjb25zdCBnY2hhciAqIHJldHVybl90eXBlX2VuZCwgKiBuYW1lX2JlZ2luOwogICAgICBHU3RyaW5nICogbmFtZTsKCiAgICAgIHJldHVybl90eXBlX2VuZCA9IHN0cmNociAoYmFyZV9tZXRob2RfbmFtZSwgJyAnKTsKICAgICAgbmFtZV9iZWdpbiA9IHJldHVybl90eXBlX2VuZCArIDEgKyBjbGFzc19uYW1lX2xlbmd0aCArIDE7CiAgICAgIGlmIChpc19jb25zdHJ1Y3RvciAmJiBnX3N0cl9oYXNfcHJlZml4IChuYW1lX2JlZ2luLCAiPGNsaW5pdD4iKSkKICAgICAgICBnb3RvIHNraXBfbWV0aG9kOwoKICAgICAgbmFtZSA9IGdfc3RyaW5nX3NpemVkX25ldyAoNjQpOwoKICAgICAgaWYgKGlzX2NvbnN0cnVjdG9yKQogICAgICB7CiAgICAgICAgZ19zdHJpbmdfYXBwZW5kIChuYW1lLCAiJGluaXQiKTsKICAgICAgICBnX3N0cmluZ19hcHBlbmQgKG5hbWUsIHN0cmNociAobmFtZV9iZWdpbiwgJz4nKSArIDEpOwogICAgICB9CiAgICAgIGVsc2UKICAgICAgewogICAgICAgIGdfc3RyaW5nX2FwcGVuZCAobmFtZSwgbmFtZV9iZWdpbik7CiAgICAgIH0KICAgICAgZ19zdHJpbmdfYXBwZW5kIChuYW1lLCAiOiAiKTsKICAgICAgZ19zdHJpbmdfYXBwZW5kX2xlbiAobmFtZSwgYmFyZV9tZXRob2RfbmFtZSwgcmV0dXJuX3R5cGVfZW5kIC0gYmFyZV9tZXRob2RfbmFtZSk7CgogICAgICBiYXJlX21ldGhvZF9uYW1lX2NvcHkgPSBnX3N0cmluZ19mcmVlIChuYW1lLCBGQUxTRSk7CiAgICAgIGJhcmVfbWV0aG9kX25hbWUgPSBiYXJlX21ldGhvZF9uYW1lX2NvcHk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgIGNvbnN0IGdjaGFyICogbmFtZV9iZWdpbjsKCiAgICAgIG5hbWVfYmVnaW4gPSBiYXJlX21ldGhvZF9uYW1lICsgY2xhc3NfbmFtZV9sZW5ndGggKyAxOwogICAgICBpZiAoaXNfY29uc3RydWN0b3IgJiYgc3RyY21wIChuYW1lX2JlZ2luLCAiPGNsaW5pdD4iKSA9PSAwKQogICAgICAgIGdvdG8gc2tpcF9tZXRob2Q7CgogICAgICBpZiAoaXNfY29uc3RydWN0b3IpCiAgICAgICAgYmFyZV9tZXRob2RfbmFtZSA9ICIkaW5pdCI7CiAgICAgIGVsc2UKICAgICAgICBiYXJlX21ldGhvZF9uYW1lICs9IGNsYXNzX25hbWVfbGVuZ3RoICsgMTsKICAgIH0KCiAgICBpZiAoc2Vlbl9tZXRob2RfbmFtZXMgIT0gTlVMTCAmJiBnX2hhc2hfdGFibGVfY29udGFpbnMgKHNlZW5fbWV0aG9kX25hbWVzLCBiYXJlX21ldGhvZF9uYW1lKSkKICAgICAgZ290byBza2lwX21ldGhvZDsKCiAgICBpZiAoY3R4LT5pZ25vcmVfY2FzZSkKICAgIHsKICAgICAgbm9ybWFsaXplZF9tZXRob2RfbmFtZV9jb3B5ID0gZ191dGY4X3N0cmRvd24gKGJhcmVfbWV0aG9kX25hbWUsIC0xKTsKICAgICAgbm9ybWFsaXplZF9tZXRob2RfbmFtZSA9IG5vcm1hbGl6ZWRfbWV0aG9kX25hbWVfY29weTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgbm9ybWFsaXplZF9tZXRob2RfbmFtZSA9IGJhcmVfbWV0aG9kX25hbWU7CiAgICB9CgogICAgaWYgKCFnX3BhdHRlcm5fbWF0Y2hfc3RyaW5nIChjdHgtPm1ldGhvZF9xdWVyeSwgbm9ybWFsaXplZF9tZXRob2RfbmFtZSkpCiAgICAgIGdvdG8gc2tpcF9tZXRob2Q7CgogICAgaWYgKGdyb3VwID09IE5VTEwpCiAgICB7CiAgICAgIGdyb3VwID0gZ19oYXNoX3RhYmxlX2xvb2t1cCAoY3R4LT5ncm91cHMsIEdVSU5UX1RPX1BPSU5URVIgKGtsYXNzLT5jbGFzc19sb2FkZXIpKTsKICAgICAgaWYgKGdyb3VwID09IE5VTEwpCiAgICAgIHsKICAgICAgICBncm91cCA9IGpzb25fYnVpbGRlcl9uZXdfaW1tdXRhYmxlICgpOwogICAgICAgIGdfaGFzaF90YWJsZV9pbnNlcnQgKGN0eC0+Z3JvdXBzLCBHVUlOVF9UT19QT0lOVEVSIChrbGFzcy0+Y2xhc3NfbG9hZGVyKSwgZ3JvdXApOwoKICAgICAgICBqc29uX2J1aWxkZXJfYmVnaW5fb2JqZWN0IChncm91cCk7CgogICAgICAgIGpzb25fYnVpbGRlcl9zZXRfbWVtYmVyX25hbWUgKGdyb3VwLCAibG9hZGVyIik7CiAgICAgICAganNvbl9idWlsZGVyX2FkZF9pbnRfdmFsdWUgKGdyb3VwLCBrbGFzcy0+Y2xhc3NfbG9hZGVyKTsKCiAgICAgICAganNvbl9idWlsZGVyX3NldF9tZW1iZXJfbmFtZSAoZ3JvdXAsICJjbGFzc2VzIik7CiAgICAgICAganNvbl9idWlsZGVyX2JlZ2luX2FycmF5IChncm91cCk7CiAgICAgIH0KCiAgICAgIGpzb25fYnVpbGRlcl9iZWdpbl9vYmplY3QgKGdyb3VwKTsKCiAgICAgIGpzb25fYnVpbGRlcl9zZXRfbWVtYmVyX25hbWUgKGdyb3VwLCAibmFtZSIpOwogICAgICBqc29uX2J1aWxkZXJfYWRkX3N0cmluZ192YWx1ZSAoZ3JvdXAsIGNsYXNzX25hbWUpOwoKICAgICAganNvbl9idWlsZGVyX3NldF9tZW1iZXJfbmFtZSAoZ3JvdXAsICJtZXRob2RzIik7CiAgICAgIGpzb25fYnVpbGRlcl9iZWdpbl9hcnJheSAoZ3JvdXApOwogICAgfQoKICAgIGpzb25fYnVpbGRlcl9hZGRfc3RyaW5nX3ZhbHVlIChncm91cCwgYmFyZV9tZXRob2RfbmFtZSk7CgogICAgaWYgKHNlZW5fbWV0aG9kX25hbWVzICE9IE5VTEwpCiAgICAgIGdfaGFzaF90YWJsZV9hZGQgKHNlZW5fbWV0aG9kX25hbWVzLCBnX3N0cmR1cCAoYmFyZV9tZXRob2RfbmFtZSkpOwoKc2tpcF9tZXRob2Q6CiAgICBnX2ZyZWUgKG5vcm1hbGl6ZWRfbWV0aG9kX25hbWVfY29weSk7CiAgICBnX2ZyZWUgKGJhcmVfbWV0aG9kX25hbWVfY29weSk7CiAgICBzdGRfc3RyaW5nX2Rlc3Ryb3kgKCZtZXRob2RfbmFtZSk7CiAgfQoKICBpZiAoc2Vlbl9tZXRob2RfbmFtZXMgIT0gTlVMTCkKICAgIGdfaGFzaF90YWJsZV91bnJlZiAoc2Vlbl9tZXRob2RfbmFtZXMpOwoKICBpZiAoZ3JvdXAgPT0gTlVMTCkKICAgIGdvdG8gc2tpcF9jbGFzczsKCiAganNvbl9idWlsZGVyX2VuZF9hcnJheSAoZ3JvdXApOwogIGpzb25fYnVpbGRlcl9lbmRfb2JqZWN0IChncm91cCk7Cgpza2lwX2NsYXNzOgogIGdfZnJlZSAoY2xhc3NfbmFtZV9jb3B5KTsKICBnX2ZyZWUgKGNsYXNzX25hbWUpOwogIHN0ZF9zdHJpbmdfZGVzdHJveSAoJmRlc2NyaXB0b3Jfc3RvcmFnZSk7CgogIHJldHVybiBUUlVFOwp9CgpnY2hhciAqCmVudW1lcmF0ZV9tZXRob2RzX2p2bSAoY29uc3QgZ2NoYXIgKiBjbGFzc19xdWVyeSwKICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBnY2hhciAqIG1ldGhvZF9xdWVyeSwKICAgICAgICAgICAgICAgICAgICAgICBqYm9vbGVhbiBpbmNsdWRlX3NpZ25hdHVyZSwKICAgICAgICAgICAgICAgICAgICAgICBqYm9vbGVhbiBpZ25vcmVfY2FzZSwKICAgICAgICAgICAgICAgICAgICAgICBqYm9vbGVhbiBza2lwX3N5c3RlbV9jbGFzc2VzLAogICAgICAgICAgICAgICAgICAgICAgIEpOSUVudiAqIGVudiwKICAgICAgICAgICAgICAgICAgICAgICBqdm10aUVudiAqIGp2bXRpKQp7CiAgZ2NoYXIgKiByZXN1bHQ7CiAgR1BhdHRlcm5TcGVjICogY2xhc3NfcGF0dGVybiwgKiBtZXRob2RfcGF0dGVybjsKICBHSGFzaFRhYmxlICogZ3JvdXBzOwogIGdwb2ludGVyICogZWYgPSBlbnYtPmZ1bmN0aW9uczsKICBqb2JqZWN0ICgqIG5ld19nbG9iYWxfcmVmKSAoSk5JRW52ICosIGpvYmplY3QpID0gZWZbMjFdOwogIHZvaWQgKCogZGVsZXRlX2xvY2FsX3JlZikgKEpOSUVudiAqLCBqb2JqZWN0KSA9IGVmWzIzXTsKICBqYm9vbGVhbiAoKiBpc19zYW1lX29iamVjdCkgKEpOSUVudiAqLCBqb2JqZWN0LCBqb2JqZWN0KSA9IGVmWzI0XTsKICBncG9pbnRlciAqIGpmID0ganZtdGktPmZ1bmN0aW9ucyAtIDE7CiAganZtdGlFcnJvciAoKiBkZWFsbG9jYXRlKSAoanZtdGlFbnYgKiwgdm9pZCAqIG1lbSkgPSBqZls0N107CiAganZtdGlFcnJvciAoKiBnZXRfY2xhc3Nfc2lnbmF0dXJlKSAoanZtdGlFbnYgKiwgamNsYXNzLCBjaGFyICoqLCBjaGFyICoqKSA9IGpmWzQ4XTsKICBqdm10aUVycm9yICgqIGdldF9jbGFzc19tZXRob2RzKSAoanZtdGlFbnYgKiwgamNsYXNzLCBqaW50ICosIGptZXRob2RJRCAqKikgPSBqZls1Ml07CiAganZtdGlFcnJvciAoKiBnZXRfY2xhc3NfbG9hZGVyKSAoanZtdGlFbnYgKiwgamNsYXNzLCBqb2JqZWN0ICopID0gamZbNTddOwogIGp2bXRpRXJyb3IgKCogZ2V0X21ldGhvZF9uYW1lKSAoanZtdGlFbnYgKiwgam1ldGhvZElELCBjaGFyICoqLCBjaGFyICoqLCBjaGFyICoqKSA9IGpmWzY0XTsKICBqdm10aUVycm9yICgqIGdldF9sb2FkZWRfY2xhc3NlcykgKGp2bXRpRW52ICosIGppbnQgKiwgamNsYXNzICoqKSA9IGpmWzc4XTsKICBqaW50IGNsYXNzX2NvdW50LCBjbGFzc19pbmRleDsKICBqY2xhc3MgKiBjbGFzc2VzOwoKICBjbGFzc19wYXR0ZXJuID0gbWFrZV9wYXR0ZXJuX3NwZWMgKGNsYXNzX3F1ZXJ5LCBpZ25vcmVfY2FzZSk7CiAgbWV0aG9kX3BhdHRlcm4gPSBtYWtlX3BhdHRlcm5fc3BlYyAobWV0aG9kX3F1ZXJ5LCBpZ25vcmVfY2FzZSk7CiAgZ3JvdXBzID0gZ19oYXNoX3RhYmxlX25ld19mdWxsIChOVUxMLCBOVUxMLCBOVUxMLCBOVUxMKTsKCiAgaWYgKGdldF9sb2FkZWRfY2xhc3NlcyAoanZtdGksICZjbGFzc19jb3VudCwgJmNsYXNzZXMpICE9IEpWTVRJX0VSUk9SX05PTkUpCiAgICBnb3RvIGVtaXRfcmVzdWx0czsKCiAgZm9yIChjbGFzc19pbmRleCA9IDA7IGNsYXNzX2luZGV4ICE9IGNsYXNzX2NvdW50OyBjbGFzc19pbmRleCsrKQogIHsKICAgIGpjbGFzcyBrbGFzcyA9IGNsYXNzZXNbY2xhc3NfaW5kZXhdOwogICAgam9iamVjdCBsb2FkZXIgPSBOVUxMOwogICAgZ2Jvb2xlYW4gaGF2ZV9sb2FkZXIgPSBGQUxTRTsKICAgIGNoYXIgKiBzaWduYXR1cmUgPSBOVUxMOwogICAgZ2NoYXIgKiBjbGFzc19uYW1lID0gTlVMTDsKICAgIGdjaGFyICogY2xhc3NfbmFtZV9jb3B5ID0gTlVMTDsKICAgIGNvbnN0IGdjaGFyICogbm9ybWFsaXplZF9jbGFzc19uYW1lOwogICAgamludCBtZXRob2RfY291bnQsIG1ldGhvZF9pbmRleDsKICAgIGptZXRob2RJRCAqIG1ldGhvZHMgPSBOVUxMOwogICAgSnNvbkJ1aWxkZXIgKiBncm91cCA9IE5VTEw7CiAgICBHSGFzaFRhYmxlICogc2Vlbl9tZXRob2RfbmFtZXMgPSBOVUxMOwoKICAgIGlmIChza2lwX3N5c3RlbV9jbGFzc2VzKQogICAgewogICAgICBpZiAoZ2V0X2NsYXNzX2xvYWRlciAoanZtdGksIGtsYXNzLCAmbG9hZGVyKSAhPSBKVk1USV9FUlJPUl9OT05FKQogICAgICAgIGdvdG8gc2tpcF9jbGFzczsKICAgICAgaGF2ZV9sb2FkZXIgPSBUUlVFOwoKICAgICAgaWYgKGxvYWRlciA9PSBOVUxMKQogICAgICAgIGdvdG8gc2tpcF9jbGFzczsKICAgIH0KCiAgICBpZiAoZ2V0X2NsYXNzX3NpZ25hdHVyZSAoanZtdGksIGtsYXNzLCAmc2lnbmF0dXJlLCBOVUxMKSAhPSBKVk1USV9FUlJPUl9OT05FKQogICAgICBnb3RvIHNraXBfY2xhc3M7CgogICAgY2xhc3NfbmFtZSA9IGNsYXNzX25hbWVfZnJvbV9zaWduYXR1cmUgKHNpZ25hdHVyZSk7CgogICAgaWYgKGlnbm9yZV9jYXNlKQogICAgewogICAgICBjbGFzc19uYW1lX2NvcHkgPSBnX3V0Zjhfc3RyZG93biAoY2xhc3NfbmFtZSwgLTEpOwogICAgICBub3JtYWxpemVkX2NsYXNzX25hbWUgPSBjbGFzc19uYW1lX2NvcHk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgIG5vcm1hbGl6ZWRfY2xhc3NfbmFtZSA9IGNsYXNzX25hbWU7CiAgICB9CgogICAgaWYgKCFnX3BhdHRlcm5fbWF0Y2hfc3RyaW5nIChjbGFzc19wYXR0ZXJuLCBub3JtYWxpemVkX2NsYXNzX25hbWUpKQogICAgICBnb3RvIHNraXBfY2xhc3M7CgogICAgaWYgKGdldF9jbGFzc19tZXRob2RzIChqdm10aSwga2xhc3MsICZtZXRob2RfY291bnQsICZtZXRob2RzKSAhPSBKVk1USV9FUlJPUl9OT05FKQogICAgICBnb3RvIHNraXBfY2xhc3M7CgogICAgaWYgKCFpbmNsdWRlX3NpZ25hdHVyZSkKICAgICAgc2Vlbl9tZXRob2RfbmFtZXMgPSBnX2hhc2hfdGFibGVfbmV3X2Z1bGwgKGdfc3RyX2hhc2gsIGdfc3RyX2VxdWFsLCBnX2ZyZWUsIE5VTEwpOwoKICAgIGZvciAobWV0aG9kX2luZGV4ID0gMDsgbWV0aG9kX2luZGV4ICE9IG1ldGhvZF9jb3VudDsgbWV0aG9kX2luZGV4KyspCiAgICB7CiAgICAgIGptZXRob2RJRCBtZXRob2QgPSBtZXRob2RzW21ldGhvZF9pbmRleF07CiAgICAgIGNvbnN0IGdjaGFyICogbWV0aG9kX25hbWU7CiAgICAgIGNoYXIgKiBtZXRob2RfbmFtZV92YWx1ZSA9IE5VTEw7CiAgICAgIGNoYXIgKiBtZXRob2Rfc2lnbmF0dXJlX3ZhbHVlID0gTlVMTDsKICAgICAgZ2NoYXIgKiBtZXRob2RfbmFtZV9jb3B5ID0gTlVMTDsKICAgICAgY29uc3QgZ2NoYXIgKiBub3JtYWxpemVkX21ldGhvZF9uYW1lOwogICAgICBnY2hhciAqIG5vcm1hbGl6ZWRfbWV0aG9kX25hbWVfY29weSA9IE5VTEw7CgogICAgICBpZiAoZ2V0X21ldGhvZF9uYW1lIChqdm10aSwgbWV0aG9kLCAmbWV0aG9kX25hbWVfdmFsdWUsIGluY2x1ZGVfc2lnbmF0dXJlID8gJm1ldGhvZF9zaWduYXR1cmVfdmFsdWUgOiBOVUxMLCBOVUxMKSAhPSBKVk1USV9FUlJPUl9OT05FKQogICAgICAgIGdvdG8gc2tpcF9tZXRob2Q7CiAgICAgIG1ldGhvZF9uYW1lID0gbWV0aG9kX25hbWVfdmFsdWU7CgogICAgICBpZiAobWV0aG9kX25hbWVbMF0gPT0gJzwnKQogICAgICB7CiAgICAgICAgaWYgKHN0cmNtcCAobWV0aG9kX25hbWUsICI8aW5pdD4iKSA9PSAwKQogICAgICAgICAgbWV0aG9kX25hbWUgPSAiJGluaXQiOwogICAgICAgIGVsc2UgaWYgKHN0cmNtcCAobWV0aG9kX25hbWUsICI8Y2xpbml0PiIpID09IDApCiAgICAgICAgICBnb3RvIHNraXBfbWV0aG9kOwogICAgICB9CgogICAgICBpZiAoaW5jbHVkZV9zaWduYXR1cmUpCiAgICAgIHsKICAgICAgICBtZXRob2RfbmFtZV9jb3B5ID0gZm9ybWF0X21ldGhvZF9zaWduYXR1cmUgKG1ldGhvZF9uYW1lLCBtZXRob2Rfc2lnbmF0dXJlX3ZhbHVlKTsKICAgICAgICBtZXRob2RfbmFtZSA9IG1ldGhvZF9uYW1lX2NvcHk7CiAgICAgIH0KCiAgICAgIGlmIChzZWVuX21ldGhvZF9uYW1lcyAhPSBOVUxMICYmIGdfaGFzaF90YWJsZV9jb250YWlucyAoc2Vlbl9tZXRob2RfbmFtZXMsIG1ldGhvZF9uYW1lKSkKICAgICAgICBnb3RvIHNraXBfbWV0aG9kOwoKICAgICAgaWYgKGlnbm9yZV9jYXNlKQogICAgICB7CiAgICAgICAgbm9ybWFsaXplZF9tZXRob2RfbmFtZV9jb3B5ID0gZ191dGY4X3N0cmRvd24gKG1ldGhvZF9uYW1lLCAtMSk7CiAgICAgICAgbm9ybWFsaXplZF9tZXRob2RfbmFtZSA9IG5vcm1hbGl6ZWRfbWV0aG9kX25hbWVfY29weTsKICAgICAgfQogICAgICBlbHNlCiAgICAgIHsKICAgICAgICBub3JtYWxpemVkX21ldGhvZF9uYW1lID0gbWV0aG9kX25hbWU7CiAgICAgIH0KCiAgICAgIGlmICghZ19wYXR0ZXJuX21hdGNoX3N0cmluZyAobWV0aG9kX3BhdHRlcm4sIG5vcm1hbGl6ZWRfbWV0aG9kX25hbWUpKQogICAgICAgIGdvdG8gc2tpcF9tZXRob2Q7CgogICAgICBpZiAoZ3JvdXAgPT0gTlVMTCkKICAgICAgewogICAgICAgIGlmICghaGF2ZV9sb2FkZXIgJiYgZ2V0X2NsYXNzX2xvYWRlciAoanZtdGksIGtsYXNzLCAmbG9hZGVyKSAhPSBKVk1USV9FUlJPUl9OT05FKQogICAgICAgICAgZ290byBza2lwX21ldGhvZDsKCiAgICAgICAgaWYgKGxvYWRlciA9PSBOVUxMKQogICAgICAgIHsKICAgICAgICAgIGdyb3VwID0gZ19oYXNoX3RhYmxlX2xvb2t1cCAoZ3JvdXBzLCBOVUxMKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgIEdIYXNoVGFibGVJdGVyIGl0ZXI7CiAgICAgICAgICBqb2JqZWN0IGN1cl9sb2FkZXI7CiAgICAgICAgICBKc29uQnVpbGRlciAqIGN1cl9ncm91cDsKCiAgICAgICAgICBnX2hhc2hfdGFibGVfaXRlcl9pbml0ICgmaXRlciwgZ3JvdXBzKTsKICAgICAgICAgIHdoaWxlIChnX2hhc2hfdGFibGVfaXRlcl9uZXh0ICgmaXRlciwgKGdwb2ludGVyICopICZjdXJfbG9hZGVyLCAoZ3BvaW50ZXIgKikgJmN1cl9ncm91cCkpCiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjdXJfbG9hZGVyICE9IE5VTEwgJiYgaXNfc2FtZV9vYmplY3QgKGVudiwgY3VyX2xvYWRlciwgbG9hZGVyKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgIGdyb3VwID0gY3VyX2dyb3VwOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoZ3JvdXAgPT0gTlVMTCkKICAgICAgICB7CiAgICAgICAgICBqb2JqZWN0IGw7CiAgICAgICAgICBnY2hhciAqIHN0cjsKCiAgICAgICAgICBsID0gKGxvYWRlciAhPSBOVUxMKSA/IG5ld19nbG9iYWxfcmVmIChlbnYsIGxvYWRlcikgOiBOVUxMOwoKICAgICAgICAgIGdyb3VwID0ganNvbl9idWlsZGVyX25ld19pbW11dGFibGUgKCk7CiAgICAgICAgICBnX2hhc2hfdGFibGVfaW5zZXJ0IChncm91cHMsIGwsIGdyb3VwKTsKCiAgICAgICAgICBqc29uX2J1aWxkZXJfYmVnaW5fb2JqZWN0IChncm91cCk7CgogICAgICAgICAganNvbl9idWlsZGVyX3NldF9tZW1iZXJfbmFtZSAoZ3JvdXAsICJsb2FkZXIiKTsKICAgICAgICAgIHN0ciA9IGdfc3RyZHVwX3ByaW50ZiAoIjB4JSIgR19HU0laRV9NT0RJRklFUiAieCIsIEdQT0lOVEVSX1RPX1NJWkUgKGwpKTsKICAgICAgICAgIGpzb25fYnVpbGRlcl9hZGRfc3RyaW5nX3ZhbHVlIChncm91cCwgc3RyKTsKICAgICAgICAgIGdfZnJlZSAoc3RyKTsKCiAgICAgICAgICBqc29uX2J1aWxkZXJfc2V0X21lbWJlcl9uYW1lIChncm91cCwgImNsYXNzZXMiKTsKICAgICAgICAgIGpzb25fYnVpbGRlcl9iZWdpbl9hcnJheSAoZ3JvdXApOwogICAgICAgIH0KCiAgICAgICAganNvbl9idWlsZGVyX2JlZ2luX29iamVjdCAoZ3JvdXApOwoKICAgICAgICBqc29uX2J1aWxkZXJfc2V0X21lbWJlcl9uYW1lIChncm91cCwgIm5hbWUiKTsKICAgICAgICBqc29uX2J1aWxkZXJfYWRkX3N0cmluZ192YWx1ZSAoZ3JvdXAsIGNsYXNzX25hbWUpOwoKICAgICAgICBqc29uX2J1aWxkZXJfc2V0X21lbWJlcl9uYW1lIChncm91cCwgIm1ldGhvZHMiKTsKICAgICAgICBqc29uX2J1aWxkZXJfYmVnaW5fYXJyYXkgKGdyb3VwKTsKICAgICAgfQoKICAgICAganNvbl9idWlsZGVyX2FkZF9zdHJpbmdfdmFsdWUgKGdyb3VwLCBtZXRob2RfbmFtZSk7CgogICAgICBpZiAoc2Vlbl9tZXRob2RfbmFtZXMgIT0gTlVMTCkKICAgICAgICBnX2hhc2hfdGFibGVfYWRkIChzZWVuX21ldGhvZF9uYW1lcywgZ19zdHJkdXAgKG1ldGhvZF9uYW1lKSk7Cgpza2lwX21ldGhvZDoKICAgICAgZ19mcmVlIChub3JtYWxpemVkX21ldGhvZF9uYW1lX2NvcHkpOwogICAgICBnX2ZyZWUgKG1ldGhvZF9uYW1lX2NvcHkpOwogICAgICBkZWFsbG9jYXRlIChqdm10aSwgbWV0aG9kX3NpZ25hdHVyZV92YWx1ZSk7CiAgICAgIGRlYWxsb2NhdGUgKGp2bXRpLCBtZXRob2RfbmFtZV92YWx1ZSk7CiAgICB9Cgpza2lwX2NsYXNzOgogICAgaWYgKGdyb3VwICE9IE5VTEwpCiAgICB7CiAgICAgIGpzb25fYnVpbGRlcl9lbmRfYXJyYXkgKGdyb3VwKTsKICAgICAganNvbl9idWlsZGVyX2VuZF9vYmplY3QgKGdyb3VwKTsKICAgIH0KCiAgICBpZiAoc2Vlbl9tZXRob2RfbmFtZXMgIT0gTlVMTCkKICAgICAgZ19oYXNoX3RhYmxlX3VucmVmIChzZWVuX21ldGhvZF9uYW1lcyk7CgogICAgZGVhbGxvY2F0ZSAoanZtdGksIG1ldGhvZHMpOwoKICAgIGdfZnJlZSAoY2xhc3NfbmFtZV9jb3B5KTsKICAgIGdfZnJlZSAoY2xhc3NfbmFtZSk7CiAgICBkZWFsbG9jYXRlIChqdm10aSwgc2lnbmF0dXJlKTsKCiAgICBpZiAobG9hZGVyICE9IE5VTEwpCiAgICAgIGRlbGV0ZV9sb2NhbF9yZWYgKGVudiwgbG9hZGVyKTsKCiAgICBkZWxldGVfbG9jYWxfcmVmIChlbnYsIGtsYXNzKTsKICB9CgogIGRlYWxsb2NhdGUgKGp2bXRpLCBjbGFzc2VzKTsKCmVtaXRfcmVzdWx0czoKICByZXN1bHQgPSBmaW5hbGl6ZV9tZXRob2RfZ3JvdXBzX3RvX2pzb24gKGdyb3Vwcyk7CgogIGdfaGFzaF90YWJsZV91bnJlZiAoZ3JvdXBzKTsKICBnX3BhdHRlcm5fc3BlY19mcmVlIChtZXRob2RfcGF0dGVybik7CiAgZ19wYXR0ZXJuX3NwZWNfZnJlZSAoY2xhc3NfcGF0dGVybik7CgogIHJldHVybiByZXN1bHQ7Cn0KCnN0YXRpYyBnY2hhciAqCmZpbmFsaXplX21ldGhvZF9ncm91cHNfdG9fanNvbiAoR0hhc2hUYWJsZSAqIGdyb3VwcykKewogIEdTdHJpbmcgKiByZXN1bHQ7CiAgR0hhc2hUYWJsZUl0ZXIgaXRlcjsKICBndWludCBpOwogIEpzb25CdWlsZGVyICogZ3JvdXA7CgogIHJlc3VsdCA9IGdfc3RyaW5nX3NpemVkX25ldyAoMTAyNCk7CgogIGdfc3RyaW5nX2FwcGVuZF9jIChyZXN1bHQsICdbJyk7CgogIGdfaGFzaF90YWJsZV9pdGVyX2luaXQgKCZpdGVyLCBncm91cHMpOwogIGZvciAoaSA9IDA7IGdfaGFzaF90YWJsZV9pdGVyX25leHQgKCZpdGVyLCBOVUxMLCAoZ3BvaW50ZXIgKikgJmdyb3VwKTsgaSsrKQogIHsKICAgIEpzb25Ob2RlICogcm9vdDsKICAgIGdjaGFyICoganNvbjsKCiAgICBpZiAoaSA+IDApCiAgICAgIGdfc3RyaW5nX2FwcGVuZF9jIChyZXN1bHQsICcsJyk7CgogICAganNvbl9idWlsZGVyX2VuZF9hcnJheSAoZ3JvdXApOwogICAganNvbl9idWlsZGVyX2VuZF9vYmplY3QgKGdyb3VwKTsKCiAgICByb290ID0ganNvbl9idWlsZGVyX2dldF9yb290IChncm91cCk7CiAgICBqc29uID0ganNvbl90b19zdHJpbmcgKHJvb3QsIEZBTFNFKTsKICAgIGdfc3RyaW5nX2FwcGVuZCAocmVzdWx0LCBqc29uKTsKICAgIGdfZnJlZSAoanNvbik7CiAgICBqc29uX25vZGVfdW5yZWYgKHJvb3QpOwoKICAgIGdfb2JqZWN0X3VucmVmIChncm91cCk7CiAgfQoKICBnX3N0cmluZ19hcHBlbmRfYyAocmVzdWx0LCAnXScpOwoKICByZXR1cm4gZ19zdHJpbmdfZnJlZSAocmVzdWx0LCBGQUxTRSk7Cn0KCnN0YXRpYyBHUGF0dGVyblNwZWMgKgptYWtlX3BhdHRlcm5fc3BlYyAoY29uc3QgZ2NoYXIgKiBwYXR0ZXJuLAogICAgICAgICAgICAgICAgICAgamJvb2xlYW4gaWdub3JlX2Nhc2UpCnsKICBHUGF0dGVyblNwZWMgKiBzcGVjOwoKICBpZiAoaWdub3JlX2Nhc2UpCiAgewogICAgZ2NoYXIgKiBzdHIgPSBnX3V0Zjhfc3RyZG93biAocGF0dGVybiwgLTEpOwogICAgc3BlYyA9IGdfcGF0dGVybl9zcGVjX25ldyAoc3RyKTsKICAgIGdfZnJlZSAoc3RyKTsKICB9CiAgZWxzZQogIHsKICAgIHNwZWMgPSBnX3BhdHRlcm5fc3BlY19uZXcgKHBhdHRlcm4pOwogIH0KCiAgcmV0dXJuIHNwZWM7Cn0KCnN0YXRpYyBnY2hhciAqCmNsYXNzX25hbWVfZnJvbV9zaWduYXR1cmUgKGNvbnN0IGdjaGFyICogZGVzY3JpcHRvcikKewogIGdjaGFyICogcmVzdWx0LCAqIGM7CgogIHJlc3VsdCA9IGdfc3RyZHVwIChkZXNjcmlwdG9yICsgMSk7CgogIGZvciAoYyA9IHJlc3VsdDsgKmMgIT0gJ1xcMCc7IGMrKykKICB7CiAgICBpZiAoKmMgPT0gJy8nKQogICAgICAqYyA9ICcuJzsKICB9CgogIGNbLTFdID0gJ1xcMCc7CgogIHJldHVybiByZXN1bHQ7Cn0KCnN0YXRpYyBnY2hhciAqCmZvcm1hdF9tZXRob2Rfc2lnbmF0dXJlIChjb25zdCBnY2hhciAqIG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBnY2hhciAqIHNpZ25hdHVyZSkKewogIEdTdHJpbmcgKiBzaWc7CiAgY29uc3QgZ2NoYXIgKiBjdXJzb3I7CiAgZ2ludCBhcmdfaW5kZXg7CgogIHNpZyA9IGdfc3RyaW5nX3NpemVkX25ldyAoMTI4KTsKCiAgZ19zdHJpbmdfYXBwZW5kIChzaWcsIG5hbWUpOwoKICBjdXJzb3IgPSBzaWduYXR1cmU7CiAgYXJnX2luZGV4ID0gLTE7CiAgd2hpbGUgKFRSVUUpCiAgewogICAgY29uc3QgZ2NoYXIgYyA9ICpjdXJzb3I7CgogICAgaWYgKGMgPT0gJygnKQogICAgewogICAgICBnX3N0cmluZ19hcHBlbmRfYyAoc2lnLCBjKTsKICAgICAgY3Vyc29yKys7CiAgICAgIGFyZ19pbmRleCA9IDA7CiAgICB9CiAgICBlbHNlIGlmIChjID09ICcpJykKICAgIHsKICAgICAgZ19zdHJpbmdfYXBwZW5kX2MgKHNpZywgYyk7CiAgICAgIGN1cnNvcisrOwogICAgICBicmVhazsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgaWYgKGFyZ19pbmRleCA+PSAxKQogICAgICAgIGdfc3RyaW5nX2FwcGVuZCAoc2lnLCAiLCAiKTsKCiAgICAgIGFwcGVuZF90eXBlIChzaWcsICZjdXJzb3IpOwoKICAgICAgaWYgKGFyZ19pbmRleCAhPSAtMSkKICAgICAgICBhcmdfaW5kZXgrKzsKICAgIH0KICB9CgogIGdfc3RyaW5nX2FwcGVuZCAoc2lnLCAiOiAiKTsKICBhcHBlbmRfdHlwZSAoc2lnLCAmY3Vyc29yKTsKCiAgcmV0dXJuIGdfc3RyaW5nX2ZyZWUgKHNpZywgRkFMU0UpOwp9CgpzdGF0aWMgdm9pZAphcHBlbmRfdHlwZSAoR1N0cmluZyAqIG91dHB1dCwKICAgICAgICAgICAgIGNvbnN0IGdjaGFyICoqIHR5cGUpCnsKICBjb25zdCBnY2hhciAqIGN1cnNvciA9ICp0eXBlOwoKICBzd2l0Y2ggKCpjdXJzb3IpCiAgewogICAgY2FzZSAnWic6CiAgICAgIGdfc3RyaW5nX2FwcGVuZCAob3V0cHV0LCAiYm9vbGVhbiIpOwogICAgICBjdXJzb3IrKzsKICAgICAgYnJlYWs7CiAgICBjYXNlICdCJzoKICAgICAgZ19zdHJpbmdfYXBwZW5kIChvdXRwdXQsICJieXRlIik7CiAgICAgIGN1cnNvcisrOwogICAgICBicmVhazsKICAgIGNhc2UgJ0MnOgogICAgICBnX3N0cmluZ19hcHBlbmQgKG91dHB1dCwgImNoYXIiKTsKICAgICAgY3Vyc29yKys7CiAgICAgIGJyZWFrOwogICAgY2FzZSAnUyc6CiAgICAgIGdfc3RyaW5nX2FwcGVuZCAob3V0cHV0LCAic2hvcnQiKTsKICAgICAgY3Vyc29yKys7CiAgICAgIGJyZWFrOwogICAgY2FzZSAnSSc6CiAgICAgIGdfc3RyaW5nX2FwcGVuZCAob3V0cHV0LCAiaW50Iik7CiAgICAgIGN1cnNvcisrOwogICAgICBicmVhazsKICAgIGNhc2UgJ0onOgogICAgICBnX3N0cmluZ19hcHBlbmQgKG91dHB1dCwgImxvbmciKTsKICAgICAgY3Vyc29yKys7CiAgICAgIGJyZWFrOwogICAgY2FzZSAnRic6CiAgICAgIGdfc3RyaW5nX2FwcGVuZCAob3V0cHV0LCAiZmxvYXQiKTsKICAgICAgY3Vyc29yKys7CiAgICAgIGJyZWFrOwogICAgY2FzZSAnRCc6CiAgICAgIGdfc3RyaW5nX2FwcGVuZCAob3V0cHV0LCAiZG91YmxlIik7CiAgICAgIGN1cnNvcisrOwogICAgICBicmVhazsKICAgIGNhc2UgJ1YnOgogICAgICBnX3N0cmluZ19hcHBlbmQgKG91dHB1dCwgInZvaWQiKTsKICAgICAgY3Vyc29yKys7CiAgICAgIGJyZWFrOwogICAgY2FzZSAnTCc6CiAgICB7CiAgICAgIGdjaGFyIGNoOwoKICAgICAgY3Vyc29yKys7CiAgICAgIGZvciAoOyAoY2ggPSAqY3Vyc29yKSAhPSAnOyc7IGN1cnNvcisrKQogICAgICB7CiAgICAgICAgZ19zdHJpbmdfYXBwZW5kX2MgKG91dHB1dCwgKGNoICE9ICcvJykgPyBjaCA6ICcuJyk7CiAgICAgIH0KICAgICAgY3Vyc29yKys7CgogICAgICBicmVhazsKICAgIH0KICAgIGNhc2UgJ1snOgogICAgICAqdHlwZSA9IGN1cnNvciArIDE7CiAgICAgIGFwcGVuZF90eXBlIChvdXRwdXQsIHR5cGUpOwogICAgICBnX3N0cmluZ19hcHBlbmQgKG91dHB1dCwgIltdIik7CiAgICAgIHJldHVybjsKICAgIGRlZmF1bHQ6CiAgICAgIGdfc3RyaW5nX2FwcGVuZCAob3V0cHV0LCAiQlVHIik7CiAgICAgIGN1cnNvcisrOwogIH0KCiAgKnR5cGUgPSBjdXJzb3I7Cn0KCnZvaWQKZGVhbGxvYyAoZ3BvaW50ZXIgbWVtKQp7CiAgZ19mcmVlIChtZW0pOwp9CgpzdGF0aWMgZ3BvaW50ZXIKcmVhZF9hcnRfYXJyYXkgKGdwb2ludGVyIG9iamVjdF9iYXNlLAogICAgICAgICAgICAgICAgZ3VpbnQgZmllbGRfb2Zmc2V0LAogICAgICAgICAgICAgICAgZ3VpbnQgbGVuZ3RoX3NpemUsCiAgICAgICAgICAgICAgICBndWludCAqIGxlbmd0aCkKewogIGdwb2ludGVyIHJlc3VsdCwgaGVhZGVyOwogIGd1aW50IG47CgogIGhlYWRlciA9IEdTSVpFX1RPX1BPSU5URVIgKCooZ3VpbnQ2NCAqKSAob2JqZWN0X2Jhc2UgKyBmaWVsZF9vZmZzZXQpKTsKICBpZiAoaGVhZGVyICE9IE5VTEwpCiAgewogICAgcmVzdWx0ID0gaGVhZGVyICsgbGVuZ3RoX3NpemU7CiAgICBpZiAobGVuZ3RoX3NpemUgPT0gc2l6ZW9mIChndWludDMyKSkKICAgICAgbiA9ICooZ3VpbnQzMiAqKSBoZWFkZXI7CiAgICBlbHNlCiAgICAgIG4gPSAqKGd1aW50NjQgKikgaGVhZGVyOwogIH0KICBlbHNlCiAgewogICAgcmVzdWx0ID0gTlVMTDsKICAgIG4gPSAwOwogIH0KCiAgaWYgKGxlbmd0aCAhPSBOVUxMKQogICAgKmxlbmd0aCA9IG47CgogIHJldHVybiByZXN1bHQ7Cn0KCnN0YXRpYyB2b2lkCnN0ZF9zdHJpbmdfZGVzdHJveSAoU3RkU3RyaW5nICogc3RyKQp7CiAgaWYgKChzdHItPmwuY2FwYWNpdHkgJiAxKSAhPSAwKQogICAgYXJ0X2FwaS5mcmVlIChzdHItPmwuZGF0YSk7Cn0KCnN0YXRpYyBnY2hhciAqCnN0ZF9zdHJpbmdfY19zdHIgKFN0ZFN0cmluZyAqIHNlbGYpCnsKICBpZiAoKHNlbGYtPmwuY2FwYWNpdHkgJiAxKSAhPSAwKQogICAgcmV0dXJuIHNlbGYtPmwuZGF0YTsKCiAgcmV0dXJuIHNlbGYtPnMuZGF0YTsKfQpgOwogIHZhciBtZXRob2RRdWVyeVBhdHRlcm4gPSAvKC4rKSEoW14vXSspXC8/KFtpc3VdKyk/LzsKICB2YXIgY20gPSBudWxsOwogIHZhciB1bndyYXAgPSBudWxsOwogIHZhciBNb2RlbCA9IGNsYXNzIHsKICAgIHN0YXRpYyBidWlsZChoYW5kbGUsIGVudikgewogICAgICBlbnN1cmVJbml0aWFsaXplZChlbnYpOwogICAgICByZXR1cm4gdW53cmFwKGhhbmRsZSwgZW52LCAob2JqZWN0KSA9PiB7CiAgICAgICAgcmV0dXJuIG5ldyBNb2RlbChjbS5uZXcoaGFuZGxlLCBvYmplY3QsIGVudikpOwogICAgICB9KTsKICAgIH0KICAgIHN0YXRpYyBlbnVtZXJhdGVNZXRob2RzKHF1ZXJ5LCBhcGkyLCBlbnYpIHsKICAgICAgZW5zdXJlSW5pdGlhbGl6ZWQoZW52KTsKICAgICAgY29uc3QgcGFyYW1zID0gcXVlcnkubWF0Y2gobWV0aG9kUXVlcnlQYXR0ZXJuKTsKICAgICAgaWYgKHBhcmFtcyA9PT0gbnVsbCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBxdWVyeTsgZm9ybWF0IGlzOiBjbGFzcyFtZXRob2QgLS0gc2VlIGRvY3VtZW50YXRpb24gb2YgSmF2YS5lbnVtZXJhdGVNZXRob2RzKHF1ZXJ5KSBmb3IgZGV0YWlscyIpOwogICAgICB9CiAgICAgIGNvbnN0IGNsYXNzUXVlcnkgPSBNZW1vcnkuYWxsb2NVdGY4U3RyaW5nKHBhcmFtc1sxXSk7CiAgICAgIGNvbnN0IG1ldGhvZFF1ZXJ5ID0gTWVtb3J5LmFsbG9jVXRmOFN0cmluZyhwYXJhbXNbMl0pOwogICAgICBsZXQgaW5jbHVkZVNpZ25hdHVyZSA9IGZhbHNlOwogICAgICBsZXQgaWdub3JlQ2FzZSA9IGZhbHNlOwogICAgICBsZXQgc2tpcFN5c3RlbUNsYXNzZXMgPSBmYWxzZTsKICAgICAgY29uc3QgbW9kaWZpZXJzID0gcGFyYW1zWzNdOwogICAgICBpZiAobW9kaWZpZXJzICE9PSB2b2lkIDApIHsKICAgICAgICBpbmNsdWRlU2lnbmF0dXJlID0gbW9kaWZpZXJzLmluZGV4T2YoInMiKSAhPT0gLTE7CiAgICAgICAgaWdub3JlQ2FzZSA9IG1vZGlmaWVycy5pbmRleE9mKCJpIikgIT09IC0xOwogICAgICAgIHNraXBTeXN0ZW1DbGFzc2VzID0gbW9kaWZpZXJzLmluZGV4T2YoInUiKSAhPT0gLTE7CiAgICAgIH0KICAgICAgbGV0IHJlc3VsdDsKICAgICAgaWYgKGFwaTIuZmxhdm9yID09PSAianZtIikgewogICAgICAgIGNvbnN0IGpzb24gPSBjbS5lbnVtZXJhdGVNZXRob2RzSnZtKAogICAgICAgICAgY2xhc3NRdWVyeSwKICAgICAgICAgIG1ldGhvZFF1ZXJ5LAogICAgICAgICAgYm9vbFRvTmF0aXZlKGluY2x1ZGVTaWduYXR1cmUpLAogICAgICAgICAgYm9vbFRvTmF0aXZlKGlnbm9yZUNhc2UpLAogICAgICAgICAgYm9vbFRvTmF0aXZlKHNraXBTeXN0ZW1DbGFzc2VzKSwKICAgICAgICAgIGVudiwKICAgICAgICAgIGFwaTIuanZtdGkKICAgICAgICApOwogICAgICAgIHRyeSB7CiAgICAgICAgICByZXN1bHQgPSBKU09OLnBhcnNlKGpzb24ucmVhZFV0ZjhTdHJpbmcoKSkubWFwKChncm91cCkgPT4gewogICAgICAgICAgICBjb25zdCBsb2FkZXJSZWYgPSBwdHIoZ3JvdXAubG9hZGVyKTsKICAgICAgICAgICAgZ3JvdXAubG9hZGVyID0gIWxvYWRlclJlZi5pc051bGwoKSA/IGxvYWRlclJlZiA6IG51bGw7CiAgICAgICAgICAgIHJldHVybiBncm91cDsKICAgICAgICAgIH0pOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBjbS5kZWFsbG9jKGpzb24pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB3aXRoUnVubmFibGVBcnRUaHJlYWQoZW52LnZtLCBlbnYsICh0aHJlYWQpID0+IHsKICAgICAgICAgIGNvbnN0IGpzb24gPSBjbS5lbnVtZXJhdGVNZXRob2RzQXJ0KAogICAgICAgICAgICBjbGFzc1F1ZXJ5LAogICAgICAgICAgICBtZXRob2RRdWVyeSwKICAgICAgICAgICAgYm9vbFRvTmF0aXZlKGluY2x1ZGVTaWduYXR1cmUpLAogICAgICAgICAgICBib29sVG9OYXRpdmUoaWdub3JlQ2FzZSksCiAgICAgICAgICAgIGJvb2xUb05hdGl2ZShza2lwU3lzdGVtQ2xhc3NlcykKICAgICAgICAgICk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCBhZGRHbG9iYWxSZWZlcmVuY2UgPSBhcGkyWyJhcnQ6OkphdmFWTUV4dDo6QWRkR2xvYmFsUmVmIl07CiAgICAgICAgICAgIGNvbnN0IHsgdm06IHZtSGFuZGxlIH0gPSBhcGkyOwogICAgICAgICAgICByZXN1bHQgPSBKU09OLnBhcnNlKGpzb24ucmVhZFV0ZjhTdHJpbmcoKSkubWFwKChncm91cCkgPT4gewogICAgICAgICAgICAgIGNvbnN0IGxvYWRlck9iaiA9IGdyb3VwLmxvYWRlcjsKICAgICAgICAgICAgICBncm91cC5sb2FkZXIgPSBsb2FkZXJPYmogIT09IDAgPyBhZGRHbG9iYWxSZWZlcmVuY2Uodm1IYW5kbGUsIHRocmVhZCwgcHRyKGxvYWRlck9iaikpIDogbnVsbDsKICAgICAgICAgICAgICByZXR1cm4gZ3JvdXA7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgY20uZGVhbGxvYyhqc29uKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgY29uc3RydWN0b3IoaGFuZGxlKSB7CiAgICAgIHRoaXMuaGFuZGxlID0gaGFuZGxlOwogICAgfQogICAgaGFzKG1lbWJlcikgewogICAgICByZXR1cm4gY20uaGFzKHRoaXMuaGFuZGxlLCBNZW1vcnkuYWxsb2NVdGY4U3RyaW5nKG1lbWJlcikpICE9PSAwOwogICAgfQogICAgZmluZChtZW1iZXIpIHsKICAgICAgcmV0dXJuIGNtLmZpbmQodGhpcy5oYW5kbGUsIE1lbW9yeS5hbGxvY1V0ZjhTdHJpbmcobWVtYmVyKSkucmVhZFV0ZjhTdHJpbmcoKTsKICAgIH0KICAgIGxpc3QoKSB7CiAgICAgIGNvbnN0IHN0ciA9IGNtLmxpc3QodGhpcy5oYW5kbGUpOwogICAgICB0cnkgewogICAgICAgIHJldHVybiBKU09OLnBhcnNlKHN0ci5yZWFkVXRmOFN0cmluZygpKTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBjbS5kZWFsbG9jKHN0cik7CiAgICAgIH0KICAgIH0KICB9OwogIGZ1bmN0aW9uIGVuc3VyZUluaXRpYWxpemVkKGVudikgewogICAgaWYgKGNtID09PSBudWxsKSB7CiAgICAgIGNtID0gY29tcGlsZU1vZHVsZShlbnYpOwogICAgICB1bndyYXAgPSBtYWtlSGFuZGxlVW53cmFwcGVyKGNtLCBlbnYudm0pOwogICAgfQogIH0KICBmdW5jdGlvbiBjb21waWxlTW9kdWxlKGVudikgewogICAgY29uc3QgeyBwb2ludGVyU2l6ZTogcG9pbnRlclNpemU5IH0gPSBQcm9jZXNzOwogICAgY29uc3QgbG9ja1NpemUgPSA4OwogICAgY29uc3QgbW9kZWxzU2l6ZSA9IHBvaW50ZXJTaXplOTsKICAgIGNvbnN0IGphdmFBcGlTaXplID0gNiAqIHBvaW50ZXJTaXplOTsKICAgIGNvbnN0IGFydEFwaVNpemUgPSAxMCAqIDQgKyA1ICogcG9pbnRlclNpemU5OwogICAgY29uc3QgZGF0YVNpemUgPSBsb2NrU2l6ZSArIG1vZGVsc1NpemUgKyBqYXZhQXBpU2l6ZSArIGFydEFwaVNpemU7CiAgICBjb25zdCBkYXRhID0gTWVtb3J5LmFsbG9jKGRhdGFTaXplKTsKICAgIGNvbnN0IGxvY2sgPSBkYXRhOwogICAgY29uc3QgbW9kZWxzID0gbG9jay5hZGQobG9ja1NpemUpOwogICAgY29uc3QgamF2YUFwaSA9IG1vZGVscy5hZGQobW9kZWxzU2l6ZSk7CiAgICBjb25zdCB7IGdldERlY2xhcmVkTWV0aG9kcywgZ2V0RGVjbGFyZWRGaWVsZHMgfSA9IGVudi5qYXZhTGFuZ0NsYXNzKCk7CiAgICBjb25zdCBtZXRob2QgPSBlbnYuamF2YUxhbmdSZWZsZWN0TWV0aG9kKCk7CiAgICBjb25zdCBmaWVsZCA9IGVudi5qYXZhTGFuZ1JlZmxlY3RGaWVsZCgpOwogICAgbGV0IGogPSBqYXZhQXBpOwogICAgWwogICAgICBnZXREZWNsYXJlZE1ldGhvZHMsCiAgICAgIGdldERlY2xhcmVkRmllbGRzLAogICAgICBtZXRob2QuZ2V0TmFtZSwKICAgICAgbWV0aG9kLmdldE1vZGlmaWVycywKICAgICAgZmllbGQuZ2V0TmFtZSwKICAgICAgZmllbGQuZ2V0TW9kaWZpZXJzCiAgICBdLmZvckVhY2goKHZhbHVlKSA9PiB7CiAgICAgIGogPSBqLndyaXRlUG9pbnRlcih2YWx1ZSkuYWRkKHBvaW50ZXJTaXplOSk7CiAgICB9KTsKICAgIGNvbnN0IGFydEFwaSA9IGphdmFBcGkuYWRkKGphdmFBcGlTaXplKTsKICAgIGNvbnN0IHsgdm06IHZtMyB9ID0gZW52OwogICAgY29uc3QgYXJ0Q2xhc3MgPSBnZXRBcnRDbGFzc1NwZWModm0zKTsKICAgIGlmIChhcnRDbGFzcyAhPT0gbnVsbCkgewogICAgICBjb25zdCBjID0gYXJ0Q2xhc3Mub2Zmc2V0OwogICAgICBjb25zdCBtID0gZ2V0QXJ0TWV0aG9kU3BlYyh2bTMpOwogICAgICBjb25zdCBmID0gZ2V0QXJ0RmllbGRTcGVjKHZtMyk7CiAgICAgIGxldCBzID0gYXJ0QXBpOwogICAgICBbCiAgICAgICAgMSwKICAgICAgICBjLmlmaWVsZHMsCiAgICAgICAgYy5tZXRob2RzLAogICAgICAgIGMuc2ZpZWxkcywKICAgICAgICBjLmNvcGllZE1ldGhvZHNPZmZzZXQsCiAgICAgICAgbS5zaXplLAogICAgICAgIG0ub2Zmc2V0LmFjY2Vzc0ZsYWdzLAogICAgICAgIGYuc2l6ZSwKICAgICAgICBmLm9mZnNldC5hY2Nlc3NGbGFncywKICAgICAgICA0Mjk0OTY3Mjk1CiAgICAgIF0uZm9yRWFjaCgodmFsdWUpID0+IHsKICAgICAgICBzID0gcy53cml0ZVVJbnQodmFsdWUpLmFkZCg0KTsKICAgICAgfSk7CiAgICAgIGNvbnN0IGFwaTIgPSBnZXRBcGkoKTsKICAgICAgWwogICAgICAgIGFwaTIuYXJ0Q2xhc3NMaW5rZXIuYWRkcmVzcywKICAgICAgICBhcGkyWyJhcnQ6OkNsYXNzTGlua2VyOjpWaXNpdENsYXNzZXMiXSwKICAgICAgICBhcGkyWyJhcnQ6Om1pcnJvcjo6Q2xhc3M6OkdldERlc2NyaXB0b3IiXSwKICAgICAgICBhcGkyWyJhcnQ6OkFydE1ldGhvZDo6UHJldHR5TWV0aG9kIl0sCiAgICAgICAgUHJvY2Vzcy5nZXRNb2R1bGVCeU5hbWUoImxpYmMuc28iKS5nZXRFeHBvcnRCeU5hbWUoImZyZWUiKQogICAgICBdLmZvckVhY2goKHZhbHVlLCBpKSA9PiB7CiAgICAgICAgaWYgKHZhbHVlID09PSB2b2lkIDApIHsKICAgICAgICAgIHZhbHVlID0gTlVMTDsKICAgICAgICB9CiAgICAgICAgcyA9IHMud3JpdGVQb2ludGVyKHZhbHVlKS5hZGQocG9pbnRlclNpemU5KTsKICAgICAgfSk7CiAgICB9CiAgICBjb25zdCBjbTIgPSBuZXcgQ01vZHVsZShjb2RlLCB7CiAgICAgIGxvY2ssCiAgICAgIG1vZGVscywKICAgICAgamF2YV9hcGk6IGphdmFBcGksCiAgICAgIGFydF9hcGk6IGFydEFwaQogICAgfSk7CiAgICBjb25zdCByZWVudHJhbnRPcHRpb25zID0geyBleGNlcHRpb25zOiAicHJvcGFnYXRlIiB9OwogICAgY29uc3QgZmFzdE9wdGlvbnMgPSB7IGV4Y2VwdGlvbnM6ICJwcm9wYWdhdGUiLCBzY2hlZHVsaW5nOiAiZXhjbHVzaXZlIiB9OwogICAgcmV0dXJuIHsKICAgICAgaGFuZGxlOiBjbTIsCiAgICAgIG1vZGU6IGFydENsYXNzICE9PSBudWxsID8gImZ1bGwiIDogImJhc2ljIiwKICAgICAgbmV3OiBuZXcgTmF0aXZlRnVuY3Rpb24oY20yLm1vZGVsX25ldywgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAicG9pbnRlciIsICJwb2ludGVyIl0sIHJlZW50cmFudE9wdGlvbnMpLAogICAgICBoYXM6IG5ldyBOYXRpdmVGdW5jdGlvbihjbTIubW9kZWxfaGFzLCAiYm9vbCIsIFsicG9pbnRlciIsICJwb2ludGVyIl0sIGZhc3RPcHRpb25zKSwKICAgICAgZmluZDogbmV3IE5hdGl2ZUZ1bmN0aW9uKGNtMi5tb2RlbF9maW5kLCAicG9pbnRlciIsIFsicG9pbnRlciIsICJwb2ludGVyIl0sIGZhc3RPcHRpb25zKSwKICAgICAgbGlzdDogbmV3IE5hdGl2ZUZ1bmN0aW9uKGNtMi5tb2RlbF9saXN0LCAicG9pbnRlciIsIFsicG9pbnRlciJdLCBmYXN0T3B0aW9ucyksCiAgICAgIGVudW1lcmF0ZU1ldGhvZHNBcnQ6IG5ldyBOYXRpdmVGdW5jdGlvbigKICAgICAgICBjbTIuZW51bWVyYXRlX21ldGhvZHNfYXJ0LAogICAgICAgICJwb2ludGVyIiwKICAgICAgICBbInBvaW50ZXIiLCAicG9pbnRlciIsICJib29sIiwgImJvb2wiLCAiYm9vbCJdLAogICAgICAgIHJlZW50cmFudE9wdGlvbnMKICAgICAgKSwKICAgICAgZW51bWVyYXRlTWV0aG9kc0p2bTogbmV3IE5hdGl2ZUZ1bmN0aW9uKGNtMi5lbnVtZXJhdGVfbWV0aG9kc19qdm0sICJwb2ludGVyIiwgWwogICAgICAgICJwb2ludGVyIiwKICAgICAgICAicG9pbnRlciIsCiAgICAgICAgImJvb2wiLAogICAgICAgICJib29sIiwKICAgICAgICAiYm9vbCIsCiAgICAgICAgInBvaW50ZXIiLAogICAgICAgICJwb2ludGVyIgogICAgICBdLCByZWVudHJhbnRPcHRpb25zKSwKICAgICAgZGVhbGxvYzogbmV3IE5hdGl2ZUZ1bmN0aW9uKGNtMi5kZWFsbG9jLCAidm9pZCIsIFsicG9pbnRlciJdLCBmYXN0T3B0aW9ucykKICAgIH07CiAgfQogIGZ1bmN0aW9uIG1ha2VIYW5kbGVVbndyYXBwZXIoY20yLCB2bTMpIHsKICAgIGlmIChjbTIubW9kZSA9PT0gImJhc2ljIikgewogICAgICByZXR1cm4gbnVsbFVud3JhcDsKICAgIH0KICAgIGNvbnN0IGRlY29kZUdsb2JhbCA9IGdldEFwaSgpWyJhcnQ6OkphdmFWTUV4dDo6RGVjb2RlR2xvYmFsIl07CiAgICByZXR1cm4gZnVuY3Rpb24oaGFuZGxlLCBlbnYsIGZuKSB7CiAgICAgIGxldCByZXN1bHQ7CiAgICAgIHdpdGhSdW5uYWJsZUFydFRocmVhZCh2bTMsIGVudiwgKHRocmVhZCkgPT4gewogICAgICAgIGNvbnN0IG9iamVjdCA9IGRlY29kZUdsb2JhbCh2bTMsIHRocmVhZCwgaGFuZGxlKTsKICAgICAgICByZXN1bHQgPSBmbihvYmplY3QpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfQogIGZ1bmN0aW9uIG51bGxVbndyYXAoaGFuZGxlLCBlbnYsIGZuKSB7CiAgICByZXR1cm4gZm4oTlVMTCk7CiAgfQogIGZ1bmN0aW9uIGJvb2xUb05hdGl2ZSh2YWwpIHsKICAgIHJldHVybiB2YWwgPyAxIDogMDsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9mcmlkYS1qYXZhLWJyaWRnZS9saWIvbHJ1LmpzCiAgdmFyIExSVSA9IGNsYXNzIHsKICAgIGNvbnN0cnVjdG9yKGNhcGFjaXR5LCBkZXN0cm95KSB7CiAgICAgIHRoaXMuaXRlbXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICB0aGlzLmNhcGFjaXR5ID0gY2FwYWNpdHk7CiAgICAgIHRoaXMuZGVzdHJveSA9IGRlc3Ryb3k7CiAgICB9CiAgICBkaXNwb3NlKGVudikgewogICAgICBjb25zdCB7IGl0ZW1zLCBkZXN0cm95IH0gPSB0aGlzOwogICAgICBpdGVtcy5mb3JFYWNoKCh2YWwpID0+IHsKICAgICAgICBkZXN0cm95KHZhbCwgZW52KTsKICAgICAgfSk7CiAgICAgIGl0ZW1zLmNsZWFyKCk7CiAgICB9CiAgICBnZXQoa2V5KSB7CiAgICAgIGNvbnN0IHsgaXRlbXMgfSA9IHRoaXM7CiAgICAgIGNvbnN0IGl0ZW0gPSBpdGVtcy5nZXQoa2V5KTsKICAgICAgaWYgKGl0ZW0gIT09IHZvaWQgMCkgewogICAgICAgIGl0ZW1zLmRlbGV0ZShrZXkpOwogICAgICAgIGl0ZW1zLnNldChrZXksIGl0ZW0pOwogICAgICB9CiAgICAgIHJldHVybiBpdGVtOwogICAgfQogICAgc2V0KGtleSwgdmFsLCBlbnYpIHsKICAgICAgY29uc3QgeyBpdGVtcyB9ID0gdGhpczsKICAgICAgY29uc3QgZXhpc3RpbmdWYWwgPSBpdGVtcy5nZXQoa2V5KTsKICAgICAgaWYgKGV4aXN0aW5nVmFsICE9PSB2b2lkIDApIHsKICAgICAgICBpdGVtcy5kZWxldGUoa2V5KTsKICAgICAgICB0aGlzLmRlc3Ryb3koZXhpc3RpbmdWYWwsIGVudik7CiAgICAgIH0gZWxzZSBpZiAoaXRlbXMuc2l6ZSA9PT0gdGhpcy5jYXBhY2l0eSkgewogICAgICAgIGNvbnN0IG9sZGVzdEtleSA9IGl0ZW1zLmtleXMoKS5uZXh0KCkudmFsdWU7CiAgICAgICAgY29uc3Qgb2xkZXN0VmFsID0gaXRlbXMuZ2V0KG9sZGVzdEtleSk7CiAgICAgICAgaXRlbXMuZGVsZXRlKG9sZGVzdEtleSk7CiAgICAgICAgdGhpcy5kZXN0cm95KG9sZGVzdFZhbCwgZW52KTsKICAgICAgfQogICAgICBpdGVtcy5zZXQoa2V5LCB2YWwpOwogICAgfQogIH07CgogIC8vIG5vZGVfbW9kdWxlcy9AZnJpZGEvYnVmZmVyL2luZGV4LmpzCiAgdmFyIGJhc2U2NCA9IF9fdG9FU00ocmVxdWlyZV9iYXNlNjRfanMoKSk7CiAgdmFyIGllZWU3NTQgPSBfX3RvRVNNKHJlcXVpcmVfaWVlZTc1NCgpKTsKICB2YXIgY29uZmlnID0gewogICAgSU5TUEVDVF9NQVhfQllURVM6IDUwCiAgfTsKICB2YXIgS19NQVhfTEVOR1RIID0gMjE0NzQ4MzY0NzsKICBCdWZmZXIyLlRZUEVEX0FSUkFZX1NVUFBPUlQgPSB0cnVlOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShCdWZmZXIyLnByb3RvdHlwZSwgInBhcmVudCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIUJ1ZmZlcjIuaXNCdWZmZXIodGhpcykpCiAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuYnVmZmVyOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShCdWZmZXIyLnByb3RvdHlwZSwgIm9mZnNldCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIUJ1ZmZlcjIuaXNCdWZmZXIodGhpcykpCiAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuYnl0ZU9mZnNldDsKICAgIH0KICB9KTsKICBmdW5jdGlvbiBjcmVhdGVCdWZmZXIobGVuZ3RoKSB7CiAgICBpZiAobGVuZ3RoID4gS19NQVhfTEVOR1RIKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdUaGUgdmFsdWUgIicgKyBsZW5ndGggKyAnIiBpcyBpbnZhbGlkIGZvciBvcHRpb24gInNpemUiJyk7CiAgICB9CiAgICBjb25zdCBidWYgPSBuZXcgVWludDhBcnJheShsZW5ndGgpOwogICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGJ1ZiwgQnVmZmVyMi5wcm90b3R5cGUpOwogICAgcmV0dXJuIGJ1ZjsKICB9CiAgZnVuY3Rpb24gQnVmZmVyMihhcmcsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkgewogICAgaWYgKHR5cGVvZiBhcmcgPT09ICJudW1iZXIiKSB7CiAgICAgIGlmICh0eXBlb2YgZW5jb2RpbmdPck9mZnNldCA9PT0gInN0cmluZyIpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKAogICAgICAgICAgJ1RoZSAic3RyaW5nIiBhcmd1bWVudCBtdXN0IGJlIG9mIHR5cGUgc3RyaW5nLiBSZWNlaXZlZCB0eXBlIG51bWJlcicKICAgICAgICApOwogICAgICB9CiAgICAgIHJldHVybiBhbGxvY1Vuc2FmZShhcmcpOwogICAgfQogICAgcmV0dXJuIGZyb20oYXJnLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpOwogIH0KICBCdWZmZXIyLnBvb2xTaXplID0gODE5MjsKICBmdW5jdGlvbiBmcm9tKHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpIHsKICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB7CiAgICAgIHJldHVybiBmcm9tU3RyaW5nKHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0KTsKICAgIH0KICAgIGlmIChBcnJheUJ1ZmZlci5pc1ZpZXcodmFsdWUpKSB7CiAgICAgIHJldHVybiBmcm9tQXJyYXlWaWV3KHZhbHVlKTsKICAgIH0KICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoCiAgICAgICAgIlRoZSBmaXJzdCBhcmd1bWVudCBtdXN0IGJlIG9uZSBvZiB0eXBlIHN0cmluZywgQnVmZmVyLCBBcnJheUJ1ZmZlciwgQXJyYXksIG9yIEFycmF5LWxpa2UgT2JqZWN0LiBSZWNlaXZlZCB0eXBlICIgKyB0eXBlb2YgdmFsdWUKICAgICAgKTsKICAgIH0KICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyIHx8IHZhbHVlICYmIHZhbHVlLmJ1ZmZlciBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSB7CiAgICAgIHJldHVybiBmcm9tQXJyYXlCdWZmZXIodmFsdWUsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCk7CiAgICB9CiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBTaGFyZWRBcnJheUJ1ZmZlciB8fCB2YWx1ZSAmJiB2YWx1ZS5idWZmZXIgaW5zdGFuY2VvZiBTaGFyZWRBcnJheUJ1ZmZlcikgewogICAgICByZXR1cm4gZnJvbUFycmF5QnVmZmVyKHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpOwogICAgfQogICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigKICAgICAgICAnVGhlICJ2YWx1ZSIgYXJndW1lbnQgbXVzdCBub3QgYmUgb2YgdHlwZSBudW1iZXIuIFJlY2VpdmVkIHR5cGUgbnVtYmVyJwogICAgICApOwogICAgfQogICAgY29uc3QgdmFsdWVPZiA9IHZhbHVlLnZhbHVlT2YgJiYgdmFsdWUudmFsdWVPZigpOwogICAgaWYgKHZhbHVlT2YgIT0gbnVsbCAmJiB2YWx1ZU9mICE9PSB2YWx1ZSkgewogICAgICByZXR1cm4gQnVmZmVyMi5mcm9tKHZhbHVlT2YsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCk7CiAgICB9CiAgICBjb25zdCBiID0gZnJvbU9iamVjdCh2YWx1ZSk7CiAgICBpZiAoYikKICAgICAgcmV0dXJuIGI7CiAgICBpZiAodHlwZW9mIFN5bWJvbCAhPT0gInVuZGVmaW5lZCIgJiYgU3ltYm9sLnRvUHJpbWl0aXZlICE9IG51bGwgJiYgdHlwZW9mIHZhbHVlW1N5bWJvbC50b1ByaW1pdGl2ZV0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmV0dXJuIEJ1ZmZlcjIuZnJvbSh2YWx1ZVtTeW1ib2wudG9QcmltaXRpdmVdKCJzdHJpbmciKSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKTsKICAgIH0KICAgIHRocm93IG5ldyBUeXBlRXJyb3IoCiAgICAgICJUaGUgZmlyc3QgYXJndW1lbnQgbXVzdCBiZSBvbmUgb2YgdHlwZSBzdHJpbmcsIEJ1ZmZlciwgQXJyYXlCdWZmZXIsIEFycmF5LCBvciBBcnJheS1saWtlIE9iamVjdC4gUmVjZWl2ZWQgdHlwZSAiICsgdHlwZW9mIHZhbHVlCiAgICApOwogIH0KICBCdWZmZXIyLmZyb20gPSBmdW5jdGlvbih2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gZnJvbSh2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKTsKICB9OwogIE9iamVjdC5zZXRQcm90b3R5cGVPZihCdWZmZXIyLnByb3RvdHlwZSwgVWludDhBcnJheS5wcm90b3R5cGUpOwogIE9iamVjdC5zZXRQcm90b3R5cGVPZihCdWZmZXIyLCBVaW50OEFycmF5KTsKICBmdW5jdGlvbiBhc3NlcnRTaXplKHNpemUpIHsKICAgIGlmICh0eXBlb2Ygc2l6ZSAhPT0gIm51bWJlciIpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignInNpemUiIGFyZ3VtZW50IG11c3QgYmUgb2YgdHlwZSBudW1iZXInKTsKICAgIH0gZWxzZSBpZiAoc2l6ZSA8IDApIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ1RoZSB2YWx1ZSAiJyArIHNpemUgKyAnIiBpcyBpbnZhbGlkIGZvciBvcHRpb24gInNpemUiJyk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGFsbG9jKHNpemUsIGZpbGwyLCBlbmNvZGluZykgewogICAgYXNzZXJ0U2l6ZShzaXplKTsKICAgIGlmIChzaXplIDw9IDApIHsKICAgICAgcmV0dXJuIGNyZWF0ZUJ1ZmZlcihzaXplKTsKICAgIH0KICAgIGlmIChmaWxsMiAhPT0gdm9pZCAwKSB7CiAgICAgIHJldHVybiB0eXBlb2YgZW5jb2RpbmcgPT09ICJzdHJpbmciID8gY3JlYXRlQnVmZmVyKHNpemUpLmZpbGwoZmlsbDIsIGVuY29kaW5nKSA6IGNyZWF0ZUJ1ZmZlcihzaXplKS5maWxsKGZpbGwyKTsKICAgIH0KICAgIHJldHVybiBjcmVhdGVCdWZmZXIoc2l6ZSk7CiAgfQogIEJ1ZmZlcjIuYWxsb2MgPSBmdW5jdGlvbihzaXplLCBmaWxsMiwgZW5jb2RpbmcpIHsKICAgIHJldHVybiBhbGxvYyhzaXplLCBmaWxsMiwgZW5jb2RpbmcpOwogIH07CiAgZnVuY3Rpb24gYWxsb2NVbnNhZmUoc2l6ZSkgewogICAgYXNzZXJ0U2l6ZShzaXplKTsKICAgIHJldHVybiBjcmVhdGVCdWZmZXIoc2l6ZSA8IDAgPyAwIDogY2hlY2tlZChzaXplKSB8IDApOwogIH0KICBCdWZmZXIyLmFsbG9jVW5zYWZlID0gZnVuY3Rpb24oc2l6ZSkgewogICAgcmV0dXJuIGFsbG9jVW5zYWZlKHNpemUpOwogIH07CiAgQnVmZmVyMi5hbGxvY1Vuc2FmZVNsb3cgPSBmdW5jdGlvbihzaXplKSB7CiAgICByZXR1cm4gYWxsb2NVbnNhZmUoc2l6ZSk7CiAgfTsKICBmdW5jdGlvbiBmcm9tU3RyaW5nKHN0cmluZywgZW5jb2RpbmcpIHsKICAgIGlmICh0eXBlb2YgZW5jb2RpbmcgIT09ICJzdHJpbmciIHx8IGVuY29kaW5nID09PSAiIikgewogICAgICBlbmNvZGluZyA9ICJ1dGY4IjsKICAgIH0KICAgIGlmICghQnVmZmVyMi5pc0VuY29kaW5nKGVuY29kaW5nKSkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJVbmtub3duIGVuY29kaW5nOiAiICsgZW5jb2RpbmcpOwogICAgfQogICAgY29uc3QgbGVuZ3RoID0gYnl0ZUxlbmd0aChzdHJpbmcsIGVuY29kaW5nKSB8IDA7CiAgICBsZXQgYnVmID0gY3JlYXRlQnVmZmVyKGxlbmd0aCk7CiAgICBjb25zdCBhY3R1YWwgPSBidWYud3JpdGUoc3RyaW5nLCBlbmNvZGluZyk7CiAgICBpZiAoYWN0dWFsICE9PSBsZW5ndGgpIHsKICAgICAgYnVmID0gYnVmLnNsaWNlKDAsIGFjdHVhbCk7CiAgICB9CiAgICByZXR1cm4gYnVmOwogIH0KICBmdW5jdGlvbiBmcm9tQXJyYXlMaWtlKGFycmF5KSB7CiAgICBjb25zdCBsZW5ndGggPSBhcnJheS5sZW5ndGggPCAwID8gMCA6IGNoZWNrZWQoYXJyYXkubGVuZ3RoKSB8IDA7CiAgICBjb25zdCBidWYgPSBjcmVhdGVCdWZmZXIobGVuZ3RoKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDEpIHsKICAgICAgYnVmW2ldID0gYXJyYXlbaV0gJiAyNTU7CiAgICB9CiAgICByZXR1cm4gYnVmOwogIH0KICBmdW5jdGlvbiBmcm9tQXJyYXlWaWV3KGFycmF5VmlldykgewogICAgaWYgKGFycmF5VmlldyBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpIHsKICAgICAgY29uc3QgY29weTIgPSBuZXcgVWludDhBcnJheShhcnJheVZpZXcpOwogICAgICByZXR1cm4gZnJvbUFycmF5QnVmZmVyKGNvcHkyLmJ1ZmZlciwgY29weTIuYnl0ZU9mZnNldCwgY29weTIuYnl0ZUxlbmd0aCk7CiAgICB9CiAgICByZXR1cm4gZnJvbUFycmF5TGlrZShhcnJheVZpZXcpOwogIH0KICBmdW5jdGlvbiBmcm9tQXJyYXlCdWZmZXIoYXJyYXksIGJ5dGVPZmZzZXQsIGxlbmd0aCkgewogICAgaWYgKGJ5dGVPZmZzZXQgPCAwIHx8IGFycmF5LmJ5dGVMZW5ndGggPCBieXRlT2Zmc2V0KSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCcib2Zmc2V0IiBpcyBvdXRzaWRlIG9mIGJ1ZmZlciBib3VuZHMnKTsKICAgIH0KICAgIGlmIChhcnJheS5ieXRlTGVuZ3RoIDwgYnl0ZU9mZnNldCArIChsZW5ndGggfHwgMCkpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJyJsZW5ndGgiIGlzIG91dHNpZGUgb2YgYnVmZmVyIGJvdW5kcycpOwogICAgfQogICAgbGV0IGJ1ZjsKICAgIGlmIChieXRlT2Zmc2V0ID09PSB2b2lkIDAgJiYgbGVuZ3RoID09PSB2b2lkIDApIHsKICAgICAgYnVmID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXkpOwogICAgfSBlbHNlIGlmIChsZW5ndGggPT09IHZvaWQgMCkgewogICAgICBidWYgPSBuZXcgVWludDhBcnJheShhcnJheSwgYnl0ZU9mZnNldCk7CiAgICB9IGVsc2UgewogICAgICBidWYgPSBuZXcgVWludDhBcnJheShhcnJheSwgYnl0ZU9mZnNldCwgbGVuZ3RoKTsKICAgIH0KICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZihidWYsIEJ1ZmZlcjIucHJvdG90eXBlKTsKICAgIHJldHVybiBidWY7CiAgfQogIGZ1bmN0aW9uIGZyb21PYmplY3Qob2JqKSB7CiAgICBpZiAoQnVmZmVyMi5pc0J1ZmZlcihvYmopKSB7CiAgICAgIGNvbnN0IGxlbiA9IGNoZWNrZWQob2JqLmxlbmd0aCkgfCAwOwogICAgICBjb25zdCBidWYgPSBjcmVhdGVCdWZmZXIobGVuKTsKICAgICAgaWYgKGJ1Zi5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gYnVmOwogICAgICB9CiAgICAgIG9iai5jb3B5KGJ1ZiwgMCwgMCwgbGVuKTsKICAgICAgcmV0dXJuIGJ1ZjsKICAgIH0KICAgIGlmIChvYmoubGVuZ3RoICE9PSB2b2lkIDApIHsKICAgICAgaWYgKHR5cGVvZiBvYmoubGVuZ3RoICE9PSAibnVtYmVyIiB8fCBOdW1iZXIuaXNOYU4ob2JqLmxlbmd0aCkpIHsKICAgICAgICByZXR1cm4gY3JlYXRlQnVmZmVyKDApOwogICAgICB9CiAgICAgIHJldHVybiBmcm9tQXJyYXlMaWtlKG9iaik7CiAgICB9CiAgICBpZiAob2JqLnR5cGUgPT09ICJCdWZmZXIiICYmIEFycmF5LmlzQXJyYXkob2JqLmRhdGEpKSB7CiAgICAgIHJldHVybiBmcm9tQXJyYXlMaWtlKG9iai5kYXRhKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gY2hlY2tlZChsZW5ndGgpIHsKICAgIGlmIChsZW5ndGggPj0gS19NQVhfTEVOR1RIKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJBdHRlbXB0IHRvIGFsbG9jYXRlIEJ1ZmZlciBsYXJnZXIgdGhhbiBtYXhpbXVtIHNpemU6IDB4IiArIEtfTUFYX0xFTkdUSC50b1N0cmluZygxNikgKyAiIGJ5dGVzIik7CiAgICB9CiAgICByZXR1cm4gbGVuZ3RoIHwgMDsKICB9CiAgQnVmZmVyMi5pc0J1ZmZlciA9IGZ1bmN0aW9uIGlzQnVmZmVyKGIpIHsKICAgIHJldHVybiBiICE9IG51bGwgJiYgYi5faXNCdWZmZXIgPT09IHRydWUgJiYgYiAhPT0gQnVmZmVyMi5wcm90b3R5cGU7CiAgfTsKICBCdWZmZXIyLmNvbXBhcmUgPSBmdW5jdGlvbiBjb21wYXJlKGEsIGIpIHsKICAgIGlmIChhIGluc3RhbmNlb2YgVWludDhBcnJheSkKICAgICAgYSA9IEJ1ZmZlcjIuZnJvbShhLCBhLm9mZnNldCwgYS5ieXRlTGVuZ3RoKTsKICAgIGlmIChiIGluc3RhbmNlb2YgVWludDhBcnJheSkKICAgICAgYiA9IEJ1ZmZlcjIuZnJvbShiLCBiLm9mZnNldCwgYi5ieXRlTGVuZ3RoKTsKICAgIGlmICghQnVmZmVyMi5pc0J1ZmZlcihhKSB8fCAhQnVmZmVyMi5pc0J1ZmZlcihiKSkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKAogICAgICAgICdUaGUgImJ1ZjEiLCAiYnVmMiIgYXJndW1lbnRzIG11c3QgYmUgb25lIG9mIHR5cGUgQnVmZmVyIG9yIFVpbnQ4QXJyYXknCiAgICAgICk7CiAgICB9CiAgICBpZiAoYSA9PT0gYikKICAgICAgcmV0dXJuIDA7CiAgICBsZXQgeCA9IGEubGVuZ3RoOwogICAgbGV0IHkgPSBiLmxlbmd0aDsKICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBNYXRoLm1pbih4LCB5KTsgaSA8IGxlbjsgKytpKSB7CiAgICAgIGlmIChhW2ldICE9PSBiW2ldKSB7CiAgICAgICAgeCA9IGFbaV07CiAgICAgICAgeSA9IGJbaV07CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIGlmICh4IDwgeSkKICAgICAgcmV0dXJuIC0xOwogICAgaWYgKHkgPCB4KQogICAgICByZXR1cm4gMTsKICAgIHJldHVybiAwOwogIH07CiAgQnVmZmVyMi5pc0VuY29kaW5nID0gZnVuY3Rpb24gaXNFbmNvZGluZyhlbmNvZGluZykgewogICAgc3dpdGNoIChTdHJpbmcoZW5jb2RpbmcpLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgY2FzZSAiaGV4IjoKICAgICAgY2FzZSAidXRmOCI6CiAgICAgIGNhc2UgInV0Zi04IjoKICAgICAgY2FzZSAiYXNjaWkiOgogICAgICBjYXNlICJsYXRpbjEiOgogICAgICBjYXNlICJiaW5hcnkiOgogICAgICBjYXNlICJiYXNlNjQiOgogICAgICBjYXNlICJ1Y3MyIjoKICAgICAgY2FzZSAidWNzLTIiOgogICAgICBjYXNlICJ1dGYxNmxlIjoKICAgICAgY2FzZSAidXRmLTE2bGUiOgogICAgICAgIHJldHVybiB0cnVlOwogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9OwogIEJ1ZmZlcjIuY29uY2F0ID0gZnVuY3Rpb24gY29uY2F0KGxpc3QsIGxlbmd0aCkgewogICAgaWYgKCFBcnJheS5pc0FycmF5KGxpc3QpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJsaXN0IiBhcmd1bWVudCBtdXN0IGJlIGFuIEFycmF5IG9mIEJ1ZmZlcnMnKTsKICAgIH0KICAgIGlmIChsaXN0Lmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gQnVmZmVyMi5hbGxvYygwKTsKICAgIH0KICAgIGxldCBpOwogICAgaWYgKGxlbmd0aCA9PT0gdm9pZCAwKSB7CiAgICAgIGxlbmd0aCA9IDA7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgKytpKSB7CiAgICAgICAgbGVuZ3RoICs9IGxpc3RbaV0ubGVuZ3RoOwogICAgICB9CiAgICB9CiAgICBjb25zdCBidWZmZXIgPSBCdWZmZXIyLmFsbG9jVW5zYWZlKGxlbmd0aCk7CiAgICBsZXQgcG9zID0gMDsKICAgIGZvciAoaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgKytpKSB7CiAgICAgIGxldCBidWYgPSBsaXN0W2ldOwogICAgICBpZiAoYnVmIGluc3RhbmNlb2YgVWludDhBcnJheSkgewogICAgICAgIGlmIChwb3MgKyBidWYubGVuZ3RoID4gYnVmZmVyLmxlbmd0aCkgewogICAgICAgICAgaWYgKCFCdWZmZXIyLmlzQnVmZmVyKGJ1ZikpIHsKICAgICAgICAgICAgYnVmID0gQnVmZmVyMi5mcm9tKGJ1Zi5idWZmZXIsIGJ1Zi5ieXRlT2Zmc2V0LCBidWYuYnl0ZUxlbmd0aCk7CiAgICAgICAgICB9CiAgICAgICAgICBidWYuY29weShidWZmZXIsIHBvcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIFVpbnQ4QXJyYXkucHJvdG90eXBlLnNldC5jYWxsKAogICAgICAgICAgICBidWZmZXIsCiAgICAgICAgICAgIGJ1ZiwKICAgICAgICAgICAgcG9zCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICghQnVmZmVyMi5pc0J1ZmZlcihidWYpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignImxpc3QiIGFyZ3VtZW50IG11c3QgYmUgYW4gQXJyYXkgb2YgQnVmZmVycycpOwogICAgICB9IGVsc2UgewogICAgICAgIGJ1Zi5jb3B5KGJ1ZmZlciwgcG9zKTsKICAgICAgfQogICAgICBwb3MgKz0gYnVmLmxlbmd0aDsKICAgIH0KICAgIHJldHVybiBidWZmZXI7CiAgfTsKICBmdW5jdGlvbiBieXRlTGVuZ3RoKHN0cmluZywgZW5jb2RpbmcpIHsKICAgIGlmIChCdWZmZXIyLmlzQnVmZmVyKHN0cmluZykpIHsKICAgICAgcmV0dXJuIHN0cmluZy5sZW5ndGg7CiAgICB9CiAgICBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KHN0cmluZykgfHwgc3RyaW5nIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpIHsKICAgICAgcmV0dXJuIHN0cmluZy5ieXRlTGVuZ3RoOwogICAgfQogICAgaWYgKHR5cGVvZiBzdHJpbmcgIT09ICJzdHJpbmciKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoCiAgICAgICAgJ1RoZSAic3RyaW5nIiBhcmd1bWVudCBtdXN0IGJlIG9uZSBvZiB0eXBlIHN0cmluZywgQnVmZmVyLCBvciBBcnJheUJ1ZmZlci4gUmVjZWl2ZWQgdHlwZSAnICsgdHlwZW9mIHN0cmluZwogICAgICApOwogICAgfQogICAgY29uc3QgbGVuID0gc3RyaW5nLmxlbmd0aDsKICAgIGNvbnN0IG11c3RNYXRjaCA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSA9PT0gdHJ1ZTsKICAgIGlmICghbXVzdE1hdGNoICYmIGxlbiA9PT0gMCkKICAgICAgcmV0dXJuIDA7CiAgICBsZXQgbG93ZXJlZENhc2UgPSBmYWxzZTsKICAgIGZvciAoOyA7ICkgewogICAgICBzd2l0Y2ggKGVuY29kaW5nKSB7CiAgICAgICAgY2FzZSAiYXNjaWkiOgogICAgICAgIGNhc2UgImxhdGluMSI6CiAgICAgICAgY2FzZSAiYmluYXJ5IjoKICAgICAgICAgIHJldHVybiBsZW47CiAgICAgICAgY2FzZSAidXRmOCI6CiAgICAgICAgY2FzZSAidXRmLTgiOgogICAgICAgICAgcmV0dXJuIHV0ZjhUb0J5dGVzKHN0cmluZykubGVuZ3RoOwogICAgICAgIGNhc2UgInVjczIiOgogICAgICAgIGNhc2UgInVjcy0yIjoKICAgICAgICBjYXNlICJ1dGYxNmxlIjoKICAgICAgICBjYXNlICJ1dGYtMTZsZSI6CiAgICAgICAgICByZXR1cm4gbGVuICogMjsKICAgICAgICBjYXNlICJoZXgiOgogICAgICAgICAgcmV0dXJuIGxlbiA+Pj4gMTsKICAgICAgICBjYXNlICJiYXNlNjQiOgogICAgICAgICAgcmV0dXJuIGJhc2U2NFRvQnl0ZXMoc3RyaW5nKS5sZW5ndGg7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGlmIChsb3dlcmVkQ2FzZSkgewogICAgICAgICAgICByZXR1cm4gbXVzdE1hdGNoID8gLTEgOiB1dGY4VG9CeXRlcyhzdHJpbmcpLmxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICAgIGVuY29kaW5nID0gKCIiICsgZW5jb2RpbmcpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICBsb3dlcmVkQ2FzZSA9IHRydWU7CiAgICAgIH0KICAgIH0KICB9CiAgQnVmZmVyMi5ieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aDsKICBmdW5jdGlvbiBzbG93VG9TdHJpbmcoZW5jb2RpbmcsIHN0YXJ0LCBlbmQpIHsKICAgIGxldCBsb3dlcmVkQ2FzZSA9IGZhbHNlOwogICAgaWYgKHN0YXJ0ID09PSB2b2lkIDAgfHwgc3RhcnQgPCAwKSB7CiAgICAgIHN0YXJ0ID0gMDsKICAgIH0KICAgIGlmIChzdGFydCA+IHRoaXMubGVuZ3RoKSB7CiAgICAgIHJldHVybiAiIjsKICAgIH0KICAgIGlmIChlbmQgPT09IHZvaWQgMCB8fCBlbmQgPiB0aGlzLmxlbmd0aCkgewogICAgICBlbmQgPSB0aGlzLmxlbmd0aDsKICAgIH0KICAgIGlmIChlbmQgPD0gMCkgewogICAgICByZXR1cm4gIiI7CiAgICB9CiAgICBlbmQgPj4+PSAwOwogICAgc3RhcnQgPj4+PSAwOwogICAgaWYgKGVuZCA8PSBzdGFydCkgewogICAgICByZXR1cm4gIiI7CiAgICB9CiAgICBpZiAoIWVuY29kaW5nKQogICAgICBlbmNvZGluZyA9ICJ1dGY4IjsKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIHN3aXRjaCAoZW5jb2RpbmcpIHsKICAgICAgICBjYXNlICJoZXgiOgogICAgICAgICAgcmV0dXJuIGhleFNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpOwogICAgICAgIGNhc2UgInV0ZjgiOgogICAgICAgIGNhc2UgInV0Zi04IjoKICAgICAgICAgIHJldHVybiB1dGY4U2xpY2UodGhpcywgc3RhcnQsIGVuZCk7CiAgICAgICAgY2FzZSAiYXNjaWkiOgogICAgICAgICAgcmV0dXJuIGFzY2lpU2xpY2UodGhpcywgc3RhcnQsIGVuZCk7CiAgICAgICAgY2FzZSAibGF0aW4xIjoKICAgICAgICBjYXNlICJiaW5hcnkiOgogICAgICAgICAgcmV0dXJuIGxhdGluMVNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpOwogICAgICAgIGNhc2UgImJhc2U2NCI6CiAgICAgICAgICByZXR1cm4gYmFzZTY0U2xpY2UodGhpcywgc3RhcnQsIGVuZCk7CiAgICAgICAgY2FzZSAidWNzMiI6CiAgICAgICAgY2FzZSAidWNzLTIiOgogICAgICAgIGNhc2UgInV0ZjE2bGUiOgogICAgICAgIGNhc2UgInV0Zi0xNmxlIjoKICAgICAgICAgIHJldHVybiB1dGYxNmxlU2xpY2UodGhpcywgc3RhcnQsIGVuZCk7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGlmIChsb3dlcmVkQ2FzZSkKICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVW5rbm93biBlbmNvZGluZzogIiArIGVuY29kaW5nKTsKICAgICAgICAgIGVuY29kaW5nID0gKGVuY29kaW5nICsgIiIpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICBsb3dlcmVkQ2FzZSA9IHRydWU7CiAgICAgIH0KICAgIH0KICB9CiAgQnVmZmVyMi5wcm90b3R5cGUuX2lzQnVmZmVyID0gdHJ1ZTsKICBmdW5jdGlvbiBzd2FwKGIsIG4sIG0pIHsKICAgIGNvbnN0IGkgPSBiW25dOwogICAgYltuXSA9IGJbbV07CiAgICBiW21dID0gaTsKICB9CiAgQnVmZmVyMi5wcm90b3R5cGUuc3dhcDE2ID0gZnVuY3Rpb24gc3dhcDE2KCkgewogICAgY29uc3QgbGVuID0gdGhpcy5sZW5ndGg7CiAgICBpZiAobGVuICUgMiAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiQnVmZmVyIHNpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2LWJpdHMiKTsKICAgIH0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpICs9IDIpIHsKICAgICAgc3dhcCh0aGlzLCBpLCBpICsgMSk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9OwogIEJ1ZmZlcjIucHJvdG90eXBlLnN3YXAzMiA9IGZ1bmN0aW9uIHN3YXAzMigpIHsKICAgIGNvbnN0IGxlbiA9IHRoaXMubGVuZ3RoOwogICAgaWYgKGxlbiAlIDQgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkJ1ZmZlciBzaXplIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAzMi1iaXRzIik7CiAgICB9CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSArPSA0KSB7CiAgICAgIHN3YXAodGhpcywgaSwgaSArIDMpOwogICAgICBzd2FwKHRoaXMsIGkgKyAxLCBpICsgMik7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9OwogIEJ1ZmZlcjIucHJvdG90eXBlLnN3YXA2NCA9IGZ1bmN0aW9uIHN3YXA2NCgpIHsKICAgIGNvbnN0IGxlbiA9IHRoaXMubGVuZ3RoOwogICAgaWYgKGxlbiAlIDggIT09IDApIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkJ1ZmZlciBzaXplIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA2NC1iaXRzIik7CiAgICB9CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSArPSA4KSB7CiAgICAgIHN3YXAodGhpcywgaSwgaSArIDcpOwogICAgICBzd2FwKHRoaXMsIGkgKyAxLCBpICsgNik7CiAgICAgIHN3YXAodGhpcywgaSArIDIsIGkgKyA1KTsKICAgICAgc3dhcCh0aGlzLCBpICsgMywgaSArIDQpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfTsKICBCdWZmZXIyLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uIHRvU3RyaW5nKCkgewogICAgY29uc3QgbGVuZ3RoID0gdGhpcy5sZW5ndGg7CiAgICBpZiAobGVuZ3RoID09PSAwKQogICAgICByZXR1cm4gIiI7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkKICAgICAgcmV0dXJuIHV0ZjhTbGljZSh0aGlzLCAwLCBsZW5ndGgpOwogICAgcmV0dXJuIHNsb3dUb1N0cmluZy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CiAgQnVmZmVyMi5wcm90b3R5cGUudG9Mb2NhbGVTdHJpbmcgPSBCdWZmZXIyLnByb3RvdHlwZS50b1N0cmluZzsKICBCdWZmZXIyLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbiBlcXVhbHMoYikgewogICAgaWYgKCFCdWZmZXIyLmlzQnVmZmVyKGIpKQogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJBcmd1bWVudCBtdXN0IGJlIGEgQnVmZmVyIik7CiAgICBpZiAodGhpcyA9PT0gYikKICAgICAgcmV0dXJuIHRydWU7CiAgICByZXR1cm4gQnVmZmVyMi5jb21wYXJlKHRoaXMsIGIpID09PSAwOwogIH07CiAgQnVmZmVyMi5wcm90b3R5cGUuaW5zcGVjdCA9IGZ1bmN0aW9uIGluc3BlY3QoKSB7CiAgICBsZXQgc3RyID0gIiI7CiAgICBjb25zdCBtYXggPSBjb25maWcuSU5TUEVDVF9NQVhfQllURVM7CiAgICBzdHIgPSB0aGlzLnRvU3RyaW5nKCJoZXgiLCAwLCBtYXgpLnJlcGxhY2UoLyguezJ9KS9nLCAiJDEgIikudHJpbSgpOwogICAgaWYgKHRoaXMubGVuZ3RoID4gbWF4KQogICAgICBzdHIgKz0gIiAuLi4gIjsKICAgIHJldHVybiAiPEJ1ZmZlciAiICsgc3RyICsgIj4iOwogIH07CiAgQnVmZmVyMi5wcm90b3R5cGVbU3ltYm9sLmZvcigibm9kZWpzLnV0aWwuaW5zcGVjdC5jdXN0b20iKV0gPSBCdWZmZXIyLnByb3RvdHlwZS5pbnNwZWN0OwogIEJ1ZmZlcjIucHJvdG90eXBlLmNvbXBhcmUgPSBmdW5jdGlvbiBjb21wYXJlMih0YXJnZXQsIHN0YXJ0LCBlbmQsIHRoaXNTdGFydCwgdGhpc0VuZCkgewogICAgaWYgKHRhcmdldCBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpIHsKICAgICAgdGFyZ2V0ID0gQnVmZmVyMi5mcm9tKHRhcmdldCwgdGFyZ2V0Lm9mZnNldCwgdGFyZ2V0LmJ5dGVMZW5ndGgpOwogICAgfQogICAgaWYgKCFCdWZmZXIyLmlzQnVmZmVyKHRhcmdldCkpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigKICAgICAgICAnVGhlICJ0YXJnZXQiIGFyZ3VtZW50IG11c3QgYmUgb25lIG9mIHR5cGUgQnVmZmVyIG9yIFVpbnQ4QXJyYXkuIFJlY2VpdmVkIHR5cGUgJyArIHR5cGVvZiB0YXJnZXQKICAgICAgKTsKICAgIH0KICAgIGlmIChzdGFydCA9PT0gdm9pZCAwKSB7CiAgICAgIHN0YXJ0ID0gMDsKICAgIH0KICAgIGlmIChlbmQgPT09IHZvaWQgMCkgewogICAgICBlbmQgPSB0YXJnZXQgPyB0YXJnZXQubGVuZ3RoIDogMDsKICAgIH0KICAgIGlmICh0aGlzU3RhcnQgPT09IHZvaWQgMCkgewogICAgICB0aGlzU3RhcnQgPSAwOwogICAgfQogICAgaWYgKHRoaXNFbmQgPT09IHZvaWQgMCkgewogICAgICB0aGlzRW5kID0gdGhpcy5sZW5ndGg7CiAgICB9CiAgICBpZiAoc3RhcnQgPCAwIHx8IGVuZCA+IHRhcmdldC5sZW5ndGggfHwgdGhpc1N0YXJ0IDwgMCB8fCB0aGlzRW5kID4gdGhpcy5sZW5ndGgpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIm91dCBvZiByYW5nZSBpbmRleCIpOwogICAgfQogICAgaWYgKHRoaXNTdGFydCA+PSB0aGlzRW5kICYmIHN0YXJ0ID49IGVuZCkgewogICAgICByZXR1cm4gMDsKICAgIH0KICAgIGlmICh0aGlzU3RhcnQgPj0gdGhpc0VuZCkgewogICAgICByZXR1cm4gLTE7CiAgICB9CiAgICBpZiAoc3RhcnQgPj0gZW5kKSB7CiAgICAgIHJldHVybiAxOwogICAgfQogICAgc3RhcnQgPj4+PSAwOwogICAgZW5kID4+Pj0gMDsKICAgIHRoaXNTdGFydCA+Pj49IDA7CiAgICB0aGlzRW5kID4+Pj0gMDsKICAgIGlmICh0aGlzID09PSB0YXJnZXQpCiAgICAgIHJldHVybiAwOwogICAgbGV0IHggPSB0aGlzRW5kIC0gdGhpc1N0YXJ0OwogICAgbGV0IHkgPSBlbmQgLSBzdGFydDsKICAgIGNvbnN0IGxlbiA9IE1hdGgubWluKHgsIHkpOwogICAgY29uc3QgdGhpc0NvcHkgPSB0aGlzLnNsaWNlKHRoaXNTdGFydCwgdGhpc0VuZCk7CiAgICBjb25zdCB0YXJnZXRDb3B5ID0gdGFyZ2V0LnNsaWNlKHN0YXJ0LCBlbmQpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICBpZiAodGhpc0NvcHlbaV0gIT09IHRhcmdldENvcHlbaV0pIHsKICAgICAgICB4ID0gdGhpc0NvcHlbaV07CiAgICAgICAgeSA9IHRhcmdldENvcHlbaV07CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIGlmICh4IDwgeSkKICAgICAgcmV0dXJuIC0xOwogICAgaWYgKHkgPCB4KQogICAgICByZXR1cm4gMTsKICAgIHJldHVybiAwOwogIH07CiAgZnVuY3Rpb24gYmlkaXJlY3Rpb25hbEluZGV4T2YoYnVmZmVyLCB2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCBkaXIpIHsKICAgIGlmIChidWZmZXIubGVuZ3RoID09PSAwKQogICAgICByZXR1cm4gLTE7CiAgICBpZiAodHlwZW9mIGJ5dGVPZmZzZXQgPT09ICJzdHJpbmciKSB7CiAgICAgIGVuY29kaW5nID0gYnl0ZU9mZnNldDsKICAgICAgYnl0ZU9mZnNldCA9IDA7CiAgICB9IGVsc2UgaWYgKGJ5dGVPZmZzZXQgPiAyMTQ3NDgzNjQ3KSB7CiAgICAgIGJ5dGVPZmZzZXQgPSAyMTQ3NDgzNjQ3OwogICAgfSBlbHNlIGlmIChieXRlT2Zmc2V0IDwgLTIxNDc0ODM2NDgpIHsKICAgICAgYnl0ZU9mZnNldCA9IC0yMTQ3NDgzNjQ4OwogICAgfQogICAgYnl0ZU9mZnNldCA9ICtieXRlT2Zmc2V0OwogICAgaWYgKE51bWJlci5pc05hTihieXRlT2Zmc2V0KSkgewogICAgICBieXRlT2Zmc2V0ID0gZGlyID8gMCA6IGJ1ZmZlci5sZW5ndGggLSAxOwogICAgfQogICAgaWYgKGJ5dGVPZmZzZXQgPCAwKQogICAgICBieXRlT2Zmc2V0ID0gYnVmZmVyLmxlbmd0aCArIGJ5dGVPZmZzZXQ7CiAgICBpZiAoYnl0ZU9mZnNldCA+PSBidWZmZXIubGVuZ3RoKSB7CiAgICAgIGlmIChkaXIpCiAgICAgICAgcmV0dXJuIC0xOwogICAgICBlbHNlCiAgICAgICAgYnl0ZU9mZnNldCA9IGJ1ZmZlci5sZW5ndGggLSAxOwogICAgfSBlbHNlIGlmIChieXRlT2Zmc2V0IDwgMCkgewogICAgICBpZiAoZGlyKQogICAgICAgIGJ5dGVPZmZzZXQgPSAwOwogICAgICBlbHNlCiAgICAgICAgcmV0dXJuIC0xOwogICAgfQogICAgaWYgKHR5cGVvZiB2YWwgPT09ICJzdHJpbmciKSB7CiAgICAgIHZhbCA9IEJ1ZmZlcjIuZnJvbSh2YWwsIGVuY29kaW5nKTsKICAgIH0KICAgIGlmIChCdWZmZXIyLmlzQnVmZmVyKHZhbCkpIHsKICAgICAgaWYgKHZhbC5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gLTE7CiAgICAgIH0KICAgICAgcmV0dXJuIGFycmF5SW5kZXhPZihidWZmZXIsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIGRpcik7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWwgPT09ICJudW1iZXIiKSB7CiAgICAgIHZhbCA9IHZhbCAmIDI1NTsKICAgICAgaWYgKHR5cGVvZiBVaW50OEFycmF5LnByb3RvdHlwZS5pbmRleE9mID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgaWYgKGRpcikgewogICAgICAgICAgcmV0dXJuIFVpbnQ4QXJyYXkucHJvdG90eXBlLmluZGV4T2YuY2FsbChidWZmZXIsIHZhbCwgYnl0ZU9mZnNldCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBVaW50OEFycmF5LnByb3RvdHlwZS5sYXN0SW5kZXhPZi5jYWxsKGJ1ZmZlciwgdmFsLCBieXRlT2Zmc2V0KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGFycmF5SW5kZXhPZihidWZmZXIsIFt2YWxdLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgZGlyKTsKICAgIH0KICAgIHRocm93IG5ldyBUeXBlRXJyb3IoInZhbCBtdXN0IGJlIHN0cmluZywgbnVtYmVyIG9yIEJ1ZmZlciIpOwogIH0KICBmdW5jdGlvbiBhcnJheUluZGV4T2YoYXJyLCB2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCBkaXIpIHsKICAgIGxldCBpbmRleFNpemUgPSAxOwogICAgbGV0IGFyckxlbmd0aCA9IGFyci5sZW5ndGg7CiAgICBsZXQgdmFsTGVuZ3RoID0gdmFsLmxlbmd0aDsKICAgIGlmIChlbmNvZGluZyAhPT0gdm9pZCAwKSB7CiAgICAgIGVuY29kaW5nID0gU3RyaW5nKGVuY29kaW5nKS50b0xvd2VyQ2FzZSgpOwogICAgICBpZiAoZW5jb2RpbmcgPT09ICJ1Y3MyIiB8fCBlbmNvZGluZyA9PT0gInVjcy0yIiB8fCBlbmNvZGluZyA9PT0gInV0ZjE2bGUiIHx8IGVuY29kaW5nID09PSAidXRmLTE2bGUiKSB7CiAgICAgICAgaWYgKGFyci5sZW5ndGggPCAyIHx8IHZhbC5sZW5ndGggPCAyKSB7CiAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgICAgIGluZGV4U2l6ZSA9IDI7CiAgICAgICAgYXJyTGVuZ3RoIC89IDI7CiAgICAgICAgdmFsTGVuZ3RoIC89IDI7CiAgICAgICAgYnl0ZU9mZnNldCAvPSAyOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiByZWFkMihidWYsIGkyKSB7CiAgICAgIGlmIChpbmRleFNpemUgPT09IDEpIHsKICAgICAgICByZXR1cm4gYnVmW2kyXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gYnVmLnJlYWRVSW50MTZCRShpMiAqIGluZGV4U2l6ZSk7CiAgICAgIH0KICAgIH0KICAgIGxldCBpOwogICAgaWYgKGRpcikgewogICAgICBsZXQgZm91bmRJbmRleCA9IC0xOwogICAgICBmb3IgKGkgPSBieXRlT2Zmc2V0OyBpIDwgYXJyTGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAocmVhZDIoYXJyLCBpKSA9PT0gcmVhZDIodmFsLCBmb3VuZEluZGV4ID09PSAtMSA/IDAgOiBpIC0gZm91bmRJbmRleCkpIHsKICAgICAgICAgIGlmIChmb3VuZEluZGV4ID09PSAtMSkKICAgICAgICAgICAgZm91bmRJbmRleCA9IGk7CiAgICAgICAgICBpZiAoaSAtIGZvdW5kSW5kZXggKyAxID09PSB2YWxMZW5ndGgpCiAgICAgICAgICAgIHJldHVybiBmb3VuZEluZGV4ICogaW5kZXhTaXplOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoZm91bmRJbmRleCAhPT0gLTEpCiAgICAgICAgICAgIGkgLT0gaSAtIGZvdW5kSW5kZXg7CiAgICAgICAgICBmb3VuZEluZGV4ID0gLTE7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoYnl0ZU9mZnNldCArIHZhbExlbmd0aCA+IGFyckxlbmd0aCkKICAgICAgICBieXRlT2Zmc2V0ID0gYXJyTGVuZ3RoIC0gdmFsTGVuZ3RoOwogICAgICBmb3IgKGkgPSBieXRlT2Zmc2V0OyBpID49IDA7IGktLSkgewogICAgICAgIGxldCBmb3VuZCA9IHRydWU7CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB2YWxMZW5ndGg7IGorKykgewogICAgICAgICAgaWYgKHJlYWQyKGFyciwgaSArIGopICE9PSByZWFkMih2YWwsIGopKSB7CiAgICAgICAgICAgIGZvdW5kID0gZmFsc2U7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZm91bmQpCiAgICAgICAgICByZXR1cm4gaTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIC0xOwogIH0KICBCdWZmZXIyLnByb3RvdHlwZS5pbmNsdWRlcyA9IGZ1bmN0aW9uIGluY2x1ZGVzKHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcpIHsKICAgIHJldHVybiB0aGlzLmluZGV4T2YodmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgIT09IC0xOwogIH07CiAgQnVmZmVyMi5wcm90b3R5cGUuaW5kZXhPZiA9IGZ1bmN0aW9uIGluZGV4T2YodmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgewogICAgcmV0dXJuIGJpZGlyZWN0aW9uYWxJbmRleE9mKHRoaXMsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIHRydWUpOwogIH07CiAgQnVmZmVyMi5wcm90b3R5cGUubGFzdEluZGV4T2YgPSBmdW5jdGlvbiBsYXN0SW5kZXhPZih2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nKSB7CiAgICByZXR1cm4gYmlkaXJlY3Rpb25hbEluZGV4T2YodGhpcywgdmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgZmFsc2UpOwogIH07CiAgZnVuY3Rpb24gaGV4V3JpdGUoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgICBvZmZzZXQgPSBOdW1iZXIob2Zmc2V0KSB8fCAwOwogICAgY29uc3QgcmVtYWluaW5nID0gYnVmLmxlbmd0aCAtIG9mZnNldDsKICAgIGlmICghbGVuZ3RoKSB7CiAgICAgIGxlbmd0aCA9IHJlbWFpbmluZzsKICAgIH0gZWxzZSB7CiAgICAgIGxlbmd0aCA9IE51bWJlcihsZW5ndGgpOwogICAgICBpZiAobGVuZ3RoID4gcmVtYWluaW5nKSB7CiAgICAgICAgbGVuZ3RoID0gcmVtYWluaW5nOwogICAgICB9CiAgICB9CiAgICBjb25zdCBzdHJMZW4gPSBzdHJpbmcubGVuZ3RoOwogICAgaWYgKGxlbmd0aCA+IHN0ckxlbiAvIDIpIHsKICAgICAgbGVuZ3RoID0gc3RyTGVuIC8gMjsKICAgIH0KICAgIGxldCBpOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IHBhcnNlZCA9IHBhcnNlSW50KHN0cmluZy5zdWJzdHIoaSAqIDIsIDIpLCAxNik7CiAgICAgIGlmIChOdW1iZXIuaXNOYU4ocGFyc2VkKSkKICAgICAgICByZXR1cm4gaTsKICAgICAgYnVmW29mZnNldCArIGldID0gcGFyc2VkOwogICAgfQogICAgcmV0dXJuIGk7CiAgfQogIGZ1bmN0aW9uIHV0ZjhXcml0ZShidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICAgIHJldHVybiBibGl0QnVmZmVyKHV0ZjhUb0J5dGVzKHN0cmluZywgYnVmLmxlbmd0aCAtIG9mZnNldCksIGJ1Ziwgb2Zmc2V0LCBsZW5ndGgpOwogIH0KICBmdW5jdGlvbiBhc2NpaVdyaXRlKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogICAgcmV0dXJuIGJsaXRCdWZmZXIoYXNjaWlUb0J5dGVzKHN0cmluZyksIGJ1Ziwgb2Zmc2V0LCBsZW5ndGgpOwogIH0KICBmdW5jdGlvbiBiYXNlNjRXcml0ZShidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICAgIHJldHVybiBibGl0QnVmZmVyKGJhc2U2NFRvQnl0ZXMoc3RyaW5nKSwgYnVmLCBvZmZzZXQsIGxlbmd0aCk7CiAgfQogIGZ1bmN0aW9uIHVjczJXcml0ZShidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICAgIHJldHVybiBibGl0QnVmZmVyKHV0ZjE2bGVUb0J5dGVzKHN0cmluZywgYnVmLmxlbmd0aCAtIG9mZnNldCksIGJ1Ziwgb2Zmc2V0LCBsZW5ndGgpOwogIH0KICBCdWZmZXIyLnByb3RvdHlwZS53cml0ZSA9IGZ1bmN0aW9uIHdyaXRlMihzdHJpbmcsIG9mZnNldCwgbGVuZ3RoLCBlbmNvZGluZykgewogICAgaWYgKG9mZnNldCA9PT0gdm9pZCAwKSB7CiAgICAgIGVuY29kaW5nID0gInV0ZjgiOwogICAgICBsZW5ndGggPSB0aGlzLmxlbmd0aDsKICAgICAgb2Zmc2V0ID0gMDsKICAgIH0gZWxzZSBpZiAobGVuZ3RoID09PSB2b2lkIDAgJiYgdHlwZW9mIG9mZnNldCA9PT0gInN0cmluZyIpIHsKICAgICAgZW5jb2RpbmcgPSBvZmZzZXQ7CiAgICAgIGxlbmd0aCA9IHRoaXMubGVuZ3RoOwogICAgICBvZmZzZXQgPSAwOwogICAgfSBlbHNlIGlmIChpc0Zpbml0ZShvZmZzZXQpKSB7CiAgICAgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKICAgICAgaWYgKGlzRmluaXRlKGxlbmd0aCkpIHsKICAgICAgICBsZW5ndGggPSBsZW5ndGggPj4+IDA7CiAgICAgICAgaWYgKGVuY29kaW5nID09PSB2b2lkIDApCiAgICAgICAgICBlbmNvZGluZyA9ICJ1dGY4IjsKICAgICAgfSBlbHNlIHsKICAgICAgICBlbmNvZGluZyA9IGxlbmd0aDsKICAgICAgICBsZW5ndGggPSB2b2lkIDA7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAiQnVmZmVyLndyaXRlKHN0cmluZywgZW5jb2RpbmcsIG9mZnNldFssIGxlbmd0aF0pIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQiCiAgICAgICk7CiAgICB9CiAgICBjb25zdCByZW1haW5pbmcgPSB0aGlzLmxlbmd0aCAtIG9mZnNldDsKICAgIGlmIChsZW5ndGggPT09IHZvaWQgMCB8fCBsZW5ndGggPiByZW1haW5pbmcpCiAgICAgIGxlbmd0aCA9IHJlbWFpbmluZzsKICAgIGlmIChzdHJpbmcubGVuZ3RoID4gMCAmJiAobGVuZ3RoIDwgMCB8fCBvZmZzZXQgPCAwKSB8fCBvZmZzZXQgPiB0aGlzLmxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiQXR0ZW1wdCB0byB3cml0ZSBvdXRzaWRlIGJ1ZmZlciBib3VuZHMiKTsKICAgIH0KICAgIGlmICghZW5jb2RpbmcpCiAgICAgIGVuY29kaW5nID0gInV0ZjgiOwogICAgbGV0IGxvd2VyZWRDYXNlID0gZmFsc2U7CiAgICBmb3IgKDsgOyApIHsKICAgICAgc3dpdGNoIChlbmNvZGluZykgewogICAgICAgIGNhc2UgImhleCI6CiAgICAgICAgICByZXR1cm4gaGV4V3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCk7CiAgICAgICAgY2FzZSAidXRmOCI6CiAgICAgICAgY2FzZSAidXRmLTgiOgogICAgICAgICAgcmV0dXJuIHV0ZjhXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKTsKICAgICAgICBjYXNlICJhc2NpaSI6CiAgICAgICAgY2FzZSAibGF0aW4xIjoKICAgICAgICBjYXNlICJiaW5hcnkiOgogICAgICAgICAgcmV0dXJuIGFzY2lpV3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCk7CiAgICAgICAgY2FzZSAiYmFzZTY0IjoKICAgICAgICAgIHJldHVybiBiYXNlNjRXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKTsKICAgICAgICBjYXNlICJ1Y3MyIjoKICAgICAgICBjYXNlICJ1Y3MtMiI6CiAgICAgICAgY2FzZSAidXRmMTZsZSI6CiAgICAgICAgY2FzZSAidXRmLTE2bGUiOgogICAgICAgICAgcmV0dXJuIHVjczJXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKTsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgaWYgKGxvd2VyZWRDYXNlKQogICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJVbmtub3duIGVuY29kaW5nOiAiICsgZW5jb2RpbmcpOwogICAgICAgICAgZW5jb2RpbmcgPSAoIiIgKyBlbmNvZGluZykudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIGxvd2VyZWRDYXNlID0gdHJ1ZTsKICAgICAgfQogICAgfQogIH07CiAgQnVmZmVyMi5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24gdG9KU09OKCkgewogICAgcmV0dXJuIHsKICAgICAgdHlwZTogIkJ1ZmZlciIsCiAgICAgIGRhdGE6IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKHRoaXMuX2FyciB8fCB0aGlzLCAwKQogICAgfTsKICB9OwogIGZ1bmN0aW9uIGJhc2U2NFNsaWNlKGJ1Ziwgc3RhcnQsIGVuZCkgewogICAgaWYgKHN0YXJ0ID09PSAwICYmIGVuZCA9PT0gYnVmLmxlbmd0aCkgewogICAgICByZXR1cm4gYmFzZTY0LmZyb21CeXRlQXJyYXkoYnVmKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBiYXNlNjQuZnJvbUJ5dGVBcnJheShidWYuc2xpY2Uoc3RhcnQsIGVuZCkpOwogICAgfQogIH0KICBmdW5jdGlvbiB1dGY4U2xpY2UoYnVmLCBzdGFydCwgZW5kKSB7CiAgICBlbmQgPSBNYXRoLm1pbihidWYubGVuZ3RoLCBlbmQpOwogICAgY29uc3QgcmVzID0gW107CiAgICBsZXQgaSA9IHN0YXJ0OwogICAgd2hpbGUgKGkgPCBlbmQpIHsKICAgICAgY29uc3QgZmlyc3RCeXRlID0gYnVmW2ldOwogICAgICBsZXQgY29kZVBvaW50ID0gbnVsbDsKICAgICAgbGV0IGJ5dGVzUGVyU2VxdWVuY2UgPSBmaXJzdEJ5dGUgPiAyMzkgPyA0IDogZmlyc3RCeXRlID4gMjIzID8gMyA6IGZpcnN0Qnl0ZSA+IDE5MSA/IDIgOiAxOwogICAgICBpZiAoaSArIGJ5dGVzUGVyU2VxdWVuY2UgPD0gZW5kKSB7CiAgICAgICAgbGV0IHNlY29uZEJ5dGUsIHRoaXJkQnl0ZSwgZm91cnRoQnl0ZSwgdGVtcENvZGVQb2ludDsKICAgICAgICBzd2l0Y2ggKGJ5dGVzUGVyU2VxdWVuY2UpIHsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgaWYgKGZpcnN0Qnl0ZSA8IDEyOCkgewogICAgICAgICAgICAgIGNvZGVQb2ludCA9IGZpcnN0Qnl0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgc2Vjb25kQnl0ZSA9IGJ1ZltpICsgMV07CiAgICAgICAgICAgIGlmICgoc2Vjb25kQnl0ZSAmIDE5MikgPT09IDEyOCkgewogICAgICAgICAgICAgIHRlbXBDb2RlUG9pbnQgPSAoZmlyc3RCeXRlICYgMzEpIDw8IDYgfCBzZWNvbmRCeXRlICYgNjM7CiAgICAgICAgICAgICAgaWYgKHRlbXBDb2RlUG9pbnQgPiAxMjcpIHsKICAgICAgICAgICAgICAgIGNvZGVQb2ludCA9IHRlbXBDb2RlUG9pbnQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICBzZWNvbmRCeXRlID0gYnVmW2kgKyAxXTsKICAgICAgICAgICAgdGhpcmRCeXRlID0gYnVmW2kgKyAyXTsKICAgICAgICAgICAgaWYgKChzZWNvbmRCeXRlICYgMTkyKSA9PT0gMTI4ICYmICh0aGlyZEJ5dGUgJiAxOTIpID09PSAxMjgpIHsKICAgICAgICAgICAgICB0ZW1wQ29kZVBvaW50ID0gKGZpcnN0Qnl0ZSAmIDE1KSA8PCAxMiB8IChzZWNvbmRCeXRlICYgNjMpIDw8IDYgfCB0aGlyZEJ5dGUgJiA2MzsKICAgICAgICAgICAgICBpZiAodGVtcENvZGVQb2ludCA+IDIwNDcgJiYgKHRlbXBDb2RlUG9pbnQgPCA1NTI5NiB8fCB0ZW1wQ29kZVBvaW50ID4gNTczNDMpKSB7CiAgICAgICAgICAgICAgICBjb2RlUG9pbnQgPSB0ZW1wQ29kZVBvaW50OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgc2Vjb25kQnl0ZSA9IGJ1ZltpICsgMV07CiAgICAgICAgICAgIHRoaXJkQnl0ZSA9IGJ1ZltpICsgMl07CiAgICAgICAgICAgIGZvdXJ0aEJ5dGUgPSBidWZbaSArIDNdOwogICAgICAgICAgICBpZiAoKHNlY29uZEJ5dGUgJiAxOTIpID09PSAxMjggJiYgKHRoaXJkQnl0ZSAmIDE5MikgPT09IDEyOCAmJiAoZm91cnRoQnl0ZSAmIDE5MikgPT09IDEyOCkgewogICAgICAgICAgICAgIHRlbXBDb2RlUG9pbnQgPSAoZmlyc3RCeXRlICYgMTUpIDw8IDE4IHwgKHNlY29uZEJ5dGUgJiA2MykgPDwgMTIgfCAodGhpcmRCeXRlICYgNjMpIDw8IDYgfCBmb3VydGhCeXRlICYgNjM7CiAgICAgICAgICAgICAgaWYgKHRlbXBDb2RlUG9pbnQgPiA2NTUzNSAmJiB0ZW1wQ29kZVBvaW50IDwgMTExNDExMikgewogICAgICAgICAgICAgICAgY29kZVBvaW50ID0gdGVtcENvZGVQb2ludDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGNvZGVQb2ludCA9PT0gbnVsbCkgewogICAgICAgIGNvZGVQb2ludCA9IDY1NTMzOwogICAgICAgIGJ5dGVzUGVyU2VxdWVuY2UgPSAxOwogICAgICB9IGVsc2UgaWYgKGNvZGVQb2ludCA+IDY1NTM1KSB7CiAgICAgICAgY29kZVBvaW50IC09IDY1NTM2OwogICAgICAgIHJlcy5wdXNoKGNvZGVQb2ludCA+Pj4gMTAgJiAxMDIzIHwgNTUyOTYpOwogICAgICAgIGNvZGVQb2ludCA9IDU2MzIwIHwgY29kZVBvaW50ICYgMTAyMzsKICAgICAgfQogICAgICByZXMucHVzaChjb2RlUG9pbnQpOwogICAgICBpICs9IGJ5dGVzUGVyU2VxdWVuY2U7CiAgICB9CiAgICByZXR1cm4gZGVjb2RlQ29kZVBvaW50c0FycmF5KHJlcyk7CiAgfQogIHZhciBNQVhfQVJHVU1FTlRTX0xFTkdUSCA9IDQwOTY7CiAgZnVuY3Rpb24gZGVjb2RlQ29kZVBvaW50c0FycmF5KGNvZGVQb2ludHMpIHsKICAgIGNvbnN0IGxlbiA9IGNvZGVQb2ludHMubGVuZ3RoOwogICAgaWYgKGxlbiA8PSBNQVhfQVJHVU1FTlRTX0xFTkdUSCkgewogICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShTdHJpbmcsIGNvZGVQb2ludHMpOwogICAgfQogICAgbGV0IHJlcyA9ICIiOwogICAgbGV0IGkgPSAwOwogICAgd2hpbGUgKGkgPCBsZW4pIHsKICAgICAgcmVzICs9IFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkoCiAgICAgICAgU3RyaW5nLAogICAgICAgIGNvZGVQb2ludHMuc2xpY2UoaSwgaSArPSBNQVhfQVJHVU1FTlRTX0xFTkdUSCkKICAgICAgKTsKICAgIH0KICAgIHJldHVybiByZXM7CiAgfQogIGZ1bmN0aW9uIGFzY2lpU2xpY2UoYnVmLCBzdGFydCwgZW5kKSB7CiAgICBsZXQgcmV0ID0gIiI7CiAgICBlbmQgPSBNYXRoLm1pbihidWYubGVuZ3RoLCBlbmQpOwogICAgZm9yIChsZXQgaSA9IHN0YXJ0OyBpIDwgZW5kOyArK2kpIHsKICAgICAgcmV0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYnVmW2ldICYgMTI3KTsKICAgIH0KICAgIHJldHVybiByZXQ7CiAgfQogIGZ1bmN0aW9uIGxhdGluMVNsaWNlKGJ1Ziwgc3RhcnQsIGVuZCkgewogICAgbGV0IHJldCA9ICIiOwogICAgZW5kID0gTWF0aC5taW4oYnVmLmxlbmd0aCwgZW5kKTsKICAgIGZvciAobGV0IGkgPSBzdGFydDsgaSA8IGVuZDsgKytpKSB7CiAgICAgIHJldCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ1ZltpXSk7CiAgICB9CiAgICByZXR1cm4gcmV0OwogIH0KICBmdW5jdGlvbiBoZXhTbGljZShidWYsIHN0YXJ0LCBlbmQpIHsKICAgIGNvbnN0IGxlbiA9IGJ1Zi5sZW5ndGg7CiAgICBpZiAoIXN0YXJ0IHx8IHN0YXJ0IDwgMCkKICAgICAgc3RhcnQgPSAwOwogICAgaWYgKCFlbmQgfHwgZW5kIDwgMCB8fCBlbmQgPiBsZW4pCiAgICAgIGVuZCA9IGxlbjsKICAgIGxldCBvdXQgPSAiIjsKICAgIGZvciAobGV0IGkgPSBzdGFydDsgaSA8IGVuZDsgKytpKSB7CiAgICAgIG91dCArPSBoZXhTbGljZUxvb2t1cFRhYmxlW2J1ZltpXV07CiAgICB9CiAgICByZXR1cm4gb3V0OwogIH0KICBmdW5jdGlvbiB1dGYxNmxlU2xpY2UoYnVmLCBzdGFydCwgZW5kKSB7CiAgICBjb25zdCBieXRlcyA9IGJ1Zi5zbGljZShzdGFydCwgZW5kKTsKICAgIGxldCByZXMgPSAiIjsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYnl0ZXMubGVuZ3RoIC0gMTsgaSArPSAyKSB7CiAgICAgIHJlcyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ5dGVzW2ldICsgYnl0ZXNbaSArIDFdICogMjU2KTsKICAgIH0KICAgIHJldHVybiByZXM7CiAgfQogIEJ1ZmZlcjIucHJvdG90eXBlLnNsaWNlID0gZnVuY3Rpb24gc2xpY2Uoc3RhcnQsIGVuZCkgewogICAgY29uc3QgbGVuID0gdGhpcy5sZW5ndGg7CiAgICBzdGFydCA9IH5+c3RhcnQ7CiAgICBlbmQgPSBlbmQgPT09IHZvaWQgMCA/IGxlbiA6IH5+ZW5kOwogICAgaWYgKHN0YXJ0IDwgMCkgewogICAgICBzdGFydCArPSBsZW47CiAgICAgIGlmIChzdGFydCA8IDApCiAgICAgICAgc3RhcnQgPSAwOwogICAgfSBlbHNlIGlmIChzdGFydCA+IGxlbikgewogICAgICBzdGFydCA9IGxlbjsKICAgIH0KICAgIGlmIChlbmQgPCAwKSB7CiAgICAgIGVuZCArPSBsZW47CiAgICAgIGlmIChlbmQgPCAwKQogICAgICAgIGVuZCA9IDA7CiAgICB9IGVsc2UgaWYgKGVuZCA+IGxlbikgewogICAgICBlbmQgPSBsZW47CiAgICB9CiAgICBpZiAoZW5kIDwgc3RhcnQpCiAgICAgIGVuZCA9IHN0YXJ0OwogICAgY29uc3QgbmV3QnVmID0gdGhpcy5zdWJhcnJheShzdGFydCwgZW5kKTsKICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZihuZXdCdWYsIEJ1ZmZlcjIucHJvdG90eXBlKTsKICAgIHJldHVybiBuZXdCdWY7CiAgfTsKICBmdW5jdGlvbiBjaGVja09mZnNldChvZmZzZXQsIGV4dCwgbGVuZ3RoKSB7CiAgICBpZiAob2Zmc2V0ICUgMSAhPT0gMCB8fCBvZmZzZXQgPCAwKQogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigib2Zmc2V0IGlzIG5vdCB1aW50Iik7CiAgICBpZiAob2Zmc2V0ICsgZXh0ID4gbGVuZ3RoKQogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiVHJ5aW5nIHRvIGFjY2VzcyBiZXlvbmQgYnVmZmVyIGxlbmd0aCIpOwogIH0KICBCdWZmZXIyLnByb3RvdHlwZS5yZWFkVWludExFID0gQnVmZmVyMi5wcm90b3R5cGUucmVhZFVJbnRMRSA9IGZ1bmN0aW9uIHJlYWRVSW50TEUob2Zmc2V0LCBieXRlTGVuZ3RoMiwgbm9Bc3NlcnQpIHsKICAgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKICAgIGJ5dGVMZW5ndGgyID0gYnl0ZUxlbmd0aDIgPj4+IDA7CiAgICBpZiAoIW5vQXNzZXJ0KQogICAgICBjaGVja09mZnNldChvZmZzZXQsIGJ5dGVMZW5ndGgyLCB0aGlzLmxlbmd0aCk7CiAgICBsZXQgdmFsID0gdGhpc1tvZmZzZXRdOwogICAgbGV0IG11bCA9IDE7CiAgICBsZXQgaSA9IDA7CiAgICB3aGlsZSAoKytpIDwgYnl0ZUxlbmd0aDIgJiYgKG11bCAqPSAyNTYpKSB7CiAgICAgIHZhbCArPSB0aGlzW29mZnNldCArIGldICogbXVsOwogICAgfQogICAgcmV0dXJuIHZhbDsKICB9OwogIEJ1ZmZlcjIucHJvdG90eXBlLnJlYWRVaW50QkUgPSBCdWZmZXIyLnByb3RvdHlwZS5yZWFkVUludEJFID0gZnVuY3Rpb24gcmVhZFVJbnRCRShvZmZzZXQsIGJ5dGVMZW5ndGgyLCBub0Fzc2VydCkgewogICAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwogICAgYnl0ZUxlbmd0aDIgPSBieXRlTGVuZ3RoMiA+Pj4gMDsKICAgIGlmICghbm9Bc3NlcnQpIHsKICAgICAgY2hlY2tPZmZzZXQob2Zmc2V0LCBieXRlTGVuZ3RoMiwgdGhpcy5sZW5ndGgpOwogICAgfQogICAgbGV0IHZhbCA9IHRoaXNbb2Zmc2V0ICsgLS1ieXRlTGVuZ3RoMl07CiAgICBsZXQgbXVsID0gMTsKICAgIHdoaWxlIChieXRlTGVuZ3RoMiA+IDAgJiYgKG11bCAqPSAyNTYpKSB7CiAgICAgIHZhbCArPSB0aGlzW29mZnNldCArIC0tYnl0ZUxlbmd0aDJdICogbXVsOwogICAgfQogICAgcmV0dXJuIHZhbDsKICB9OwogIEJ1ZmZlcjIucHJvdG90eXBlLnJlYWRVaW50OCA9IEJ1ZmZlcjIucHJvdG90eXBlLnJlYWRVSW50OCA9IGZ1bmN0aW9uIHJlYWRVSW50OChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBvZmZzZXQgPSBvZmZzZXQgPj4+IDA7CiAgICBpZiAoIW5vQXNzZXJ0KQogICAgICBjaGVja09mZnNldChvZmZzZXQsIDEsIHRoaXMubGVuZ3RoKTsKICAgIHJldHVybiB0aGlzW29mZnNldF07CiAgfTsKICBCdWZmZXIyLnByb3RvdHlwZS5yZWFkVWludDE2TEUgPSBCdWZmZXIyLnByb3RvdHlwZS5yZWFkVUludDE2TEUgPSBmdW5jdGlvbiByZWFkVUludDE2TEUob2Zmc2V0LCBub0Fzc2VydCkgewogICAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwogICAgaWYgKCFub0Fzc2VydCkKICAgICAgY2hlY2tPZmZzZXQob2Zmc2V0LCAyLCB0aGlzLmxlbmd0aCk7CiAgICByZXR1cm4gdGhpc1tvZmZzZXRdIHwgdGhpc1tvZmZzZXQgKyAxXSA8PCA4OwogIH07CiAgQnVmZmVyMi5wcm90b3R5cGUucmVhZFVpbnQxNkJFID0gQnVmZmVyMi5wcm90b3R5cGUucmVhZFVJbnQxNkJFID0gZnVuY3Rpb24gcmVhZFVJbnQxNkJFKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKICAgIGlmICghbm9Bc3NlcnQpCiAgICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgMiwgdGhpcy5sZW5ndGgpOwogICAgcmV0dXJuIHRoaXNbb2Zmc2V0XSA8PCA4IHwgdGhpc1tvZmZzZXQgKyAxXTsKICB9OwogIEJ1ZmZlcjIucHJvdG90eXBlLnJlYWRVaW50MzJMRSA9IEJ1ZmZlcjIucHJvdG90eXBlLnJlYWRVSW50MzJMRSA9IGZ1bmN0aW9uIHJlYWRVSW50MzJMRShvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBvZmZzZXQgPSBvZmZzZXQgPj4+IDA7CiAgICBpZiAoIW5vQXNzZXJ0KQogICAgICBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKTsKICAgIHJldHVybiAodGhpc1tvZmZzZXRdIHwgdGhpc1tvZmZzZXQgKyAxXSA8PCA4IHwgdGhpc1tvZmZzZXQgKyAyXSA8PCAxNikgKyB0aGlzW29mZnNldCArIDNdICogMTY3NzcyMTY7CiAgfTsKICBCdWZmZXIyLnByb3RvdHlwZS5yZWFkVWludDMyQkUgPSBCdWZmZXIyLnByb3RvdHlwZS5yZWFkVUludDMyQkUgPSBmdW5jdGlvbiByZWFkVUludDMyQkUob2Zmc2V0LCBub0Fzc2VydCkgewogICAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwogICAgaWYgKCFub0Fzc2VydCkKICAgICAgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCk7CiAgICByZXR1cm4gdGhpc1tvZmZzZXRdICogMTY3NzcyMTYgKyAodGhpc1tvZmZzZXQgKyAxXSA8PCAxNiB8IHRoaXNbb2Zmc2V0ICsgMl0gPDwgOCB8IHRoaXNbb2Zmc2V0ICsgM10pOwogIH07CiAgQnVmZmVyMi5wcm90b3R5cGUucmVhZEJpZ1VJbnQ2NExFID0gZnVuY3Rpb24gcmVhZEJpZ1VJbnQ2NExFKG9mZnNldCkgewogICAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwogICAgdmFsaWRhdGVOdW1iZXIob2Zmc2V0LCAib2Zmc2V0Iik7CiAgICBjb25zdCBmaXJzdCA9IHRoaXNbb2Zmc2V0XTsKICAgIGNvbnN0IGxhc3QgPSB0aGlzW29mZnNldCArIDddOwogICAgaWYgKGZpcnN0ID09PSB2b2lkIDAgfHwgbGFzdCA9PT0gdm9pZCAwKSB7CiAgICAgIGJvdW5kc0Vycm9yKG9mZnNldCwgdGhpcy5sZW5ndGggLSA4KTsKICAgIH0KICAgIGNvbnN0IGxvID0gZmlyc3QgKyB0aGlzWysrb2Zmc2V0XSAqIDIgKiogOCArIHRoaXNbKytvZmZzZXRdICogMiAqKiAxNiArIHRoaXNbKytvZmZzZXRdICogMiAqKiAyNDsKICAgIGNvbnN0IGhpID0gdGhpc1srK29mZnNldF0gKyB0aGlzWysrb2Zmc2V0XSAqIDIgKiogOCArIHRoaXNbKytvZmZzZXRdICogMiAqKiAxNiArIGxhc3QgKiAyICoqIDI0OwogICAgcmV0dXJuIEJpZ0ludChsbykgKyAoQmlnSW50KGhpKSA8PCBCaWdJbnQoMzIpKTsKICB9OwogIEJ1ZmZlcjIucHJvdG90eXBlLnJlYWRCaWdVSW50NjRCRSA9IGZ1bmN0aW9uIHJlYWRCaWdVSW50NjRCRShvZmZzZXQpIHsKICAgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKICAgIHZhbGlkYXRlTnVtYmVyKG9mZnNldCwgIm9mZnNldCIpOwogICAgY29uc3QgZmlyc3QgPSB0aGlzW29mZnNldF07CiAgICBjb25zdCBsYXN0ID0gdGhpc1tvZmZzZXQgKyA3XTsKICAgIGlmIChmaXJzdCA9PT0gdm9pZCAwIHx8IGxhc3QgPT09IHZvaWQgMCkgewogICAgICBib3VuZHNFcnJvcihvZmZzZXQsIHRoaXMubGVuZ3RoIC0gOCk7CiAgICB9CiAgICBjb25zdCBoaSA9IGZpcnN0ICogMiAqKiAyNCArIHRoaXNbKytvZmZzZXRdICogMiAqKiAxNiArIHRoaXNbKytvZmZzZXRdICogMiAqKiA4ICsgdGhpc1srK29mZnNldF07CiAgICBjb25zdCBsbyA9IHRoaXNbKytvZmZzZXRdICogMiAqKiAyNCArIHRoaXNbKytvZmZzZXRdICogMiAqKiAxNiArIHRoaXNbKytvZmZzZXRdICogMiAqKiA4ICsgbGFzdDsKICAgIHJldHVybiAoQmlnSW50KGhpKSA8PCBCaWdJbnQoMzIpKSArIEJpZ0ludChsbyk7CiAgfTsKICBCdWZmZXIyLnByb3RvdHlwZS5yZWFkSW50TEUgPSBmdW5jdGlvbiByZWFkSW50TEUob2Zmc2V0LCBieXRlTGVuZ3RoMiwgbm9Bc3NlcnQpIHsKICAgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKICAgIGJ5dGVMZW5ndGgyID0gYnl0ZUxlbmd0aDIgPj4+IDA7CiAgICBpZiAoIW5vQXNzZXJ0KQogICAgICBjaGVja09mZnNldChvZmZzZXQsIGJ5dGVMZW5ndGgyLCB0aGlzLmxlbmd0aCk7CiAgICBsZXQgdmFsID0gdGhpc1tvZmZzZXRdOwogICAgbGV0IG11bCA9IDE7CiAgICBsZXQgaSA9IDA7CiAgICB3aGlsZSAoKytpIDwgYnl0ZUxlbmd0aDIgJiYgKG11bCAqPSAyNTYpKSB7CiAgICAgIHZhbCArPSB0aGlzW29mZnNldCArIGldICogbXVsOwogICAgfQogICAgbXVsICo9IDEyODsKICAgIGlmICh2YWwgPj0gbXVsKQogICAgICB2YWwgLT0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGgyKTsKICAgIHJldHVybiB2YWw7CiAgfTsKICBCdWZmZXIyLnByb3RvdHlwZS5yZWFkSW50QkUgPSBmdW5jdGlvbiByZWFkSW50QkUob2Zmc2V0LCBieXRlTGVuZ3RoMiwgbm9Bc3NlcnQpIHsKICAgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKICAgIGJ5dGVMZW5ndGgyID0gYnl0ZUxlbmd0aDIgPj4+IDA7CiAgICBpZiAoIW5vQXNzZXJ0KQogICAgICBjaGVja09mZnNldChvZmZzZXQsIGJ5dGVMZW5ndGgyLCB0aGlzLmxlbmd0aCk7CiAgICBsZXQgaSA9IGJ5dGVMZW5ndGgyOwogICAgbGV0IG11bCA9IDE7CiAgICBsZXQgdmFsID0gdGhpc1tvZmZzZXQgKyAtLWldOwogICAgd2hpbGUgKGkgPiAwICYmIChtdWwgKj0gMjU2KSkgewogICAgICB2YWwgKz0gdGhpc1tvZmZzZXQgKyAtLWldICogbXVsOwogICAgfQogICAgbXVsICo9IDEyODsKICAgIGlmICh2YWwgPj0gbXVsKQogICAgICB2YWwgLT0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGgyKTsKICAgIHJldHVybiB2YWw7CiAgfTsKICBCdWZmZXIyLnByb3RvdHlwZS5yZWFkSW50OCA9IGZ1bmN0aW9uIHJlYWRJbnQ4KG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKICAgIGlmICghbm9Bc3NlcnQpCiAgICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgMSwgdGhpcy5sZW5ndGgpOwogICAgaWYgKCEodGhpc1tvZmZzZXRdICYgMTI4KSkKICAgICAgcmV0dXJuIHRoaXNbb2Zmc2V0XTsKICAgIHJldHVybiAoMjU1IC0gdGhpc1tvZmZzZXRdICsgMSkgKiAtMTsKICB9OwogIEJ1ZmZlcjIucHJvdG90eXBlLnJlYWRJbnQxNkxFID0gZnVuY3Rpb24gcmVhZEludDE2TEUob2Zmc2V0LCBub0Fzc2VydCkgewogICAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwogICAgaWYgKCFub0Fzc2VydCkKICAgICAgY2hlY2tPZmZzZXQob2Zmc2V0LCAyLCB0aGlzLmxlbmd0aCk7CiAgICBjb25zdCB2YWwgPSB0aGlzW29mZnNldF0gfCB0aGlzW29mZnNldCArIDFdIDw8IDg7CiAgICByZXR1cm4gdmFsICYgMzI3NjggPyB2YWwgfCA0Mjk0OTAxNzYwIDogdmFsOwogIH07CiAgQnVmZmVyMi5wcm90b3R5cGUucmVhZEludDE2QkUgPSBmdW5jdGlvbiByZWFkSW50MTZCRShvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBvZmZzZXQgPSBvZmZzZXQgPj4+IDA7CiAgICBpZiAoIW5vQXNzZXJ0KQogICAgICBjaGVja09mZnNldChvZmZzZXQsIDIsIHRoaXMubGVuZ3RoKTsKICAgIGNvbnN0IHZhbCA9IHRoaXNbb2Zmc2V0ICsgMV0gfCB0aGlzW29mZnNldF0gPDwgODsKICAgIHJldHVybiB2YWwgJiAzMjc2OCA/IHZhbCB8IDQyOTQ5MDE3NjAgOiB2YWw7CiAgfTsKICBCdWZmZXIyLnByb3RvdHlwZS5yZWFkSW50MzJMRSA9IGZ1bmN0aW9uIHJlYWRJbnQzMkxFKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKICAgIGlmICghbm9Bc3NlcnQpCiAgICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpOwogICAgcmV0dXJuIHRoaXNbb2Zmc2V0XSB8IHRoaXNbb2Zmc2V0ICsgMV0gPDwgOCB8IHRoaXNbb2Zmc2V0ICsgMl0gPDwgMTYgfCB0aGlzW29mZnNldCArIDNdIDw8IDI0OwogIH07CiAgQnVmZmVyMi5wcm90b3R5cGUucmVhZEludDMyQkUgPSBmdW5jdGlvbiByZWFkSW50MzJCRShvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBvZmZzZXQgPSBvZmZzZXQgPj4+IDA7CiAgICBpZiAoIW5vQXNzZXJ0KQogICAgICBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKTsKICAgIHJldHVybiB0aGlzW29mZnNldF0gPDwgMjQgfCB0aGlzW29mZnNldCArIDFdIDw8IDE2IHwgdGhpc1tvZmZzZXQgKyAyXSA8PCA4IHwgdGhpc1tvZmZzZXQgKyAzXTsKICB9OwogIEJ1ZmZlcjIucHJvdG90eXBlLnJlYWRCaWdJbnQ2NExFID0gZnVuY3Rpb24gcmVhZEJpZ0ludDY0TEUob2Zmc2V0KSB7CiAgICBvZmZzZXQgPSBvZmZzZXQgPj4+IDA7CiAgICB2YWxpZGF0ZU51bWJlcihvZmZzZXQsICJvZmZzZXQiKTsKICAgIGNvbnN0IGZpcnN0ID0gdGhpc1tvZmZzZXRdOwogICAgY29uc3QgbGFzdCA9IHRoaXNbb2Zmc2V0ICsgN107CiAgICBpZiAoZmlyc3QgPT09IHZvaWQgMCB8fCBsYXN0ID09PSB2b2lkIDApIHsKICAgICAgYm91bmRzRXJyb3Iob2Zmc2V0LCB0aGlzLmxlbmd0aCAtIDgpOwogICAgfQogICAgY29uc3QgdmFsID0gdGhpc1tvZmZzZXQgKyA0XSArIHRoaXNbb2Zmc2V0ICsgNV0gKiAyICoqIDggKyB0aGlzW29mZnNldCArIDZdICogMiAqKiAxNiArIChsYXN0IDw8IDI0KTsKICAgIHJldHVybiAoQmlnSW50KHZhbCkgPDwgQmlnSW50KDMyKSkgKyBCaWdJbnQoZmlyc3QgKyB0aGlzWysrb2Zmc2V0XSAqIDIgKiogOCArIHRoaXNbKytvZmZzZXRdICogMiAqKiAxNiArIHRoaXNbKytvZmZzZXRdICogMiAqKiAyNCk7CiAgfTsKICBCdWZmZXIyLnByb3RvdHlwZS5yZWFkQmlnSW50NjRCRSA9IGZ1bmN0aW9uIHJlYWRCaWdJbnQ2NEJFKG9mZnNldCkgewogICAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwogICAgdmFsaWRhdGVOdW1iZXIob2Zmc2V0LCAib2Zmc2V0Iik7CiAgICBjb25zdCBmaXJzdCA9IHRoaXNbb2Zmc2V0XTsKICAgIGNvbnN0IGxhc3QgPSB0aGlzW29mZnNldCArIDddOwogICAgaWYgKGZpcnN0ID09PSB2b2lkIDAgfHwgbGFzdCA9PT0gdm9pZCAwKSB7CiAgICAgIGJvdW5kc0Vycm9yKG9mZnNldCwgdGhpcy5sZW5ndGggLSA4KTsKICAgIH0KICAgIGNvbnN0IHZhbCA9IChmaXJzdCA8PCAyNCkgKyAvLyBPdmVyZmxvdwogICAgdGhpc1srK29mZnNldF0gKiAyICoqIDE2ICsgdGhpc1srK29mZnNldF0gKiAyICoqIDggKyB0aGlzWysrb2Zmc2V0XTsKICAgIHJldHVybiAoQmlnSW50KHZhbCkgPDwgQmlnSW50KDMyKSkgKyBCaWdJbnQodGhpc1srK29mZnNldF0gKiAyICoqIDI0ICsgdGhpc1srK29mZnNldF0gKiAyICoqIDE2ICsgdGhpc1srK29mZnNldF0gKiAyICoqIDggKyBsYXN0KTsKICB9OwogIEJ1ZmZlcjIucHJvdG90eXBlLnJlYWRGbG9hdExFID0gZnVuY3Rpb24gcmVhZEZsb2F0TEUob2Zmc2V0LCBub0Fzc2VydCkgewogICAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwogICAgaWYgKCFub0Fzc2VydCkKICAgICAgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCk7CiAgICByZXR1cm4gaWVlZTc1NC5yZWFkKHRoaXMsIG9mZnNldCwgdHJ1ZSwgMjMsIDQpOwogIH07CiAgQnVmZmVyMi5wcm90b3R5cGUucmVhZEZsb2F0QkUgPSBmdW5jdGlvbiByZWFkRmxvYXRCRShvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBvZmZzZXQgPSBvZmZzZXQgPj4+IDA7CiAgICBpZiAoIW5vQXNzZXJ0KQogICAgICBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKTsKICAgIHJldHVybiBpZWVlNzU0LnJlYWQodGhpcywgb2Zmc2V0LCBmYWxzZSwgMjMsIDQpOwogIH07CiAgQnVmZmVyMi5wcm90b3R5cGUucmVhZERvdWJsZUxFID0gZnVuY3Rpb24gcmVhZERvdWJsZUxFKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKICAgIGlmICghbm9Bc3NlcnQpCiAgICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgOCwgdGhpcy5sZW5ndGgpOwogICAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIHRydWUsIDUyLCA4KTsKICB9OwogIEJ1ZmZlcjIucHJvdG90eXBlLnJlYWREb3VibGVCRSA9IGZ1bmN0aW9uIHJlYWREb3VibGVCRShvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBvZmZzZXQgPSBvZmZzZXQgPj4+IDA7CiAgICBpZiAoIW5vQXNzZXJ0KQogICAgICBjaGVja09mZnNldChvZmZzZXQsIDgsIHRoaXMubGVuZ3RoKTsKICAgIHJldHVybiBpZWVlNzU0LnJlYWQodGhpcywgb2Zmc2V0LCBmYWxzZSwgNTIsIDgpOwogIH07CiAgZnVuY3Rpb24gY2hlY2tJbnQoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBleHQsIG1heCwgbWluKSB7CiAgICBpZiAoIUJ1ZmZlcjIuaXNCdWZmZXIoYnVmKSkKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignImJ1ZmZlciIgYXJndW1lbnQgbXVzdCBiZSBhIEJ1ZmZlciBpbnN0YW5jZScpOwogICAgaWYgKHZhbHVlID4gbWF4IHx8IHZhbHVlIDwgbWluKQogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignInZhbHVlIiBhcmd1bWVudCBpcyBvdXQgb2YgYm91bmRzJyk7CiAgICBpZiAob2Zmc2V0ICsgZXh0ID4gYnVmLmxlbmd0aCkKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkluZGV4IG91dCBvZiByYW5nZSIpOwogIH0KICBCdWZmZXIyLnByb3RvdHlwZS53cml0ZVVpbnRMRSA9IEJ1ZmZlcjIucHJvdG90eXBlLndyaXRlVUludExFID0gZnVuY3Rpb24gd3JpdGVVSW50TEUodmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aDIsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZTsKICAgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKICAgIGJ5dGVMZW5ndGgyID0gYnl0ZUxlbmd0aDIgPj4+IDA7CiAgICBpZiAoIW5vQXNzZXJ0KSB7CiAgICAgIGNvbnN0IG1heEJ5dGVzID0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGgyKSAtIDE7CiAgICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgyLCBtYXhCeXRlcywgMCk7CiAgICB9CiAgICBsZXQgbXVsID0gMTsKICAgIGxldCBpID0gMDsKICAgIHRoaXNbb2Zmc2V0XSA9IHZhbHVlICYgMjU1OwogICAgd2hpbGUgKCsraSA8IGJ5dGVMZW5ndGgyICYmIChtdWwgKj0gMjU2KSkgewogICAgICB0aGlzW29mZnNldCArIGldID0gdmFsdWUgLyBtdWwgJiAyNTU7CiAgICB9CiAgICByZXR1cm4gb2Zmc2V0ICsgYnl0ZUxlbmd0aDI7CiAgfTsKICBCdWZmZXIyLnByb3RvdHlwZS53cml0ZVVpbnRCRSA9IEJ1ZmZlcjIucHJvdG90eXBlLndyaXRlVUludEJFID0gZnVuY3Rpb24gd3JpdGVVSW50QkUodmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aDIsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZTsKICAgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKICAgIGJ5dGVMZW5ndGgyID0gYnl0ZUxlbmd0aDIgPj4+IDA7CiAgICBpZiAoIW5vQXNzZXJ0KSB7CiAgICAgIGNvbnN0IG1heEJ5dGVzID0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGgyKSAtIDE7CiAgICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgyLCBtYXhCeXRlcywgMCk7CiAgICB9CiAgICBsZXQgaSA9IGJ5dGVMZW5ndGgyIC0gMTsKICAgIGxldCBtdWwgPSAxOwogICAgdGhpc1tvZmZzZXQgKyBpXSA9IHZhbHVlICYgMjU1OwogICAgd2hpbGUgKC0taSA+PSAwICYmIChtdWwgKj0gMjU2KSkgewogICAgICB0aGlzW29mZnNldCArIGldID0gdmFsdWUgLyBtdWwgJiAyNTU7CiAgICB9CiAgICByZXR1cm4gb2Zmc2V0ICsgYnl0ZUxlbmd0aDI7CiAgfTsKICBCdWZmZXIyLnByb3RvdHlwZS53cml0ZVVpbnQ4ID0gQnVmZmVyMi5wcm90b3R5cGUud3JpdGVVSW50OCA9IGZ1bmN0aW9uIHdyaXRlVUludDgodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlOwogICAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwogICAgaWYgKCFub0Fzc2VydCkKICAgICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMSwgMjU1LCAwKTsKICAgIHRoaXNbb2Zmc2V0XSA9IHZhbHVlICYgMjU1OwogICAgcmV0dXJuIG9mZnNldCArIDE7CiAgfTsKICBCdWZmZXIyLnByb3RvdHlwZS53cml0ZVVpbnQxNkxFID0gQnVmZmVyMi5wcm90b3R5cGUud3JpdGVVSW50MTZMRSA9IGZ1bmN0aW9uIHdyaXRlVUludDE2TEUodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlOwogICAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwogICAgaWYgKCFub0Fzc2VydCkKICAgICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMiwgNjU1MzUsIDApOwogICAgdGhpc1tvZmZzZXRdID0gdmFsdWUgJiAyNTU7CiAgICB0aGlzW29mZnNldCArIDFdID0gdmFsdWUgPj4+IDg7CiAgICByZXR1cm4gb2Zmc2V0ICsgMjsKICB9OwogIEJ1ZmZlcjIucHJvdG90eXBlLndyaXRlVWludDE2QkUgPSBCdWZmZXIyLnByb3RvdHlwZS53cml0ZVVJbnQxNkJFID0gZnVuY3Rpb24gd3JpdGVVSW50MTZCRSh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWU7CiAgICBvZmZzZXQgPSBvZmZzZXQgPj4+IDA7CiAgICBpZiAoIW5vQXNzZXJ0KQogICAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCA2NTUzNSwgMCk7CiAgICB0aGlzW29mZnNldF0gPSB2YWx1ZSA+Pj4gODsKICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSB2YWx1ZSAmIDI1NTsKICAgIHJldHVybiBvZmZzZXQgKyAyOwogIH07CiAgQnVmZmVyMi5wcm90b3R5cGUud3JpdGVVaW50MzJMRSA9IEJ1ZmZlcjIucHJvdG90eXBlLndyaXRlVUludDMyTEUgPSBmdW5jdGlvbiB3cml0ZVVJbnQzMkxFKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZTsKICAgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKICAgIGlmICghbm9Bc3NlcnQpCiAgICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDQsIDQyOTQ5NjcyOTUsIDApOwogICAgdGhpc1tvZmZzZXQgKyAzXSA9IHZhbHVlID4+PiAyNDsKICAgIHRoaXNbb2Zmc2V0ICsgMl0gPSB2YWx1ZSA+Pj4gMTY7CiAgICB0aGlzW29mZnNldCArIDFdID0gdmFsdWUgPj4+IDg7CiAgICB0aGlzW29mZnNldF0gPSB2YWx1ZSAmIDI1NTsKICAgIHJldHVybiBvZmZzZXQgKyA0OwogIH07CiAgQnVmZmVyMi5wcm90b3R5cGUud3JpdGVVaW50MzJCRSA9IEJ1ZmZlcjIucHJvdG90eXBlLndyaXRlVUludDMyQkUgPSBmdW5jdGlvbiB3cml0ZVVJbnQzMkJFKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZTsKICAgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKICAgIGlmICghbm9Bc3NlcnQpCiAgICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDQsIDQyOTQ5NjcyOTUsIDApOwogICAgdGhpc1tvZmZzZXRdID0gdmFsdWUgPj4+IDI0OwogICAgdGhpc1tvZmZzZXQgKyAxXSA9IHZhbHVlID4+PiAxNjsKICAgIHRoaXNbb2Zmc2V0ICsgMl0gPSB2YWx1ZSA+Pj4gODsKICAgIHRoaXNbb2Zmc2V0ICsgM10gPSB2YWx1ZSAmIDI1NTsKICAgIHJldHVybiBvZmZzZXQgKyA0OwogIH07CiAgZnVuY3Rpb24gd3J0QmlnVUludDY0TEUoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBtaW4sIG1heCkgewogICAgY2hlY2tJbnRCSSh2YWx1ZSwgbWluLCBtYXgsIGJ1Ziwgb2Zmc2V0LCA3KTsKICAgIGxldCBsbyA9IE51bWJlcih2YWx1ZSAmIEJpZ0ludCg0Mjk0OTY3Mjk1KSk7CiAgICBidWZbb2Zmc2V0KytdID0gbG87CiAgICBsbyA9IGxvID4+IDg7CiAgICBidWZbb2Zmc2V0KytdID0gbG87CiAgICBsbyA9IGxvID4+IDg7CiAgICBidWZbb2Zmc2V0KytdID0gbG87CiAgICBsbyA9IGxvID4+IDg7CiAgICBidWZbb2Zmc2V0KytdID0gbG87CiAgICBsZXQgaGkgPSBOdW1iZXIodmFsdWUgPj4gQmlnSW50KDMyKSAmIEJpZ0ludCg0Mjk0OTY3Mjk1KSk7CiAgICBidWZbb2Zmc2V0KytdID0gaGk7CiAgICBoaSA9IGhpID4+IDg7CiAgICBidWZbb2Zmc2V0KytdID0gaGk7CiAgICBoaSA9IGhpID4+IDg7CiAgICBidWZbb2Zmc2V0KytdID0gaGk7CiAgICBoaSA9IGhpID4+IDg7CiAgICBidWZbb2Zmc2V0KytdID0gaGk7CiAgICByZXR1cm4gb2Zmc2V0OwogIH0KICBmdW5jdGlvbiB3cnRCaWdVSW50NjRCRShidWYsIHZhbHVlLCBvZmZzZXQsIG1pbiwgbWF4KSB7CiAgICBjaGVja0ludEJJKHZhbHVlLCBtaW4sIG1heCwgYnVmLCBvZmZzZXQsIDcpOwogICAgbGV0IGxvID0gTnVtYmVyKHZhbHVlICYgQmlnSW50KDQyOTQ5NjcyOTUpKTsKICAgIGJ1ZltvZmZzZXQgKyA3XSA9IGxvOwogICAgbG8gPSBsbyA+PiA4OwogICAgYnVmW29mZnNldCArIDZdID0gbG87CiAgICBsbyA9IGxvID4+IDg7CiAgICBidWZbb2Zmc2V0ICsgNV0gPSBsbzsKICAgIGxvID0gbG8gPj4gODsKICAgIGJ1ZltvZmZzZXQgKyA0XSA9IGxvOwogICAgbGV0IGhpID0gTnVtYmVyKHZhbHVlID4+IEJpZ0ludCgzMikgJiBCaWdJbnQoNDI5NDk2NzI5NSkpOwogICAgYnVmW29mZnNldCArIDNdID0gaGk7CiAgICBoaSA9IGhpID4+IDg7CiAgICBidWZbb2Zmc2V0ICsgMl0gPSBoaTsKICAgIGhpID0gaGkgPj4gODsKICAgIGJ1ZltvZmZzZXQgKyAxXSA9IGhpOwogICAgaGkgPSBoaSA+PiA4OwogICAgYnVmW29mZnNldF0gPSBoaTsKICAgIHJldHVybiBvZmZzZXQgKyA4OwogIH0KICBCdWZmZXIyLnByb3RvdHlwZS53cml0ZUJpZ1VJbnQ2NExFID0gZnVuY3Rpb24gd3JpdGVCaWdVSW50NjRMRSh2YWx1ZSwgb2Zmc2V0ID0gMCkgewogICAgcmV0dXJuIHdydEJpZ1VJbnQ2NExFKHRoaXMsIHZhbHVlLCBvZmZzZXQsIEJpZ0ludCgwKSwgQmlnSW50KCIweGZmZmZmZmZmZmZmZmZmZmYiKSk7CiAgfTsKICBCdWZmZXIyLnByb3RvdHlwZS53cml0ZUJpZ1VJbnQ2NEJFID0gZnVuY3Rpb24gd3JpdGVCaWdVSW50NjRCRSh2YWx1ZSwgb2Zmc2V0ID0gMCkgewogICAgcmV0dXJuIHdydEJpZ1VJbnQ2NEJFKHRoaXMsIHZhbHVlLCBvZmZzZXQsIEJpZ0ludCgwKSwgQmlnSW50KCIweGZmZmZmZmZmZmZmZmZmZmYiKSk7CiAgfTsKICBCdWZmZXIyLnByb3RvdHlwZS53cml0ZUludExFID0gZnVuY3Rpb24gd3JpdGVJbnRMRSh2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoMiwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlOwogICAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwogICAgaWYgKCFub0Fzc2VydCkgewogICAgICBjb25zdCBsaW1pdCA9IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoMiAtIDEpOwogICAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoMiwgbGltaXQgLSAxLCAtbGltaXQpOwogICAgfQogICAgbGV0IGkgPSAwOwogICAgbGV0IG11bCA9IDE7CiAgICBsZXQgc3ViID0gMDsKICAgIHRoaXNbb2Zmc2V0XSA9IHZhbHVlICYgMjU1OwogICAgd2hpbGUgKCsraSA8IGJ5dGVMZW5ndGgyICYmIChtdWwgKj0gMjU2KSkgewogICAgICBpZiAodmFsdWUgPCAwICYmIHN1YiA9PT0gMCAmJiB0aGlzW29mZnNldCArIGkgLSAxXSAhPT0gMCkgewogICAgICAgIHN1YiA9IDE7CiAgICAgIH0KICAgICAgdGhpc1tvZmZzZXQgKyBpXSA9ICh2YWx1ZSAvIG11bCA+PiAwKSAtIHN1YiAmIDI1NTsKICAgIH0KICAgIHJldHVybiBvZmZzZXQgKyBieXRlTGVuZ3RoMjsKICB9OwogIEJ1ZmZlcjIucHJvdG90eXBlLndyaXRlSW50QkUgPSBmdW5jdGlvbiB3cml0ZUludEJFKHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgyLCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWU7CiAgICBvZmZzZXQgPSBvZmZzZXQgPj4+IDA7CiAgICBpZiAoIW5vQXNzZXJ0KSB7CiAgICAgIGNvbnN0IGxpbWl0ID0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGgyIC0gMSk7CiAgICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgyLCBsaW1pdCAtIDEsIC1saW1pdCk7CiAgICB9CiAgICBsZXQgaSA9IGJ5dGVMZW5ndGgyIC0gMTsKICAgIGxldCBtdWwgPSAxOwogICAgbGV0IHN1YiA9IDA7CiAgICB0aGlzW29mZnNldCArIGldID0gdmFsdWUgJiAyNTU7CiAgICB3aGlsZSAoLS1pID49IDAgJiYgKG11bCAqPSAyNTYpKSB7CiAgICAgIGlmICh2YWx1ZSA8IDAgJiYgc3ViID09PSAwICYmIHRoaXNbb2Zmc2V0ICsgaSArIDFdICE9PSAwKSB7CiAgICAgICAgc3ViID0gMTsKICAgICAgfQogICAgICB0aGlzW29mZnNldCArIGldID0gKHZhbHVlIC8gbXVsID4+IDApIC0gc3ViICYgMjU1OwogICAgfQogICAgcmV0dXJuIG9mZnNldCArIGJ5dGVMZW5ndGgyOwogIH07CiAgQnVmZmVyMi5wcm90b3R5cGUud3JpdGVJbnQ4ID0gZnVuY3Rpb24gd3JpdGVJbnQ4KHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZTsKICAgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKICAgIGlmICghbm9Bc3NlcnQpCiAgICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDEsIDEyNywgLTEyOCk7CiAgICBpZiAodmFsdWUgPCAwKQogICAgICB2YWx1ZSA9IDI1NSArIHZhbHVlICsgMTsKICAgIHRoaXNbb2Zmc2V0XSA9IHZhbHVlICYgMjU1OwogICAgcmV0dXJuIG9mZnNldCArIDE7CiAgfTsKICBCdWZmZXIyLnByb3RvdHlwZS53cml0ZUludDE2TEUgPSBmdW5jdGlvbiB3cml0ZUludDE2TEUodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlOwogICAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwogICAgaWYgKCFub0Fzc2VydCkKICAgICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMiwgMzI3NjcsIC0zMjc2OCk7CiAgICB0aGlzW29mZnNldF0gPSB2YWx1ZSAmIDI1NTsKICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSB2YWx1ZSA+Pj4gODsKICAgIHJldHVybiBvZmZzZXQgKyAyOwogIH07CiAgQnVmZmVyMi5wcm90b3R5cGUud3JpdGVJbnQxNkJFID0gZnVuY3Rpb24gd3JpdGVJbnQxNkJFKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZTsKICAgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKICAgIGlmICghbm9Bc3NlcnQpCiAgICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDIsIDMyNzY3LCAtMzI3NjgpOwogICAgdGhpc1tvZmZzZXRdID0gdmFsdWUgPj4+IDg7CiAgICB0aGlzW29mZnNldCArIDFdID0gdmFsdWUgJiAyNTU7CiAgICByZXR1cm4gb2Zmc2V0ICsgMjsKICB9OwogIEJ1ZmZlcjIucHJvdG90eXBlLndyaXRlSW50MzJMRSA9IGZ1bmN0aW9uIHdyaXRlSW50MzJMRSh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWU7CiAgICBvZmZzZXQgPSBvZmZzZXQgPj4+IDA7CiAgICBpZiAoIW5vQXNzZXJ0KQogICAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCA0LCAyMTQ3NDgzNjQ3LCAtMjE0NzQ4MzY0OCk7CiAgICB0aGlzW29mZnNldF0gPSB2YWx1ZSAmIDI1NTsKICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSB2YWx1ZSA+Pj4gODsKICAgIHRoaXNbb2Zmc2V0ICsgMl0gPSB2YWx1ZSA+Pj4gMTY7CiAgICB0aGlzW29mZnNldCArIDNdID0gdmFsdWUgPj4+IDI0OwogICAgcmV0dXJuIG9mZnNldCArIDQ7CiAgfTsKICBCdWZmZXIyLnByb3RvdHlwZS53cml0ZUludDMyQkUgPSBmdW5jdGlvbiB3cml0ZUludDMyQkUodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlOwogICAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwogICAgaWYgKCFub0Fzc2VydCkKICAgICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgNCwgMjE0NzQ4MzY0NywgLTIxNDc0ODM2NDgpOwogICAgaWYgKHZhbHVlIDwgMCkKICAgICAgdmFsdWUgPSA0Mjk0OTY3Mjk1ICsgdmFsdWUgKyAxOwogICAgdGhpc1tvZmZzZXRdID0gdmFsdWUgPj4+IDI0OwogICAgdGhpc1tvZmZzZXQgKyAxXSA9IHZhbHVlID4+PiAxNjsKICAgIHRoaXNbb2Zmc2V0ICsgMl0gPSB2YWx1ZSA+Pj4gODsKICAgIHRoaXNbb2Zmc2V0ICsgM10gPSB2YWx1ZSAmIDI1NTsKICAgIHJldHVybiBvZmZzZXQgKyA0OwogIH07CiAgQnVmZmVyMi5wcm90b3R5cGUud3JpdGVCaWdJbnQ2NExFID0gZnVuY3Rpb24gd3JpdGVCaWdJbnQ2NExFKHZhbHVlLCBvZmZzZXQgPSAwKSB7CiAgICByZXR1cm4gd3J0QmlnVUludDY0TEUodGhpcywgdmFsdWUsIG9mZnNldCwgLUJpZ0ludCgiMHg4MDAwMDAwMDAwMDAwMDAwIiksIEJpZ0ludCgiMHg3ZmZmZmZmZmZmZmZmZmZmIikpOwogIH07CiAgQnVmZmVyMi5wcm90b3R5cGUud3JpdGVCaWdJbnQ2NEJFID0gZnVuY3Rpb24gd3JpdGVCaWdJbnQ2NEJFKHZhbHVlLCBvZmZzZXQgPSAwKSB7CiAgICByZXR1cm4gd3J0QmlnVUludDY0QkUodGhpcywgdmFsdWUsIG9mZnNldCwgLUJpZ0ludCgiMHg4MDAwMDAwMDAwMDAwMDAwIiksIEJpZ0ludCgiMHg3ZmZmZmZmZmZmZmZmZmZmIikpOwogIH07CiAgZnVuY3Rpb24gY2hlY2tJRUVFNzU0KGJ1ZiwgdmFsdWUsIG9mZnNldCwgZXh0LCBtYXgsIG1pbikgewogICAgaWYgKG9mZnNldCArIGV4dCA+IGJ1Zi5sZW5ndGgpCiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJJbmRleCBvdXQgb2YgcmFuZ2UiKTsKICAgIGlmIChvZmZzZXQgPCAwKQogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiSW5kZXggb3V0IG9mIHJhbmdlIik7CiAgfQogIGZ1bmN0aW9uIHdyaXRlRmxvYXQoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4sIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZTsKICAgIG9mZnNldCA9IG9mZnNldCA+Pj4gMDsKICAgIGlmICghbm9Bc3NlcnQpIHsKICAgICAgY2hlY2tJRUVFNzU0KGJ1ZiwgdmFsdWUsIG9mZnNldCwgNCwgMzQwMjgyMzQ2NjM4NTI4ODZlMjIsIC0zNDAyODIzNDY2Mzg1Mjg4NmUyMik7CiAgICB9CiAgICBpZWVlNzU0LndyaXRlKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCAyMywgNCk7CiAgICByZXR1cm4gb2Zmc2V0ICsgNDsKICB9CiAgQnVmZmVyMi5wcm90b3R5cGUud3JpdGVGbG9hdExFID0gZnVuY3Rpb24gd3JpdGVGbG9hdExFKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICByZXR1cm4gd3JpdGVGbG9hdCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlLCBub0Fzc2VydCk7CiAgfTsKICBCdWZmZXIyLnByb3RvdHlwZS53cml0ZUZsb2F0QkUgPSBmdW5jdGlvbiB3cml0ZUZsb2F0QkUodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHJldHVybiB3cml0ZUZsb2F0KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlLCBub0Fzc2VydCk7CiAgfTsKICBmdW5jdGlvbiB3cml0ZURvdWJsZShidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbiwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlOwogICAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwOwogICAgaWYgKCFub0Fzc2VydCkgewogICAgICBjaGVja0lFRUU3NTQoYnVmLCB2YWx1ZSwgb2Zmc2V0LCA4LCAxNzk3NjkzMTM0ODYyMzE1N2UyOTIsIC0xNzk3NjkzMTM0ODYyMzE1N2UyOTIpOwogICAgfQogICAgaWVlZTc1NC53cml0ZShidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbiwgNTIsIDgpOwogICAgcmV0dXJuIG9mZnNldCArIDg7CiAgfQogIEJ1ZmZlcjIucHJvdG90eXBlLndyaXRlRG91YmxlTEUgPSBmdW5jdGlvbiB3cml0ZURvdWJsZUxFKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICByZXR1cm4gd3JpdGVEb3VibGUodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSwgbm9Bc3NlcnQpOwogIH07CiAgQnVmZmVyMi5wcm90b3R5cGUud3JpdGVEb3VibGVCRSA9IGZ1bmN0aW9uIHdyaXRlRG91YmxlQkUodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHJldHVybiB3cml0ZURvdWJsZSh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSwgbm9Bc3NlcnQpOwogIH07CiAgQnVmZmVyMi5wcm90b3R5cGUuY29weSA9IGZ1bmN0aW9uIGNvcHkodGFyZ2V0LCB0YXJnZXRTdGFydCwgc3RhcnQsIGVuZCkgewogICAgaWYgKCFCdWZmZXIyLmlzQnVmZmVyKHRhcmdldCkpCiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoImFyZ3VtZW50IHNob3VsZCBiZSBhIEJ1ZmZlciIpOwogICAgaWYgKCFzdGFydCkKICAgICAgc3RhcnQgPSAwOwogICAgaWYgKCFlbmQgJiYgZW5kICE9PSAwKQogICAgICBlbmQgPSB0aGlzLmxlbmd0aDsKICAgIGlmICh0YXJnZXRTdGFydCA+PSB0YXJnZXQubGVuZ3RoKQogICAgICB0YXJnZXRTdGFydCA9IHRhcmdldC5sZW5ndGg7CiAgICBpZiAoIXRhcmdldFN0YXJ0KQogICAgICB0YXJnZXRTdGFydCA9IDA7CiAgICBpZiAoZW5kID4gMCAmJiBlbmQgPCBzdGFydCkKICAgICAgZW5kID0gc3RhcnQ7CiAgICBpZiAoZW5kID09PSBzdGFydCkKICAgICAgcmV0dXJuIDA7CiAgICBpZiAodGFyZ2V0Lmxlbmd0aCA9PT0gMCB8fCB0aGlzLmxlbmd0aCA9PT0gMCkKICAgICAgcmV0dXJuIDA7CiAgICBpZiAodGFyZ2V0U3RhcnQgPCAwKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJ0YXJnZXRTdGFydCBvdXQgb2YgYm91bmRzIik7CiAgICB9CiAgICBpZiAoc3RhcnQgPCAwIHx8IHN0YXJ0ID49IHRoaXMubGVuZ3RoKQogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiSW5kZXggb3V0IG9mIHJhbmdlIik7CiAgICBpZiAoZW5kIDwgMCkKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoInNvdXJjZUVuZCBvdXQgb2YgYm91bmRzIik7CiAgICBpZiAoZW5kID4gdGhpcy5sZW5ndGgpCiAgICAgIGVuZCA9IHRoaXMubGVuZ3RoOwogICAgaWYgKHRhcmdldC5sZW5ndGggLSB0YXJnZXRTdGFydCA8IGVuZCAtIHN0YXJ0KSB7CiAgICAgIGVuZCA9IHRhcmdldC5sZW5ndGggLSB0YXJnZXRTdGFydCArIHN0YXJ0OwogICAgfQogICAgY29uc3QgbGVuID0gZW5kIC0gc3RhcnQ7CiAgICBpZiAodGhpcyA9PT0gdGFyZ2V0KSB7CiAgICAgIHRoaXMuY29weVdpdGhpbih0YXJnZXRTdGFydCwgc3RhcnQsIGVuZCk7CiAgICB9IGVsc2UgewogICAgICBVaW50OEFycmF5LnByb3RvdHlwZS5zZXQuY2FsbCgKICAgICAgICB0YXJnZXQsCiAgICAgICAgdGhpcy5zdWJhcnJheShzdGFydCwgZW5kKSwKICAgICAgICB0YXJnZXRTdGFydAogICAgICApOwogICAgfQogICAgcmV0dXJuIGxlbjsKICB9OwogIEJ1ZmZlcjIucHJvdG90eXBlLmZpbGwgPSBmdW5jdGlvbiBmaWxsKHZhbCwgc3RhcnQsIGVuZCwgZW5jb2RpbmcpIHsKICAgIGlmICh0eXBlb2YgdmFsID09PSAic3RyaW5nIikgewogICAgICBpZiAodHlwZW9mIHN0YXJ0ID09PSAic3RyaW5nIikgewogICAgICAgIGVuY29kaW5nID0gc3RhcnQ7CiAgICAgICAgc3RhcnQgPSAwOwogICAgICAgIGVuZCA9IHRoaXMubGVuZ3RoOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbmQgPT09ICJzdHJpbmciKSB7CiAgICAgICAgZW5jb2RpbmcgPSBlbmQ7CiAgICAgICAgZW5kID0gdGhpcy5sZW5ndGg7CiAgICAgIH0KICAgICAgaWYgKGVuY29kaW5nICE9PSB2b2lkIDAgJiYgdHlwZW9mIGVuY29kaW5nICE9PSAic3RyaW5nIikgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoImVuY29kaW5nIG11c3QgYmUgYSBzdHJpbmciKTsKICAgICAgfQogICAgICBpZiAodHlwZW9mIGVuY29kaW5nID09PSAic3RyaW5nIiAmJiAhQnVmZmVyMi5pc0VuY29kaW5nKGVuY29kaW5nKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVua25vd24gZW5jb2Rpbmc6ICIgKyBlbmNvZGluZyk7CiAgICAgIH0KICAgICAgaWYgKHZhbC5sZW5ndGggPT09IDEpIHsKICAgICAgICBjb25zdCBjb2RlMiA9IHZhbC5jaGFyQ29kZUF0KDApOwogICAgICAgIGlmIChlbmNvZGluZyA9PT0gInV0ZjgiICYmIGNvZGUyIDwgMTI4IHx8IGVuY29kaW5nID09PSAibGF0aW4xIikgewogICAgICAgICAgdmFsID0gY29kZTI7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWwgPT09ICJudW1iZXIiKSB7CiAgICAgIHZhbCA9IHZhbCAmIDI1NTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gImJvb2xlYW4iKSB7CiAgICAgIHZhbCA9IE51bWJlcih2YWwpOwogICAgfQogICAgaWYgKHN0YXJ0IDwgMCB8fCB0aGlzLmxlbmd0aCA8IHN0YXJ0IHx8IHRoaXMubGVuZ3RoIDwgZW5kKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCJPdXQgb2YgcmFuZ2UgaW5kZXgiKTsKICAgIH0KICAgIGlmIChlbmQgPD0gc3RhcnQpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBzdGFydCA9IHN0YXJ0ID4+PiAwOwogICAgZW5kID0gZW5kID09PSB2b2lkIDAgPyB0aGlzLmxlbmd0aCA6IGVuZCA+Pj4gMDsKICAgIGlmICghdmFsKQogICAgICB2YWwgPSAwOwogICAgbGV0IGk7CiAgICBpZiAodHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHsKICAgICAgZm9yIChpID0gc3RhcnQ7IGkgPCBlbmQ7ICsraSkgewogICAgICAgIHRoaXNbaV0gPSB2YWw7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGJ5dGVzID0gQnVmZmVyMi5pc0J1ZmZlcih2YWwpID8gdmFsIDogQnVmZmVyMi5mcm9tKHZhbCwgZW5jb2RpbmcpOwogICAgICBjb25zdCBsZW4gPSBieXRlcy5sZW5ndGg7CiAgICAgIGlmIChsZW4gPT09IDApIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdUaGUgdmFsdWUgIicgKyB2YWwgKyAnIiBpcyBpbnZhbGlkIGZvciBhcmd1bWVudCAidmFsdWUiJyk7CiAgICAgIH0KICAgICAgZm9yIChpID0gMDsgaSA8IGVuZCAtIHN0YXJ0OyArK2kpIHsKICAgICAgICB0aGlzW2kgKyBzdGFydF0gPSBieXRlc1tpICUgbGVuXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfTsKICB2YXIgZXJyb3JzID0ge307CiAgZnVuY3Rpb24gRShzeW0sIGdldE1lc3NhZ2UsIEJhc2UpIHsKICAgIGVycm9yc1tzeW1dID0gY2xhc3MgTm9kZUVycm9yIGV4dGVuZHMgQmFzZSB7CiAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgIHN1cGVyKCk7CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICJtZXNzYWdlIiwgewogICAgICAgICAgdmFsdWU6IGdldE1lc3NhZ2UuYXBwbHkodGhpcywgYXJndW1lbnRzKSwKICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5uYW1lID0gYCR7dGhpcy5uYW1lfSBbJHtzeW19XWA7CiAgICAgICAgdGhpcy5zdGFjazsKICAgICAgICBkZWxldGUgdGhpcy5uYW1lOwogICAgICB9CiAgICAgIGdldCBjb2RlKCkgewogICAgICAgIHJldHVybiBzeW07CiAgICAgIH0KICAgICAgc2V0IGNvZGUodmFsdWUpIHsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgImNvZGUiLCB7CiAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgdmFsdWUsCiAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHRvU3RyaW5nKCkgewogICAgICAgIHJldHVybiBgJHt0aGlzLm5hbWV9IFske3N5bX1dOiAke3RoaXMubWVzc2FnZX1gOwogICAgICB9CiAgICB9OwogIH0KICBFKAogICAgIkVSUl9CVUZGRVJfT1VUX09GX0JPVU5EUyIsCiAgICBmdW5jdGlvbihuYW1lKSB7CiAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgcmV0dXJuIGAke25hbWV9IGlzIG91dHNpZGUgb2YgYnVmZmVyIGJvdW5kc2A7CiAgICAgIH0KICAgICAgcmV0dXJuICJBdHRlbXB0IHRvIGFjY2VzcyBtZW1vcnkgb3V0c2lkZSBidWZmZXIgYm91bmRzIjsKICAgIH0sCiAgICBSYW5nZUVycm9yCiAgKTsKICBFKAogICAgIkVSUl9JTlZBTElEX0FSR19UWVBFIiwKICAgIGZ1bmN0aW9uKG5hbWUsIGFjdHVhbCkgewogICAgICByZXR1cm4gYFRoZSAiJHtuYW1lfSIgYXJndW1lbnQgbXVzdCBiZSBvZiB0eXBlIG51bWJlci4gUmVjZWl2ZWQgdHlwZSAke3R5cGVvZiBhY3R1YWx9YDsKICAgIH0sCiAgICBUeXBlRXJyb3IKICApOwogIEUoCiAgICAiRVJSX09VVF9PRl9SQU5HRSIsCiAgICBmdW5jdGlvbihzdHIsIHJhbmdlLCBpbnB1dCkgewogICAgICBsZXQgbXNnID0gYFRoZSB2YWx1ZSBvZiAiJHtzdHJ9IiBpcyBvdXQgb2YgcmFuZ2UuYDsKICAgICAgbGV0IHJlY2VpdmVkID0gaW5wdXQ7CiAgICAgIGlmIChOdW1iZXIuaXNJbnRlZ2VyKGlucHV0KSAmJiBNYXRoLmFicyhpbnB1dCkgPiAyICoqIDMyKSB7CiAgICAgICAgcmVjZWl2ZWQgPSBhZGROdW1lcmljYWxTZXBhcmF0b3IoU3RyaW5nKGlucHV0KSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGlucHV0ID09PSAiYmlnaW50IikgewogICAgICAgIHJlY2VpdmVkID0gU3RyaW5nKGlucHV0KTsKICAgICAgICBpZiAoaW5wdXQgPiBCaWdJbnQoMikgKiogQmlnSW50KDMyKSB8fCBpbnB1dCA8IC0oQmlnSW50KDIpICoqIEJpZ0ludCgzMikpKSB7CiAgICAgICAgICByZWNlaXZlZCA9IGFkZE51bWVyaWNhbFNlcGFyYXRvcihyZWNlaXZlZCk7CiAgICAgICAgfQogICAgICAgIHJlY2VpdmVkICs9ICJuIjsKICAgICAgfQogICAgICBtc2cgKz0gYCBJdCBtdXN0IGJlICR7cmFuZ2V9LiBSZWNlaXZlZCAke3JlY2VpdmVkfWA7CiAgICAgIHJldHVybiBtc2c7CiAgICB9LAogICAgUmFuZ2VFcnJvcgogICk7CiAgZnVuY3Rpb24gYWRkTnVtZXJpY2FsU2VwYXJhdG9yKHZhbCkgewogICAgbGV0IHJlcyA9ICIiOwogICAgbGV0IGkgPSB2YWwubGVuZ3RoOwogICAgY29uc3Qgc3RhcnQgPSB2YWxbMF0gPT09ICItIiA/IDEgOiAwOwogICAgZm9yICg7IGkgPj0gc3RhcnQgKyA0OyBpIC09IDMpIHsKICAgICAgcmVzID0gYF8ke3ZhbC5zbGljZShpIC0gMywgaSl9JHtyZXN9YDsKICAgIH0KICAgIHJldHVybiBgJHt2YWwuc2xpY2UoMCwgaSl9JHtyZXN9YDsKICB9CiAgZnVuY3Rpb24gY2hlY2tCb3VuZHMoYnVmLCBvZmZzZXQsIGJ5dGVMZW5ndGgyKSB7CiAgICB2YWxpZGF0ZU51bWJlcihvZmZzZXQsICJvZmZzZXQiKTsKICAgIGlmIChidWZbb2Zmc2V0XSA9PT0gdm9pZCAwIHx8IGJ1ZltvZmZzZXQgKyBieXRlTGVuZ3RoMl0gPT09IHZvaWQgMCkgewogICAgICBib3VuZHNFcnJvcihvZmZzZXQsIGJ1Zi5sZW5ndGggLSAoYnl0ZUxlbmd0aDIgKyAxKSk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGNoZWNrSW50QkkodmFsdWUsIG1pbiwgbWF4LCBidWYsIG9mZnNldCwgYnl0ZUxlbmd0aDIpIHsKICAgIGlmICh2YWx1ZSA+IG1heCB8fCB2YWx1ZSA8IG1pbikgewogICAgICBjb25zdCBuID0gdHlwZW9mIG1pbiA9PT0gImJpZ2ludCIgPyAibiIgOiAiIjsKICAgICAgbGV0IHJhbmdlOwogICAgICBpZiAoYnl0ZUxlbmd0aDIgPiAzKSB7CiAgICAgICAgaWYgKG1pbiA9PT0gMCB8fCBtaW4gPT09IEJpZ0ludCgwKSkgewogICAgICAgICAgcmFuZ2UgPSBgPj0gMCR7bn0gYW5kIDwgMiR7bn0gKiogJHsoYnl0ZUxlbmd0aDIgKyAxKSAqIDh9JHtufWA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJhbmdlID0gYD49IC0oMiR7bn0gKiogJHsoYnl0ZUxlbmd0aDIgKyAxKSAqIDggLSAxfSR7bn0pIGFuZCA8IDIgKiogJHsoYnl0ZUxlbmd0aDIgKyAxKSAqIDggLSAxfSR7bn1gOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByYW5nZSA9IGA+PSAke21pbn0ke259IGFuZCA8PSAke21heH0ke259YDsKICAgICAgfQogICAgICB0aHJvdyBuZXcgZXJyb3JzLkVSUl9PVVRfT0ZfUkFOR0UoInZhbHVlIiwgcmFuZ2UsIHZhbHVlKTsKICAgIH0KICAgIGNoZWNrQm91bmRzKGJ1Ziwgb2Zmc2V0LCBieXRlTGVuZ3RoMik7CiAgfQogIGZ1bmN0aW9uIHZhbGlkYXRlTnVtYmVyKHZhbHVlLCBuYW1lKSB7CiAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAibnVtYmVyIikgewogICAgICB0aHJvdyBuZXcgZXJyb3JzLkVSUl9JTlZBTElEX0FSR19UWVBFKG5hbWUsICJudW1iZXIiLCB2YWx1ZSk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGJvdW5kc0Vycm9yKHZhbHVlLCBsZW5ndGgsIHR5cGUpIHsKICAgIGlmIChNYXRoLmZsb29yKHZhbHVlKSAhPT0gdmFsdWUpIHsKICAgICAgdmFsaWRhdGVOdW1iZXIodmFsdWUsIHR5cGUpOwogICAgICB0aHJvdyBuZXcgZXJyb3JzLkVSUl9PVVRfT0ZfUkFOR0UodHlwZSB8fCAib2Zmc2V0IiwgImFuIGludGVnZXIiLCB2YWx1ZSk7CiAgICB9CiAgICBpZiAobGVuZ3RoIDwgMCkgewogICAgICB0aHJvdyBuZXcgZXJyb3JzLkVSUl9CVUZGRVJfT1VUX09GX0JPVU5EUygpOwogICAgfQogICAgdGhyb3cgbmV3IGVycm9ycy5FUlJfT1VUX09GX1JBTkdFKAogICAgICB0eXBlIHx8ICJvZmZzZXQiLAogICAgICBgPj0gJHt0eXBlID8gMSA6IDB9IGFuZCA8PSAke2xlbmd0aH1gLAogICAgICB2YWx1ZQogICAgKTsKICB9CiAgdmFyIElOVkFMSURfQkFTRTY0X1JFID0gL1teKy8wLTlBLVphLXotX10vZzsKICBmdW5jdGlvbiBiYXNlNjRjbGVhbihzdHIpIHsKICAgIHN0ciA9IHN0ci5zcGxpdCgiPSIpWzBdOwogICAgc3RyID0gc3RyLnRyaW0oKS5yZXBsYWNlKElOVkFMSURfQkFTRTY0X1JFLCAiIik7CiAgICBpZiAoc3RyLmxlbmd0aCA8IDIpCiAgICAgIHJldHVybiAiIjsKICAgIHdoaWxlIChzdHIubGVuZ3RoICUgNCAhPT0gMCkgewogICAgICBzdHIgPSBzdHIgKyAiPSI7CiAgICB9CiAgICByZXR1cm4gc3RyOwogIH0KICBmdW5jdGlvbiB1dGY4VG9CeXRlcyhzdHJpbmcsIHVuaXRzKSB7CiAgICB1bml0cyA9IHVuaXRzIHx8IEluZmluaXR5OwogICAgbGV0IGNvZGVQb2ludDsKICAgIGNvbnN0IGxlbmd0aCA9IHN0cmluZy5sZW5ndGg7CiAgICBsZXQgbGVhZFN1cnJvZ2F0ZSA9IG51bGw7CiAgICBjb25zdCBieXRlcyA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBjb2RlUG9pbnQgPSBzdHJpbmcuY2hhckNvZGVBdChpKTsKICAgICAgaWYgKGNvZGVQb2ludCA+IDU1Mjk1ICYmIGNvZGVQb2ludCA8IDU3MzQ0KSB7CiAgICAgICAgaWYgKCFsZWFkU3Vycm9nYXRlKSB7CiAgICAgICAgICBpZiAoY29kZVBvaW50ID4gNTYzMTkpIHsKICAgICAgICAgICAgaWYgKCh1bml0cyAtPSAzKSA+IC0xKQogICAgICAgICAgICAgIGJ5dGVzLnB1c2goMjM5LCAxOTEsIDE4OSk7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfSBlbHNlIGlmIChpICsgMSA9PT0gbGVuZ3RoKSB7CiAgICAgICAgICAgIGlmICgodW5pdHMgLT0gMykgPiAtMSkKICAgICAgICAgICAgICBieXRlcy5wdXNoKDIzOSwgMTkxLCAxODkpOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGxlYWRTdXJyb2dhdGUgPSBjb2RlUG9pbnQ7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGNvZGVQb2ludCA8IDU2MzIwKSB7CiAgICAgICAgICBpZiAoKHVuaXRzIC09IDMpID4gLTEpCiAgICAgICAgICAgIGJ5dGVzLnB1c2goMjM5LCAxOTEsIDE4OSk7CiAgICAgICAgICBsZWFkU3Vycm9nYXRlID0gY29kZVBvaW50OwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGNvZGVQb2ludCA9IChsZWFkU3Vycm9nYXRlIC0gNTUyOTYgPDwgMTAgfCBjb2RlUG9pbnQgLSA1NjMyMCkgKyA2NTUzNjsKICAgICAgfSBlbHNlIGlmIChsZWFkU3Vycm9nYXRlKSB7CiAgICAgICAgaWYgKCh1bml0cyAtPSAzKSA+IC0xKQogICAgICAgICAgYnl0ZXMucHVzaCgyMzksIDE5MSwgMTg5KTsKICAgICAgfQogICAgICBsZWFkU3Vycm9nYXRlID0gbnVsbDsKICAgICAgaWYgKGNvZGVQb2ludCA8IDEyOCkgewogICAgICAgIGlmICgodW5pdHMgLT0gMSkgPCAwKQogICAgICAgICAgYnJlYWs7CiAgICAgICAgYnl0ZXMucHVzaChjb2RlUG9pbnQpOwogICAgICB9IGVsc2UgaWYgKGNvZGVQb2ludCA8IDIwNDgpIHsKICAgICAgICBpZiAoKHVuaXRzIC09IDIpIDwgMCkKICAgICAgICAgIGJyZWFrOwogICAgICAgIGJ5dGVzLnB1c2goCiAgICAgICAgICBjb2RlUG9pbnQgPj4gNiB8IDE5MiwKICAgICAgICAgIGNvZGVQb2ludCAmIDYzIHwgMTI4CiAgICAgICAgKTsKICAgICAgfSBlbHNlIGlmIChjb2RlUG9pbnQgPCA2NTUzNikgewogICAgICAgIGlmICgodW5pdHMgLT0gMykgPCAwKQogICAgICAgICAgYnJlYWs7CiAgICAgICAgYnl0ZXMucHVzaCgKICAgICAgICAgIGNvZGVQb2ludCA+PiAxMiB8IDIyNCwKICAgICAgICAgIGNvZGVQb2ludCA+PiA2ICYgNjMgfCAxMjgsCiAgICAgICAgICBjb2RlUG9pbnQgJiA2MyB8IDEyOAogICAgICAgICk7CiAgICAgIH0gZWxzZSBpZiAoY29kZVBvaW50IDwgMTExNDExMikgewogICAgICAgIGlmICgodW5pdHMgLT0gNCkgPCAwKQogICAgICAgICAgYnJlYWs7CiAgICAgICAgYnl0ZXMucHVzaCgKICAgICAgICAgIGNvZGVQb2ludCA+PiAxOCB8IDI0MCwKICAgICAgICAgIGNvZGVQb2ludCA+PiAxMiAmIDYzIHwgMTI4LAogICAgICAgICAgY29kZVBvaW50ID4+IDYgJiA2MyB8IDEyOCwKICAgICAgICAgIGNvZGVQb2ludCAmIDYzIHwgMTI4CiAgICAgICAgKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgY29kZSBwb2ludCIpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gYnl0ZXM7CiAgfQogIGZ1bmN0aW9uIGFzY2lpVG9CeXRlcyhzdHIpIHsKICAgIGNvbnN0IGJ5dGVBcnJheSA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyArK2kpIHsKICAgICAgYnl0ZUFycmF5LnB1c2goc3RyLmNoYXJDb2RlQXQoaSkgJiAyNTUpOwogICAgfQogICAgcmV0dXJuIGJ5dGVBcnJheTsKICB9CiAgZnVuY3Rpb24gdXRmMTZsZVRvQnl0ZXMoc3RyLCB1bml0cykgewogICAgbGV0IGMsIGhpLCBsbzsKICAgIGNvbnN0IGJ5dGVBcnJheSA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKCh1bml0cyAtPSAyKSA8IDApCiAgICAgICAgYnJlYWs7CiAgICAgIGMgPSBzdHIuY2hhckNvZGVBdChpKTsKICAgICAgaGkgPSBjID4+IDg7CiAgICAgIGxvID0gYyAlIDI1NjsKICAgICAgYnl0ZUFycmF5LnB1c2gobG8pOwogICAgICBieXRlQXJyYXkucHVzaChoaSk7CiAgICB9CiAgICByZXR1cm4gYnl0ZUFycmF5OwogIH0KICBmdW5jdGlvbiBiYXNlNjRUb0J5dGVzKHN0cikgewogICAgcmV0dXJuIGJhc2U2NC50b0J5dGVBcnJheShiYXNlNjRjbGVhbihzdHIpKTsKICB9CiAgZnVuY3Rpb24gYmxpdEJ1ZmZlcihzcmMsIGRzdCwgb2Zmc2V0LCBsZW5ndGgpIHsKICAgIGxldCBpOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGlmIChpICsgb2Zmc2V0ID49IGRzdC5sZW5ndGggfHwgaSA+PSBzcmMubGVuZ3RoKQogICAgICAgIGJyZWFrOwogICAgICBkc3RbaSArIG9mZnNldF0gPSBzcmNbaV07CiAgICB9CiAgICByZXR1cm4gaTsKICB9CiAgdmFyIGhleFNsaWNlTG9va3VwVGFibGUgPSBmdW5jdGlvbigpIHsKICAgIGNvbnN0IGFscGhhYmV0ID0gIjAxMjM0NTY3ODlhYmNkZWYiOwogICAgY29uc3QgdGFibGUgPSBuZXcgQXJyYXkoMjU2KTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTY7ICsraSkgewogICAgICBjb25zdCBpMTYgPSBpICogMTY7CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgMTY7ICsraikgewogICAgICAgIHRhYmxlW2kxNiArIGpdID0gYWxwaGFiZXRbaV0gKyBhbHBoYWJldFtqXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRhYmxlOwogIH0oKTsKCiAgLy8gbm9kZV9tb2R1bGVzL2ZyaWRhLWphdmEtYnJpZGdlL2xpYi9ta2RleC5qcwogIHZhciBrQWNjUHVibGljMiA9IDE7CiAgdmFyIGtBY2NOYXRpdmUyID0gMjU2OwogIHZhciBrQWNjQ29uc3RydWN0b3IgPSA2NTUzNjsKICB2YXIga0VuZGlhblRhZyA9IDMwNTQxOTg5NjsKICB2YXIga0NsYXNzRGVmU2l6ZSA9IDMyOwogIHZhciBrUHJvdG9JZFNpemUgPSAxMjsKICB2YXIga0ZpZWxkSWRTaXplID0gODsKICB2YXIga01ldGhvZElkU2l6ZSA9IDg7CiAgdmFyIGtUeXBlSWRTaXplID0gNDsKICB2YXIga1N0cmluZ0lkU2l6ZSA9IDQ7CiAgdmFyIGtNYXBJdGVtU2l6ZSA9IDEyOwogIHZhciBUWVBFX0hFQURFUl9JVEVNID0gMDsKICB2YXIgVFlQRV9TVFJJTkdfSURfSVRFTSA9IDE7CiAgdmFyIFRZUEVfVFlQRV9JRF9JVEVNID0gMjsKICB2YXIgVFlQRV9QUk9UT19JRF9JVEVNID0gMzsKICB2YXIgVFlQRV9GSUVMRF9JRF9JVEVNID0gNDsKICB2YXIgVFlQRV9NRVRIT0RfSURfSVRFTSA9IDU7CiAgdmFyIFRZUEVfQ0xBU1NfREVGX0lURU0gPSA2OwogIHZhciBUWVBFX01BUF9MSVNUID0gNDA5NjsKICB2YXIgVFlQRV9UWVBFX0xJU1QgPSA0MDk3OwogIHZhciBUWVBFX0FOTk9UQVRJT05fU0VUX0lURU0gPSA0MDk5OwogIHZhciBUWVBFX0NMQVNTX0RBVEFfSVRFTSA9IDgxOTI7CiAgdmFyIFRZUEVfQ09ERV9JVEVNID0gODE5MzsKICB2YXIgVFlQRV9TVFJJTkdfREFUQV9JVEVNID0gODE5NDsKICB2YXIgVFlQRV9ERUJVR19JTkZPX0lURU0gPSA4MTk1OwogIHZhciBUWVBFX0FOTk9UQVRJT05fSVRFTSA9IDgxOTY7CiAgdmFyIFRZUEVfQU5OT1RBVElPTlNfRElSRUNUT1JZX0lURU0gPSA4MTk4OwogIHZhciBWQUxVRV9UWVBFID0gMjQ7CiAgdmFyIFZBTFVFX0FSUkFZID0gMjg7CiAgdmFyIFZJU0lCSUxJVFlfU1lTVEVNID0gMjsKICB2YXIga0RlZmF1bHRDb25zdHJ1Y3RvclNpemUgPSAyNDsKICB2YXIga0RlZmF1bHRDb25zdHJ1Y3RvckRlYnVnSW5mbyA9IEJ1ZmZlcjIuZnJvbShbMywgMCwgNywgMTQsIDBdKTsKICB2YXIga0RhbHZpa0Fubm90YXRpb25UeXBlVGhyb3dzID0gIkxkYWx2aWsvYW5ub3RhdGlvbi9UaHJvd3M7IjsKICB2YXIga051bGxUZXJtaW5hdG9yID0gQnVmZmVyMi5mcm9tKFswXSk7CiAgZnVuY3Rpb24gbWtkZXgoc3BlYykgewogICAgY29uc3QgYnVpbGRlciA9IG5ldyBEZXhCdWlsZGVyKCk7CiAgICBjb25zdCBmdWxsU3BlYyA9IE9iamVjdC5hc3NpZ24oe30sIHNwZWMpOwogICAgYnVpbGRlci5hZGRDbGFzcyhmdWxsU3BlYyk7CiAgICByZXR1cm4gYnVpbGRlci5idWlsZCgpOwogIH0KICB2YXIgRGV4QnVpbGRlciA9IGNsYXNzIHsKICAgIGNvbnN0cnVjdG9yKCkgewogICAgICB0aGlzLmNsYXNzZXMgPSBbXTsKICAgIH0KICAgIGFkZENsYXNzKHNwZWMpIHsKICAgICAgdGhpcy5jbGFzc2VzLnB1c2goc3BlYyk7CiAgICB9CiAgICBidWlsZCgpIHsKICAgICAgY29uc3QgbW9kZWwgPSBjb21wdXRlTW9kZWwodGhpcy5jbGFzc2VzKTsKICAgICAgY29uc3QgewogICAgICAgIGNsYXNzZXMsCiAgICAgICAgaW50ZXJmYWNlcywKICAgICAgICBmaWVsZHMsCiAgICAgICAgbWV0aG9kcywKICAgICAgICBwcm90b3MsCiAgICAgICAgcGFyYW1ldGVycywKICAgICAgICBhbm5vdGF0aW9uRGlyZWN0b3JpZXMsCiAgICAgICAgYW5ub3RhdGlvblNldHMsCiAgICAgICAgdGhyb3dzQW5ub3RhdGlvbnMsCiAgICAgICAgdHlwZXMsCiAgICAgICAgc3RyaW5ncwogICAgICB9ID0gbW9kZWw7CiAgICAgIGxldCBvZmZzZXQgPSAwOwogICAgICBjb25zdCBoZWFkZXJPZmZzZXQgPSAwOwogICAgICBjb25zdCBjaGVja3N1bU9mZnNldCA9IDg7CiAgICAgIGNvbnN0IHNpZ25hdHVyZU9mZnNldCA9IDEyOwogICAgICBjb25zdCBzaWduYXR1cmVTaXplID0gMjA7CiAgICAgIGNvbnN0IGhlYWRlclNpemUgPSAxMTI7CiAgICAgIG9mZnNldCArPSBoZWFkZXJTaXplOwogICAgICBjb25zdCBzdHJpbmdJZHNPZmZzZXQgPSBvZmZzZXQ7CiAgICAgIGNvbnN0IHN0cmluZ0lkc1NpemUgPSBzdHJpbmdzLmxlbmd0aCAqIGtTdHJpbmdJZFNpemU7CiAgICAgIG9mZnNldCArPSBzdHJpbmdJZHNTaXplOwogICAgICBjb25zdCB0eXBlSWRzT2Zmc2V0ID0gb2Zmc2V0OwogICAgICBjb25zdCB0eXBlSWRzU2l6ZSA9IHR5cGVzLmxlbmd0aCAqIGtUeXBlSWRTaXplOwogICAgICBvZmZzZXQgKz0gdHlwZUlkc1NpemU7CiAgICAgIGNvbnN0IHByb3RvSWRzT2Zmc2V0ID0gb2Zmc2V0OwogICAgICBjb25zdCBwcm90b0lkc1NpemUgPSBwcm90b3MubGVuZ3RoICoga1Byb3RvSWRTaXplOwogICAgICBvZmZzZXQgKz0gcHJvdG9JZHNTaXplOwogICAgICBjb25zdCBmaWVsZElkc09mZnNldCA9IG9mZnNldDsKICAgICAgY29uc3QgZmllbGRJZHNTaXplID0gZmllbGRzLmxlbmd0aCAqIGtGaWVsZElkU2l6ZTsKICAgICAgb2Zmc2V0ICs9IGZpZWxkSWRzU2l6ZTsKICAgICAgY29uc3QgbWV0aG9kSWRzT2Zmc2V0ID0gb2Zmc2V0OwogICAgICBjb25zdCBtZXRob2RJZHNTaXplID0gbWV0aG9kcy5sZW5ndGggKiBrTWV0aG9kSWRTaXplOwogICAgICBvZmZzZXQgKz0gbWV0aG9kSWRzU2l6ZTsKICAgICAgY29uc3QgY2xhc3NEZWZzT2Zmc2V0ID0gb2Zmc2V0OwogICAgICBjb25zdCBjbGFzc0RlZnNTaXplID0gY2xhc3Nlcy5sZW5ndGggKiBrQ2xhc3NEZWZTaXplOwogICAgICBvZmZzZXQgKz0gY2xhc3NEZWZzU2l6ZTsKICAgICAgY29uc3QgZGF0YU9mZnNldCA9IG9mZnNldDsKICAgICAgY29uc3QgYW5ub3RhdGlvblNldE9mZnNldHMgPSBhbm5vdGF0aW9uU2V0cy5tYXAoKHNldCkgPT4gewogICAgICAgIGNvbnN0IHNldE9mZnNldCA9IG9mZnNldDsKICAgICAgICBzZXQub2Zmc2V0ID0gc2V0T2Zmc2V0OwogICAgICAgIG9mZnNldCArPSA0ICsgc2V0Lml0ZW1zLmxlbmd0aCAqIDQ7CiAgICAgICAgcmV0dXJuIHNldE9mZnNldDsKICAgICAgfSk7CiAgICAgIGNvbnN0IGphdmFDb2RlSXRlbXMgPSBjbGFzc2VzLnJlZHVjZSgocmVzdWx0LCBrbGFzcykgPT4gewogICAgICAgIGNvbnN0IGNvbnN0cnVjdG9yTWV0aG9kcyA9IGtsYXNzLmNsYXNzRGF0YS5jb25zdHJ1Y3Rvck1ldGhvZHM7CiAgICAgICAgY29uc3RydWN0b3JNZXRob2RzLmZvckVhY2goKG1ldGhvZCkgPT4gewogICAgICAgICAgY29uc3QgWywgYWNjZXNzRmxhZ3MsIHN1cGVyQ29uc3RydWN0b3JdID0gbWV0aG9kOwogICAgICAgICAgaWYgKChhY2Nlc3NGbGFncyAmIGtBY2NOYXRpdmUyKSA9PT0gMCAmJiBzdXBlckNvbnN0cnVjdG9yID49IDApIHsKICAgICAgICAgICAgbWV0aG9kLnB1c2gob2Zmc2V0KTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goeyBvZmZzZXQsIHN1cGVyQ29uc3RydWN0b3IgfSk7CiAgICAgICAgICAgIG9mZnNldCArPSBrRGVmYXVsdENvbnN0cnVjdG9yU2l6ZTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9LCBbXSk7CiAgICAgIGFubm90YXRpb25EaXJlY3Rvcmllcy5mb3JFYWNoKChkaXIpID0+IHsKICAgICAgICBkaXIub2Zmc2V0ID0gb2Zmc2V0OwogICAgICAgIG9mZnNldCArPSAxNiArIGRpci5tZXRob2RzLmxlbmd0aCAqIDg7CiAgICAgIH0pOwogICAgICBjb25zdCBpbnRlcmZhY2VPZmZzZXRzID0gaW50ZXJmYWNlcy5tYXAoKGlmYWNlKSA9PiB7CiAgICAgICAgb2Zmc2V0ID0gYWxpZ24ob2Zmc2V0LCA0KTsKICAgICAgICBjb25zdCBpZmFjZU9mZnNldCA9IG9mZnNldDsKICAgICAgICBpZmFjZS5vZmZzZXQgPSBpZmFjZU9mZnNldDsKICAgICAgICBvZmZzZXQgKz0gNCArIDIgKiBpZmFjZS50eXBlcy5sZW5ndGg7CiAgICAgICAgcmV0dXJuIGlmYWNlT2Zmc2V0OwogICAgICB9KTsKICAgICAgY29uc3QgcGFyYW1ldGVyT2Zmc2V0cyA9IHBhcmFtZXRlcnMubWFwKChwYXJhbSkgPT4gewogICAgICAgIG9mZnNldCA9IGFsaWduKG9mZnNldCwgNCk7CiAgICAgICAgY29uc3QgcGFyYW1PZmZzZXQgPSBvZmZzZXQ7CiAgICAgICAgcGFyYW0ub2Zmc2V0ID0gcGFyYW1PZmZzZXQ7CiAgICAgICAgb2Zmc2V0ICs9IDQgKyAyICogcGFyYW0udHlwZXMubGVuZ3RoOwogICAgICAgIHJldHVybiBwYXJhbU9mZnNldDsKICAgICAgfSk7CiAgICAgIGNvbnN0IHN0cmluZ0NodW5rcyA9IFtdOwogICAgICBjb25zdCBzdHJpbmdPZmZzZXRzID0gc3RyaW5ncy5tYXAoKHN0cikgPT4gewogICAgICAgIGNvbnN0IHN0ck9mZnNldCA9IG9mZnNldDsKICAgICAgICBjb25zdCBoZWFkZXIgPSBCdWZmZXIyLmZyb20oY3JlYXRlVWxlYjEyOChzdHIubGVuZ3RoKSk7CiAgICAgICAgY29uc3QgZGF0YSA9IEJ1ZmZlcjIuZnJvbShzdHIsICJ1dGY4Iik7CiAgICAgICAgY29uc3QgY2h1bmsgPSBCdWZmZXIyLmNvbmNhdChbaGVhZGVyLCBkYXRhLCBrTnVsbFRlcm1pbmF0b3JdKTsKICAgICAgICBzdHJpbmdDaHVua3MucHVzaChjaHVuayk7CiAgICAgICAgb2Zmc2V0ICs9IGNodW5rLmxlbmd0aDsKICAgICAgICByZXR1cm4gc3RyT2Zmc2V0OwogICAgICB9KTsKICAgICAgY29uc3QgZGVidWdJbmZvT2Zmc2V0cyA9IGphdmFDb2RlSXRlbXMubWFwKChjb2RlSXRlbSkgPT4gewogICAgICAgIGNvbnN0IGRlYnVnT2Zmc2V0ID0gb2Zmc2V0OwogICAgICAgIG9mZnNldCArPSBrRGVmYXVsdENvbnN0cnVjdG9yRGVidWdJbmZvLmxlbmd0aDsKICAgICAgICByZXR1cm4gZGVidWdPZmZzZXQ7CiAgICAgIH0pOwogICAgICBjb25zdCB0aHJvd3NBbm5vdGF0aW9uQmxvYnMgPSB0aHJvd3NBbm5vdGF0aW9ucy5tYXAoKGFubm90YXRpb24pID0+IHsKICAgICAgICBjb25zdCBibG9iID0gbWFrZVRocm93c0Fubm90YXRpb24oYW5ub3RhdGlvbik7CiAgICAgICAgYW5ub3RhdGlvbi5vZmZzZXQgPSBvZmZzZXQ7CiAgICAgICAgb2Zmc2V0ICs9IGJsb2IubGVuZ3RoOwogICAgICAgIHJldHVybiBibG9iOwogICAgICB9KTsKICAgICAgY29uc3QgY2xhc3NEYXRhQmxvYnMgPSBjbGFzc2VzLm1hcCgoa2xhc3MsIGluZGV4KSA9PiB7CiAgICAgICAga2xhc3MuY2xhc3NEYXRhLm9mZnNldCA9IG9mZnNldDsKICAgICAgICBjb25zdCBibG9iID0gbWFrZUNsYXNzRGF0YShrbGFzcyk7CiAgICAgICAgb2Zmc2V0ICs9IGJsb2IubGVuZ3RoOwogICAgICAgIHJldHVybiBibG9iOwogICAgICB9KTsKICAgICAgY29uc3QgbGlua1NpemUgPSAwOwogICAgICBjb25zdCBsaW5rT2Zmc2V0ID0gMDsKICAgICAgb2Zmc2V0ID0gYWxpZ24ob2Zmc2V0LCA0KTsKICAgICAgY29uc3QgbWFwT2Zmc2V0ID0gb2Zmc2V0OwogICAgICBjb25zdCB0eXBlTGlzdExlbmd0aCA9IGludGVyZmFjZXMubGVuZ3RoICsgcGFyYW1ldGVycy5sZW5ndGg7CiAgICAgIGNvbnN0IG1hcE51bUl0ZW1zID0gNCArIChmaWVsZHMubGVuZ3RoID4gMCA/IDEgOiAwKSArIDIgKyBhbm5vdGF0aW9uU2V0cy5sZW5ndGggKyBqYXZhQ29kZUl0ZW1zLmxlbmd0aCArIGFubm90YXRpb25EaXJlY3Rvcmllcy5sZW5ndGggKyAodHlwZUxpc3RMZW5ndGggPiAwID8gMSA6IDApICsgMSArIGRlYnVnSW5mb09mZnNldHMubGVuZ3RoICsgdGhyb3dzQW5ub3RhdGlvbnMubGVuZ3RoICsgY2xhc3Nlcy5sZW5ndGggKyAxOwogICAgICBjb25zdCBtYXBTaXplID0gNCArIG1hcE51bUl0ZW1zICoga01hcEl0ZW1TaXplOwogICAgICBvZmZzZXQgKz0gbWFwU2l6ZTsKICAgICAgY29uc3QgZGF0YVNpemUgPSBvZmZzZXQgLSBkYXRhT2Zmc2V0OwogICAgICBjb25zdCBmaWxlU2l6ZSA9IG9mZnNldDsKICAgICAgY29uc3QgZGV4ID0gQnVmZmVyMi5hbGxvYyhmaWxlU2l6ZSk7CiAgICAgIGRleC53cml0ZSgiZGV4XG4wMzUiKTsKICAgICAgZGV4LndyaXRlVUludDMyTEUoZmlsZVNpemUsIDMyKTsKICAgICAgZGV4LndyaXRlVUludDMyTEUoaGVhZGVyU2l6ZSwgMzYpOwogICAgICBkZXgud3JpdGVVSW50MzJMRShrRW5kaWFuVGFnLCA0MCk7CiAgICAgIGRleC53cml0ZVVJbnQzMkxFKGxpbmtTaXplLCA0NCk7CiAgICAgIGRleC53cml0ZVVJbnQzMkxFKGxpbmtPZmZzZXQsIDQ4KTsKICAgICAgZGV4LndyaXRlVUludDMyTEUobWFwT2Zmc2V0LCA1Mik7CiAgICAgIGRleC53cml0ZVVJbnQzMkxFKHN0cmluZ3MubGVuZ3RoLCA1Nik7CiAgICAgIGRleC53cml0ZVVJbnQzMkxFKHN0cmluZ0lkc09mZnNldCwgNjApOwogICAgICBkZXgud3JpdGVVSW50MzJMRSh0eXBlcy5sZW5ndGgsIDY0KTsKICAgICAgZGV4LndyaXRlVUludDMyTEUodHlwZUlkc09mZnNldCwgNjgpOwogICAgICBkZXgud3JpdGVVSW50MzJMRShwcm90b3MubGVuZ3RoLCA3Mik7CiAgICAgIGRleC53cml0ZVVJbnQzMkxFKHByb3RvSWRzT2Zmc2V0LCA3Nik7CiAgICAgIGRleC53cml0ZVVJbnQzMkxFKGZpZWxkcy5sZW5ndGgsIDgwKTsKICAgICAgZGV4LndyaXRlVUludDMyTEUoZmllbGRzLmxlbmd0aCA+IDAgPyBmaWVsZElkc09mZnNldCA6IDAsIDg0KTsKICAgICAgZGV4LndyaXRlVUludDMyTEUobWV0aG9kcy5sZW5ndGgsIDg4KTsKICAgICAgZGV4LndyaXRlVUludDMyTEUobWV0aG9kSWRzT2Zmc2V0LCA5Mik7CiAgICAgIGRleC53cml0ZVVJbnQzMkxFKGNsYXNzZXMubGVuZ3RoLCA5Nik7CiAgICAgIGRleC53cml0ZVVJbnQzMkxFKGNsYXNzRGVmc09mZnNldCwgMTAwKTsKICAgICAgZGV4LndyaXRlVUludDMyTEUoZGF0YVNpemUsIDEwNCk7CiAgICAgIGRleC53cml0ZVVJbnQzMkxFKGRhdGFPZmZzZXQsIDEwOCk7CiAgICAgIHN0cmluZ09mZnNldHMuZm9yRWFjaCgob2Zmc2V0MiwgaW5kZXgpID0+IHsKICAgICAgICBkZXgud3JpdGVVSW50MzJMRShvZmZzZXQyLCBzdHJpbmdJZHNPZmZzZXQgKyBpbmRleCAqIGtTdHJpbmdJZFNpemUpOwogICAgICB9KTsKICAgICAgdHlwZXMuZm9yRWFjaCgoaWQsIGluZGV4KSA9PiB7CiAgICAgICAgZGV4LndyaXRlVUludDMyTEUoaWQsIHR5cGVJZHNPZmZzZXQgKyBpbmRleCAqIGtUeXBlSWRTaXplKTsKICAgICAgfSk7CiAgICAgIHByb3Rvcy5mb3JFYWNoKChwcm90bywgaW5kZXgpID0+IHsKICAgICAgICBjb25zdCBbc2hvcnR5SW5kZXgsIHJldHVyblR5cGVJbmRleCwgcGFyYW1zXSA9IHByb3RvOwogICAgICAgIGNvbnN0IHByb3RvT2Zmc2V0ID0gcHJvdG9JZHNPZmZzZXQgKyBpbmRleCAqIGtQcm90b0lkU2l6ZTsKICAgICAgICBkZXgud3JpdGVVSW50MzJMRShzaG9ydHlJbmRleCwgcHJvdG9PZmZzZXQpOwogICAgICAgIGRleC53cml0ZVVJbnQzMkxFKHJldHVyblR5cGVJbmRleCwgcHJvdG9PZmZzZXQgKyA0KTsKICAgICAgICBkZXgud3JpdGVVSW50MzJMRShwYXJhbXMgIT09IG51bGwgPyBwYXJhbXMub2Zmc2V0IDogMCwgcHJvdG9PZmZzZXQgKyA4KTsKICAgICAgfSk7CiAgICAgIGZpZWxkcy5mb3JFYWNoKChmaWVsZCwgaW5kZXgpID0+IHsKICAgICAgICBjb25zdCBbY2xhc3NJbmRleCwgdHlwZUluZGV4LCBuYW1lSW5kZXhdID0gZmllbGQ7CiAgICAgICAgY29uc3QgZmllbGRPZmZzZXQgPSBmaWVsZElkc09mZnNldCArIGluZGV4ICoga0ZpZWxkSWRTaXplOwogICAgICAgIGRleC53cml0ZVVJbnQxNkxFKGNsYXNzSW5kZXgsIGZpZWxkT2Zmc2V0KTsKICAgICAgICBkZXgud3JpdGVVSW50MTZMRSh0eXBlSW5kZXgsIGZpZWxkT2Zmc2V0ICsgMik7CiAgICAgICAgZGV4LndyaXRlVUludDMyTEUobmFtZUluZGV4LCBmaWVsZE9mZnNldCArIDQpOwogICAgICB9KTsKICAgICAgbWV0aG9kcy5mb3JFYWNoKChtZXRob2QsIGluZGV4KSA9PiB7CiAgICAgICAgY29uc3QgW2NsYXNzSW5kZXgsIHByb3RvSW5kZXgsIG5hbWVJbmRleF0gPSBtZXRob2Q7CiAgICAgICAgY29uc3QgbWV0aG9kT2Zmc2V0ID0gbWV0aG9kSWRzT2Zmc2V0ICsgaW5kZXggKiBrTWV0aG9kSWRTaXplOwogICAgICAgIGRleC53cml0ZVVJbnQxNkxFKGNsYXNzSW5kZXgsIG1ldGhvZE9mZnNldCk7CiAgICAgICAgZGV4LndyaXRlVUludDE2TEUocHJvdG9JbmRleCwgbWV0aG9kT2Zmc2V0ICsgMik7CiAgICAgICAgZGV4LndyaXRlVUludDMyTEUobmFtZUluZGV4LCBtZXRob2RPZmZzZXQgKyA0KTsKICAgICAgfSk7CiAgICAgIGNsYXNzZXMuZm9yRWFjaCgoa2xhc3MsIGluZGV4KSA9PiB7CiAgICAgICAgY29uc3QgeyBpbnRlcmZhY2VzOiBpbnRlcmZhY2VzMiwgYW5ub3RhdGlvbnNEaXJlY3RvcnkgfSA9IGtsYXNzOwogICAgICAgIGNvbnN0IGludGVyZmFjZXNPZmZzZXQgPSBpbnRlcmZhY2VzMiAhPT0gbnVsbCA/IGludGVyZmFjZXMyLm9mZnNldCA6IDA7CiAgICAgICAgY29uc3QgYW5ub3RhdGlvbnNPZmZzZXQgPSBhbm5vdGF0aW9uc0RpcmVjdG9yeSAhPT0gbnVsbCA/IGFubm90YXRpb25zRGlyZWN0b3J5Lm9mZnNldCA6IDA7CiAgICAgICAgY29uc3Qgc3RhdGljVmFsdWVzT2Zmc2V0ID0gMDsKICAgICAgICBjb25zdCBjbGFzc09mZnNldCA9IGNsYXNzRGVmc09mZnNldCArIGluZGV4ICoga0NsYXNzRGVmU2l6ZTsKICAgICAgICBkZXgud3JpdGVVSW50MzJMRShrbGFzcy5pbmRleCwgY2xhc3NPZmZzZXQpOwogICAgICAgIGRleC53cml0ZVVJbnQzMkxFKGtsYXNzLmFjY2Vzc0ZsYWdzLCBjbGFzc09mZnNldCArIDQpOwogICAgICAgIGRleC53cml0ZVVJbnQzMkxFKGtsYXNzLnN1cGVyQ2xhc3NJbmRleCwgY2xhc3NPZmZzZXQgKyA4KTsKICAgICAgICBkZXgud3JpdGVVSW50MzJMRShpbnRlcmZhY2VzT2Zmc2V0LCBjbGFzc09mZnNldCArIDEyKTsKICAgICAgICBkZXgud3JpdGVVSW50MzJMRShrbGFzcy5zb3VyY2VGaWxlSW5kZXgsIGNsYXNzT2Zmc2V0ICsgMTYpOwogICAgICAgIGRleC53cml0ZVVJbnQzMkxFKGFubm90YXRpb25zT2Zmc2V0LCBjbGFzc09mZnNldCArIDIwKTsKICAgICAgICBkZXgud3JpdGVVSW50MzJMRShrbGFzcy5jbGFzc0RhdGEub2Zmc2V0LCBjbGFzc09mZnNldCArIDI0KTsKICAgICAgICBkZXgud3JpdGVVSW50MzJMRShzdGF0aWNWYWx1ZXNPZmZzZXQsIGNsYXNzT2Zmc2V0ICsgMjgpOwogICAgICB9KTsKICAgICAgYW5ub3RhdGlvblNldHMuZm9yRWFjaCgoc2V0LCBpbmRleCkgPT4gewogICAgICAgIGNvbnN0IHsgaXRlbXMgfSA9IHNldDsKICAgICAgICBjb25zdCBzZXRPZmZzZXQgPSBhbm5vdGF0aW9uU2V0T2Zmc2V0c1tpbmRleF07CiAgICAgICAgZGV4LndyaXRlVUludDMyTEUoaXRlbXMubGVuZ3RoLCBzZXRPZmZzZXQpOwogICAgICAgIGl0ZW1zLmZvckVhY2goKGl0ZW0sIGluZGV4MikgPT4gewogICAgICAgICAgZGV4LndyaXRlVUludDMyTEUoaXRlbS5vZmZzZXQsIHNldE9mZnNldCArIDQgKyBpbmRleDIgKiA0KTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIGphdmFDb2RlSXRlbXMuZm9yRWFjaCgoY29kZUl0ZW0sIGluZGV4KSA9PiB7CiAgICAgICAgY29uc3QgeyBvZmZzZXQ6IG9mZnNldDIsIHN1cGVyQ29uc3RydWN0b3IgfSA9IGNvZGVJdGVtOwogICAgICAgIGNvbnN0IHJlZ2lzdGVyc1NpemUgPSAxOwogICAgICAgIGNvbnN0IGluc1NpemUgPSAxOwogICAgICAgIGNvbnN0IG91dHNTaXplID0gMTsKICAgICAgICBjb25zdCB0cmllc1NpemUgPSAwOwogICAgICAgIGNvbnN0IGluc25zU2l6ZSA9IDQ7CiAgICAgICAgZGV4LndyaXRlVUludDE2TEUocmVnaXN0ZXJzU2l6ZSwgb2Zmc2V0Mik7CiAgICAgICAgZGV4LndyaXRlVUludDE2TEUoaW5zU2l6ZSwgb2Zmc2V0MiArIDIpOwogICAgICAgIGRleC53cml0ZVVJbnQxNkxFKG91dHNTaXplLCBvZmZzZXQyICsgNCk7CiAgICAgICAgZGV4LndyaXRlVUludDE2TEUodHJpZXNTaXplLCBvZmZzZXQyICsgNik7CiAgICAgICAgZGV4LndyaXRlVUludDMyTEUoZGVidWdJbmZvT2Zmc2V0c1tpbmRleF0sIG9mZnNldDIgKyA4KTsKICAgICAgICBkZXgud3JpdGVVSW50MzJMRShpbnNuc1NpemUsIG9mZnNldDIgKyAxMik7CiAgICAgICAgZGV4LndyaXRlVUludDE2TEUoNDIwOCwgb2Zmc2V0MiArIDE2KTsKICAgICAgICBkZXgud3JpdGVVSW50MTZMRShzdXBlckNvbnN0cnVjdG9yLCBvZmZzZXQyICsgMTgpOwogICAgICAgIGRleC53cml0ZVVJbnQxNkxFKDAsIG9mZnNldDIgKyAyMCk7CiAgICAgICAgZGV4LndyaXRlVUludDE2TEUoMTQsIG9mZnNldDIgKyAyMik7CiAgICAgIH0pOwogICAgICBhbm5vdGF0aW9uRGlyZWN0b3JpZXMuZm9yRWFjaCgoZGlyKSA9PiB7CiAgICAgICAgY29uc3QgZGlyT2Zmc2V0ID0gZGlyLm9mZnNldDsKICAgICAgICBjb25zdCBjbGFzc0Fubm90YXRpb25zT2Zmc2V0ID0gMDsKICAgICAgICBjb25zdCBmaWVsZHNTaXplID0gMDsKICAgICAgICBjb25zdCBhbm5vdGF0ZWRNZXRob2RzU2l6ZSA9IGRpci5tZXRob2RzLmxlbmd0aDsKICAgICAgICBjb25zdCBhbm5vdGF0ZWRQYXJhbWV0ZXJzU2l6ZSA9IDA7CiAgICAgICAgZGV4LndyaXRlVUludDMyTEUoY2xhc3NBbm5vdGF0aW9uc09mZnNldCwgZGlyT2Zmc2V0KTsKICAgICAgICBkZXgud3JpdGVVSW50MzJMRShmaWVsZHNTaXplLCBkaXJPZmZzZXQgKyA0KTsKICAgICAgICBkZXgud3JpdGVVSW50MzJMRShhbm5vdGF0ZWRNZXRob2RzU2l6ZSwgZGlyT2Zmc2V0ICsgOCk7CiAgICAgICAgZGV4LndyaXRlVUludDMyTEUoYW5ub3RhdGVkUGFyYW1ldGVyc1NpemUsIGRpck9mZnNldCArIDEyKTsKICAgICAgICBkaXIubWV0aG9kcy5mb3JFYWNoKChtZXRob2QsIGluZGV4KSA9PiB7CiAgICAgICAgICBjb25zdCBlbnRyeU9mZnNldCA9IGRpck9mZnNldCArIDE2ICsgaW5kZXggKiA4OwogICAgICAgICAgY29uc3QgW21ldGhvZEluZGV4LCBhbm5vdGF0aW9uU2V0XSA9IG1ldGhvZDsKICAgICAgICAgIGRleC53cml0ZVVJbnQzMkxFKG1ldGhvZEluZGV4LCBlbnRyeU9mZnNldCk7CiAgICAgICAgICBkZXgud3JpdGVVSW50MzJMRShhbm5vdGF0aW9uU2V0Lm9mZnNldCwgZW50cnlPZmZzZXQgKyA0KTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIGludGVyZmFjZXMuZm9yRWFjaCgoaWZhY2UsIGluZGV4KSA9PiB7CiAgICAgICAgY29uc3QgaWZhY2VPZmZzZXQgPSBpbnRlcmZhY2VPZmZzZXRzW2luZGV4XTsKICAgICAgICBkZXgud3JpdGVVSW50MzJMRShpZmFjZS50eXBlcy5sZW5ndGgsIGlmYWNlT2Zmc2V0KTsKICAgICAgICBpZmFjZS50eXBlcy5mb3JFYWNoKCh0eXBlLCB0eXBlSW5kZXgpID0+IHsKICAgICAgICAgIGRleC53cml0ZVVJbnQxNkxFKHR5cGUsIGlmYWNlT2Zmc2V0ICsgNCArIHR5cGVJbmRleCAqIDIpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgcGFyYW1ldGVycy5mb3JFYWNoKChwYXJhbSwgaW5kZXgpID0+IHsKICAgICAgICBjb25zdCBwYXJhbU9mZnNldCA9IHBhcmFtZXRlck9mZnNldHNbaW5kZXhdOwogICAgICAgIGRleC53cml0ZVVJbnQzMkxFKHBhcmFtLnR5cGVzLmxlbmd0aCwgcGFyYW1PZmZzZXQpOwogICAgICAgIHBhcmFtLnR5cGVzLmZvckVhY2goKHR5cGUsIHR5cGVJbmRleCkgPT4gewogICAgICAgICAgZGV4LndyaXRlVUludDE2TEUodHlwZSwgcGFyYW1PZmZzZXQgKyA0ICsgdHlwZUluZGV4ICogMik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICBzdHJpbmdDaHVua3MuZm9yRWFjaCgoY2h1bmssIGluZGV4KSA9PiB7CiAgICAgICAgY2h1bmsuY29weShkZXgsIHN0cmluZ09mZnNldHNbaW5kZXhdKTsKICAgICAgfSk7CiAgICAgIGRlYnVnSW5mb09mZnNldHMuZm9yRWFjaCgoZGVidWdJbmZvT2Zmc2V0KSA9PiB7CiAgICAgICAga0RlZmF1bHRDb25zdHJ1Y3RvckRlYnVnSW5mby5jb3B5KGRleCwgZGVidWdJbmZvT2Zmc2V0KTsKICAgICAgfSk7CiAgICAgIHRocm93c0Fubm90YXRpb25CbG9icy5mb3JFYWNoKChhbm5vdGF0aW9uQmxvYiwgaW5kZXgpID0+IHsKICAgICAgICBhbm5vdGF0aW9uQmxvYi5jb3B5KGRleCwgdGhyb3dzQW5ub3RhdGlvbnNbaW5kZXhdLm9mZnNldCk7CiAgICAgIH0pOwogICAgICBjbGFzc0RhdGFCbG9icy5mb3JFYWNoKChjbGFzc0RhdGFCbG9iLCBpbmRleCkgPT4gewogICAgICAgIGNsYXNzRGF0YUJsb2IuY29weShkZXgsIGNsYXNzZXNbaW5kZXhdLmNsYXNzRGF0YS5vZmZzZXQpOwogICAgICB9KTsKICAgICAgZGV4LndyaXRlVUludDMyTEUobWFwTnVtSXRlbXMsIG1hcE9mZnNldCk7CiAgICAgIGNvbnN0IG1hcEl0ZW1zID0gWwogICAgICAgIFtUWVBFX0hFQURFUl9JVEVNLCAxLCBoZWFkZXJPZmZzZXRdLAogICAgICAgIFtUWVBFX1NUUklOR19JRF9JVEVNLCBzdHJpbmdzLmxlbmd0aCwgc3RyaW5nSWRzT2Zmc2V0XSwKICAgICAgICBbVFlQRV9UWVBFX0lEX0lURU0sIHR5cGVzLmxlbmd0aCwgdHlwZUlkc09mZnNldF0sCiAgICAgICAgW1RZUEVfUFJPVE9fSURfSVRFTSwgcHJvdG9zLmxlbmd0aCwgcHJvdG9JZHNPZmZzZXRdCiAgICAgIF07CiAgICAgIGlmIChmaWVsZHMubGVuZ3RoID4gMCkgewogICAgICAgIG1hcEl0ZW1zLnB1c2goW1RZUEVfRklFTERfSURfSVRFTSwgZmllbGRzLmxlbmd0aCwgZmllbGRJZHNPZmZzZXRdKTsKICAgICAgfQogICAgICBtYXBJdGVtcy5wdXNoKFtUWVBFX01FVEhPRF9JRF9JVEVNLCBtZXRob2RzLmxlbmd0aCwgbWV0aG9kSWRzT2Zmc2V0XSk7CiAgICAgIG1hcEl0ZW1zLnB1c2goW1RZUEVfQ0xBU1NfREVGX0lURU0sIGNsYXNzZXMubGVuZ3RoLCBjbGFzc0RlZnNPZmZzZXRdKTsKICAgICAgYW5ub3RhdGlvblNldHMuZm9yRWFjaCgoc2V0LCBpbmRleCkgPT4gewogICAgICAgIG1hcEl0ZW1zLnB1c2goW1RZUEVfQU5OT1RBVElPTl9TRVRfSVRFTSwgc2V0Lml0ZW1zLmxlbmd0aCwgYW5ub3RhdGlvblNldE9mZnNldHNbaW5kZXhdXSk7CiAgICAgIH0pOwogICAgICBqYXZhQ29kZUl0ZW1zLmZvckVhY2goKGNvZGVJdGVtKSA9PiB7CiAgICAgICAgbWFwSXRlbXMucHVzaChbVFlQRV9DT0RFX0lURU0sIDEsIGNvZGVJdGVtLm9mZnNldF0pOwogICAgICB9KTsKICAgICAgYW5ub3RhdGlvbkRpcmVjdG9yaWVzLmZvckVhY2goKGRpcikgPT4gewogICAgICAgIG1hcEl0ZW1zLnB1c2goW1RZUEVfQU5OT1RBVElPTlNfRElSRUNUT1JZX0lURU0sIDEsIGRpci5vZmZzZXRdKTsKICAgICAgfSk7CiAgICAgIGlmICh0eXBlTGlzdExlbmd0aCA+IDApIHsKICAgICAgICBtYXBJdGVtcy5wdXNoKFtUWVBFX1RZUEVfTElTVCwgdHlwZUxpc3RMZW5ndGgsIGludGVyZmFjZU9mZnNldHMuY29uY2F0KHBhcmFtZXRlck9mZnNldHMpWzBdXSk7CiAgICAgIH0KICAgICAgbWFwSXRlbXMucHVzaChbVFlQRV9TVFJJTkdfREFUQV9JVEVNLCBzdHJpbmdzLmxlbmd0aCwgc3RyaW5nT2Zmc2V0c1swXV0pOwogICAgICBkZWJ1Z0luZm9PZmZzZXRzLmZvckVhY2goKGRlYnVnSW5mb09mZnNldCkgPT4gewogICAgICAgIG1hcEl0ZW1zLnB1c2goW1RZUEVfREVCVUdfSU5GT19JVEVNLCAxLCBkZWJ1Z0luZm9PZmZzZXRdKTsKICAgICAgfSk7CiAgICAgIHRocm93c0Fubm90YXRpb25zLmZvckVhY2goKGFubm90YXRpb24pID0+IHsKICAgICAgICBtYXBJdGVtcy5wdXNoKFtUWVBFX0FOTk9UQVRJT05fSVRFTSwgMSwgYW5ub3RhdGlvbi5vZmZzZXRdKTsKICAgICAgfSk7CiAgICAgIGNsYXNzZXMuZm9yRWFjaCgoa2xhc3MpID0+IHsKICAgICAgICBtYXBJdGVtcy5wdXNoKFtUWVBFX0NMQVNTX0RBVEFfSVRFTSwgMSwga2xhc3MuY2xhc3NEYXRhLm9mZnNldF0pOwogICAgICB9KTsKICAgICAgbWFwSXRlbXMucHVzaChbVFlQRV9NQVBfTElTVCwgMSwgbWFwT2Zmc2V0XSk7CiAgICAgIG1hcEl0ZW1zLmZvckVhY2goKGl0ZW0sIGluZGV4KSA9PiB7CiAgICAgICAgY29uc3QgW3R5cGUsIHNpemUsIG9mZnNldDJdID0gaXRlbTsKICAgICAgICBjb25zdCBpdGVtT2Zmc2V0ID0gbWFwT2Zmc2V0ICsgNCArIGluZGV4ICoga01hcEl0ZW1TaXplOwogICAgICAgIGRleC53cml0ZVVJbnQxNkxFKHR5cGUsIGl0ZW1PZmZzZXQpOwogICAgICAgIGRleC53cml0ZVVJbnQzMkxFKHNpemUsIGl0ZW1PZmZzZXQgKyA0KTsKICAgICAgICBkZXgud3JpdGVVSW50MzJMRShvZmZzZXQyLCBpdGVtT2Zmc2V0ICsgOCk7CiAgICAgIH0pOwogICAgICBjb25zdCBoYXNoID0gbmV3IENoZWNrc3VtKCJzaGExIik7CiAgICAgIGhhc2gudXBkYXRlKGRleC5zbGljZShzaWduYXR1cmVPZmZzZXQgKyBzaWduYXR1cmVTaXplKSk7CiAgICAgIEJ1ZmZlcjIuZnJvbShoYXNoLmdldERpZ2VzdCgpKS5jb3B5KGRleCwgc2lnbmF0dXJlT2Zmc2V0KTsKICAgICAgZGV4LndyaXRlVUludDMyTEUoYWRsZXIzMihkZXgsIHNpZ25hdHVyZU9mZnNldCksIGNoZWNrc3VtT2Zmc2V0KTsKICAgICAgcmV0dXJuIGRleDsKICAgIH0KICB9OwogIGZ1bmN0aW9uIG1ha2VDbGFzc0RhdGEoa2xhc3MpIHsKICAgIGNvbnN0IHsgaW5zdGFuY2VGaWVsZHMsIGNvbnN0cnVjdG9yTWV0aG9kcywgdmlydHVhbE1ldGhvZHMgfSA9IGtsYXNzLmNsYXNzRGF0YTsKICAgIGNvbnN0IHN0YXRpY0ZpZWxkc1NpemUgPSAwOwogICAgcmV0dXJuIEJ1ZmZlcjIuZnJvbShbCiAgICAgIHN0YXRpY0ZpZWxkc1NpemUKICAgIF0uY29uY2F0KGNyZWF0ZVVsZWIxMjgoaW5zdGFuY2VGaWVsZHMubGVuZ3RoKSkuY29uY2F0KGNyZWF0ZVVsZWIxMjgoY29uc3RydWN0b3JNZXRob2RzLmxlbmd0aCkpLmNvbmNhdChjcmVhdGVVbGViMTI4KHZpcnR1YWxNZXRob2RzLmxlbmd0aCkpLmNvbmNhdChpbnN0YW5jZUZpZWxkcy5yZWR1Y2UoKHJlc3VsdCwgW2luZGV4RGlmZiwgYWNjZXNzRmxhZ3NdKSA9PiB7CiAgICAgIHJldHVybiByZXN1bHQuY29uY2F0KGNyZWF0ZVVsZWIxMjgoaW5kZXhEaWZmKSkuY29uY2F0KGNyZWF0ZVVsZWIxMjgoYWNjZXNzRmxhZ3MpKTsKICAgIH0sIFtdKSkuY29uY2F0KGNvbnN0cnVjdG9yTWV0aG9kcy5yZWR1Y2UoKHJlc3VsdCwgW2luZGV4RGlmZiwgYWNjZXNzRmxhZ3MsICwgY29kZU9mZnNldF0pID0+IHsKICAgICAgcmV0dXJuIHJlc3VsdC5jb25jYXQoY3JlYXRlVWxlYjEyOChpbmRleERpZmYpKS5jb25jYXQoY3JlYXRlVWxlYjEyOChhY2Nlc3NGbGFncykpLmNvbmNhdChjcmVhdGVVbGViMTI4KGNvZGVPZmZzZXQgfHwgMCkpOwogICAgfSwgW10pKS5jb25jYXQodmlydHVhbE1ldGhvZHMucmVkdWNlKChyZXN1bHQsIFtpbmRleERpZmYsIGFjY2Vzc0ZsYWdzXSkgPT4gewogICAgICBjb25zdCBjb2RlT2Zmc2V0ID0gMDsKICAgICAgcmV0dXJuIHJlc3VsdC5jb25jYXQoY3JlYXRlVWxlYjEyOChpbmRleERpZmYpKS5jb25jYXQoY3JlYXRlVWxlYjEyOChhY2Nlc3NGbGFncykpLmNvbmNhdChbY29kZU9mZnNldF0pOwogICAgfSwgW10pKSk7CiAgfQogIGZ1bmN0aW9uIG1ha2VUaHJvd3NBbm5vdGF0aW9uKGFubm90YXRpb24pIHsKICAgIGNvbnN0IHsgdGhyb3duVHlwZXMgfSA9IGFubm90YXRpb247CiAgICByZXR1cm4gQnVmZmVyMi5mcm9tKAogICAgICBbCiAgICAgICAgVklTSUJJTElUWV9TWVNURU0KICAgICAgXS5jb25jYXQoY3JlYXRlVWxlYjEyOChhbm5vdGF0aW9uLnR5cGUpKS5jb25jYXQoWzFdKS5jb25jYXQoY3JlYXRlVWxlYjEyOChhbm5vdGF0aW9uLnZhbHVlKSkuY29uY2F0KFtWQUxVRV9BUlJBWSwgdGhyb3duVHlwZXMubGVuZ3RoXSkuY29uY2F0KHRocm93blR5cGVzLnJlZHVjZSgocmVzdWx0LCB0eXBlKSA9PiB7CiAgICAgICAgcmVzdWx0LnB1c2goVkFMVUVfVFlQRSwgdHlwZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfSwgW10pKQogICAgKTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZU1vZGVsKGNsYXNzZXMpIHsKICAgIGNvbnN0IHN0cmluZ3MgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgY29uc3QgdHlwZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgY29uc3QgcHJvdG9zID0ge307CiAgICBjb25zdCBmaWVsZHMgPSBbXTsKICAgIGNvbnN0IG1ldGhvZHMgPSBbXTsKICAgIGNvbnN0IHRocm93c0Fubm90YXRpb25zID0ge307CiAgICBjb25zdCBqYXZhQ29uc3RydWN0b3JzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgIGNvbnN0IHN1cGVyQ29uc3RydWN0b3JzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgIGNsYXNzZXMuZm9yRWFjaCgoa2xhc3MpID0+IHsKICAgICAgY29uc3QgeyBuYW1lLCBzdXBlckNsYXNzLCBzb3VyY2VGaWxlTmFtZSB9ID0ga2xhc3M7CiAgICAgIHN0cmluZ3MuYWRkKCJ0aGlzIik7CiAgICAgIHN0cmluZ3MuYWRkKG5hbWUpOwogICAgICB0eXBlcy5hZGQobmFtZSk7CiAgICAgIHN0cmluZ3MuYWRkKHN1cGVyQ2xhc3MpOwogICAgICB0eXBlcy5hZGQoc3VwZXJDbGFzcyk7CiAgICAgIHN0cmluZ3MuYWRkKHNvdXJjZUZpbGVOYW1lKTsKICAgICAga2xhc3MuaW50ZXJmYWNlcy5mb3JFYWNoKChpZmFjZSkgPT4gewogICAgICAgIHN0cmluZ3MuYWRkKGlmYWNlKTsKICAgICAgICB0eXBlcy5hZGQoaWZhY2UpOwogICAgICB9KTsKICAgICAga2xhc3MuZmllbGRzLmZvckVhY2goKGZpZWxkKSA9PiB7CiAgICAgICAgY29uc3QgW2ZpZWxkTmFtZSwgZmllbGRUeXBlXSA9IGZpZWxkOwogICAgICAgIHN0cmluZ3MuYWRkKGZpZWxkTmFtZSk7CiAgICAgICAgc3RyaW5ncy5hZGQoZmllbGRUeXBlKTsKICAgICAgICB0eXBlcy5hZGQoZmllbGRUeXBlKTsKICAgICAgICBmaWVsZHMucHVzaChba2xhc3MubmFtZSwgZmllbGRUeXBlLCBmaWVsZE5hbWVdKTsKICAgICAgfSk7CiAgICAgIGlmICgha2xhc3MubWV0aG9kcy5zb21lKChbbWV0aG9kTmFtZV0pID0+IG1ldGhvZE5hbWUgPT09ICI8aW5pdD4iKSkgewogICAgICAgIGtsYXNzLm1ldGhvZHMudW5zaGlmdChbIjxpbml0PiIsICJWIiwgW11dKTsKICAgICAgICBqYXZhQ29uc3RydWN0b3JzLmFkZChuYW1lKTsKICAgICAgfQogICAgICBrbGFzcy5tZXRob2RzLmZvckVhY2goKG1ldGhvZCkgPT4gewogICAgICAgIGNvbnN0IFttZXRob2ROYW1lLCByZXRUeXBlLCBhcmdUeXBlcywgdGhyb3duVHlwZXMgPSBbXSwgYWNjZXNzRmxhZ3NdID0gbWV0aG9kOwogICAgICAgIHN0cmluZ3MuYWRkKG1ldGhvZE5hbWUpOwogICAgICAgIGNvbnN0IHByb3RvSWQgPSBhZGRQcm90byhyZXRUeXBlLCBhcmdUeXBlcyk7CiAgICAgICAgbGV0IHRocm93c0Fubm90YXRpb25JZCA9IG51bGw7CiAgICAgICAgaWYgKHRocm93blR5cGVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGNvbnN0IHR5cGVzTm9ybWFsaXplZCA9IHRocm93blR5cGVzLnNsaWNlKCk7CiAgICAgICAgICB0eXBlc05vcm1hbGl6ZWQuc29ydCgpOwogICAgICAgICAgdGhyb3dzQW5ub3RhdGlvbklkID0gdHlwZXNOb3JtYWxpemVkLmpvaW4oInwiKTsKICAgICAgICAgIGxldCB0aHJvd3NBbm5vdGF0aW9uID0gdGhyb3dzQW5ub3RhdGlvbnNbdGhyb3dzQW5ub3RhdGlvbklkXTsKICAgICAgICAgIGlmICh0aHJvd3NBbm5vdGF0aW9uID09PSB2b2lkIDApIHsKICAgICAgICAgICAgdGhyb3dzQW5ub3RhdGlvbiA9IHsKICAgICAgICAgICAgICBpZDogdGhyb3dzQW5ub3RhdGlvbklkLAogICAgICAgICAgICAgIHR5cGVzOiB0eXBlc05vcm1hbGl6ZWQKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhyb3dzQW5ub3RhdGlvbnNbdGhyb3dzQW5ub3RhdGlvbklkXSA9IHRocm93c0Fubm90YXRpb247CiAgICAgICAgICB9CiAgICAgICAgICBzdHJpbmdzLmFkZChrRGFsdmlrQW5ub3RhdGlvblR5cGVUaHJvd3MpOwogICAgICAgICAgdHlwZXMuYWRkKGtEYWx2aWtBbm5vdGF0aW9uVHlwZVRocm93cyk7CiAgICAgICAgICB0aHJvd25UeXBlcy5mb3JFYWNoKCh0eXBlKSA9PiB7CiAgICAgICAgICAgIHN0cmluZ3MuYWRkKHR5cGUpOwogICAgICAgICAgICB0eXBlcy5hZGQodHlwZSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHN0cmluZ3MuYWRkKCJ2YWx1ZSIpOwogICAgICAgIH0KICAgICAgICBtZXRob2RzLnB1c2goW2tsYXNzLm5hbWUsIHByb3RvSWQsIG1ldGhvZE5hbWUsIHRocm93c0Fubm90YXRpb25JZCwgYWNjZXNzRmxhZ3NdKTsKICAgICAgICBpZiAobWV0aG9kTmFtZSA9PT0gIjxpbml0PiIpIHsKICAgICAgICAgIHN1cGVyQ29uc3RydWN0b3JzLmFkZChuYW1lICsgInwiICsgcHJvdG9JZCk7CiAgICAgICAgICBjb25zdCBzdXBlckNvbnN0cnVjdG9ySWQgPSBzdXBlckNsYXNzICsgInwiICsgcHJvdG9JZDsKICAgICAgICAgIGlmIChqYXZhQ29uc3RydWN0b3JzLmhhcyhuYW1lKSAmJiAhc3VwZXJDb25zdHJ1Y3RvcnMuaGFzKHN1cGVyQ29uc3RydWN0b3JJZCkpIHsKICAgICAgICAgICAgbWV0aG9kcy5wdXNoKFtzdXBlckNsYXNzLCBwcm90b0lkLCBtZXRob2ROYW1lLCBudWxsLCAwXSk7CiAgICAgICAgICAgIHN1cGVyQ29uc3RydWN0b3JzLmFkZChzdXBlckNvbnN0cnVjdG9ySWQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICAgIGZ1bmN0aW9uIGFkZFByb3RvKHJldFR5cGUsIGFyZ1R5cGVzKSB7CiAgICAgIGNvbnN0IHNpZ25hdHVyZSA9IFtyZXRUeXBlXS5jb25jYXQoYXJnVHlwZXMpOwogICAgICBjb25zdCBpZCA9IHNpZ25hdHVyZS5qb2luKCJ8Iik7CiAgICAgIGlmIChwcm90b3NbaWRdICE9PSB2b2lkIDApIHsKICAgICAgICByZXR1cm4gaWQ7CiAgICAgIH0KICAgICAgc3RyaW5ncy5hZGQocmV0VHlwZSk7CiAgICAgIHR5cGVzLmFkZChyZXRUeXBlKTsKICAgICAgYXJnVHlwZXMuZm9yRWFjaCgoYXJnVHlwZSkgPT4gewogICAgICAgIHN0cmluZ3MuYWRkKGFyZ1R5cGUpOwogICAgICAgIHR5cGVzLmFkZChhcmdUeXBlKTsKICAgICAgfSk7CiAgICAgIGNvbnN0IHNob3J0eSA9IHNpZ25hdHVyZS5tYXAodHlwZVRvU2hvcnR5KS5qb2luKCIiKTsKICAgICAgc3RyaW5ncy5hZGQoc2hvcnR5KTsKICAgICAgcHJvdG9zW2lkXSA9IFtpZCwgc2hvcnR5LCByZXRUeXBlLCBhcmdUeXBlc107CiAgICAgIHJldHVybiBpZDsKICAgIH0KICAgIGNvbnN0IHN0cmluZ0l0ZW1zID0gQXJyYXkuZnJvbShzdHJpbmdzKTsKICAgIHN0cmluZ0l0ZW1zLnNvcnQoKTsKICAgIGNvbnN0IHN0cmluZ1RvSW5kZXggPSBzdHJpbmdJdGVtcy5yZWR1Y2UoKHJlc3VsdCwgc3RyaW5nLCBpbmRleCkgPT4gewogICAgICByZXN1bHRbc3RyaW5nXSA9IGluZGV4OwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwge30pOwogICAgY29uc3QgdHlwZUl0ZW1zID0gQXJyYXkuZnJvbSh0eXBlcykubWFwKChuYW1lKSA9PiBzdHJpbmdUb0luZGV4W25hbWVdKTsKICAgIHR5cGVJdGVtcy5zb3J0KGNvbXBhcmVOdW1iZXJzKTsKICAgIGNvbnN0IHR5cGVUb0luZGV4ID0gdHlwZUl0ZW1zLnJlZHVjZSgocmVzdWx0LCBzdHJpbmdJbmRleCwgdHlwZUluZGV4KSA9PiB7CiAgICAgIHJlc3VsdFtzdHJpbmdJdGVtc1tzdHJpbmdJbmRleF1dID0gdHlwZUluZGV4OwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwge30pOwogICAgY29uc3QgbGl0ZXJhbFByb3RvSXRlbXMgPSBPYmplY3Qua2V5cyhwcm90b3MpLm1hcCgoaWQpID0+IHByb3Rvc1tpZF0pOwogICAgbGl0ZXJhbFByb3RvSXRlbXMuc29ydChjb21wYXJlUHJvdG9JdGVtcyk7CiAgICBjb25zdCBwYXJhbWV0ZXJzID0ge307CiAgICBjb25zdCBwcm90b0l0ZW1zID0gbGl0ZXJhbFByb3RvSXRlbXMubWFwKChpdGVtKSA9PiB7CiAgICAgIGNvbnN0IFssIHNob3J0eSwgcmV0VHlwZSwgYXJnVHlwZXNdID0gaXRlbTsKICAgICAgbGV0IHBhcmFtczsKICAgICAgaWYgKGFyZ1R5cGVzLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zdCBhcmdUeXBlc1NpZyA9IGFyZ1R5cGVzLmpvaW4oInwiKTsKICAgICAgICBwYXJhbXMgPSBwYXJhbWV0ZXJzW2FyZ1R5cGVzU2lnXTsKICAgICAgICBpZiAocGFyYW1zID09PSB2b2lkIDApIHsKICAgICAgICAgIHBhcmFtcyA9IHsKICAgICAgICAgICAgdHlwZXM6IGFyZ1R5cGVzLm1hcCgodHlwZSkgPT4gdHlwZVRvSW5kZXhbdHlwZV0pLAogICAgICAgICAgICBvZmZzZXQ6IC0xCiAgICAgICAgICB9OwogICAgICAgICAgcGFyYW1ldGVyc1thcmdUeXBlc1NpZ10gPSBwYXJhbXM7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHBhcmFtcyA9IG51bGw7CiAgICAgIH0KICAgICAgcmV0dXJuIFsKICAgICAgICBzdHJpbmdUb0luZGV4W3Nob3J0eV0sCiAgICAgICAgdHlwZVRvSW5kZXhbcmV0VHlwZV0sCiAgICAgICAgcGFyYW1zCiAgICAgIF07CiAgICB9KTsKICAgIGNvbnN0IHByb3RvVG9JbmRleCA9IGxpdGVyYWxQcm90b0l0ZW1zLnJlZHVjZSgocmVzdWx0LCBpdGVtLCBpbmRleCkgPT4gewogICAgICBjb25zdCBbaWRdID0gaXRlbTsKICAgICAgcmVzdWx0W2lkXSA9IGluZGV4OwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwge30pOwogICAgY29uc3QgcGFyYW1ldGVySXRlbXMgPSBPYmplY3Qua2V5cyhwYXJhbWV0ZXJzKS5tYXAoKGlkKSA9PiBwYXJhbWV0ZXJzW2lkXSk7CiAgICBjb25zdCBmaWVsZEl0ZW1zID0gZmllbGRzLm1hcCgoZmllbGQpID0+IHsKICAgICAgY29uc3QgW2tsYXNzLCBmaWVsZFR5cGUsIGZpZWxkTmFtZV0gPSBmaWVsZDsKICAgICAgcmV0dXJuIFsKICAgICAgICB0eXBlVG9JbmRleFtrbGFzc10sCiAgICAgICAgdHlwZVRvSW5kZXhbZmllbGRUeXBlXSwKICAgICAgICBzdHJpbmdUb0luZGV4W2ZpZWxkTmFtZV0KICAgICAgXTsKICAgIH0pOwogICAgZmllbGRJdGVtcy5zb3J0KGNvbXBhcmVGaWVsZEl0ZW1zKTsKICAgIGNvbnN0IG1ldGhvZEl0ZW1zID0gbWV0aG9kcy5tYXAoKG1ldGhvZCkgPT4gewogICAgICBjb25zdCBba2xhc3MsIHByb3RvSWQsIG5hbWUsIGFubm90YXRpb25zSWQsIGFjY2Vzc0ZsYWdzXSA9IG1ldGhvZDsKICAgICAgcmV0dXJuIFsKICAgICAgICB0eXBlVG9JbmRleFtrbGFzc10sCiAgICAgICAgcHJvdG9Ub0luZGV4W3Byb3RvSWRdLAogICAgICAgIHN0cmluZ1RvSW5kZXhbbmFtZV0sCiAgICAgICAgYW5ub3RhdGlvbnNJZCwKICAgICAgICBhY2Nlc3NGbGFncwogICAgICBdOwogICAgfSk7CiAgICBtZXRob2RJdGVtcy5zb3J0KGNvbXBhcmVNZXRob2RJdGVtcyk7CiAgICBjb25zdCB0aHJvd3NBbm5vdGF0aW9uSXRlbXMgPSBPYmplY3Qua2V5cyh0aHJvd3NBbm5vdGF0aW9ucykubWFwKChpZCkgPT4gdGhyb3dzQW5ub3RhdGlvbnNbaWRdKS5tYXAoKGl0ZW0pID0+IHsKICAgICAgcmV0dXJuIHsKICAgICAgICBpZDogaXRlbS5pZCwKICAgICAgICB0eXBlOiB0eXBlVG9JbmRleFtrRGFsdmlrQW5ub3RhdGlvblR5cGVUaHJvd3NdLAogICAgICAgIHZhbHVlOiBzdHJpbmdUb0luZGV4LnZhbHVlLAogICAgICAgIHRocm93blR5cGVzOiBpdGVtLnR5cGVzLm1hcCgodHlwZSkgPT4gdHlwZVRvSW5kZXhbdHlwZV0pLAogICAgICAgIG9mZnNldDogLTEKICAgICAgfTsKICAgIH0pOwogICAgY29uc3QgYW5ub3RhdGlvblNldEl0ZW1zID0gdGhyb3dzQW5ub3RhdGlvbkl0ZW1zLm1hcCgoaXRlbSkgPT4gewogICAgICByZXR1cm4gewogICAgICAgIGlkOiBpdGVtLmlkLAogICAgICAgIGl0ZW1zOiBbaXRlbV0sCiAgICAgICAgb2Zmc2V0OiAtMQogICAgICB9OwogICAgfSk7CiAgICBjb25zdCBhbm5vdGF0aW9uU2V0SWRUb0luZGV4ID0gYW5ub3RhdGlvblNldEl0ZW1zLnJlZHVjZSgocmVzdWx0LCBpdGVtLCBpbmRleCkgPT4gewogICAgICByZXN1bHRbaXRlbS5pZF0gPSBpbmRleDsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0sIHt9KTsKICAgIGNvbnN0IGludGVyZmFjZUxpc3RzID0ge307CiAgICBjb25zdCBhbm5vdGF0aW9uRGlyZWN0b3JpZXMgPSBbXTsKICAgIGNvbnN0IGNsYXNzSXRlbXMgPSBjbGFzc2VzLm1hcCgoa2xhc3MpID0+IHsKICAgICAgY29uc3QgY2xhc3NJbmRleCA9IHR5cGVUb0luZGV4W2tsYXNzLm5hbWVdOwogICAgICBjb25zdCBhY2Nlc3NGbGFncyA9IGtBY2NQdWJsaWMyOwogICAgICBjb25zdCBzdXBlckNsYXNzSW5kZXggPSB0eXBlVG9JbmRleFtrbGFzcy5zdXBlckNsYXNzXTsKICAgICAgbGV0IGlmYWNlTGlzdDsKICAgICAgY29uc3QgaWZhY2VzID0ga2xhc3MuaW50ZXJmYWNlcy5tYXAoKHR5cGUpID0+IHR5cGVUb0luZGV4W3R5cGVdKTsKICAgICAgaWYgKGlmYWNlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgaWZhY2VzLnNvcnQoY29tcGFyZU51bWJlcnMpOwogICAgICAgIGNvbnN0IGlmYWNlc0lkID0gaWZhY2VzLmpvaW4oInwiKTsKICAgICAgICBpZmFjZUxpc3QgPSBpbnRlcmZhY2VMaXN0c1tpZmFjZXNJZF07CiAgICAgICAgaWYgKGlmYWNlTGlzdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICBpZmFjZUxpc3QgPSB7CiAgICAgICAgICAgIHR5cGVzOiBpZmFjZXMsCiAgICAgICAgICAgIG9mZnNldDogLTEKICAgICAgICAgIH07CiAgICAgICAgICBpbnRlcmZhY2VMaXN0c1tpZmFjZXNJZF0gPSBpZmFjZUxpc3Q7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmYWNlTGlzdCA9IG51bGw7CiAgICAgIH0KICAgICAgY29uc3Qgc291cmNlRmlsZUluZGV4ID0gc3RyaW5nVG9JbmRleFtrbGFzcy5zb3VyY2VGaWxlTmFtZV07CiAgICAgIGNvbnN0IGNsYXNzTWV0aG9kcyA9IG1ldGhvZEl0ZW1zLnJlZHVjZSgocmVzdWx0LCBtZXRob2QsIGluZGV4KSA9PiB7CiAgICAgICAgY29uc3QgW2hvbGRlciwgcHJvdG9JbmRleCwgbmFtZSwgYW5ub3RhdGlvbnNJZCwgYWNjZXNzRmxhZ3MyXSA9IG1ldGhvZDsKICAgICAgICBpZiAoaG9sZGVyID09PSBjbGFzc0luZGV4KSB7CiAgICAgICAgICByZXN1bHQucHVzaChbaW5kZXgsIG5hbWUsIGFubm90YXRpb25zSWQsIHByb3RvSW5kZXgsIGFjY2Vzc0ZsYWdzMl0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9LCBbXSk7CiAgICAgIGxldCBhbm5vdGF0aW9uc0RpcmVjdG9yeSA9IG51bGw7CiAgICAgIGNvbnN0IG1ldGhvZEFubm90YXRpb25zID0gY2xhc3NNZXRob2RzLmZpbHRlcigoWywgLCBhbm5vdGF0aW9uc0lkXSkgPT4gewogICAgICAgIHJldHVybiBhbm5vdGF0aW9uc0lkICE9PSBudWxsOwogICAgICB9KS5tYXAoKFtpbmRleCwgLCBhbm5vdGF0aW9uc0lkXSkgPT4gewogICAgICAgIHJldHVybiBbaW5kZXgsIGFubm90YXRpb25TZXRJdGVtc1thbm5vdGF0aW9uU2V0SWRUb0luZGV4W2Fubm90YXRpb25zSWRdXV07CiAgICAgIH0pOwogICAgICBpZiAobWV0aG9kQW5ub3RhdGlvbnMubGVuZ3RoID4gMCkgewogICAgICAgIGFubm90YXRpb25zRGlyZWN0b3J5ID0gewogICAgICAgICAgbWV0aG9kczogbWV0aG9kQW5ub3RhdGlvbnMsCiAgICAgICAgICBvZmZzZXQ6IC0xCiAgICAgICAgfTsKICAgICAgICBhbm5vdGF0aW9uRGlyZWN0b3JpZXMucHVzaChhbm5vdGF0aW9uc0RpcmVjdG9yeSk7CiAgICAgIH0KICAgICAgY29uc3QgaW5zdGFuY2VGaWVsZHMgPSBmaWVsZEl0ZW1zLnJlZHVjZSgocmVzdWx0LCBmaWVsZCwgaW5kZXgpID0+IHsKICAgICAgICBjb25zdCBbaG9sZGVyXSA9IGZpZWxkOwogICAgICAgIGlmIChob2xkZXIgPT09IGNsYXNzSW5kZXgpIHsKICAgICAgICAgIHJlc3VsdC5wdXNoKFtpbmRleCA+IDAgPyAxIDogMCwga0FjY1B1YmxpYzJdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfSwgW10pOwogICAgICBjb25zdCBjb25zdHJ1Y3Rvck5hbWVJbmRleCA9IHN0cmluZ1RvSW5kZXhbIjxpbml0PiJdOwogICAgICBjb25zdCBjb25zdHJ1Y3Rvck1ldGhvZHMgPSBjbGFzc01ldGhvZHMuZmlsdGVyKChbLCBuYW1lXSkgPT4gbmFtZSA9PT0gY29uc3RydWN0b3JOYW1lSW5kZXgpLm1hcCgoW2luZGV4LCAsICwgcHJvdG9JbmRleF0pID0+IHsKICAgICAgICBpZiAoamF2YUNvbnN0cnVjdG9ycy5oYXMoa2xhc3MubmFtZSkpIHsKICAgICAgICAgIGxldCBzdXBlckNvbnN0cnVjdG9yID0gLTE7CiAgICAgICAgICBjb25zdCBudW1NZXRob2RJdGVtcyA9IG1ldGhvZEl0ZW1zLmxlbmd0aDsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBudW1NZXRob2RJdGVtczsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IFttZXRob2RDbGFzcywgbWV0aG9kUHJvdG8sIG1ldGhvZE5hbWVdID0gbWV0aG9kSXRlbXNbaV07CiAgICAgICAgICAgIGlmIChtZXRob2RDbGFzcyA9PT0gc3VwZXJDbGFzc0luZGV4ICYmIG1ldGhvZE5hbWUgPT09IGNvbnN0cnVjdG9yTmFtZUluZGV4ICYmIG1ldGhvZFByb3RvID09PSBwcm90b0luZGV4KSB7CiAgICAgICAgICAgICAgc3VwZXJDb25zdHJ1Y3RvciA9IGk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBbaW5kZXgsIGtBY2NQdWJsaWMyIHwga0FjY0NvbnN0cnVjdG9yLCBzdXBlckNvbnN0cnVjdG9yXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIFtpbmRleCwga0FjY1B1YmxpYzIgfCBrQWNjQ29uc3RydWN0b3IgfCBrQWNjTmF0aXZlMiwgLTFdOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGNvbnN0IHZpcnR1YWxNZXRob2RzID0gY29tcHJlc3NDbGFzc01ldGhvZEluZGV4ZXMoY2xhc3NNZXRob2RzLmZpbHRlcigoWywgbmFtZV0pID0+IG5hbWUgIT09IGNvbnN0cnVjdG9yTmFtZUluZGV4KS5tYXAoKFtpbmRleCwgLCAsICwgYWNjZXNzRmxhZ3MyXSkgPT4gewogICAgICAgIHJldHVybiBbaW5kZXgsIGFjY2Vzc0ZsYWdzMiB8IGtBY2NQdWJsaWMyIHwga0FjY05hdGl2ZTJdOwogICAgICB9KSk7CiAgICAgIGNvbnN0IGNsYXNzRGF0YSA9IHsKICAgICAgICBpbnN0YW5jZUZpZWxkcywKICAgICAgICBjb25zdHJ1Y3Rvck1ldGhvZHMsCiAgICAgICAgdmlydHVhbE1ldGhvZHMsCiAgICAgICAgb2Zmc2V0OiAtMQogICAgICB9OwogICAgICByZXR1cm4gewogICAgICAgIGluZGV4OiBjbGFzc0luZGV4LAogICAgICAgIGFjY2Vzc0ZsYWdzLAogICAgICAgIHN1cGVyQ2xhc3NJbmRleCwKICAgICAgICBpbnRlcmZhY2VzOiBpZmFjZUxpc3QsCiAgICAgICAgc291cmNlRmlsZUluZGV4LAogICAgICAgIGFubm90YXRpb25zRGlyZWN0b3J5LAogICAgICAgIGNsYXNzRGF0YQogICAgICB9OwogICAgfSk7CiAgICBjb25zdCBpbnRlcmZhY2VJdGVtcyA9IE9iamVjdC5rZXlzKGludGVyZmFjZUxpc3RzKS5tYXAoKGlkKSA9PiBpbnRlcmZhY2VMaXN0c1tpZF0pOwogICAgcmV0dXJuIHsKICAgICAgY2xhc3NlczogY2xhc3NJdGVtcywKICAgICAgaW50ZXJmYWNlczogaW50ZXJmYWNlSXRlbXMsCiAgICAgIGZpZWxkczogZmllbGRJdGVtcywKICAgICAgbWV0aG9kczogbWV0aG9kSXRlbXMsCiAgICAgIHByb3RvczogcHJvdG9JdGVtcywKICAgICAgcGFyYW1ldGVyczogcGFyYW1ldGVySXRlbXMsCiAgICAgIGFubm90YXRpb25EaXJlY3RvcmllcywKICAgICAgYW5ub3RhdGlvblNldHM6IGFubm90YXRpb25TZXRJdGVtcywKICAgICAgdGhyb3dzQW5ub3RhdGlvbnM6IHRocm93c0Fubm90YXRpb25JdGVtcywKICAgICAgdHlwZXM6IHR5cGVJdGVtcywKICAgICAgc3RyaW5nczogc3RyaW5nSXRlbXMKICAgIH07CiAgfQogIGZ1bmN0aW9uIGNvbXByZXNzQ2xhc3NNZXRob2RJbmRleGVzKGl0ZW1zKSB7CiAgICBsZXQgcHJldmlvdXNJbmRleCA9IDA7CiAgICByZXR1cm4gaXRlbXMubWFwKChbaW5kZXgsIGFjY2Vzc0ZsYWdzXSwgZWxlbWVudEluZGV4KSA9PiB7CiAgICAgIGxldCByZXN1bHQ7CiAgICAgIGlmIChlbGVtZW50SW5kZXggPT09IDApIHsKICAgICAgICByZXN1bHQgPSBbaW5kZXgsIGFjY2Vzc0ZsYWdzXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHQgPSBbaW5kZXggLSBwcmV2aW91c0luZGV4LCBhY2Nlc3NGbGFnc107CiAgICAgIH0KICAgICAgcHJldmlvdXNJbmRleCA9IGluZGV4OwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIGNvbXBhcmVOdW1iZXJzKGEsIGIpIHsKICAgIHJldHVybiBhIC0gYjsKICB9CiAgZnVuY3Rpb24gY29tcGFyZVByb3RvSXRlbXMoYSwgYikgewogICAgY29uc3QgWywgLCBhUmV0VHlwZSwgYUFyZ1R5cGVzXSA9IGE7CiAgICBjb25zdCBbLCAsIGJSZXRUeXBlLCBiQXJnVHlwZXNdID0gYjsKICAgIGlmIChhUmV0VHlwZSA8IGJSZXRUeXBlKSB7CiAgICAgIHJldHVybiAtMTsKICAgIH0KICAgIGlmIChhUmV0VHlwZSA+IGJSZXRUeXBlKSB7CiAgICAgIHJldHVybiAxOwogICAgfQogICAgY29uc3QgYUFyZ1R5cGVzU2lnID0gYUFyZ1R5cGVzLmpvaW4oInwiKTsKICAgIGNvbnN0IGJBcmdUeXBlc1NpZyA9IGJBcmdUeXBlcy5qb2luKCJ8Iik7CiAgICBpZiAoYUFyZ1R5cGVzU2lnIDwgYkFyZ1R5cGVzU2lnKSB7CiAgICAgIHJldHVybiAtMTsKICAgIH0KICAgIGlmIChhQXJnVHlwZXNTaWcgPiBiQXJnVHlwZXNTaWcpIHsKICAgICAgcmV0dXJuIDE7CiAgICB9CiAgICByZXR1cm4gMDsKICB9CiAgZnVuY3Rpb24gY29tcGFyZUZpZWxkSXRlbXMoYSwgYikgewogICAgY29uc3QgW2FDbGFzcywgYVR5cGUsIGFOYW1lXSA9IGE7CiAgICBjb25zdCBbYkNsYXNzLCBiVHlwZSwgYk5hbWVdID0gYjsKICAgIGlmIChhQ2xhc3MgIT09IGJDbGFzcykgewogICAgICByZXR1cm4gYUNsYXNzIC0gYkNsYXNzOwogICAgfQogICAgaWYgKGFOYW1lICE9PSBiTmFtZSkgewogICAgICByZXR1cm4gYU5hbWUgLSBiTmFtZTsKICAgIH0KICAgIHJldHVybiBhVHlwZSAtIGJUeXBlOwogIH0KICBmdW5jdGlvbiBjb21wYXJlTWV0aG9kSXRlbXMoYSwgYikgewogICAgY29uc3QgW2FDbGFzcywgYVByb3RvLCBhTmFtZV0gPSBhOwogICAgY29uc3QgW2JDbGFzcywgYlByb3RvLCBiTmFtZV0gPSBiOwogICAgaWYgKGFDbGFzcyAhPT0gYkNsYXNzKSB7CiAgICAgIHJldHVybiBhQ2xhc3MgLSBiQ2xhc3M7CiAgICB9CiAgICBpZiAoYU5hbWUgIT09IGJOYW1lKSB7CiAgICAgIHJldHVybiBhTmFtZSAtIGJOYW1lOwogICAgfQogICAgcmV0dXJuIGFQcm90byAtIGJQcm90bzsKICB9CiAgZnVuY3Rpb24gdHlwZVRvU2hvcnR5KHR5cGUpIHsKICAgIGNvbnN0IGZpcnN0Q2hhcmFjdGVyID0gdHlwZVswXTsKICAgIHJldHVybiBmaXJzdENoYXJhY3RlciA9PT0gIkwiIHx8IGZpcnN0Q2hhcmFjdGVyID09PSAiWyIgPyAiTCIgOiB0eXBlOwogIH0KICBmdW5jdGlvbiBjcmVhdGVVbGViMTI4KHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPD0gMTI3KSB7CiAgICAgIHJldHVybiBbdmFsdWVdOwogICAgfQogICAgY29uc3QgcmVzdWx0ID0gW107CiAgICBsZXQgbW9yZVNsaWNlc05lZWRlZCA9IGZhbHNlOwogICAgZG8gewogICAgICBsZXQgc2xpY2UyID0gdmFsdWUgJiAxMjc7CiAgICAgIHZhbHVlID4+PSA3OwogICAgICBtb3JlU2xpY2VzTmVlZGVkID0gdmFsdWUgIT09IDA7CiAgICAgIGlmIChtb3JlU2xpY2VzTmVlZGVkKSB7CiAgICAgICAgc2xpY2UyIHw9IDEyODsKICAgICAgfQogICAgICByZXN1bHQucHVzaChzbGljZTIpOwogICAgfSB3aGlsZSAobW9yZVNsaWNlc05lZWRlZCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBhbGlnbih2YWx1ZSwgYWxpZ25tZW50KSB7CiAgICBjb25zdCBhbGlnbm1lbnREZWx0YSA9IHZhbHVlICUgYWxpZ25tZW50OwogICAgaWYgKGFsaWdubWVudERlbHRhID09PSAwKSB7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIHJldHVybiB2YWx1ZSArIGFsaWdubWVudCAtIGFsaWdubWVudERlbHRhOwogIH0KICBmdW5jdGlvbiBhZGxlcjMyKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICBsZXQgYSA9IDE7CiAgICBsZXQgYiA9IDA7CiAgICBjb25zdCBsZW5ndGggPSBidWZmZXIubGVuZ3RoOwogICAgZm9yIChsZXQgaSA9IG9mZnNldDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIGEgPSAoYSArIGJ1ZmZlcltpXSkgJSA2NTUyMTsKICAgICAgYiA9IChiICsgYSkgJSA2NTUyMTsKICAgIH0KICAgIHJldHVybiAoYiA8PCAxNiB8IGEpID4+PiAwOwogIH0KICB2YXIgbWtkZXhfZGVmYXVsdCA9IG1rZGV4OwoKICAvLyBub2RlX21vZHVsZXMvZnJpZGEtamF2YS1icmlkZ2UvbGliL3R5cGVzLmpzCiAgdmFyIEpOSUxvY2FsUmVmVHlwZSA9IDE7CiAgdmFyIHZtID0gbnVsbDsKICB2YXIgcHJpbWl0aXZlQXJyYXlIYW5kbGVyID0gbnVsbDsKICBmdW5jdGlvbiBpbml0aWFsaXplKF92bSkgewogICAgdm0gPSBfdm07CiAgfQogIGZ1bmN0aW9uIGdldFR5cGUodHlwZU5hbWUsIHVuYm94LCBmYWN0b3J5KSB7CiAgICBsZXQgdHlwZSA9IGdldFByaW1pdGl2ZVR5cGUodHlwZU5hbWUpOwogICAgaWYgKHR5cGUgPT09IG51bGwpIHsKICAgICAgaWYgKHR5cGVOYW1lLmluZGV4T2YoIlsiKSA9PT0gMCkgewogICAgICAgIHR5cGUgPSBnZXRBcnJheVR5cGUodHlwZU5hbWUsIHVuYm94LCBmYWN0b3J5KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodHlwZU5hbWVbMF0gPT09ICJMIiAmJiB0eXBlTmFtZVt0eXBlTmFtZS5sZW5ndGggLSAxXSA9PT0gIjsiKSB7CiAgICAgICAgICB0eXBlTmFtZSA9IHR5cGVOYW1lLnN1YnN0cmluZygxLCB0eXBlTmFtZS5sZW5ndGggLSAxKTsKICAgICAgICB9CiAgICAgICAgdHlwZSA9IGdldE9iamVjdFR5cGUodHlwZU5hbWUsIHVuYm94LCBmYWN0b3J5KTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oeyBjbGFzc05hbWU6IHR5cGVOYW1lIH0sIHR5cGUpOwogIH0KICB2YXIgcHJpbWl0aXZlVHlwZXMgPSB7CiAgICBib29sZWFuOiB7CiAgICAgIG5hbWU6ICJaIiwKICAgICAgdHlwZTogInVpbnQ4IiwKICAgICAgc2l6ZTogMSwKICAgICAgYnl0ZVNpemU6IDEsCiAgICAgIGRlZmF1bHRWYWx1ZTogZmFsc2UsCiAgICAgIGlzQ29tcGF0aWJsZSh2KSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiB2ID09PSAiYm9vbGVhbiI7CiAgICAgIH0sCiAgICAgIGZyb21KbmkodikgewogICAgICAgIHJldHVybiAhIXY7CiAgICAgIH0sCiAgICAgIHRvSm5pKHYpIHsKICAgICAgICByZXR1cm4gdiA/IDEgOiAwOwogICAgICB9LAogICAgICByZWFkKGFkZHJlc3MpIHsKICAgICAgICByZXR1cm4gYWRkcmVzcy5yZWFkVTgoKTsKICAgICAgfSwKICAgICAgd3JpdGUoYWRkcmVzcywgdmFsdWUpIHsKICAgICAgICBhZGRyZXNzLndyaXRlVTgodmFsdWUpOwogICAgICB9LAogICAgICB0b1N0cmluZygpIHsKICAgICAgICByZXR1cm4gdGhpcy5uYW1lOwogICAgICB9CiAgICB9LAogICAgYnl0ZTogewogICAgICBuYW1lOiAiQiIsCiAgICAgIHR5cGU6ICJpbnQ4IiwKICAgICAgc2l6ZTogMSwKICAgICAgYnl0ZVNpemU6IDEsCiAgICAgIGRlZmF1bHRWYWx1ZTogMCwKICAgICAgaXNDb21wYXRpYmxlKHYpIHsKICAgICAgICByZXR1cm4gTnVtYmVyLmlzSW50ZWdlcih2KSAmJiB2ID49IC0xMjggJiYgdiA8PSAxMjc7CiAgICAgIH0sCiAgICAgIGZyb21Kbmk6IGlkZW50aXR5LAogICAgICB0b0puaTogaWRlbnRpdHksCiAgICAgIHJlYWQoYWRkcmVzcykgewogICAgICAgIHJldHVybiBhZGRyZXNzLnJlYWRTOCgpOwogICAgICB9LAogICAgICB3cml0ZShhZGRyZXNzLCB2YWx1ZSkgewogICAgICAgIGFkZHJlc3Mud3JpdGVTOCh2YWx1ZSk7CiAgICAgIH0sCiAgICAgIHRvU3RyaW5nKCkgewogICAgICAgIHJldHVybiB0aGlzLm5hbWU7CiAgICAgIH0KICAgIH0sCiAgICBjaGFyOiB7CiAgICAgIG5hbWU6ICJDIiwKICAgICAgdHlwZTogInVpbnQxNiIsCiAgICAgIHNpemU6IDEsCiAgICAgIGJ5dGVTaXplOiAyLAogICAgICBkZWZhdWx0VmFsdWU6IDAsCiAgICAgIGlzQ29tcGF0aWJsZSh2KSB7CiAgICAgICAgaWYgKHR5cGVvZiB2ICE9PSAic3RyaW5nIiB8fCB2Lmxlbmd0aCAhPT0gMSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb2RlMiA9IHYuY2hhckNvZGVBdCgwKTsKICAgICAgICByZXR1cm4gY29kZTIgPj0gMCAmJiBjb2RlMiA8PSA2NTUzNTsKICAgICAgfSwKICAgICAgZnJvbUpuaShjKSB7CiAgICAgICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoYyk7CiAgICAgIH0sCiAgICAgIHRvSm5pKHMpIHsKICAgICAgICByZXR1cm4gcy5jaGFyQ29kZUF0KDApOwogICAgICB9LAogICAgICByZWFkKGFkZHJlc3MpIHsKICAgICAgICByZXR1cm4gYWRkcmVzcy5yZWFkVTE2KCk7CiAgICAgIH0sCiAgICAgIHdyaXRlKGFkZHJlc3MsIHZhbHVlKSB7CiAgICAgICAgYWRkcmVzcy53cml0ZVUxNih2YWx1ZSk7CiAgICAgIH0sCiAgICAgIHRvU3RyaW5nKCkgewogICAgICAgIHJldHVybiB0aGlzLm5hbWU7CiAgICAgIH0KICAgIH0sCiAgICBzaG9ydDogewogICAgICBuYW1lOiAiUyIsCiAgICAgIHR5cGU6ICJpbnQxNiIsCiAgICAgIHNpemU6IDEsCiAgICAgIGJ5dGVTaXplOiAyLAogICAgICBkZWZhdWx0VmFsdWU6IDAsCiAgICAgIGlzQ29tcGF0aWJsZSh2KSB7CiAgICAgICAgcmV0dXJuIE51bWJlci5pc0ludGVnZXIodikgJiYgdiA+PSAtMzI3NjggJiYgdiA8PSAzMjc2NzsKICAgICAgfSwKICAgICAgZnJvbUpuaTogaWRlbnRpdHksCiAgICAgIHRvSm5pOiBpZGVudGl0eSwKICAgICAgcmVhZChhZGRyZXNzKSB7CiAgICAgICAgcmV0dXJuIGFkZHJlc3MucmVhZFMxNigpOwogICAgICB9LAogICAgICB3cml0ZShhZGRyZXNzLCB2YWx1ZSkgewogICAgICAgIGFkZHJlc3Mud3JpdGVTMTYodmFsdWUpOwogICAgICB9LAogICAgICB0b1N0cmluZygpIHsKICAgICAgICByZXR1cm4gdGhpcy5uYW1lOwogICAgICB9CiAgICB9LAogICAgaW50OiB7CiAgICAgIG5hbWU6ICJJIiwKICAgICAgdHlwZTogImludDMyIiwKICAgICAgc2l6ZTogMSwKICAgICAgYnl0ZVNpemU6IDQsCiAgICAgIGRlZmF1bHRWYWx1ZTogMCwKICAgICAgaXNDb21wYXRpYmxlKHYpIHsKICAgICAgICByZXR1cm4gTnVtYmVyLmlzSW50ZWdlcih2KSAmJiB2ID49IC0yMTQ3NDgzNjQ4ICYmIHYgPD0gMjE0NzQ4MzY0NzsKICAgICAgfSwKICAgICAgZnJvbUpuaTogaWRlbnRpdHksCiAgICAgIHRvSm5pOiBpZGVudGl0eSwKICAgICAgcmVhZChhZGRyZXNzKSB7CiAgICAgICAgcmV0dXJuIGFkZHJlc3MucmVhZFMzMigpOwogICAgICB9LAogICAgICB3cml0ZShhZGRyZXNzLCB2YWx1ZSkgewogICAgICAgIGFkZHJlc3Mud3JpdGVTMzIodmFsdWUpOwogICAgICB9LAogICAgICB0b1N0cmluZygpIHsKICAgICAgICByZXR1cm4gdGhpcy5uYW1lOwogICAgICB9CiAgICB9LAogICAgbG9uZzogewogICAgICBuYW1lOiAiSiIsCiAgICAgIHR5cGU6ICJpbnQ2NCIsCiAgICAgIHNpemU6IDIsCiAgICAgIGJ5dGVTaXplOiA4LAogICAgICBkZWZhdWx0VmFsdWU6IDAsCiAgICAgIGlzQ29tcGF0aWJsZSh2KSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiB2ID09PSAibnVtYmVyIiB8fCB2IGluc3RhbmNlb2YgSW50NjQ7CiAgICAgIH0sCiAgICAgIGZyb21Kbmk6IGlkZW50aXR5LAogICAgICB0b0puaTogaWRlbnRpdHksCiAgICAgIHJlYWQoYWRkcmVzcykgewogICAgICAgIHJldHVybiBhZGRyZXNzLnJlYWRTNjQoKTsKICAgICAgfSwKICAgICAgd3JpdGUoYWRkcmVzcywgdmFsdWUpIHsKICAgICAgICBhZGRyZXNzLndyaXRlUzY0KHZhbHVlKTsKICAgICAgfSwKICAgICAgdG9TdHJpbmcoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubmFtZTsKICAgICAgfQogICAgfSwKICAgIGZsb2F0OiB7CiAgICAgIG5hbWU6ICJGIiwKICAgICAgdHlwZTogImZsb2F0IiwKICAgICAgc2l6ZTogMSwKICAgICAgYnl0ZVNpemU6IDQsCiAgICAgIGRlZmF1bHRWYWx1ZTogMCwKICAgICAgaXNDb21wYXRpYmxlKHYpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHYgPT09ICJudW1iZXIiOwogICAgICB9LAogICAgICBmcm9tSm5pOiBpZGVudGl0eSwKICAgICAgdG9Kbmk6IGlkZW50aXR5LAogICAgICByZWFkKGFkZHJlc3MpIHsKICAgICAgICByZXR1cm4gYWRkcmVzcy5yZWFkRmxvYXQoKTsKICAgICAgfSwKICAgICAgd3JpdGUoYWRkcmVzcywgdmFsdWUpIHsKICAgICAgICBhZGRyZXNzLndyaXRlRmxvYXQodmFsdWUpOwogICAgICB9LAogICAgICB0b1N0cmluZygpIHsKICAgICAgICByZXR1cm4gdGhpcy5uYW1lOwogICAgICB9CiAgICB9LAogICAgZG91YmxlOiB7CiAgICAgIG5hbWU6ICJEIiwKICAgICAgdHlwZTogImRvdWJsZSIsCiAgICAgIHNpemU6IDIsCiAgICAgIGJ5dGVTaXplOiA4LAogICAgICBkZWZhdWx0VmFsdWU6IDAsCiAgICAgIGlzQ29tcGF0aWJsZSh2KSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiB2ID09PSAibnVtYmVyIjsKICAgICAgfSwKICAgICAgZnJvbUpuaTogaWRlbnRpdHksCiAgICAgIHRvSm5pOiBpZGVudGl0eSwKICAgICAgcmVhZChhZGRyZXNzKSB7CiAgICAgICAgcmV0dXJuIGFkZHJlc3MucmVhZERvdWJsZSgpOwogICAgICB9LAogICAgICB3cml0ZShhZGRyZXNzLCB2YWx1ZSkgewogICAgICAgIGFkZHJlc3Mud3JpdGVEb3VibGUodmFsdWUpOwogICAgICB9LAogICAgICB0b1N0cmluZygpIHsKICAgICAgICByZXR1cm4gdGhpcy5uYW1lOwogICAgICB9CiAgICB9LAogICAgdm9pZDogewogICAgICBuYW1lOiAiViIsCiAgICAgIHR5cGU6ICJ2b2lkIiwKICAgICAgc2l6ZTogMCwKICAgICAgYnl0ZVNpemU6IDAsCiAgICAgIGRlZmF1bHRWYWx1ZTogdm9pZCAwLAogICAgICBpc0NvbXBhdGlibGUodikgewogICAgICAgIHJldHVybiB2ID09PSB2b2lkIDA7CiAgICAgIH0sCiAgICAgIGZyb21KbmkoKSB7CiAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgfSwKICAgICAgdG9KbmkoKSB7CiAgICAgICAgcmV0dXJuIE5VTEw7CiAgICAgIH0sCiAgICAgIHRvU3RyaW5nKCkgewogICAgICAgIHJldHVybiB0aGlzLm5hbWU7CiAgICAgIH0KICAgIH0KICB9OwogIHZhciBwcmltaXRpdmVUeXBlc05hbWVzID0gbmV3IFNldChPYmplY3QudmFsdWVzKHByaW1pdGl2ZVR5cGVzKS5tYXAoKHQpID0+IHQubmFtZSkpOwogIGZ1bmN0aW9uIGdldFByaW1pdGl2ZVR5cGUobmFtZSkgewogICAgY29uc3QgcmVzdWx0ID0gcHJpbWl0aXZlVHlwZXNbbmFtZV07CiAgICByZXR1cm4gcmVzdWx0ICE9PSB2b2lkIDAgPyByZXN1bHQgOiBudWxsOwogIH0KICBmdW5jdGlvbiBnZXRPYmplY3RUeXBlKHR5cGVOYW1lLCB1bmJveCwgZmFjdG9yeSkgewogICAgY29uc3QgY2FjaGUgPSBmYWN0b3J5Ll90eXBlc1t1bmJveCA/IDEgOiAwXTsKICAgIGxldCB0eXBlID0gY2FjaGVbdHlwZU5hbWVdOwogICAgaWYgKHR5cGUgIT09IHZvaWQgMCkgewogICAgICByZXR1cm4gdHlwZTsKICAgIH0KICAgIGlmICh0eXBlTmFtZSA9PT0gImphdmEubGFuZy5PYmplY3QiKSB7CiAgICAgIHR5cGUgPSBnZXRKYXZhTGFuZ09iamVjdFR5cGUoZmFjdG9yeSk7CiAgICB9IGVsc2UgewogICAgICB0eXBlID0gZ2V0QW55T2JqZWN0VHlwZSh0eXBlTmFtZSwgdW5ib3gsIGZhY3RvcnkpOwogICAgfQogICAgY2FjaGVbdHlwZU5hbWVdID0gdHlwZTsKICAgIHJldHVybiB0eXBlOwogIH0KICBmdW5jdGlvbiBnZXRKYXZhTGFuZ09iamVjdFR5cGUoZmFjdG9yeSkgewogICAgcmV0dXJuIHsKICAgICAgbmFtZTogIkxqYXZhL2xhbmcvT2JqZWN0OyIsCiAgICAgIHR5cGU6ICJwb2ludGVyIiwKICAgICAgc2l6ZTogMSwKICAgICAgZGVmYXVsdFZhbHVlOiBOVUxMLAogICAgICBpc0NvbXBhdGlibGUodikgewogICAgICAgIGlmICh2ID09PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKHYgPT09IHZvaWQgMCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBjb25zdCBpc1dyYXBwZXIgPSB2LiRoIGluc3RhbmNlb2YgTmF0aXZlUG9pbnRlcjsKICAgICAgICBpZiAoaXNXcmFwcGVyKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHR5cGVvZiB2ID09PSAic3RyaW5nIjsKICAgICAgfSwKICAgICAgZnJvbUpuaShoLCBlbnYsIG93bmVkKSB7CiAgICAgICAgaWYgKGguaXNOdWxsKCkpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFjdG9yeS5jYXN0KGgsIGZhY3RvcnkudXNlKCJqYXZhLmxhbmcuT2JqZWN0IiksIG93bmVkKTsKICAgICAgfSwKICAgICAgdG9KbmkobywgZW52KSB7CiAgICAgICAgaWYgKG8gPT09IG51bGwpIHsKICAgICAgICAgIHJldHVybiBOVUxMOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIG8gPT09ICJzdHJpbmciKSB7CiAgICAgICAgICByZXR1cm4gZW52Lm5ld1N0cmluZ1V0ZihvKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG8uJGg7CiAgICAgIH0KICAgIH07CiAgfQogIGZ1bmN0aW9uIGdldEFueU9iamVjdFR5cGUodHlwZU5hbWUsIHVuYm94LCBmYWN0b3J5KSB7CiAgICBsZXQgY2FjaGVkQ2xhc3MgPSBudWxsOwogICAgbGV0IGNhY2hlZElzSW5zdGFuY2UgPSBudWxsOwogICAgbGV0IGNhY2hlZElzRGVmYXVsdFN0cmluZyA9IG51bGw7CiAgICBmdW5jdGlvbiBnZXRDbGFzcygpIHsKICAgICAgaWYgKGNhY2hlZENsYXNzID09PSBudWxsKSB7CiAgICAgICAgY2FjaGVkQ2xhc3MgPSBmYWN0b3J5LnVzZSh0eXBlTmFtZSkuY2xhc3M7CiAgICAgIH0KICAgICAgcmV0dXJuIGNhY2hlZENsYXNzOwogICAgfQogICAgZnVuY3Rpb24gaXNJbnN0YW5jZSh2KSB7CiAgICAgIGNvbnN0IGtsYXNzID0gZ2V0Q2xhc3MoKTsKICAgICAgaWYgKGNhY2hlZElzSW5zdGFuY2UgPT09IG51bGwpIHsKICAgICAgICBjYWNoZWRJc0luc3RhbmNlID0ga2xhc3MuaXNJbnN0YW5jZS5vdmVybG9hZCgiamF2YS5sYW5nLk9iamVjdCIpOwogICAgICB9CiAgICAgIHJldHVybiBjYWNoZWRJc0luc3RhbmNlLmNhbGwoa2xhc3MsIHYpOwogICAgfQogICAgZnVuY3Rpb24gdHlwZUlzRGVmYXVsdFN0cmluZygpIHsKICAgICAgaWYgKGNhY2hlZElzRGVmYXVsdFN0cmluZyA9PT0gbnVsbCkgewogICAgICAgIGNvbnN0IHggPSBnZXRDbGFzcygpOwogICAgICAgIGNhY2hlZElzRGVmYXVsdFN0cmluZyA9IGZhY3RvcnkudXNlKCJqYXZhLmxhbmcuU3RyaW5nIikuY2xhc3MuaXNBc3NpZ25hYmxlRnJvbSh4KTsKICAgICAgfQogICAgICByZXR1cm4gY2FjaGVkSXNEZWZhdWx0U3RyaW5nOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgbmFtZTogbWFrZUpuaU9iamVjdFR5cGVOYW1lKHR5cGVOYW1lKSwKICAgICAgdHlwZTogInBvaW50ZXIiLAogICAgICBzaXplOiAxLAogICAgICBkZWZhdWx0VmFsdWU6IE5VTEwsCiAgICAgIGlzQ29tcGF0aWJsZSh2KSB7CiAgICAgICAgaWYgKHYgPT09IG51bGwpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBpZiAodiA9PT0gdm9pZCAwKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGlzV3JhcHBlciA9IHYuJGggaW5zdGFuY2VvZiBOYXRpdmVQb2ludGVyOwogICAgICAgIGlmIChpc1dyYXBwZXIpIHsKICAgICAgICAgIHJldHVybiBpc0luc3RhbmNlKHYpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHlwZW9mIHYgPT09ICJzdHJpbmciICYmIHR5cGVJc0RlZmF1bHRTdHJpbmcoKTsKICAgICAgfSwKICAgICAgZnJvbUpuaShoLCBlbnYsIG93bmVkKSB7CiAgICAgICAgaWYgKGguaXNOdWxsKCkpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZUlzRGVmYXVsdFN0cmluZygpICYmIHVuYm94KSB7CiAgICAgICAgICByZXR1cm4gZW52LnN0cmluZ0Zyb21KbmkoaCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWN0b3J5LmNhc3QoaCwgZmFjdG9yeS51c2UodHlwZU5hbWUpLCBvd25lZCk7CiAgICAgIH0sCiAgICAgIHRvSm5pKG8sIGVudikgewogICAgICAgIGlmIChvID09PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gTlVMTDsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBvID09PSAic3RyaW5nIikgewogICAgICAgICAgcmV0dXJuIGVudi5uZXdTdHJpbmdVdGYobyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvLiRoOwogICAgICB9LAogICAgICB0b1N0cmluZygpIHsKICAgICAgICByZXR1cm4gdGhpcy5uYW1lOwogICAgICB9CiAgICB9OwogIH0KICB2YXIgcHJpbWl0aXZlQXJyYXlUeXBlcyA9IFsKICAgIFsiWiIsICJib29sZWFuIl0sCiAgICBbIkIiLCAiYnl0ZSJdLAogICAgWyJDIiwgImNoYXIiXSwKICAgIFsiRCIsICJkb3VibGUiXSwKICAgIFsiRiIsICJmbG9hdCJdLAogICAgWyJJIiwgImludCJdLAogICAgWyJKIiwgImxvbmciXSwKICAgIFsiUyIsICJzaG9ydCJdCiAgXS5yZWR1Y2UoKHJlc3VsdCwgW3Nob3J0eSwgbmFtZV0pID0+IHsKICAgIHJlc3VsdFsiWyIgKyBzaG9ydHldID0gbWFrZVByaW1pdGl2ZUFycmF5VHlwZSgiWyIgKyBzaG9ydHksIG5hbWUpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9LCB7fSk7CiAgZnVuY3Rpb24gbWFrZVByaW1pdGl2ZUFycmF5VHlwZShzaG9ydHksIG5hbWUpIHsKICAgIGNvbnN0IGVudlByb3RvID0gRW52LnByb3RvdHlwZTsKICAgIGNvbnN0IG5hbWVUaXRsZWQgPSB0b1RpdGxlQ2FzZShuYW1lKTsKICAgIGNvbnN0IHNwZWMgPSB7CiAgICAgIHR5cGVOYW1lOiBuYW1lLAogICAgICBuZXdBcnJheTogZW52UHJvdG9bIm5ldyIgKyBuYW1lVGl0bGVkICsgIkFycmF5Il0sCiAgICAgIHNldFJlZ2lvbjogZW52UHJvdG9bInNldCIgKyBuYW1lVGl0bGVkICsgIkFycmF5UmVnaW9uIl0sCiAgICAgIGdldEVsZW1lbnRzOiBlbnZQcm90b1siZ2V0IiArIG5hbWVUaXRsZWQgKyAiQXJyYXlFbGVtZW50cyJdLAogICAgICByZWxlYXNlRWxlbWVudHM6IGVudlByb3RvWyJyZWxlYXNlIiArIG5hbWVUaXRsZWQgKyAiQXJyYXlFbGVtZW50cyJdCiAgICB9OwogICAgcmV0dXJuIHsKICAgICAgbmFtZTogc2hvcnR5LAogICAgICB0eXBlOiAicG9pbnRlciIsCiAgICAgIHNpemU6IDEsCiAgICAgIGRlZmF1bHRWYWx1ZTogTlVMTCwKICAgICAgaXNDb21wYXRpYmxlKHYpIHsKICAgICAgICByZXR1cm4gaXNDb21wYXRpYmxlUHJpbWl0aXZlQXJyYXkodiwgbmFtZSk7CiAgICAgIH0sCiAgICAgIGZyb21KbmkoaCwgZW52LCBvd25lZCkgewogICAgICAgIHJldHVybiBmcm9tSm5pUHJpbWl0aXZlQXJyYXkoaCwgc3BlYywgZW52LCBvd25lZCk7CiAgICAgIH0sCiAgICAgIHRvSm5pKGFyciwgZW52KSB7CiAgICAgICAgcmV0dXJuIHRvSm5pUHJpbWl0aXZlQXJyYXkoYXJyLCBzcGVjLCBlbnYpOwogICAgICB9CiAgICB9OwogIH0KICBmdW5jdGlvbiBnZXRBcnJheVR5cGUodHlwZU5hbWUsIHVuYm94LCBmYWN0b3J5KSB7CiAgICBjb25zdCBwcmltaXRpdmVUeXBlID0gcHJpbWl0aXZlQXJyYXlUeXBlc1t0eXBlTmFtZV07CiAgICBpZiAocHJpbWl0aXZlVHlwZSAhPT0gdm9pZCAwKSB7CiAgICAgIHJldHVybiBwcmltaXRpdmVUeXBlOwogICAgfQogICAgaWYgKHR5cGVOYW1lLmluZGV4T2YoIlsiKSAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuc3VwcG9ydGVkIHR5cGU6ICIgKyB0eXBlTmFtZSk7CiAgICB9CiAgICBsZXQgZWxlbWVudFR5cGVOYW1lID0gdHlwZU5hbWUuc3Vic3RyaW5nKDEpOwogICAgY29uc3QgZWxlbWVudFR5cGUgPSBnZXRUeXBlKGVsZW1lbnRUeXBlTmFtZSwgdW5ib3gsIGZhY3RvcnkpOwogICAgbGV0IG51bUludGVybmFsQXJyYXlzID0gMDsKICAgIGNvbnN0IGVuZCA9IGVsZW1lbnRUeXBlTmFtZS5sZW5ndGg7CiAgICB3aGlsZSAobnVtSW50ZXJuYWxBcnJheXMgIT09IGVuZCAmJiBlbGVtZW50VHlwZU5hbWVbbnVtSW50ZXJuYWxBcnJheXNdID09PSAiWyIpIHsKICAgICAgbnVtSW50ZXJuYWxBcnJheXMrKzsKICAgIH0KICAgIGVsZW1lbnRUeXBlTmFtZSA9IGVsZW1lbnRUeXBlTmFtZS5zdWJzdHJpbmcobnVtSW50ZXJuYWxBcnJheXMpOwogICAgaWYgKGVsZW1lbnRUeXBlTmFtZVswXSA9PT0gIkwiICYmIGVsZW1lbnRUeXBlTmFtZVtlbGVtZW50VHlwZU5hbWUubGVuZ3RoIC0gMV0gPT09ICI7IikgewogICAgICBlbGVtZW50VHlwZU5hbWUgPSBlbGVtZW50VHlwZU5hbWUuc3Vic3RyaW5nKDEsIGVsZW1lbnRUeXBlTmFtZS5sZW5ndGggLSAxKTsKICAgIH0KICAgIGxldCBpbnRlcm5hbEVsZW1lbnRUeXBlTmFtZSA9IGVsZW1lbnRUeXBlTmFtZS5yZXBsYWNlKC9cLi9nLCAiLyIpOwogICAgaWYgKHByaW1pdGl2ZVR5cGVzTmFtZXMuaGFzKGludGVybmFsRWxlbWVudFR5cGVOYW1lKSkgewogICAgICBpbnRlcm5hbEVsZW1lbnRUeXBlTmFtZSA9ICJbIi5yZXBlYXQobnVtSW50ZXJuYWxBcnJheXMpICsgaW50ZXJuYWxFbGVtZW50VHlwZU5hbWU7CiAgICB9IGVsc2UgewogICAgICBpbnRlcm5hbEVsZW1lbnRUeXBlTmFtZSA9ICJbIi5yZXBlYXQobnVtSW50ZXJuYWxBcnJheXMpICsgIkwiICsgaW50ZXJuYWxFbGVtZW50VHlwZU5hbWUgKyAiOyI7CiAgICB9CiAgICBjb25zdCBpbnRlcm5hbFR5cGVOYW1lID0gIlsiICsgaW50ZXJuYWxFbGVtZW50VHlwZU5hbWU7CiAgICBlbGVtZW50VHlwZU5hbWUgPSAiWyIucmVwZWF0KG51bUludGVybmFsQXJyYXlzKSArIGVsZW1lbnRUeXBlTmFtZTsKICAgIHJldHVybiB7CiAgICAgIG5hbWU6IHR5cGVOYW1lLnJlcGxhY2UoL1wuL2csICIvIiksCiAgICAgIHR5cGU6ICJwb2ludGVyIiwKICAgICAgc2l6ZTogMSwKICAgICAgZGVmYXVsdFZhbHVlOiBOVUxMLAogICAgICBpc0NvbXBhdGlibGUodikgewogICAgICAgIGlmICh2ID09PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiB2ICE9PSAib2JqZWN0IiB8fCB2Lmxlbmd0aCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2LmV2ZXJ5KGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgIHJldHVybiBlbGVtZW50VHlwZS5pc0NvbXBhdGlibGUoZWxlbWVudCk7CiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIGZyb21KbmkoYXJyLCBlbnYsIG93bmVkKSB7CiAgICAgICAgaWYgKGFyci5pc051bGwoKSkgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJlc3VsdCA9IFtdOwogICAgICAgIGNvbnN0IG4gPSBlbnYuZ2V0QXJyYXlMZW5ndGgoYXJyKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gbjsgaSsrKSB7CiAgICAgICAgICBjb25zdCBlbGVtZW50ID0gZW52LmdldE9iamVjdEFycmF5RWxlbWVudChhcnIsIGkpOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmVzdWx0LnB1c2goZWxlbWVudFR5cGUuZnJvbUpuaShlbGVtZW50LCBlbnYpKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGVudi5kZWxldGVMb2NhbFJlZihlbGVtZW50KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJlc3VsdC4kdyA9IGZhY3RvcnkuY2FzdChhcnIsIGZhY3RvcnkudXNlKGludGVybmFsVHlwZU5hbWUpLCBvd25lZCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgZmFjdG9yeS51c2UoImphdmEubGFuZy5yZWZsZWN0LkFycmF5IikubmV3SW5zdGFuY2UoZmFjdG9yeS51c2UoZWxlbWVudFR5cGVOYW1lKS5jbGFzcywgMCk7CiAgICAgICAgICByZXN1bHQuJHcgPSBmYWN0b3J5LmNhc3QoYXJyLCBmYWN0b3J5LnVzZShpbnRlcm5hbFR5cGVOYW1lKSwgb3duZWQpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuJGRpc3Bvc2UgPSBkaXNwb3NlT2JqZWN0QXJyYXk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfSwKICAgICAgdG9KbmkoZWxlbWVudHMsIGVudikgewogICAgICAgIGlmIChlbGVtZW50cyA9PT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIE5VTEw7CiAgICAgICAgfQogICAgICAgIGlmICghKGVsZW1lbnRzIGluc3RhbmNlb2YgQXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIGFuIGFycmF5Iik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHdyYXBwZXIgPSBlbGVtZW50cy4kdzsKICAgICAgICBpZiAod3JhcHBlciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICByZXR1cm4gd3JhcHBlci4kaDsKICAgICAgICB9CiAgICAgICAgY29uc3QgbiA9IGVsZW1lbnRzLmxlbmd0aDsKICAgICAgICBjb25zdCBrbGFzc09iaiA9IGZhY3RvcnkudXNlKGVsZW1lbnRUeXBlTmFtZSk7CiAgICAgICAgY29uc3QgY2xhc3NIYW5kbGUgPSBrbGFzc09iai4kYm9ycm93Q2xhc3NIYW5kbGUoZW52KTsKICAgICAgICB0cnkgewogICAgICAgICAgY29uc3QgcmVzdWx0ID0gZW52Lm5ld09iamVjdEFycmF5KG4sIGNsYXNzSGFuZGxlLnZhbHVlLCBOVUxMKTsKICAgICAgICAgIGVudi50aHJvd0lmRXhjZXB0aW9uUGVuZGluZygpOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IG47IGkrKykgewogICAgICAgICAgICBjb25zdCBoYW5kbGUgPSBlbGVtZW50VHlwZS50b0puaShlbGVtZW50c1tpXSwgZW52KTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBlbnYuc2V0T2JqZWN0QXJyYXlFbGVtZW50KHJlc3VsdCwgaSwgaGFuZGxlKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBpZiAoZWxlbWVudFR5cGUudHlwZSA9PT0gInBvaW50ZXIiICYmIGVudi5nZXRPYmplY3RSZWZUeXBlKGhhbmRsZSkgPT09IEpOSUxvY2FsUmVmVHlwZSkgewogICAgICAgICAgICAgICAgZW52LmRlbGV0ZUxvY2FsUmVmKGhhbmRsZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVudi50aHJvd0lmRXhjZXB0aW9uUGVuZGluZygpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgY2xhc3NIYW5kbGUudW5yZWYoZW52KTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfQogIGZ1bmN0aW9uIGRpc3Bvc2VPYmplY3RBcnJheSgpIHsKICAgIGNvbnN0IG4gPSB0aGlzLmxlbmd0aDsKICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBuOyBpKyspIHsKICAgICAgY29uc3Qgb2JqID0gdGhpc1tpXTsKICAgICAgaWYgKG9iaiA9PT0gbnVsbCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbnN0IGRpc3Bvc2UgPSBvYmouJGRpc3Bvc2U7CiAgICAgIGlmIChkaXNwb3NlID09PSB2b2lkIDApIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBkaXNwb3NlLmNhbGwob2JqKTsKICAgIH0KICAgIHRoaXMuJHcuJGRpc3Bvc2UoKTsKICB9CiAgZnVuY3Rpb24gZnJvbUpuaVByaW1pdGl2ZUFycmF5KGFyciwgc3BlYywgZW52LCBvd25lZCkgewogICAgaWYgKGFyci5pc051bGwoKSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IHR5cGUgPSBnZXRQcmltaXRpdmVUeXBlKHNwZWMudHlwZU5hbWUpOwogICAgY29uc3QgbGVuZ3RoID0gZW52LmdldEFycmF5TGVuZ3RoKGFycik7CiAgICByZXR1cm4gbmV3IFByaW1pdGl2ZUFycmF5KGFyciwgc3BlYywgdHlwZSwgbGVuZ3RoLCBlbnYsIG93bmVkKTsKICB9CiAgZnVuY3Rpb24gdG9KbmlQcmltaXRpdmVBcnJheShhcnIsIHNwZWMsIGVudikgewogICAgaWYgKGFyciA9PT0gbnVsbCkgewogICAgICByZXR1cm4gTlVMTDsKICAgIH0KICAgIGNvbnN0IGhhbmRsZSA9IGFyci4kaDsKICAgIGlmIChoYW5kbGUgIT09IHZvaWQgMCkgewogICAgICByZXR1cm4gaGFuZGxlOwogICAgfQogICAgY29uc3QgbGVuZ3RoID0gYXJyLmxlbmd0aDsKICAgIGNvbnN0IHR5cGUgPSBnZXRQcmltaXRpdmVUeXBlKHNwZWMudHlwZU5hbWUpOwogICAgY29uc3QgcmVzdWx0ID0gc3BlYy5uZXdBcnJheS5jYWxsKGVudiwgbGVuZ3RoKTsKICAgIGlmIChyZXN1bHQuaXNOdWxsKCkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gY29uc3RydWN0IGFycmF5Iik7CiAgICB9CiAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICBjb25zdCBlbGVtZW50U2l6ZSA9IHR5cGUuYnl0ZVNpemU7CiAgICAgIGNvbnN0IHdyaXRlRWxlbWVudCA9IHR5cGUud3JpdGU7CiAgICAgIGNvbnN0IHVucGFyc2VFbGVtZW50VmFsdWUgPSB0eXBlLnRvSm5pOwogICAgICBjb25zdCBlbGVtZW50cyA9IE1lbW9yeS5hbGxvYyhsZW5ndGggKiB0eXBlLmJ5dGVTaXplKTsKICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCAhPT0gbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgd3JpdGVFbGVtZW50KGVsZW1lbnRzLmFkZChpbmRleCAqIGVsZW1lbnRTaXplKSwgdW5wYXJzZUVsZW1lbnRWYWx1ZShhcnJbaW5kZXhdKSk7CiAgICAgIH0KICAgICAgc3BlYy5zZXRSZWdpb24uY2FsbChlbnYsIHJlc3VsdCwgMCwgbGVuZ3RoLCBlbGVtZW50cyk7CiAgICAgIGVudi50aHJvd0lmRXhjZXB0aW9uUGVuZGluZygpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gaXNDb21wYXRpYmxlUHJpbWl0aXZlQXJyYXkodmFsdWUsIHR5cGVOYW1lKSB7CiAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBQcmltaXRpdmVBcnJheSkgewogICAgICByZXR1cm4gdmFsdWUuJHMudHlwZU5hbWUgPT09IHR5cGVOYW1lOwogICAgfQogICAgY29uc3QgaXNBcnJheUxpa2UgPSB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHZhbHVlLmxlbmd0aCAhPT0gdm9pZCAwOwogICAgaWYgKCFpc0FycmF5TGlrZSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBjb25zdCBlbGVtZW50VHlwZSA9IGdldFByaW1pdGl2ZVR5cGUodHlwZU5hbWUpOwogICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5ldmVyeS5jYWxsKHZhbHVlLCAoZWxlbWVudCkgPT4gZWxlbWVudFR5cGUuaXNDb21wYXRpYmxlKGVsZW1lbnQpKTsKICB9CiAgZnVuY3Rpb24gUHJpbWl0aXZlQXJyYXkoaGFuZGxlLCBzcGVjLCB0eXBlLCBsZW5ndGgsIGVudiwgb3duZWQgPSB0cnVlKSB7CiAgICBpZiAob3duZWQpIHsKICAgICAgY29uc3QgaCA9IGVudi5uZXdHbG9iYWxSZWYoaGFuZGxlKTsKICAgICAgdGhpcy4kaCA9IGg7CiAgICAgIHRoaXMuJHIgPSBTY3JpcHQuYmluZFdlYWsodGhpcywgZW52LnZtLm1ha2VIYW5kbGVEZXN0cnVjdG9yKGgpKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuJGggPSBoYW5kbGU7CiAgICAgIHRoaXMuJHIgPSBudWxsOwogICAgfQogICAgdGhpcy4kcyA9IHNwZWM7CiAgICB0aGlzLiR0ID0gdHlwZTsKICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoOwogICAgcmV0dXJuIG5ldyBQcm94eSh0aGlzLCBwcmltaXRpdmVBcnJheUhhbmRsZXIpOwogIH0KICBwcmltaXRpdmVBcnJheUhhbmRsZXIgPSB7CiAgICBoYXModGFyZ2V0LCBwcm9wZXJ0eSkgewogICAgICBpZiAocHJvcGVydHkgaW4gdGFyZ2V0KSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIHRhcmdldC50cnlQYXJzZUluZGV4KHByb3BlcnR5KSAhPT0gbnVsbDsKICAgIH0sCiAgICBnZXQodGFyZ2V0LCBwcm9wZXJ0eSwgcmVjZWl2ZXIpIHsKICAgICAgY29uc3QgaW5kZXggPSB0YXJnZXQudHJ5UGFyc2VJbmRleChwcm9wZXJ0eSk7CiAgICAgIGlmIChpbmRleCA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiB0YXJnZXRbcHJvcGVydHldOwogICAgICB9CiAgICAgIHJldHVybiB0YXJnZXQucmVhZEVsZW1lbnQoaW5kZXgpOwogICAgfSwKICAgIHNldCh0YXJnZXQsIHByb3BlcnR5LCB2YWx1ZSwgcmVjZWl2ZXIpIHsKICAgICAgY29uc3QgaW5kZXggPSB0YXJnZXQudHJ5UGFyc2VJbmRleChwcm9wZXJ0eSk7CiAgICAgIGlmIChpbmRleCA9PT0gbnVsbCkgewogICAgICAgIHRhcmdldFtwcm9wZXJ0eV0gPSB2YWx1ZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICB0YXJnZXQud3JpdGVFbGVtZW50KGluZGV4LCB2YWx1ZSk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAgIG93bktleXModGFyZ2V0KSB7CiAgICAgIGNvbnN0IGtleXMgPSBbXTsKICAgICAgY29uc3QgeyBsZW5ndGggfSA9IHRhcmdldDsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3Qga2V5ID0gaS50b1N0cmluZygpOwogICAgICAgIGtleXMucHVzaChrZXkpOwogICAgICB9CiAgICAgIGtleXMucHVzaCgibGVuZ3RoIik7CiAgICAgIHJldHVybiBrZXlzOwogICAgfSwKICAgIGdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIHByb3BlcnR5KSB7CiAgICAgIGNvbnN0IGluZGV4ID0gdGFyZ2V0LnRyeVBhcnNlSW5kZXgocHJvcGVydHkpOwogICAgICBpZiAoaW5kZXggIT09IG51bGwpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgfTsKICAgICAgfQogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIHByb3BlcnR5KTsKICAgIH0KICB9OwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFByaW1pdGl2ZUFycmF5LnByb3RvdHlwZSwgewogICAgJGRpc3Bvc2U6IHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgdmFsdWUoKSB7CiAgICAgICAgY29uc3QgcmVmID0gdGhpcy4kcjsKICAgICAgICBpZiAocmVmICE9PSBudWxsKSB7CiAgICAgICAgICB0aGlzLiRyID0gbnVsbDsKICAgICAgICAgIFNjcmlwdC51bmJpbmRXZWFrKHJlZik7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgJGNsb25lOiB7CiAgICAgIHZhbHVlKGVudikgewogICAgICAgIHJldHVybiBuZXcgUHJpbWl0aXZlQXJyYXkodGhpcy4kaCwgdGhpcy4kcywgdGhpcy4kdCwgdGhpcy5sZW5ndGgsIGVudik7CiAgICAgIH0KICAgIH0sCiAgICB0cnlQYXJzZUluZGV4OiB7CiAgICAgIHZhbHVlKHJhd0luZGV4KSB7CiAgICAgICAgaWYgKHR5cGVvZiByYXdJbmRleCA9PT0gInN5bWJvbCIpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbmRleCA9IHBhcnNlSW50KHJhd0luZGV4KTsKICAgICAgICBpZiAoaXNOYU4oaW5kZXgpIHx8IGluZGV4IDwgMCB8fCBpbmRleCA+PSB0aGlzLmxlbmd0aCkgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpbmRleDsKICAgICAgfQogICAgfSwKICAgIHJlYWRFbGVtZW50OiB7CiAgICAgIHZhbHVlKGluZGV4KSB7CiAgICAgICAgcmV0dXJuIHRoaXMud2l0aEVsZW1lbnRzKChlbGVtZW50cykgPT4gewogICAgICAgICAgY29uc3QgdHlwZSA9IHRoaXMuJHQ7CiAgICAgICAgICByZXR1cm4gdHlwZS5mcm9tSm5pKHR5cGUucmVhZChlbGVtZW50cy5hZGQoaW5kZXggKiB0eXBlLmJ5dGVTaXplKSkpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LAogICAgd3JpdGVFbGVtZW50OiB7CiAgICAgIHZhbHVlKGluZGV4LCB2YWx1ZSkgewogICAgICAgIGNvbnN0IHsgJGg6IGhhbmRsZSwgJHM6IHNwZWMsICR0OiB0eXBlIH0gPSB0aGlzOwogICAgICAgIGNvbnN0IGVudiA9IHZtLmdldEVudigpOwogICAgICAgIGNvbnN0IGVsZW1lbnQgPSBNZW1vcnkuYWxsb2ModHlwZS5ieXRlU2l6ZSk7CiAgICAgICAgdHlwZS53cml0ZShlbGVtZW50LCB0eXBlLnRvSm5pKHZhbHVlKSk7CiAgICAgICAgc3BlYy5zZXRSZWdpb24uY2FsbChlbnYsIGhhbmRsZSwgaW5kZXgsIDEsIGVsZW1lbnQpOwogICAgICB9CiAgICB9LAogICAgd2l0aEVsZW1lbnRzOiB7CiAgICAgIHZhbHVlKHBlcmZvcm0pIHsKICAgICAgICBjb25zdCB7ICRoOiBoYW5kbGUsICRzOiBzcGVjIH0gPSB0aGlzOwogICAgICAgIGNvbnN0IGVudiA9IHZtLmdldEVudigpOwogICAgICAgIGNvbnN0IGVsZW1lbnRzID0gc3BlYy5nZXRFbGVtZW50cy5jYWxsKGVudiwgaGFuZGxlKTsKICAgICAgICBpZiAoZWxlbWVudHMuaXNOdWxsKCkpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGdldCBhcnJheSBlbGVtZW50cyIpOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgcmV0dXJuIHBlcmZvcm0oZWxlbWVudHMpOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBzcGVjLnJlbGVhc2VFbGVtZW50cy5jYWxsKGVudiwgaGFuZGxlLCBlbGVtZW50cyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgdG9KU09OOiB7CiAgICAgIHZhbHVlKCkgewogICAgICAgIGNvbnN0IHsgbGVuZ3RoLCAkdDogdHlwZSB9ID0gdGhpczsKICAgICAgICBjb25zdCB7IGJ5dGVTaXplOiBlbGVtZW50U2l6ZSwgZnJvbUpuaSwgcmVhZDogcmVhZDIgfSA9IHR5cGU7CiAgICAgICAgcmV0dXJuIHRoaXMud2l0aEVsZW1lbnRzKChlbGVtZW50cykgPT4gewogICAgICAgICAgY29uc3QgdmFsdWVzID0gW107CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBmcm9tSm5pKHJlYWQyKGVsZW1lbnRzLmFkZChpICogZWxlbWVudFNpemUpKSk7CiAgICAgICAgICAgIHZhbHVlcy5wdXNoKHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZXM7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgICB0b1N0cmluZzogewogICAgICB2YWx1ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy50b0pTT04oKS50b1N0cmluZygpOwogICAgICB9CiAgICB9CiAgfSk7CiAgZnVuY3Rpb24gbWFrZUpuaU9iamVjdFR5cGVOYW1lKHR5cGVOYW1lKSB7CiAgICByZXR1cm4gIkwiICsgdHlwZU5hbWUucmVwbGFjZSgvXC4vZywgIi8iKSArICI7IjsKICB9CiAgZnVuY3Rpb24gdG9UaXRsZUNhc2Uoc3RyKSB7CiAgICByZXR1cm4gc3RyLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgc3RyLnNsaWNlKDEpOwogIH0KICBmdW5jdGlvbiBpZGVudGl0eSh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlOwogIH0KCiAgLy8gbm9kZV9tb2R1bGVzL2ZyaWRhLWphdmEtYnJpZGdlL2xpYi9jbGFzcy1mYWN0b3J5LmpzCiAgdmFyIGpzaXplU2l6ZTMgPSA0OwogIHZhciB7CiAgICBlbnN1cmVDbGFzc0luaXRpYWxpemVkOiBlbnN1cmVDbGFzc0luaXRpYWxpemVkMywKICAgIG1ha2VNZXRob2RNYW5nbGVyOiBtYWtlTWV0aG9kTWFuZ2xlcjMKICB9ID0gYW5kcm9pZF9leHBvcnRzOwogIHZhciBrQWNjU3RhdGljMiA9IDg7CiAgdmFyIENPTlNUUlVDVE9SX01FVEhPRCA9IDE7CiAgdmFyIFNUQVRJQ19NRVRIT0QgPSAyOwogIHZhciBJTlNUQU5DRV9NRVRIT0QgPSAzOwogIHZhciBTVEFUSUNfRklFTEQgPSAxOwogIHZhciBJTlNUQU5DRV9GSUVMRCA9IDI7CiAgdmFyIFNUUkFURUdZX1ZJUlRVQUwgPSAxOwogIHZhciBTVFJBVEVHWV9ESVJFQ1QgPSAyOwogIHZhciBQRU5ESU5HX1VTRSA9IFN5bWJvbCgiUEVORElOR19VU0UiKTsKICB2YXIgREVGQVVMVF9DQUNIRV9ESVIgPSAiL2RhdGEvbG9jYWwvdG1wIjsKICB2YXIgewogICAgZ2V0Q3VycmVudFRocmVhZElkLAogICAgcG9pbnRlclNpemU6IHBvaW50ZXJTaXplNwogIH0gPSBQcm9jZXNzOwogIHZhciBmYWN0b3J5Q2FjaGUgPSB7CiAgICBzdGF0ZTogImVtcHR5IiwKICAgIGZhY3RvcmllczogW10sCiAgICBsb2FkZXJzOiBudWxsLAogICAgSW50ZWdlcjogbnVsbAogIH07CiAgdmFyIHZtMiA9IG51bGw7CiAgdmFyIGFwaSA9IG51bGw7CiAgdmFyIGlzQXJ0Vm0gPSBudWxsOwogIHZhciB3cmFwcGVySGFuZGxlciA9IG51bGw7CiAgdmFyIGRpc3BhdGNoZXJQcm90b3R5cGUgPSBudWxsOwogIHZhciBtZXRob2RQcm90b3R5cGUgPSBudWxsOwogIHZhciB2YWx1ZU9mUHJvdG90eXBlID0gbnVsbDsKICB2YXIgY2FjaGVkTG9hZGVySW52b2tlID0gbnVsbDsKICB2YXIgY2FjaGVkTG9hZGVyTWV0aG9kID0gbnVsbDsKICB2YXIgaWdub3JlZFRocmVhZHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIHZhciBDbGFzc0ZhY3RvcnkgPSBjbGFzcyB7CiAgICBzdGF0aWMgX2luaXRpYWxpemUoX3ZtLCBfYXBpKSB7CiAgICAgIHZtMiA9IF92bTsKICAgICAgYXBpID0gX2FwaTsKICAgICAgaXNBcnRWbSA9IF9hcGkuZmxhdm9yID09PSAiYXJ0IjsKICAgICAgaWYgKF9hcGkuZmxhdm9yID09PSAianZtIikgewogICAgICAgIGVuc3VyZUNsYXNzSW5pdGlhbGl6ZWQzID0gZW5zdXJlQ2xhc3NJbml0aWFsaXplZDI7CiAgICAgICAgbWFrZU1ldGhvZE1hbmdsZXIzID0gbWFrZU1ldGhvZE1hbmdsZXIyOwogICAgICB9CiAgICB9CiAgICBzdGF0aWMgX2Rpc3Bvc2VBbGwoZW52KSB7CiAgICAgIGZhY3RvcnlDYWNoZS5mYWN0b3JpZXMuZm9yRWFjaCgoZmFjdG9yeSkgPT4gewogICAgICAgIGZhY3RvcnkuX2Rpc3Bvc2UoZW52KTsKICAgICAgfSk7CiAgICB9CiAgICBzdGF0aWMgZ2V0KGNsYXNzTG9hZGVyKSB7CiAgICAgIGNvbnN0IGNhY2hlID0gZ2V0RmFjdG9yeUNhY2hlKCk7CiAgICAgIGNvbnN0IGRlZmF1bHRGYWN0b3J5ID0gY2FjaGUuZmFjdG9yaWVzWzBdOwogICAgICBpZiAoY2xhc3NMb2FkZXIgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gZGVmYXVsdEZhY3Rvcnk7CiAgICAgIH0KICAgICAgY29uc3QgaW5kZXhPYmogPSBjYWNoZS5sb2FkZXJzLmdldChjbGFzc0xvYWRlcik7CiAgICAgIGlmIChpbmRleE9iaiAhPT0gbnVsbCkgewogICAgICAgIGNvbnN0IGluZGV4ID0gZGVmYXVsdEZhY3RvcnkuY2FzdChpbmRleE9iaiwgY2FjaGUuSW50ZWdlcik7CiAgICAgICAgcmV0dXJuIGNhY2hlLmZhY3Rvcmllc1tpbmRleC5pbnRWYWx1ZSgpXTsKICAgICAgfQogICAgICBjb25zdCBmYWN0b3J5ID0gbmV3IENsYXNzRmFjdG9yeSgpOwogICAgICBmYWN0b3J5LmxvYWRlciA9IGNsYXNzTG9hZGVyOwogICAgICBmYWN0b3J5LmNhY2hlRGlyID0gZGVmYXVsdEZhY3RvcnkuY2FjaGVEaXI7CiAgICAgIGFkZEZhY3RvcnlUb0NhY2hlKGZhY3RvcnksIGNsYXNzTG9hZGVyKTsKICAgICAgcmV0dXJuIGZhY3Rvcnk7CiAgICB9CiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgdGhpcy5jYWNoZURpciA9IERFRkFVTFRfQ0FDSEVfRElSOwogICAgICB0aGlzLmNvZGVDYWNoZURpciA9IERFRkFVTFRfQ0FDSEVfRElSICsgIi9kYWx2aWstY2FjaGUiOwogICAgICB0aGlzLnRlbXBGaWxlTmFtaW5nID0gewogICAgICAgIHByZWZpeDogImZyaWRhIiwKICAgICAgICBzdWZmaXg6ICIiCiAgICAgIH07CiAgICAgIHRoaXMuX2NsYXNzZXMgPSB7fTsKICAgICAgdGhpcy5fY2xhc3NIYW5kbGVzID0gbmV3IExSVSgxMCwgcmVsZWFzZUNsYXNzSGFuZGxlKTsKICAgICAgdGhpcy5fcGF0Y2hlZE1ldGhvZHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICB0aGlzLl9sb2FkZXIgPSBudWxsOwogICAgICB0aGlzLl90eXBlcyA9IFt7fSwge31dOwogICAgICBmYWN0b3J5Q2FjaGUuZmFjdG9yaWVzLnB1c2godGhpcyk7CiAgICB9CiAgICBfZGlzcG9zZShlbnYpIHsKICAgICAgQXJyYXkuZnJvbSh0aGlzLl9wYXRjaGVkTWV0aG9kcykuZm9yRWFjaCgobWV0aG9kKSA9PiB7CiAgICAgICAgbWV0aG9kLmltcGxlbWVudGF0aW9uID0gbnVsbDsKICAgICAgfSk7CiAgICAgIHRoaXMuX3BhdGNoZWRNZXRob2RzLmNsZWFyKCk7CiAgICAgIHJldmVydEdsb2JhbFBhdGNoZXMoKTsKICAgICAgdGhpcy5fY2xhc3NIYW5kbGVzLmRpc3Bvc2UoZW52KTsKICAgICAgdGhpcy5fY2xhc3NlcyA9IHt9OwogICAgfQogICAgZ2V0IGxvYWRlcigpIHsKICAgICAgcmV0dXJuIHRoaXMuX2xvYWRlcjsKICAgIH0KICAgIHNldCBsb2FkZXIodmFsdWUpIHsKICAgICAgY29uc3QgaXNJbml0aWFsID0gdGhpcy5fbG9hZGVyID09PSBudWxsICYmIHZhbHVlICE9PSBudWxsOwogICAgICB0aGlzLl9sb2FkZXIgPSB2YWx1ZTsKICAgICAgaWYgKGlzSW5pdGlhbCAmJiBmYWN0b3J5Q2FjaGUuc3RhdGUgPT09ICJyZWFkeSIgJiYgdGhpcyA9PT0gZmFjdG9yeUNhY2hlLmZhY3Rvcmllc1swXSkgewogICAgICAgIGFkZEZhY3RvcnlUb0NhY2hlKHRoaXMsIHZhbHVlKTsKICAgICAgfQogICAgfQogICAgdXNlKGNsYXNzTmFtZSwgb3B0aW9ucyA9IHt9KSB7CiAgICAgIGNvbnN0IGFsbG93Q2FjaGVkID0gb3B0aW9ucy5jYWNoZSAhPT0gInNraXAiOwogICAgICBsZXQgQyA9IGFsbG93Q2FjaGVkID8gdGhpcy5fZ2V0VXNlZENsYXNzKGNsYXNzTmFtZSkgOiB2b2lkIDA7CiAgICAgIGlmIChDID09PSB2b2lkIDApIHsKICAgICAgICB0cnkgewogICAgICAgICAgY29uc3QgZW52ID0gdm0yLmdldEVudigpOwogICAgICAgICAgY29uc3QgeyBfbG9hZGVyOiBsb2FkZXIgfSA9IHRoaXM7CiAgICAgICAgICBjb25zdCBnZXRDbGFzc0hhbmRsZSA9IGxvYWRlciAhPT0gbnVsbCA/IG1ha2VMb2FkZXJDbGFzc0hhbmRsZUdldHRlcihjbGFzc05hbWUsIGxvYWRlciwgZW52KSA6IG1ha2VCYXNpY0NsYXNzSGFuZGxlR2V0dGVyKGNsYXNzTmFtZSk7CiAgICAgICAgICBDID0gdGhpcy5fbWFrZShjbGFzc05hbWUsIGdldENsYXNzSGFuZGxlLCBlbnYpOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpZiAoYWxsb3dDYWNoZWQpIHsKICAgICAgICAgICAgdGhpcy5fc2V0VXNlZENsYXNzKGNsYXNzTmFtZSwgQyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBDOwogICAgfQogICAgX2dldFVzZWRDbGFzcyhjbGFzc05hbWUpIHsKICAgICAgbGV0IGM7CiAgICAgIHdoaWxlICgoYyA9IHRoaXMuX2NsYXNzZXNbY2xhc3NOYW1lXSkgPT09IFBFTkRJTkdfVVNFKSB7CiAgICAgICAgVGhyZWFkLnNsZWVwKDAuMDUpOwogICAgICB9CiAgICAgIGlmIChjID09PSB2b2lkIDApIHsKICAgICAgICB0aGlzLl9jbGFzc2VzW2NsYXNzTmFtZV0gPSBQRU5ESU5HX1VTRTsKICAgICAgfQogICAgICByZXR1cm4gYzsKICAgIH0KICAgIF9zZXRVc2VkQ2xhc3MoY2xhc3NOYW1lLCBjKSB7CiAgICAgIGlmIChjICE9PSB2b2lkIDApIHsKICAgICAgICB0aGlzLl9jbGFzc2VzW2NsYXNzTmFtZV0gPSBjOwogICAgICB9IGVsc2UgewogICAgICAgIGRlbGV0ZSB0aGlzLl9jbGFzc2VzW2NsYXNzTmFtZV07CiAgICAgIH0KICAgIH0KICAgIF9tYWtlKG5hbWUsIGdldENsYXNzSGFuZGxlLCBlbnYpIHsKICAgICAgY29uc3QgQyA9IG1ha2VDbGFzc1dyYXBwZXJDb25zdHJ1Y3RvcigpOwogICAgICBjb25zdCBwcm90byA9IE9iamVjdC5jcmVhdGUoV3JhcHBlci5wcm90b3R5cGUsIHsKICAgICAgICBbU3ltYm9sLmZvcigibiIpXTogewogICAgICAgICAgdmFsdWU6IG5hbWUKICAgICAgICB9LAogICAgICAgICRuOiB7CiAgICAgICAgICBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzW1N5bWJvbC5mb3IoIm4iKV07CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBbU3ltYm9sLmZvcigiQyIpXTogewogICAgICAgICAgdmFsdWU6IEMKICAgICAgICB9LAogICAgICAgICRDOiB7CiAgICAgICAgICBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzW1N5bWJvbC5mb3IoIkMiKV07CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBbU3ltYm9sLmZvcigidyIpXTogewogICAgICAgICAgdmFsdWU6IG51bGwsCiAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgIH0sCiAgICAgICAgJHc6IHsKICAgICAgICAgIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXNbU3ltYm9sLmZvcigidyIpXTsKICAgICAgICAgIH0sCiAgICAgICAgICBzZXQodmFsKSB7CiAgICAgICAgICAgIHRoaXNbU3ltYm9sLmZvcigidyIpXSA9IHZhbDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIFtTeW1ib2wuZm9yKCJfcyIpXTogewogICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICB9LAogICAgICAgICRfczogewogICAgICAgICAgZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpc1tTeW1ib2wuZm9yKCJfcyIpXTsKICAgICAgICAgIH0sCiAgICAgICAgICBzZXQodmFsKSB7CiAgICAgICAgICAgIHRoaXNbU3ltYm9sLmZvcigiX3MiKV0gPSB2YWw7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBbU3ltYm9sLmZvcigiYyIpXTogewogICAgICAgICAgdmFsdWU6IFtudWxsXQogICAgICAgIH0sCiAgICAgICAgJGM6IHsKICAgICAgICAgIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXNbU3ltYm9sLmZvcigiYyIpXTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIFtTeW1ib2wuZm9yKCJtIildOiB7CiAgICAgICAgICB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKQogICAgICAgIH0sCiAgICAgICAgJG06IHsKICAgICAgICAgIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXNbU3ltYm9sLmZvcigibSIpXTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIFtTeW1ib2wuZm9yKCJsIildOiB7CiAgICAgICAgICB2YWx1ZTogbnVsbCwKICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgfSwKICAgICAgICAkbDogewogICAgICAgICAgZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpc1tTeW1ib2wuZm9yKCJsIildOwogICAgICAgICAgfSwKICAgICAgICAgIHNldCh2YWwpIHsKICAgICAgICAgICAgdGhpc1tTeW1ib2wuZm9yKCJsIildID0gdmFsOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgW1N5bWJvbC5mb3IoImdjaCIpXTogewogICAgICAgICAgdmFsdWU6IGdldENsYXNzSGFuZGxlCiAgICAgICAgfSwKICAgICAgICAkZ2NoOiB7CiAgICAgICAgICBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzW1N5bWJvbC5mb3IoImdjaCIpXTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIFtTeW1ib2wuZm9yKCJmIildOiB7CiAgICAgICAgICB2YWx1ZTogdGhpcwogICAgICAgIH0sCiAgICAgICAgJGY6IHsKICAgICAgICAgIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXNbU3ltYm9sLmZvcigiZiIpXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBDLnByb3RvdHlwZSA9IHByb3RvOwogICAgICBjb25zdCBjbGFzc1dyYXBwZXIgPSBuZXcgQyhudWxsKTsKICAgICAgcHJvdG9bU3ltYm9sLmZvcigidyIpXSA9IGNsYXNzV3JhcHBlcjsKICAgICAgcHJvdG8uJHcgPSBjbGFzc1dyYXBwZXI7CiAgICAgIGNvbnN0IGggPSBjbGFzc1dyYXBwZXIuJGJvcnJvd0NsYXNzSGFuZGxlKGVudik7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgY2xhc3NIYW5kbGUgPSBoLnZhbHVlOwogICAgICAgIGVuc3VyZUNsYXNzSW5pdGlhbGl6ZWQzKGVudiwgY2xhc3NIYW5kbGUpOwogICAgICAgIHByb3RvLiRsID0gTW9kZWwuYnVpbGQoY2xhc3NIYW5kbGUsIGVudik7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgaC51bnJlZihlbnYpOwogICAgICB9CiAgICAgIHJldHVybiBjbGFzc1dyYXBwZXI7CiAgICB9CiAgICByZXRhaW4ob2JqKSB7CiAgICAgIGNvbnN0IGVudiA9IHZtMi5nZXRFbnYoKTsKICAgICAgcmV0dXJuIG9iai4kY2xvbmUoZW52KTsKICAgIH0KICAgIGNhc3Qob2JqLCBrbGFzcywgb3duZWQpIHsKICAgICAgY29uc3QgZW52ID0gdm0yLmdldEVudigpOwogICAgICBsZXQgaGFuZGxlID0gb2JqLiRoOwogICAgICBpZiAoaGFuZGxlID09PSB2b2lkIDApIHsKICAgICAgICBoYW5kbGUgPSBvYmo7CiAgICAgIH0KICAgICAgY29uc3QgaCA9IGtsYXNzLiRib3Jyb3dDbGFzc0hhbmRsZShlbnYpOwogICAgICB0cnkgewogICAgICAgIGNvbnN0IGlzVmFsaWRDYXN0ID0gZW52LmlzSW5zdGFuY2VPZihoYW5kbGUsIGgudmFsdWUpOwogICAgICAgIGlmICghaXNWYWxpZENhc3QpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2FzdCBmcm9tICcke2Vudi5nZXRPYmplY3RDbGFzc05hbWUoaGFuZGxlKX0nIHRvICcke2tsYXNzLiRufScgaXNuJ3QgcG9zc2libGVgKTsKICAgICAgICB9CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgaC51bnJlZihlbnYpOwogICAgICB9CiAgICAgIGNvbnN0IEMgPSBrbGFzcy4kQzsKICAgICAgcmV0dXJuIG5ldyBDKGhhbmRsZSwgU1RSQVRFR1lfVklSVFVBTCwgZW52LCBvd25lZCk7CiAgICB9CiAgICB3cmFwKGhhbmRsZSwga2xhc3MsIGVudikgewogICAgICBjb25zdCBDID0ga2xhc3MuJEM7CiAgICAgIGNvbnN0IHdyYXBwZXIgPSBuZXcgQyhoYW5kbGUsIFNUUkFURUdZX1ZJUlRVQUwsIGVudiwgZmFsc2UpOwogICAgICB3cmFwcGVyLiRyID0gU2NyaXB0LmJpbmRXZWFrKHdyYXBwZXIsIHZtMi5tYWtlSGFuZGxlRGVzdHJ1Y3RvcihoYW5kbGUpKTsKICAgICAgcmV0dXJuIHdyYXBwZXI7CiAgICB9CiAgICBhcnJheSh0eXBlLCBlbGVtZW50cykgewogICAgICBjb25zdCBlbnYgPSB2bTIuZ2V0RW52KCk7CiAgICAgIGNvbnN0IHByaW1pdGl2ZVR5cGUgPSBnZXRQcmltaXRpdmVUeXBlKHR5cGUpOwogICAgICBpZiAocHJpbWl0aXZlVHlwZSAhPT0gbnVsbCkgewogICAgICAgIHR5cGUgPSBwcmltaXRpdmVUeXBlLm5hbWU7CiAgICAgIH0KICAgICAgY29uc3QgYXJyYXlUeXBlID0gZ2V0QXJyYXlUeXBlKCJbIiArIHR5cGUsIGZhbHNlLCB0aGlzKTsKICAgICAgY29uc3QgcmF3QXJyYXkgPSBhcnJheVR5cGUudG9KbmkoZWxlbWVudHMsIGVudik7CiAgICAgIHJldHVybiBhcnJheVR5cGUuZnJvbUpuaShyYXdBcnJheSwgZW52LCB0cnVlKTsKICAgIH0KICAgIHJlZ2lzdGVyQ2xhc3Moc3BlYykgewogICAgICBjb25zdCBlbnYgPSB2bTIuZ2V0RW52KCk7CiAgICAgIGNvbnN0IHRlbXBIYW5kbGVzID0gW107CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgQ2xhc3MgPSB0aGlzLnVzZSgiamF2YS5sYW5nLkNsYXNzIik7CiAgICAgICAgY29uc3QgTWV0aG9kID0gZW52LmphdmFMYW5nUmVmbGVjdE1ldGhvZCgpOwogICAgICAgIGNvbnN0IGludm9rZU9iamVjdE1ldGhvZE5vQXJncyA9IGVudi52YU1ldGhvZCgicG9pbnRlciIsIFtdKTsKICAgICAgICBjb25zdCBjbGFzc05hbWUgPSBzcGVjLm5hbWU7CiAgICAgICAgY29uc3QgaW50ZXJmYWNlcyA9IHNwZWMuaW1wbGVtZW50cyB8fCBbXTsKICAgICAgICBjb25zdCBzdXBlckNsYXNzID0gc3BlYy5zdXBlckNsYXNzIHx8IHRoaXMudXNlKCJqYXZhLmxhbmcuT2JqZWN0Iik7CiAgICAgICAgY29uc3QgZGV4RmllbGRzID0gW107CiAgICAgICAgY29uc3QgZGV4TWV0aG9kcyA9IFtdOwogICAgICAgIGNvbnN0IGRleFNwZWMgPSB7CiAgICAgICAgICBuYW1lOiBtYWtlSm5pT2JqZWN0VHlwZU5hbWUoY2xhc3NOYW1lKSwKICAgICAgICAgIHNvdXJjZUZpbGVOYW1lOiBtYWtlU291cmNlRmlsZU5hbWUoY2xhc3NOYW1lKSwKICAgICAgICAgIHN1cGVyQ2xhc3M6IG1ha2VKbmlPYmplY3RUeXBlTmFtZShzdXBlckNsYXNzLiRuKSwKICAgICAgICAgIGludGVyZmFjZXM6IGludGVyZmFjZXMubWFwKChpZmFjZSkgPT4gbWFrZUpuaU9iamVjdFR5cGVOYW1lKGlmYWNlLiRuKSksCiAgICAgICAgICBmaWVsZHM6IGRleEZpZWxkcywKICAgICAgICAgIG1ldGhvZHM6IGRleE1ldGhvZHMKICAgICAgICB9OwogICAgICAgIGNvbnN0IGFsbEludGVyZmFjZXMgPSBpbnRlcmZhY2VzLnNsaWNlKCk7CiAgICAgICAgaW50ZXJmYWNlcy5mb3JFYWNoKChpZmFjZSkgPT4gewogICAgICAgICAgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoaWZhY2UuY2xhc3MuZ2V0SW50ZXJmYWNlcygpKS5mb3JFYWNoKChiYXNlSWZhY2UpID0+IHsKICAgICAgICAgICAgY29uc3QgYmFzZUlmYWNlTmFtZSA9IHRoaXMuY2FzdChiYXNlSWZhY2UsIENsYXNzKS5nZXRDYW5vbmljYWxOYW1lKCk7CiAgICAgICAgICAgIGFsbEludGVyZmFjZXMucHVzaCh0aGlzLnVzZShiYXNlSWZhY2VOYW1lKSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBjb25zdCBmaWVsZHMgPSBzcGVjLmZpZWxkcyB8fCB7fTsKICAgICAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhmaWVsZHMpLmZvckVhY2goKG5hbWUpID0+IHsKICAgICAgICAgIGNvbnN0IGZpZWxkVHlwZSA9IHRoaXMuX2dldFR5cGUoZmllbGRzW25hbWVdKTsKICAgICAgICAgIGRleEZpZWxkcy5wdXNoKFtuYW1lLCBmaWVsZFR5cGUubmFtZV0pOwogICAgICAgIH0pOwogICAgICAgIGNvbnN0IGJhc2VNZXRob2RzID0ge307CiAgICAgICAgY29uc3QgcGVuZGluZ092ZXJsb2FkcyA9IHt9OwogICAgICAgIGFsbEludGVyZmFjZXMuZm9yRWFjaCgoaWZhY2UpID0+IHsKICAgICAgICAgIGNvbnN0IGggPSBpZmFjZS4kYm9ycm93Q2xhc3NIYW5kbGUoZW52KTsKICAgICAgICAgIHRlbXBIYW5kbGVzLnB1c2goaCk7CiAgICAgICAgICBjb25zdCBpZmFjZUhhbmRsZSA9IGgudmFsdWU7CiAgICAgICAgICBpZmFjZS4kb3duTWVtYmVycy5maWx0ZXIoKG5hbWUpID0+IHsKICAgICAgICAgICAgcmV0dXJuIGlmYWNlW25hbWVdLm92ZXJsb2FkcyAhPT0gdm9pZCAwOwogICAgICAgICAgfSkuZm9yRWFjaCgobmFtZSkgPT4gewogICAgICAgICAgICBjb25zdCBtZXRob2QgPSBpZmFjZVtuYW1lXTsKICAgICAgICAgICAgY29uc3Qgb3ZlcmxvYWRzID0gbWV0aG9kLm92ZXJsb2FkczsKICAgICAgICAgICAgY29uc3Qgb3ZlcmxvYWRJZHMgPSBvdmVybG9hZHMubWFwKChvdmVybG9hZCkgPT4gbWFrZU92ZXJsb2FkSWQobmFtZSwgb3ZlcmxvYWQucmV0dXJuVHlwZSwgb3ZlcmxvYWQuYXJndW1lbnRUeXBlcykpOwogICAgICAgICAgICBiYXNlTWV0aG9kc1tuYW1lXSA9IFttZXRob2QsIG92ZXJsb2FkSWRzLCBpZmFjZUhhbmRsZV07CiAgICAgICAgICAgIG92ZXJsb2Fkcy5mb3JFYWNoKChvdmVybG9hZCwgaW5kZXgpID0+IHsKICAgICAgICAgICAgICBjb25zdCBpZCA9IG92ZXJsb2FkSWRzW2luZGV4XTsKICAgICAgICAgICAgICBwZW5kaW5nT3ZlcmxvYWRzW2lkXSA9IFtvdmVybG9hZCwgaWZhY2VIYW5kbGVdOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICAgIGNvbnN0IG1ldGhvZHMgPSBzcGVjLm1ldGhvZHMgfHwge307CiAgICAgICAgY29uc3QgbWV0aG9kTmFtZXMgPSBPYmplY3Qua2V5cyhtZXRob2RzKTsKICAgICAgICBjb25zdCBtZXRob2RFbnRyaWVzID0gbWV0aG9kTmFtZXMucmVkdWNlKChyZXN1bHQsIG5hbWUpID0+IHsKICAgICAgICAgIGNvbnN0IGVudHJ5ID0gbWV0aG9kc1tuYW1lXTsKICAgICAgICAgIGNvbnN0IHJhd05hbWUgPSBuYW1lID09PSAiJGluaXQiID8gIjxpbml0PiIgOiBuYW1lOwogICAgICAgICAgaWYgKGVudHJ5IGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgICAgcmVzdWx0LnB1c2goLi4uZW50cnkubWFwKChlKSA9PiBbcmF3TmFtZSwgZV0pKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKFtyYXdOYW1lLCBlbnRyeV0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LCBbXSk7CiAgICAgICAgY29uc3QgaW1wbE1ldGhvZHMgPSBbXTsKICAgICAgICBtZXRob2RFbnRyaWVzLmZvckVhY2goKFtuYW1lLCBtZXRob2RWYWx1ZV0pID0+IHsKICAgICAgICAgIGxldCB0eXBlID0gSU5TVEFOQ0VfTUVUSE9EOwogICAgICAgICAgbGV0IHJldHVyblR5cGU7CiAgICAgICAgICBsZXQgYXJndW1lbnRUeXBlczsKICAgICAgICAgIGxldCB0aHJvd25UeXBlTmFtZXMgPSBbXTsKICAgICAgICAgIGxldCBpbXBsOwogICAgICAgICAgaWYgKHR5cGVvZiBtZXRob2RWYWx1ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBjb25zdCBtID0gYmFzZU1ldGhvZHNbbmFtZV07CiAgICAgICAgICAgIGlmIChtICE9PSB2b2lkIDAgJiYgQXJyYXkuaXNBcnJheShtKSkgewogICAgICAgICAgICAgIGNvbnN0IFtiYXNlTWV0aG9kLCBvdmVybG9hZElkcywgcGFyZW50VHlwZUhhbmRsZV0gPSBtOwogICAgICAgICAgICAgIGlmIChvdmVybG9hZElkcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE1vcmUgdGhhbiBvbmUgb3ZlcmxvYWQgbWF0Y2hpbmcgJyR7bmFtZX0nOiBzaWduYXR1cmUgbXVzdCBiZSBzcGVjaWZpZWRgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGVsZXRlIHBlbmRpbmdPdmVybG9hZHNbb3ZlcmxvYWRJZHNbMF1dOwogICAgICAgICAgICAgIGNvbnN0IG92ZXJsb2FkID0gYmFzZU1ldGhvZC5vdmVybG9hZHNbMF07CiAgICAgICAgICAgICAgdHlwZSA9IG92ZXJsb2FkLnR5cGU7CiAgICAgICAgICAgICAgcmV0dXJuVHlwZSA9IG92ZXJsb2FkLnJldHVyblR5cGU7CiAgICAgICAgICAgICAgYXJndW1lbnRUeXBlcyA9IG92ZXJsb2FkLmFyZ3VtZW50VHlwZXM7CiAgICAgICAgICAgICAgaW1wbCA9IG1ldGhvZFZhbHVlOwogICAgICAgICAgICAgIGNvbnN0IHJlZmxlY3RlZE1ldGhvZCA9IGVudi50b1JlZmxlY3RlZE1ldGhvZChwYXJlbnRUeXBlSGFuZGxlLCBvdmVybG9hZC5oYW5kbGUsIDApOwogICAgICAgICAgICAgIGNvbnN0IHRocm93blR5cGVzID0gaW52b2tlT2JqZWN0TWV0aG9kTm9BcmdzKGVudi5oYW5kbGUsIHJlZmxlY3RlZE1ldGhvZCwgTWV0aG9kLmdldEdlbmVyaWNFeGNlcHRpb25UeXBlcyk7CiAgICAgICAgICAgICAgdGhyb3duVHlwZU5hbWVzID0gcmVhZFR5cGVOYW1lcyhlbnYsIHRocm93blR5cGVzKS5tYXAobWFrZUpuaU9iamVjdFR5cGVOYW1lKTsKICAgICAgICAgICAgICBlbnYuZGVsZXRlTG9jYWxSZWYodGhyb3duVHlwZXMpOwogICAgICAgICAgICAgIGVudi5kZWxldGVMb2NhbFJlZihyZWZsZWN0ZWRNZXRob2QpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVyblR5cGUgPSB0aGlzLl9nZXRUeXBlKCJ2b2lkIik7CiAgICAgICAgICAgICAgYXJndW1lbnRUeXBlcyA9IFtdOwogICAgICAgICAgICAgIGltcGwgPSBtZXRob2RWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKG1ldGhvZFZhbHVlLmlzU3RhdGljKSB7CiAgICAgICAgICAgICAgdHlwZSA9IFNUQVRJQ19NRVRIT0Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuVHlwZSA9IHRoaXMuX2dldFR5cGUobWV0aG9kVmFsdWUucmV0dXJuVHlwZSB8fCAidm9pZCIpOwogICAgICAgICAgICBhcmd1bWVudFR5cGVzID0gKG1ldGhvZFZhbHVlLmFyZ3VtZW50VHlwZXMgfHwgW10pLm1hcCgobmFtZTIpID0+IHRoaXMuX2dldFR5cGUobmFtZTIpKTsKICAgICAgICAgICAgaW1wbCA9IG1ldGhvZFZhbHVlLmltcGxlbWVudGF0aW9uOwogICAgICAgICAgICBpZiAodHlwZW9mIGltcGwgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIGEgZnVuY3Rpb24gaW1wbGVtZW50YXRpb24gZm9yIG1ldGhvZDogIiArIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGlkID0gbWFrZU92ZXJsb2FkSWQobmFtZSwgcmV0dXJuVHlwZSwgYXJndW1lbnRUeXBlcyk7CiAgICAgICAgICAgIGNvbnN0IHBlbmRpbmdPdmVybG9hZCA9IHBlbmRpbmdPdmVybG9hZHNbaWRdOwogICAgICAgICAgICBpZiAocGVuZGluZ092ZXJsb2FkICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBjb25zdCBbb3ZlcmxvYWQsIHBhcmVudFR5cGVIYW5kbGVdID0gcGVuZGluZ092ZXJsb2FkOwogICAgICAgICAgICAgIGRlbGV0ZSBwZW5kaW5nT3ZlcmxvYWRzW2lkXTsKICAgICAgICAgICAgICB0eXBlID0gb3ZlcmxvYWQudHlwZTsKICAgICAgICAgICAgICByZXR1cm5UeXBlID0gb3ZlcmxvYWQucmV0dXJuVHlwZTsKICAgICAgICAgICAgICBhcmd1bWVudFR5cGVzID0gb3ZlcmxvYWQuYXJndW1lbnRUeXBlczsKICAgICAgICAgICAgICBjb25zdCByZWZsZWN0ZWRNZXRob2QgPSBlbnYudG9SZWZsZWN0ZWRNZXRob2QocGFyZW50VHlwZUhhbmRsZSwgb3ZlcmxvYWQuaGFuZGxlLCAwKTsKICAgICAgICAgICAgICBjb25zdCB0aHJvd25UeXBlcyA9IGludm9rZU9iamVjdE1ldGhvZE5vQXJncyhlbnYuaGFuZGxlLCByZWZsZWN0ZWRNZXRob2QsIE1ldGhvZC5nZXRHZW5lcmljRXhjZXB0aW9uVHlwZXMpOwogICAgICAgICAgICAgIHRocm93blR5cGVOYW1lcyA9IHJlYWRUeXBlTmFtZXMoZW52LCB0aHJvd25UeXBlcykubWFwKG1ha2VKbmlPYmplY3RUeXBlTmFtZSk7CiAgICAgICAgICAgICAgZW52LmRlbGV0ZUxvY2FsUmVmKHRocm93blR5cGVzKTsKICAgICAgICAgICAgICBlbnYuZGVsZXRlTG9jYWxSZWYocmVmbGVjdGVkTWV0aG9kKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcmV0dXJuVHlwZU5hbWUgPSByZXR1cm5UeXBlLm5hbWU7CiAgICAgICAgICBjb25zdCBhcmd1bWVudFR5cGVOYW1lcyA9IGFyZ3VtZW50VHlwZXMubWFwKCh0KSA9PiB0Lm5hbWUpOwogICAgICAgICAgY29uc3Qgc2lnbmF0dXJlID0gIigiICsgYXJndW1lbnRUeXBlTmFtZXMuam9pbigiIikgKyAiKSIgKyByZXR1cm5UeXBlTmFtZTsKICAgICAgICAgIGRleE1ldGhvZHMucHVzaChbbmFtZSwgcmV0dXJuVHlwZU5hbWUsIGFyZ3VtZW50VHlwZU5hbWVzLCB0aHJvd25UeXBlTmFtZXMsIHR5cGUgPT09IFNUQVRJQ19NRVRIT0QgPyBrQWNjU3RhdGljMiA6IDBdKTsKICAgICAgICAgIGltcGxNZXRob2RzLnB1c2goW25hbWUsIHNpZ25hdHVyZSwgdHlwZSwgcmV0dXJuVHlwZSwgYXJndW1lbnRUeXBlcywgaW1wbF0pOwogICAgICAgIH0pOwogICAgICAgIGNvbnN0IHVuaW1wbGVtZW50ZWRNZXRob2RJZHMgPSBPYmplY3Qua2V5cyhwZW5kaW5nT3ZlcmxvYWRzKTsKICAgICAgICBpZiAodW5pbXBsZW1lbnRlZE1ldGhvZElkcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk1pc3NpbmcgaW1wbGVtZW50YXRpb24gZm9yOiAiICsgdW5pbXBsZW1lbnRlZE1ldGhvZElkcy5qb2luKCIsICIpKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGV4ID0gRGV4RmlsZS5mcm9tQnVmZmVyKG1rZGV4X2RlZmF1bHQoZGV4U3BlYyksIHRoaXMpOwogICAgICAgIHRyeSB7CiAgICAgICAgICBkZXgubG9hZCgpOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBkZXguZmlsZS5kZWxldGUoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY2xhc3NXcmFwcGVyID0gdGhpcy51c2Uoc3BlYy5uYW1lKTsKICAgICAgICBjb25zdCBudW1NZXRob2RzID0gbWV0aG9kRW50cmllcy5sZW5ndGg7CiAgICAgICAgaWYgKG51bU1ldGhvZHMgPiAwKSB7CiAgICAgICAgICBjb25zdCBtZXRob2RFbGVtZW50U2l6ZSA9IDMgKiBwb2ludGVyU2l6ZTc7CiAgICAgICAgICBjb25zdCBtZXRob2RFbGVtZW50cyA9IE1lbW9yeS5hbGxvYyhudW1NZXRob2RzICogbWV0aG9kRWxlbWVudFNpemUpOwogICAgICAgICAgY29uc3QgbmF0aXZlTWV0aG9kcyA9IFtdOwogICAgICAgICAgY29uc3QgdGVtcG9yYXJ5SGFuZGxlcyA9IFtdOwogICAgICAgICAgaW1wbE1ldGhvZHMuZm9yRWFjaCgoW25hbWUsIHNpZ25hdHVyZSwgdHlwZSwgcmV0dXJuVHlwZSwgYXJndW1lbnRUeXBlcywgaW1wbF0sIGluZGV4KSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHJhd05hbWUgPSBNZW1vcnkuYWxsb2NVdGY4U3RyaW5nKG5hbWUpOwogICAgICAgICAgICBjb25zdCByYXdTaWduYXR1cmUgPSBNZW1vcnkuYWxsb2NVdGY4U3RyaW5nKHNpZ25hdHVyZSk7CiAgICAgICAgICAgIGNvbnN0IHJhd0ltcGwgPSBpbXBsZW1lbnQobmFtZSwgY2xhc3NXcmFwcGVyLCB0eXBlLCByZXR1cm5UeXBlLCBhcmd1bWVudFR5cGVzLCBpbXBsKTsKICAgICAgICAgICAgbWV0aG9kRWxlbWVudHMuYWRkKGluZGV4ICogbWV0aG9kRWxlbWVudFNpemUpLndyaXRlUG9pbnRlcihyYXdOYW1lKTsKICAgICAgICAgICAgbWV0aG9kRWxlbWVudHMuYWRkKGluZGV4ICogbWV0aG9kRWxlbWVudFNpemUgKyBwb2ludGVyU2l6ZTcpLndyaXRlUG9pbnRlcihyYXdTaWduYXR1cmUpOwogICAgICAgICAgICBtZXRob2RFbGVtZW50cy5hZGQoaW5kZXggKiBtZXRob2RFbGVtZW50U2l6ZSArIDIgKiBwb2ludGVyU2l6ZTcpLndyaXRlUG9pbnRlcihyYXdJbXBsKTsKICAgICAgICAgICAgdGVtcG9yYXJ5SGFuZGxlcy5wdXNoKHJhd05hbWUsIHJhd1NpZ25hdHVyZSk7CiAgICAgICAgICAgIG5hdGl2ZU1ldGhvZHMucHVzaChyYXdJbXBsKTsKICAgICAgICAgIH0pOwogICAgICAgICAgY29uc3QgaCA9IGNsYXNzV3JhcHBlci4kYm9ycm93Q2xhc3NIYW5kbGUoZW52KTsKICAgICAgICAgIHRlbXBIYW5kbGVzLnB1c2goaCk7CiAgICAgICAgICBjb25zdCBjbGFzc0hhbmRsZSA9IGgudmFsdWU7CiAgICAgICAgICBlbnYucmVnaXN0ZXJOYXRpdmVzKGNsYXNzSGFuZGxlLCBtZXRob2RFbGVtZW50cywgbnVtTWV0aG9kcyk7CiAgICAgICAgICBlbnYudGhyb3dJZkV4Y2VwdGlvblBlbmRpbmcoKTsKICAgICAgICAgIGNsYXNzV3JhcHBlci4kbmF0aXZlTWV0aG9kcyA9IG5hdGl2ZU1ldGhvZHM7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjbGFzc1dyYXBwZXI7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgdGVtcEhhbmRsZXMuZm9yRWFjaCgoaCkgPT4gewogICAgICAgICAgaC51bnJlZihlbnYpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgICBjaG9vc2Uoc3BlY2lmaWVyLCBjYWxsYmFja3MpIHsKICAgICAgY29uc3QgZW52ID0gdm0yLmdldEVudigpOwogICAgICBjb25zdCB7IGZsYXZvciB9ID0gYXBpOwogICAgICBpZiAoZmxhdm9yID09PSAianZtIikgewogICAgICAgIHRoaXMuX2Nob29zZU9iamVjdHNKdm0oc3BlY2lmaWVyLCBlbnYsIGNhbGxiYWNrcyk7CiAgICAgIH0gZWxzZSBpZiAoZmxhdm9yID09PSAiYXJ0IikgewogICAgICAgIGNvbnN0IGxlZ2FjeUFwaU1pc3NpbmcgPSBhcGlbImFydDo6Z2M6OkhlYXA6OlZpc2l0T2JqZWN0cyJdID09PSB2b2lkIDA7CiAgICAgICAgaWYgKGxlZ2FjeUFwaU1pc3NpbmcpIHsKICAgICAgICAgIGNvbnN0IHByZUExMkFwaU1pc3NpbmcgPSBhcGlbImFydDo6Z2M6OkhlYXA6OkdldEluc3RhbmNlcyJdID09PSB2b2lkIDA7CiAgICAgICAgICBpZiAocHJlQTEyQXBpTWlzc2luZykgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fY2hvb3NlT2JqZWN0c0p2bShzcGVjaWZpZXIsIGVudiwgY2FsbGJhY2tzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgd2l0aFJ1bm5hYmxlQXJ0VGhyZWFkKHZtMiwgZW52LCAodGhyZWFkKSA9PiB7CiAgICAgICAgICBpZiAobGVnYWN5QXBpTWlzc2luZykgewogICAgICAgICAgICB0aGlzLl9jaG9vc2VPYmplY3RzQXJ0UHJlQTEyKHNwZWNpZmllciwgZW52LCB0aHJlYWQsIGNhbGxiYWNrcyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl9jaG9vc2VPYmplY3RzQXJ0TGVnYWN5KHNwZWNpZmllciwgZW52LCB0aHJlYWQsIGNhbGxiYWNrcyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fY2hvb3NlT2JqZWN0c0RhbHZpayhzcGVjaWZpZXIsIGVudiwgY2FsbGJhY2tzKTsKICAgICAgfQogICAgfQogICAgX2Nob29zZU9iamVjdHNKdm0oY2xhc3NOYW1lLCBlbnYsIGNhbGxiYWNrcykgewogICAgICBjb25zdCBjbGFzc1dyYXBwZXIgPSB0aGlzLnVzZShjbGFzc05hbWUpOwogICAgICBjb25zdCB7IGp2bXRpIH0gPSBhcGk7CiAgICAgIGNvbnN0IEpWTVRJX0lURVJBVElPTl9DT05USU5VRSA9IDE7CiAgICAgIGNvbnN0IEpWTVRJX0hFQVBfT0JKRUNUX0VJVEhFUiA9IDM7CiAgICAgIGNvbnN0IGggPSBjbGFzc1dyYXBwZXIuJGJvcnJvd0NsYXNzSGFuZGxlKGVudik7CiAgICAgIGNvbnN0IHRhZyA9IGludDY0KGgudmFsdWUudG9TdHJpbmcoKSk7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgaGVhcE9iamVjdENhbGxiYWNrID0gbmV3IE5hdGl2ZUNhbGxiYWNrKChjbGFzc1RhZywgc2l6ZSwgdGFnUHRyMiwgdXNlckRhdGEpID0+IHsKICAgICAgICAgIHRhZ1B0cjIud3JpdGVTNjQodGFnKTsKICAgICAgICAgIHJldHVybiBKVk1USV9JVEVSQVRJT05fQ09OVElOVUU7CiAgICAgICAgfSwgImludCIsIFsiaW50NjQiLCAiaW50NjQiLCAicG9pbnRlciIsICJwb2ludGVyIl0pOwogICAgICAgIGp2bXRpLml0ZXJhdGVPdmVySW5zdGFuY2VzT2ZDbGFzcyhoLnZhbHVlLCBKVk1USV9IRUFQX09CSkVDVF9FSVRIRVIsIGhlYXBPYmplY3RDYWxsYmFjaywgaC52YWx1ZSk7CiAgICAgICAgY29uc3QgdGFnUHRyID0gTWVtb3J5LmFsbG9jKDgpOwogICAgICAgIHRhZ1B0ci53cml0ZVM2NCh0YWcpOwogICAgICAgIGNvbnN0IGNvdW50UHRyID0gTWVtb3J5LmFsbG9jKGpzaXplU2l6ZTMpOwogICAgICAgIGNvbnN0IG9iamVjdHNQdHIgPSBNZW1vcnkuYWxsb2MocG9pbnRlclNpemU3KTsKICAgICAgICBqdm10aS5nZXRPYmplY3RzV2l0aFRhZ3MoMSwgdGFnUHRyLCBjb3VudFB0ciwgb2JqZWN0c1B0ciwgTlVMTCk7CiAgICAgICAgY29uc3QgY291bnQgPSBjb3VudFB0ci5yZWFkUzMyKCk7CiAgICAgICAgY29uc3Qgb2JqZWN0cyA9IG9iamVjdHNQdHIucmVhZFBvaW50ZXIoKTsKICAgICAgICBjb25zdCBoYW5kbGVzID0gW107CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IGNvdW50OyBpKyspIHsKICAgICAgICAgIGhhbmRsZXMucHVzaChvYmplY3RzLmFkZChpICogcG9pbnRlclNpemU3KS5yZWFkUG9pbnRlcigpKTsKICAgICAgICB9CiAgICAgICAganZtdGkuZGVhbGxvY2F0ZShvYmplY3RzKTsKICAgICAgICB0cnkgewogICAgICAgICAgZm9yIChjb25zdCBoYW5kbGUgb2YgaGFuZGxlcykgewogICAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IHRoaXMuY2FzdChoYW5kbGUsIGNsYXNzV3JhcHBlcik7CiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGNhbGxiYWNrcy5vbk1hdGNoKGluc3RhbmNlKTsKICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gInN0b3AiKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNhbGxiYWNrcy5vbkNvbXBsZXRlKCk7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGhhbmRsZXMuZm9yRWFjaCgoaGFuZGxlKSA9PiB7CiAgICAgICAgICAgIGVudi5kZWxldGVMb2NhbFJlZihoYW5kbGUpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9IGZpbmFsbHkgewogICAgICAgIGgudW5yZWYoZW52KTsKICAgICAgfQogICAgfQogICAgX2Nob29zZU9iamVjdHNBcnRQcmVBMTIoY2xhc3NOYW1lLCBlbnYsIHRocmVhZCwgY2FsbGJhY2tzKSB7CiAgICAgIGNvbnN0IGNsYXNzV3JhcHBlciA9IHRoaXMudXNlKGNsYXNzTmFtZSk7CiAgICAgIGNvbnN0IHNjb3BlID0gVmFyaWFibGVTaXplZEhhbmRsZVNjb3BlLiRuZXcodGhyZWFkLCB2bTIpOwogICAgICBsZXQgbmVlZGxlOwogICAgICBjb25zdCBoID0gY2xhc3NXcmFwcGVyLiRib3Jyb3dDbGFzc0hhbmRsZShlbnYpOwogICAgICB0cnkgewogICAgICAgIGNvbnN0IG9iamVjdCA9IGFwaVsiYXJ0OjpKYXZhVk1FeHQ6OkRlY29kZUdsb2JhbCJdKGFwaS52bSwgdGhyZWFkLCBoLnZhbHVlKTsKICAgICAgICBuZWVkbGUgPSBzY29wZS5uZXdIYW5kbGUob2JqZWN0KTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBoLnVucmVmKGVudik7CiAgICAgIH0KICAgICAgY29uc3QgbWF4Q291bnQgPSAwOwogICAgICBjb25zdCBpbnN0YW5jZXMgPSBIYW5kbGVWZWN0b3IuJG5ldygpOwogICAgICBhcGlbImFydDo6Z2M6OkhlYXA6OkdldEluc3RhbmNlcyJdKGFwaS5hcnRIZWFwLCBzY29wZSwgbmVlZGxlLCBtYXhDb3VudCwgaW5zdGFuY2VzKTsKICAgICAgY29uc3QgaW5zdGFuY2VIYW5kbGVzID0gaW5zdGFuY2VzLmhhbmRsZXMubWFwKChoYW5kbGUpID0+IGVudi5uZXdHbG9iYWxSZWYoaGFuZGxlKSk7CiAgICAgIGluc3RhbmNlcy4kZGVsZXRlKCk7CiAgICAgIHNjb3BlLiRkZWxldGUoKTsKICAgICAgdHJ5IHsKICAgICAgICBmb3IgKGNvbnN0IGhhbmRsZSBvZiBpbnN0YW5jZUhhbmRsZXMpIHsKICAgICAgICAgIGNvbnN0IGluc3RhbmNlID0gdGhpcy5jYXN0KGhhbmRsZSwgY2xhc3NXcmFwcGVyKTsKICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGNhbGxiYWNrcy5vbk1hdGNoKGluc3RhbmNlKTsKICAgICAgICAgIGlmIChyZXN1bHQgPT09ICJzdG9wIikgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY2FsbGJhY2tzLm9uQ29tcGxldGUoKTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBpbnN0YW5jZUhhbmRsZXMuZm9yRWFjaCgoaGFuZGxlKSA9PiB7CiAgICAgICAgICBlbnYuZGVsZXRlR2xvYmFsUmVmKGhhbmRsZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIF9jaG9vc2VPYmplY3RzQXJ0TGVnYWN5KGNsYXNzTmFtZSwgZW52LCB0aHJlYWQsIGNhbGxiYWNrcykgewogICAgICBjb25zdCBjbGFzc1dyYXBwZXIgPSB0aGlzLnVzZShjbGFzc05hbWUpOwogICAgICBjb25zdCBpbnN0YW5jZUhhbmRsZXMgPSBbXTsKICAgICAgY29uc3QgYWRkR2xvYmFsUmVmZXJlbmNlID0gYXBpWyJhcnQ6OkphdmFWTUV4dDo6QWRkR2xvYmFsUmVmIl07CiAgICAgIGNvbnN0IHZtSGFuZGxlID0gYXBpLnZtOwogICAgICBsZXQgbmVlZGxlOwogICAgICBjb25zdCBoID0gY2xhc3NXcmFwcGVyLiRib3Jyb3dDbGFzc0hhbmRsZShlbnYpOwogICAgICB0cnkgewogICAgICAgIG5lZWRsZSA9IGFwaVsiYXJ0OjpKYXZhVk1FeHQ6OkRlY29kZUdsb2JhbCJdKHZtSGFuZGxlLCB0aHJlYWQsIGgudmFsdWUpLnRvSW50MzIoKTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBoLnVucmVmKGVudik7CiAgICAgIH0KICAgICAgY29uc3QgY29sbGVjdE1hdGNoaW5nSW5zdGFuY2VIYW5kbGVzID0gbWFrZU9iamVjdFZpc2l0b3JQcmVkaWNhdGUobmVlZGxlLCAob2JqZWN0KSA9PiB7CiAgICAgICAgaW5zdGFuY2VIYW5kbGVzLnB1c2goYWRkR2xvYmFsUmVmZXJlbmNlKHZtSGFuZGxlLCB0aHJlYWQsIG9iamVjdCkpOwogICAgICB9KTsKICAgICAgYXBpWyJhcnQ6OmdjOjpIZWFwOjpWaXNpdE9iamVjdHMiXShhcGkuYXJ0SGVhcCwgY29sbGVjdE1hdGNoaW5nSW5zdGFuY2VIYW5kbGVzLCBOVUxMKTsKICAgICAgdHJ5IHsKICAgICAgICBmb3IgKGNvbnN0IGhhbmRsZSBvZiBpbnN0YW5jZUhhbmRsZXMpIHsKICAgICAgICAgIGNvbnN0IGluc3RhbmNlID0gdGhpcy5jYXN0KGhhbmRsZSwgY2xhc3NXcmFwcGVyKTsKICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGNhbGxiYWNrcy5vbk1hdGNoKGluc3RhbmNlKTsKICAgICAgICAgIGlmIChyZXN1bHQgPT09ICJzdG9wIikgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgaW5zdGFuY2VIYW5kbGVzLmZvckVhY2goKGhhbmRsZSkgPT4gewogICAgICAgICAgZW52LmRlbGV0ZUdsb2JhbFJlZihoYW5kbGUpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGNhbGxiYWNrcy5vbkNvbXBsZXRlKCk7CiAgICB9CiAgICBfY2hvb3NlT2JqZWN0c0RhbHZpayhjbGFzc05hbWUsIGNhbGxlckVudiwgY2FsbGJhY2tzKSB7CiAgICAgIGNvbnN0IGNsYXNzV3JhcHBlciA9IHRoaXMudXNlKGNsYXNzTmFtZSk7CiAgICAgIGlmIChhcGkuYWRkTG9jYWxSZWZlcmVuY2UgPT09IG51bGwpIHsKICAgICAgICBjb25zdCBsaWJkdm0gPSBQcm9jZXNzLmdldE1vZHVsZUJ5TmFtZSgibGliZHZtLnNvIik7CiAgICAgICAgbGV0IHBhdHRlcm47CiAgICAgICAgc3dpdGNoIChQcm9jZXNzLmFyY2gpIHsKICAgICAgICAgIGNhc2UgImFybSI6CiAgICAgICAgICAgIHBhdHRlcm4gPSAiMmQgZTkgZjAgNDEgMDUgNDYgMTUgNGUgMGMgNDYgN2UgNDQgMTEgYjMgNDMgNjgiOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgImlhMzIiOgogICAgICAgICAgICBwYXR0ZXJuID0gIjhkIDY0IDI0IGQ0IDg5IDVjIDI0IDFjIDg5IDc0IDI0IDIwIGU4ID8/ID8/ID8/ID8/ID8/ID8/ID8/ID8/ID8/ID8/IDg1IGQyIjsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIE1lbW9yeS5zY2FuKGxpYmR2bS5iYXNlLCBsaWJkdm0uc2l6ZSwgcGF0dGVybiwgewogICAgICAgICAgb25NYXRjaDogKGFkZHJlc3MsIHNpemUpID0+IHsKICAgICAgICAgICAgbGV0IHdyYXBwZXI7CiAgICAgICAgICAgIGlmIChQcm9jZXNzLmFyY2ggPT09ICJhcm0iKSB7CiAgICAgICAgICAgICAgYWRkcmVzcyA9IGFkZHJlc3Mub3IoMSk7CiAgICAgICAgICAgICAgd3JhcHBlciA9IG5ldyBOYXRpdmVGdW5jdGlvbihhZGRyZXNzLCAicG9pbnRlciIsIFsicG9pbnRlciIsICJwb2ludGVyIl0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbnN0IHRodW5rID0gTWVtb3J5LmFsbG9jKFByb2Nlc3MucGFnZVNpemUpOwogICAgICAgICAgICAgIE1lbW9yeS5wYXRjaENvZGUodGh1bmssIDE2LCAoY29kZTIpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGN3ID0gbmV3IFg4NldyaXRlcihjb2RlMiwgeyBwYzogdGh1bmsgfSk7CiAgICAgICAgICAgICAgICBjdy5wdXRNb3ZSZWdSZWdPZmZzZXRQdHIoImVheCIsICJlc3AiLCA0KTsKICAgICAgICAgICAgICAgIGN3LnB1dE1vdlJlZ1JlZ09mZnNldFB0cigiZWR4IiwgImVzcCIsIDgpOwogICAgICAgICAgICAgICAgY3cucHV0Sm1wQWRkcmVzcyhhZGRyZXNzKTsKICAgICAgICAgICAgICAgIGN3LmZsdXNoKCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgd3JhcHBlciA9IG5ldyBOYXRpdmVGdW5jdGlvbih0aHVuaywgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAicG9pbnRlciJdKTsKICAgICAgICAgICAgICB3cmFwcGVyLl90aHVuayA9IHRodW5rOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFwaS5hZGRMb2NhbFJlZmVyZW5jZSA9IHdyYXBwZXI7CiAgICAgICAgICAgIHZtMi5wZXJmb3JtKChlbnYpID0+IHsKICAgICAgICAgICAgICBlbnVtZXJhdGVJbnN0YW5jZXModGhpcywgZW52KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiAic3RvcCI7CiAgICAgICAgICB9LAogICAgICAgICAgb25FcnJvcihyZWFzb24pIHsKICAgICAgICAgIH0sCiAgICAgICAgICBvbkNvbXBsZXRlKCkgewogICAgICAgICAgICBpZiAoYXBpLmFkZExvY2FsUmVmZXJlbmNlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uQ29tcGxldGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGVudW1lcmF0ZUluc3RhbmNlcyh0aGlzLCBjYWxsZXJFbnYpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGVudW1lcmF0ZUluc3RhbmNlcyhmYWN0b3J5LCBlbnYpIHsKICAgICAgICBjb25zdCB7IERWTV9KTklfRU5WX09GRlNFVF9TRUxGOiBEVk1fSk5JX0VOVl9PRkZTRVRfU0VMRjIgfSA9IGFuZHJvaWRfZXhwb3J0czsKICAgICAgICBjb25zdCB0aHJlYWQgPSBlbnYuaGFuZGxlLmFkZChEVk1fSk5JX0VOVl9PRkZTRVRfU0VMRjIpLnJlYWRQb2ludGVyKCk7CiAgICAgICAgbGV0IHB0ckNsYXNzT2JqZWN0OwogICAgICAgIGNvbnN0IGggPSBjbGFzc1dyYXBwZXIuJGJvcnJvd0NsYXNzSGFuZGxlKGVudik7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHB0ckNsYXNzT2JqZWN0ID0gYXBpLmR2bURlY29kZUluZGlyZWN0UmVmKHRocmVhZCwgaC52YWx1ZSk7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGgudW5yZWYoZW52KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcGF0dGVybiA9IHB0ckNsYXNzT2JqZWN0LnRvTWF0Y2hQYXR0ZXJuKCk7CiAgICAgICAgY29uc3QgaGVhcFNvdXJjZUJhc2UgPSBhcGkuZHZtSGVhcFNvdXJjZUdldEJhc2UoKTsKICAgICAgICBjb25zdCBoZWFwU291cmNlTGltaXQgPSBhcGkuZHZtSGVhcFNvdXJjZUdldExpbWl0KCk7CiAgICAgICAgY29uc3Qgc2l6ZSA9IGhlYXBTb3VyY2VMaW1pdC5zdWIoaGVhcFNvdXJjZUJhc2UpLnRvSW50MzIoKTsKICAgICAgICBNZW1vcnkuc2NhbihoZWFwU291cmNlQmFzZSwgc2l6ZSwgcGF0dGVybiwgewogICAgICAgICAgb25NYXRjaDogKGFkZHJlc3MsIHNpemUyKSA9PiB7CiAgICAgICAgICAgIGlmIChhcGkuZHZtSXNWYWxpZE9iamVjdChhZGRyZXNzKSkgewogICAgICAgICAgICAgIHZtMi5wZXJmb3JtKChlbnYyKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCB0aHJlYWQyID0gZW52Mi5oYW5kbGUuYWRkKERWTV9KTklfRU5WX09GRlNFVF9TRUxGMikucmVhZFBvaW50ZXIoKTsKICAgICAgICAgICAgICAgIGxldCBpbnN0YW5jZTsKICAgICAgICAgICAgICAgIGNvbnN0IGxvY2FsUmVmZXJlbmNlID0gYXBpLmFkZExvY2FsUmVmZXJlbmNlKHRocmVhZDIsIGFkZHJlc3MpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaW5zdGFuY2UgPSBmYWN0b3J5LmNhc3QobG9jYWxSZWZlcmVuY2UsIGNsYXNzV3JhcHBlcik7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBlbnYyLmRlbGV0ZUxvY2FsUmVmKGxvY2FsUmVmZXJlbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGNhbGxiYWNrcy5vbk1hdGNoKGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgPT09ICJzdG9wIikgewogICAgICAgICAgICAgICAgICByZXR1cm4gInN0b3AiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgb25FcnJvcihyZWFzb24pIHsKICAgICAgICAgIH0sCiAgICAgICAgICBvbkNvbXBsZXRlKCkgewogICAgICAgICAgICBjYWxsYmFja3Mub25Db21wbGV0ZSgpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgICBvcGVuQ2xhc3NGaWxlKGZpbGVQYXRoKSB7CiAgICAgIHJldHVybiBuZXcgRGV4RmlsZShmaWxlUGF0aCwgbnVsbCwgdGhpcyk7CiAgICB9CiAgICBfZ2V0VHlwZSh0eXBlTmFtZSwgdW5ib3ggPSB0cnVlKSB7CiAgICAgIHJldHVybiBnZXRUeXBlKHR5cGVOYW1lLCB1bmJveCwgdGhpcyk7CiAgICB9CiAgfTsKICBmdW5jdGlvbiBtYWtlQ2xhc3NXcmFwcGVyQ29uc3RydWN0b3IoKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oaGFuZGxlLCBzdHJhdGVneSwgZW52LCBvd25lZCkgewogICAgICByZXR1cm4gV3JhcHBlci5jYWxsKHRoaXMsIGhhbmRsZSwgc3RyYXRlZ3ksIGVudiwgb3duZWQpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gV3JhcHBlcihoYW5kbGUsIHN0cmF0ZWd5LCBlbnYsIG93bmVkID0gdHJ1ZSkgewogICAgaWYgKGhhbmRsZSAhPT0gbnVsbCkgewogICAgICBpZiAob3duZWQpIHsKICAgICAgICBjb25zdCBoID0gZW52Lm5ld0dsb2JhbFJlZihoYW5kbGUpOwogICAgICAgIHRoaXMuJGggPSBoOwogICAgICAgIHRoaXMuJHIgPSBTY3JpcHQuYmluZFdlYWsodGhpcywgdm0yLm1ha2VIYW5kbGVEZXN0cnVjdG9yKGgpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLiRoID0gaGFuZGxlOwogICAgICAgIHRoaXMuJHIgPSBudWxsOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0aGlzLiRoID0gbnVsbDsKICAgICAgdGhpcy4kciA9IG51bGw7CiAgICB9CiAgICB0aGlzLiR0ID0gc3RyYXRlZ3k7CiAgICByZXR1cm4gbmV3IFByb3h5KHRoaXMsIHdyYXBwZXJIYW5kbGVyKTsKICB9CiAgd3JhcHBlckhhbmRsZXIgPSB7CiAgICBoYXModGFyZ2V0LCBwcm9wZXJ0eSkgewogICAgICBpZiAocHJvcGVydHkgaW4gdGFyZ2V0KSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIHRhcmdldC4kaGFzKHByb3BlcnR5KTsKICAgIH0sCiAgICBnZXQodGFyZ2V0LCBwcm9wZXJ0eSwgcmVjZWl2ZXIpIHsKICAgICAgaWYgKHR5cGVvZiBwcm9wZXJ0eSAhPT0gInN0cmluZyIgfHwgcHJvcGVydHkuc3RhcnRzV2l0aCgiJCIpIHx8IHByb3BlcnR5ID09PSAiY2xhc3MiKSB7CiAgICAgICAgcmV0dXJuIHRhcmdldFtwcm9wZXJ0eV07CiAgICAgIH0KICAgICAgY29uc3QgdW53cmFwMiA9IHRhcmdldC4kZmluZChwcm9wZXJ0eSk7CiAgICAgIGlmICh1bndyYXAyICE9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHVud3JhcDIocmVjZWl2ZXIpOwogICAgICB9CiAgICAgIHJldHVybiB0YXJnZXRbcHJvcGVydHldOwogICAgfSwKICAgIHNldCh0YXJnZXQsIHByb3BlcnR5LCB2YWx1ZSwgcmVjZWl2ZXIpIHsKICAgICAgdGFyZ2V0W3Byb3BlcnR5XSA9IHZhbHVlOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCiAgICBvd25LZXlzKHRhcmdldCkgewogICAgICByZXR1cm4gdGFyZ2V0LiRsaXN0KCk7CiAgICB9LAogICAgZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwgcHJvcGVydHkpIHsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0YXJnZXQsIHByb3BlcnR5KSkgewogICAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwgcHJvcGVydHkpOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgd3JpdGFibGU6IGZhbHNlLAogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgIH07CiAgICB9CiAgfTsKICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhXcmFwcGVyLnByb3RvdHlwZSwgewogICAgW1N5bWJvbC5mb3IoIm5ldyIpXTogewogICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLiRnZXRDdG9yKCJhbGxvY0FuZEluaXQiKTsKICAgICAgfQogICAgfSwKICAgICRuZXc6IHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzW1N5bWJvbC5mb3IoIm5ldyIpXTsKICAgICAgfQogICAgfSwKICAgIFtTeW1ib2wuZm9yKCJhbGxvYyIpXTogewogICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgdmFsdWUoKSB7CiAgICAgICAgY29uc3QgZW52ID0gdm0yLmdldEVudigpOwogICAgICAgIGNvbnN0IGggPSB0aGlzLiRib3Jyb3dDbGFzc0hhbmRsZShlbnYpOwogICAgICAgIHRyeSB7CiAgICAgICAgICBjb25zdCBvYmogPSBlbnYuYWxsb2NPYmplY3QoaC52YWx1ZSk7CiAgICAgICAgICBjb25zdCBmYWN0b3J5ID0gdGhpcy4kZjsKICAgICAgICAgIHJldHVybiBmYWN0b3J5LmNhc3Qob2JqLCB0aGlzKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaC51bnJlZihlbnYpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICRhbGxvYzogewogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXNbU3ltYm9sLmZvcigiYWxsb2MiKV07CiAgICAgIH0KICAgIH0sCiAgICBbU3ltYm9sLmZvcigiaW5pdCIpXTogewogICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLiRnZXRDdG9yKCJpbml0T25seSIpOwogICAgICB9CiAgICB9LAogICAgJGluaXQ6IHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzW1N5bWJvbC5mb3IoImluaXQiKV07CiAgICAgIH0KICAgIH0sCiAgICBbU3ltYm9sLmZvcigiZGlzcG9zZSIpXTogewogICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgdmFsdWUoKSB7CiAgICAgICAgY29uc3QgcmVmID0gdGhpcy4kcjsKICAgICAgICBpZiAocmVmICE9PSBudWxsKSB7CiAgICAgICAgICB0aGlzLiRyID0gbnVsbDsKICAgICAgICAgIFNjcmlwdC51bmJpbmRXZWFrKHJlZik7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLiRoICE9PSBudWxsKSB7CiAgICAgICAgICB0aGlzLiRoID0gdm9pZCAwOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICRkaXNwb3NlOiB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpc1tTeW1ib2wuZm9yKCJkaXNwb3NlIildOwogICAgICB9CiAgICB9LAogICAgW1N5bWJvbC5mb3IoImNsb25lIildOiB7CiAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICB2YWx1ZShlbnYpIHsKICAgICAgICBjb25zdCBDID0gdGhpcy4kQzsKICAgICAgICByZXR1cm4gbmV3IEModGhpcy4kaCwgdGhpcy4kdCwgZW52KTsKICAgICAgfQogICAgfSwKICAgICRjbG9uZTogewogICAgICB2YWx1ZShlbnYpIHsKICAgICAgICByZXR1cm4gdGhpc1tTeW1ib2wuZm9yKCJjbG9uZSIpXShlbnYpOwogICAgICB9CiAgICB9LAogICAgW1N5bWJvbC5mb3IoImNsYXNzIildOiB7CiAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICBnZXQoKSB7CiAgICAgICAgY29uc3QgZW52ID0gdm0yLmdldEVudigpOwogICAgICAgIGNvbnN0IGggPSB0aGlzLiRib3Jyb3dDbGFzc0hhbmRsZShlbnYpOwogICAgICAgIHRyeSB7CiAgICAgICAgICBjb25zdCBmYWN0b3J5ID0gdGhpcy4kZjsKICAgICAgICAgIHJldHVybiBmYWN0b3J5LmNhc3QoaC52YWx1ZSwgZmFjdG9yeS51c2UoImphdmEubGFuZy5DbGFzcyIpKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaC51bnJlZihlbnYpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGNsYXNzOiB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpc1tTeW1ib2wuZm9yKCJjbGFzcyIpXTsKICAgICAgfQogICAgfSwKICAgIFtTeW1ib2wuZm9yKCJjbGFzc05hbWUiKV06IHsKICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgIGdldCgpIHsKICAgICAgICBjb25zdCBoYW5kbGUgPSB0aGlzLiRoOwogICAgICAgIGlmIChoYW5kbGUgPT09IG51bGwpIHsKICAgICAgICAgIHJldHVybiB0aGlzLiRuOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdm0yLmdldEVudigpLmdldE9iamVjdENsYXNzTmFtZShoYW5kbGUpOwogICAgICB9CiAgICB9LAogICAgJGNsYXNzTmFtZTogewogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXNbU3ltYm9sLmZvcigiY2xhc3NOYW1lIildOwogICAgICB9CiAgICB9LAogICAgW1N5bWJvbC5mb3IoIm93bk1lbWJlcnMiKV06IHsKICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgIGdldCgpIHsKICAgICAgICBjb25zdCBtb2RlbCA9IHRoaXMuJGw7CiAgICAgICAgcmV0dXJuIG1vZGVsLmxpc3QoKTsKICAgICAgfQogICAgfSwKICAgICRvd25NZW1iZXJzOiB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpc1tTeW1ib2wuZm9yKCJvd25NZW1iZXJzIildOwogICAgICB9CiAgICB9LAogICAgW1N5bWJvbC5mb3IoInN1cGVyIildOiB7CiAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICBnZXQoKSB7CiAgICAgICAgY29uc3QgZW52ID0gdm0yLmdldEVudigpOwogICAgICAgIGNvbnN0IEMgPSB0aGlzLiRzLiRDOwogICAgICAgIHJldHVybiBuZXcgQyh0aGlzLiRoLCBTVFJBVEVHWV9ESVJFQ1QsIGVudik7CiAgICAgIH0KICAgIH0sCiAgICAkc3VwZXI6IHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzW1N5bWJvbC5mb3IoInN1cGVyIildOwogICAgICB9CiAgICB9LAogICAgW1N5bWJvbC5mb3IoInMiKV06IHsKICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgIGdldCgpIHsKICAgICAgICBjb25zdCBwcm90byA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKTsKICAgICAgICBsZXQgc3VwZXJXcmFwcGVyID0gcHJvdG8uJF9zOwogICAgICAgIGlmIChzdXBlcldyYXBwZXIgPT09IHZvaWQgMCkgewogICAgICAgICAgY29uc3QgZW52ID0gdm0yLmdldEVudigpOwogICAgICAgICAgY29uc3QgaCA9IHRoaXMuJGJvcnJvd0NsYXNzSGFuZGxlKGVudik7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCBzdXBlckhhbmRsZSA9IGVudi5nZXRTdXBlcmNsYXNzKGgudmFsdWUpOwogICAgICAgICAgICBpZiAoIXN1cGVySGFuZGxlLmlzTnVsbCgpKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnN0IHN1cGVyQ2xhc3NOYW1lID0gZW52LmdldENsYXNzTmFtZShzdXBlckhhbmRsZSk7CiAgICAgICAgICAgICAgICBjb25zdCBmYWN0b3J5ID0gcHJvdG8uJGY7CiAgICAgICAgICAgICAgICBzdXBlcldyYXBwZXIgPSBmYWN0b3J5Ll9nZXRVc2VkQ2xhc3Moc3VwZXJDbGFzc05hbWUpOwogICAgICAgICAgICAgICAgaWYgKHN1cGVyV3JhcHBlciA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ2V0U3VwZXJDbGFzc0hhbmRsZSA9IG1ha2VTdXBlckhhbmRsZUdldHRlcih0aGlzKTsKICAgICAgICAgICAgICAgICAgICBzdXBlcldyYXBwZXIgPSBmYWN0b3J5Ll9tYWtlKHN1cGVyQ2xhc3NOYW1lLCBnZXRTdXBlckNsYXNzSGFuZGxlLCBlbnYpOwogICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgIGZhY3RvcnkuX3NldFVzZWRDbGFzcyhzdXBlckNsYXNzTmFtZSwgc3VwZXJXcmFwcGVyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBlbnYuZGVsZXRlTG9jYWxSZWYoc3VwZXJIYW5kbGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdXBlcldyYXBwZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBoLnVucmVmKGVudik7CiAgICAgICAgICB9CiAgICAgICAgICBwcm90by4kX3MgPSBzdXBlcldyYXBwZXI7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdXBlcldyYXBwZXI7CiAgICAgIH0KICAgIH0sCiAgICAkczogewogICAgICBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXNbU3ltYm9sLmZvcigicyIpXTsKICAgICAgfQogICAgfSwKICAgIFtTeW1ib2wuZm9yKCJpc1NhbWVPYmplY3QiKV06IHsKICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgIHZhbHVlKG9iaikgewogICAgICAgIGNvbnN0IGVudiA9IHZtMi5nZXRFbnYoKTsKICAgICAgICByZXR1cm4gZW52LmlzU2FtZU9iamVjdChvYmouJGgsIHRoaXMuJGgpOwogICAgICB9CiAgICB9LAogICAgJGlzU2FtZU9iamVjdDogewogICAgICB2YWx1ZShvYmopIHsKICAgICAgICByZXR1cm4gdGhpc1tTeW1ib2wuZm9yKCJpc1NhbWVPYmplY3QiKV0ob2JqKTsKICAgICAgfQogICAgfSwKICAgIFtTeW1ib2wuZm9yKCJnZXRDdG9yIildOiB7CiAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICB2YWx1ZSh0eXBlKSB7CiAgICAgICAgY29uc3Qgc2xvdCA9IHRoaXMuJGM7CiAgICAgICAgbGV0IGN0b3IgPSBzbG90WzBdOwogICAgICAgIGlmIChjdG9yID09PSBudWxsKSB7CiAgICAgICAgICBjb25zdCBlbnYgPSB2bTIuZ2V0RW52KCk7CiAgICAgICAgICBjb25zdCBoID0gdGhpcy4kYm9ycm93Q2xhc3NIYW5kbGUoZW52KTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGN0b3IgPSBtYWtlQ29uc3RydWN0b3IoaC52YWx1ZSwgdGhpcy4kdywgZW52KTsKICAgICAgICAgICAgc2xvdFswXSA9IGN0b3I7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBoLnVucmVmKGVudik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBjdG9yW3R5cGVdOwogICAgICB9CiAgICB9LAogICAgJGdldEN0b3I6IHsKICAgICAgdmFsdWUodHlwZSkgewogICAgICAgIHJldHVybiB0aGlzW1N5bWJvbC5mb3IoImdldEN0b3IiKV0odHlwZSk7CiAgICAgIH0KICAgIH0sCiAgICBbU3ltYm9sLmZvcigiYm9ycm93Q2xhc3NIYW5kbGUiKV06IHsKICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgIHZhbHVlKGVudikgewogICAgICAgIGNvbnN0IGNsYXNzTmFtZSA9IHRoaXMuJG47CiAgICAgICAgY29uc3QgY2xhc3NIYW5kbGVzID0gdGhpcy4kZi5fY2xhc3NIYW5kbGVzOwogICAgICAgIGxldCBoYW5kbGUgPSBjbGFzc0hhbmRsZXMuZ2V0KGNsYXNzTmFtZSk7CiAgICAgICAgaWYgKGhhbmRsZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICBoYW5kbGUgPSBuZXcgQ2xhc3NIYW5kbGUodGhpcy4kZ2NoKGVudiksIGVudik7CiAgICAgICAgICBjbGFzc0hhbmRsZXMuc2V0KGNsYXNzTmFtZSwgaGFuZGxlLCBlbnYpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaGFuZGxlLnJlZigpOwogICAgICB9CiAgICB9LAogICAgJGJvcnJvd0NsYXNzSGFuZGxlOiB7CiAgICAgIHZhbHVlKGVudikgewogICAgICAgIHJldHVybiB0aGlzW1N5bWJvbC5mb3IoImJvcnJvd0NsYXNzSGFuZGxlIildKGVudik7CiAgICAgIH0KICAgIH0sCiAgICBbU3ltYm9sLmZvcigiY29weUNsYXNzSGFuZGxlIildOiB7CiAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICB2YWx1ZShlbnYpIHsKICAgICAgICBjb25zdCBoID0gdGhpcy4kYm9ycm93Q2xhc3NIYW5kbGUoZW52KTsKICAgICAgICB0cnkgewogICAgICAgICAgcmV0dXJuIGVudi5uZXdMb2NhbFJlZihoLnZhbHVlKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaC51bnJlZihlbnYpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICRjb3B5Q2xhc3NIYW5kbGU6IHsKICAgICAgdmFsdWUoZW52KSB7CiAgICAgICAgcmV0dXJuIHRoaXNbU3ltYm9sLmZvcigiY29weUNsYXNzSGFuZGxlIildKGVudik7CiAgICAgIH0KICAgIH0sCiAgICBbU3ltYm9sLmZvcigiZ2V0SGFuZGxlIildOiB7CiAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICB2YWx1ZShlbnYpIHsKICAgICAgICBjb25zdCBoYW5kbGUgPSB0aGlzLiRoOwogICAgICAgIGNvbnN0IGlzRGlzcG9zZWQgPSBoYW5kbGUgPT09IHZvaWQgMDsKICAgICAgICBpZiAoaXNEaXNwb3NlZCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJXcmFwcGVyIGlzIGRpc3Bvc2VkOyBwZXJoYXBzIGl0IHdhcyBib3Jyb3dlZCBmcm9tIGEgaG9vayBpbnN0ZWFkIG9mIGNhbGxpbmcgSmF2YS5yZXRhaW4oKSB0byBtYWtlIGEgbG9uZy1saXZlZCB3cmFwcGVyPyIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaGFuZGxlOwogICAgICB9CiAgICB9LAogICAgJGdldEhhbmRsZTogewogICAgICB2YWx1ZShlbnYpIHsKICAgICAgICByZXR1cm4gdGhpc1tTeW1ib2wuZm9yKCJnZXRIYW5kbGUiKV0oZW52KTsKICAgICAgfQogICAgfSwKICAgIFtTeW1ib2wuZm9yKCJsaXN0IildOiB7CiAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICB2YWx1ZSgpIHsKICAgICAgICBjb25zdCBzdXBlcldyYXBwZXIgPSB0aGlzLiRzOwogICAgICAgIGNvbnN0IHN1cGVyTWVtYmVycyA9IHN1cGVyV3JhcHBlciAhPT0gbnVsbCA/IHN1cGVyV3JhcHBlci4kbGlzdCgpIDogW107CiAgICAgICAgY29uc3QgbW9kZWwgPSB0aGlzLiRsOwogICAgICAgIHJldHVybiBBcnJheS5mcm9tKG5ldyBTZXQoc3VwZXJNZW1iZXJzLmNvbmNhdChtb2RlbC5saXN0KCkpKSk7CiAgICAgIH0KICAgIH0sCiAgICAkbGlzdDogewogICAgICBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXNbU3ltYm9sLmZvcigibGlzdCIpXTsKICAgICAgfQogICAgfSwKICAgIFtTeW1ib2wuZm9yKCJoYXMiKV06IHsKICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgIHZhbHVlKG1lbWJlcikgewogICAgICAgIGNvbnN0IG1lbWJlcnMgPSB0aGlzLiRtOwogICAgICAgIGlmIChtZW1iZXJzLmhhcyhtZW1iZXIpKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbW9kZWwgPSB0aGlzLiRsOwogICAgICAgIGlmIChtb2RlbC5oYXMobWVtYmVyKSkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN1cGVyV3JhcHBlciA9IHRoaXMuJHM7CiAgICAgICAgaWYgKHN1cGVyV3JhcHBlciAhPT0gbnVsbCAmJiBzdXBlcldyYXBwZXIuJGhhcyhtZW1iZXIpKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9LAogICAgJGhhczogewogICAgICB2YWx1ZShtZW1iZXIpIHsKICAgICAgICByZXR1cm4gdGhpc1tTeW1ib2wuZm9yKCJoYXMiKV0obWVtYmVyKTsKICAgICAgfQogICAgfSwKICAgIFtTeW1ib2wuZm9yKCJmaW5kIildOiB7CiAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICB2YWx1ZShtZW1iZXIpIHsKICAgICAgICBjb25zdCBtZW1iZXJzID0gdGhpcy4kbTsKICAgICAgICBsZXQgdmFsdWUgPSBtZW1iZXJzLmdldChtZW1iZXIpOwogICAgICAgIGlmICh2YWx1ZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG1vZGVsID0gdGhpcy4kbDsKICAgICAgICBjb25zdCBzcGVjID0gbW9kZWwuZmluZChtZW1iZXIpOwogICAgICAgIGlmIChzcGVjICE9PSBudWxsKSB7CiAgICAgICAgICBjb25zdCBlbnYgPSB2bTIuZ2V0RW52KCk7CiAgICAgICAgICBjb25zdCBoID0gdGhpcy4kYm9ycm93Q2xhc3NIYW5kbGUoZW52KTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhbHVlID0gbWFrZU1lbWJlcihtZW1iZXIsIHNwZWMsIGgudmFsdWUsIHRoaXMuJHcsIGVudik7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBoLnVucmVmKGVudik7CiAgICAgICAgICB9CiAgICAgICAgICBtZW1iZXJzLnNldChtZW1iZXIsIHZhbHVlKTsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc3VwZXJXcmFwcGVyID0gdGhpcy4kczsKICAgICAgICBpZiAoc3VwZXJXcmFwcGVyICE9PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gc3VwZXJXcmFwcGVyLiRmaW5kKG1lbWJlcik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICB9LAogICAgJGZpbmQ6IHsKICAgICAgdmFsdWUobWVtYmVyKSB7CiAgICAgICAgcmV0dXJuIHRoaXNbU3ltYm9sLmZvcigiZmluZCIpXShtZW1iZXIpOwogICAgICB9CiAgICB9LAogICAgW1N5bWJvbC5mb3IoInRvSlNPTiIpXTogewogICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgdmFsdWUoKSB7CiAgICAgICAgY29uc3Qgd3JhcHBlck5hbWUgPSB0aGlzLiRuOwogICAgICAgIGNvbnN0IGhhbmRsZSA9IHRoaXMuJGg7CiAgICAgICAgaWYgKGhhbmRsZSA9PT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIGA8Y2xhc3M6ICR7d3JhcHBlck5hbWV9PmA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGFjdHVhbE5hbWUgPSB0aGlzLiRjbGFzc05hbWU7CiAgICAgICAgaWYgKHdyYXBwZXJOYW1lID09PSBhY3R1YWxOYW1lKSB7CiAgICAgICAgICByZXR1cm4gYDxpbnN0YW5jZTogJHt3cmFwcGVyTmFtZX0+YDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGA8aW5zdGFuY2U6ICR7d3JhcHBlck5hbWV9LCAkY2xhc3NOYW1lOiAke2FjdHVhbE5hbWV9PmA7CiAgICAgIH0KICAgIH0sCiAgICB0b0pTT046IHsKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzW1N5bWJvbC5mb3IoInRvSlNPTiIpXTsKICAgICAgfQogICAgfQogIH0pOwogIGZ1bmN0aW9uIENsYXNzSGFuZGxlKHZhbHVlLCBlbnYpIHsKICAgIHRoaXMudmFsdWUgPSBlbnYubmV3R2xvYmFsUmVmKHZhbHVlKTsKICAgIGVudi5kZWxldGVMb2NhbFJlZih2YWx1ZSk7CiAgICB0aGlzLnJlZnMgPSAxOwogIH0KICBDbGFzc0hhbmRsZS5wcm90b3R5cGUucmVmID0gZnVuY3Rpb24oKSB7CiAgICB0aGlzLnJlZnMrKzsKICAgIHJldHVybiB0aGlzOwogIH07CiAgQ2xhc3NIYW5kbGUucHJvdG90eXBlLnVucmVmID0gZnVuY3Rpb24oZW52KSB7CiAgICBpZiAoLS10aGlzLnJlZnMgPT09IDApIHsKICAgICAgZW52LmRlbGV0ZUdsb2JhbFJlZih0aGlzLnZhbHVlKTsKICAgIH0KICB9OwogIGZ1bmN0aW9uIHJlbGVhc2VDbGFzc0hhbmRsZShoYW5kbGUsIGVudikgewogICAgaGFuZGxlLnVucmVmKGVudik7CiAgfQogIGZ1bmN0aW9uIG1ha2VCYXNpY0NsYXNzSGFuZGxlR2V0dGVyKGNsYXNzTmFtZSkgewogICAgY29uc3QgY2Fub25pY2FsQ2xhc3NOYW1lID0gY2xhc3NOYW1lLnJlcGxhY2UoL1wuL2csICIvIik7CiAgICByZXR1cm4gZnVuY3Rpb24oZW52KSB7CiAgICAgIGNvbnN0IHRpZCA9IGdldEN1cnJlbnRUaHJlYWRJZCgpOwogICAgICBpZ25vcmUodGlkKTsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gZW52LmZpbmRDbGFzcyhjYW5vbmljYWxDbGFzc05hbWUpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHVuaWdub3JlKHRpZCk7CiAgICAgIH0KICAgIH07CiAgfQogIGZ1bmN0aW9uIG1ha2VMb2FkZXJDbGFzc0hhbmRsZUdldHRlcihjbGFzc05hbWUsIHVzZWRMb2FkZXIsIGNhbGxlckVudikgewogICAgaWYgKGNhY2hlZExvYWRlck1ldGhvZCA9PT0gbnVsbCkgewogICAgICBjYWNoZWRMb2FkZXJJbnZva2UgPSBjYWxsZXJFbnYudmFNZXRob2QoInBvaW50ZXIiLCBbInBvaW50ZXIiXSk7CiAgICAgIGNhY2hlZExvYWRlck1ldGhvZCA9IHVzZWRMb2FkZXIubG9hZENsYXNzLm92ZXJsb2FkKCJqYXZhLmxhbmcuU3RyaW5nIikuaGFuZGxlOwogICAgfQogICAgY2FsbGVyRW52ID0gbnVsbDsKICAgIHJldHVybiBmdW5jdGlvbihlbnYpIHsKICAgICAgY29uc3QgY2xhc3NOYW1lVmFsdWUgPSBlbnYubmV3U3RyaW5nVXRmKGNsYXNzTmFtZSk7CiAgICAgIGNvbnN0IHRpZCA9IGdldEN1cnJlbnRUaHJlYWRJZCgpOwogICAgICBpZ25vcmUodGlkKTsKICAgICAgdHJ5IHsKICAgICAgICBjb25zdCByZXN1bHQgPSBjYWNoZWRMb2FkZXJJbnZva2UoZW52LmhhbmRsZSwgdXNlZExvYWRlci4kaCwgY2FjaGVkTG9hZGVyTWV0aG9kLCBjbGFzc05hbWVWYWx1ZSk7CiAgICAgICAgZW52LnRocm93SWZFeGNlcHRpb25QZW5kaW5nKCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICB1bmlnbm9yZSh0aWQpOwogICAgICAgIGVudi5kZWxldGVMb2NhbFJlZihjbGFzc05hbWVWYWx1ZSk7CiAgICAgIH0KICAgIH07CiAgfQogIGZ1bmN0aW9uIG1ha2VTdXBlckhhbmRsZUdldHRlcihjbGFzc1dyYXBwZXIpIHsKICAgIHJldHVybiBmdW5jdGlvbihlbnYpIHsKICAgICAgY29uc3QgaCA9IGNsYXNzV3JhcHBlci4kYm9ycm93Q2xhc3NIYW5kbGUoZW52KTsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gZW52LmdldFN1cGVyY2xhc3MoaC52YWx1ZSk7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgaC51bnJlZihlbnYpOwogICAgICB9CiAgICB9OwogIH0KICBmdW5jdGlvbiBtYWtlQ29uc3RydWN0b3IoY2xhc3NIYW5kbGUsIGNsYXNzV3JhcHBlciwgZW52KSB7CiAgICBjb25zdCB7ICRuOiBjbGFzc05hbWUsICRmOiBmYWN0b3J5IH0gPSBjbGFzc1dyYXBwZXI7CiAgICBjb25zdCBtZXRob2ROYW1lID0gYmFzZW5hbWUoY2xhc3NOYW1lKTsKICAgIGNvbnN0IENsYXNzID0gZW52LmphdmFMYW5nQ2xhc3MoKTsKICAgIGNvbnN0IENvbnN0cnVjdG9yID0gZW52LmphdmFMYW5nUmVmbGVjdENvbnN0cnVjdG9yKCk7CiAgICBjb25zdCBpbnZva2VPYmplY3RNZXRob2ROb0FyZ3MgPSBlbnYudmFNZXRob2QoInBvaW50ZXIiLCBbXSk7CiAgICBjb25zdCBpbnZva2VVSW50OE1ldGhvZE5vQXJncyA9IGVudi52YU1ldGhvZCgidWludDgiLCBbXSk7CiAgICBjb25zdCBqc0N0b3JNZXRob2RzID0gW107CiAgICBjb25zdCBqc0luaXRNZXRob2RzID0gW107CiAgICBjb25zdCBqc1JldFR5cGUgPSBmYWN0b3J5Ll9nZXRUeXBlKGNsYXNzTmFtZSwgZmFsc2UpOwogICAgY29uc3QganNWb2lkVHlwZSA9IGZhY3RvcnkuX2dldFR5cGUoInZvaWQiLCBmYWxzZSk7CiAgICBjb25zdCBjb25zdHJ1Y3RvcnMgPSBpbnZva2VPYmplY3RNZXRob2ROb0FyZ3MoZW52LmhhbmRsZSwgY2xhc3NIYW5kbGUsIENsYXNzLmdldERlY2xhcmVkQ29uc3RydWN0b3JzKTsKICAgIHRyeSB7CiAgICAgIGNvbnN0IG4gPSBlbnYuZ2V0QXJyYXlMZW5ndGgoY29uc3RydWN0b3JzKTsKICAgICAgaWYgKG4gIT09IDApIHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gbjsgaSsrKSB7CiAgICAgICAgICBsZXQgbWV0aG9kSWQsIHR5cGVzOwogICAgICAgICAgY29uc3QgY29uc3RydWN0b3IgPSBlbnYuZ2V0T2JqZWN0QXJyYXlFbGVtZW50KGNvbnN0cnVjdG9ycywgaSk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBtZXRob2RJZCA9IGVudi5mcm9tUmVmbGVjdGVkTWV0aG9kKGNvbnN0cnVjdG9yKTsKICAgICAgICAgICAgdHlwZXMgPSBpbnZva2VPYmplY3RNZXRob2ROb0FyZ3MoZW52LmhhbmRsZSwgY29uc3RydWN0b3IsIENvbnN0cnVjdG9yLmdldEdlbmVyaWNQYXJhbWV0ZXJUeXBlcyk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBlbnYuZGVsZXRlTG9jYWxSZWYoY29uc3RydWN0b3IpOwogICAgICAgICAgfQogICAgICAgICAgbGV0IGpzQXJnVHlwZXM7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBqc0FyZ1R5cGVzID0gcmVhZFR5cGVOYW1lcyhlbnYsIHR5cGVzKS5tYXAoKG5hbWUpID0+IGZhY3RvcnkuX2dldFR5cGUobmFtZSkpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgZW52LmRlbGV0ZUxvY2FsUmVmKHR5cGVzKTsKICAgICAgICAgIH0KICAgICAgICAgIGpzQ3Rvck1ldGhvZHMucHVzaChtYWtlTWV0aG9kKG1ldGhvZE5hbWUsIGNsYXNzV3JhcHBlciwgQ09OU1RSVUNUT1JfTUVUSE9ELCBtZXRob2RJZCwganNSZXRUeXBlLCBqc0FyZ1R5cGVzLCBlbnYpKTsKICAgICAgICAgIGpzSW5pdE1ldGhvZHMucHVzaChtYWtlTWV0aG9kKG1ldGhvZE5hbWUsIGNsYXNzV3JhcHBlciwgSU5TVEFOQ0VfTUVUSE9ELCBtZXRob2RJZCwganNWb2lkVHlwZSwganNBcmdUeXBlcywgZW52KSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGlzSW50ZXJmYWNlID0gaW52b2tlVUludDhNZXRob2ROb0FyZ3MoZW52LmhhbmRsZSwgY2xhc3NIYW5kbGUsIENsYXNzLmlzSW50ZXJmYWNlKTsKICAgICAgICBpZiAoaXNJbnRlcmZhY2UpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiY2Fubm90IGluc3RhbnRpYXRlIGFuIGludGVyZmFjZSIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBkZWZhdWx0Q2xhc3MgPSBlbnYuamF2YUxhbmdPYmplY3QoKTsKICAgICAgICBjb25zdCBkZWZhdWx0Q29uc3RydWN0b3IgPSBlbnYuZ2V0TWV0aG9kSWQoZGVmYXVsdENsYXNzLCAiPGluaXQ+IiwgIigpViIpOwogICAgICAgIGpzQ3Rvck1ldGhvZHMucHVzaChtYWtlTWV0aG9kKG1ldGhvZE5hbWUsIGNsYXNzV3JhcHBlciwgQ09OU1RSVUNUT1JfTUVUSE9ELCBkZWZhdWx0Q29uc3RydWN0b3IsIGpzUmV0VHlwZSwgW10sIGVudikpOwogICAgICAgIGpzSW5pdE1ldGhvZHMucHVzaChtYWtlTWV0aG9kKG1ldGhvZE5hbWUsIGNsYXNzV3JhcHBlciwgSU5TVEFOQ0VfTUVUSE9ELCBkZWZhdWx0Q29uc3RydWN0b3IsIGpzVm9pZFR5cGUsIFtdLCBlbnYpKTsKICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgZW52LmRlbGV0ZUxvY2FsUmVmKGNvbnN0cnVjdG9ycyk7CiAgICB9CiAgICBpZiAoanNJbml0TWV0aG9kcy5sZW5ndGggPT09IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJubyBzdXBwb3J0ZWQgb3ZlcmxvYWRzIik7CiAgICB9CiAgICByZXR1cm4gewogICAgICBhbGxvY0FuZEluaXQ6IG1ha2VNZXRob2REaXNwYXRjaGVyKGpzQ3Rvck1ldGhvZHMpLAogICAgICBpbml0T25seTogbWFrZU1ldGhvZERpc3BhdGNoZXIoanNJbml0TWV0aG9kcykKICAgIH07CiAgfQogIGZ1bmN0aW9uIG1ha2VNZW1iZXIobmFtZSwgc3BlYywgY2xhc3NIYW5kbGUsIGNsYXNzV3JhcHBlciwgZW52KSB7CiAgICBpZiAoc3BlYy5zdGFydHNXaXRoKCJtIikpIHsKICAgICAgcmV0dXJuIG1ha2VNZXRob2RGcm9tU3BlYyhuYW1lLCBzcGVjLCBjbGFzc0hhbmRsZSwgY2xhc3NXcmFwcGVyLCBlbnYpOwogICAgfQogICAgcmV0dXJuIG1ha2VGaWVsZEZyb21TcGVjKG5hbWUsIHNwZWMsIGNsYXNzSGFuZGxlLCBjbGFzc1dyYXBwZXIsIGVudik7CiAgfQogIGZ1bmN0aW9uIG1ha2VNZXRob2RGcm9tU3BlYyhuYW1lLCBzcGVjLCBjbGFzc0hhbmRsZSwgY2xhc3NXcmFwcGVyLCBlbnYpIHsKICAgIGNvbnN0IHsgJGY6IGZhY3RvcnkgfSA9IGNsYXNzV3JhcHBlcjsKICAgIGNvbnN0IG92ZXJsb2FkcyA9IHNwZWMuc3BsaXQoIjoiKS5zbGljZSgxKTsKICAgIGNvbnN0IE1ldGhvZCA9IGVudi5qYXZhTGFuZ1JlZmxlY3RNZXRob2QoKTsKICAgIGNvbnN0IGludm9rZU9iamVjdE1ldGhvZE5vQXJncyA9IGVudi52YU1ldGhvZCgicG9pbnRlciIsIFtdKTsKICAgIGNvbnN0IGludm9rZVVJbnQ4TWV0aG9kTm9BcmdzID0gZW52LnZhTWV0aG9kKCJ1aW50OCIsIFtdKTsKICAgIGNvbnN0IG1ldGhvZHMgPSBvdmVybG9hZHMubWFwKChwYXJhbXMpID0+IHsKICAgICAgY29uc3QgdHlwZSA9IHBhcmFtc1swXSA9PT0gInMiID8gU1RBVElDX01FVEhPRCA6IElOU1RBTkNFX01FVEhPRDsKICAgICAgY29uc3QgbWV0aG9kSWQgPSBwdHIocGFyYW1zLnN1YnN0cigxKSk7CiAgICAgIGxldCBqc1JldFR5cGU7CiAgICAgIGNvbnN0IGpzQXJnVHlwZXMgPSBbXTsKICAgICAgY29uc3QgaGFuZGxlID0gZW52LnRvUmVmbGVjdGVkTWV0aG9kKGNsYXNzSGFuZGxlLCBtZXRob2RJZCwgdHlwZSA9PT0gU1RBVElDX01FVEhPRCA/IDEgOiAwKTsKICAgICAgdHJ5IHsKICAgICAgICBjb25zdCBpc1ZhckFyZ3MgPSAhIWludm9rZVVJbnQ4TWV0aG9kTm9BcmdzKGVudi5oYW5kbGUsIGhhbmRsZSwgTWV0aG9kLmlzVmFyQXJncyk7CiAgICAgICAgY29uc3QgcmV0VHlwZSA9IGludm9rZU9iamVjdE1ldGhvZE5vQXJncyhlbnYuaGFuZGxlLCBoYW5kbGUsIE1ldGhvZC5nZXRHZW5lcmljUmV0dXJuVHlwZSk7CiAgICAgICAgZW52LnRocm93SWZFeGNlcHRpb25QZW5kaW5nKCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGpzUmV0VHlwZSA9IGZhY3RvcnkuX2dldFR5cGUoZW52LmdldFR5cGVOYW1lKHJldFR5cGUpKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgZW52LmRlbGV0ZUxvY2FsUmVmKHJldFR5cGUpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhcmdUeXBlcyA9IGludm9rZU9iamVjdE1ldGhvZE5vQXJncyhlbnYuaGFuZGxlLCBoYW5kbGUsIE1ldGhvZC5nZXRQYXJhbWV0ZXJUeXBlcyk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbnN0IG4gPSBlbnYuZ2V0QXJyYXlMZW5ndGgoYXJnVHlwZXMpOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IG47IGkrKykgewogICAgICAgICAgICBjb25zdCB0ID0gZW52LmdldE9iamVjdEFycmF5RWxlbWVudChhcmdUeXBlcywgaSk7CiAgICAgICAgICAgIGxldCBhcmdDbGFzc05hbWU7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgYXJnQ2xhc3NOYW1lID0gaXNWYXJBcmdzICYmIGkgPT09IG4gLSAxID8gZW52LmdldEFycmF5VHlwZU5hbWUodCkgOiBlbnYuZ2V0VHlwZU5hbWUodCk7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgZW52LmRlbGV0ZUxvY2FsUmVmKHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGFyZ1R5cGUgPSBmYWN0b3J5Ll9nZXRUeXBlKGFyZ0NsYXNzTmFtZSk7CiAgICAgICAgICAgIGpzQXJnVHlwZXMucHVzaChhcmdUeXBlKTsKICAgICAgICAgIH0KICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgZW52LmRlbGV0ZUxvY2FsUmVmKGFyZ1R5cGVzKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBlbnYuZGVsZXRlTG9jYWxSZWYoaGFuZGxlKTsKICAgICAgfQogICAgICByZXR1cm4gbWFrZU1ldGhvZChuYW1lLCBjbGFzc1dyYXBwZXIsIHR5cGUsIG1ldGhvZElkLCBqc1JldFR5cGUsIGpzQXJnVHlwZXMsIGVudik7CiAgICB9KS5maWx0ZXIoKG0pID0+IG0gIT09IG51bGwpOwogICAgaWYgKG1ldGhvZHMubGVuZ3RoID09PSAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiTm8gc3VwcG9ydGVkIG92ZXJsb2FkcyIpOwogICAgfQogICAgaWYgKG5hbWUgPT09ICJ2YWx1ZU9mIikgewogICAgICBlbnN1cmVEZWZhdWx0VmFsdWVPZkltcGxlbWVudGVkKG1ldGhvZHMpOwogICAgfQogICAgY29uc3QgcmVzdWx0ID0gbWFrZU1ldGhvZERpc3BhdGNoZXIobWV0aG9kcyk7CiAgICByZXR1cm4gZnVuY3Rpb24ocmVjZWl2ZXIpIHsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfQogIGZ1bmN0aW9uIG1ha2VNZXRob2REaXNwYXRjaGVyKG92ZXJsb2FkcykgewogICAgY29uc3QgbSA9IG1ha2VNZXRob2REaXNwYXRjaGVyQ2FsbGFibGUoKTsKICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZihtLCBkaXNwYXRjaGVyUHJvdG90eXBlKTsKICAgIG0uX28gPSBvdmVybG9hZHM7CiAgICByZXR1cm4gbTsKICB9CiAgZnVuY3Rpb24gbWFrZU1ldGhvZERpc3BhdGNoZXJDYWxsYWJsZSgpIHsKICAgIGNvbnN0IG0gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG0uaW52b2tlKHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9OwogICAgcmV0dXJuIG07CiAgfQogIGRpc3BhdGNoZXJQcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEZ1bmN0aW9uLnByb3RvdHlwZSwgewogICAgb3ZlcmxvYWRzOiB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fbzsKICAgICAgfQogICAgfSwKICAgIG92ZXJsb2FkOiB7CiAgICAgIHZhbHVlKC4uLmFyZ3MpIHsKICAgICAgICBjb25zdCBvdmVybG9hZHMgPSB0aGlzLl9vOwogICAgICAgIGNvbnN0IG51bUFyZ3MgPSBhcmdzLmxlbmd0aDsKICAgICAgICBjb25zdCBzaWduYXR1cmUgPSBhcmdzLmpvaW4oIjoiKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gb3ZlcmxvYWRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBtZXRob2QgPSBvdmVybG9hZHNbaV07CiAgICAgICAgICBjb25zdCB7IGFyZ3VtZW50VHlwZXMgfSA9IG1ldGhvZDsKICAgICAgICAgIGlmIChhcmd1bWVudFR5cGVzLmxlbmd0aCAhPT0gbnVtQXJncykgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHMgPSBhcmd1bWVudFR5cGVzLm1hcCgodCkgPT4gdC5jbGFzc05hbWUpLmpvaW4oIjoiKTsKICAgICAgICAgIGlmIChzID09PSBzaWduYXR1cmUpIHsKICAgICAgICAgICAgcmV0dXJuIG1ldGhvZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhyb3dPdmVybG9hZEVycm9yKHRoaXMubWV0aG9kTmFtZSwgdGhpcy5vdmVybG9hZHMsICJzcGVjaWZpZWQgYXJndW1lbnQgdHlwZXMgZG8gbm90IG1hdGNoIGFueSBvZjoiKTsKICAgICAgfQogICAgfSwKICAgIG1ldGhvZE5hbWU6IHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLl9vWzBdLm1ldGhvZE5hbWU7CiAgICAgIH0KICAgIH0sCiAgICBob2xkZXI6IHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLl9vWzBdLmhvbGRlcjsKICAgICAgfQogICAgfSwKICAgIHR5cGU6IHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLl9vWzBdLnR5cGU7CiAgICAgIH0KICAgIH0sCiAgICBoYW5kbGU6IHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgZ2V0KCkgewogICAgICAgIHRocm93SWZEaXNwYXRjaGVyQW1iaWd1b3VzKHRoaXMpOwogICAgICAgIHJldHVybiB0aGlzLl9vWzBdLmhhbmRsZTsKICAgICAgfQogICAgfSwKICAgIGltcGxlbWVudGF0aW9uOiB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIGdldCgpIHsKICAgICAgICB0aHJvd0lmRGlzcGF0Y2hlckFtYmlndW91cyh0aGlzKTsKICAgICAgICByZXR1cm4gdGhpcy5fb1swXS5pbXBsZW1lbnRhdGlvbjsKICAgICAgfSwKICAgICAgc2V0KGZuKSB7CiAgICAgICAgdGhyb3dJZkRpc3BhdGNoZXJBbWJpZ3VvdXModGhpcyk7CiAgICAgICAgdGhpcy5fb1swXS5pbXBsZW1lbnRhdGlvbiA9IGZuOwogICAgICB9CiAgICB9LAogICAgcmV0dXJuVHlwZTogewogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBnZXQoKSB7CiAgICAgICAgdGhyb3dJZkRpc3BhdGNoZXJBbWJpZ3VvdXModGhpcyk7CiAgICAgICAgcmV0dXJuIHRoaXMuX29bMF0ucmV0dXJuVHlwZTsKICAgICAgfQogICAgfSwKICAgIGFyZ3VtZW50VHlwZXM6IHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgZ2V0KCkgewogICAgICAgIHRocm93SWZEaXNwYXRjaGVyQW1iaWd1b3VzKHRoaXMpOwogICAgICAgIHJldHVybiB0aGlzLl9vWzBdLmFyZ3VtZW50VHlwZXM7CiAgICAgIH0KICAgIH0sCiAgICBjYW5JbnZva2VXaXRoOiB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIGdldChhcmdzKSB7CiAgICAgICAgdGhyb3dJZkRpc3BhdGNoZXJBbWJpZ3VvdXModGhpcyk7CiAgICAgICAgcmV0dXJuIHRoaXMuX29bMF0uY2FuSW52b2tlV2l0aDsKICAgICAgfQogICAgfSwKICAgIGNsb25lOiB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIHZhbHVlKG9wdGlvbnMpIHsKICAgICAgICB0aHJvd0lmRGlzcGF0Y2hlckFtYmlndW91cyh0aGlzKTsKICAgICAgICByZXR1cm4gdGhpcy5fb1swXS5jbG9uZShvcHRpb25zKTsKICAgICAgfQogICAgfSwKICAgIGludm9rZTogewogICAgICB2YWx1ZShyZWNlaXZlciwgYXJncykgewogICAgICAgIGNvbnN0IG92ZXJsb2FkcyA9IHRoaXMuX287CiAgICAgICAgY29uc3QgaXNJbnN0YW5jZSA9IHJlY2VpdmVyLiRoICE9PSBudWxsOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBvdmVybG9hZHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IG1ldGhvZCA9IG92ZXJsb2Fkc1tpXTsKICAgICAgICAgIGlmICghbWV0aG9kLmNhbkludm9rZVdpdGgoYXJncykpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobWV0aG9kLnR5cGUgPT09IElOU1RBTkNFX01FVEhPRCAmJiAhaXNJbnN0YW5jZSkgewogICAgICAgICAgICBjb25zdCBuYW1lID0gdGhpcy5tZXRob2ROYW1lOwogICAgICAgICAgICBpZiAobmFtZSA9PT0gInRvU3RyaW5nIikgewogICAgICAgICAgICAgIHJldHVybiBgPGNsYXNzOiAke3JlY2VpdmVyLiRufT5gOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihuYW1lICsgIjogY2Fubm90IGNhbGwgaW5zdGFuY2UgbWV0aG9kIHdpdGhvdXQgYW4gaW5zdGFuY2UiKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtZXRob2QuYXBwbHkocmVjZWl2ZXIsIGFyZ3MpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5tZXRob2ROYW1lID09PSAidG9TdHJpbmciKSB7CiAgICAgICAgICByZXR1cm4gYDxjbGFzczogJHtyZWNlaXZlci4kbn0+YDsKICAgICAgICB9CiAgICAgICAgdGhyb3dPdmVybG9hZEVycm9yKHRoaXMubWV0aG9kTmFtZSwgdGhpcy5vdmVybG9hZHMsICJhcmd1bWVudCB0eXBlcyBkbyBub3QgbWF0Y2ggYW55IG9mOiIpOwogICAgICB9CiAgICB9CiAgfSk7CiAgZnVuY3Rpb24gbWFrZU92ZXJsb2FkSWQobmFtZSwgcmV0dXJuVHlwZSwgYXJndW1lbnRUeXBlcykgewogICAgcmV0dXJuIGAke3JldHVyblR5cGUuY2xhc3NOYW1lfSAke25hbWV9KCR7YXJndW1lbnRUeXBlcy5tYXAoKHQpID0+IHQuY2xhc3NOYW1lKS5qb2luKCIsICIpfSlgOwogIH0KICBmdW5jdGlvbiB0aHJvd0lmRGlzcGF0Y2hlckFtYmlndW91cyhkaXNwYXRjaGVyKSB7CiAgICBjb25zdCBtZXRob2RzID0gZGlzcGF0Y2hlci5fbzsKICAgIGlmIChtZXRob2RzLmxlbmd0aCA+IDEpIHsKICAgICAgdGhyb3dPdmVybG9hZEVycm9yKG1ldGhvZHNbMF0ubWV0aG9kTmFtZSwgbWV0aG9kcywgImhhcyBtb3JlIHRoYW4gb25lIG92ZXJsb2FkLCB1c2UgLm92ZXJsb2FkKDxzaWduYXR1cmU+KSB0byBjaG9vc2UgZnJvbToiKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gdGhyb3dPdmVybG9hZEVycm9yKG5hbWUsIG1ldGhvZHMsIG1lc3NhZ2UpIHsKICAgIGNvbnN0IG1ldGhvZHNTb3J0ZWRCeUFyaXR5ID0gbWV0aG9kcy5zbGljZSgpLnNvcnQoKGEsIGIpID0+IGEuYXJndW1lbnRUeXBlcy5sZW5ndGggLSBiLmFyZ3VtZW50VHlwZXMubGVuZ3RoKTsKICAgIGNvbnN0IG92ZXJsb2FkcyA9IG1ldGhvZHNTb3J0ZWRCeUFyaXR5Lm1hcCgobSkgPT4gewogICAgICBjb25zdCBhcmdUeXBlcyA9IG0uYXJndW1lbnRUeXBlczsKICAgICAgaWYgKGFyZ1R5cGVzLmxlbmd0aCA+IDApIHsKICAgICAgICByZXR1cm4gIi5vdmVybG9hZCgnIiArIG0uYXJndW1lbnRUeXBlcy5tYXAoKHQpID0+IHQuY2xhc3NOYW1lKS5qb2luKCInLCAnIikgKyAiJykiOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiAiLm92ZXJsb2FkKCkiOwogICAgICB9CiAgICB9KTsKICAgIHRocm93IG5ldyBFcnJvcihgJHtuYW1lfSgpOiAke21lc3NhZ2V9Cgkke292ZXJsb2Fkcy5qb2luKCJcbgkiKX1gKTsKICB9CiAgZnVuY3Rpb24gbWFrZU1ldGhvZChtZXRob2ROYW1lLCBjbGFzc1dyYXBwZXIsIHR5cGUsIG1ldGhvZElkLCByZXRUeXBlLCBhcmdUeXBlcywgZW52LCBpbnZvY2F0aW9uT3B0aW9ucykgewogICAgY29uc3QgcmF3UmV0VHlwZSA9IHJldFR5cGUudHlwZTsKICAgIGNvbnN0IHJhd0FyZ1R5cGVzID0gYXJnVHlwZXMubWFwKCh0KSA9PiB0LnR5cGUpOwogICAgaWYgKGVudiA9PT0gbnVsbCkgewogICAgICBlbnYgPSB2bTIuZ2V0RW52KCk7CiAgICB9CiAgICBsZXQgY2FsbFZpcnR1YWxseSwgY2FsbERpcmVjdGx5OwogICAgaWYgKHR5cGUgPT09IElOU1RBTkNFX01FVEhPRCkgewogICAgICBjYWxsVmlydHVhbGx5ID0gZW52LnZhTWV0aG9kKHJhd1JldFR5cGUsIHJhd0FyZ1R5cGVzLCBpbnZvY2F0aW9uT3B0aW9ucyk7CiAgICAgIGNhbGxEaXJlY3RseSA9IGVudi5ub252aXJ0dWFsVmFNZXRob2QocmF3UmV0VHlwZSwgcmF3QXJnVHlwZXMsIGludm9jYXRpb25PcHRpb25zKTsKICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gU1RBVElDX01FVEhPRCkgewogICAgICBjYWxsVmlydHVhbGx5ID0gZW52LnN0YXRpY1ZhTWV0aG9kKHJhd1JldFR5cGUsIHJhd0FyZ1R5cGVzLCBpbnZvY2F0aW9uT3B0aW9ucyk7CiAgICAgIGNhbGxEaXJlY3RseSA9IGNhbGxWaXJ0dWFsbHk7CiAgICB9IGVsc2UgewogICAgICBjYWxsVmlydHVhbGx5ID0gZW52LmNvbnN0cnVjdG9yKHJhd0FyZ1R5cGVzLCBpbnZvY2F0aW9uT3B0aW9ucyk7CiAgICAgIGNhbGxEaXJlY3RseSA9IGNhbGxWaXJ0dWFsbHk7CiAgICB9CiAgICByZXR1cm4gbWFrZU1ldGhvZEluc3RhbmNlKFttZXRob2ROYW1lLCBjbGFzc1dyYXBwZXIsIHR5cGUsIG1ldGhvZElkLCByZXRUeXBlLCBhcmdUeXBlcywgY2FsbFZpcnR1YWxseSwgY2FsbERpcmVjdGx5XSk7CiAgfQogIGZ1bmN0aW9uIG1ha2VNZXRob2RJbnN0YW5jZShwYXJhbXMpIHsKICAgIGNvbnN0IG0gPSBtYWtlTWV0aG9kQ2FsbGFibGUoKTsKICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZihtLCBtZXRob2RQcm90b3R5cGUpOwogICAgbS5fcCA9IHBhcmFtczsKICAgIHJldHVybiBtOwogIH0KICBmdW5jdGlvbiBtYWtlTWV0aG9kQ2FsbGFibGUoKSB7CiAgICBjb25zdCBtID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBtLmludm9rZSh0aGlzLCBhcmd1bWVudHMpOwogICAgfTsKICAgIHJldHVybiBtOwogIH0KICBtZXRob2RQcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEZ1bmN0aW9uLnByb3RvdHlwZSwgewogICAgbWV0aG9kTmFtZTogewogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3BbMF07CiAgICAgIH0KICAgIH0sCiAgICBob2xkZXI6IHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLl9wWzFdOwogICAgICB9CiAgICB9LAogICAgdHlwZTogewogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3BbMl07CiAgICAgIH0KICAgIH0sCiAgICBoYW5kbGU6IHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLl9wWzNdOwogICAgICB9CiAgICB9LAogICAgaW1wbGVtZW50YXRpb246IHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgZ2V0KCkgewogICAgICAgIGNvbnN0IHJlcGxhY2VtZW50ID0gdGhpcy5fcjsKICAgICAgICByZXR1cm4gcmVwbGFjZW1lbnQgIT09IHZvaWQgMCA/IHJlcGxhY2VtZW50IDogbnVsbDsKICAgICAgfSwKICAgICAgc2V0KGZuKSB7CiAgICAgICAgY29uc3QgcGFyYW1zID0gdGhpcy5fcDsKICAgICAgICBjb25zdCBob2xkZXIgPSBwYXJhbXNbMV07CiAgICAgICAgY29uc3QgdHlwZSA9IHBhcmFtc1syXTsKICAgICAgICBpZiAodHlwZSA9PT0gQ09OU1RSVUNUT1JfTUVUSE9EKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlaW1wbGVtZW50aW5nICRuZXcgaXMgbm90IHBvc3NpYmxlOyByZXBsYWNlIGltcGxlbWVudGF0aW9uIG9mICRpbml0IGluc3RlYWQiKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZXhpc3RpbmdSZXBsYWNlbWVudCA9IHRoaXMuX3I7CiAgICAgICAgaWYgKGV4aXN0aW5nUmVwbGFjZW1lbnQgIT09IHZvaWQgMCkgewogICAgICAgICAgaG9sZGVyLiRmLl9wYXRjaGVkTWV0aG9kcy5kZWxldGUodGhpcyk7CiAgICAgICAgICBjb25zdCBtYW5nbGVyID0gZXhpc3RpbmdSZXBsYWNlbWVudC5fbTsKICAgICAgICAgIG1hbmdsZXIucmV2ZXJ0KHZtMik7CiAgICAgICAgICB0aGlzLl9yID0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoZm4gIT09IG51bGwpIHsKICAgICAgICAgIGNvbnN0IFttZXRob2ROYW1lLCBjbGFzc1dyYXBwZXIsIHR5cGUyLCBtZXRob2RJZCwgcmV0VHlwZSwgYXJnVHlwZXNdID0gcGFyYW1zOwogICAgICAgICAgY29uc3QgcmVwbGFjZW1lbnQgPSBpbXBsZW1lbnQobWV0aG9kTmFtZSwgY2xhc3NXcmFwcGVyLCB0eXBlMiwgcmV0VHlwZSwgYXJnVHlwZXMsIGZuLCB0aGlzKTsKICAgICAgICAgIGNvbnN0IG1hbmdsZXIgPSBtYWtlTWV0aG9kTWFuZ2xlcjMobWV0aG9kSWQpOwogICAgICAgICAgcmVwbGFjZW1lbnQuX20gPSBtYW5nbGVyOwogICAgICAgICAgdGhpcy5fciA9IHJlcGxhY2VtZW50OwogICAgICAgICAgbWFuZ2xlci5yZXBsYWNlKHJlcGxhY2VtZW50LCB0eXBlMiA9PT0gSU5TVEFOQ0VfTUVUSE9ELCBhcmdUeXBlcywgdm0yLCBhcGkpOwogICAgICAgICAgaG9sZGVyLiRmLl9wYXRjaGVkTWV0aG9kcy5hZGQodGhpcyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgcmV0dXJuVHlwZTogewogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3BbNF07CiAgICAgIH0KICAgIH0sCiAgICBhcmd1bWVudFR5cGVzOiB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcFs1XTsKICAgICAgfQogICAgfSwKICAgIGNhbkludm9rZVdpdGg6IHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgdmFsdWUoYXJncykgewogICAgICAgIGNvbnN0IGFyZ1R5cGVzID0gdGhpcy5fcFs1XTsKICAgICAgICBpZiAoYXJncy5sZW5ndGggIT09IGFyZ1R5cGVzLmxlbmd0aCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXJnVHlwZXMuZXZlcnkoKHQsIGkpID0+IHsKICAgICAgICAgIHJldHVybiB0LmlzQ29tcGF0aWJsZShhcmdzW2ldKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIGNsb25lOiB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIHZhbHVlKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCBwYXJhbXMgPSB0aGlzLl9wLnNsaWNlKDAsIDYpOwogICAgICAgIHJldHVybiBtYWtlTWV0aG9kKC4uLnBhcmFtcywgbnVsbCwgb3B0aW9ucyk7CiAgICAgIH0KICAgIH0sCiAgICBpbnZva2U6IHsKICAgICAgdmFsdWUocmVjZWl2ZXIsIGFyZ3MpIHsKICAgICAgICBjb25zdCBlbnYgPSB2bTIuZ2V0RW52KCk7CiAgICAgICAgY29uc3QgcGFyYW1zID0gdGhpcy5fcDsKICAgICAgICBjb25zdCB0eXBlID0gcGFyYW1zWzJdOwogICAgICAgIGNvbnN0IHJldFR5cGUgPSBwYXJhbXNbNF07CiAgICAgICAgY29uc3QgYXJnVHlwZXMgPSBwYXJhbXNbNV07CiAgICAgICAgY29uc3QgcmVwbGFjZW1lbnQgPSB0aGlzLl9yOwogICAgICAgIGNvbnN0IGlzSW5zdGFuY2VNZXRob2QgPSB0eXBlID09PSBJTlNUQU5DRV9NRVRIT0Q7CiAgICAgICAgY29uc3QgbnVtQXJncyA9IGFyZ3MubGVuZ3RoOwogICAgICAgIGNvbnN0IGZyYW1lQ2FwYWNpdHkgPSAyICsgbnVtQXJnczsKICAgICAgICBlbnYucHVzaExvY2FsRnJhbWUoZnJhbWVDYXBhY2l0eSk7CiAgICAgICAgbGV0IGJvcnJvd2VkSGFuZGxlID0gbnVsbDsKICAgICAgICB0cnkgewogICAgICAgICAgbGV0IGpuaVRoaXM7CiAgICAgICAgICBpZiAoaXNJbnN0YW5jZU1ldGhvZCkgewogICAgICAgICAgICBqbmlUaGlzID0gcmVjZWl2ZXIuJGdldEhhbmRsZSgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYm9ycm93ZWRIYW5kbGUgPSByZWNlaXZlci4kYm9ycm93Q2xhc3NIYW5kbGUoZW52KTsKICAgICAgICAgICAgam5pVGhpcyA9IGJvcnJvd2VkSGFuZGxlLnZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgbGV0IG1ldGhvZElkOwogICAgICAgICAgbGV0IHN0cmF0ZWd5ID0gcmVjZWl2ZXIuJHQ7CiAgICAgICAgICBpZiAocmVwbGFjZW1lbnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBtZXRob2RJZCA9IHBhcmFtc1szXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IG1hbmdsZXIgPSByZXBsYWNlbWVudC5fbTsKICAgICAgICAgICAgbWV0aG9kSWQgPSBtYW5nbGVyLnJlc29sdmVUYXJnZXQocmVjZWl2ZXIsIGlzSW5zdGFuY2VNZXRob2QsIGVudiwgYXBpKTsKICAgICAgICAgICAgaWYgKGlzQXJ0Vm0pIHsKICAgICAgICAgICAgICBjb25zdCBwZW5kaW5nQ2FsbHMgPSByZXBsYWNlbWVudC5fYzsKICAgICAgICAgICAgICBpZiAocGVuZGluZ0NhbGxzLmhhcyhnZXRDdXJyZW50VGhyZWFkSWQoKSkpIHsKICAgICAgICAgICAgICAgIHN0cmF0ZWd5ID0gU1RSQVRFR1lfRElSRUNUOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY29uc3Qgam5pQXJncyA9IFsKICAgICAgICAgICAgZW52LmhhbmRsZSwKICAgICAgICAgICAgam5pVGhpcywKICAgICAgICAgICAgbWV0aG9kSWQKICAgICAgICAgIF07CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gbnVtQXJnczsgaSsrKSB7CiAgICAgICAgICAgIGpuaUFyZ3MucHVzaChhcmdUeXBlc1tpXS50b0puaShhcmdzW2ldLCBlbnYpKTsKICAgICAgICAgIH0KICAgICAgICAgIGxldCBqbmlDYWxsOwogICAgICAgICAgaWYgKHN0cmF0ZWd5ID09PSBTVFJBVEVHWV9WSVJUVUFMKSB7CiAgICAgICAgICAgIGpuaUNhbGwgPSBwYXJhbXNbNl07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBqbmlDYWxsID0gcGFyYW1zWzddOwogICAgICAgICAgICBpZiAoaXNJbnN0YW5jZU1ldGhvZCkgewogICAgICAgICAgICAgIGpuaUFyZ3Muc3BsaWNlKDIsIDAsIHJlY2VpdmVyLiRjb3B5Q2xhc3NIYW5kbGUoZW52KSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGpuaVJldHZhbCA9IGpuaUNhbGwuYXBwbHkobnVsbCwgam5pQXJncyk7CiAgICAgICAgICBlbnYudGhyb3dJZkV4Y2VwdGlvblBlbmRpbmcoKTsKICAgICAgICAgIHJldHVybiByZXRUeXBlLmZyb21Kbmkoam5pUmV0dmFsLCBlbnYsIHRydWUpOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpZiAoYm9ycm93ZWRIYW5kbGUgIT09IG51bGwpIHsKICAgICAgICAgICAgYm9ycm93ZWRIYW5kbGUudW5yZWYoZW52KTsKICAgICAgICAgIH0KICAgICAgICAgIGVudi5wb3BMb2NhbEZyYW1lKE5VTEwpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIHRvU3RyaW5nOiB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIHZhbHVlKCkgewogICAgICAgIHJldHVybiBgZnVuY3Rpb24gJHt0aGlzLm1ldGhvZE5hbWV9KCR7dGhpcy5hcmd1bWVudFR5cGVzLm1hcCgodCkgPT4gdC5jbGFzc05hbWUpLmpvaW4oIiwgIil9KTogJHt0aGlzLnJldHVyblR5cGUuY2xhc3NOYW1lfWA7CiAgICAgIH0KICAgIH0KICB9KTsKICBmdW5jdGlvbiBpbXBsZW1lbnQobWV0aG9kTmFtZSwgY2xhc3NXcmFwcGVyLCB0eXBlLCByZXRUeXBlLCBhcmdUeXBlcywgaGFuZGxlciwgZmFsbGJhY2sgPSBudWxsKSB7CiAgICBjb25zdCBwZW5kaW5nQ2FsbHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgY29uc3QgZiA9IG1ha2VNZXRob2RJbXBsZW1lbnRhdGlvbihbbWV0aG9kTmFtZSwgY2xhc3NXcmFwcGVyLCB0eXBlLCByZXRUeXBlLCBhcmdUeXBlcywgaGFuZGxlciwgZmFsbGJhY2ssIHBlbmRpbmdDYWxsc10pOwogICAgY29uc3QgaW1wbCA9IG5ldyBOYXRpdmVDYWxsYmFjayhmLCByZXRUeXBlLnR5cGUsIFsicG9pbnRlciIsICJwb2ludGVyIl0uY29uY2F0KGFyZ1R5cGVzLm1hcCgodCkgPT4gdC50eXBlKSkpOwogICAgaW1wbC5fYyA9IHBlbmRpbmdDYWxsczsKICAgIHJldHVybiBpbXBsOwogIH0KICBmdW5jdGlvbiBtYWtlTWV0aG9kSW1wbGVtZW50YXRpb24ocGFyYW1zKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBoYW5kbGVNZXRob2RJbnZvY2F0aW9uKGFyZ3VtZW50cywgcGFyYW1zKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGhhbmRsZU1ldGhvZEludm9jYXRpb24oam5pQXJncywgcGFyYW1zKSB7CiAgICBjb25zdCBlbnYgPSBuZXcgRW52KGpuaUFyZ3NbMF0sIHZtMik7CiAgICBjb25zdCBbbWV0aG9kTmFtZSwgY2xhc3NXcmFwcGVyLCB0eXBlLCByZXRUeXBlLCBhcmdUeXBlcywgaGFuZGxlciwgZmFsbGJhY2ssIHBlbmRpbmdDYWxsc10gPSBwYXJhbXM7CiAgICBjb25zdCBvd25lZE9iamVjdHMgPSBbXTsKICAgIGxldCBzZWxmOwogICAgaWYgKHR5cGUgPT09IElOU1RBTkNFX01FVEhPRCkgewogICAgICBjb25zdCBDID0gY2xhc3NXcmFwcGVyLiRDOwogICAgICBzZWxmID0gbmV3IEMoam5pQXJnc1sxXSwgU1RSQVRFR1lfVklSVFVBTCwgZW52LCBmYWxzZSk7CiAgICB9IGVsc2UgewogICAgICBzZWxmID0gY2xhc3NXcmFwcGVyOwogICAgfQogICAgY29uc3QgdGlkID0gZ2V0Q3VycmVudFRocmVhZElkKCk7CiAgICBlbnYucHVzaExvY2FsRnJhbWUoMyk7CiAgICBsZXQgaGF2ZUZyYW1lID0gdHJ1ZTsKICAgIHZtMi5saW5rKHRpZCwgZW52KTsKICAgIHRyeSB7CiAgICAgIHBlbmRpbmdDYWxscy5hZGQodGlkKTsKICAgICAgbGV0IGZuOwogICAgICBpZiAoZmFsbGJhY2sgPT09IG51bGwgfHwgIWlnbm9yZWRUaHJlYWRzLmhhcyh0aWQpKSB7CiAgICAgICAgZm4gPSBoYW5kbGVyOwogICAgICB9IGVsc2UgewogICAgICAgIGZuID0gZmFsbGJhY2s7CiAgICAgIH0KICAgICAgY29uc3QgYXJncyA9IFtdOwogICAgICBjb25zdCBudW1BcmdzID0gam5pQXJncy5sZW5ndGggLSAyOwogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gbnVtQXJnczsgaSsrKSB7CiAgICAgICAgY29uc3QgdCA9IGFyZ1R5cGVzW2ldOwogICAgICAgIGNvbnN0IHZhbHVlID0gdC5mcm9tSm5pKGpuaUFyZ3NbMiArIGldLCBlbnYsIGZhbHNlKTsKICAgICAgICBhcmdzLnB1c2godmFsdWUpOwogICAgICAgIG93bmVkT2JqZWN0cy5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgICBjb25zdCByZXR2YWwgPSBmbi5hcHBseShzZWxmLCBhcmdzKTsKICAgICAgaWYgKCFyZXRUeXBlLmlzQ29tcGF0aWJsZShyZXR2YWwpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbXBsZW1lbnRhdGlvbiBmb3IgJHttZXRob2ROYW1lfSBleHBlY3RlZCByZXR1cm4gdmFsdWUgY29tcGF0aWJsZSB3aXRoICR7cmV0VHlwZS5jbGFzc05hbWV9YCk7CiAgICAgIH0KICAgICAgbGV0IGpuaVJldHZhbCA9IHJldFR5cGUudG9KbmkocmV0dmFsLCBlbnYpOwogICAgICBpZiAocmV0VHlwZS50eXBlID09PSAicG9pbnRlciIpIHsKICAgICAgICBqbmlSZXR2YWwgPSBlbnYucG9wTG9jYWxGcmFtZShqbmlSZXR2YWwpOwogICAgICAgIGhhdmVGcmFtZSA9IGZhbHNlOwogICAgICAgIG93bmVkT2JqZWN0cy5wdXNoKHJldHZhbCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGpuaVJldHZhbDsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgY29uc3Qgam5pRXhjZXB0aW9uID0gZS4kaDsKICAgICAgaWYgKGpuaUV4Y2VwdGlvbiAhPT0gdm9pZCAwKSB7CiAgICAgICAgZW52LnRocm93KGpuaUV4Y2VwdGlvbik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgU2NyaXB0Lm5leHRUaWNrKCgpID0+IHsKICAgICAgICAgIHRocm93IGU7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJldFR5cGUuZGVmYXVsdFZhbHVlOwogICAgfSBmaW5hbGx5IHsKICAgICAgdm0yLnVubGluayh0aWQpOwogICAgICBpZiAoaGF2ZUZyYW1lKSB7CiAgICAgICAgZW52LnBvcExvY2FsRnJhbWUoTlVMTCk7CiAgICAgIH0KICAgICAgcGVuZGluZ0NhbGxzLmRlbGV0ZSh0aWQpOwogICAgICBvd25lZE9iamVjdHMuZm9yRWFjaCgob2JqKSA9PiB7CiAgICAgICAgaWYgKG9iaiA9PT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBkaXNwb3NlID0gb2JqLiRkaXNwb3NlOwogICAgICAgIGlmIChkaXNwb3NlICE9PSB2b2lkIDApIHsKICAgICAgICAgIGRpc3Bvc2UuY2FsbChvYmopOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGVuc3VyZURlZmF1bHRWYWx1ZU9mSW1wbGVtZW50ZWQobWV0aG9kcykgewogICAgY29uc3QgeyBob2xkZXIsIHR5cGUgfSA9IG1ldGhvZHNbMF07CiAgICBjb25zdCBoYXNEZWZhdWx0VmFsdWVPZiA9IG1ldGhvZHMuc29tZSgobSkgPT4gbS50eXBlID09PSB0eXBlICYmIG0uYXJndW1lbnRUeXBlcy5sZW5ndGggPT09IDApOwogICAgaWYgKGhhc0RlZmF1bHRWYWx1ZU9mKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIG1ldGhvZHMucHVzaChtYWtlVmFsdWVPZk1ldGhvZChbaG9sZGVyLCB0eXBlXSkpOwogIH0KICBmdW5jdGlvbiBtYWtlVmFsdWVPZk1ldGhvZChwYXJhbXMpIHsKICAgIGNvbnN0IG0gPSBtYWtlVmFsdWVPZkNhbGxhYmxlKCk7CiAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YobSwgdmFsdWVPZlByb3RvdHlwZSk7CiAgICBtLl9wID0gcGFyYW1zOwogICAgcmV0dXJuIG07CiAgfQogIGZ1bmN0aW9uIG1ha2VWYWx1ZU9mQ2FsbGFibGUoKSB7CiAgICBjb25zdCBtID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICAgIHJldHVybiBtOwogIH0KICB2YWx1ZU9mUHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShGdW5jdGlvbi5wcm90b3R5cGUsIHsKICAgIG1ldGhvZE5hbWU6IHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiAidmFsdWVPZiI7CiAgICAgIH0KICAgIH0sCiAgICBob2xkZXI6IHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLl9wWzBdOwogICAgICB9CiAgICB9LAogICAgdHlwZTogewogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3BbMV07CiAgICAgIH0KICAgIH0sCiAgICBoYW5kbGU6IHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiBOVUxMOwogICAgICB9CiAgICB9LAogICAgaW1wbGVtZW50YXRpb246IHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9LAogICAgICBzZXQoZm4pIHsKICAgICAgfQogICAgfSwKICAgIHJldHVyblR5cGU6IHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgZ2V0KCkgewogICAgICAgIGNvbnN0IGNsYXNzV3JhcHBlciA9IHRoaXMuaG9sZGVyOwogICAgICAgIHJldHVybiBjbGFzc1dyYXBwZXIuJGYudXNlKGNsYXNzV3JhcHBlci4kbik7CiAgICAgIH0KICAgIH0sCiAgICBhcmd1bWVudFR5cGVzOiB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIGdldCgpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgIH0sCiAgICBjYW5JbnZva2VXaXRoOiB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIHZhbHVlKGFyZ3MpIHsKICAgICAgICByZXR1cm4gYXJncy5sZW5ndGggPT09IDA7CiAgICAgIH0KICAgIH0sCiAgICBjbG9uZTogewogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICB2YWx1ZShvcHRpb25zKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIG9wZXJhdGlvbiIpOwogICAgICB9CiAgICB9CiAgfSk7CiAgZnVuY3Rpb24gbWFrZUZpZWxkRnJvbVNwZWMobmFtZSwgc3BlYywgY2xhc3NIYW5kbGUsIGNsYXNzV3JhcHBlciwgZW52KSB7CiAgICBjb25zdCB0eXBlID0gc3BlY1syXSA9PT0gInMiID8gU1RBVElDX0ZJRUxEIDogSU5TVEFOQ0VfRklFTEQ7CiAgICBjb25zdCBpZCA9IHB0cihzcGVjLnN1YnN0cigzKSk7CiAgICBjb25zdCB7ICRmOiBmYWN0b3J5IH0gPSBjbGFzc1dyYXBwZXI7CiAgICBsZXQgZmllbGRUeXBlOwogICAgY29uc3QgZmllbGQgPSBlbnYudG9SZWZsZWN0ZWRGaWVsZChjbGFzc0hhbmRsZSwgaWQsIHR5cGUgPT09IFNUQVRJQ19GSUVMRCA/IDEgOiAwKTsKICAgIHRyeSB7CiAgICAgIGZpZWxkVHlwZSA9IGVudi52YU1ldGhvZCgicG9pbnRlciIsIFtdKShlbnYuaGFuZGxlLCBmaWVsZCwgZW52LmphdmFMYW5nUmVmbGVjdEZpZWxkKCkuZ2V0R2VuZXJpY1R5cGUpOwogICAgICBlbnYudGhyb3dJZkV4Y2VwdGlvblBlbmRpbmcoKTsKICAgIH0gZmluYWxseSB7CiAgICAgIGVudi5kZWxldGVMb2NhbFJlZihmaWVsZCk7CiAgICB9CiAgICBsZXQgcnR5cGU7CiAgICB0cnkgewogICAgICBydHlwZSA9IGZhY3RvcnkuX2dldFR5cGUoZW52LmdldFR5cGVOYW1lKGZpZWxkVHlwZSkpOwogICAgfSBmaW5hbGx5IHsKICAgICAgZW52LmRlbGV0ZUxvY2FsUmVmKGZpZWxkVHlwZSk7CiAgICB9CiAgICBsZXQgZ2V0VmFsdWUsIHNldFZhbHVlOwogICAgY29uc3QgcnR5cGVKbmkgPSBydHlwZS50eXBlOwogICAgaWYgKHR5cGUgPT09IFNUQVRJQ19GSUVMRCkgewogICAgICBnZXRWYWx1ZSA9IGVudi5nZXRTdGF0aWNGaWVsZChydHlwZUpuaSk7CiAgICAgIHNldFZhbHVlID0gZW52LnNldFN0YXRpY0ZpZWxkKHJ0eXBlSm5pKTsKICAgIH0gZWxzZSB7CiAgICAgIGdldFZhbHVlID0gZW52LmdldEZpZWxkKHJ0eXBlSm5pKTsKICAgICAgc2V0VmFsdWUgPSBlbnYuc2V0RmllbGQocnR5cGVKbmkpOwogICAgfQogICAgcmV0dXJuIG1ha2VGaWVsZEZyb21QYXJhbXMoW3R5cGUsIHJ0eXBlLCBpZCwgZ2V0VmFsdWUsIHNldFZhbHVlXSk7CiAgfQogIGZ1bmN0aW9uIG1ha2VGaWVsZEZyb21QYXJhbXMocGFyYW1zKSB7CiAgICByZXR1cm4gZnVuY3Rpb24ocmVjZWl2ZXIpIHsKICAgICAgcmV0dXJuIG5ldyBGaWVsZChbcmVjZWl2ZXJdLmNvbmNhdChwYXJhbXMpKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIEZpZWxkKHBhcmFtcykgewogICAgdGhpcy5fcCA9IHBhcmFtczsKICB9CiAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoRmllbGQucHJvdG90eXBlLCB7CiAgICB2YWx1ZTogewogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBnZXQoKSB7CiAgICAgICAgY29uc3QgW2hvbGRlciwgdHlwZSwgcnR5cGUsIGlkLCBnZXRWYWx1ZV0gPSB0aGlzLl9wOwogICAgICAgIGNvbnN0IGVudiA9IHZtMi5nZXRFbnYoKTsKICAgICAgICBlbnYucHVzaExvY2FsRnJhbWUoNCk7CiAgICAgICAgbGV0IGJvcnJvd2VkSGFuZGxlID0gbnVsbDsKICAgICAgICB0cnkgewogICAgICAgICAgbGV0IGpuaVRoaXM7CiAgICAgICAgICBpZiAodHlwZSA9PT0gSU5TVEFOQ0VfRklFTEQpIHsKICAgICAgICAgICAgam5pVGhpcyA9IGhvbGRlci4kZ2V0SGFuZGxlKCk7CiAgICAgICAgICAgIGlmIChqbmlUaGlzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgYWNjZXNzIGFuIGluc3RhbmNlIGZpZWxkIHdpdGhvdXQgYW4gaW5zdGFuY2UiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYm9ycm93ZWRIYW5kbGUgPSBob2xkZXIuJGJvcnJvd0NsYXNzSGFuZGxlKGVudik7CiAgICAgICAgICAgIGpuaVRoaXMgPSBib3Jyb3dlZEhhbmRsZS52YWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGpuaVJldHZhbCA9IGdldFZhbHVlKGVudi5oYW5kbGUsIGpuaVRoaXMsIGlkKTsKICAgICAgICAgIGVudi50aHJvd0lmRXhjZXB0aW9uUGVuZGluZygpOwogICAgICAgICAgcmV0dXJuIHJ0eXBlLmZyb21Kbmkoam5pUmV0dmFsLCBlbnYsIHRydWUpOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpZiAoYm9ycm93ZWRIYW5kbGUgIT09IG51bGwpIHsKICAgICAgICAgICAgYm9ycm93ZWRIYW5kbGUudW5yZWYoZW52KTsKICAgICAgICAgIH0KICAgICAgICAgIGVudi5wb3BMb2NhbEZyYW1lKE5VTEwpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2V0KHZhbHVlKSB7CiAgICAgICAgY29uc3QgW2hvbGRlciwgdHlwZSwgcnR5cGUsIGlkLCAsIHNldFZhbHVlXSA9IHRoaXMuX3A7CiAgICAgICAgY29uc3QgZW52ID0gdm0yLmdldEVudigpOwogICAgICAgIGVudi5wdXNoTG9jYWxGcmFtZSg0KTsKICAgICAgICBsZXQgYm9ycm93ZWRIYW5kbGUgPSBudWxsOwogICAgICAgIHRyeSB7CiAgICAgICAgICBsZXQgam5pVGhpczsKICAgICAgICAgIGlmICh0eXBlID09PSBJTlNUQU5DRV9GSUVMRCkgewogICAgICAgICAgICBqbmlUaGlzID0gaG9sZGVyLiRnZXRIYW5kbGUoKTsKICAgICAgICAgICAgaWYgKGpuaVRoaXMgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBhY2Nlc3MgYW4gaW5zdGFuY2UgZmllbGQgd2l0aG91dCBhbiBpbnN0YW5jZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBib3Jyb3dlZEhhbmRsZSA9IGhvbGRlci4kYm9ycm93Q2xhc3NIYW5kbGUoZW52KTsKICAgICAgICAgICAgam5pVGhpcyA9IGJvcnJvd2VkSGFuZGxlLnZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFydHlwZS5pc0NvbXBhdGlibGUodmFsdWUpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgdmFsdWUgY29tcGF0aWJsZSB3aXRoICR7cnR5cGUuY2xhc3NOYW1lfWApOwogICAgICAgICAgfQogICAgICAgICAgY29uc3Qgam5pVmFsdWUgPSBydHlwZS50b0puaSh2YWx1ZSwgZW52KTsKICAgICAgICAgIHNldFZhbHVlKGVudi5oYW5kbGUsIGpuaVRoaXMsIGlkLCBqbmlWYWx1ZSk7CiAgICAgICAgICBlbnYudGhyb3dJZkV4Y2VwdGlvblBlbmRpbmcoKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaWYgKGJvcnJvd2VkSGFuZGxlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGJvcnJvd2VkSGFuZGxlLnVucmVmKGVudik7CiAgICAgICAgICB9CiAgICAgICAgICBlbnYucG9wTG9jYWxGcmFtZShOVUxMKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBob2xkZXI6IHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLl9wWzBdOwogICAgICB9CiAgICB9LAogICAgZmllbGRUeXBlOiB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcFsxXTsKICAgICAgfQogICAgfSwKICAgIGZpZWxkUmV0dXJuVHlwZTogewogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3BbMl07CiAgICAgIH0KICAgIH0sCiAgICB0b1N0cmluZzogewogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICB2YWx1ZSgpIHsKICAgICAgICBjb25zdCBpbmxpbmVTdHJpbmcgPSBgSmF2YS5GaWVsZHtob2xkZXI6ICR7dGhpcy5ob2xkZXJ9LCBmaWVsZFR5cGU6ICR7dGhpcy5maWVsZFR5cGV9LCBmaWVsZFJldHVyblR5cGU6ICR7dGhpcy5maWVsZFJldHVyblR5cGV9LCB2YWx1ZTogJHt0aGlzLnZhbHVlfX1gOwogICAgICAgIGlmIChpbmxpbmVTdHJpbmcubGVuZ3RoIDwgMjAwKSB7CiAgICAgICAgICByZXR1cm4gaW5saW5lU3RyaW5nOwogICAgICAgIH0KICAgICAgICBjb25zdCBtdWx0aWxpbmVTdHJpbmcgPSBgSmF2YS5GaWVsZHsKCWhvbGRlcjogJHt0aGlzLmhvbGRlcn0sCglmaWVsZFR5cGU6ICR7dGhpcy5maWVsZFR5cGV9LAoJZmllbGRSZXR1cm5UeXBlOiAke3RoaXMuZmllbGRSZXR1cm5UeXBlfSwKCXZhbHVlOiAke3RoaXMudmFsdWV9LAp9YDsKICAgICAgICByZXR1cm4gbXVsdGlsaW5lU3RyaW5nLnNwbGl0KCJcbiIpLm1hcCgobCkgPT4gbC5sZW5ndGggPiAyMDAgPyBsLnNsaWNlKDAsIGwuaW5kZXhPZigiICIpICsgMSkgKyAiLi4uLCIgOiBsKS5qb2luKCJcbiIpOwogICAgICB9CiAgICB9CiAgfSk7CiAgdmFyIERleEZpbGUgPSBjbGFzcyB7CiAgICBzdGF0aWMgZnJvbUJ1ZmZlcihidWZmZXIsIGZhY3RvcnkpIHsKICAgICAgY29uc3QgZmlsZVZhbHVlID0gY3JlYXRlVGVtcG9yYXJ5RGV4KGZhY3RvcnkpOwogICAgICBjb25zdCBmaWxlUGF0aCA9IGZpbGVWYWx1ZS5nZXRDYW5vbmljYWxQYXRoKCkudG9TdHJpbmcoKTsKICAgICAgY29uc3QgZmlsZSA9IG5ldyBGaWxlKGZpbGVQYXRoLCAidyIpOwogICAgICBmaWxlLndyaXRlKGJ1ZmZlci5idWZmZXIpOwogICAgICBmaWxlLmNsb3NlKCk7CiAgICAgIHNldFJlYWRPbmx5RGV4KGZpbGVQYXRoLCBmYWN0b3J5KTsKICAgICAgcmV0dXJuIG5ldyBEZXhGaWxlKGZpbGVQYXRoLCBmaWxlVmFsdWUsIGZhY3RvcnkpOwogICAgfQogICAgY29uc3RydWN0b3IocGF0aCwgZmlsZSwgZmFjdG9yeSkgewogICAgICB0aGlzLnBhdGggPSBwYXRoOwogICAgICB0aGlzLmZpbGUgPSBmaWxlOwogICAgICB0aGlzLl9mYWN0b3J5ID0gZmFjdG9yeTsKICAgIH0KICAgIGxvYWQoKSB7CiAgICAgIGNvbnN0IHsgX2ZhY3Rvcnk6IGZhY3RvcnkgfSA9IHRoaXM7CiAgICAgIGNvbnN0IHsgY29kZUNhY2hlRGlyIH0gPSBmYWN0b3J5OwogICAgICBjb25zdCBEZXhDbGFzc0xvYWRlciA9IGZhY3RvcnkudXNlKCJkYWx2aWsuc3lzdGVtLkRleENsYXNzTG9hZGVyIik7CiAgICAgIGNvbnN0IEpGaWxlID0gZmFjdG9yeS51c2UoImphdmEuaW8uRmlsZSIpOwogICAgICBsZXQgZmlsZSA9IHRoaXMuZmlsZTsKICAgICAgaWYgKGZpbGUgPT09IG51bGwpIHsKICAgICAgICBmaWxlID0gZmFjdG9yeS51c2UoImphdmEuaW8uRmlsZSIpLiRuZXcodGhpcy5wYXRoKTsKICAgICAgfQogICAgICBpZiAoIWZpbGUuZXhpc3RzKCkpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkZpbGUgbm90IGZvdW5kIik7CiAgICAgIH0KICAgICAgSkZpbGUuJG5ldyhjb2RlQ2FjaGVEaXIpLm1rZGlycygpOwogICAgICBmYWN0b3J5LmxvYWRlciA9IERleENsYXNzTG9hZGVyLiRuZXcoZmlsZS5nZXRDYW5vbmljYWxQYXRoKCksIGNvZGVDYWNoZURpciwgbnVsbCwgZmFjdG9yeS5sb2FkZXIpOwogICAgICB2bTIucHJldmVudERldGFjaER1ZVRvQ2xhc3NMb2FkZXIoKTsKICAgIH0KICAgIGdldENsYXNzTmFtZXMoKSB7CiAgICAgIGNvbnN0IHsgX2ZhY3Rvcnk6IGZhY3RvcnkgfSA9IHRoaXM7CiAgICAgIGNvbnN0IERleEZpbGUyID0gZmFjdG9yeS51c2UoImRhbHZpay5zeXN0ZW0uRGV4RmlsZSIpOwogICAgICBjb25zdCBvcHRpbWl6ZWREZXggPSBjcmVhdGVUZW1wb3JhcnlEZXgoZmFjdG9yeSk7CiAgICAgIGNvbnN0IGR4ID0gRGV4RmlsZTIubG9hZERleCh0aGlzLnBhdGgsIG9wdGltaXplZERleC5nZXRDYW5vbmljYWxQYXRoKCksIDApOwogICAgICBjb25zdCBjbGFzc05hbWVzID0gW107CiAgICAgIGNvbnN0IGVudW1lcmF0b3JDbGFzc05hbWVzID0gZHguZW50cmllcygpOwogICAgICB3aGlsZSAoZW51bWVyYXRvckNsYXNzTmFtZXMuaGFzTW9yZUVsZW1lbnRzKCkpIHsKICAgICAgICBjbGFzc05hbWVzLnB1c2goZW51bWVyYXRvckNsYXNzTmFtZXMubmV4dEVsZW1lbnQoKS50b1N0cmluZygpKTsKICAgICAgfQogICAgICByZXR1cm4gY2xhc3NOYW1lczsKICAgIH0KICB9OwogIGZ1bmN0aW9uIGNyZWF0ZVRlbXBvcmFyeURleChmYWN0b3J5KSB7CiAgICBjb25zdCB7IGNhY2hlRGlyLCB0ZW1wRmlsZU5hbWluZyB9ID0gZmFjdG9yeTsKICAgIGNvbnN0IEpGaWxlID0gZmFjdG9yeS51c2UoImphdmEuaW8uRmlsZSIpOwogICAgY29uc3QgY2FjaGVEaXJWYWx1ZSA9IEpGaWxlLiRuZXcoY2FjaGVEaXIpOwogICAgY2FjaGVEaXJWYWx1ZS5ta2RpcnMoKTsKICAgIHJldHVybiBKRmlsZS5jcmVhdGVUZW1wRmlsZSh0ZW1wRmlsZU5hbWluZy5wcmVmaXgsIHRlbXBGaWxlTmFtaW5nLnN1ZmZpeCArICIuZGV4IiwgY2FjaGVEaXJWYWx1ZSk7CiAgfQogIGZ1bmN0aW9uIHNldFJlYWRPbmx5RGV4KGZpbGVQYXRoLCBmYWN0b3J5KSB7CiAgICBjb25zdCBKRmlsZSA9IGZhY3RvcnkudXNlKCJqYXZhLmlvLkZpbGUiKTsKICAgIGNvbnN0IGZpbGUgPSBKRmlsZS4kbmV3KGZpbGVQYXRoKTsKICAgIGZpbGUuc2V0V3JpdGFibGUoZmFsc2UsIGZhbHNlKTsKICB9CiAgZnVuY3Rpb24gZ2V0RmFjdG9yeUNhY2hlKCkgewogICAgc3dpdGNoIChmYWN0b3J5Q2FjaGUuc3RhdGUpIHsKICAgICAgY2FzZSAiZW1wdHkiOiB7CiAgICAgICAgZmFjdG9yeUNhY2hlLnN0YXRlID0gInBlbmRpbmciOwogICAgICAgIGNvbnN0IGRlZmF1bHRGYWN0b3J5ID0gZmFjdG9yeUNhY2hlLmZhY3Rvcmllc1swXTsKICAgICAgICBjb25zdCBIYXNoTWFwID0gZGVmYXVsdEZhY3RvcnkudXNlKCJqYXZhLnV0aWwuSGFzaE1hcCIpOwogICAgICAgIGNvbnN0IEludGVnZXIgPSBkZWZhdWx0RmFjdG9yeS51c2UoImphdmEubGFuZy5JbnRlZ2VyIik7CiAgICAgICAgZmFjdG9yeUNhY2hlLmxvYWRlcnMgPSBIYXNoTWFwLiRuZXcoKTsKICAgICAgICBmYWN0b3J5Q2FjaGUuSW50ZWdlciA9IEludGVnZXI7CiAgICAgICAgY29uc3QgbG9hZGVyID0gZGVmYXVsdEZhY3RvcnkubG9hZGVyOwogICAgICAgIGlmIChsb2FkZXIgIT09IG51bGwpIHsKICAgICAgICAgIGFkZEZhY3RvcnlUb0NhY2hlKGRlZmF1bHRGYWN0b3J5LCBsb2FkZXIpOwogICAgICAgIH0KICAgICAgICBmYWN0b3J5Q2FjaGUuc3RhdGUgPSAicmVhZHkiOwogICAgICAgIHJldHVybiBmYWN0b3J5Q2FjaGU7CiAgICAgIH0KICAgICAgY2FzZSAicGVuZGluZyI6CiAgICAgICAgZG8gewogICAgICAgICAgVGhyZWFkLnNsZWVwKDAuMDUpOwogICAgICAgIH0gd2hpbGUgKGZhY3RvcnlDYWNoZS5zdGF0ZSA9PT0gInBlbmRpbmciKTsKICAgICAgICByZXR1cm4gZmFjdG9yeUNhY2hlOwogICAgICBjYXNlICJyZWFkeSI6CiAgICAgICAgcmV0dXJuIGZhY3RvcnlDYWNoZTsKICAgIH0KICB9CiAgZnVuY3Rpb24gYWRkRmFjdG9yeVRvQ2FjaGUoZmFjdG9yeSwgbG9hZGVyKSB7CiAgICBjb25zdCB7IGZhY3RvcmllcywgbG9hZGVycywgSW50ZWdlciB9ID0gZmFjdG9yeUNhY2hlOwogICAgY29uc3QgaW5kZXggPSBJbnRlZ2VyLiRuZXcoZmFjdG9yaWVzLmluZGV4T2YoZmFjdG9yeSkpOwogICAgbG9hZGVycy5wdXQobG9hZGVyLCBpbmRleCk7CiAgICBmb3IgKGxldCBsID0gbG9hZGVyLmdldFBhcmVudCgpOyBsICE9PSBudWxsOyBsID0gbC5nZXRQYXJlbnQoKSkgewogICAgICBpZiAobG9hZGVycy5jb250YWluc0tleShsKSkgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIGxvYWRlcnMucHV0KGwsIGluZGV4KTsKICAgIH0KICB9CiAgZnVuY3Rpb24gaWdub3JlKHRocmVhZElkKSB7CiAgICBsZXQgY291bnQgPSBpZ25vcmVkVGhyZWFkcy5nZXQodGhyZWFkSWQpOwogICAgaWYgKGNvdW50ID09PSB2b2lkIDApIHsKICAgICAgY291bnQgPSAwOwogICAgfQogICAgY291bnQrKzsKICAgIGlnbm9yZWRUaHJlYWRzLnNldCh0aHJlYWRJZCwgY291bnQpOwogIH0KICBmdW5jdGlvbiB1bmlnbm9yZSh0aHJlYWRJZCkgewogICAgbGV0IGNvdW50ID0gaWdub3JlZFRocmVhZHMuZ2V0KHRocmVhZElkKTsKICAgIGlmIChjb3VudCA9PT0gdm9pZCAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhyZWFkICR7dGhyZWFkSWR9IGlzIG5vdCBpZ25vcmVkYCk7CiAgICB9CiAgICBjb3VudC0tOwogICAgaWYgKGNvdW50ID09PSAwKSB7CiAgICAgIGlnbm9yZWRUaHJlYWRzLmRlbGV0ZSh0aHJlYWRJZCk7CiAgICB9IGVsc2UgewogICAgICBpZ25vcmVkVGhyZWFkcy5zZXQodGhyZWFkSWQsIGNvdW50KTsKICAgIH0KICB9CiAgZnVuY3Rpb24gYmFzZW5hbWUoY2xhc3NOYW1lKSB7CiAgICByZXR1cm4gY2xhc3NOYW1lLnNsaWNlKGNsYXNzTmFtZS5sYXN0SW5kZXhPZigiLiIpICsgMSk7CiAgfQogIGZ1bmN0aW9uIHJlYWRUeXBlTmFtZXMoZW52LCB0eXBlcykgewogICAgY29uc3QgbmFtZXMgPSBbXTsKICAgIGNvbnN0IG4gPSBlbnYuZ2V0QXJyYXlMZW5ndGgodHlwZXMpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IG47IGkrKykgewogICAgICBjb25zdCB0ID0gZW52LmdldE9iamVjdEFycmF5RWxlbWVudCh0eXBlcywgaSk7CiAgICAgIHRyeSB7CiAgICAgICAgbmFtZXMucHVzaChlbnYuZ2V0VHlwZU5hbWUodCkpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIGVudi5kZWxldGVMb2NhbFJlZih0KTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG5hbWVzOwogIH0KICBmdW5jdGlvbiBtYWtlU291cmNlRmlsZU5hbWUoY2xhc3NOYW1lKSB7CiAgICBjb25zdCB0b2tlbnMgPSBjbGFzc05hbWUuc3BsaXQoIi4iKTsKICAgIHJldHVybiB0b2tlbnNbdG9rZW5zLmxlbmd0aCAtIDFdICsgIi5qYXZhIjsKICB9CgogIC8vIG5vZGVfbW9kdWxlcy9mcmlkYS1qYXZhLWJyaWRnZS9pbmRleC5qcwogIHZhciBqc2l6ZVNpemU0ID0gNDsKICB2YXIgcG9pbnRlclNpemU4ID0gUHJvY2Vzcy5wb2ludGVyU2l6ZTsKICB2YXIgUnVudGltZSA9IGNsYXNzIHsKICAgIEFDQ19QVUJMSUMgPSAxOwogICAgQUNDX1BSSVZBVEUgPSAyOwogICAgQUNDX1BST1RFQ1RFRCA9IDQ7CiAgICBBQ0NfU1RBVElDID0gODsKICAgIEFDQ19GSU5BTCA9IDE2OwogICAgQUNDX1NZTkNIUk9OSVpFRCA9IDMyOwogICAgQUNDX0JSSURHRSA9IDY0OwogICAgQUNDX1ZBUkFSR1MgPSAxMjg7CiAgICBBQ0NfTkFUSVZFID0gMjU2OwogICAgQUNDX0FCU1RSQUNUID0gMTAyNDsKICAgIEFDQ19TVFJJQ1QgPSAyMDQ4OwogICAgQUNDX1NZTlRIRVRJQyA9IDQwOTY7CiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgdGhpcy5jbGFzc0ZhY3RvcnkgPSBudWxsOwogICAgICB0aGlzLkNsYXNzRmFjdG9yeSA9IENsYXNzRmFjdG9yeTsKICAgICAgdGhpcy52bSA9IG51bGw7CiAgICAgIHRoaXMuYXBpID0gbnVsbDsKICAgICAgdGhpcy5faW5pdGlhbGl6ZWQgPSBmYWxzZTsKICAgICAgdGhpcy5fYXBpRXJyb3IgPSBudWxsOwogICAgICB0aGlzLl93YWtldXBIYW5kbGVyID0gbnVsbDsKICAgICAgdGhpcy5fcG9sbExpc3RlbmVyID0gbnVsbDsKICAgICAgdGhpcy5fcGVuZGluZ01haW5PcHMgPSBbXTsKICAgICAgdGhpcy5fcGVuZGluZ1ZtT3BzID0gW107CiAgICAgIHRoaXMuX2NhY2hlZElzQXBwUHJvY2VzcyA9IG51bGw7CiAgICAgIHRyeSB7CiAgICAgICAgdGhpcy5fdHJ5SW5pdGlhbGl6ZSgpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgIH0KICAgIH0KICAgIF90cnlJbml0aWFsaXplKCkgewogICAgICBpZiAodGhpcy5faW5pdGlhbGl6ZWQpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZiAodGhpcy5fYXBpRXJyb3IgIT09IG51bGwpIHsKICAgICAgICB0aHJvdyB0aGlzLl9hcGlFcnJvcjsKICAgICAgfQogICAgICBsZXQgYXBpMjsKICAgICAgdHJ5IHsKICAgICAgICBhcGkyID0gYXBpX2RlZmF1bHQoKTsKICAgICAgICB0aGlzLmFwaSA9IGFwaTI7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB0aGlzLl9hcGlFcnJvciA9IGU7CiAgICAgICAgdGhyb3cgZTsKICAgICAgfQogICAgICBpZiAoYXBpMiA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBjb25zdCB2bTMgPSBuZXcgVk0oYXBpMik7CiAgICAgIHRoaXMudm0gPSB2bTM7CiAgICAgIGluaXRpYWxpemUodm0zKTsKICAgICAgQ2xhc3NGYWN0b3J5Ll9pbml0aWFsaXplKHZtMywgYXBpMik7CiAgICAgIHRoaXMuY2xhc3NGYWN0b3J5ID0gbmV3IENsYXNzRmFjdG9yeSgpOwogICAgICB0aGlzLl9pbml0aWFsaXplZCA9IHRydWU7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgX2Rpc3Bvc2UoKSB7CiAgICAgIGlmICh0aGlzLmFwaSA9PT0gbnVsbCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjb25zdCB7IHZtOiB2bTMgfSA9IHRoaXM7CiAgICAgIHZtMy5wZXJmb3JtKChlbnYpID0+IHsKICAgICAgICBDbGFzc0ZhY3RvcnkuX2Rpc3Bvc2VBbGwoZW52KTsKICAgICAgICBFbnYuZGlzcG9zZShlbnYpOwogICAgICB9KTsKICAgICAgU2NyaXB0Lm5leHRUaWNrKCgpID0+IHsKICAgICAgICBWTS5kaXNwb3NlKHZtMyk7CiAgICAgIH0pOwogICAgfQogICAgZ2V0IGF2YWlsYWJsZSgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3RyeUluaXRpYWxpemUoKTsKICAgIH0KICAgIGdldCBhbmRyb2lkVmVyc2lvbigpIHsKICAgICAgcmV0dXJuIGdldEFuZHJvaWRWZXJzaW9uKCk7CiAgICB9CiAgICBzeW5jaHJvbml6ZWQob2JqLCBmbikgewogICAgICBjb25zdCB7ICRoOiBvYmpIYW5kbGUgPSBvYmogfSA9IG9iajsKICAgICAgaWYgKCEob2JqSGFuZGxlIGluc3RhbmNlb2YgTmF0aXZlUG9pbnRlcikpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkphdmEuc3luY2hyb25pemVkOiB0aGUgZmlyc3QgYXJndW1lbnQgYG9iamAgbXVzdCBiZSBlaXRoZXIgYSBwb2ludGVyIG9yIGEgSmF2YSBpbnN0YW5jZSIpOwogICAgICB9CiAgICAgIGNvbnN0IGVudiA9IHRoaXMudm0uZ2V0RW52KCk7CiAgICAgIGNoZWNrSm5pUmVzdWx0KCJWTTo6TW9uaXRvckVudGVyIiwgZW52Lm1vbml0b3JFbnRlcihvYmpIYW5kbGUpKTsKICAgICAgdHJ5IHsKICAgICAgICBmbigpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIGVudi5tb25pdG9yRXhpdChvYmpIYW5kbGUpOwogICAgICB9CiAgICB9CiAgICBlbnVtZXJhdGVMb2FkZWRDbGFzc2VzKGNhbGxiYWNrcykgewogICAgICB0aGlzLl9jaGVja0F2YWlsYWJsZSgpOwogICAgICBjb25zdCB7IGZsYXZvciB9ID0gdGhpcy5hcGk7CiAgICAgIGlmIChmbGF2b3IgPT09ICJqdm0iKSB7CiAgICAgICAgdGhpcy5fZW51bWVyYXRlTG9hZGVkQ2xhc3Nlc0p2bShjYWxsYmFja3MpOwogICAgICB9IGVsc2UgaWYgKGZsYXZvciA9PT0gImFydCIpIHsKICAgICAgICB0aGlzLl9lbnVtZXJhdGVMb2FkZWRDbGFzc2VzQXJ0KGNhbGxiYWNrcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fZW51bWVyYXRlTG9hZGVkQ2xhc3Nlc0RhbHZpayhjYWxsYmFja3MpOwogICAgICB9CiAgICB9CiAgICBlbnVtZXJhdGVMb2FkZWRDbGFzc2VzU3luYygpIHsKICAgICAgY29uc3QgY2xhc3NlcyA9IFtdOwogICAgICB0aGlzLmVudW1lcmF0ZUxvYWRlZENsYXNzZXMoewogICAgICAgIG9uTWF0Y2goYykgewogICAgICAgICAgY2xhc3Nlcy5wdXNoKGMpOwogICAgICAgIH0sCiAgICAgICAgb25Db21wbGV0ZSgpIHsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gY2xhc3NlczsKICAgIH0KICAgIGVudW1lcmF0ZUNsYXNzTG9hZGVycyhjYWxsYmFja3MpIHsKICAgICAgdGhpcy5fY2hlY2tBdmFpbGFibGUoKTsKICAgICAgY29uc3QgeyBmbGF2b3IgfSA9IHRoaXMuYXBpOwogICAgICBpZiAoZmxhdm9yID09PSAianZtIikgewogICAgICAgIHRoaXMuX2VudW1lcmF0ZUNsYXNzTG9hZGVyc0p2bShjYWxsYmFja3MpOwogICAgICB9IGVsc2UgaWYgKGZsYXZvciA9PT0gImFydCIpIHsKICAgICAgICB0aGlzLl9lbnVtZXJhdGVDbGFzc0xvYWRlcnNBcnQoY2FsbGJhY2tzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkVudW1lcmF0aW5nIGNsYXNzIGxvYWRlcnMgaXMgbm90IHN1cHBvcnRlZCBvbiBEYWx2aWsiKTsKICAgICAgfQogICAgfQogICAgZW51bWVyYXRlQ2xhc3NMb2FkZXJzU3luYygpIHsKICAgICAgY29uc3QgbG9hZGVycyA9IFtdOwogICAgICB0aGlzLmVudW1lcmF0ZUNsYXNzTG9hZGVycyh7CiAgICAgICAgb25NYXRjaChjKSB7CiAgICAgICAgICBsb2FkZXJzLnB1c2goYyk7CiAgICAgICAgfSwKICAgICAgICBvbkNvbXBsZXRlKCkgewogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBsb2FkZXJzOwogICAgfQogICAgX2VudW1lcmF0ZUxvYWRlZENsYXNzZXNKdm0oY2FsbGJhY2tzKSB7CiAgICAgIGNvbnN0IHsgYXBpOiBhcGkyLCB2bTogdm0zIH0gPSB0aGlzOwogICAgICBjb25zdCB7IGp2bXRpIH0gPSBhcGkyOwogICAgICBjb25zdCBlbnYgPSB2bTMuZ2V0RW52KCk7CiAgICAgIGNvbnN0IGNvdW50UHRyID0gTWVtb3J5LmFsbG9jKGpzaXplU2l6ZTQpOwogICAgICBjb25zdCBjbGFzc2VzUHRyID0gTWVtb3J5LmFsbG9jKHBvaW50ZXJTaXplOCk7CiAgICAgIGp2bXRpLmdldExvYWRlZENsYXNzZXMoY291bnRQdHIsIGNsYXNzZXNQdHIpOwogICAgICBjb25zdCBjb3VudCA9IGNvdW50UHRyLnJlYWRTMzIoKTsKICAgICAgY29uc3QgY2xhc3NlcyA9IGNsYXNzZXNQdHIucmVhZFBvaW50ZXIoKTsKICAgICAgY29uc3QgaGFuZGxlcyA9IFtdOwogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gY291bnQ7IGkrKykgewogICAgICAgIGhhbmRsZXMucHVzaChjbGFzc2VzLmFkZChpICogcG9pbnRlclNpemU4KS5yZWFkUG9pbnRlcigpKTsKICAgICAgfQogICAgICBqdm10aS5kZWFsbG9jYXRlKGNsYXNzZXMpOwogICAgICB0cnkgewogICAgICAgIGZvciAoY29uc3QgaGFuZGxlIG9mIGhhbmRsZXMpIHsKICAgICAgICAgIGNvbnN0IGNsYXNzTmFtZSA9IGVudi5nZXRDbGFzc05hbWUoaGFuZGxlKTsKICAgICAgICAgIGNhbGxiYWNrcy5vbk1hdGNoKGNsYXNzTmFtZSwgaGFuZGxlKTsKICAgICAgICB9CiAgICAgICAgY2FsbGJhY2tzLm9uQ29tcGxldGUoKTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBoYW5kbGVzLmZvckVhY2goKGhhbmRsZSkgPT4gewogICAgICAgICAgZW52LmRlbGV0ZUxvY2FsUmVmKGhhbmRsZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIF9lbnVtZXJhdGVDbGFzc0xvYWRlcnNKdm0oY2FsbGJhY2tzKSB7CiAgICAgIHRoaXMuY2hvb3NlKCJqYXZhLmxhbmcuQ2xhc3NMb2FkZXIiLCBjYWxsYmFja3MpOwogICAgfQogICAgX2VudW1lcmF0ZUxvYWRlZENsYXNzZXNBcnQoY2FsbGJhY2tzKSB7CiAgICAgIGNvbnN0IHsgdm06IHZtMywgYXBpOiBhcGkyIH0gPSB0aGlzOwogICAgICBjb25zdCBlbnYgPSB2bTMuZ2V0RW52KCk7CiAgICAgIGNvbnN0IGFkZEdsb2JhbFJlZmVyZW5jZSA9IGFwaTJbImFydDo6SmF2YVZNRXh0OjpBZGRHbG9iYWxSZWYiXTsKICAgICAgY29uc3QgeyB2bTogdm1IYW5kbGUgfSA9IGFwaTI7CiAgICAgIHdpdGhSdW5uYWJsZUFydFRocmVhZCh2bTMsIGVudiwgKHRocmVhZCkgPT4gewogICAgICAgIGNvbnN0IGNvbGxlY3RDbGFzc0hhbmRsZXMgPSBtYWtlQXJ0Q2xhc3NWaXNpdG9yKChrbGFzcykgPT4gewogICAgICAgICAgY29uc3QgaGFuZGxlID0gYWRkR2xvYmFsUmVmZXJlbmNlKHZtSGFuZGxlLCB0aHJlYWQsIGtsYXNzKTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IGNsYXNzTmFtZSA9IGVudi5nZXRDbGFzc05hbWUoaGFuZGxlKTsKICAgICAgICAgICAgY2FsbGJhY2tzLm9uTWF0Y2goY2xhc3NOYW1lLCBoYW5kbGUpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgZW52LmRlbGV0ZUdsb2JhbFJlZihoYW5kbGUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSk7CiAgICAgICAgYXBpMlsiYXJ0OjpDbGFzc0xpbmtlcjo6VmlzaXRDbGFzc2VzIl0oYXBpMi5hcnRDbGFzc0xpbmtlci5hZGRyZXNzLCBjb2xsZWN0Q2xhc3NIYW5kbGVzKTsKICAgICAgfSk7CiAgICAgIGNhbGxiYWNrcy5vbkNvbXBsZXRlKCk7CiAgICB9CiAgICBfZW51bWVyYXRlQ2xhc3NMb2FkZXJzQXJ0KGNhbGxiYWNrcykgewogICAgICBjb25zdCB7IGNsYXNzRmFjdG9yeTogZmFjdG9yeSwgdm06IHZtMywgYXBpOiBhcGkyIH0gPSB0aGlzOwogICAgICBjb25zdCBlbnYgPSB2bTMuZ2V0RW52KCk7CiAgICAgIGNvbnN0IHZpc2l0Q2xhc3NMb2FkZXJzID0gYXBpMlsiYXJ0OjpDbGFzc0xpbmtlcjo6VmlzaXRDbGFzc0xvYWRlcnMiXTsKICAgICAgaWYgKHZpc2l0Q2xhc3NMb2FkZXJzID09PSB2b2lkIDApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoaXMgQVBJIGlzIG9ubHkgYXZhaWxhYmxlIG9uIEFuZHJvaWQgPj0gNy4wIik7CiAgICAgIH0KICAgICAgY29uc3QgQ2xhc3NMb2FkZXIgPSBmYWN0b3J5LnVzZSgiamF2YS5sYW5nLkNsYXNzTG9hZGVyIik7CiAgICAgIGNvbnN0IGxvYWRlckhhbmRsZXMgPSBbXTsKICAgICAgY29uc3QgYWRkR2xvYmFsUmVmZXJlbmNlID0gYXBpMlsiYXJ0OjpKYXZhVk1FeHQ6OkFkZEdsb2JhbFJlZiJdOwogICAgICBjb25zdCB7IHZtOiB2bUhhbmRsZSB9ID0gYXBpMjsKICAgICAgd2l0aFJ1bm5hYmxlQXJ0VGhyZWFkKHZtMywgZW52LCAodGhyZWFkKSA9PiB7CiAgICAgICAgY29uc3QgY29sbGVjdExvYWRlckhhbmRsZXMgPSBtYWtlQXJ0Q2xhc3NMb2FkZXJWaXNpdG9yKChsb2FkZXIpID0+IHsKICAgICAgICAgIGxvYWRlckhhbmRsZXMucHVzaChhZGRHbG9iYWxSZWZlcmVuY2Uodm1IYW5kbGUsIHRocmVhZCwgbG9hZGVyKSk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9KTsKICAgICAgICB3aXRoQWxsQXJ0VGhyZWFkc1N1c3BlbmRlZCgoKSA9PiB7CiAgICAgICAgICB2aXNpdENsYXNzTG9hZGVycyhhcGkyLmFydENsYXNzTGlua2VyLmFkZHJlc3MsIGNvbGxlY3RMb2FkZXJIYW5kbGVzKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIHRyeSB7CiAgICAgICAgbG9hZGVySGFuZGxlcy5mb3JFYWNoKChoYW5kbGUpID0+IHsKICAgICAgICAgIGNvbnN0IGxvYWRlciA9IGZhY3RvcnkuY2FzdChoYW5kbGUsIENsYXNzTG9hZGVyKTsKICAgICAgICAgIGNhbGxiYWNrcy5vbk1hdGNoKGxvYWRlcik7CiAgICAgICAgfSk7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgbG9hZGVySGFuZGxlcy5mb3JFYWNoKChoYW5kbGUpID0+IHsKICAgICAgICAgIGVudi5kZWxldGVHbG9iYWxSZWYoaGFuZGxlKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBjYWxsYmFja3Mub25Db21wbGV0ZSgpOwogICAgfQogICAgX2VudW1lcmF0ZUxvYWRlZENsYXNzZXNEYWx2aWsoY2FsbGJhY2tzKSB7CiAgICAgIGNvbnN0IHsgYXBpOiBhcGkyIH0gPSB0aGlzOwogICAgICBjb25zdCBIQVNIX1RPTUJTVE9ORSA9IHB0cigiMHhjYmNhY2NjZCIpOwogICAgICBjb25zdCBsb2FkZWRDbGFzc2VzT2Zmc2V0ID0gMTcyOwogICAgICBjb25zdCBoYXNoRW50cnlTaXplID0gODsKICAgICAgY29uc3QgcHRyTG9hZGVkQ2xhc3Nlc0hhc2h0YWJsZSA9IGFwaTIuZ0R2bS5hZGQobG9hZGVkQ2xhc3Nlc09mZnNldCk7CiAgICAgIGNvbnN0IGhhc2hUYWJsZSA9IHB0ckxvYWRlZENsYXNzZXNIYXNodGFibGUucmVhZFBvaW50ZXIoKTsKICAgICAgY29uc3QgdGFibGVTaXplID0gaGFzaFRhYmxlLnJlYWRTMzIoKTsKICAgICAgY29uc3QgcHRycEVudHJpZXMgPSBoYXNoVGFibGUuYWRkKDEyKTsKICAgICAgY29uc3QgcEVudHJpZXMgPSBwdHJwRW50cmllcy5yZWFkUG9pbnRlcigpOwogICAgICBjb25zdCBlbmQgPSB0YWJsZVNpemUgKiBoYXNoRW50cnlTaXplOwogICAgICBmb3IgKGxldCBvZmZzZXQgPSAwOyBvZmZzZXQgPCBlbmQ7IG9mZnNldCArPSBoYXNoRW50cnlTaXplKSB7CiAgICAgICAgY29uc3QgcEVudHJ5UHRyID0gcEVudHJpZXMuYWRkKG9mZnNldCk7CiAgICAgICAgY29uc3QgZGF0YVB0ciA9IHBFbnRyeVB0ci5hZGQoNCkucmVhZFBvaW50ZXIoKTsKICAgICAgICBpZiAoZGF0YVB0ci5pc051bGwoKSB8fCBkYXRhUHRyLmVxdWFscyhIQVNIX1RPTUJTVE9ORSkpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBjb25zdCBkZXNjcmlwdGlvblB0ciA9IGRhdGFQdHIuYWRkKDI0KS5yZWFkUG9pbnRlcigpOwogICAgICAgIGNvbnN0IGRlc2NyaXB0aW9uID0gZGVzY3JpcHRpb25QdHIucmVhZFV0ZjhTdHJpbmcoKTsKICAgICAgICBpZiAoZGVzY3JpcHRpb24uc3RhcnRzV2l0aCgiTCIpKSB7CiAgICAgICAgICBjb25zdCBuYW1lID0gZGVzY3JpcHRpb24uc3Vic3RyaW5nKDEsIGRlc2NyaXB0aW9uLmxlbmd0aCAtIDEpLnJlcGxhY2UoL1wvL2csICIuIik7CiAgICAgICAgICBjYWxsYmFja3Mub25NYXRjaChuYW1lKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY2FsbGJhY2tzLm9uQ29tcGxldGUoKTsKICAgIH0KICAgIGVudW1lcmF0ZU1ldGhvZHMocXVlcnkpIHsKICAgICAgY29uc3QgeyBjbGFzc0ZhY3Rvcnk6IGZhY3RvcnkgfSA9IHRoaXM7CiAgICAgIGNvbnN0IGVudiA9IHRoaXMudm0uZ2V0RW52KCk7CiAgICAgIGNvbnN0IENsYXNzTG9hZGVyID0gZmFjdG9yeS51c2UoImphdmEubGFuZy5DbGFzc0xvYWRlciIpOwogICAgICByZXR1cm4gTW9kZWwuZW51bWVyYXRlTWV0aG9kcyhxdWVyeSwgdGhpcy5hcGksIGVudikubWFwKChncm91cCkgPT4gewogICAgICAgIGNvbnN0IGhhbmRsZSA9IGdyb3VwLmxvYWRlcjsKICAgICAgICBncm91cC5sb2FkZXIgPSBoYW5kbGUgIT09IG51bGwgPyBmYWN0b3J5LndyYXAoaGFuZGxlLCBDbGFzc0xvYWRlciwgZW52KSA6IG51bGw7CiAgICAgICAgcmV0dXJuIGdyb3VwOwogICAgICB9KTsKICAgIH0KICAgIHNjaGVkdWxlT25NYWluVGhyZWFkKGZuKSB7CiAgICAgIHRoaXMucGVyZm9ybU5vdygoKSA9PiB7CiAgICAgICAgdGhpcy5fcGVuZGluZ01haW5PcHMucHVzaChmbik7CiAgICAgICAgbGV0IHsgX3dha2V1cEhhbmRsZXI6IHdha2V1cEhhbmRsZXIgfSA9IHRoaXM7CiAgICAgICAgaWYgKHdha2V1cEhhbmRsZXIgPT09IG51bGwpIHsKICAgICAgICAgIGNvbnN0IHsgY2xhc3NGYWN0b3J5OiBmYWN0b3J5IH0gPSB0aGlzOwogICAgICAgICAgY29uc3QgSGFuZGxlciA9IGZhY3RvcnkudXNlKCJhbmRyb2lkLm9zLkhhbmRsZXIiKTsKICAgICAgICAgIGNvbnN0IExvb3BlciA9IGZhY3RvcnkudXNlKCJhbmRyb2lkLm9zLkxvb3BlciIpOwogICAgICAgICAgd2FrZXVwSGFuZGxlciA9IEhhbmRsZXIuJG5ldyhMb29wZXIuZ2V0TWFpbkxvb3BlcigpKTsKICAgICAgICAgIHRoaXMuX3dha2V1cEhhbmRsZXIgPSB3YWtldXBIYW5kbGVyOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5fcG9sbExpc3RlbmVyID09PSBudWxsKSB7CiAgICAgICAgICB0aGlzLl9wb2xsTGlzdGVuZXIgPSBJbnRlcmNlcHRvci5hdHRhY2goUHJvY2Vzcy5nZXRNb2R1bGVCeU5hbWUoImxpYmMuc28iKS5nZXRFeHBvcnRCeU5hbWUoImVwb2xsX3dhaXQiKSwgdGhpcy5fbWFrZVBvbGxIb29rKCkpOwogICAgICAgICAgSW50ZXJjZXB0b3IuZmx1c2goKTsKICAgICAgICB9CiAgICAgICAgd2FrZXVwSGFuZGxlci5zZW5kRW1wdHlNZXNzYWdlKDEpOwogICAgICB9KTsKICAgIH0KICAgIF9tYWtlUG9sbEhvb2soKSB7CiAgICAgIGNvbnN0IG1haW5UaHJlYWRJZCA9IFByb2Nlc3MuaWQ7CiAgICAgIGNvbnN0IHsgX3BlbmRpbmdNYWluT3BzOiBwZW5kaW5nIH0gPSB0aGlzOwogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMudGhyZWFkSWQgIT09IG1haW5UaHJlYWRJZCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBsZXQgZm47CiAgICAgICAgd2hpbGUgKChmbiA9IHBlbmRpbmcuc2hpZnQoKSkgIT09IHZvaWQgMCkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZm4oKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgU2NyaXB0Lm5leHRUaWNrKCgpID0+IHsKICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICBwZXJmb3JtKGZuKSB7CiAgICAgIHRoaXMuX2NoZWNrQXZhaWxhYmxlKCk7CiAgICAgIGlmICghdGhpcy5faXNBcHBQcm9jZXNzKCkgfHwgdGhpcy5jbGFzc0ZhY3RvcnkubG9hZGVyICE9PSBudWxsKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHRoaXMudm0ucGVyZm9ybShmbik7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgU2NyaXB0Lm5leHRUaWNrKCgpID0+IHsKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9wZW5kaW5nVm1PcHMucHVzaChmbik7CiAgICAgICAgaWYgKHRoaXMuX3BlbmRpbmdWbU9wcy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgIHRoaXMuX3BlcmZvcm1QZW5kaW5nVm1PcHNXaGVuUmVhZHkoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHBlcmZvcm1Ob3coZm4pIHsKICAgICAgdGhpcy5fY2hlY2tBdmFpbGFibGUoKTsKICAgICAgcmV0dXJuIHRoaXMudm0ucGVyZm9ybSgoKSA9PiB7CiAgICAgICAgY29uc3QgeyBjbGFzc0ZhY3Rvcnk6IGZhY3RvcnkgfSA9IHRoaXM7CiAgICAgICAgaWYgKHRoaXMuX2lzQXBwUHJvY2VzcygpICYmIGZhY3RvcnkubG9hZGVyID09PSBudWxsKSB7CiAgICAgICAgICBjb25zdCBBY3Rpdml0eVRocmVhZCA9IGZhY3RvcnkudXNlKCJhbmRyb2lkLmFwcC5BY3Rpdml0eVRocmVhZCIpOwogICAgICAgICAgY29uc3QgYXBwID0gQWN0aXZpdHlUaHJlYWQuY3VycmVudEFwcGxpY2F0aW9uKCk7CiAgICAgICAgICBpZiAoYXBwICE9PSBudWxsKSB7CiAgICAgICAgICAgIGluaXRGYWN0b3J5RnJvbUFwcGxpY2F0aW9uKGZhY3RvcnksIGFwcCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmbigpOwogICAgICB9KTsKICAgIH0KICAgIF9wZXJmb3JtUGVuZGluZ1ZtT3BzV2hlblJlYWR5KCkgewogICAgICB0aGlzLnZtLnBlcmZvcm0oKCkgPT4gewogICAgICAgIGNvbnN0IHsgY2xhc3NGYWN0b3J5OiBmYWN0b3J5IH0gPSB0aGlzOwogICAgICAgIGNvbnN0IEFjdGl2aXR5VGhyZWFkID0gZmFjdG9yeS51c2UoImFuZHJvaWQuYXBwLkFjdGl2aXR5VGhyZWFkIik7CiAgICAgICAgY29uc3QgYXBwID0gQWN0aXZpdHlUaHJlYWQuY3VycmVudEFwcGxpY2F0aW9uKCk7CiAgICAgICAgaWYgKGFwcCAhPT0gbnVsbCkgewogICAgICAgICAgaW5pdEZhY3RvcnlGcm9tQXBwbGljYXRpb24oZmFjdG9yeSwgYXBwKTsKICAgICAgICAgIHRoaXMuX3BlcmZvcm1QZW5kaW5nVm1PcHMoKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgcnVudGltZTIgPSB0aGlzOwogICAgICAgIGxldCBpbml0aWFsaXplZCA9IGZhbHNlOwogICAgICAgIGxldCBob29rcG9pbnQgPSAiZWFybHkiOwogICAgICAgIGNvbnN0IGhhbmRsZUJpbmRBcHBsaWNhdGlvbiA9IEFjdGl2aXR5VGhyZWFkLmhhbmRsZUJpbmRBcHBsaWNhdGlvbjsKICAgICAgICBoYW5kbGVCaW5kQXBwbGljYXRpb24uaW1wbGVtZW50YXRpb24gPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5pbnN0cnVtZW50YXRpb25OYW1lLnZhbHVlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGhvb2twb2ludCA9ICJsYXRlIjsKICAgICAgICAgICAgY29uc3QgTG9hZGVkQXBrID0gZmFjdG9yeS51c2UoImFuZHJvaWQuYXBwLkxvYWRlZEFwayIpOwogICAgICAgICAgICBjb25zdCBtYWtlQXBwbGljYXRpb24gPSBMb2FkZWRBcGsubWFrZUFwcGxpY2F0aW9uOwogICAgICAgICAgICBtYWtlQXBwbGljYXRpb24uaW1wbGVtZW50YXRpb24gPSBmdW5jdGlvbihmb3JjZURlZmF1bHRBcHBDbGFzcywgaW5zdHJ1bWVudGF0aW9uKSB7CiAgICAgICAgICAgICAgaWYgKCFpbml0aWFsaXplZCkgewogICAgICAgICAgICAgICAgaW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgaW5pdEZhY3RvcnlGcm9tTG9hZGVkQXBrKGZhY3RvcnksIHRoaXMpOwogICAgICAgICAgICAgICAgcnVudGltZTIuX3BlcmZvcm1QZW5kaW5nVm1PcHMoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG1ha2VBcHBsaWNhdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgaGFuZGxlQmluZEFwcGxpY2F0aW9uLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfTsKICAgICAgICBjb25zdCBnZXRQYWNrYWdlSW5mb0NhbmRpZGF0ZXMgPSBBY3Rpdml0eVRocmVhZC5nZXRQYWNrYWdlSW5mby5vdmVybG9hZHMubWFwKChtKSA9PiBbbS5hcmd1bWVudFR5cGVzLmxlbmd0aCwgbV0pLnNvcnQoKFthcml0eUFdLCBbYXJpdHlCXSkgPT4gYXJpdHlCIC0gYXJpdHlBKS5tYXAoKFtfLCBtZXRob2RdKSA9PiBtZXRob2QpOwogICAgICAgIGNvbnN0IGdldFBhY2thZ2VJbmZvID0gZ2V0UGFja2FnZUluZm9DYW5kaWRhdGVzWzBdOwogICAgICAgIGdldFBhY2thZ2VJbmZvLmltcGxlbWVudGF0aW9uID0gZnVuY3Rpb24oLi4uYXJncykgewogICAgICAgICAgY29uc3QgYXBrID0gZ2V0UGFja2FnZUluZm8uY2FsbCh0aGlzLCAuLi5hcmdzKTsKICAgICAgICAgIGlmICghaW5pdGlhbGl6ZWQgJiYgaG9va3BvaW50ID09PSAiZWFybHkiKSB7CiAgICAgICAgICAgIGluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgICAgICAgaW5pdEZhY3RvcnlGcm9tTG9hZGVkQXBrKGZhY3RvcnksIGFwayk7CiAgICAgICAgICAgIHJ1bnRpbWUyLl9wZXJmb3JtUGVuZGluZ1ZtT3BzKCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYXBrOwogICAgICAgIH07CiAgICAgIH0pOwogICAgfQogICAgX3BlcmZvcm1QZW5kaW5nVm1PcHMoKSB7CiAgICAgIGNvbnN0IHsgdm06IHZtMywgX3BlbmRpbmdWbU9wczogcGVuZGluZyB9ID0gdGhpczsKICAgICAgbGV0IGZuOwogICAgICB3aGlsZSAoKGZuID0gcGVuZGluZy5zaGlmdCgpKSAhPT0gdm9pZCAwKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZtMy5wZXJmb3JtKGZuKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBTY3JpcHQubmV4dFRpY2soKCkgPT4gewogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICB1c2UoY2xhc3NOYW1lLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLmNsYXNzRmFjdG9yeS51c2UoY2xhc3NOYW1lLCBvcHRpb25zKTsKICAgIH0KICAgIG9wZW5DbGFzc0ZpbGUoZmlsZVBhdGgpIHsKICAgICAgcmV0dXJuIHRoaXMuY2xhc3NGYWN0b3J5Lm9wZW5DbGFzc0ZpbGUoZmlsZVBhdGgpOwogICAgfQogICAgY2hvb3NlKHNwZWNpZmllciwgY2FsbGJhY2tzKSB7CiAgICAgIHRoaXMuY2xhc3NGYWN0b3J5LmNob29zZShzcGVjaWZpZXIsIGNhbGxiYWNrcyk7CiAgICB9CiAgICByZXRhaW4ob2JqKSB7CiAgICAgIHJldHVybiB0aGlzLmNsYXNzRmFjdG9yeS5yZXRhaW4ob2JqKTsKICAgIH0KICAgIGNhc3Qob2JqLCBDKSB7CiAgICAgIHJldHVybiB0aGlzLmNsYXNzRmFjdG9yeS5jYXN0KG9iaiwgQyk7CiAgICB9CiAgICBhcnJheSh0eXBlLCBlbGVtZW50cykgewogICAgICByZXR1cm4gdGhpcy5jbGFzc0ZhY3RvcnkuYXJyYXkodHlwZSwgZWxlbWVudHMpOwogICAgfQogICAgYmFja3RyYWNlKG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIGJhY2t0cmFjZSh0aGlzLnZtLCBvcHRpb25zKTsKICAgIH0KICAgIC8vIFJlZmVyZW5jZTogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8yODQ4NTc1L2hvdy10by1kZXRlY3QtdWktdGhyZWFkLW9uLWFuZHJvaWQKICAgIGlzTWFpblRocmVhZCgpIHsKICAgICAgY29uc3QgTG9vcGVyID0gdGhpcy5jbGFzc0ZhY3RvcnkudXNlKCJhbmRyb2lkLm9zLkxvb3BlciIpOwogICAgICBjb25zdCBtYWluTG9vcGVyID0gTG9vcGVyLmdldE1haW5Mb29wZXIoKTsKICAgICAgY29uc3QgbXlMb29wZXIgPSBMb29wZXIubXlMb29wZXIoKTsKICAgICAgaWYgKG15TG9vcGVyID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiBtYWluTG9vcGVyLiRpc1NhbWVPYmplY3QobXlMb29wZXIpOwogICAgfQogICAgcmVnaXN0ZXJDbGFzcyhzcGVjKSB7CiAgICAgIHJldHVybiB0aGlzLmNsYXNzRmFjdG9yeS5yZWdpc3RlckNsYXNzKHNwZWMpOwogICAgfQogICAgZGVvcHRpbWl6ZUV2ZXJ5dGhpbmcoKSB7CiAgICAgIGNvbnN0IHsgdm06IHZtMyB9ID0gdGhpczsKICAgICAgcmV0dXJuIGRlb3B0aW1pemVFdmVyeXRoaW5nKHZtMywgdm0zLmdldEVudigpKTsKICAgIH0KICAgIGRlb3B0aW1pemVCb290SW1hZ2UoKSB7CiAgICAgIGNvbnN0IHsgdm06IHZtMyB9ID0gdGhpczsKICAgICAgcmV0dXJuIGRlb3B0aW1pemVCb290SW1hZ2Uodm0zLCB2bTMuZ2V0RW52KCkpOwogICAgfQogICAgZGVvcHRpbWl6ZU1ldGhvZChtZXRob2QpIHsKICAgICAgY29uc3QgeyB2bTogdm0zIH0gPSB0aGlzOwogICAgICByZXR1cm4gZGVvcHRpbWl6ZU1ldGhvZCh2bTMsIHZtMy5nZXRFbnYoKSwgbWV0aG9kKTsKICAgIH0KICAgIF9jaGVja0F2YWlsYWJsZSgpIHsKICAgICAgaWYgKCF0aGlzLmF2YWlsYWJsZSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiSmF2YSBBUEkgbm90IGF2YWlsYWJsZSIpOwogICAgICB9CiAgICB9CiAgICBfaXNBcHBQcm9jZXNzKCkgewogICAgICBsZXQgcmVzdWx0ID0gdGhpcy5fY2FjaGVkSXNBcHBQcm9jZXNzOwogICAgICBpZiAocmVzdWx0ID09PSBudWxsKSB7CiAgICAgICAgaWYgKHRoaXMuYXBpLmZsYXZvciA9PT0gImp2bSIpIHsKICAgICAgICAgIHJlc3VsdCA9IGZhbHNlOwogICAgICAgICAgdGhpcy5fY2FjaGVkSXNBcHBQcm9jZXNzID0gcmVzdWx0OwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmVhZGxpbmsgPSBuZXcgTmF0aXZlRnVuY3Rpb24oTW9kdWxlLmdldEdsb2JhbEV4cG9ydEJ5TmFtZSgicmVhZGxpbmsiKSwgInBvaW50ZXIiLCBbInBvaW50ZXIiLCAicG9pbnRlciIsICJwb2ludGVyIl0sIHsKICAgICAgICAgIGV4Y2VwdGlvbnM6ICJwcm9wYWdhdGUiCiAgICAgICAgfSk7CiAgICAgICAgY29uc3QgcGF0aG5hbWUgPSBNZW1vcnkuYWxsb2NVdGY4U3RyaW5nKCIvcHJvYy9zZWxmL2V4ZSIpOwogICAgICAgIGNvbnN0IGJ1ZmZlclNpemUgPSAxMDI0OwogICAgICAgIGNvbnN0IGJ1ZmZlciA9IE1lbW9yeS5hbGxvYyhidWZmZXJTaXplKTsKICAgICAgICBjb25zdCBzaXplID0gcmVhZGxpbmsocGF0aG5hbWUsIGJ1ZmZlciwgcHRyKGJ1ZmZlclNpemUpKS50b0ludDMyKCk7CiAgICAgICAgaWYgKHNpemUgIT09IC0xKSB7CiAgICAgICAgICBjb25zdCBleGUgPSBidWZmZXIucmVhZFV0ZjhTdHJpbmcoc2l6ZSk7CiAgICAgICAgICByZXN1bHQgPSAvXlwvc3lzdGVtXC9iaW5cL2FwcF9wcm9jZXNzLy50ZXN0KGV4ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHRoaXMuX2NhY2hlZElzQXBwUHJvY2VzcyA9IHJlc3VsdDsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIH07CiAgZnVuY3Rpb24gaW5pdEZhY3RvcnlGcm9tQXBwbGljYXRpb24oZmFjdG9yeSwgYXBwKSB7CiAgICBjb25zdCBQcm9jZXNzMiA9IGZhY3RvcnkudXNlKCJhbmRyb2lkLm9zLlByb2Nlc3MiKTsKICAgIGZhY3RvcnkubG9hZGVyID0gYXBwLmdldENsYXNzTG9hZGVyKCk7CiAgICBpZiAoUHJvY2VzczIubXlVaWQoKSA9PT0gUHJvY2VzczIuU1lTVEVNX1VJRC52YWx1ZSkgewogICAgICBmYWN0b3J5LmNhY2hlRGlyID0gIi9kYXRhL3N5c3RlbSI7CiAgICAgIGZhY3RvcnkuY29kZUNhY2hlRGlyID0gIi9kYXRhL2RhbHZpay1jYWNoZSI7CiAgICB9IGVsc2UgewogICAgICBpZiAoImdldENvZGVDYWNoZURpciIgaW4gYXBwKSB7CiAgICAgICAgZmFjdG9yeS5jYWNoZURpciA9IGFwcC5nZXRDYWNoZURpcigpLmdldENhbm9uaWNhbFBhdGgoKTsKICAgICAgICBmYWN0b3J5LmNvZGVDYWNoZURpciA9IGFwcC5nZXRDb2RlQ2FjaGVEaXIoKS5nZXRDYW5vbmljYWxQYXRoKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZmFjdG9yeS5jYWNoZURpciA9IGFwcC5nZXRGaWxlc0RpcigpLmdldENhbm9uaWNhbFBhdGgoKTsKICAgICAgICBmYWN0b3J5LmNvZGVDYWNoZURpciA9IGFwcC5nZXRDYWNoZURpcigpLmdldENhbm9uaWNhbFBhdGgoKTsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBpbml0RmFjdG9yeUZyb21Mb2FkZWRBcGsoZmFjdG9yeSwgYXBrKSB7CiAgICBjb25zdCBKRmlsZSA9IGZhY3RvcnkudXNlKCJqYXZhLmlvLkZpbGUiKTsKICAgIGZhY3RvcnkubG9hZGVyID0gYXBrLmdldENsYXNzTG9hZGVyKCk7CiAgICBjb25zdCBkYXRhRGlyID0gSkZpbGUuJG5ldyhhcGsuZ2V0RGF0YURpcigpKS5nZXRDYW5vbmljYWxQYXRoKCk7CiAgICBmYWN0b3J5LmNhY2hlRGlyID0gZGF0YURpcjsKICAgIGZhY3RvcnkuY29kZUNhY2hlRGlyID0gZGF0YURpciArICIvY2FjaGUiOwogIH0KICB2YXIgcnVudGltZSA9IG5ldyBSdW50aW1lKCk7CiAgU2NyaXB0LmJpbmRXZWFrKHJ1bnRpbWUsICgpID0+IHsKICAgIHJ1bnRpbWUuX2Rpc3Bvc2UoKTsKICB9KTsKICB2YXIgZnJpZGFfamF2YV9icmlkZ2VfZGVmYXVsdCA9IHJ1bnRpbWU7CgogIC8vIGRldmljZS50cwogIGZyaWRhX2phdmFfYnJpZGdlX2RlZmF1bHQucGVyZm9ybSgoKSA9PiB7CiAgICB2YXIgTG9nID0gZnJpZGFfamF2YV9icmlkZ2VfZGVmYXVsdC51c2UoImFuZHJvaWQudXRpbC5Mb2ciKTsKICAgIExvZy52KCJ0ZXN0IiwgImhlbGxvIGZyb20gZXZhbCIpOwogIH0pOwp9KSgpOwovKiEgQnVuZGxlZCBsaWNlbnNlIGluZm9ybWF0aW9uOgoKaWVlZTc1NC9pbmRleC5qczoKICAoKiEgaWVlZTc1NC4gQlNELTMtQ2xhdXNlIExpY2Vuc2UuIEZlcm9zcyBBYm91a2hhZGlqZWggPGh0dHBzOi8vZmVyb3NzLm9yZy9vcGVuc291cmNlPiAqKQoKQGZyaWRhL2J1ZmZlci9pbmRleC5qczoKICAoKiEKICAgKiBUaGUgYnVmZmVyIG1vZHVsZSBmcm9tIG5vZGUuanMsIGZvciBGcmlkYS4KICAgKgogICAqIEBhdXRob3IgICBGZXJvc3MgQWJvdWtoYWRpamVoIDxodHRwczovL2Zlcm9zcy5vcmc+CiAgICogQGxpY2Vuc2UgIE1JVAogICAqKQoqLwo=`;

Java.perform(() => {
	var Log = Java.use("android.util.Log");
	Log.v("test", "doing");

	Il2Cpp.perform(async () => {
		Log.v("test", "inside");

		const code = Buffer.from(c, "base64").toString();
		Log.v("test", "got code");
		Log.v("test", code.toString().slice(0, 10));

		try {
			eval(code);
			Log.v("test", "eval");
		  } catch (e) {
			const error = e as Error;
			Log.v("test", "error: " + error.toString());
		}
	}, "main");
});
